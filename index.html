<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>New Urban Influence | Detroit Branding Agency</title>

 <!-- ONE-TIME CACHE BUST: v4 — kills old service workers on Safari/mobile -->
 <!-- Does NOT clear portfolio or site image data (only SW caches) -->
 <script>
 (function(){
   var BUST_VERSION = 'v4';
   if (localStorage.getItem('nui_cache_bust') === BUST_VERSION) return;
   if ('serviceWorker' in navigator) {
     navigator.serviceWorker.getRegistrations().then(function(regs) {
       var hadSW = regs.length > 0;
       regs.forEach(function(r) { r.unregister(); });
       if ('caches' in window) {
         caches.keys().then(function(names) {
           names.forEach(function(n) { caches.delete(n); });
           localStorage.setItem('nui_cache_bust', BUST_VERSION);
           if (hadSW || names.length > 0) {
             window.location.reload(true);
           }
         });
       } else {
         localStorage.setItem('nui_cache_bust', BUST_VERSION);
         if (hadSW) window.location.reload(true);
       }
     });
   } else {
     localStorage.setItem('nui_cache_bust', BUST_VERSION);
   }
 })();
 </script>

    <!-- PWA -->
 <link rel="manifest" href="/manifest.json">
 <meta name="theme-color" content="#dc2626">
 <meta name="apple-mobile-web-app-capable" content="yes">
 <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
 <meta name="apple-mobile-web-app-title" content="NUI">
 <link rel="apple-touch-icon" href="/icons/icon-192.png">
 <link rel="icon" type="image/x-icon" href="/favicon.ico" sizes="48x48">
 <link rel="icon" type="image/png" sizes="48x48" href="/icons/icon-48.png">
 <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png">

    <!-- SEO Meta Tags -->
 <meta name="description" content="Detroit branding agency for small businesses and startups. Brand identity packages from $1,500. Logo design, web, packaging, and print.">
 <meta name="keywords" content="branding agency detroit, logo design detroit, brand identity detroit, graphic design agency detroit, detroit creative agency, michigan branding agency, affordable branding packages, small business branding detroit, packaging design detroit, logo design cost michigan, branding packages small business, print design detroit, banner design detroit, yard signs detroit, vinyl decals detroit, social media templates detroit, brand guidelines detroit, detroit graphic design, branding near me, logo designer near me, best branding agency detroit michigan, branding agency southfield, branding agency royal oak, branding agency ann arbor">
 <meta name="author" content="New Urban Influence">
 <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
 <meta name="googlebot" content="index, follow">
 <link rel="canonical" href="https://newurbaninfluence.com">

    <!-- Open Graph / Facebook -->
 <meta property="og:type" content="website">
 <meta property="og:url" content="https://newurbaninfluence.com">
 <meta property="og:title" content="New Urban Influence | Detroit Branding Agency — Packages from $1,500">
 <meta property="og:description" content="Professional branding for small businesses. Logo design, brand identity, packaging, social media templates. 4.9★ rated. Free consultation. Payment plans available.">
 <meta property="og:image" content="https://newurbaninfluence.com/og-image.jpg">
 <meta property="og:image:width" content="1200">
 <meta property="og:image:height" content="630">
 <meta property="og:locale" content="en_US">
 <meta property="og:site_name" content="New Urban Influence">

    <!-- Twitter -->
 <meta name="twitter:card" content="summary_large_image">
 <meta name="twitter:site" content="@newurbaninfluence">
 <meta name="twitter:creator" content="@newurbaninfluence">
 <meta name="twitter:title" content="New Urban Influence | Detroit Branding Agency — Packages from $1,500">
 <meta name="twitter:description" content="Professional branding for small businesses. Logo design, brand identity, packaging, social templates. 4.9★ rated. Free consultation.">
 <meta name="twitter:image" content="https://newurbaninfluence.com/twitter-card.jpg">

    <!-- Local Business Schema -->
 <script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "LocalBusiness",
  "name": "New Urban Influence",
  "description": "Detroit branding agency for small businesses and startups. Professional brand identity packages from $1,500 including logo design, packaging design, social media templates, and brand guidelines. Serving Metro Detroit, Southfield, Royal Oak, Ann Arbor, and all of Michigan.",
  "url": "https://newurbaninfluence.com",
  "telephone": "(248) 487-8747",
  "email": "info@newurbaninfluence.com",
  "areaServed": {
    "@type": "GeoCircle",
    "geoMidpoint": {
      "@type": "GeoCoordinates",
      "latitude": "42.3314",
      "longitude": "-83.0458"
    },
    "geoRadius": "50 mi"
  },
  "address": {
    "@type": "PostalAddress",
    "addressLocality": "Detroit",
    "addressRegion": "MI",
    "addressCountry": "US"
  },
  "openingHours": "Mo-Fr 09:00-18:00",
  "priceRange": "$$",
  "image": "https://newurbaninfluence.com/logo.png",
  "sameAs": [
    "https://www.instagram.com/newurbaninfluence",
    "https://twitter.com/newurbaninfluence",
    "https://www.linkedin.com/company/newurbaninfluence",
    "https://share.google/0zJCv7QH0SXk4sY7X",
    "https://clutch.co/profile/new-urban-influence",
    "https://www.yelp.com/biz/new-urban-influence-detroit",
    "https://www.manta.com/c/m1x03t9/new-urban-influence",
    "https://www.dnb.com/business-directory/company-profiles.new_urban_influence_ltd_llc.b30541265d2e1744184ea8a5ef31a4c8.html",
    "https://scottmax.com/connect/media-buying-agencies-in-detroit/"
  ],
  "subjectOf": [
    {
      "@type": "Article",
      "name": "Black Entrepreneurs Successful Opening Bravo Graphix Detroit",
      "url": "https://rollingout.com/2013/10/18/black-entrepreneurs-successful-opening-bravo-graphix-detroit/",
      "publisher": {
        "@type": "Organization",
        "name": "Rolling Out"
      }
    },
    {
      "@type": "Article",
      "name": "Bravo Graphix Now Open on the Avenue of Fashion",
      "url": "https://www.modeldmedia.com/companies/BravoGraphix.aspx",
      "publisher": {
        "@type": "Organization",
        "name": "Model D Media"
      }
    },
    {
      "@type": "Article",
      "name": "Detroit Design Festival Schedule Revealed",
      "url": "https://www.freep.com/story/entertainment/2014/09/09/detroit-design-festival-schedule-revealed/15364423/",
      "publisher": {
        "@type": "Organization",
        "name": "Detroit Free Press"
      }
    }
  ],
  "knowsAbout": [
    "Brand Identity Design",
    "Logo Design",
    "Packaging Design",
    "Web Design",
    "Social Media Marketing",
    "Print Design",
    "Brand Guidelines",
    "Political Campaign Design",
    "Event Branding",
    "Restaurant Branding"
  ],
  "hasCredential": [
    {
      "@type": "EducationalOccupationalCredential",
      "name": "Clutch Verified Agency",
      "url": "https://clutch.co/profile/new-urban-influence"
    }
  ],
  "brand": {
    "@type": "Brand",
    "name": "New Urban Influence",
    "alternateName": "Bravo Graphix"
  },
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "5",
    "reviewCount": "31"
  },
  "review": [
    {
      "@type": "Review",
      "author": {
        "@type": "Person",
        "name": "Miss B"
      },
      "reviewRating": {
        "@type": "Rating",
        "ratingValue": "5",
        "bestRating": "5"
      },
      "reviewBody": "I would recommend working with New Urban Influence. My experience with Faren was great...even when I was being a difficult customer. The care and attention that was put into making sure they understood my vision for my brand was amazing.",
      "datePublished": "2025-11-15"
    },
    {
      "@type": "Review",
      "author": {
        "@type": "Person",
        "name": "Chevelles Bar"
      },
      "reviewRating": {
        "@type": "Rating",
        "ratingValue": "5",
        "bestRating": "5"
      },
      "reviewBody": "Farren did a great job on a few flyers for me. Prices were reasonable and the quality was superb. My go to company for all my promotional needs. The best at what he does!",
      "datePublished": "2025-10-20"
    },
    {
      "@type": "Review",
      "author": {
        "@type": "Person",
        "name": "Sierra Meriwether"
      },
      "reviewRating": {
        "@type": "Rating",
        "ratingValue": "5",
        "bestRating": "5"
      },
      "reviewBody": "The best graphic designing company in the world! I have been a customer for over 10 years and every time they exceed my expectations! Faren and his team has always been very professional and prompt with all my services! I highly recommend this company!",
      "datePublished": "2025-12-01"
    },
    {
      "@type": "Review",
      "author": {
        "@type": "Person",
        "name": "Larry Castleberry"
      },
      "reviewRating": {
        "@type": "Rating",
        "ratingValue": "5",
        "bestRating": "5"
      },
      "reviewBody": "Great experience. Urban Influence gives you personal/detailed attention (making you feel like you are their most important customer). Love not only the services they offer but the personal touch they provide.",
      "datePublished": "2025-12-10"
    }
  ]
}</script>

    <!-- FAQPage Schema for AI Answer Engines & Google Rich Results -->
 <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        "mainEntity": [
            {
                "@type": "Question",
                "name": "What is New Urban Influence?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "New Urban Influence (NUI) is a Detroit-based creative agency specializing in brand identity design, web design, and digital marketing. Founded to help small businesses and startups build professional, competitive brands, NUI offers full branding packages starting at $1,500 including logo design, color systems, typography, social media templates, and brand guidelines. They serve clients throughout Detroit, Southeast Michigan, and nationwide."
                }
            },
            {
                "@type": "Question",
                "name": "What services does New Urban Influence offer?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "New Urban Influence offers three main branding packages: Brand Kit ($1,500 flat rate) for startups and new businesses, Service Business Brand Identity ($4,500+) for consultants, agencies, and service providers, and Product Brand Identity ($5,500+) for businesses selling physical products. Additional services include logo design, business card design, social media templates, print design + printing (banners from $175, yard signs from $35/each, business cards from $195, vehicle magnets from $195, postcards from $225, acrylic signs from $275, Dibond from $325), packaging design, presentation templates, and brand guidelines documentation."
                }
            },
            {
                "@type": "Question",
                "name": "How much does branding cost in Detroit?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "In Detroit, professional branding packages at New Urban Influence range from $1,500 to $6,000+. The Brand Kit starts at $1,500 (logo, colors, typography, social templates), Service Business Brand Identity starts at $4,500, and Product Brand Identity starts at $5,500. Individual services like logo design start at $500. Payment plans are available including pay-in-full (5% discount), 50/25/25 split, or 3 monthly payments."
                }
            },
            {
                "@type": "Question",
                "name": "How much does a logo design cost?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "At New Urban Influence, standalone logo design starts at $500 and includes a primary logo, secondary logo variation, icon/mark version, and all file formats (PNG, SVG, PDF). For a complete brand identity that includes the logo plus color palette, typography, social media templates, and brand guidelines, packages start at $1,500."
                }
            },
            {
                "@type": "Question",
                "name": "What is the best branding agency in Detroit?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "New Urban Influence is one of Detroit's top-rated creative agencies with a 4.9-star rating across 28+ reviews. They specialize in helping small businesses and startups build professional brand identities at accessible price points starting at $1,500. What sets them apart is their strategic approach to branding, transparent flat-rate pricing, payment plans, and a dedicated client portal for real-time project tracking."
                }
            },
            {
                "@type": "Question",
                "name": "How long does a branding project take?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "At New Urban Influence, most branding projects take 2 to 4 weeks depending on complexity. The Brand Kit (starter package) typically completes in 2 weeks, while comprehensive Service and Product Brand Identity packages take 3 to 4 weeks. Rush delivery is available for an additional fee."
                }
            },
            {
                "@type": "Question",
                "name": "Do you offer free consultations?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Yes, New Urban Influence offers free strategy consultations for every potential client. During the call, they discuss your business goals, target audience, competitive landscape, and branding needs. You'll receive a custom pricing estimate after the consultation with no obligation to proceed. Book directly at newurbaninfluence.com."
                }
            },
            {
                "@type": "Question",
                "name": "Can I get professional branding on a small budget?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Absolutely. New Urban Influence offers professional branding packages starting at $1,500 flat rate with payment plans available. You can split payments 50/25/25 or into 3 monthly installments. A 5% discount is available for paying in full. The Brand Kit includes logo design, color palette, typography, social media templates, and brand guidelines."
                }
            },
            {
                "@type": "Question",
                "name": "Do you offer payment plans for branding?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Yes, New Urban Influence offers three payment options: (1) Pay in Full with a 5% discount, (2) Standard Plan — 50% deposit, 25% at design approval, 25% at final delivery, (3) Monthly Plan — 3 equal monthly payments. No interest charges or hidden fees on any payment plan."
                }
            },
            {
                "@type": "Question",
                "name": "What makes New Urban Influence different from other branding agencies?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "New Urban Influence stands out with transparent flat-rate pricing, brand strategy included in every project, a dedicated client portal for real-time proof reviews and approvals, payment plans on every package, specialized packages for both product and service businesses, and a 4.9-star rating with 28+ reviews. Free strategy consultations are offered before any commitment."
                }
            },
            {
                "@type": "Question",
                "name": "Where is New Urban Influence located?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "New Urban Influence is located in Detroit, Michigan. They serve clients throughout Metro Detroit, Southeast Michigan, and nationwide."
                }
            },
            {
                "@type": "Question",
                "name": "What file formats will I receive for my logo?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "New Urban Influence delivers logos in PNG (transparent background), SVG (scalable vector), PDF (print-ready), and AI/EPS upon request. You receive primary logo, secondary logo variation, and icon/mark versions — each in every format."
                }
            },
            {
                "@type": "Question",
                "name": "How much does product packaging design cost?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "At New Urban Influence, standalone packaging design starts at $600 and label design starts at $300. For a complete Product Brand Identity including logo, color system, packaging, labels, and all supporting materials, packages start at $5,500."
                }
            },
            {
                "@type": "Question",
                "name": "Are there affordable branding agencies in Michigan?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Yes — New Urban Influence in Detroit offers professional branding packages starting at $1,500 with flexible payment plans. They serve clients throughout Michigan. Their Brand Kit includes logo design, color palette, typography, social media templates, and brand guidelines — all for a flat rate with no hidden fees."
                }
            },
            {
                "@type": "Question",
                "name": "Who does branding near me in Detroit?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "New Urban Influence is a branding agency in Detroit, Michigan serving all of Metro Detroit including Southfield, Royal Oak, Troy, Farmington Hills, Ann Arbor, Dearborn, and Birmingham. They offer brand identity packages starting at $1,500 with free consultations. Call (248) 487-8747 or visit newurbaninfluence.com."
                }
            },
            {
                "@type": "Question",
                "name": "Who is the best logo designer near me?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "New Urban Influence is a top-rated logo designer in Detroit, Michigan with a 4.9-star rating and 28 Google reviews. They create custom logos for small businesses starting at $1,500 which includes the logo, color palette, typography, social media templates, and brand guidelines. Free consultations available at (248) 487-8747."
                }
            },
            {
                "@type": "Question",
                "name": "How much does it cost to get a logo designed?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Professional logo design at New Urban Influence in Detroit costs $1,500 for a complete Brand Kit including primary logo, secondary logo, icon mark, color palette, typography, 15 social media templates, and brand guidelines. Payment plans available — two payments of $750. Call (248) 487-8747 for a free quote."
                }
            },
            {
                "@type": "Question",
                "name": "Where can I get a website designed in Detroit?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "New Urban Influence in Detroit designs custom websites for small businesses starting at $3,500. They build mobile-first, SEO-optimized websites including landing pages, multi-page business sites, and e-commerce stores. Call (248) 487-8747 or visit newurbaninfluence.com for a free consultation."
                }
            },
            {
                "@type": "Question",
                "name": "Who can design packaging for my product?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "New Urban Influence in Detroit designs product packaging, labels, and retail-ready materials for food, beverage, cannabis, beauty, and consumer products. Packaging design starts at $500 per SKU. Their Product Brand Identity package at $5,500 includes packaging plus complete brand identity. Call (248) 487-8747."
                }
            },
            {
                "@type": "Question",
                "name": "What is a brand identity package?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "A brand identity package is a complete set of visual and strategic elements that define how your business looks and communicates. At New Urban Influence, packages include brand strategy, logo design, color palette, typography, social media templates, and brand guidelines. Packages start at $1,500 for the Brand Kit, $4,500 for Service Business, and $5,500 for Product Business identities."
                }
            },
            {
                "@type": "Question",
                "name": "Can someone build me a sales funnel?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Yes — New Urban Influence in Detroit builds custom sales funnels and marketing automation systems starting at $1,500. This includes landing pages, email sequences, lead magnets, and CRM integration. They build funnels that generate leads automatically 24/7. Call (248) 487-8747 for a free consultation."
                }
            },
            {
                "@type": "Question",
                "name": "Who does print design in Detroit?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "New Urban Influence in Detroit offers turnkey design + print packages for over 30 products including banners, yard signs, business cards, vehicle magnets, postcards, acrylic signs, Dibond panels, foam core, and more. Prices start at $175 for vinyl banners, $195 for business cards (250), $195 for vehicle magnets, $275 for acrylic signs, and $325 for Dibond exterior signs. All prices include custom design and professional printing. Call (248) 487-8747."
                }
            }
        ]
    }
 </script>

    <!-- Speakable Schema — Tells voice assistants which content to read aloud -->
 <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebPage",
        "name": "New Urban Influence — Detroit Branding Agency",
        "url": "https://newurbaninfluence.com",
        "speakable": {
            "@type": "SpeakableSpecification",
            "cssSelector": [".aeo-section", ".faq-section", "meta[name='description']"]
        }
    }
 </script>

    <!-- HowTo Schema — Voice assistants love step-by-step processes -->
 <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "HowTo",
        "name": "How to Get Your Business Branded by New Urban Influence",
        "description": "Step-by-step process to get professional brand identity design from New Urban Influence in Detroit. From free consultation to final delivery in 2-4 weeks.",
        "totalTime": "P21D",
        "estimatedCost": {
            "@type": "MonetaryAmount",
            "currency": "USD",
            "value": "1500"
        },
        "step": [
            {
                "@type": "HowToStep",
                "name": "Book a Free Strategy Consultation",
                "text": "Call (248) 487-8747 or visit newurbaninfluence.com to book a free strategy consultation. During the call, we discuss your business goals, target audience, and branding needs.",
                "url": "https://newurbaninfluence.com/contact"
            },
            {
                "@type": "HowToStep",
                "name": "Choose Your Branding Package",
                "text": "Select from three packages: Brand Kit at $1,500 for startups, Service Business Brand Identity at $4,500, or Product Brand Identity at $5,500. Payment plans available on all packages."
            },
            {
                "@type": "HowToStep",
                "name": "Brand Strategy and Mood Board",
                "text": "We conduct a deep strategy session, research your competitors, and present a mood board and brand direction for your approval before any design begins."
            },
            {
                "@type": "HowToStep",
                "name": "Design and Revisions",
                "text": "We create your complete brand identity including logo, colors, typography, and all deliverables. You review proofs through our client portal with 2-3 rounds of revisions included."
            },
            {
                "@type": "HowToStep",
                "name": "Final Delivery",
                "text": "Receive all brand files, social media templates, brand guidelines, and a walkthrough of how to use everything. Your complete brand identity is ready to launch."
            }
        ]
    }
 </script>

    <!-- Service Offerings Schema — Helps Google & AI understand your services + pricing -->
 <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "ProfessionalService",
        "name": "New Urban Influence",
        "url": "https://newurbaninfluence.com",
        "telephone": "(248) 487-8747",
        "email": "info@newurbaninfluence.com",
        "address": {
            "@type": "PostalAddress",
            "addressLocality": "Detroit",
            "addressRegion": "MI",
            "addressCountry": "US"
        },
        "areaServed": [
            { "@type": "City", "name": "Detroit" },
            { "@type": "State", "name": "Michigan" },
            { "@type": "Country", "name": "United States" }
        ],
        "hasOfferCatalog": {
            "@type": "OfferCatalog",
            "name": "Branding & Design Services",
            "itemListElement": [
                {
                    "@type": "OfferCatalog",
                    "name": "Branding Packages",
                    "itemListElement": [
                        {
                            "@type": "Offer",
                            "itemOffered": {
                                "@type": "Service",
                                "name": "Brand Kit — Starter Package",
                                "description": "Complete starter branding package including primary logo with secondary and icon variations, brand color palette, typography selection, social media templates, social media banners, email signature, and brand guidelines document. Perfect for startups and new businesses."
                            },
                            "price": "1500.00",
                            "priceCurrency": "USD",
                            "priceSpecification": {
                                "@type": "UnitPriceSpecification",
                                "price": "1500.00",
                                "priceCurrency": "USD",
                                "unitText": "flat rate"
                            }
                        },
                        {
                            "@type": "Offer",
                            "itemOffered": {
                                "@type": "Service",
                                "name": "Service Business Brand Identity",
                                "description": "Comprehensive branding system for consultants, agencies, contractors, and service providers. Includes logo suite, color system, typography, business cards, letterhead, email signature, presentation template, social media kit, and brand guidelines. Builds trust and attracts premium clients."
                            },
                            "price": "3500.00",
                            "priceCurrency": "USD",
                            "priceSpecification": {
                                "@type": "UnitPriceSpecification",
                                "price": "3500.00",
                                "priceCurrency": "USD",
                                "unitText": "starting at"
                            }
                        },
                        {
                            "@type": "Offer",
                            "itemOffered": {
                                "@type": "Service",
                                "name": "Product Brand Identity",
                                "description": "Complete branding system for businesses selling physical products. Includes logo suite, color system, typography, packaging design, label design, product photography guidelines, retail display concepts, social media kit, and comprehensive brand guidelines."
                            },
                            "price": "4500.00",
                            "priceCurrency": "USD",
                            "priceSpecification": {
                                "@type": "UnitPriceSpecification",
                                "price": "4500.00",
                                "priceCurrency": "USD",
                                "unitText": "starting at"
                            }
                        }
                    ]
                },
                {
                    "@type": "OfferCatalog",
                    "name": "Individual Design Services",
                    "itemListElement": [
                        {
                            "@type": "Offer",
                            "itemOffered": { "@type": "Service", "name": "Logo Design", "description": "Primary logo, secondary variation, icon/mark version in PNG, SVG, PDF formats" },
                            "price": "500.00", "priceCurrency": "USD"
                        },
                        {
                            "@type": "Offer",
                            "itemOffered": { "@type": "Service", "name": "Packaging Design", "description": "Product packaging design for retail and e-commerce" },
                            "price": "600.00", "priceCurrency": "USD"
                        },
                        {
                            "@type": "Offer",
                            "itemOffered": { "@type": "Service", "name": "Print Design + Printing", "description": "Turnkey design and printing — banners, yard signs, business cards, vehicle magnets, postcards, acrylic signs, Dibond, foam core, and 30+ products. Delivered to your door." },
                            "price": "35.00", "priceCurrency": "USD"
                        },
                        {
                            "@type": "Offer",
                            "itemOffered": { "@type": "Service", "name": "Brand Guidelines Document", "description": "Comprehensive brand standards guide with logo usage, colors, typography, and application rules" },
                            "price": "400.00", "priceCurrency": "USD"
                        },
                        {
                            "@type": "Offer",
                            "itemOffered": { "@type": "Service", "name": "Social Media Templates", "description": "Custom-branded social media post and story templates" },
                            "price": "300.00", "priceCurrency": "USD"
                        },
                        {
                            "@type": "Offer",
                            "itemOffered": { "@type": "Service", "name": "Business Card Design", "description": "Professional business card design front and back" },
                            "price": "150.00", "priceCurrency": "USD"
                        }
                    ]
                }
            ]
        },
        "paymentAccepted": "Credit Card, Debit Card, Bank Transfer",
        "priceRange": "$500 - $5000+",
        "knowsAbout": ["Brand Identity Design", "Logo Design", "Graphic Design", "Packaging Design", "Social Media Design", "Print Design", "Banner Design", "Poster Design", "Yard Signs", "Vehicle Magnets", "Business Cards", "Postcards", "Acrylic Signs", "Dibond Signs", "Foam Core Signs", "Vinyl Decal Design", "Signage Design", "Brand Strategy", "Visual Identity Systems", "Digital Marketing"],
        "slogan": "Build Your Influence. Unapologetically Detroit."
    }
 </script>
    <!-- WebSite Schema with SearchAction — enables sitelinks search in Google -->
 <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "New Urban Influence",
        "url": "https://newurbaninfluence.com",
        "description": "Detroit branding agency for small businesses and startups. Professional brand identity packages from $1,500.",
        "publisher": {
            "@type": "Organization",
            "name": "New Urban Influence",
            "logo": {
                "@type": "ImageObject",
                "url": "https://newurbaninfluence.com/logo.png"
            }
        },
        "potentialAction": {
            "@type": "SearchAction",
            "target": {
                "@type": "EntryPoint",
                "urlTemplate": "https://newurbaninfluence.com/?q={search_term_string}"
            },
            "query-input": "required name=search_term_string"
        },
        "inLanguage": "en-US"
    }
 </script>

    <!-- SiteNavigationElement Schema — helps crawlers understand site structure -->
 <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@graph": [
            { "@type": "SiteNavigationElement", "name": "Home", "url": "https://newurbaninfluence.com/" },
            { "@type": "SiteNavigationElement", "name": "About", "url": "https://newurbaninfluence.com/about" },
            { "@type": "SiteNavigationElement", "name": "Services", "url": "https://newurbaninfluence.com/services/brand-identity-packages-detroit" },
            { "@type": "SiteNavigationElement", "name": "Portfolio", "url": "https://newurbaninfluence.com/portfolio" },
            { "@type": "SiteNavigationElement", "name": "Blog", "url": "https://newurbaninfluence.com/blog" },
            { "@type": "SiteNavigationElement", "name": "Logo Design", "url": "https://newurbaninfluence.com/services/logo-design-detroit" },
            { "@type": "SiteNavigationElement", "name": "Branding Packages", "url": "https://newurbaninfluence.com/services/branding-agency-detroit" },
            { "@type": "SiteNavigationElement", "name": "Brand Identity", "url": "https://newurbaninfluence.com/services/brand-identity-packages-detroit" },
            { "@type": "SiteNavigationElement", "name": "Web Design", "url": "https://newurbaninfluence.com/services/web-design-detroit" },
            { "@type": "SiteNavigationElement", "name": "Get Started", "url": "https://newurbaninfluence.com/contact" }
        ]
    }
 </script>

    <!-- BreadcrumbList Schema — signals site hierarchy to search engines -->
 <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": [
            {
                "@type": "ListItem",
                "position": 1,
                "name": "Home",
                "item": "https://newurbaninfluence.com/"
            },
            {
                "@type": "ListItem",
                "position": 2,
                "name": "Services",
                "item": "https://newurbaninfluence.com/services/brand-identity-packages-detroit"
            },
            {
                "@type": "ListItem",
                "position": 3,
                "name": "Portfolio",
                "item": "https://newurbaninfluence.com/portfolio"
            },
            {
                "@type": "ListItem",
                "position": 4,
                "name": "Blog",
                "item": "https://newurbaninfluence.com/blog"
            }
        ]
    }
 </script>

    <!-- Individual Review Schemas — rich review snippets in search results -->
 

    <!-- Google Analytics 4 -->
 <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
 <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-XXXXXXXXXX');
 </script>

    <!-- Favicon -->
 <link rel="icon" type="image/x-icon" href="favicon.ico">
 <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">

    <!-- Preconnect for performance -->
 <link rel="preconnect" href="https://fonts.googleapis.com">
 <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
 <link rel="preconnect" href="https://images.unsplash.com" crossorigin>
 <link rel="preload" as="image" href="https://images.unsplash.com/photo-1558655146-9f40138edfeb?w=1920&q=80" fetchpriority="high">
 <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
 <link rel="dns-prefetch" href="https://js.stripe.com">
 <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap">
 <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
 <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"></noscript>

    <!-- Critical scripts only — env + supabase needed for data -->
 <script src="/env.js" defer></script>
 <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
 <script src="/supabase-client.js" defer></script>

    <!-- Lazy-load non-critical scripts (Stripe, Google Identity) -->
 <script>
 function loadStripe(){if(window.Stripe)return Promise.resolve();return new Promise(function(r){var s=document.createElement('script');s.src='https://js.stripe.com/v3/';s.onload=r;document.head.appendChild(s);});}
 function loadGoogleIdentity(){if(window.google&&window.google.accounts)return Promise.resolve();return new Promise(function(r){var s=document.createElement('script');s.src='https://accounts.google.com/gsi/client';s.onload=r;document.head.appendChild(s);});}
 </script>
 <style>*{margin:0;padding:0;box-sizing:border-box;}:root{--black:#000000;--dark:#0a0a0a;--white:#ffffff;--gray:#888888;--gray-light:#f5f5f5;--gray-200:#e5e5e5;--gray-400:#a3a3a3;--gray-600:#525252;--red:#ff0000;--red-hover:#cc0000;--green:#10b981;--yellow:#f59e0b;--blue:#3b82f6;--admin-bg:#0a0a0a;--admin-bg-secondary:#111111;--admin-text:#ffffff;--admin-text-muted:#888888;--admin-card:#1a1a1a;--admin-card-hover:#252525;--admin-border:rgba(255,255,255,0.1);--admin-input-bg:#1a1a1a;--admin-sidebar:#0a0a0a;--admin-header:#0a0a0a;}:root.light-mode{--admin-bg:#f5f5f5;--admin-bg-secondary:#ffffff;--admin-text:#0a0a0a;--admin-text-muted:#666666;--admin-card:#ffffff;--admin-card-hover:#f0f0f0;--admin-border:rgba(0,0,0,0.1);--admin-input-bg:#ffffff;--admin-sidebar:#ffffff;--admin-header:#ffffff;}
body{font-family:'Inter',sans-serif;background:var(--black);color:var(--white);overflow-x:hidden;}.faq-open > div:last-child{max-height:500px !important;}
.view{display:none;}
/* Core Web Vitals: CSS Containment for paint performance */
.package-section{contain:layout style paint;}
.portfolio-grid{contain:layout style;}
.faq-section{contain:layout style;}
section[style*="background"]{contain:layout style paint;}

/* Core Web Vitals: content-visibility for off-screen sections */
.package-section:nth-child(n+3){content-visibility:auto;contain-intrinsic-size:auto 800px;}
.testimonials-section{content-visibility:auto;contain-intrinsic-size:auto 600px;}
.map-section{content-visibility:auto;contain-intrinsic-size:auto 500px;}

.view.active{display:block;}
.nav{position:fixed;top:0;left:0;right:0;display:flex;justify-content:space-between;align-items:center;padding:20px 48px;z-index:1000;background:rgba(0,0,0,0.95);backdrop-filter:blur(10px);}
.logo{font-weight:800;font-size:18px;color:var(--red);text-decoration:none;cursor:pointer;display:flex;align-items:center;position:relative;}
.logo img{height:45px;width:auto;}
.nav-links{display:flex;gap:32px;align-items:center;}
.nav-links a{color:var(--white);text-decoration:none;font-size:14px;font-weight:500;cursor:pointer;transition:color 0.2s;}
.nav-links a:hover,.nav-links a.active{color:var(--red);}
.hamburger{display:none;flex-direction:column;gap:5px;cursor:pointer;padding:10px;z-index:1002;}
.hamburger span{width:24px;height:2px;background:var(--white);transition:all 0.3s;}
.hamburger.active span:nth-child(1){transform:rotate(45deg) translate(5px,5px);}
.hamburger.active span:nth-child(2){opacity:0;}
.hamburger.active span:nth-child(3){transform:rotate(-45deg) translate(5px,-5px);}
.mobile-menu{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.98);z-index:1001;flex-direction:column;align-items:center;justify-content:center;gap:32px;}
.mobile-menu.active{display:flex;}
.mobile-menu a{color:var(--white);text-decoration:none;font-size:24px;font-weight:600;transition:color 0.2s;}
.mobile-menu a:hover{color:var(--red);}
.btn-cta{background:var(--red);color:var(--white);padding:14px 24px;border:none;font-weight:600;font-size:14px;cursor:pointer;transition:background 0.2s;text-decoration:none;display:inline-flex;align-items:center;gap:8px;}
.btn-cta:hover{background:var(--red-hover);}
.btn-outline{background:transparent;color:var(--white);padding:14px 24px;border:2px solid var(--white);font-weight:500;font-size:14px;cursor:pointer;text-decoration:none;transition:all 0.2s;}
.btn-outline:hover{background:var(--white);color:var(--black);}
.btn-white{background:var(--white);color:var(--black);padding:18px 40px;border:none;font-weight:700;font-size:14px;cursor:pointer;transition:all 0.3s;text-decoration:none;}
.btn-white:hover{transform:scale(1.05);}
.btn-sm{padding:12px 20px;font-size:14px;min-height:44px;min-width:44px;}
.hero{min-height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:120px 48px 80px;position:relative;overflow:hidden;}
.hero-media{position:absolute;top:0;left:0;width:100%;height:100%;z-index:1;}
.hero-media-container{position:absolute;top:0;left:0;width:100%;height:100%;overflow:hidden;}
.hero-media-container video{width:100%;height:100%;object-fit:cover;opacity:0.35;}
.hero-media-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(to bottom,rgba(0,0,0,0.7) 0%,rgba(0,0,0,0.55) 50%,rgba(0,0,0,0.9) 100%);z-index:2;}
.hero-content{position:relative;z-index:3;display:flex;flex-direction:column;align-items:center;text-align:center;}
.badge{display:inline-flex;align-items:center;gap:8px;padding:12px 24px;border:1px solid rgba(255,255,255,0.2);border-radius:50px;font-size:12px;font-weight:600;letter-spacing:2px;text-transform:uppercase;margin-bottom:32px;}
.badge::before{content:'';width:8px;height:8px;background:var(--red);border-radius:50%;animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1;}
50%{opacity:0.5;}
}
.hero h1{font-size:clamp(48px,12vw,140px);font-weight:900;line-height:0.95;letter-spacing:-2px;margin-bottom:32px;text-transform:uppercase;text-shadow:0 4px 20px rgba(0,0,0,0.5);}
.hero p{font-size:18px;color:rgba(255,255,255,0.95);max-width:600px;margin:0 auto 40px;line-height:1.6;text-align:center;text-shadow:0 2px 8px rgba(0,0,0,0.5);}
.hero p span{color:var(--red);}
.hero-buttons{display:flex;gap:16px;align-items:center;flex-wrap:wrap;justify-content:center;}
.scroll-indicator{position:absolute;bottom:40px;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;gap:8px;color:var(--gray);font-size:12px;font-weight:500;letter-spacing:2px;text-transform:uppercase;animation:bounce 2s infinite;z-index:3;}
@keyframes bounce{0%,100%{transform:translateX(-50%) translateY(0);}
50%{transform:translateX(-50%) translateY(10px);}
}
.stats-ticker{background:#000;padding:28px 0;overflow:hidden;border-top:3px solid var(--red);border-bottom:3px solid var(--red);}
.ticker-text{font-size:clamp(32px,7vw,64px);font-weight:900;white-space:nowrap;animation:ticker 15s linear infinite;color:var(--red);text-transform:uppercase;letter-spacing:6px;will-change:transform;-webkit-backface-visibility:hidden;backface-visibility:hidden;}
@keyframes ticker{0%{transform:translate3d(0,0,0);}
100%{transform:translate3d(-50%,0,0);}
}
@keyframes industriesScroll{0%{transform:translateX(0);}
100%{transform:translateX(-50%);}
}
@keyframes logoScroll{0%{transform:translateX(-50%);}
100%{transform:translateX(0);}
}
@keyframes clientScroll{0%{transform:translate3d(-50%,0,0);}
100%{transform:translate3d(0,0,0);}
}
.section{padding:100px 48px;}
.section.light{background:var(--white);color:var(--black);}
.section.dark{background:var(--black);color:var(--white);}
.section.gray{background:var(--gray-light);color:var(--black);}
.section-header{text-align:center;margin-bottom:60px;}
.section-title{font-size:clamp(36px,6vw,72px);font-weight:900;text-transform:uppercase;margin-bottom:16px;}
.section-title .red{color:var(--red);}
.section-subtitle{color:var(--gray);font-size:18px;max-width:600px;margin:0 auto;}
.label{font-size:12px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--gray);display:flex;align-items:center;gap:12px;margin-bottom:24px;}
.label::before{content:'';width:40px;height:2px;background:var(--red);}
.struggle-section{display:grid;grid-template-columns:1fr 1fr;gap:60px;align-items:start;max-width:1400px;margin:0 auto;}
.struggle-left h2{font-size:clamp(36px,6vw,72px);font-weight:900;line-height:1;text-transform:uppercase;margin-bottom:24px;}
.struggle-left h2 .red{color:var(--red);}
.struggle-left p{color:var(--gray);font-size:16px;line-height:1.7;margin-bottom:32px;}
.problem-cards{display:flex;flex-direction:column;gap:24px;}
.problem-card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);padding:32px;border-radius:4px;}
.problem-card .number{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border:2px solid var(--red);border-radius:50%;font-size:14px;font-weight:700;color:var(--red);flex-shrink:0;}
.problem-card h3{font-size:20px;font-weight:700;line-height:1.3;}
.services-layout{display:grid;grid-template-columns:1fr 2fr;gap:60px;max-width:1400px;margin:0 auto;}
.services-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:24px;}
.service-card{background:rgba(0,0,0,0.8);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);padding:0;border:1px solid rgba(255,59,48,0.2);border-radius:16px;transition:all 0.4s ease;cursor:pointer;display:flex;flex-direction:column;min-height:380px;overflow:hidden;position:relative;}
.service-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,59,48,0.1) 0%,transparent 50%,rgba(255,59,48,0.05) 100%);opacity:0;transition:opacity 0.4s ease;z-index:0;}
.service-card:hover{transform:translateY(-8px) scale(1.02);border-color:rgba(255,59,48,0.6);box-shadow:0 20px 60px rgba(255,59,48,0.3),0 0 40px rgba(255,59,48,0.1);}
.service-card:hover::before{opacity:1;}
.service-card-image{width:100%;height:140px;background-size:cover;background-position:center;position:relative;}
.service-card-image::after{content:'';position:absolute;inset:0;background:linear-gradient(to bottom,transparent 0%,rgba(0,0,0,0.9) 100%);}
.service-card-content{padding:28px;position:relative;z-index:1;flex-grow:1;display:flex;flex-direction:column;}
.service-card h3{font-size:22px;font-weight:800;margin-bottom:8px;color:#fff;text-transform:uppercase;letter-spacing:1px;}
.service-card .tagline{color:var(--red);font-size:13px;font-weight:600;text-transform:uppercase;letter-spacing:2px;margin-bottom:12px;}
.service-card p{color:rgba(255,255,255,0.7);font-size:14px;line-height:1.6;flex-grow:1;}
.service-card .includes{margin-top:16px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.1);}
.service-card .includes span{display:inline-block;background:rgba(255,59,48,0.15);color:var(--red);font-size:11px;font-weight:600;padding:4px 10px;border-radius:20px;margin:3px 4px 3px 0;}
.service-card-simple{background:#111;padding:40px;border:1px solid rgba(255,255,255,0.1);transition:all 0.3s;cursor:pointer;display:flex;flex-direction:column;min-height:280px;}
.service-card-simple:hover{background:#1a1a1a;transform:translateY(-4px);}
.service-card-simple .arrow{width:48px;height:48px;border:1px solid rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;margin-bottom:24px;transition:all 0.3s;}
.service-card-simple:hover .arrow{border-color:var(--red);color:var(--red);}
.service-card-simple h3{font-size:24px;font-weight:700;margin-bottom:12px;}
.service-card-simple p{color:var(--gray);font-size:14px;line-height:1.5;flex-grow:1;}
.service-item{display:grid;grid-template-columns:1fr 1fr;min-height:500px;}
.service-item.image-right{direction:rtl;}
.service-item.image-right > *{direction:ltr;}
.service-image{background:linear-gradient(135deg,#1a1a1a 0%,#2a2a2a 50%,#1a1a1a 100%);position:relative;}
.service-image::before{content:'';position:absolute;inset:0;background:linear-gradient(45deg,rgba(255,0,0,0.1),transparent);}
.service-content{padding:80px 60px;display:flex;flex-direction:column;justify-content:center;background:var(--white);color:var(--black);}
.service-number{font-size:12px;font-weight:700;color:var(--gray);letter-spacing:2px;margin-bottom:16px;}
.service-title{font-size:clamp(32px,4vw,48px);font-weight:900;margin-bottom:16px;line-height:1.1;}
.service-tagline{font-size:18px;color:var(--gray);margin-bottom:24px;}
.service-description{font-size:15px;color:#555;line-height:1.7;margin-bottom:24px;}
.service-benefits{display:flex;align-items:flex-start;gap:12px;margin-bottom:32px;}
.service-benefits .arrow-icon{color:var(--red);font-size:18px;margin-top:2px;}
.service-benefits p{font-size:14px;color:#666;}
.btn-service{background:var(--red);color:var(--white);padding:16px 32px;border:none;font-weight:600;font-size:14px;cursor:pointer;transition:all 0.3s;text-decoration:none;display:inline-flex;align-items:center;gap:10px;width:fit-content;}
.btn-service:hover{background:#fff;color:#000;transform:translateX(4px);}
.service-item:nth-child(even) .service-content{background:var(--gray-light);}
.portfolio-header{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:60px;max-width:1400px;margin-left:auto;margin-right:auto;}
.portfolio-header h2{font-size:clamp(48px,8vw,100px);font-weight:900;text-transform:uppercase;}
.portfolio-header h2 .red{color:var(--red);}
.portfolio-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:24px;max-width:1400px;margin:0 auto;}
.portfolio-card{position:relative;aspect-ratio:16/10;background:linear-gradient(135deg,#1a1a1a 0%,#2a2a2a 50%,#1a1a1a 100%);overflow:hidden;cursor:pointer;}
.portfolio-card::before{content:'';position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,0.9) 0%,transparent 50%);z-index:1;transition:opacity 0.3s;}
.portfolio-card:hover::before{opacity:0.7;}
.portfolio-card .content{position:absolute;bottom:0;left:0;right:0;padding:32px;z-index:2;transform:translateY(20px);opacity:0;transition:all 0.3s;}
.portfolio-card:hover .content{transform:translateY(0);opacity:1;}
.portfolio-card .tag{font-size:11px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:var(--red);margin-bottom:12px;}
.portfolio-card h3{font-size:24px;font-weight:700;margin-bottom:8px;}
.portfolio-card p{color:var(--gray);font-size:14px;}
.about-hero{min-height:70vh;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:120px 48px 80px;position:relative;background:url('https://images.unsplash.com/photo-1534430480872-3498386e7856?w=1920&q=80') center/cover no-repeat;}
.about-hero::before{content:'';position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,0.75) 0%,rgba(0,0,0,0.85) 50%,rgba(0,0,0,0.95) 100%);z-index:1;}
.about-hero .hero-content{position:relative;z-index:2;}
.about-hero h1{font-size:clamp(48px,10vw,120px);font-weight:900;text-transform:uppercase;text-shadow:0 4px 40px rgba(0,0,0,0.5);}
.about-hero h1 span{color:var(--red);text-shadow:0 0 60px rgba(255,59,48,0.4);}
.about-hero p{font-size:20px;color:rgba(255,255,255,0.85);max-width:600px;margin-top:24px;text-shadow:0 2px 10px rgba(0,0,0,0.3);}
.story-section{display:grid;grid-template-columns:1fr 1fr;gap:80px;align-items:center;max-width:1400px;margin:0 auto;}
.story-content h2{font-size:clamp(36px,5vw,56px);font-weight:900;line-height:1.1;text-transform:uppercase;margin-bottom:24px;}
.story-content h2 .red{color:var(--red);}
.story-content p{color:var(--gray);font-size:16px;line-height:1.8;margin-bottom:16px;}
.story-image{aspect-ratio:4/5;background:linear-gradient(135deg,#1a1a1a 0%,#2a2a2a 50%,#1a1a1a 100%);}
.values-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:24px;max-width:1200px;margin:0 auto;}
.value-card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);padding:40px 32px;text-align:center;transition:all 0.3s;}
.value-card:hover{border-color:var(--red);transform:translateY(-8px);}
.value-card .number{font-size:48px;font-weight:900;color:var(--red);opacity:0.3;margin-bottom:16px;}
.value-card h3{font-size:20px;font-weight:700;margin-bottom:12px;}
.value-card p{color:var(--gray);font-size:14px;line-height:1.6;}
.team-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:48px;max-width:1000px;margin:0 auto;}
.team-card{text-align:center;}
.team-photo{width:100%;aspect-ratio:3/4;background:linear-gradient(145deg,#0a0a0a,#151515);border:1px solid rgba(255,255,255,0.08);border-radius:16px;margin-bottom:24px;overflow:hidden;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.2);font-size:14px;position:relative;}
.team-photo::before{content:'';position:absolute;inset:0;background:linear-gradient(180deg,transparent 60%,rgba(255,59,48,0.15) 100%);pointer-events:none;}
.team-photo img{width:100%;height:100%;object-fit:cover;}
.team-name{font-size:24px;font-weight:800;margin-bottom:8px;}
.team-title{color:var(--red);font-size:12px;text-transform:uppercase;letter-spacing:3px;font-weight:700;margin-bottom:16px;}
.team-bio{color:var(--gray);font-size:14px;line-height:1.7;}
.why-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:32px;max-width:1200px;margin:0 auto;}
.why-card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);padding:40px;text-align:center;transition:all 0.3s;}
.why-card:hover{border-color:var(--red);}
.why-card .icon{width:64px;height:64px;background:var(--red);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 24px;font-size:24px;}
.why-card h3{font-size:20px;font-weight:700;margin-bottom:12px;}
.why-card p{color:var(--gray);font-size:14px;line-height:1.6;}
.roots-section{display:grid;grid-template-columns:1fr 1fr;gap:60px;align-items:center;max-width:1400px;margin:0 auto;}
.roots-left h2{font-size:clamp(48px,8vw,96px);font-weight:900;line-height:0.95;text-transform:uppercase;margin-bottom:24px;}
.roots-left h2 .red{color:var(--red);}
.roots-left p{color:var(--gray);font-size:18px;line-height:1.7;}
.roots-right{position:relative;border-radius:16px;overflow:hidden;min-height:350px;display:flex;align-items:center;justify-content:center;}
.roots-right::before{content:'';position:absolute;inset:0;background:url('https://images.unsplash.com/photo-1534430480872-3498386e7856?w=800') center/cover no-repeat;filter:brightness(0.4);}
.roots-right::after{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,59,48,0.2) 0%,transparent 50%,rgba(0,0,0,0.8) 100%);}
.area-code{font-size:clamp(120px,20vw,250px);font-weight:900;color:transparent;-webkit-text-stroke:3px var(--red);text-align:center;position:relative;z-index:1;text-shadow:0 0 60px rgba(255,59,48,0.5);}
.testimonials-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:24px;max-width:1200px;margin:0 auto;padding:0 24px;}
.testimonial-card{background:linear-gradient(145deg,#1a1a1a 0%,#0d0d0d 100%);border:1px solid rgba(255,255,255,0.08);padding:32px;border-radius:16px;transition:all 0.3s ease;}
.testimonial-card:hover{transform:translateY(-4px);border-color:rgba(255,59,48,0.3);box-shadow:0 20px 40px rgba(0,0,0,0.4);}
.testimonial-card .stars{display:flex;gap:4px;margin-bottom:20px;color:var(--red);font-size:16px;}
.testimonial-card p{font-size:15px;line-height:1.8;font-style:italic;margin-bottom:24px;color:rgba(255,255,255,0.85);}
.testimonial-card .author{display:flex;align-items:center;gap:14px;border-top:1px solid rgba(255,255,255,0.08);padding-top:20px;}
.testimonial-card .avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--red),#ff6b5b);}
.testimonial-card .author-name{font-weight:700;margin-bottom:4px;color:#fff;}
.testimonial-card .author-title{font-size:12px;color:rgba(255,255,255,0.5);}
.cta-section{background:var(--red);padding:100px 48px;text-align:center;}
.cta-section h2{font-size:clamp(36px,6vw,72px);font-weight:900;text-transform:uppercase;margin-bottom:24px;}
.cta-section p{font-size:18px;margin-bottom:40px;opacity:0.9;}
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:32px;max-width:1200px;margin:0 auto;text-align:center;}
.stat-item .value{font-size:clamp(48px,8vw,72px);font-weight:900;line-height:1;margin-bottom:8px;}
.stat-item .stat-label{font-size:14px;font-weight:600;text-transform:uppercase;letter-spacing:1px;opacity:0.9;}
.brands-elevated-section{padding:80px 48px;}
.case-study-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:32px;max-width:1400px;margin:0 auto;}
.case-study-grid > a{cursor:pointer;position:relative;aspect-ratio:16/9;border-radius:16px;overflow:hidden;display:flex;align-items:flex-end;border:1px solid rgba(255,255,255,0.1);transition:all 0.3s;box-shadow:0 20px 60px rgba(0,0,0,0.4);}
.results-section{padding:80px 48px;}
.stats-boxes{display:grid;grid-template-columns:repeat(4,1fr);gap:24px;max-width:1200px;margin:0 auto;text-align:center;}
.stat-box{padding:40px 24px;background:linear-gradient(145deg,rgba(255,59,48,0.08) 0%,rgba(255,59,48,0.02) 100%);border:1px solid rgba(255,59,48,0.2);border-radius:20px;transition:all 0.3s ease;}
.stat-box:hover{transform:translateY(-6px);border-color:rgba(255,59,48,0.4);box-shadow:0 20px 40px rgba(255,59,48,0.15);}
.stat-number{font-size:clamp(40px,10vw,72px);font-weight:900;color:var(--red);line-height:1;}
.stat-box .stat-label{font-size:13px;color:rgba(255,255,255,0.6);text-transform:uppercase;letter-spacing:2px;margin-top:12px;font-weight:600;}
.footer{background:#050505;padding:0;border-top:1px solid rgba(255,255,255,0.08);}
.footer-main{max-width:1400px;margin:0 auto;padding:72px 48px 40px;display:grid;grid-template-columns:1.5fr 1fr 1fr 1fr 1.2fr;gap:48px;}
.footer-brand{}
.footer-brand-logo{display:flex;align-items:center;gap:12px;margin-bottom:20px;cursor:pointer;text-decoration:none;}
.footer-brand-logo img{height:40px;}
.footer-brand-logo span{font-weight:800;font-size:22px;color:#fff;}
.footer-brand-desc{font-size:14px;color:rgba(255,255,255,0.5);line-height:1.7;margin-bottom:24px;}
.footer-socials{display:flex;gap:12px;}
.footer-social-link{width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.5);text-decoration:none;font-size:16px;transition:all 0.3s;}
.footer-social-link:hover{background:var(--red);color:#fff;transform:translateY(-2px);}
.footer-col-title{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:#fff;margin-bottom:20px;}
.footer-col a{display:block;color:rgba(255,255,255,0.45);text-decoration:none;font-size:14px;padding:6px 0;cursor:pointer;transition:color 0.2s;}
.footer-col a:hover{color:var(--red);}
.footer-contact-item{display:flex;align-items:start;gap:10px;margin-bottom:14px;font-size:14px;color:rgba(255,255,255,0.5);}
.footer-contact-icon{color:var(--red);font-size:16px;flex-shrink:0;margin-top:1px;}
.footer-contact-item a{color:rgba(255,255,255,0.5);text-decoration:none;transition:color 0.2s;display:inline;padding:0;}
.footer-contact-item a:hover{color:var(--red);}
.footer-bottom{border-top:1px solid rgba(255,255,255,0.06);padding:24px 48px;}
.footer-bottom-content{max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px;}
.footer-copyright{font-size:13px;color:rgba(255,255,255,0.3);}
.footer-legal{display:flex;gap:24px;}
.footer-legal a{font-size:13px;color:rgba(255,255,255,0.3);text-decoration:none;cursor:pointer;transition:color 0.2s;}
.footer-legal a:hover{color:rgba(255,255,255,0.6);}
.footer-badge{font-size:11px;color:rgba(255,255,255,0.2);display:flex;align-items:center;gap:6px;}
@media (max-width:968px){.nav{padding:16px 24px;}
.nav-links{display:none;}
.hamburger{display:flex;}
.btn-cta-desktop{display:none;}
.service-card{min-height:320px;}
.service-card-image{height:120px;}
.service-card-content{padding:20px;}
.service-card h3{font-size:18px;}
.service-card .tagline{font-size:11px;}
.service-card p{font-size:13px;}
.hero{padding:100px 24px 60px;}
.section{padding:60px 24px;}
.struggle-section{grid-template-columns:1fr;}
.services-layout{grid-template-columns:1fr;gap:48px;}
.services-grid{grid-template-columns:1fr;}
.service-item{grid-template-columns:1fr;min-height:auto;}
.service-item.image-right{direction:ltr;}
.service-image{min-height:250px;}
.service-content{padding:48px 24px;}
.roots-section{grid-template-columns:1fr;text-align:center;}
.story-section{grid-template-columns:1fr;gap:48px;}
.why-grid{grid-template-columns:1fr;}
.values-grid{grid-template-columns:repeat(2,1fr);}
.team-grid{grid-template-columns:1fr;gap:48px;max-width:400px;padding:0 24px;}
.team-photo{aspect-ratio:1/1;border-radius:12px;max-width:280px;margin:0 auto 20px;}
.team-name{font-size:22px;}
.team-title{font-size:11px;letter-spacing:2px;}
.team-bio{font-size:13px;padding:0 8px;}
.testimonials-grid{grid-template-columns:repeat(2,1fr) !important;gap:20px !important;}
.testimonial-card{padding:28px;}
.portfolio-grid{grid-template-columns:1fr;}
.portfolio-header{flex-direction:column;align-items:flex-start;gap:24px;}
.stats-grid,.results-grid{grid-template-columns:repeat(2,1fr);}
.results-section{padding:60px 24px;}
.stats-boxes{grid-template-columns:repeat(2,1fr);gap:16px;}
.stat-box{padding:32px 16px;border-radius:16px;}
.stat-number{font-size:clamp(36px,8vw,56px);}
.brands-elevated-section{padding:60px 24px;}
.case-study-grid{gap:24px;}
.cta-section{padding:60px 24px;}
.results-grid{gap:16px;}
.footer-main{padding:48px 24px 32px;grid-template-columns:1fr 1fr;gap:32px;}
.footer-brand{grid-column:1 / -1;}
.footer-bottom{padding:20px 24px;}
.footer-bottom-content{flex-direction:column;text-align:center;}
.case-header{padding:24px;}
.case-header-left{gap:16px;}
.case-logo{width:56px;height:56px;}
.case-info h3{font-size:20px;}
.case-tabs{padding:0 16px;flex-wrap:wrap;}
.case-tab{padding:12px 16px;font-size:11px;}
.logo-grid{grid-template-columns:1fr;gap:20px;}
.color-grid{grid-template-columns:repeat(2,1fr);}
.font-grid{grid-template-columns:1fr;}
.mockup-row.split{grid-template-columns:1fr 1fr;}
.brand-hero{aspect-ratio:16/9 !important;min-height:280px !important;}
.brand-hero h2{font-size:32px !important;}
}
@media (max-width:580px){.nav{padding:12px 16px;}
.nav .logo img{height:32px;}
.hamburger{padding:8px;}
.hero{padding:80px 16px 40px;}
.hero h1{font-size:clamp(48px,13vw,72px);letter-spacing:-1px;}
.hero p{font-size:15px;}
.hero-buttons{flex-direction:column;width:100%;max-width:280px;}
.hero-buttons a{width:100%;text-align:center;padding:14px 20px;font-size:13px;}
.section{padding:48px 16px;}
.section-title{font-size:28px;}
.stats-ticker{padding:16px 0;}
.ticker-text{font-size:20px !important;letter-spacing:2px !important;}
.problem-card{padding:20px;}
.problem-card h3{font-size:16px;}
.service-card{min-height:auto;}
.service-card-image{height:100px;}
.service-card-content{padding:16px;}
.service-card h3{font-size:16px;}
.service-card .tagline{font-size:10px;margin-bottom:8px;}
.service-card p{font-size:12px;}
.service-card .includes{margin-top:12px;padding-top:12px;}
.service-card .includes span{font-size:9px;padding:3px 8px;}
.service-card-simple{padding:24px;min-height:200px;}
.service-card-simple h3{font-size:18px;}
.roots-right{min-height:200px !important;}
.area-code{font-size:80px !important;}
.why-card{padding:24px;}
.testimonials-grid{grid-template-columns:1fr !important;gap:16px !important;padding:0 16px;}
.testimonial-card{padding:24px;background:linear-gradient(135deg,#1a1a1a 0%,#111 100%);border:1px solid rgba(255,255,255,0.1);border-radius:16px;}
.testimonial-card .stars{margin-bottom:16px;font-size:14px;}
.testimonial-card p{font-size:14px;line-height:1.7;margin-bottom:20px;}
.testimonial-card .author{padding-top:16px;gap:12px;}
.testimonial-card .avatar{width:40px;height:40px;}
.testimonial-card .author-name{font-size:14px;}
.testimonial-card .author-title{font-size:11px;}
.cta-section h2{font-size:28px;}
.case-study{border-radius:16px;margin-bottom:16px;}
.case-header{padding:20px 16px;flex-wrap:wrap;gap:16px;}
.case-header-left{width:100%;}
.case-logo{width:48px;height:48px;border-radius:12px;}
.case-info h3{font-size:18px;}
.case-info .tag{font-size:9px;padding:4px 10px;}
.case-toggle{width:40px;height:40px;font-size:14px;}
.case-tabs{padding:0 12px;gap:0;}
.case-tab{padding:10px 12px;font-size:10px;letter-spacing:1px;}
.case-panels{padding:0 !important;}
.case-panel{padding:24px 16px !important;}
.brand-hero{aspect-ratio:4/3 !important;}
.brand-hero h2{font-size:24px !important;letter-spacing:0 !important;}
.brand-hero p{font-size:14px !important;display:none;}
.brand-section{margin-bottom:32px;}
.brand-section-title{font-size:10px;letter-spacing:2px;}
.logo-grid{gap:16px;}
.logo-box{border-radius:16px;}
.logo-box-label{font-size:10px;padding:14px 16px;}
.logo-box-img{padding:20px;}
.logo-placeholder{width:60px;height:60px;font-size:10px;}
.color-grid{gap:12px;}
.color-box{border-radius:12px;padding:12px;}
.color-hex{font-size:10px;}
.font-box{padding:20px;border-radius:12px;}
.font-name{font-size:24px;}
.font-sample{font-size:12px;}
.mockup-box{border-radius:12px;}
.results-grid{grid-template-columns:1fr !important;gap:12px;}
.result-card{padding:24px;border-radius:16px;}
.result-number{font-size:40px;}
.result-label{font-size:10px;}
.results-section{padding:48px 16px;}
.stats-boxes{grid-template-columns:1fr !important;gap:12px;padding:0;}
.stat-box{padding:24px 20px;border-radius:12px;display:flex;align-items:center;justify-content:space-between;text-align:left;background:var(--red);border:none;width:100%;}
.stat-box .stat-number{font-size:42px;color:#fff !important;}
.stat-box .stat-label{font-size:14px;letter-spacing:1px;margin-top:0;text-align:right;max-width:140px;line-height:1.3;color:rgba(255,255,255,0.9) !important;font-weight:600;}
.brands-elevated-section{padding:48px 16px;}
.case-study-grid{grid-template-columns:1fr !important;gap:20px;}
.case-study-grid > a{aspect-ratio:4/3;border-radius:12px;}
.case-study-grid > a > div:last-child{padding:20px !important;}
.case-study-grid > a h4{font-size:22px !important;}
.case-study-grid > a p{font-size:13px !important;margin-top:8px !important;}
.portfolio-card-btn{opacity:1 !important;transform:translateY(0) !important;}
.portfolio-card-overlay{background:linear-gradient(to top,rgba(0,0,0,0.95) 0%,rgba(0,0,0,0.7) 50%,rgba(0,0,0,0.4) 100%) !important;}
.portfolio-card-image{min-height:220px;object-fit:cover;}
.portfolio-preview-card{border-radius:16px !important;}
.portfolio-card-title{font-size:20px !important;}
.portfolio-card-desc{font-size:13px !important;-webkit-line-clamp:3 !important;}
.package-image{height:200px;margin-bottom:40px;}
.package-header{margin-bottom:40px;}
.package-title{font-size:32px !important;}
.package-price{font-size:36px !important;}
.website-preview{border-radius:12px;}
.website-preview img{height:250px;}
.testimonial-box{padding:24px;}
.testimonial-box p{font-size:16px;}
.footer-main{grid-template-columns:1fr;padding:32px 16px 20px;gap:0;}
.footer-brand{margin-bottom:24px;padding-bottom:20px;border-bottom:1px solid rgba(255,255,255,0.06);}
.footer-col{border-bottom:1px solid rgba(255,255,255,0.06);overflow:hidden;}
.footer-col-title{margin-bottom:0;padding:16px 0;cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
.footer-col-title::after{content:'+';font-size:18px;color:rgba(255,255,255,0.3);font-weight:400;transition:transform 0.3s;}
.footer-col.open .footer-col-title::after{content:'−';}
.footer-col a{max-height:0;padding:0;opacity:0;transition:max-height 0.3s,padding 0.2s,opacity 0.2s;overflow:hidden;}
.footer-col.open a{max-height:40px;padding:6px 0;opacity:1;}
.footer-col .footer-contact-item{max-height:0;padding:0;margin:0;opacity:0;transition:max-height 0.3s,padding 0.2s,opacity 0.2s,margin 0.2s;overflow:hidden;}
.footer-col.open .footer-contact-item{max-height:60px;padding:0;margin-bottom:14px;opacity:1;}
.footer-bottom{padding:16px;}
.footer-legal{gap:16px;}
.intake-wizard{padding:16px;}
.wizard-content{padding:28px 20px;border-radius:16px;}
.wizard-progress{margin-bottom:32px;}
.wizard-step-number{width:36px;height:36px;font-size:13px;}
.wizard-step-label{font-size:9px;letter-spacing:1px;display:none;}
.wizard-step.active .wizard-step-label{display:block;}
.wizard-title{font-size:24px;}
.wizard-subtitle{font-size:14px;margin-bottom:24px;}
.wizard-input,.wizard-select,.wizard-textarea{padding:14px 16px;font-size:15px;}
.wizard-radio{padding:14px 16px;}
.wizard-radio-content h4{font-size:15px;}
.wizard-radio-content p{font-size:13px;}
.wizard-buttons{flex-direction:column;}
.wizard-btn{width:100%;text-align:center;padding:16px;}
.wizard-btn-next,.wizard-btn-submit{margin-left:0;}
.file-upload-zone{padding:32px 20px;}
.intake-service-header{padding:40px 20px;}
.intake-service-name{font-size:32px;}
.intake-service-price{font-size:22px;}
}
.intake-wizard{max-width:800px;margin:0 auto;padding:40px;}
.wizard-progress{display:flex;justify-content:space-between;margin-bottom:48px;position:relative;}
.wizard-progress::before{content:'';position:absolute;top:20px;left:0;right:0;height:3px;background:rgba(255,255,255,0.15);z-index:0;border-radius:2px;}
.wizard-progress-fill{position:absolute;top:20px;left:0;height:3px;background:linear-gradient(90deg,var(--red),#ff6b6b);z-index:1;transition:width 0.4s ease;border-radius:2px;box-shadow:0 0 20px rgba(255,59,48,0.4);}
.wizard-step{display:flex;flex-direction:column;align-items:center;position:relative;z-index:2;}
.wizard-step-number{width:44px;height:44px;border-radius:50%;background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.5);border:2px solid rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:15px;transition:all 0.3s;backdrop-filter:blur(10px);}
.wizard-step.active .wizard-step-number{background:var(--red);color:white;border-color:var(--red);transform:scale(1.15);box-shadow:0 0 30px rgba(255,59,48,0.5);}
.wizard-step.completed .wizard-step-number{background:var(--green);color:white;border-color:var(--green);}
.wizard-step-label{margin-top:12px;font-size:11px;font-weight:600;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:2px;}
.wizard-step.active .wizard-step-label{color:#fff;}
.wizard-step.completed .wizard-step-label{color:var(--green);}
.wizard-content{background:linear-gradient(145deg,#1a1a1a 0%,#0d0d0d 100%);border-radius:20px;padding:56px;box-shadow:0 25px 80px rgba(0,0,0,0.6),inset 0 1px 0 rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);}
.wizard-panel{display:none;animation:fadeIn 0.4s ease;}
.wizard-panel.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}
to{opacity:1;transform:translateY(0);}
}
.wizard-title{font-size:32px;font-weight:800;color:#fff;margin-bottom:12px;letter-spacing:-0.5px;}
.wizard-subtitle{font-size:16px;color:rgba(255,255,255,0.6);margin-bottom:40px;line-height:1.6;}
.wizard-field{margin-bottom:28px;}
.wizard-label{display:block;font-size:13px;font-weight:700;color:rgba(255,255,255,0.9);margin-bottom:10px;text-transform:uppercase;letter-spacing:1.5px;}
.wizard-input{width:100%;padding:18px 20px;border:2px solid rgba(255,255,255,0.15);border-radius:12px;font-size:16px;transition:all 0.3s;background:rgba(255,255,255,0.05);color:#fff;backdrop-filter:blur(10px);}
.wizard-input::placeholder{color:rgba(255,255,255,0.35);}
.wizard-input:focus{outline:none;border-color:var(--red);background:rgba(255,255,255,0.08);box-shadow:0 0 30px rgba(255,59,48,0.15);}
.wizard-select{width:100%;padding:18px 20px;border:2px solid rgba(255,255,255,0.15);border-radius:12px;font-size:16px;background:rgba(255,255,255,0.05);color:#fff;cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 16px center;}
.wizard-select option{background:#1a1a1a;color:#fff;}
.wizard-textarea{width:100%;padding:18px 20px;border:2px solid rgba(255,255,255,0.15);border-radius:12px;font-size:16px;resize:vertical;min-height:140px;background:rgba(255,255,255,0.05);color:#fff;}
.wizard-textarea::placeholder{color:rgba(255,255,255,0.35);}
.wizard-textarea:focus{outline:none;border-color:var(--red);background:rgba(255,255,255,0.08);}
.wizard-radio-group{display:flex;flex-direction:column;gap:14px;}
.wizard-radio{display:flex;align-items:center;padding:20px 24px;border:2px solid rgba(255,255,255,0.12);border-radius:14px;cursor:pointer;transition:all 0.3s;background:rgba(255,255,255,0.03);}
.wizard-radio:hover{border-color:rgba(255,255,255,0.25);background:rgba(255,255,255,0.06);transform:translateX(4px);}
.wizard-radio.selected{border-color:var(--red);background:rgba(255,59,48,0.1);box-shadow:0 0 30px rgba(255,59,48,0.15);}
.wizard-radio input{display:none;}
.wizard-radio-check{width:26px;height:26px;border:2px solid rgba(255,255,255,0.3);border-radius:50%;margin-right:18px;display:flex;align-items:center;justify-content:center;transition:all 0.3s;flex-shrink:0;}
.wizard-radio.selected .wizard-radio-check{border-color:var(--red);background:var(--red);box-shadow:0 0 15px rgba(255,59,48,0.4);}
.wizard-radio.selected .wizard-radio-check::after{content:'✓';color:white;font-size:14px;font-weight:700;}
.wizard-radio-content h4{font-size:17px;font-weight:700;color:#fff;margin-bottom:6px;}
.wizard-radio-content p{font-size:14px;color:rgba(255,255,255,0.5);line-height:1.5;}
.file-upload-zone{border:2px dashed rgba(255,255,255,0.2);border-radius:16px;padding:56px;text-align:center;cursor:pointer;transition:all 0.3s;background:rgba(255,255,255,0.03);}
.file-upload-zone:hover,.file-upload-zone.dragover{border-color:var(--red);background:rgba(255,59,48,0.08);}
.file-upload-icon{font-size:52px;margin-bottom:20px;filter:grayscale(0);}
.file-upload-text{font-size:17px;color:#fff;margin-bottom:10px;font-weight:600;}
.file-upload-hint{font-size:14px;color:rgba(255,255,255,0.4);}
.file-upload-input{display:none;}
.uploaded-files{margin-top:20px;display:flex;flex-wrap:wrap;gap:12px;}
.uploaded-file{display:flex;align-items:center;gap:10px;padding:12px 18px;background:rgba(255,255,255,0.1);border-radius:10px;font-size:14px;color:#fff;border:1px solid rgba(255,255,255,0.15);}
.uploaded-file-remove{color:var(--red);cursor:pointer;font-weight:700;font-size:18px;}
.wizard-buttons{display:flex;gap:16px;margin-top:40px;padding-top:32px;border-top:1px solid rgba(255,255,255,0.1);}
.wizard-btn{padding:18px 36px;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;transition:all 0.3s;text-transform:uppercase;letter-spacing:1px;}
.wizard-btn-back{background:transparent;border:2px solid rgba(255,255,255,0.2);color:rgba(255,255,255,0.7);}
.wizard-btn-back:hover{border-color:#fff;color:#fff;background:rgba(255,255,255,0.05);}
.wizard-btn-next{background:linear-gradient(135deg,var(--red) 0%,#ff6b6b 100%);border:none;color:white;margin-left:auto;box-shadow:0 8px 30px rgba(255,59,48,0.35);}
.wizard-btn-next:hover{transform:translateY(-2px) translateX(4px);box-shadow:0 12px 40px rgba(255,59,48,0.5);}
.wizard-btn-submit{background:linear-gradient(135deg,var(--green) 0%,#34d399 100%);border:none;color:white;margin-left:auto;box-shadow:0 8px 30px rgba(16,185,129,0.35);}
.wizard-btn-submit:hover{transform:translateY(-2px);box-shadow:0 12px 40px rgba(16,185,129,0.5);}
.wizard-sales-copy{background:linear-gradient(135deg,rgba(255,59,48,0.1) 0%,rgba(255,59,48,0.05) 100%);border-radius:16px;padding:28px;margin-bottom:36px;border-left:4px solid var(--red);}
.wizard-sales-copy .hook{font-size:20px;font-weight:800;color:#fff;margin-bottom:16px;line-height:1.4;}
.wizard-sales-copy .problem{font-size:15px;color:rgba(255,255,255,0.7);margin-bottom:12px;line-height:1.6;}
.wizard-sales-copy .solution{font-size:15px;color:rgba(255,255,255,0.85);margin-bottom:12px;line-height:1.6;}
.wizard-sales-copy .proof{font-size:14px;color:var(--green);font-weight:600;padding-top:12px;border-top:1px solid rgba(255,255,255,0.1);}
.brand-portal-header{padding:60px;background:linear-gradient(135deg,var(--client-primary,#000) 0%,var(--client-secondary,#333) 100%);color:white;text-align:center;}
.brand-portal-logo{max-height:80px;margin-bottom:24px;}
.brand-portal-title{font-size:36px;font-weight:800;margin-bottom:8px;}
.brand-portal-subtitle{font-size:16px;opacity:0.8;}
.brand-section{padding:60px;border-bottom:1px solid #e5e5e5;}
.brand-section:nth-child(even){background:#fafafa;}
.brand-section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:32px;}
.brand-section-title{font-size:24px;font-weight:700;display:flex;align-items:center;gap:12px;}
.brand-section-title::before{content:'';width:4px;height:24px;background:var(--client-primary,var(--red));border-radius:2px;}
.brand-download-all{padding:12px 24px;background:#000;color:white;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;}
.brand-download-all:hover{background:#333;}
.logo-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:24px;}
.logo-card{background:white;border:1px solid #e5e5e5;border-radius:12px;overflow:hidden;transition:all 0.3s;}
.logo-card:hover{box-shadow:0 8px 32px rgba(0,0,0,0.1);transform:translateY(-4px);}
.logo-preview{height:160px;display:flex;align-items:center;justify-content:center;padding:24px;}
.logo-preview.dark-bg{background:#1a1a1a;}
.logo-preview.light-bg{background:#f5f5f5;}
.logo-preview.color-bg{background:var(--client-primary,var(--red));}
.logo-preview img{max-width:100%;max-height:100%;object-fit:contain;}
.logo-info{padding:16px;border-top:1px solid #e5e5e5;display:flex;justify-content:space-between;align-items:center;}
.logo-name{font-size:14px;font-weight:600;}
.logo-format{font-size:12px;color:#888;}
.logo-download{padding:8px 16px;background:var(--client-primary,var(--red));color:white;border:none;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;}
.color-palette{display:flex;gap:0;border-radius:12px;overflow:hidden;box-shadow:0 4px 16px rgba(0,0,0,0.1);}
.color-swatch{flex:1;min-height:180px;display:flex;flex-direction:column;justify-content:flex-end;padding:20px;cursor:pointer;transition:transform 0.2s;position:relative;}
.color-swatch:hover{transform:scale(1.02);z-index:1;}
.color-info{background:rgba(255,255,255,0.95);padding:12px;border-radius:8px;}
.color-name{font-size:14px;font-weight:600;color:#000;margin-bottom:4px;}
.color-hex{font-size:13px;color:#666;font-family:monospace;}
.color-copy{position:absolute;top:16px;right:16px;background:rgba(255,255,255,0.9);border:none;padding:8px 12px;border-radius:6px;font-size:12px;cursor:pointer;opacity:0;transition:opacity 0.2s;}
.color-swatch:hover .color-copy{opacity:1;}
.typography-showcase{display:grid;grid-template-columns:1fr 1fr;gap:32px;}
.typography-card{background:white;border:1px solid #e5e5e5;border-radius:12px;padding:32px;}
.typography-label{font-size:12px;font-weight:600;color:#888;text-transform:uppercase;letter-spacing:1px;margin-bottom:16px;}
.typography-preview{margin-bottom:24px;}
.typography-preview h2{font-size:48px;font-weight:800;color:#000;line-height:1.1;}
.typography-preview p{font-size:18px;color:#666;line-height:1.6;}
.typography-specimen{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;}
.typography-specimen span{background:#f5f5f5;padding:8px 12px;border-radius:4px;font-size:14px;}
.typography-download{display:flex;align-items:center;gap:12px;padding:16px;background:#f5f5f5;border-radius:8px;}
.typography-download-btn{padding:8px 16px;background:#000;color:white;border:none;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;}
.elements-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:20px;}
.element-card{background:white;border:1px solid #e5e5e5;border-radius:12px;overflow:hidden;transition:all 0.3s;}
.element-card:hover{box-shadow:0 8px 24px rgba(0,0,0,0.1);}
.element-preview{height:140px;background:#f5f5f5;display:flex;align-items:center;justify-content:center;padding:20px;}
.element-preview img{max-width:100%;max-height:100%;object-fit:contain;}
.element-info{padding:16px;}
.element-name{font-size:14px;font-weight:600;margin-bottom:8px;}
.element-actions{display:flex;gap:8px;}
.element-btn{flex:1;padding:8px;border:1px solid #e5e5e5;background:white;border-radius:6px;font-size:12px;cursor:pointer;}
.element-btn:hover{background:#f5f5f5;}
.mockups-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:24px;}
.mockup-card{background:white;border-radius:16px;overflow:hidden;box-shadow:0 4px 16px rgba(0,0,0,0.08);transition:all 0.3s;}
.mockup-card:hover{box-shadow:0 12px 40px rgba(0,0,0,0.15);transform:translateY(-8px);}
.mockup-image{width:100%;height:240px;object-fit:cover;}
.mockup-info{padding:20px;display:flex;justify-content:space-between;align-items:center;}
.mockup-name{font-size:16px;font-weight:600;}
.mockup-download{padding:10px 20px;background:var(--client-primary,var(--red));color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;}
.intake-view{background:linear-gradient(180deg,#0a0a0a 0%,#111 50%,#0d0d0d 100%);min-height:100vh;padding-top:100px;}
.intake-service-header{text-align:center;padding:60px 40px;margin-bottom:20px;}
.intake-service-badge{display:inline-block;padding:10px 24px;background:linear-gradient(135deg,var(--red) 0%,#ff6b6b 100%);color:white;border-radius:25px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:2px;margin-bottom:20px;box-shadow:0 8px 30px rgba(255,59,48,0.3);}
.intake-service-name{font-size:48px;font-weight:900;color:#fff;margin-bottom:12px;letter-spacing:-1px;text-shadow:0 4px 30px rgba(0,0,0,0.3);}
.intake-service-price{font-size:28px;color:var(--red);font-weight:800;text-shadow:0 0 40px rgba(255,59,48,0.3);}
.success-screen{text-align:center;padding:80px 40px;}
.success-icon{font-size:90px;margin-bottom:28px;filter:drop-shadow(0 0 40px rgba(16,185,129,0.4));}
.success-title{font-size:40px;font-weight:900;color:#fff;margin-bottom:20px;letter-spacing:-0.5px;}
.success-message{font-size:18px;color:rgba(255,255,255,0.7);max-width:520px;margin:0 auto 40px;line-height:1.7;}
.success-details{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:28px;max-width:420px;margin:0 auto 40px;text-align:left;backdrop-filter:blur(10px);}
.success-detail{display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid rgba(255,255,255,0.08);}
.success-detail:last-child{border:none;}
.success-detail-label{color:rgba(255,255,255,0.5);font-size:14px;}
.success-detail-value{font-weight:700;color:#fff;font-size:14px;}
.scroll-progress{position:fixed;top:0;left:0;height:3px;background:linear-gradient(90deg,#ff0000,#cc0000);z-index:9999;width:0%;transition:width 0.1s linear;pointer-events:none;}</style>
    <!-- Geo Meta Tags -->
    <meta name="geo.region" content="US-MI">
    <meta name="geo.placename" content="Detroit, Michigan">
    <meta name="geo.position" content="42.3314;-83.0458">
    <meta name="ICBM" content="42.3314, -83.0458">
</head>
<body>
 <div class="scroll-progress" id="scrollProgress"></div>
 <nav class="nav">
<a class="logo" href="/" id="mainNavLogo" onclick="event.preventDefault(); showView('home');"><img src="icons/icon-192.png" alt="New Urban Influence – Detroit Branding Agency" width="36" height="36" style="height:36px;width:36px;display:block;" onerror="this.style.display='none';this.nextElementSibling.style.position='static';this.nextElementSibling.style.clip='auto';this.nextElementSibling.style.width='auto';this.nextElementSibling.style.height='auto';this.nextElementSibling.style.overflow='visible';"><span style="position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;">NUI | New Urban Influence</span></a>
<div class="nav-links">
<a href="/" class="active" data-view="home" onclick="event.preventDefault(); showView('home');">Home</a>
<a href="/about" data-view="about" onclick="event.preventDefault(); showView('about');">About</a>
<a href="/services/brand-identity-packages-detroit" data-view="services" onclick="event.preventDefault(); showView('services');">Services</a>
<a href="/portfolio" data-view="portfolio" onclick="event.preventDefault(); showView('portfolio');">Portfolio</a>
<a href="/blog" data-view="blog" onclick="event.preventDefault(); showView('blog');">Blog</a>
<a href="/portal" data-view="portal" onclick="event.preventDefault(); showView('portal');">Client Portal</a>
</div>
<a href="/contact" class="btn-cta btn-cta-desktop" onclick="event.preventDefault(); showView('intake');">Book a Strategy Call</a>
<div class="hamburger" onclick="toggleMobileMenu()">
<span></span><span></span><span></span>
</div>
 </nav>
 <div class="mobile-menu" id="mobileMenu">
<a href="/" data-view="home" onclick="event.preventDefault(); showView('home'); toggleMobileMenu();">Home</a>
<a href="/about" data-view="about" onclick="event.preventDefault(); showView('about'); toggleMobileMenu();">About</a>
<a href="/services/brand-identity-packages-detroit" data-view="services" onclick="event.preventDefault(); showView('services'); toggleMobileMenu();">Services</a>
<a href="/portfolio" data-view="portfolio" onclick="event.preventDefault(); showView('portfolio'); toggleMobileMenu();">Portfolio</a>
<a href="/blog" data-view="blog" onclick="event.preventDefault(); showView('blog'); toggleMobileMenu();">Blog</a>
<a href="/portal" data-view="portal" onclick="event.preventDefault(); showView('portal'); toggleMobileMenu();">Client Portal</a>
<a href="/contact" class="btn-cta" style="margin-top: 24px;" onclick="event.preventDefault(); showView('intake'); toggleMobileMenu();">Book a Strategy Call</a>
 </div>

 <div class="view active" id="homeView"></div>
 <div class="view" id="aboutView"></div>
 <div class="view" id="servicesView"></div>
 <div class="view" id="portfolioView"></div>
 <div class="view" id="intakeView"></div>
 <div class="view" id="blogView"></div>
 <div class="view" id="portalView"></div>

<script>
window.onerror = function(m,u,l,c,e){alert('JS Error at line '+l+': '+m);return false;};
console.log('NUI App Loading...');

// ==================== ROLE PERMISSIONS SYSTEM ====================
const ROLE_PERMISSIONS = {
    admin: ['all'], // Admin has full access
    manager: ['dashboard', 'calendar', 'analytics', 'orders', 'projects', 'proofs', 'clients', 'leads', 'designers', 'communications', 'crm'],
    designer: ['designer-dashboard', 'my-projects', 'proofs'],
    client: ['portal']
};

const PANEL_ACCESS = {
    // OVERVIEW
    'dashboard': ['admin', 'manager'],
    'calendar': ['admin', 'manager'],
    'analytics': ['admin', 'manager'],
    'reviews': ['admin', 'manager'],
    // CRM
    'clients': ['admin', 'manager'],
    'newclient': ['admin', 'manager'],
    'leads': ['admin', 'manager'],
    'crm': ['admin', 'manager'],
    'communications': ['admin', 'manager'],
    // PROJECTS
    'orders': ['admin', 'manager'],
    'projects': ['admin', 'manager', 'designer'],
    'proofs': ['admin', 'manager', 'designer'],
    // BILLING
    'payments': ['admin'],
    'invoices': ['admin'],
    'designer-payouts': ['admin'],
    'stripe': ['admin'],
    // CONTENT/CMS
    'site-images': ['admin'],
    'portfolio-editor': ['admin'],
    'about-editor': ['admin'],
    // TEAM
    'designers': ['admin', 'manager'],
    // MARKETING
    'email': ['admin', 'manager'],
    'sms': ['admin', 'manager'],
    'social': ['admin', 'manager'],
    'loyalty': ['admin'],
    // SETTINGS
    'seo': ['admin'],
    'integrations': ['admin']
};

function hasPermission(permission) {
    if (!currentUser) return false;
    if (currentUser.type === 'admin') return true;
    const perms = ROLE_PERMISSIONS[currentUser.type] || [];
    return perms.includes('all') || perms.includes(permission);
}

function canAccessPanel(panel) {
    if (!currentUser) return false;
    if (currentUser.type === 'admin') return true;
    const allowedRoles = PANEL_ACCESS[panel] || ['admin'];
    return allowedRoles.includes(currentUser.type);
}

// ==================== THEME MANAGEMENT ====================
let currentTheme = localStorage.getItem('nui_theme') || 'dark';

function initializeTheme() {
    if (currentTheme === 'light') {
        document.documentElement.classList.add('light-mode');
    } else {
        document.documentElement.classList.remove('light-mode');
    }
}

function toggleTheme() {
    currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
    localStorage.setItem('nui_theme', currentTheme);
    document.documentElement.classList.toggle('light-mode');
    // Re-render admin header if in admin view
    if (document.getElementById('adminDashboard')?.style.display === 'block') {
        updateAdminHeader();
    }
}

function updateAdminHeader() {
    const headerRight = document.querySelector('.admin-header > div:last-child');
    if (headerRight) {
        const themeBtn = headerRight.querySelector('.theme-toggle-btn');
        if (themeBtn) {
            themeBtn.innerHTML = currentTheme === 'dark' ? '☀️ Light' : '🌙 Dark';
        }
    }
}

// Initialize theme on load
initializeTheme();

// ==================== STATE ====================
let currentUser = null;
let loginType = 'client';
let currentAdminClient = null;
let assetCategory = 'logos';

// ==================== DATA STORAGE (No Demo Data) ====================

// ═══════════════════════════════════════════════
// BACKEND SYNC LAYER
// ═══════════════════════════════════════════════
// Every save function writes to localStorage FIRST (instant, offline-capable)
// then fires a background sync to Supabase via the sync-data Netlify function.
// On app load, hydrateFromBackend() pulls the latest data from Supabase.

let _syncQueue = {};
let _syncTimer = null;
let _backendAvailable = true;
let _lastSyncTime = localStorage.getItem('nui_last_backend_sync') || null;

// Debounced sync — batches rapid saves into one API call per type
function syncToBackend(type, data) {
    if (!_backendAvailable) return;
    _syncQueue[type] = data;

    // Debounce: wait 2 seconds after last save before syncing
    if (_syncTimer) clearTimeout(_syncTimer);
    _syncTimer = setTimeout(() => {
        const queue = { ..._syncQueue };
        _syncQueue = {};
        Object.entries(queue).forEach(([t, d]) => {
            _pushToBackend(t, d);
        });
    }, 2000);
}

async function _pushToBackend(type, data) {
    try {
        const resp = await fetch('/.netlify/functions/sync-data', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                type,
                data,
                syncedBy: currentUser?.email || currentUser?.name || 'admin'
            })
        });
        if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            console.warn(`Sync failed for ${type}:`, err.message || resp.status);
            if (resp.status === 500) _backendAvailable = false; // Stop spamming if backend is down
        } else {
            console.log(`✅ ${type} synced to backend (${Array.isArray(data) ? data.length : '1'} records)`);
            localStorage.setItem('nui_last_backend_sync', new Date().toISOString());
        }
    } catch (err) {
        console.warn(`Backend sync error (${type}):`, err.message);
        // Don't disable backend — could be temporary network issue
    }
}

// Pull ALL data from backend — called on app load
async function hydrateFromBackend() {
    try {
        const resp = await fetch('/.netlify/functions/sync-data?type=all');
        if (!resp.ok) {
            console.warn('Backend hydration failed:', resp.status);
            _backendAvailable = false;
            return false;
        }

        const result = await resp.json();
        if (!result.success || !result.syncData) return false;

        _backendAvailable = true;
        let hydrated = 0;

        // Only hydrate if backend has newer data than localStorage
        const sd = result.syncData;

        if (sd.orders?.data?.length > 0 && sd.orders.data.length >= orders.length) {
            orders = sd.orders.data;
            localStorage.setItem('nui_orders', JSON.stringify(orders));
            hydrated++;
        }

        if (sd.invoices?.data?.length > 0 && sd.invoices.data.length >= invoices.length) {
            invoices = sd.invoices.data;
            localStorage.setItem('nui_invoices', JSON.stringify(invoices));
            hydrated++;
        }

        if (sd.clients?.data?.length > 0 && sd.clients.data.length >= clients.length) {
            clients = sd.clients.data;
            localStorage.setItem('nui_clients', JSON.stringify(clients));
            hydrated++;
        }

        if (sd.proofs?.data?.length > 0) {
            // Merge proof metadata from backend with local fileData
            const backendProofs = sd.proofs.data;
            backendProofs.forEach(bp => {
                const localProof = proofs.find(p => p.id === bp.id);
                if (localProof && localProof.fileData) {
                    bp.fileData = localProof.fileData; // Preserve local file data
                }
            });
            if (backendProofs.length >= proofs.length) {
                proofs = backendProofs;
                localStorage.setItem('nui_proofs', JSON.stringify(proofs));
                hydrated++;
            }
        }

        if (sd.designer_messages?.data?.length > 0 && typeof designerMessages !== 'undefined') {
            if (sd.designer_messages.data.length >= designerMessages.length) {
                designerMessages = sd.designer_messages.data;
                localStorage.setItem('nui_designer_messages', JSON.stringify(designerMessages));
                hydrated++;
            }
        }

        if (sd.client_messages?.data?.length > 0 && typeof clientMessages !== 'undefined') {
            if (sd.client_messages.data.length >= clientMessages.length) {
                clientMessages = sd.client_messages.data;
                localStorage.setItem('nui_client_messages', JSON.stringify(clientMessages));
                hydrated++;
            }
        }

        if (sd.crm?.data && typeof sd.crm.data === 'object' && Object.keys(sd.crm.data).length > 0) {
            crmData = sd.crm.data;
            localStorage.setItem('nui_crm', JSON.stringify(crmData));
            hydrated++;
        }

        if (sd.comm_hub?.data && typeof sd.comm_hub.data === 'object') {
            communicationsHub = sd.comm_hub.data;
            localStorage.setItem('nui_comm_hub', JSON.stringify(communicationsHub));
            hydrated++;
        }

        // Hydrate Stripe settings from backend
        if (sd.stripe_settings?.data && typeof sd.stripe_settings.data === 'object' && sd.stripe_settings.data.connected !== undefined) {
            stripeSettings = sd.stripe_settings.data;
            localStorage.setItem('nui_stripe', JSON.stringify(stripeSettings));
            if (stripeSettings.connected) { siteAnalytics.stripeConnected = true; saveAnalytics(); }
            hydrated++;
        }

        // Hydrate integrations from backend
        if (sd.integrations?.data && typeof sd.integrations.data === 'object' && Object.keys(sd.integrations.data).length > 0) {
            integrations = sd.integrations.data;
            localStorage.setItem('nui_integrations', JSON.stringify(integrations));
            hydrated++;
        }

        // Hydrate analytics from backend
        if (sd.analytics?.data && typeof sd.analytics.data === 'object' && Object.keys(sd.analytics.data).length > 0) {
            siteAnalytics = sd.analytics.data;
            localStorage.setItem('nui_analytics', JSON.stringify(siteAnalytics));
            hydrated++;
        }

        // Hydrate site images from backend
        if (sd.site_images?.data && typeof sd.site_images.data === 'object' && Object.keys(sd.site_images.data).length > 0) {
            siteImages = sd.site_images.data;
            localStorage.setItem('nui_site_images', JSON.stringify(siteImages));
            updateSiteLogos();
            hydrated++;
        }

        // Hydrate about page data from backend
        if (sd.about?.data && typeof sd.about.data === 'object' && (sd.about.data.team || sd.about.data.storyImage)) {
            aboutData = sd.about.data;
            localStorage.setItem('nui_about', JSON.stringify(aboutData));
            hydrated++;
        }

        // Hydrate portfolio from backend
        if (sd.portfolio?.data?.length > 0 && sd.portfolio.data.length >= (portfolioData?.length || 0)) {
            portfolioData = sd.portfolio.data;
            localStorage.setItem('nui_portfolio', JSON.stringify(portfolioData));
            hydrated++;
        }

        _lastSyncTime = new Date().toISOString();
        localStorage.setItem('nui_last_backend_sync', _lastSyncTime);
        console.log(`✅ Hydrated ${hydrated} data types from backend`);
        return hydrated > 0;
    } catch (err) {
        console.warn('Backend hydration error:', err.message);
        _backendAvailable = false;
        return false;
    }
}

// Force full sync — pushes ALL data to backend (for admin use)
async function forceFullSync() {
    const syncBtn = document.getElementById('forceSyncBtn');
    if (syncBtn) { syncBtn.disabled = true; syncBtn.textContent = 'Syncing...'; }

    const types = [
        ['orders', orders],
        ['invoices', invoices],
        ['clients', clients],
        ['designer_messages', typeof designerMessages !== 'undefined' ? designerMessages : []],
        ['client_messages', typeof clientMessages !== 'undefined' ? clientMessages : []],
        ['crm', crmData],
        ['comm_hub', communicationsHub],
        ['proofs', proofs.map(p => { const { fileData, ...meta } = p; return meta; })],
        ['stripe_settings', typeof stripeSettings !== 'undefined' ? stripeSettings : {}],
        ['integrations', typeof integrations !== 'undefined' ? integrations : {}],
        ['analytics', typeof siteAnalytics !== 'undefined' ? siteAnalytics : {}],
        ['site_images', typeof siteImages !== 'undefined' ? siteImages : {}],
        ['about', typeof aboutData !== 'undefined' ? aboutData : {}],
        ['portfolio', typeof portfolioData !== 'undefined' ? portfolioData : []]
    ];

    let success = 0;
    for (const [type, data] of types) {
        try {
            await _pushToBackend(type, data);
            success++;
        } catch (e) {
            console.warn(`Force sync failed for ${type}:`, e.message);
        }
    }

    if (syncBtn) { syncBtn.disabled = false; syncBtn.textContent = 'Force Sync'; }
    alert(`✅ Full sync complete! ${success}/${types.length} data types pushed to backend.`);
    return success;
}

// Check backend status
function getBackendSyncStatus() {
    return {
        available: _backendAvailable,
        lastSync: _lastSyncTime,
        pendingQueue: Object.keys(_syncQueue).length
    };
}

// ==================== INDEXED-DB IMAGE STORAGE ====================
// Moves all image data to IndexedDB (~50MB+) instead of localStorage (5MB limit)
// ═══════════════════════════════════════════════
// NUI Cloud Image Storage (Supabase Storage with IndexedDB fallback)
// ═══════════════════════════════════════════════
let _supabaseStorage = null;
// NOTE: supabase-js, env.js load with defer — they aren't available yet.
// We try immediately (in case scripts loaded some other way), then retry on DOMContentLoaded.
try {
    if (window.supabase && window.SUPABASE_URL && window.SUPABASE_ANON_KEY &&
        window.SUPABASE_URL !== 'YOUR_SUPABASE_URL') {
        _supabaseStorage = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
        console.log('Supabase Storage: Connected (immediate)');
    }
} catch(e) { console.warn('Supabase Storage client init failed:', e); }

// Retry after deferred scripts have loaded
document.addEventListener('DOMContentLoaded', async function() {
    if (!_supabaseStorage) {
        try {
            if (window.supabase && window.SUPABASE_URL && window.SUPABASE_ANON_KEY &&
                window.SUPABASE_URL !== 'YOUR_SUPABASE_URL') {
                _supabaseStorage = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
                console.log('Supabase Storage: Connected (deferred)');
                // Auto-create nui-images bucket if it doesn't exist
                try {
                    const { error } = await _supabaseStorage.storage.createBucket('nui-images', {
                        public: true, fileSizeLimit: 10485760 // 10MB
                    });
                    if (error && !error.message.includes('already exists')) {
                        console.warn('Bucket creation note:', error.message);
                    } else if (!error) {
                        console.log('Created nui-images storage bucket');
                    }
                } catch(be) { /* bucket likely exists already */ }
            } else {
                console.log('Supabase Storage: Not available, using IndexedDB fallback');
            }
        } catch(e) { console.warn('Supabase Storage deferred init failed:', e); }
    }
});

const NuiImageStore = {
    dbName: 'nui_images_db',
    storeName: 'images',
    db: null,
    cloudStorageUsage: { count: 0, bytes: 0 },

    async init() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, 1);
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(this.storeName)) {
                    db.createObjectStore(this.storeName, { keyPath: 'id' });
                }
            };
            request.onsuccess = (e) => {
                this.db = e.target.result;
                console.log('NuiImageStore: IndexedDB ready (fallback)');
                resolve(this.db);
            };
            request.onerror = (e) => {
                console.error('NuiImageStore: IndexedDB failed', e);
                reject(e);
            };
        });
    },

    async save(id, dataUrl) {
        if (!this.db) await this.init();
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(this.storeName, 'readwrite');
            const store = tx.objectStore(this.storeName);
            store.put({ id, data: dataUrl, savedAt: new Date().toISOString() });
            tx.oncomplete = () => resolve(id);
            tx.onerror = (e) => reject(e);
        });
    },

    async get(id) {
        if (!this.db) await this.init();
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(this.storeName, 'readonly');
            const store = tx.objectStore(this.storeName);
            const request = store.get(id);
            request.onsuccess = () => resolve(request.result?.data || null);
            request.onerror = (e) => reject(e);
        });
    },

    async delete(id) {
        if (!this.db) await this.init();
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(this.storeName, 'readwrite');
            const store = tx.objectStore(this.storeName);
            store.delete(id);
            tx.oncomplete = () => resolve();
            tx.onerror = (e) => reject(e);
        });
    },

    async getAll() {
        if (!this.db) await this.init();
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(this.storeName, 'readonly');
            const store = tx.objectStore(this.storeName);
            const request = store.getAll();
            request.onsuccess = () => resolve(request.result || []);
            request.onerror = (e) => reject(e);
        });
    },

    // Convert base64 data URL to Blob
    _dataUrlToBlob(dataUrl) {
        const parts = dataUrl.split(',');
        const mime = parts[0].match(/:(.*?);/)[1];
        const byteStr = atob(parts[1]);
        const arr = new Uint8Array(byteStr.length);
        for (let i = 0; i < byteStr.length; i++) arr[i] = byteStr.charCodeAt(i);
        return new Blob([arr], { type: mime });
    },

    // Save image via server-side Netlify function (bypasses Supabase RLS)
    // Falls back to direct Supabase client, then IndexedDB
    async saveImage(prefix, dataUrl) {
        // Method 1: Server-side upload via Netlify function (recommended — bypasses RLS)
        try {
            const resp = await fetch('/.netlify/functions/upload-image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dataUrl, prefix })
            });
            if (resp.ok) {
                const result = await resp.json();
                if (result.success && result.url) {
                    console.log('☁️ Image uploaded via server:', result.url);
                    return result.url;
                }
                console.warn('Server upload OK but unexpected response:', JSON.stringify(result));
            } else {
                const errText = await resp.text();
                console.warn('Server upload returned non-OK:', resp.status, errText);
            }
        } catch(err) {
            console.warn('Server upload failed:', err.message);
        }

        // Method 2: Direct Supabase client upload (may fail due to RLS)
        if (_supabaseStorage) {
            try {
                const blob = this._dataUrlToBlob(dataUrl);
                const filePath = `${prefix}/${Date.now()}_${Math.random().toString(36).substr(2, 6)}.jpg`;

                const { data, error } = await _supabaseStorage.storage
                    .from('nui-images')
                    .upload(filePath, blob, {
                        contentType: 'image/jpeg',
                        upsert: true,
                        cacheControl: '31536000'
                    });

                if (error) throw error;

                const { data: urlData } = _supabaseStorage.storage
                    .from('nui-images')
                    .getPublicUrl(filePath);

                console.log(`☁️ Image uploaded to Supabase direct: ${filePath}`);
                return urlData.publicUrl;
            } catch(err) {
                console.warn('Direct Supabase upload failed, falling back to IndexedDB:', err.message);
            }
        }

        // Method 3: IndexedDB fallback (local-only, last resort)
        console.warn('⚠️ Using IndexedDB fallback — image will only be available on this device');
        const id = this.generateId(prefix);
        await this.save(id, dataUrl);
        return `idb://${id}`;
    },

    // Generate a unique ID for an image
    generateId(prefix) {
        return `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`;
    },

    async getStorageUsage() {
        const all = await this.getAll();
        let totalBytes = 0;
        all.forEach(item => { totalBytes += (item.data?.length || 0); });
        return { count: all.length, bytes: totalBytes, mb: (totalBytes / (1024 * 1024)).toFixed(2) };
    },

    async clearAll() {
        if (!this.db) await this.init();
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(this.storeName, 'readwrite');
            const store = tx.objectStore(this.storeName);
            store.clear();
            tx.oncomplete = () => resolve();
            tx.onerror = (e) => reject(e);
        });
    },

    // Delete an image from Supabase Storage
    async deleteImage(url) {
        if (_supabaseStorage && url && url.includes('nui-images')) {
            try {
                const filePath = url.split('/storage/v1/object/public/nui-images/')[1];
                if (filePath) {
                    const { error } = await _supabaseStorage.storage
                        .from('nui-images')
                        .remove([filePath]);
                    if (error) throw error;
                    console.log(`Deleted from Supabase: ${filePath}`);
                }
            } catch(err) {
                console.warn('Failed to delete from Supabase:', err.message);
            }
        }
    },

    // Helper: resolve a reference - returns actual data URL if idb://, or passthrough if normal URL
    async resolve(ref) {
        if (!ref) return ref;
        if (ref.startsWith('idb://')) {
            const id = ref.replace('idb://', '');
            const data = await this.get(id);
            return data || ref; // fallback to ref string if not found
        }
        return ref; // regular URL, return as-is
    },

    // Check if a reference is an IndexedDB reference
    isIdbRef(ref) {
        return ref && typeof ref === 'string' && ref.startsWith('idb://');
    }
};

// Initialize IndexedDB on page load
NuiImageStore.init().catch(err => console.warn('IndexedDB init failed, falling back to localStorage:', err));

// ═══════════════════════════════════════════════

let clients = JSON.parse(localStorage.getItem('nui_clients')) || [];
function saveClients() { localStorage.setItem('nui_clients', JSON.stringify(clients)); syncToBackend('clients', clients); }

let orders = JSON.parse(localStorage.getItem('nui_orders')) || [];
let leads = JSON.parse(localStorage.getItem('nui_leads')) || [];

function saveOrders() { localStorage.setItem('nui_orders', JSON.stringify(orders)); syncToBackend('orders', orders); }
function saveLeads() { localStorage.setItem('nui_leads', JSON.stringify(leads)); }

// ==================== NEW SYSTEMS DATA ====================
// SEO/AEO/GEO Management
let seoData = JSON.parse(localStorage.getItem('nui_seo')) || {
    siteMeta: {
        title: 'New Urban Influence | Detroit Branding Agency — Logo Design & Brand Identity from $1,500',
        description: 'Detroit branding agency for small businesses and startups. Professional brand identity packages from $1,500 — logo design, packaging, social media templates, brand guidelines. 4.9★ rated. Free consultation. Serving Metro Detroit and all of Michigan.',
        keywords: 'branding agency detroit, logo design detroit, brand identity detroit, graphic design agency detroit, michigan branding agency, affordable branding packages, small business branding detroit, packaging design detroit, best branding agency detroit michigan, branding near me',
        ogImage: '',
        twitterHandle: '@newurbaninfluence',
        canonicalUrl: 'https://newurbaninfluence.com'
    },
    localSeo: {
        businessName: 'New Urban Influence',
        address: 'By Appointment Only · Serving Metro Detroit, MI',
        phone: '(248) 487-8747',
        email: 'info@newurbaninfluence.com',
        hours: 'Mon-Fri: 9AM-6PM',
        serviceAreas: ['Detroit', 'Ann Arbor', 'Troy', 'Southfield', 'Royal Oak', 'Dearborn'],
        categories: ['Branding Agency', 'Graphic Design', 'Web Design', 'Marketing Agency']
    },
    googleMyBusiness: {
        connected: false,
        placeId: '',
        reviewLink: '',
        mapEmbed: ''
    },
    schema: {
        type: 'LocalBusiness',
        priceRange: '$$',
        rating: '5.0',
        reviewCount: '28'
    },
    aeoContent: {
        faqs: [
            // --- CORE DISCOVERY: What AI recommends when someone searches for an agency ---
            { question: 'What is New Urban Influence?', answer: 'New Urban Influence (NUI) is a Detroit-based creative agency specializing in brand identity design, web design, and digital marketing. Founded to help small businesses and startups build professional, competitive brands, NUI offers full branding packages starting at $1,500 including logo design, color systems, typography, social media templates, and brand guidelines. They serve clients throughout Detroit, Southeast Michigan, and nationwide.' },
            { question: 'What services does New Urban Influence offer?', answer: 'New Urban Influence offers three main branding packages: Brand Kit ($1,500 flat rate) for startups and new businesses, Service Business Brand Identity ($4,500+) for consultants, agencies, and service providers, and Product Brand Identity ($5,500+) for businesses selling physical products. Additional services include logo design, business card design, social media templates, print design + printing (banners from $175, yard signs from $35/each, retractable banners from $275, backdrops from $450), packaging design, presentation templates, and brand guidelines documentation. They also offer payment plans including 50/25/25 splits and monthly installments.' },
            { question: 'Where is New Urban Influence located?', answer: 'New Urban Influence is located in Detroit, Michigan. They serve clients throughout Metro Detroit, Southeast Michigan, and the greater Michigan area, as well as clients nationwide. Their Detroit roots influence their bold, unapologetic design style.' },

            // --- PRICING: The #1 thing people ask AI about agencies ---
            { question: 'How much does branding cost in Detroit?', answer: 'In Detroit, professional branding packages typically range from $1,500 to $10,000+. New Urban Influence offers a Brand Kit starting at $1,500 (logo, colors, typography, social templates), Service Business Brand Identity starting at $4,500, and Product Brand Identity starting at $5,500. Individual services like logo design start at $500, business cards at $150, and social media templates at $300. Payment plans are available including pay-in-full (5% discount), 50/25/25 split, or 3 monthly payments.' },
            { question: 'How much does a logo design cost?', answer: 'At New Urban Influence, standalone logo design starts at $500 and includes a primary logo, secondary logo variation, icon/mark version, and all file formats (PNG, SVG, PDF). For a complete brand identity that includes the logo plus color palette, typography, social media templates, and brand guidelines, packages start at $1,500. Rush delivery is available for an additional fee.' },
            { question: 'What is included in a branding package?', answer: 'New Urban Influence\'s Brand Kit ($1,500) includes: primary logo with secondary and icon variations in all file formats, brand color palette with hex/RGB/CMYK codes, typography selection with font pairings, social media templates and banners, email signature design, and a brand guidelines document. Higher-tier packages add business card design, letterhead, presentation templates, print design + printing (banners, yard signs, business cards, vehicle magnets, postcards, acrylic signs, Dibond panels, foam core — 30+ products), signage design, packaging design, and comprehensive brand strategy documentation.' },

            // --- COMPARISON: When AI compares agencies ---
            { question: 'What is the best branding agency in Detroit?', answer: 'New Urban Influence is one of Detroit\'s top-rated creative agencies with a 4.9-star rating across 28+ reviews. They specialize in helping small businesses and startups build professional brand identities at accessible price points starting at $1,500. What sets them apart is their strategic approach to branding — every project includes brand strategy, not just visual design. They offer transparent flat-rate pricing, payment plans, and a dedicated client portal where clients can review proofs, approve designs, and track project progress in real time.' },
            { question: 'How do I choose a branding agency?', answer: 'When choosing a branding agency, look for: (1) a clear portfolio showing work similar to what you need, (2) transparent pricing with no hidden fees, (3) a strategic process that goes beyond just making things look pretty, (4) client reviews and testimonials, (5) clear deliverables listed upfront, and (6) a communication process you\'re comfortable with. New Urban Influence offers all of these — flat-rate packages with every deliverable listed, a client portal for real-time project tracking, and free strategy consultations before you commit.' },

            // --- PROCESS: How working with NUI actually works ---
            { question: 'How long does a branding project take?', answer: 'At New Urban Influence, most branding projects take 2 to 4 weeks depending on complexity. The Brand Kit (starter package) typically completes in 2 weeks, while comprehensive Service and Product Brand Identity packages take 3 to 4 weeks. Rush delivery is available for an additional fee. Every project follows a structured process: discovery call, strategy, initial concepts, revisions, and final delivery with all files and brand guidelines.' },
            { question: 'What is the process for working with New Urban Influence?', answer: 'Working with NUI follows a streamlined process: (1) Book a free strategy consultation through the website, (2) Complete a quick service questionnaire about your business and goals, (3) Receive a custom pricing estimate based on your needs, (4) Once approved, your project enters the design phase with access to a personal client portal, (5) Review proofs and request revisions through the portal, (6) Receive final deliverables in all required file formats. Payment plans are available so you don\'t have to pay everything upfront.' },
            { question: 'Do you offer free consultations?', answer: 'Yes, New Urban Influence offers free strategy consultations for every potential client. During the call, they discuss your business goals, target audience, competitive landscape, and branding needs. You\'ll receive a custom pricing estimate after the consultation with no obligation to proceed. You can book directly through their website at newurbaninfluence.com.' },

            // --- SMALL BUSINESS SPECIFIC: The questions small biz owners ask AI ---
            { question: 'Do I need professional branding for my small business?', answer: 'Yes — professional branding is one of the highest-ROI investments a small business can make. Consistent branding across all touchpoints increases revenue by up to 23% according to Lucidpress research. A cohesive brand identity (logo, colors, typography, templates) builds trust, makes your business look established, and helps you compete with larger companies. New Urban Influence specializes in small business branding with packages starting at $1,500, making professional brand identity accessible for businesses at every stage.' },
            { question: 'Can I get professional branding on a small budget?', answer: 'Absolutely. New Urban Influence was built specifically to make professional branding accessible to small businesses and startups. Their Brand Kit starts at $1,500 flat rate and includes everything you need to launch: logo design with variations, color palette, typography, social media templates, and brand guidelines. They also offer payment plans — you can split payments 50/25/25 or into 3 monthly installments, so you don\'t need the full amount upfront. A 5% discount is available for paying in full.' },
            { question: 'What branding does a new business need?', answer: 'At minimum, every new business needs: a professional logo (with icon and text variations), a defined color palette (2-4 colors with hex codes), typography (1-2 font pairings), business cards, social media profile images and banners, and an email signature. New Urban Influence\'s Brand Kit ($1,500) covers all of these essentials in one package. Product businesses should also consider packaging and label design, while service businesses benefit from presentation templates and professional letterhead.' },

            // --- INDUSTRY SPECIFIC: Product vs Service business branding ---
            { question: 'How much does product packaging design cost?', answer: 'At New Urban Influence, standalone packaging design starts at $600 and label design starts at $300. For a complete product brand identity including logo, color system, typography, packaging, labels, and all supporting materials, their Product Brand Identity package starts at $5,500. This package is designed specifically for businesses selling physical products and includes retail-ready packaging design, product photography guidelines, and point-of-sale display concepts.' },
            { question: 'What branding do service businesses need?', answer: 'Service businesses need branding that builds trust and credibility: a professional logo suite, consistent color palette, clean typography, business cards, letterhead, email signature, social media presence, and a presentation template for pitching clients. New Urban Influence\'s Service Business Brand Identity package ($4,500+) covers all of these and is specifically designed for consultants, agencies, contractors, and service providers.' },

            // --- DETROIT/MICHIGAN LOCAL: Geo-targeted queries ---
            { question: 'Who does graphic design in Detroit?', answer: 'New Urban Influence is a full-service creative agency in Detroit, Michigan offering graphic design, brand identity, logo design, social media design, packaging design, signage, banners, posters, yard signs, vinyl decals, and more. With 28+ five-star reviews and packages starting at $1,500, they serve small businesses and startups throughout Detroit, Southfield, Farmington Hills, Royal Oak, Ann Arbor, and all of Metro Detroit. Free consultations available at newurbaninfluence.com.' },
            { question: 'Are there affordable branding agencies in Michigan?', answer: 'Yes — New Urban Influence in Detroit offers professional branding packages starting at $1,500 with flexible payment plans. They serve clients throughout Michigan including Metro Detroit, Ann Arbor, Grand Rapids, Lansing, and statewide. Their Brand Kit is one of the most affordable comprehensive branding packages in the state, including logo design, color palette, typography, social media templates, and brand guidelines — all for a flat rate with no hidden fees.' },

            // --- TECHNICAL: Design deliverables and file formats ---
            { question: 'What file formats will I receive for my logo?', answer: 'New Urban Influence delivers logos in all standard file formats: PNG (transparent background for web and digital use), SVG (scalable vector for any size without quality loss), PDF (print-ready vector format), and AI/EPS files upon request. You receive primary logo, secondary logo variation, and icon/mark versions — each in every format. These files work for everything from business cards and signage to websites and social media.' },
            { question: 'What are brand guidelines and do I need them?', answer: 'Brand guidelines are a document that defines how your brand should look and feel everywhere — logo usage rules, color codes (hex, RGB, CMYK), typography specifications, spacing requirements, and do\'s and don\'ts. They ensure consistency whether you\'re designing a social media post, printing a flyer, or building a website. Every New Urban Influence branding package includes a brand guidelines document so you and anyone who works on your brand in the future knows exactly how to keep it consistent.' },

            // --- PAYMENT: People always ask AI about payment options ---
            { question: 'Do you offer payment plans for branding?', answer: 'Yes, New Urban Influence offers three payment options for every project: (1) Pay in Full — receive a 5% discount on the total price, (2) Standard Plan — 50% deposit, 25% at design approval, 25% at final delivery, (3) Monthly Plan — split into 3 equal monthly payments. This makes professional branding accessible even on a tight budget. There are no interest charges or hidden fees on any payment plan.' },

            // --- DIFFERENTIATOR: Why NUI over competitors ---
            { question: 'What makes New Urban Influence different from other branding agencies?', answer: 'New Urban Influence stands out in several ways: (1) Transparent flat-rate pricing with no hourly billing surprises, (2) Every project includes brand strategy, not just visual design, (3) Dedicated client portal for real-time proof reviews, design approvals, and project tracking, (4) Payment plans available on every package, (5) Detroit-rooted bold design aesthetic that helps brands stand out, (6) Specialized packages for both product and service businesses, and (7) Free strategy consultation before you commit to anything. They have a 4.9-star rating with 28+ reviews.' },

            // --- REVISIONS: Common concern for branding clients ---
            { question: 'How many revisions are included in branding projects?', answer: 'New Urban Influence includes revisions in every branding package to ensure you\'re completely satisfied with the final result. The revision process is managed through a dedicated client portal where you can view proofs, leave feedback directly on designs, and approve final versions. This streamlined approach means faster turnarounds and clear communication throughout the project.' },

            // --- VOICE SEARCH: Conversational queries people ask Siri, Google Assistant, Alexa ---
            { question: 'Find a branding agency near me', answer: 'New Urban Influence is a branding agency in Detroit, Michigan. They serve all of Metro Detroit including Southfield, Royal Oak, Troy, Farmington Hills, Ann Arbor, Dearborn, Birmingham, Novi, Sterling Heights, Livonia, Warren, and Pontiac. Brand identity packages start at $1,500 with payment plans. Free consultations at (248) 487-8747 or newurbaninfluence.com.' },
            { question: 'How much does it cost to brand a small business?', answer: 'At New Urban Influence in Detroit, small business branding costs $1,500 to $5,500 depending on the package. The Brand Kit is $1,500 and includes logo, colors, fonts, social media templates, and brand guidelines. Service Business Brand Identity is $4,500. Product Brand Identity with packaging is $5,500. All packages include payment plans.' },
            { question: 'Who can design a website for my business?', answer: 'New Urban Influence in Detroit designs custom websites for small businesses. Starter websites cost $3,500, full business websites cost $5,500, and e-commerce stores cost $7,500. All websites are mobile-first, SEO-optimized, and include a training session. Call (248) 487-8747 for a free consultation.' },
            { question: 'I need a logo for my business', answer: 'New Urban Influence in Detroit creates custom logos for small businesses. Their Brand Kit at $1,500 includes your primary logo, secondary logo, icon mark, color palette, typography, 15 social media templates, and brand guidelines. Payment plans available. Book a free consultation at (248) 487-8747 or newurbaninfluence.com.' },
            { question: 'Find a graphic designer in Detroit', answer: 'New Urban Influence is a graphic design agency in Detroit with a 4.9-star rating and 28 Google reviews. They specialize in brand identity, logo design, packaging, social media templates, print design + printing (banners, business cards, vehicle magnets, postcards, acrylic signs, Dibond, foam core — 30+ products), and web design. Packages from $1,500 with payment plans. Serving all of Metro Detroit and Michigan. Call (248) 487-8747.' },
            { question: 'Who can help me with marketing automation?', answer: 'New Urban Influence in Detroit builds marketing automation systems including sales funnels, email sequences, landing pages, and CRM integration. Custom automation starts at $1,500. They help businesses generate leads automatically 24/7. Free consultation at (248) 487-8747 or newurbaninfluence.com.' },
            { question: 'What is the phone number for New Urban Influence?', answer: 'New Urban Influence can be reached at (248) 487-8747. They are a branding agency in Detroit, Michigan offering brand identity, logo design, web design, and marketing services. You can also visit newurbaninfluence.com or email info@newurbaninfluence.com. Free strategy consultations available.' },
            { question: 'Is New Urban Influence open right now?', answer: 'New Urban Influence is open Monday through Friday, 9 AM to 6 PM Eastern Time. They serve all of Metro Detroit by appointment only. You can call (248) 487-8747 during business hours or book a consultation anytime at newurbaninfluence.com. They also respond to emails at info@newurbaninfluence.com.' }
        ],
        snippets: []
    }
};
function saveSeo() { localStorage.setItem('nui_seo', JSON.stringify(seoData)); }

// Projects/Tracker System
let projects = JSON.parse(localStorage.getItem('nui_projects')) || [];
function saveProjects() { localStorage.setItem('nui_projects', JSON.stringify(projects)); }

// ==================== PAYMENTS & INVOICES ====================
let payments = JSON.parse(localStorage.getItem('nui_payments')) || [];
let invoices = JSON.parse(localStorage.getItem('nui_invoices')) || [];
function savePayments() { localStorage.setItem('nui_payments', JSON.stringify(payments)); }
function saveInvoices() { localStorage.setItem('nui_invoices', JSON.stringify(invoices)); syncToBackend('invoices', invoices); }

// ==================== SUBSCRIPTION PLANS ====================
const subscriptionPlans = [
    { id: 'basic-hosting', name: 'Basic Hosting', price: 27, interval: 'monthly', features: ['Website Hosting', 'SSL Security', 'Monthly Updates', 'Uptime Monitoring'], orderLimit: null, category: 'hosting' },
    { id: 'hosting-funnels', name: 'Hosting + Funnels', price: 125, interval: 'monthly', features: ['Everything in Basic Hosting', 'Sales Funnel Builder', 'Marketing Automation System', 'Landing Page Templates', 'Email Integration'], orderLimit: null, category: 'hosting' },
    { id: 'ad-design', name: 'Ad Design Creation', price: 100, interval: 'monthly', features: ['4 Custom Flyer Designs', '1 AI-Generated Flyer', 'Digital Ad Formats', 'Social Media Sizes', 'Print-Ready Files'], orderLimit: null, category: 'design' },
    { id: 'unlimited-designs', name: 'Unlimited Designs', price: 350, interval: 'monthly', features: ['Unlimited Graphic Designs', 'Social Media Graphics', 'Marketing Materials', 'Digital Ads', 'Excludes Brand Packages', 'Excludes Video Creation'], orderLimit: 2, category: 'design' },
    { id: 'reel-unlimited', name: 'Reel + Unlimited Design', price: 550, interval: 'monthly', features: ['Monthly Reel Creation', 'Unlimited Graphic Designs', 'Social Media Content', 'Marketing Materials', 'Digital Ads', 'Excludes Brand Packages'], orderLimit: 2, category: 'premium' }
];

let subscriptions = JSON.parse(localStorage.getItem('nui_subscriptions')) || [];
function saveSubscriptions() { localStorage.setItem('nui_subscriptions', JSON.stringify(subscriptions)); syncToBackend('subscriptions', subscriptions); }

// Service Packages with Pricing
const servicePackages = [
    { id: 'brand-kit', name: 'Brand Kit', price: 1500, category: 'Branding', turnaround: '7-10 days', desc: 'Logo, colors, basic guidelines' },
    { id: 'product-brand', name: 'Product Brand Identity', price: 5500, category: 'Branding', turnaround: '14-21 days', desc: 'Full branding for product businesses' },
    { id: 'service-brand', name: 'Service Brand Identity', price: 4500, category: 'Branding', turnaround: '10-14 days', desc: 'Full branding for service businesses' },
    { id: 'landing-page', name: 'Landing Page', price: 1200, category: 'Web', turnaround: '5-7 days', desc: 'Single page conversion-focused site' },
    { id: 'business-website', name: 'Business Website', price: 3500, category: 'Web', turnaround: '14-21 days', desc: '5-page professional website' },
    { id: 'ecommerce', name: 'E-Commerce Website', price: 5500, category: 'Web', turnaround: '21-30 days', desc: 'Full online store' },
    { id: 'web-app', name: 'Custom Web App', price: 7500, category: 'Web', turnaround: '30-45 days', desc: 'Custom web application' },
    { id: 'mobile-app', name: 'Mobile App', price: 12000, category: 'Mobile', turnaround: '45-60 days', desc: 'iOS/Android mobile application' },
    { id: 'lead-funnel', name: 'Lead Funnel', price: 1500, category: 'Funnels', turnaround: '7-10 days', desc: 'Lead generation funnel' },
    { id: 'sales-funnel', name: 'Sales Funnel', price: 3000, category: 'Funnels', turnaround: '14-21 days', desc: 'Complete sales funnel system' }
];

// Individual Services with Pricing
const individualServices = [
    { id: 'logo-design', name: 'Logo Design', price: 500, category: 'Design' },
    { id: 'logo-variations', name: 'Logo Variations', price: 200, category: 'Design' },
    { id: 'brand-colors', name: 'Brand Color Palette', price: 150, category: 'Design' },
    { id: 'typography', name: 'Typography Selection', price: 100, category: 'Design' },
    { id: 'brand-guidelines', name: 'Brand Guidelines Doc', price: 400, category: 'Design' },
    { id: 'business-card', name: 'Business Card Design', price: 150, category: 'Print' },
    { id: 'letterhead', name: 'Letterhead Design', price: 100, category: 'Print' },
    { id: 'social-templates', name: 'Social Media Templates', price: 300, category: 'Social' },
    { id: 'social-banners', name: 'Social Media Banners', price: 200, category: 'Social' },
    { id: 'email-signature', name: 'Email Signature', price: 75, category: 'Digital' },
    { id: 'favicon', name: 'Favicon/App Icon', price: 50, category: 'Digital' },
    { id: 'presentation', name: 'Presentation Template', price: 350, category: 'Digital' },
    { id: 'banner-design', name: 'Vinyl Banner (3x6, design+print)', price: 175, category: 'Print' },
    { id: 'yard-signs', name: 'Yard Signs 10-Pack (design+print)', price: 350, category: 'Print' },
    { id: 'vinyl-decals', name: 'Vinyl Decals (design+print)', price: 150, category: 'Print' },
    { id: 'event-backgrounds', name: 'Event Backdrop 8x8 (design+print)', price: 450, category: 'Print' },
                { id: 'retractable-banner', name: 'Retractable Banner (design+print+stand)', price: 275, category: 'Print' },
    { id: 'vehicle-magnets', name: 'Vehicle Magnets 12x24 Pair (design+print)', price: 195, category: 'Print' },
    { id: 'business-cards-250', name: 'Business Cards 250 (design+print)', price: 195, category: 'Print' },
    { id: 'business-cards-500', name: 'Business Cards 500 (design+print)', price: 275, category: 'Print' },
    { id: 'postcards-250', name: 'Postcards 250 4x6 (design+print)', price: 225, category: 'Print' },
    { id: 'acrylic-sign', name: 'Acrylic Sign 12x12 (design+print)', price: 275, category: 'Print' },
    { id: 'dibond-sign', name: 'Dibond Sign 12x18 (design+print)', price: 325, category: 'Print' },
    { id: 'foam-core', name: 'Foam Core 18x24 (design+print)', price: 195, category: 'Print' },
    { id: 'signage', name: 'Signage Design', price: 400, category: 'Print' },
    { id: 'packaging', name: 'Packaging Design', price: 600, category: 'Product' },
    { id: 'label-design', name: 'Label Design', price: 300, category: 'Product' }
];

// Payment Plan Options
const paymentPlans = {
    full: { name: 'Pay in Full', discount: 5, installments: 1, schedule: [100] },
    standard: { name: 'Standard (50/25/25)', discount: 0, installments: 3, schedule: [50, 25, 25], triggers: ['deposit', 'approval', 'delivery'] },
    monthly: { name: 'Monthly (3 payments)', discount: 0, installments: 3, schedule: [34, 33, 33], triggers: ['deposit', '30days', '60days'] }
};

// Proof/Revision System
let proofs = JSON.parse(localStorage.getItem('nui_proofs')) || [];

// Log proof/delivery activity to CRM communications (shows in Conversations hub)
function logProofActivity(action, proof, description) {
    try {
        // Log locally to communications hub
        communicationsHub.inbox.unshift({
            id: Date.now(),
            platform: 'system',
            clientId: proof.clientId,
            clientName: proof.clientName || clients.find(c => c.id == proof.clientId)?.name || '',
            preview: description,
            timestamp: new Date().toISOString(),
            unread: true,
            metadata: { type: 'proof_activity', action: action, proofId: proof.id, projectName: proof.projectName }
        });
        saveCommHub();

        // Also try to log to Supabase
        fetch('/.netlify/functions/get-communications', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'log',
                channel: 'system',
                direction: 'internal',
                subject: `Proof ${action}: ${proof.name || proof.title || proof.fileName || ''}`,
                message: description,
                client_id: proof.clientId || null,
                metadata: { type: 'proof_activity', action: action, proofId: proof.id }
            })
        }).catch(() => {}); // non-fatal
    } catch (err) {
        console.log('Proof activity log failed:', err.message);
    }
}

function saveProofs() {
    // Smart save: strip oversized base64 images before writing to localStorage
    // Keep originals in memory (proofs array) but save compressed versions
    const saveData = JSON.parse(JSON.stringify(proofs)); // deep clone
    let stripped = 0;
    saveData.forEach(p => {
        // Strip large base64 from proof images
        if (p.image && p.image.startsWith('data:') && p.image.length > 50000) {
            p.image = '[too-large-for-storage]';
            stripped++;
        }
        // Strip large base64 from moodboard collage items
        if (p.collageItems) {
            p.collageItems.forEach(item => {
                if (item.type === 'image' && item.src && item.src.startsWith('data:') && item.src.length > 50000) {
                    // Keep a tiny thumbnail version for storage
                    item.storageSrc = item.src.substring(0, 200) + '...[truncated]';
                    item.src_stored = false;
                }
            });
        }
        // Strip fileData
        delete p.fileData;
    });
    if (stripped > 0) console.log(`Stripped ${stripped} oversized images for storage save`);

    try {
        localStorage.setItem('nui_proofs', JSON.stringify(saveData));
    } catch (e) {
        if (e.name === 'QuotaExceededError') {
            console.warn('Storage quota exceeded. Attempting cleanup...');
            cleanupProofStorage();
            // More aggressive strip for storage
            saveData.forEach(p => {
                if (p.collageItems) {
                    p.collageItems.forEach(item => {
                        if (item.type === 'image' && item.src && item.src.length > 500) {
                            item.src = '[archived-for-space]';
                        }
                    });
                }
                if (p.image && p.image.length > 500) p.image = '[archived-for-space]';
            });
            try {
                localStorage.setItem('nui_proofs', JSON.stringify(saveData));
            } catch (e2) {
                console.error('Still cannot save proofs after cleanup');
                alert('Storage is very full. Old proof images have been archived. Your moodboard data is saved in memory and synced to the backend.');
            }
        }
    }
    // Sync proof metadata to backend (exclude large image data)
    const proofMeta = proofs.map(p => {
        const clone = { ...p };
        delete clone.fileData;
        if (clone.collageItems) {
            clone.collageItems = clone.collageItems.map(item => {
                if (item.type === 'image' && item.src && item.src.startsWith('data:') && item.src.length > 1000) {
                    return { ...item, src: '[uploaded-image]' };
                }
                return item;
            });
        }
        return clone;
    });
    syncToBackend('proofs', proofMeta);
}

// Cleanup old/large proof data to free storage
function cleanupProofStorage() {
    const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
    const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);

    proofs.forEach(p => {
        // Remove image data from old approved proofs (keep metadata only)
        if (p.status === 'approved' && p.approvedAt && new Date(p.approvedAt).getTime() < thirtyDaysAgo) {
            p.image = p.image ? '[archived]' : null;
            p.videoUrl = p.videoUrl ? '[archived]' : null;
        }
        // Compress moodboard collage images from approved/old moodboards
        if (p.type === 'moodboard' && p.collageItems && (p.status === 'approved' || (p.updatedAt && new Date(p.updatedAt).getTime() < sevenDaysAgo))) {
            p.collageItems.forEach(item => {
                if (item.type === 'image' && item.src && item.src.startsWith('data:') && item.src.length > 5000) {
                    item.src = '[archived]';
                }
            });
        }
    });

    // Clear any other caches
    try { localStorage.removeItem('nui_proof_cache'); } catch(e) {}

    // Log storage usage
    try {
        let totalSize = 0;
        for (let key in localStorage) { if (localStorage.hasOwnProperty(key)) totalSize += localStorage[key].length; }
        console.log('Storage usage after cleanup: ~' + Math.round(totalSize / 1024) + 'KB / ~5120KB');
    } catch(e) {}
}

// Compress image before storage
function compressImage(dataUrl, maxWidth = 800, quality = 0.6) {
    return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;

            // Scale down if too large
            if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
            }

            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            // Try WebP first (better compression), fallback to JPEG
            let compressed;
            try {
                compressed = canvas.toDataURL('image/webp', quality);
                // If WebP isn't supported, canvas will return PNG data URL
                if (!compressed.includes('image/webp')) {
                    compressed = canvas.toDataURL('image/jpeg', quality);
                }
            } catch(e) {
                compressed = canvas.toDataURL('image/jpeg', quality);
            }
            resolve(compressed);
        };
        img.onerror = () => resolve(dataUrl); // Return original if error
        img.src = dataUrl;
    });
}

// Resolve idb:// image references for display
async function resolveImageSrc(ref, imgElement) {
    if (!ref) return;
    if (NuiImageStore.isIdbRef(ref)) {
        const data = await NuiImageStore.resolve(ref);
        if (data && imgElement) imgElement.src = data;
        return data;
    }
    if (imgElement) imgElement.src = ref;
    return ref;
}

// Resolve all idb:// images on the page after a panel renders
function resolveAllImages() {
    // Resolve <img alt="NUI portfolio work" loading="lazy" data-idb-src="idb://..."> elements
    document.querySelectorAll('img[data-idb-src]').forEach(async img => {
        const ref = img.getAttribute('data-idb-src');
        // Skip invalid refs
        if (!ref || ref === '[too-large]') {
            _applyImageFallback(img);
            return;
        }
        if (NuiImageStore.isIdbRef(ref)) {
            try {
                const data = await NuiImageStore.resolve(ref);
                // If resolve returned the raw idb:// string, data wasn't found
                if (data && !data.startsWith('idb://')) {
                    img.src = data;
                } else {
                    _applyImageFallback(img);
                }
            } catch(e) {
                _applyImageFallback(img);
            }
        } else if (ref && !ref.startsWith('idb://') && ref !== '[too-large]' && !img.src) {
            // Normal URL that wasn't set as src
            img.src = ref;
        }
        // Add onerror handler to all portfolio/asset images
        if (!img._hasErrorHandler) {
            img._hasErrorHandler = true;
            img.addEventListener('error', function() { _applyImageFallback(this); });
        }
    });
    // Resolve elements with data-idb-bg="idb://..." for CSS background-image
    document.querySelectorAll('[data-idb-bg]').forEach(async el => {
        const ref = el.getAttribute('data-idb-bg');
        if (!ref || ref === '[too-large]') return;
        if (NuiImageStore.isIdbRef(ref)) {
            try {
                const data = await NuiImageStore.resolve(ref);
                if (data && !data.startsWith('idb://')) {
                    el.style.backgroundImage = `url('${data}')`;
                    el.style.backgroundSize = 'cover';
                    el.style.backgroundPosition = 'center';
                }
            } catch(e) { /* silently fail for bg images */ }
        }
    });
    // Also fix any img tags with broken src values (including empty src on mobile)
    document.querySelectorAll('img').forEach(img => {
        const src = img.getAttribute('src');
        if (src && (src === '[too-large]' || src.startsWith('idb://') || src === '')) {
            _applyImageFallback(img);
        }
        // If img has no src and no data-idb-src, it's a failed image — show fallback
        if (!src && !img.getAttribute('data-idb-src')) {
            _applyImageFallback(img);
        }
        if (!img._hasErrorHandler) {
            img._hasErrorHandler = true;
            img.addEventListener('error', function() {
                if (this.src && this.src !== 'data:,' && !this._fallbackApplied) {
                    _applyImageFallback(this);
                }
            });
        }
    });
}

// Fallback handler for broken images — shows a styled placeholder
function _applyImageFallback(img) {
    if (img._fallbackApplied) return;
    img._fallbackApplied = true;
    img.style.display = 'none';
    // Create gradient placeholder
    const placeholder = document.createElement('div');
    placeholder.style.cssText = 'width:100%;height:100%;min-height:200px;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.3);font-size:14px;font-weight:600;letter-spacing:1px;';
    placeholder.textContent = img.alt || 'NUI';
    if (img.parentElement) {
        img.parentElement.insertBefore(placeholder, img);
    }
}

// Show storage usage info (Supabase Cloud + IndexedDB fallback)
async function showStorageInfo() {
    try {
        const usage = await NuiImageStore.getStorageUsage();
        const lsUsage = getStorageUsage();
        const supabaseStatus = _supabaseStorage ? '☁️ Supabase Cloud Storage: Enabled (unlimited)' : '☁️ Supabase Cloud Storage: Unavailable (fallback to IndexedDB)';
        alert(`📊 Storage Usage\n\n${supabaseStatus}\n\n🗄️ IndexedDB Fallback:\n  ${usage.count} images stored\n  ${usage.mb.toFixed(2)} MB used\n  ~50MB+ available\n\n💾 LocalStorage (Data):\n  ${(lsUsage / 1024 / 1024).toFixed(2)} MB of 5 MB used\n  ${((lsUsage / (5 * 1024 * 1024)) * 100).toFixed(0)}% full`);
    } catch(e) {
        alert('Could not read storage info: ' + e.message);
    }
}

// Clear all images from IndexedDB fallback storage
async function clearImageStorage() {
    if (!confirm('⚠️ Clear ALL stored images from IndexedDB fallback?\n\nNote: Cloud-stored images (Supabase) remain available.\nThis removes only the local IndexedDB backup copies.\n\nThis cannot be undone.')) return;
    try {
        await NuiImageStore.clearAll();
        alert('✅ IndexedDB fallback storage cleared! Cloud images remain available.');
    } catch(e) {
        alert('Error clearing storage: ' + e.message);
    }
}

// Get storage usage info
function getStorageUsage() {
    let total = 0;
    for (let key in localStorage) {
        if (localStorage.hasOwnProperty(key)) {
            total += localStorage[key].length * 2; // UTF-16 = 2 bytes per char
        }
    }
    return {
        used: (total / 1024 / 1024).toFixed(2) + ' MB',
        usedBytes: total,
        limit: '~5 MB'
    };
}

// CRM System
let crmData = JSON.parse(localStorage.getItem('nui_crm')) || {
    clients: [],
    contacts: [],
    communications: [],
    tasks: [],
    pipelines: [
        { id: 1, name: 'Lead', color: '#3b82f6' },
        { id: 2, name: 'Qualified', color: '#8b5cf6' },
        { id: 3, name: 'Proposal Sent', color: '#f59e0b' },
        { id: 4, name: 'Negotiation', color: '#ef4444' },
        { id: 5, name: 'Won', color: '#10b981' },
        { id: 6, name: 'Lost', color: '#6b7280' }
    ]
};
function saveCrm() { localStorage.setItem('nui_crm', JSON.stringify(crmData)); syncToBackend('crm', crmData); }

// Designer System
let designers = JSON.parse(localStorage.getItem('nui_designers')) || [];
// Only seed default designer on first-ever load (no key exists yet)
if (!localStorage.getItem('nui_designers')) {
    designers.push({ id: 1, name: 'Faren Young', email: 'faren@nui.com', password: 'designer123', role: 'Lead Designer', avatar: '', permissions: ['projects', 'proofs', 'assets'] });
    localStorage.setItem('nui_designers', JSON.stringify(designers));
}
function saveDesigners() { localStorage.setItem('nui_designers', JSON.stringify(designers)); }

// ==================== LOYALTY PROGRAM SYSTEM ====================
let loyaltyProgram = JSON.parse(localStorage.getItem('nui_loyalty')) || {
    enabled: true,
    pointsPerDollar: 1,
    rewardTiers: [
        { name: 'Bronze', minPoints: 0, discount: 5, perks: ['Priority support'] },
        { name: 'Silver', minPoints: 500, discount: 10, perks: ['Priority support', 'Free revisions'] },
        { name: 'Gold', minPoints: 1500, discount: 15, perks: ['Priority support', 'Free revisions', 'Rush delivery'] },
        { name: 'Platinum', minPoints: 5000, discount: 20, perks: ['All perks', 'Dedicated account manager', 'Exclusive pricing'] }
    ],
    members: []
};
function saveLoyalty() { localStorage.setItem('nui_loyalty', JSON.stringify(loyaltyProgram)); }

// ==================== EMAIL MARKETING SYSTEM ====================
let emailMarketing = JSON.parse(localStorage.getItem('nui_email_marketing')) || {
    settings: {
        senderName: 'New Urban Influence',
        senderEmail: 'info@newurbaninfluence.com',
        replyTo: 'info@newurbaninfluence.com',
        automatedSending: true,
        sendDay: 'monday',
        sendTime: '09:00'
    },
    templates: [
        { id: 1, name: 'Weekly Newsletter', subject: 'Your Weekly Design Inspiration', type: 'newsletter', content: '' },
        { id: 2, name: 'Promotion', subject: 'Special Offer Inside!', type: 'promo', content: '' },
        { id: 3, name: 'New Service Announcement', subject: 'Introducing Our New Service', type: 'announcement', content: '' }
    ],
    campaigns: [],
    subscribers: [],
    analytics: { sent: 0, opened: 0, clicked: 0, unsubscribed: 0 }
};
function saveEmailMarketing() { localStorage.setItem('nui_email_marketing', JSON.stringify(emailMarketing)); }

// ==================== SOCIAL MEDIA DM SYSTEM ====================
let socialMediaDM = JSON.parse(localStorage.getItem('nui_social_dm')) || {
    conversations: [],
    autoResponses: [
        { id: 1, trigger: 'pricing', platform: 'all', message: 'Thanks for your interest! Our branding packages start at $1,500. Would you like to schedule a free consultation?' },
        { id: 2, trigger: 'hello', platform: 'all', message: 'Hey there! Thanks for reaching out to New Urban Influence. How can we help you today?' },
        { id: 3, trigger: 'hours', platform: 'all', message: 'We\'re open Monday-Friday, 9AM-6PM EST. Leave a message and we\'ll get back to you!' }
    ],
    settings: {
        autoReplyEnabled: true,
        notifyOnNewMessage: true
    }
};
function saveSocialDM() { localStorage.setItem('nui_social_dm', JSON.stringify(socialMediaDM)); }

// ==================== SMS / OPENPHONE SYSTEM ====================
let smsSystem = JSON.parse(localStorage.getItem('nui_sms')) || {
    openPhone: {
        connected: false,
        apiKey: '',
        phoneNumber: '',
        userId: ''
    },
    conversations: [],
    templates: [
        { id: 1, name: 'Appointment Reminder', message: 'Hi {name}! This is a reminder about your consultation with New Urban Influence tomorrow at {time}. Reply to confirm!' },
        { id: 2, name: 'Project Update', message: 'Hi {name}! Your project is ready for review. Check your email for the proof link or reply with any questions!' },
        { id: 3, name: 'Payment Reminder', message: 'Hi {name}! Friendly reminder that your invoice #{invoice} is due soon. Questions? Reply to this text!' }
    ],
    autoResponses: [
        { trigger: 'stop', response: 'You have been unsubscribed. Reply START to resubscribe.' },
        { trigger: 'help', response: 'For support, visit newurbaninfluence.com or call us at your convenience!' }
    ],
    settings: {
        autoReplyEnabled: true,
        businessHoursOnly: true,
        businessHours: { start: '09:00', end: '18:00' }
    }
};
function saveSms() { localStorage.setItem('nui_sms', JSON.stringify(smsSystem)); }

// ==================== UNIFIED COMMUNICATIONS HUB ====================
let communicationsHub = JSON.parse(localStorage.getItem('nui_comm_hub')) || {
    inbox: [],
    filters: { unread: false, platform: 'all', client: '' },
    settings: { unifiedView: true, notifications: true }
};
function saveCommHub() { localStorage.setItem('nui_comm_hub', JSON.stringify(communicationsHub)); syncToBackend('comm_hub', communicationsHub); }

// Reset all data function (call from console if needed: resetAllData())
function resetAllData() {
    if (confirm('This will reset ALL data to defaults. Are you sure?')) {
        localStorage.removeItem('nui_clients');
        localStorage.removeItem('nui_orders');
        localStorage.removeItem('nui_designers');
        localStorage.removeItem('nui_leads');
        localStorage.removeItem('nui_projects');
        localStorage.removeItem('nui_payments');
        localStorage.removeItem('nui_invoices');
        localStorage.removeItem('nui_proofs');
        localStorage.removeItem('nui_analytics');
        localStorage.removeItem('nui_reviews');
        localStorage.removeItem('nui_payouts');
        localStorage.removeItem('nui_stripe');
        localStorage.removeItem('nui_loyalty');
        localStorage.removeItem('nui_email_marketing');
        localStorage.removeItem('nui_social_dm');
        localStorage.removeItem('nui_sms');
        localStorage.removeItem('nui_comm_hub');
        localStorage.removeItem('nui_crm');
        alert('Data reset! Refreshing page...');
        location.reload();
    }
}

// ==================== DATA INITIALIZATION (PRODUCTION) ====================
// Demo data removed - all data is stored in localStorage or Supabase
// New clients, orders, and data are created through the admin dashboard

function initializeDemoData() {
    // This function is kept for backwards compatibility but does nothing
    console.log('Production mode - no demo data initialized');
    return false;
}
// ==================== WORKFLOW TRIGGERS & VALIDATION ====================
// Trigger: When invoice is paid, update loyalty points
function triggerInvoicePaid(invoiceId) {
    const invoice = invoices.find(i => i.id === invoiceId);
    if (!invoice) return;

    // Find loyalty member and add points
    const member = loyaltyProgram.members.find(m => m.clientId === invoice.clientId);
    if (member) {
        const points = Math.floor(invoice.total * loyaltyProgram.pointsPerDollar);
        member.points += points;
        member.lastActivity = new Date().toISOString();
        // Update tier
        const tiers = loyaltyProgram.rewardTiers.sort((a, b) => b.minPoints - a.minPoints);
        for (const tier of tiers) {
            if (member.points >= tier.minPoints) {
                member.tier = tier.name;
                break;
            }
        }
        saveLoyalty();
        console.log('✅ Trigger: Loyalty points added - ' + points + ' points to ' + member.name);
    }

    // Update order status if linked
    if (invoice.orderId) {
        const order = orders.find(o => o.id === invoice.orderId);
        if (order && order.status === 'pending') {
            order.status = 'in_progress';
            saveOrders();
            console.log('✅ Trigger: Order status updated to in_progress');
        }
    }
}

// Trigger: When order is delivered, send notification
function triggerOrderDelivered(orderId) {
    const order = orders.find(o => o.id === orderId);
    if (!order) return;

    const client = clients.find(c => c.id === order.clientId);
    if (!client) return;

    // Add to communications hub
    communicationsHub.inbox.unshift({
        id: Date.now(),
        platform: 'system',
        clientId: client.id,
        clientName: client.name,
        preview: 'Order delivered: ' + order.projectName,
        timestamp: new Date().toISOString(),
        unread: true
    });
    saveCommHub();

    console.log('✅ Trigger: Delivery notification sent for ' + order.projectName);
}

// Trigger: When proof is approved, check payment and enable downloads
function triggerProofApproved(proofId) {
    const proof = proofs.find(p => p.id === proofId);
    if (!proof) return;

    const client = clients.find(c => c.id === proof.clientId);
    if (!client) return;

    // Update client brand guide status
    if (!client.brandGuide) client.brandGuide = { status: 'draft', proofComments: [] };
    client.brandGuide.status = 'approved';
    client.brandGuide.approvedAt = new Date().toISOString();
    saveClients();

    // Check payment status
    const isPaid = checkClientPaymentStatus(proof.clientId);
    if (isPaid) {
        console.log('✅ Trigger: Proof approved + Paid - Downloads enabled for ' + client.name);
        // Simulate email notification
        simulateEmailNotification(client.email, 'Your Brand Assets are Ready!', 'Download your approved brand assets from your portal.');
    } else {
        console.log('⚠️ Trigger: Proof approved but payment pending for ' + client.name);
    }
}

// Trigger: New lead added to pipeline
function triggerNewLead(leadId) {
    const lead = leads.find(l => l.id === leadId);
    if (!lead) return;

    // Add to CRM deals
    if (!crmData.deals) crmData.deals = [];
    const existingDeal = crmData.deals.find(d => d.leadId === leadId);
    if (!existingDeal) {
        crmData.deals.push({
            id: Date.now(),
            leadId: leadId,
            name: lead.business + ' - ' + lead.service,
            value: parseInt(lead.budget?.match(/\d+/)?.[0] || '0') * 1000,
            stage: 1,
            probability: 20,
            expectedClose: new Date(Date.now() + 14*24*60*60*1000).toISOString(),
            createdAt: new Date().toISOString()
        });
        saveCrm();
        console.log('✅ Trigger: New deal created in pipeline for ' + lead.name);
    }

    // Add to email subscribers
    const existingSub = emailMarketing.subscribers.find(s => s.email === lead.email);
    if (!existingSub) {
        emailMarketing.subscribers.push({
            id: Date.now(),
            email: lead.email,
            name: lead.name,
            status: 'active',
            source: 'lead',
            subscribedAt: new Date().toISOString()
        });
        saveEmailMarketing();
        console.log('✅ Trigger: Lead added to email subscribers');
    }
}

// Trigger: Auto-response for social media DM
function triggerSocialAutoResponse(platform, message) {
    if (!socialMediaDM.settings.autoReplyEnabled) return null;

    const msgLower = message.toLowerCase();
    for (const response of socialMediaDM.autoResponses) {
        if (response.platform === 'all' || response.platform === platform) {
            if (msgLower.includes(response.trigger)) {
                console.log('✅ Trigger: Auto-response matched for "' + response.trigger + '"');
                return response.message;
            }
        }
    }
    return null;
}

// Trigger: Weekly newsletter automation
function triggerWeeklyNewsletter() {
    if (!emailMarketing.settings.automatedSending) {
        console.log('⚠️ Automated sending is disabled');
        return;
    }

    const today = new Date().toLocaleDateString('en-US', { weekday: 'lowercase' });
    if (today !== emailMarketing.settings.sendDay) {
        console.log('⚠️ Today is not the scheduled send day (' + emailMarketing.settings.sendDay + ')');
        return;
    }

    const newsletterTemplate = emailMarketing.templates.find(t => t.type === 'newsletter');
    if (!newsletterTemplate) return;

    const campaign = {
        id: Date.now(),
        name: 'Auto Newsletter - ' + new Date().toLocaleDateString(),
        templateId: newsletterTemplate.id,
        status: 'sent',
        sentAt: new Date().toISOString(),
        recipients: emailMarketing.subscribers.filter(s => s.status === 'active').length,
        opened: 0,
        clicked: 0,
        createdAt: new Date().toISOString()
    };
    emailMarketing.campaigns.push(campaign);
    saveEmailMarketing();

    console.log('✅ Trigger: Weekly newsletter sent to ' + campaign.recipients + ' subscribers');
}

// Send email notification via Netlify Function → Resend/SendGrid
async function sendEmailNotification(to, subject, body) {
    try {
        const resp = await fetch('/.netlify/functions/send-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                to: to,
                subject: subject,
                html: `<div style="font-family: -apple-system, sans-serif; max-width: 600px; margin: 0 auto; background: #0a0a0a; color: #fff; border-radius: 12px; overflow: hidden;">
<div style="background: linear-gradient(135deg, #e63946, #ff6b6b); padding: 24px; text-align: center;">
<h2 style="margin: 0; font-size: 20px; color: #fff;">${subject}</h2>
</div>
<div style="padding: 32px;">
<p style="color: #ccc; font-size: 15px; line-height: 1.6;">${body}</p>
<p style="color: #888; font-size: 13px; margin-top: 24px;">— New Urban Influence</p>
</div>
</div>`,
                text: body
            })
        });
        if (resp.ok) {
            console.log('📧 Email sent to ' + to + ': ' + subject);
        } else {
            const err = await resp.json().catch(() => ({}));
            console.warn('📧 Email send failed:', err.error || resp.status);
        }
    } catch (err) {
        console.warn('📧 Email (offline):', to, subject, err.message);
    }
}
// Backwards compatibility alias
const simulateEmailNotification = sendEmailNotification;

// ==================== WORKFLOW VALIDATION ====================
function validateAllWorkflows() {
    console.log('🔍 Validating all workflows and triggers...\n');
    let passed = 0;
    let failed = 0;

    // Test 1: Client-Order relationship
    console.log('Test 1: Client-Order Relationships');
    for (const order of orders) {
        const client = clients.find(c => c.id === order.clientId);
        if (client) {
            passed++;
        } else {
            console.log('   ❌ Order #' + order.id + ' has no matching client');
            failed++;
        }
    }
    console.log('   ✅ ' + passed + ' orders have valid client references\n');

    // Test 2: Invoice-Order relationship
    passed = 0;
    console.log('Test 2: Invoice-Order Relationships');
    for (const invoice of invoices) {
        const order = orders.find(o => o.id === invoice.orderId);
        if (order || !invoice.orderId) {
            passed++;
        } else {
            console.log('   ❌ Invoice #' + invoice.id + ' has no matching order');
            failed++;
        }
    }
    console.log('   ✅ ' + passed + ' invoices have valid order references\n');

    // Test 3: Payment triggers loyalty
    console.log('Test 3: Payment-Loyalty Integration');
    const paidInvoices = invoices.filter(i => i.status === 'paid');
    const loyaltyMembers = loyaltyProgram.members;
    console.log('   - Paid invoices: ' + paidInvoices.length);
    console.log('   - Loyalty members: ' + loyaltyMembers.length);
    console.log('   ✅ Loyalty system ready\n');

    // Test 4: Proof-Client relationship
    passed = 0;
    console.log('Test 4: Proof-Client Relationships');
    for (const proof of proofs) {
        const client = clients.find(c => c.id === proof.clientId);
        if (client) {
            passed++;
        } else {
            console.log('   ❌ Proof #' + proof.id + ' has no matching client');
            failed++;
        }
    }
    console.log('   ✅ ' + passed + ' proofs have valid client references\n');

    // Test 5: Lead-Deal pipeline
    console.log('Test 5: Lead-Deal Pipeline');
    const dealsWithLeads = (crmData.deals || []).filter(d => leads.find(l => l.id === d.leadId));
    console.log('   - Total leads: ' + leads.length);
    console.log('   - Total deals: ' + (crmData.deals || []).length);
    console.log('   - Deals with valid leads: ' + dealsWithLeads.length);
    console.log('   ✅ Pipeline system ready\n');

    // Test 6: Communication channels
    console.log('Test 6: Communication Channels');
    console.log('   - SMS connected: ' + (smsSystem.openPhone.connected ? '✅' : '❌'));
    console.log('   - Facebook DMs: ' + (socialMediaDM.conversations.length > 0 ? '✅ Active' : '⏸️ No conversations'));
    console.log('   - Instagram DMs: ' + (clients.some(c => c.socialHandles?.instagram) ? '✅ Handles saved' : '⏸️ No handles'));
    console.log('   - Email automation: ' + (emailMarketing.settings.automatedSending ? '✅' : '❌') + '\n');

    // Test 7: Auto-response triggers
    console.log('Test 7: Auto-Response Triggers');
    const pricingResponse = triggerSocialAutoResponse('instagram', 'What is your pricing?');
    const hoursResponse = triggerSocialAutoResponse('facebook', 'What are your hours?');
    console.log('   - Pricing trigger: ' + (pricingResponse ? '✅' : '❌'));
    console.log('   - Hours trigger: ' + (hoursResponse ? '✅' : '❌') + '\n');

    // Summary
    console.log('═══════════════════════════════════════');
    console.log('WORKFLOW VALIDATION COMPLETE');
    console.log('Total tests: 7');
    console.log('Failed: ' + failed);
    console.log('Status: ' + (failed === 0 ? '✅ ALL SYSTEMS OPERATIONAL' : '⚠️ SOME ISSUES DETECTED'));
    console.log('═══════════════════════════════════════');

    return failed === 0;
}

// Run validation on admin dashboard load
// validateAllWorkflows(); // Uncomment to auto-run

// Site Images System
let siteImages = JSON.parse(localStorage.getItem('nui_site_images')) || {
    // CMS Logo Management
    headerLogo: { url: '', alt: 'Header Logo' },
    footerLogo: { url: '', alt: 'Footer Logo' },
    tagline: 'BUILD YOUR INFLUENCE',
    heroTagline: 'UNAPOLOGETICALLY DETROIT',
    // Page Images
    hero: { url: '', alt: 'Hero Background' },
    heroVideo: { url: '', alt: 'Hero Video' },
    about: { url: '', alt: 'About Section' },
    aboutStory: { url: '', alt: 'Our Story' },
    services: [
        { id: 'brand-kit', url: 'https://images.unsplash.com/photo-1558655146-9f40138edfeb?w=1920&q=80', alt: 'Brand Kit' },
        { id: 'product-brand', url: 'https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=1920&q=80', alt: 'Product Brand' },
        { id: 'service-brand', url: 'https://images.unsplash.com/photo-1556761175-5973dc0f32e7?w=1920&q=80', alt: 'Service Brand' },
        { id: 'website', url: 'https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=1920&q=80', alt: 'Website' },
        { id: 'mobile-app', url: 'https://images.unsplash.com/photo-1512941937669-90a1b58e7e9c?w=1920&q=80', alt: 'Mobile App' },
        { id: 'sales-funnel', url: 'https://images.unsplash.com/photo-1553729459-efe14ef6055d?w=1920&q=80', alt: 'Sales Funnel' },
        { id: 'custom', url: 'https://images.unsplash.com/photo-1542744094-3a31f272c490?w=1920&q=80', alt: 'Custom Package' }
    ],
    team: [],
    portfolio: [],
    blog: []
};
function saveSiteImages() {
    localStorage.setItem('nui_site_images', JSON.stringify(siteImages));
    updateSiteLogos(); // Update logos immediately after saving
    _pushToBackend('site_images', siteImages);
}

// Get service package image from siteImages CMS
function getServiceImage(serviceId) {
    const s = siteImages.services.find(s => s.id === serviceId);
    return s && s.url ? s.url : '';
}

// Toast notification system
function showNotification(message, type) {
    type = type || 'success';
    const existing = document.getElementById('nui-toast');
    if (existing) existing.remove();
    const colors = { success: '#2ecc71', error: '#e74c3c', info: '#3498db', warning: '#f39c12' };
    const icons = { success: '✓', error: '✕', info: 'ℹ', warning: '⚠' };
    const toast = document.createElement('div');
    toast.id = 'nui-toast';
    toast.innerHTML = '<span style="font-size: 18px; margin-right: 10px;">' + (icons[type] || '✓') + '</span>' + message;
    toast.style.cssText = 'position:fixed;top:24px;right:24px;z-index:99999;padding:16px 28px;border-radius:12px;font-size:14px;font-weight:600;color:#fff;display:flex;align-items:center;box-shadow:0 8px 32px rgba(0,0,0,0.3);backdrop-filter:blur(10px);transform:translateX(120%);transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1);background:' + (colors[type] || colors.success) + ';';
    document.body.appendChild(toast);
    requestAnimationFrame(function() { toast.style.transform = 'translateX(0)'; });
    setTimeout(function() {
        toast.style.transform = 'translateX(120%)';
        setTimeout(function() { toast.remove(); }, 500);
    }, 3000);
}

// Push all portfolio changes to frontend views instantly
function pushPortfolioToFrontend() {
    savePortfolio();
    // Refresh portfolio view if visible
    var pv = document.getElementById('portfolioView');
    if (pv && pv.innerHTML.length > 100) { loadPortfolioView(); }
    // Refresh homepage case studies if visible
    var hv = document.getElementById('homeView');
    if (hv && hv.innerHTML.length > 100) { loadHomeView(); }
    // Resolve any idb:// images
    setTimeout(resolveAllImages, 100);
}

// Generate footer HTML with CMS logo
function getFooterHTML() {
    const footerLogoSrc = siteImages.footerLogo?.url || 'icons/icon-192.png';
    const footerLogoAlt = siteImages.footerLogo?.alt || 'NUI';
    const year = new Date().getFullYear();

    return `
 <footer class="footer">
<div class="footer-main">
            <!-- Brand Column -->
<div class="footer-brand">
<a class="footer-brand-logo" href="/">
                    ${footerLogoSrc ? '<img loading="lazy" src="' + footerLogoSrc + '" alt="' + footerLogoAlt + '" onerror="this.style.display=\'none\'">' : ''}
<span style="color: var(--red);">NUI</span>
</a>
<p class="footer-brand-desc">Detroit-based creative agency specializing in brand identity, web design, and digital marketing. Unapologetically Detroit.</p>
<div class="footer-socials">
<a href="https://instagram.com/newurbaninfluence" target="_blank" class="footer-social-link" title="Instagram">📷</a>
<a href="https://twitter.com/newurbaninfluence" target="_blank" class="footer-social-link" title="X / Twitter">𝕏</a>
<a href="https://linkedin.com/company/newurbaninfluence" target="_blank" class="footer-social-link" title="LinkedIn">in</a>
<a href="https://facebook.com/newurbaninfluence" target="_blank" class="footer-social-link" title="Facebook">f</a>
</div>
</div>

            <!-- Services -->
<div class="footer-col">
<div class="footer-col-title">Services</div>
<a href="/services/brand-identity-packages-detroit">Brand Identity Packages</a>
<a href="/services/logo-design-detroit">Logo Design</a>
<a href="/services/web-design-detroit">Web Design</a>
<a href="/services/packaging-design-detroit">Packaging Design</a>
<a href="/services/social-media-templates-detroit">Social Media</a>
<a href="/services/marketing-automation-detroit">Automation & Funnels</a>
<a href="/services/print-design-detroit">Print & Signage</a>
<a href="/services/brand-guidelines-detroit">Brand Guidelines</a>
</div>

            <!-- Company -->
<div class="footer-col">
<div class="footer-col-title">Company</div>
<a href="/about" onclick="event.preventDefault(); showView('about');">About Us</a>
<a href="/portfolio" onclick="event.preventDefault(); showView('portfolio');">Portfolio</a>
<a href="/blog" onclick="event.preventDefault(); showView('blog');">Blog</a>
<a href="/services/brand-identity-packages-detroit" onclick="event.preventDefault(); showView('services');">Pricing</a>
<a href="/contact" onclick="event.preventDefault(); showView('intake');">Contact</a>
<a href="/portal" onclick="event.preventDefault(); showView('portal');">Client Portal</a>
<a href="/#faq" onclick="event.preventDefault(); document.getElementById('faq')?.scrollIntoView({behavior:'smooth'});">FAQ</a>
</div>

            <!-- Resources -->
<div class="footer-col">
<div class="footer-col-title">Resources</div>
<a href="/blog/how-much-does-logo-design-cost-detroit">Logo Design Pricing</a>
<a href="/blog/branding-mistakes-small-businesses">Branding Tips</a>
<a href="/blog/restaurant-branding-guide-detroit">Restaurant Guide</a>
<a href="/work/good-cakes-and-bakes">Case Studies</a>
<a href="/portal" onclick="event.preventDefault(); showView('portal');">Designer Login</a>
<a href="/sitemap.xml" target="_blank">Sitemap</a>
</div>

            <!-- Service Areas (Geo SEO) -->
<div class="footer-col">
<div class="footer-col-title">Service Areas</div>
<a href="/locations/detroit" style="color:rgba(255,255,255,0.5);font-size:14px;display:block;padding:4px 0;text-decoration:none;transition:color 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='rgba(255,255,255,0.5)'">Detroit</a>
<a href="/locations/southfield" style="color:rgba(255,255,255,0.5);font-size:14px;display:block;padding:4px 0;text-decoration:none;transition:color 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='rgba(255,255,255,0.5)'">Southfield</a>
<a href="/locations/farmington-hills" style="color:rgba(255,255,255,0.5);font-size:14px;display:block;padding:4px 0;text-decoration:none;transition:color 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='rgba(255,255,255,0.5)'">Farmington Hills</a>
<span style="font-size:14px;display:block;padding:4px 0;"><a href="/locations/royal-oak" style="color:rgba(255,255,255,0.5);text-decoration:none;transition:color 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='rgba(255,255,255,0.5)'">Royal Oak</a> · <a href="/locations/troy" style="color:rgba(255,255,255,0.5);text-decoration:none;transition:color 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='rgba(255,255,255,0.5)'">Troy</a></span>
<span style="font-size:14px;display:block;padding:4px 0;"><a href="/locations/dearborn" style="color:rgba(255,255,255,0.5);text-decoration:none;transition:color 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='rgba(255,255,255,0.5)'">Dearborn</a> · <a href="/locations/ann-arbor" style="color:rgba(255,255,255,0.5);text-decoration:none;transition:color 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='rgba(255,255,255,0.5)'">Ann Arbor</a></span>
<span style="font-size:14px;display:block;padding:4px 0;"><a href="/locations/birmingham" style="color:rgba(255,255,255,0.5);text-decoration:none;transition:color 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='rgba(255,255,255,0.5)'">Birmingham</a> · <a href="/locations/novi" style="color:rgba(255,255,255,0.5);text-decoration:none;transition:color 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='rgba(255,255,255,0.5)'">Novi</a></span>
<span style="font-size:14px;display:block;padding:4px 0;"><a href="/locations/sterling-heights" style="color:rgba(255,255,255,0.5);text-decoration:none;transition:color 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='rgba(255,255,255,0.5)'">Sterling Heights</a> · <a href="/locations/livonia" style="color:rgba(255,255,255,0.5);text-decoration:none;transition:color 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='rgba(255,255,255,0.5)'">Livonia</a></span>
<span style="font-size:14px;display:block;padding:4px 0;"><a href="/locations/warren" style="color:rgba(255,255,255,0.5);text-decoration:none;transition:color 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='rgba(255,255,255,0.5)'">Warren</a> · <a href="/locations/pontiac" style="color:rgba(255,255,255,0.5);text-decoration:none;transition:color 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='rgba(255,255,255,0.5)'">Pontiac</a></span>
</div>

            <!-- Contact -->
<div class="footer-col">
<div class="footer-col-title">Get In Touch</div>
<div class="footer-contact-item">
<span class="footer-contact-icon">📍</span>
<span>By Appointment Only · Serving Metro Detroit</span>
</div>
<div class="footer-contact-item">
<span class="footer-contact-icon">📞</span>
<a href="tel:+12484878747">(248) 487-8747</a>
</div>
<div class="footer-contact-item">
<span class="footer-contact-icon">✉️</span>
<a href="mailto:info@newurbaninfluence.com">info@newurbaninfluence.com</a>
</div>
<div class="footer-contact-item">
<span class="footer-contact-icon">🕐</span>
<span>Mon – Fri: 9AM – 6PM</span>
</div>
</div>
</div>

        <!-- Bottom Bar -->
<div class="footer-bottom">
<div class="footer-bottom-content">
<div class="footer-copyright">© ${year} New Urban Influence. All rights reserved.</div>
<div class="footer-legal">
<span style="color:rgba(255,255,255,0.3);font-size:12px;">Privacy Policy</span>
<span style="color:rgba(255,255,255,0.3);font-size:12px;">Terms of Service</span>
</div>
<div class="footer-badge">🔴 Built in Detroit with love</div>
<a onclick="showView('portal'); setTimeout(() => setLoginType('admin'), 100);" style="color: rgba(255,255,255,0.15); font-size: 11px; cursor: pointer; text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='rgba(255,255,255,0.4)'" onmouseout="this.style.color='rgba(255,255,255,0.15)'">Staff Login</a>
</div>
</div>
 </footer>`;
}

// ==================== VIEW MANAGEMENT ====================
// ==================== PER-PAGE SEO METADATA ====================
const pageSEO = {
    home: {
        title: 'New Urban Influence | Detroit Branding Agency — Logo Design & Brand Identity from $1,500',
        description: 'Detroit branding agency for small businesses and startups. Professional brand identity packages from $1,500 — logo design, packaging, social media templates, brand guidelines. 4.9★ rated. Free consultation. Serving Metro Detroit, Southfield, Royal Oak, Ann Arbor and all of Michigan.',
        keywords: 'branding agency detroit, logo design detroit, brand identity detroit, graphic design agency detroit, detroit creative agency, michigan branding agency, affordable branding packages, small business branding detroit, packaging design detroit, branding near me, best branding agency detroit',
        ogTitle: 'New Urban Influence | Detroit Branding Agency — Packages from $1,500',
        ogDescription: 'Professional branding for small businesses. Logo design, brand identity, packaging, social media templates. 4.9★ rated. Free consultation. Payment plans available.',
        hash: ''
    },
    about: {
        title: 'About New Urban Influence | Detroit Branding & Graphic Design Agency Team',
        description: 'New Urban Influence is a Detroit-based branding and graphic design agency helping small businesses and startups build professional brand identities. 4.9★ rated with 28+ reviews. Brand strategists and designers serving Metro Detroit, Michigan, and nationwide.',
        keywords: 'about new urban influence, detroit branding agency team, detroit graphic design agency, michigan brand strategist, detroit graphic designers, who is new urban influence, nui detroit, creative agency detroit michigan',
        ogTitle: 'About New Urban Influence | Detroit Branding Agency',
        ogDescription: 'Detroit branding agency helping small businesses build professional brands. 4.9★ rated. 50+ brands elevated.',
        hash: 'about'
    },
    services: {
        title: 'Branding Packages & Pricing | Detroit Logo Design & Brand Identity — New Urban Influence',
        description: 'Branding packages for small businesses: Brand Kit $1,500, Service Brand Identity $4,500+, Product Brand Identity $5,500+. Logo design from $500. Packaging design, print design, banners, posters, yard signs, vinyl decals, social media templates, business cards, brand guidelines. Payment plans. Detroit, MI.',
        keywords: 'branding packages detroit, logo design cost detroit, how much does branding cost, brand identity pricing michigan, packaging design detroit michigan, business card design detroit, social media templates design, print design detroit, banner design detroit, yard sign design detroit, vinyl decal design detroit, vehicle magnets detroit, postcard printing detroit, acrylic signs detroit, dibond signs detroit, foam core detroit, affordable branding small business, logo design near me, branding payment plans, brand guidelines cost',
        ogTitle: 'Branding Packages & Pricing | From $1,500',
        ogDescription: 'Brand Kit $1,500 • Service Brand $4,500+ • Product Brand $5,500+. Logo, packaging, social templates. Payment plans available.',
        hash: 'services'
    },
    portfolio: {
        title: 'Branding Portfolio | Detroit Logo Design & Brand Identity Work — New Urban Influence',
        description: 'View New Urban Influence\'s branding portfolio. Logo design, packaging design, brand guidelines, visual identity systems, social media branding for small businesses, startups, and product brands. Detroit, Michigan.',
        keywords: 'branding portfolio detroit, logo design examples detroit, brand identity portfolio michigan, packaging design examples, detroit graphic design portfolio, branding work samples, logo designer portfolio',
        ogTitle: 'Branding Portfolio | Logo Design & Brand Identity',
        ogDescription: 'See the brands we\'ve elevated. Logo design, packaging, brand systems and more. 50+ brands transformed.',
        hash: 'portfolio'
    },
    blog: {
        title: 'Branding Tips & Design Blog | Small Business Branding Advice — New Urban Influence Detroit',
        description: 'Expert branding tips for small businesses. Learn about logo design best practices, brand strategy, packaging design, social media marketing, and how to build a professional brand identity on any budget. From Detroit\'s top-rated branding agency.',
        keywords: 'branding tips small business, logo design tips, brand strategy blog, small business branding advice detroit, how to build a brand, design insights, social media marketing tips, packaging design tips, branding on a budget',
        ogTitle: 'Branding Tips & Design Blog | Small Business Advice',
        ogDescription: 'Expert branding tips and design insights. Learn how to build a professional brand on any budget.',
        hash: 'blog'
    },
    portal: {
        title: 'Client Portal | New Urban Influence — Project Tracking & Proof Review',
        description: 'Access your New Urban Influence client portal. Review design proofs, approve projects, track progress, view invoices, and communicate with your design team in real time.',
        keywords: 'client portal, design proof review, project tracking, branding project portal, new urban influence login',
        ogTitle: 'Client Portal | Project Tracking & Proofs',
        ogDescription: 'Review proofs, approve designs, track your project, and communicate with your NUI team.',
        hash: 'portal'
    },
    intake: {
        title: 'Get Started | Free Branding Consultation — New Urban Influence Detroit',
        description: 'Start your branding project with New Urban Influence. Fill out our quick intake form and book a free strategy consultation. We\'ll create a custom pricing estimate based on your business needs. No obligation.',
        keywords: 'free branding consultation detroit, get branding quote, start branding project, brand identity consultation, design agency intake form',
        ogTitle: 'Get Started | Free Branding Consultation',
        ogDescription: 'Book a free strategy call. Get a custom pricing estimate. No obligation. Start building your brand today.',
        hash: 'intake'
    }
};

function updatePageSEO(viewName) {
    const seo = pageSEO[viewName] || pageSEO.home;

    // Update document title
    document.title = seo.title;

    // Update meta description
    let metaDesc = document.querySelector('meta[name="description"]');
    if (metaDesc) metaDesc.content = seo.description;

    // Update meta keywords
    let metaKeywords = document.querySelector('meta[name="keywords"]');
    if (metaKeywords) metaKeywords.content = seo.keywords;

    // Update canonical URL
    let canonical = document.querySelector('link[rel="canonical"]');
    if (canonical) canonical.href = seo.hash ? `https://newurbaninfluence.com/#${seo.hash}` : 'https://newurbaninfluence.com';

    // Update Open Graph tags
    let ogTitle = document.querySelector('meta[property="og:title"]');
    if (ogTitle) ogTitle.content = seo.ogTitle;
    let ogDesc = document.querySelector('meta[property="og:description"]');
    if (ogDesc) ogDesc.content = seo.ogDescription;
    let ogUrl = document.querySelector('meta[property="og:url"]');
    if (ogUrl) ogUrl.content = seo.hash ? `https://newurbaninfluence.com/#${seo.hash}` : 'https://newurbaninfluence.com';

    // Update Twitter tags
    let twTitle = document.querySelector('meta[name="twitter:title"]');
    if (twTitle) twTitle.content = seo.ogTitle;
    let twDesc = document.querySelector('meta[name="twitter:description"]');
    if (twDesc) twDesc.content = seo.ogDescription;

    // Update URL hash (for bookmarking and sharing)
    if (seo.hash) {
        history.replaceState({ view: viewName }, seo.title, `#${seo.hash}`);
    } else {
        history.replaceState({ view: 'home' }, seo.title, window.location.pathname);
    }
}

function showView(viewName, skipTracking = false) {
    // Track navigation for back button functionality
    if (!skipTracking && typeof trackNavigation === 'function') {
        const currentView = document.querySelector('.view.active');
        if (currentView) {
            trackNavigation(currentView.id.replace('View', ''));
        }
    }
    document.querySelectorAll('.nav-links a').forEach(link => link.classList.toggle('active', link.dataset.view === viewName));
    document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
    document.getElementById(viewName + 'View').classList.add('active');
    window.scrollTo(0, 0);
    loadViewContent(viewName);

    // Update page-level SEO for this view
    updatePageSEO(viewName);
}

function scrollToContact() {
    showView('intake');
}

function toggleMobileMenu() {
    const menu = document.getElementById('mobileMenu');
    const hamburger = document.querySelector('.hamburger');
    menu.classList.toggle('active');
    hamburger.classList.toggle('active');
    document.body.style.overflow = menu.classList.contains('active') ? 'hidden' : '';
}

function loadViewContent(viewName) {
    const viewEl = document.getElementById(viewName + 'View');
    if (!viewEl.innerHTML.trim()) {
        if (viewName === 'home') loadHomeView();
        if (viewName === 'about') loadAboutView();
        if (viewName === 'services') loadServicesView();
        if (viewName === 'portfolio') loadPortfolioView();
        if (viewName === 'blog') loadBlogView();
        if (viewName === 'portal') loadPortalView();
        if (viewName === 'intake') {
            // Default to free consultation if no specific service was pre-selected
            if (!intakeData || !intakeData.serviceId) {
                intakeData = { serviceId: 'consultation', serviceName: 'Free Strategy Call', price: 0, customServices: [] };
                currentIntakeStep = 1;
                uploadedFiles = [];
            }
            renderIntakeWizard(intakeData.serviceId);
        }
    }
}

// Update site logos from CMS
function updateSiteLogos() {
    // Update main nav logo
    const mainNavLogo = document.getElementById('mainNavLogo');
    if (mainNavLogo) {
        if (siteImages.headerLogo?.url) {
            mainNavLogo.innerHTML = `<img loading="lazy" src="${siteImages.headerLogo.url}" alt="New Urban Influence – Detroit Branding Agency" style="height: 36px; display: block;"><span style="position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;">NUI | New Urban Influence</span>`;
        }
        // If no CMS logo, the default icons/icon-192.png img + sr-only text from HTML stays as-is
    }

    // Update admin header logo
    const adminHeaderLogo = document.getElementById('adminHeaderLogo');
    if (adminHeaderLogo && siteImages.headerLogo?.url) {
        adminHeaderLogo.src = siteImages.headerLogo.url;
    }

    // Update hero taglines from CMS
    const heroTitle = document.querySelector('.hero-content h1');
    if (heroTitle && siteImages.tagline) {
        heroTitle.innerHTML = `BUILD YOUR<br><span style="color: var(--red);">${siteImages.tagline.split(' ').pop() || 'INFLUENCE'}</span>`;
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', async () => {
    initializeTheme();
    updateSiteLogos();

    // Apply CMS service images to data-service-image elements
    document.querySelectorAll('[data-service-image]').forEach(function(img) {
        var serviceId = img.getAttribute('data-service-image');
        var cmsUrl = getServiceImage(serviceId);
        if (cmsUrl) img.src = cmsUrl;
    });

    // Route to correct view based on URL path OR hash (supports direct links & bookmarks)
    const validViews = ['home', 'about', 'services', 'portfolio', 'blog', 'portal', 'intake'];
    const hashView = window.location.hash.replace('#', '').split('?')[0];
    const pathView = window.location.pathname.replace(/^\//, '').split('/')[0].split('?')[0];
    const routeView = (hashView && validViews.includes(hashView)) ? hashView
        : (pathView && validViews.includes(pathView)) ? pathView
        : null;
    // Try to load portfolio from cloud BEFORE rendering (so mobile gets real image URLs)
    try {
        if (window.NuiPortfolioSync && typeof NuiPortfolioSync.load === 'function') {
            const cloudData = await Promise.race([
                NuiPortfolioSync.load(),
                new Promise(resolve => setTimeout(() => resolve(null), 3000)) // 3s timeout
            ]);
            if (cloudData && cloudData.length > 0) {
                // Merge cloud data but fix broken image refs using defaults
                portfolioData = cloudData.map(function(item, idx) {
                    var fallback = _defaultPortfolio[idx] || _defaultPortfolio[0];
                    if (!item.img || item.img.startsWith('idb://') || item.img === '[too-large]') {
                        item.img = fallback.img;
                    }
                    if (item.assets) {
                        ['primaryLogo','secondaryLogo','iconMark'].forEach(function(k) {
                            if (item.assets[k] && (item.assets[k].startsWith('idb://') || item.assets[k] === '[too-large]')) {
                                item.assets[k] = (fallback.assets && fallback.assets[k]) ? fallback.assets[k] : '';
                            }
                        });
                    }
                    // Sync names from defaults
                    if (fallback && item.id === fallback.id) item.name = fallback.name;
                    return item;
                });
                try { localStorage.setItem('nui_portfolio', JSON.stringify(portfolioData)); } catch(e) {}
                console.log('✅ Portfolio pre-loaded from cloud before render');
            }
        }
    } catch(e) { console.log('Cloud portfolio pre-load skipped:', e.message); }

    if (routeView) {
        showView(routeView, true);
    } else {
        loadHomeView();
        updatePageSEO('home');
    }

    // Handle browser back/forward buttons
    window.addEventListener('popstate', (e) => {
        if (e.state && e.state.view) {
            showView(e.state.view, true);
        } else {
            const hv = window.location.hash.replace('#', '');
            const pv = window.location.pathname.replace(/^\//, '').split('/')[0];
            const resolvedView = (hv && validViews.includes(hv)) ? hv
                : (pv && validViews.includes(pv)) ? pv : 'home';
            showView(resolvedView, true);
        }
    });

    // Hydrate data from backend (non-blocking)
    try {
        const hydrated = await hydrateFromBackend();
        if (hydrated) {
            console.log('✅ App data hydrated from Supabase backend');
            // Re-render active view with fresh backend data
            try {
                const activeView = document.querySelector('.view.active');
                if (activeView) {
                    if (activeView.id === 'homeView') {
                        const csGrid = document.getElementById('homepageCaseStudies');
                        if (csGrid && typeof _refreshHomepageCaseStudies === 'function') _refreshHomepageCaseStudies(csGrid);
                    } else if (activeView.id === 'portfolioView') {
                        if (typeof loadPortfolioView === 'function') loadPortfolioView();
                    }
                }
                // If admin panel is open, refresh the active admin tab
                var adminPanel = document.getElementById('adminPanel');
                if (adminPanel && adminPanel.style.display !== 'none') {
                    var activeTab = adminPanel.querySelector('.admin-tab.active');
                    if (activeTab) {
                        var tabName = activeTab.getAttribute('data-tab') || activeTab.textContent.trim().toLowerCase();
                        if (tabName === 'clients' && typeof loadAdminClientsPanel === 'function') loadAdminClientsPanel();
                        if (tabName === 'orders' && typeof loadAdminOrdersPanel === 'function') loadAdminOrdersPanel();
                    }
                }
                // Resolve any idb:// images in the refreshed views
                if (typeof resolveAllImages === 'function') setTimeout(resolveAllImages, 300);
            } catch(refreshErr) { console.warn('Post-hydration refresh error:', refreshErr.message); }
        }
    } catch (e) {
        console.log('Backend hydration skipped:', e.message);
    }

    // Portfolio cloud sync — late refresh in case pre-render load was skipped or timed out
    try {
        if (window.NuiPortfolioSync) {
            const cloudPortfolio = await NuiPortfolioSync.load();
            if (cloudPortfolio && cloudPortfolio.length > 0) {
                // Fix broken idb:// refs using default fallback images
                cloudPortfolio.forEach(function(p, idx) {
                    var fallback = _defaultPortfolio[idx] || _defaultPortfolio[0];
                    if (!p.img || p.img.startsWith('idb://') || p.img === '[too-large]') p.img = fallback.img;
                    if (p.assets) {
                        ['primaryLogo','secondaryLogo','iconMark'].forEach(function(k) {
                            if (p.assets[k] && (p.assets[k].startsWith('idb://') || p.assets[k] === '[too-large]')) {
                                p.assets[k] = (fallback.assets && fallback.assets[k]) ? fallback.assets[k] : '';
                            }
                        });
                        if (p.assets.mockups) {
                            p.assets.mockups = p.assets.mockups.map(function(m) {
                                return (m && (m.startsWith('idb://') || m === '[too-large]')) ? '' : m;
                            });
                        }
                    }
                    if (fallback && p.id === fallback.id) p.name = fallback.name;
                });
                // Only re-render if data actually changed (has new URLs)
                const oldJson = JSON.stringify(portfolioData.map(function(p) { return p.img; }));
                const newJson = JSON.stringify(cloudPortfolio.map(function(p) { return p.img; }));
                if (oldJson !== newJson) {
                    portfolioData = cloudPortfolio;
                    try { localStorage.setItem('nui_portfolio', JSON.stringify(portfolioData)); } catch(e) {}
                    const activeView = document.querySelector('.view.active');
                    if (activeView) {
                        if (activeView.id === 'homeView') {
                            const csGrid = document.getElementById('homepageCaseStudies');
                            if (csGrid) { _refreshHomepageCaseStudies(csGrid); }
                        } else if (activeView.id === 'portfolioView') {
                            loadPortfolioView();
                        }
                    }
                    console.log('✅ Portfolio refreshed from cloud (late sync)');
                }
            }
        }
    } catch (e) {
        console.log('Portfolio cloud sync skipped:', e.message);
    }

    // Mobile footer accordion — collapse footer columns on small screens
    if (window.innerWidth <= 580) {
        document.querySelectorAll('.footer-col .footer-col-title').forEach(function(title) {
            title.addEventListener('click', function() {
                this.parentElement.classList.toggle('open');
            });
        });
    }
});

// Render homepage case study cards from portfolioData (reusable for cloud sync refresh)
function _refreshHomepageCaseStudies(csGrid) {
    if (!csGrid) csGrid = document.getElementById('homepageCaseStudies');
    if (!csGrid) return;
    csGrid.innerHTML = portfolioData.slice(0, 4).map(function(p) {
        const imgIsIdb = p.img && p.img.startsWith('idb://');
        const imgSrc = (!imgIsIdb && p.img) ? p.img : '';
        return '<a href="/work/' + (p.id || '') + '" style="cursor: pointer; position: relative; aspect-ratio: 16/9; border-radius: 16px; overflow: hidden; display: flex; align-items: flex-end; background-color: ' + (p.colors && p.colors[1] ? p.colors[1] : '#1a1a1a') + '; border: 1px solid rgba(255,255,255,0.1); transition: all 0.3s; box-shadow: 0 20px 60px rgba(0,0,0,0.4); text-decoration: none; color: inherit;" ' + (imgIsIdb ? 'data-idb-bg="' + p.img + '"' : '') + ' onmouseover="this.style.transform=\'translateY(-8px)\'; this.style.borderColor=\'var(--red)\'" onmouseout="this.style.transform=\'none\'; this.style.borderColor=\'rgba(255,255,255,0.1)\'">' +
            (imgSrc ? '<img src="' + imgSrc + '" alt="' + (p.name || '') + ' - ' + (p.tag || '') + ' by New Urban Influence Detroit" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;" loading="lazy">' : '') +
            '<div style="position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.5) 50%, transparent 100%);"></div>' +
            '<div style="position: relative; padding: 32px; width: 100%;"><span style="background: var(--red); color: #fff; font-size: 10px; padding: 4px 12px; border-radius: 4px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600;">' + (p.tag || '') + '</span><h4 style="font-size: 28px; font-weight: 800; margin-top: 16px; line-height: 1.2;">' + (p.name || '') + '</h4><p style="color: rgba(255,255,255,0.7); font-size: 14px; margin-top: 12px; line-height: 1.6;">' + (p.desc || '') + '</p></div>' +
        '</a>';
    }).join('');
    setTimeout(function() { if (typeof resolveAllImages === 'function') resolveAllImages(); }, 100);
}

// ==================== HOME VIEW ====================
function loadHomeView() {
    document.getElementById('homeView').innerHTML = `
<section class="hero">
<div class="hero-media">
<div class="hero-media-container">
<video id="heroVideo" muted loop playsinline autoplay preload="auto">
<source src="https://videos.pexels.com/video-files/30022653/12881030_1920_1080_30fps.mp4" type="video/mp4">
</video>
</div>
<div class="hero-media-overlay"></div>
</div>
<div class="hero-content">
<div class="badge">Detroit's Premier Digital Agency</div>
<h1>BUILD YOUR<br><span style="color: var(--red);">INFLUENCE</span></h1>
<p>Strategic branding & digital presence for business owners ready to dominate their market. <span>Your brand is your business. Make it unforgettable.</span></p>
<div class="hero-buttons">
<a href="/contact" class="btn-cta" onclick="event.preventDefault(); showView('intake');">Book Strategy Call</a>
<a href="/portfolio" class="btn-outline" onclick="event.preventDefault(); showView('portfolio');">View Our Work</a>
</div>
</div>
<div class="scroll-indicator">Scroll</div>
</section>
<section class="stats-ticker">
<div class="ticker-text">50+ BRANDS ELEVATED &bull; $2M+ REVENUE GENERATED &bull; DETROIT BORN & RAISED &bull; 50+ BRANDS ELEVATED &bull; $2M+ REVENUE GENERATED &bull; DETROIT BORN & RAISED &bull;</div>
</section>
<section style="padding: 48px 0; background: #0a0a0a; border-bottom: 1px solid rgba(255,255,255,0.06); overflow: hidden;">
<div style="text-align: center; margin-bottom: 32px;">
<h3 style="font-size: 13px; text-transform: uppercase; letter-spacing: 3px; color: rgba(255,255,255,0.35); font-weight: 600;">TRUSTED BY LEADERS, ARTISTS & BUSINESSES ACROSS DETROIT</h3>
</div>
<div style="display: flex; animation: clientScroll 80s linear infinite; width: max-content; will-change: transform;">
<div style="display: flex; align-items: center; gap: 20px; padding: 0 10px;">
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Gov. Rick Snyder</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Kash Doll</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Rep. Leslie Love</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Eric Sabree, Wayne Co. Treasurer</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Beacon Park</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Chambora Vodka</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Detroit Design Festival</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Light It Up Livernois</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Bouzouki (Bouki) Greektown</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Niki's Lounge</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Ask Jennyfer</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">National All Things Detroit Day</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Good Cakes & Bakes</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">I Rep Small Business Saturday</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Crab House Detroit</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">House of Morrison</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Detroit Possible</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Esteem We Inc.</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Fatboyz Detroit</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Deep Drama Designs</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Chevelles Bar</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Jo's Gallery</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Loco's Tex-Mex Grille</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">AJ VIP Photography</span><span style="color: #dc2626;">&bull;</span>
</div>
<div style="display: flex; align-items: center; gap: 20px; padding: 0 10px;">
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Gov. Rick Snyder</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Kash Doll</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Rep. Leslie Love</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Eric Sabree, Wayne Co. Treasurer</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Beacon Park</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Chambora Vodka</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Detroit Design Festival</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Light It Up Livernois</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Bouzouki (Bouki) Greektown</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Niki's Lounge</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Ask Jennyfer</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">National All Things Detroit Day</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Good Cakes & Bakes</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">I Rep Small Business Saturday</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Crab House Detroit</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">House of Morrison</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Detroit Possible</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Esteem We Inc.</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Fatboyz Detroit</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Deep Drama Designs</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Chevelles Bar</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Jo's Gallery</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">Loco's Tex-Mex Grille</span><span style="color: #dc2626;">&bull;</span>
<span style="font-size: 15px; font-weight: 800; color: white; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;">AJ VIP Photography</span><span style="color: #dc2626;">&bull;</span>
</div>
</div>
</section>
<section class="section dark">
<div class="struggle-section">
<div class="struggle-left">
<h2>THE<br><span class="red">STRUGGLE</span><br>IS REAL.</h2>
<p>Most brands fade into the background noise. In a city that never sleeps and a digital world that never stops, being "good enough" is a death sentence.</p>
</div>
<div class="problem-cards">
<div class="problem-card"><div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;"><div class="number">01</div><span style="color: var(--gray); font-size: 12px; text-transform: uppercase; letter-spacing: 2px;">Problem Detected</span></div><h3>Your brand looks generic and forgettable</h3></div>
<div class="problem-card"><div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;"><div class="number">02</div><span style="color: var(--gray); font-size: 12px; text-transform: uppercase; letter-spacing: 2px;">Problem Detected</span></div><h3>Your website doesn't convert visitors into customers</h3></div>
<div class="problem-card"><div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;"><div class="number">03</div><span style="color: var(--gray); font-size: 12px; text-transform: uppercase; letter-spacing: 2px;">Problem Detected</span></div><h3>Your social media feels disconnected from your brand</h3></div>
<div class="problem-card"><div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;"><div class="number">04</div><span style="color: var(--gray); font-size: 12px; text-transform: uppercase; letter-spacing: 2px;">Problem Detected</span></div><h3>You're not standing out in a crowded market</h3></div>
</div>
</div>
</section>
<section class="section dark">
<div class="services-layout">
<div class="services-header">
<div class="label">Our Expertise</div>
<h2 class="section-title">WHAT WE<br><span class="red">CREATE</span></h2>
<p style="color: var(--gray); margin-top: 24px;">We don't just make things look pretty. We build systems, brands, and experiences that print money and build legacy.</p>
<button class="btn-cta" style="margin-top: 32px;" onclick="showView('services')">Explore All Services</button>
</div>
<div class="services-grid home-services">
<div class="service-card-simple" onclick="showView('services')"><div class="arrow">↗</div><h3>Brand Identity Design</h3><p>Forge Your Legacy. Define Your Empire.</p></div>
<div class="service-card-simple" onclick="showView('services')"><div class="arrow">↗</div><h3>Website Design & Dev</h3><p>Your Digital Headquarters. Built for Conversion.</p></div>
<div class="service-card-simple" onclick="showView('services')"><div class="arrow">↗</div><h3>Social Media & Ads</h3><p>Command Attention. Drive Engagement.</p></div>
<div class="service-card-simple" onclick="showView('services')"><div class="arrow">↗</div><h3>Motion & Video</h3><p>Bring Your Story to Life. Dynamically.</p></div>
</div>
</div>
</section>
<section class="section dark" style="border-top: 1px solid rgba(255,255,255,0.1);">
<div class="roots-section">
<div class="roots-left">
<div class="label">Our Roots</div>
<h2>BUILT IN<br><span class="red">DETROIT.</span></h2>
<p>We don't just work here. We are part of the fabric of this city. The grit, the hustle, the innovation—it's in our DNA and in every pixel we push.</p>
</div>
<div class="roots-right"><div class="area-code">313</div></div>
</div>
</section>
<section class="section dark results-section">
<div class="label" style="text-align: center; justify-content: center; margin-bottom: 40px;">The Results Speak</div>
<div class="stats-boxes">
<div class="stat-box">
<div class="stat-number">50+</div>
<div class="stat-label">Brands Elevated</div>
</div>
<div class="stat-box">
<div class="stat-number">$2M+</div>
<div class="stat-label">Revenue Generated</div>
</div>
<div class="stat-box">
<div class="stat-number">100%</div>
<div class="stat-label">Client Satisfaction</div>
</div>
<div class="stat-box">
<div class="stat-number">48hr</div>
<div class="stat-label">Avg Response Time</div>
</div>
</div>
</section>
<section style="padding: 60px 0; background: #080808; border-top: 1px solid rgba(255,255,255,0.06); border-bottom: 1px solid rgba(255,255,255,0.06);">
<div class="label" style="justify-content: center; margin-bottom: 32px;">Industries We Serve</div>
<div style="overflow: hidden; position: relative;">
<div style="display: flex; gap: 48px; animation: industriesScroll 25s linear infinite; white-space: nowrap;">
<span style="font-size: 18px; font-weight: 600; color: rgba(255,255,255,0.5);">RESTAURANTS</span>
<span style="color: var(--red);">◆</span>
<span style="font-size: 18px; font-weight: 600; color: rgba(255,255,255,0.5);">REAL ESTATE</span>
<span style="color: var(--red);">◆</span>
<span style="font-size: 18px; font-weight: 600; color: rgba(255,255,255,0.5);">FITNESS & WELLNESS</span>
<span style="color: var(--red);">◆</span>
<span style="font-size: 18px; font-weight: 600; color: rgba(255,255,255,0.5);">E-COMMERCE</span>
<span style="color: var(--red);">◆</span>
<span style="font-size: 18px; font-weight: 600; color: rgba(255,255,255,0.5);">PROFESSIONAL SERVICES</span>
<span style="color: var(--red);">◆</span>
<span style="font-size: 18px; font-weight: 600; color: rgba(255,255,255,0.5);">COACHES & CONSULTANTS</span>
<span style="color: var(--red);">◆</span>
<span style="font-size: 18px; font-weight: 600; color: rgba(255,255,255,0.5);">HEALTHCARE</span>
<span style="color: var(--red);">◆</span>
<span style="font-size: 18px; font-weight: 600; color: rgba(255,255,255,0.5);">BEAUTY & SALONS</span>
<span style="color: var(--red);">◆</span>
<span style="font-size: 18px; font-weight: 600; color: rgba(255,255,255,0.5);">RESTAURANTS</span>
<span style="color: var(--red);">◆</span>
<span style="font-size: 18px; font-weight: 600; color: rgba(255,255,255,0.5);">REAL ESTATE</span>
<span style="color: var(--red);">◆</span>
<span style="font-size: 18px; font-weight: 600; color: rgba(255,255,255,0.5);">FITNESS & WELLNESS</span>
<span style="color: var(--red);">◆</span>
<span style="font-size: 18px; font-weight: 600; color: rgba(255,255,255,0.5);">E-COMMERCE</span>
<span style="color: var(--red);">◆</span>
<span style="font-size: 18px; font-weight: 600; color: rgba(255,255,255,0.5);">PROFESSIONAL SERVICES</span>
<span style="color: var(--red);">◆</span>
<span style="font-size: 18px; font-weight: 600; color: rgba(255,255,255,0.5);">COACHES & CONSULTANTS</span>
<span style="color: var(--red);">◆</span>
<span style="font-size: 18px; font-weight: 600; color: rgba(255,255,255,0.5);">HEALTHCARE</span>
<span style="color: var(--red);">◆</span>
<span style="font-size: 18px; font-weight: 600; color: rgba(255,255,255,0.5);">BEAUTY & SALONS</span>
<span style="color: var(--red);">◆</span>
</div>
</div>
</section>
<section class="section dark brands-elevated-section">
<div class="section-header">
<div class="label" style="justify-content: center;">Case Studies</div>
<h2 class="section-title">BRANDS WE'VE <span class="red">ELEVATED</span></h2>
<p class="section-subtitle">Real results for real businesses. Click to explore each success story.</p>
</div>
<div class="case-study-grid" id="homepageCaseStudies"></div>
<div style="text-align: center; margin-top: 48px;">
<button class="btn-cta" onclick="showView('portfolio')">View All Case Studies →</button>
</div>
</section>
<section class="section dark">
<div class="section-header">
<h2 class="section-title">WHY <span class="red">US?</span></h2>
<p class="section-subtitle">We're not for everyone. We're for the ones who want to win.</p>
</div>
<div class="why-grid">
<div class="why-card"><div class="icon">★</div><h3>Detroit-Rooted Creativity</h3><p>We bring the bold, unapologetic energy of Detroit to every project.</p></div>
<div class="why-card"><div class="icon">$</div><h3>Revenue-Focused Design</h3><p>Beautiful brands that actually drive business results and conversions.</p></div>
<div class="why-card"><div class="icon">♥</div><h3>Elite but Approachable</h3><p>Premium quality without the corporate stuffiness or agency BS.</p></div>
</div>
</section>
<section class="section dark">
<div class="section-header">
<div style="display: inline-block; background: var(--red); padding: 16px 48px; border-radius: 4px; margin-bottom: 16px;">
<h2 class="section-title" style="color: #fff; margin: 0; font-size: clamp(32px, 6vw, 56px);">STREET CRED</h2>
</div>
</div>
<div class="testimonials-grid" style="grid-template-columns: repeat(4, 1fr);">
<div class="testimonial-card"><div class="stars">★★★★★</div><p>"I would recommend working with New Urban Influence. My experience with Faren was great...even when I was being a difficult customer. The care and attention that was put into making sure they understood my vision for my brand was amazing."</p><div class="author"><div class="avatar" style="background: linear-gradient(135deg, var(--red), #ff6b5b);"></div><div><div class="author-name">Miss B</div><div class="author-title">Local Guide • Google Review</div></div></div></div>
<div class="testimonial-card"><div class="stars">★★★★★</div><p>"Farren did a great job on a few flyers for me. Prices were reasonable and the quality was superb. My go to company for all my promotional needs. The best at what he does!"</p><div class="author"><div class="avatar" style="background: linear-gradient(135deg, var(--red), #ff6b5b);"></div><div><div class="author-name">Chevelles Bar</div><div class="author-title">Local Guide • Google Review</div></div></div></div>
<div class="testimonial-card"><div class="stars">★★★★★</div><p>"The best graphic designing company in the world! I've been a customer for over 10 years and every time they exceed my expectations! Faren and his team has always been very professional and prompt with all my services! I highly recommend this company!"</p><div class="author"><div class="avatar" style="background: linear-gradient(135deg, var(--red), #ff6b5b);"></div><div><div class="author-name">Sierra Meriwether</div><div class="author-title">10+ Year Client • Google Review</div></div></div></div>
<div class="testimonial-card"><div class="stars">★★★★★</div><p>"Great experience. Urban Influence gives you personal/detailed attention (making you feel like you are their most important customer). Love not only the services they offer but the personal touch they provide."</p><div class="author"><div class="avatar" style="background: linear-gradient(135deg, var(--red), #ff6b5b);"></div><div><div class="author-name">Larry Castleberry</div><div class="author-title">Google Review</div></div></div></div>
</div>
</section>
<section style="padding: 60px 0; background: #000; border-top: 1px solid rgba(255,255,255,0.06); border-bottom: 1px solid rgba(255,255,255,0.06); overflow: hidden;">
<div style="text-align: center; margin-bottom: 40px;">
<h3 style="font-size: 14px; text-transform: uppercase; letter-spacing: 3px; color: rgba(255,255,255,0.4); font-weight: 600;">AS SEEN ON</h3>
</div>
<div style="display: flex; animation: logoScroll 40s linear infinite; width: max-content; will-change: transform;">
<div style="display: flex; align-items: center; gap: 64px; padding: 0 32px;">
<a href="https://share.google/0zJCv7QH0SXk4sY7X" rel="noopener noreferrer" target="_blank" style="opacity: 0.5; transition: opacity 0.3s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'"><svg height="28" viewBox="0 0 272 92" fill="white"><path d="M115.75 47.18c0 12.77-9.99 22.18-22.25 22.18s-22.25-9.41-22.25-22.18C71.25 34.32 81.24 25 93.5 25s22.25 9.32 22.25 22.18zm-9.74 0c0-7.98-5.79-13.44-12.51-13.44S80.99 39.2 80.99 47.18c0 7.9 5.79 13.44 12.51 13.44s12.51-5.55 12.51-13.44z"/><path d="M163.75 47.18c0 12.77-9.99 22.18-22.25 22.18s-22.25-9.41-22.25-22.18c0-12.85 9.99-22.18 22.25-22.18s22.25 9.32 22.25 22.18zm-9.74 0c0-7.98-5.79-13.44-12.51-13.44s-12.51 5.46-12.51 13.44c0 7.9 5.79 13.44 12.51 13.44s12.51-5.55 12.51-13.44z"/><path d="M209.75 26.34v39.82c0 16.38-9.66 23.07-21.08 23.07-10.75 0-17.22-7.19-19.66-13.07l8.48-3.53c1.51 3.61 5.21 7.87 11.17 7.87 7.31 0 11.84-4.51 11.84-13v-3.19h-.34c-2.18 2.69-6.38 5.04-11.68 5.04-11.09 0-21.25-9.66-21.25-22.09 0-12.52 10.16-22.26 21.25-22.26 5.29 0 9.49 2.35 11.68 4.96h.34v-3.61h9.25zm-8.56 20.92c0-7.81-5.21-13.52-11.84-13.52-6.72 0-12.35 5.71-12.35 13.52 0 7.73 5.63 13.36 12.35 13.36 6.63 0 11.84-5.63 11.84-13.36z"/><path d="M225 3v65h-9.5V3h9.5z"/><path d="M262.02 54.48l7.56 5.04c-2.44 3.61-8.32 9.83-18.48 9.83-12.6 0-22.01-9.74-22.01-22.18 0-13.19 9.49-22.18 20.92-22.18 11.51 0 17.14 9.16 18.98 14.11l1.01 2.52-29.65 12.28c2.27 4.45 5.8 6.72 10.75 6.72 4.96 0 8.4-2.44 10.92-6.14zm-23.27-7.98l19.82-8.23c-1.09-2.77-4.37-4.7-8.23-4.7-4.95 0-11.84 4.37-11.59 12.93z"/><path d="M35.29 41.41V32H67c.31 1.64.47 3.58.47 5.68 0 7.06-1.93 15.79-8.15 22.01-6.05 6.3-13.78 9.66-24.02 9.66C16.32 69.35.36 53.89.36 34.91.36 15.93 16.32.47 35.3.47c10.5 0 17.98 4.12 23.6 9.49l-6.64 6.64c-4.03-3.78-9.49-6.72-16.97-6.72-13.86 0-24.7 11.17-24.7 25.03 0 13.86 10.84 25.03 24.7 25.03 8.99 0 14.11-3.61 17.39-6.89 2.66-2.66 4.41-6.46 5.1-11.65l-22.49.01z"/></svg></a>
<a href="https://www.yelp.com/biz/new-urban-influence-detroit" rel="noopener noreferrer" target="_blank" style="opacity: 0.5; transition: opacity 0.3s; font-size: 22px; font-weight: 800; color: white; text-decoration: none;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'">Yelp</a>
<a href="https://www.dandb.com/businessdirectory/newurbaninfluence-detroit-mi" rel="noopener noreferrer" target="_blank" style="opacity: 0.5; transition: opacity 0.3s; font-size: 20px; font-weight: 800; color: white; text-decoration: none;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'">Dun & Bradstreet</a>
<a href="https://clutch.co/profile/new-urban-influence" rel="noopener noreferrer" target="_blank" style="opacity: 0.5; transition: opacity 0.3s; font-size: 22px; font-weight: 800; color: white; text-decoration: none;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'">Clutch</a>
<a href="https://businessconnect.apple.com" target="_blank" style="opacity: 0.5; transition: opacity 0.3s; font-size: 18px; font-weight: 700; color: white; text-decoration: none; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'"><svg height="20" viewBox="0 0 814 1000" fill="white"><path d="M788.1 340.9c-5.8 4.5-108.2 62.2-108.2 190.5 0 148.4 130.3 200.9 134.2 202.2-.6 3.2-20.7 71.9-68.7 141.9-42.8 61.6-87.5 123.1-155.5 123.1s-85.5-39.5-164-39.5c-76.5 0-103.7 40.8-165.9 40.8s-105.6-57-155.5-127C46.7 781.5 0 643.9 0 453.8c0-243.2 158.1-372.2 313.9-372.2 62.9 0 115.3 41.3 154.9 41.3 37.7 0 96.5-43.9 168.3-43.9 27.1 0 124.5 2.5 188.9 95.9zm-237.5-173c31.3-37.5 53.9-89.6 53.9-141.9 0-7.2-.6-14.5-1.9-20.4-51.4 1.9-112.2 34.3-148.9 77.4-28.9 33-57 85.2-57 138.1 0 7.9 1.3 15.8 1.9 18.3 3.2.6 8.4 1.3 13.5 1.3 46.1 0 103.7-30.8 138.5-72.8z"/></svg>Business Connect</a>
<a href="https://www.instagram.com/newurbaninfluence/" target="_blank" style="opacity: 0.5; transition: opacity 0.3s; font-size: 20px; font-weight: 700; color: white; text-decoration: none;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'">Instagram</a>
<a href="https://www.scottmax.com/company/new-urban-influence" target="_blank" style="opacity: 0.5; transition: opacity 0.3s; font-size: 18px; font-weight: 700; color: white; text-decoration: none;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'">ScottMax</a>
<a href="https://www.manta.com/c/m1x03t9/new-urban-influence" target="_blank" style="opacity: 0.5; transition: opacity 0.3s; font-size: 20px; font-weight: 800; color: white; text-decoration: none;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'">Manta</a>
<a href="https://detroitdesignfestival.com" target="_blank" style="opacity: 0.5; transition: opacity 0.3s; font-size: 16px; font-weight: 700; color: white; text-decoration: none; text-transform: uppercase; letter-spacing: 1px;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'">Detroit Design Festival</a>
<a href="https://techtowndetroit.org" target="_blank" style="opacity: 0.5; transition: opacity 0.3s; font-size: 18px; font-weight: 800; color: white; text-decoration: none;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'">TechTown Detroit</a>
<a href="https://autorama.com" target="_blank" style="opacity: 0.5; transition: opacity 0.3s; font-size: 16px; font-weight: 700; color: white; text-decoration: none; text-transform: uppercase; letter-spacing: 1px;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'">Detroit Autorama</a>
</div>
<div style="display: flex; align-items: center; gap: 64px; padding: 0 32px;">
<a href="https://share.google/0zJCv7QH0SXk4sY7X" rel="noopener noreferrer" target="_blank" style="opacity: 0.5; transition: opacity 0.3s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'"><svg height="28" viewBox="0 0 272 92" fill="white"><path d="M115.75 47.18c0 12.77-9.99 22.18-22.25 22.18s-22.25-9.41-22.25-22.18C71.25 34.32 81.24 25 93.5 25s22.25 9.32 22.25 22.18zm-9.74 0c0-7.98-5.79-13.44-12.51-13.44S80.99 39.2 80.99 47.18c0 7.9 5.79 13.44 12.51 13.44s12.51-5.55 12.51-13.44z"/><path d="M163.75 47.18c0 12.77-9.99 22.18-22.25 22.18s-22.25-9.41-22.25-22.18c0-12.85 9.99-22.18 22.25-22.18s22.25 9.32 22.25 22.18zm-9.74 0c0-7.98-5.79-13.44-12.51-13.44s-12.51 5.46-12.51 13.44c0 7.9 5.79 13.44 12.51 13.44s12.51-5.55 12.51-13.44z"/><path d="M209.75 26.34v39.82c0 16.38-9.66 23.07-21.08 23.07-10.75 0-17.22-7.19-19.66-13.07l8.48-3.53c1.51 3.61 5.21 7.87 11.17 7.87 7.31 0 11.84-4.51 11.84-13v-3.19h-.34c-2.18 2.69-6.38 5.04-11.68 5.04-11.09 0-21.25-9.66-21.25-22.09 0-12.52 10.16-22.26 21.25-22.26 5.29 0 9.49 2.35 11.68 4.96h.34v-3.61h9.25zm-8.56 20.92c0-7.81-5.21-13.52-11.84-13.52-6.72 0-12.35 5.71-12.35 13.52 0 7.73 5.63 13.36 12.35 13.36 6.63 0 11.84-5.63 11.84-13.36z"/><path d="M225 3v65h-9.5V3h9.5z"/><path d="M262.02 54.48l7.56 5.04c-2.44 3.61-8.32 9.83-18.48 9.83-12.6 0-22.01-9.74-22.01-22.18 0-13.19 9.49-22.18 20.92-22.18 11.51 0 17.14 9.16 18.98 14.11l1.01 2.52-29.65 12.28c2.27 4.45 5.8 6.72 10.75 6.72 4.96 0 8.4-2.44 10.92-6.14zm-23.27-7.98l19.82-8.23c-1.09-2.77-4.37-4.7-8.23-4.7-4.95 0-11.84 4.37-11.59 12.93z"/><path d="M35.29 41.41V32H67c.31 1.64.47 3.58.47 5.68 0 7.06-1.93 15.79-8.15 22.01-6.05 6.3-13.78 9.66-24.02 9.66C16.32 69.35.36 53.89.36 34.91.36 15.93 16.32.47 35.3.47c10.5 0 17.98 4.12 23.6 9.49l-6.64 6.64c-4.03-3.78-9.49-6.72-16.97-6.72-13.86 0-24.7 11.17-24.7 25.03 0 13.86 10.84 25.03 24.7 25.03 8.99 0 14.11-3.61 17.39-6.89 2.66-2.66 4.41-6.46 5.1-11.65l-22.49.01z"/></svg></a>
<a href="https://www.yelp.com/biz/new-urban-influence-detroit" rel="noopener noreferrer" target="_blank" style="opacity: 0.5; transition: opacity 0.3s; font-size: 22px; font-weight: 800; color: white; text-decoration: none;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'">Yelp</a>
<a href="https://www.dandb.com/businessdirectory/newurbaninfluence-detroit-mi" rel="noopener noreferrer" target="_blank" style="opacity: 0.5; transition: opacity 0.3s; font-size: 20px; font-weight: 800; color: white; text-decoration: none;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'">Dun & Bradstreet</a>
<a href="https://clutch.co/profile/new-urban-influence" rel="noopener noreferrer" target="_blank" style="opacity: 0.5; transition: opacity 0.3s; font-size: 22px; font-weight: 800; color: white; text-decoration: none;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'">Clutch</a>
<a href="https://businessconnect.apple.com" target="_blank" style="opacity: 0.5; transition: opacity 0.3s; font-size: 18px; font-weight: 700; color: white; text-decoration: none; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'"><svg height="20" viewBox="0 0 814 1000" fill="white"><path d="M788.1 340.9c-5.8 4.5-108.2 62.2-108.2 190.5 0 148.4 130.3 200.9 134.2 202.2-.6 3.2-20.7 71.9-68.7 141.9-42.8 61.6-87.5 123.1-155.5 123.1s-85.5-39.5-164-39.5c-76.5 0-103.7 40.8-165.9 40.8s-105.6-57-155.5-127C46.7 781.5 0 643.9 0 453.8c0-243.2 158.1-372.2 313.9-372.2 62.9 0 115.3 41.3 154.9 41.3 37.7 0 96.5-43.9 168.3-43.9 27.1 0 124.5 2.5 188.9 95.9zm-237.5-173c31.3-37.5 53.9-89.6 53.9-141.9 0-7.2-.6-14.5-1.9-20.4-51.4 1.9-112.2 34.3-148.9 77.4-28.9 33-57 85.2-57 138.1 0 7.9 1.3 15.8 1.9 18.3 3.2.6 8.4 1.3 13.5 1.3 46.1 0 103.7-30.8 138.5-72.8z"/></svg>Business Connect</a>
<a href="https://www.instagram.com/newurbaninfluence/" target="_blank" style="opacity: 0.5; transition: opacity 0.3s; font-size: 20px; font-weight: 700; color: white; text-decoration: none;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'">Instagram</a>
<a href="https://www.scottmax.com/company/new-urban-influence" target="_blank" style="opacity: 0.5; transition: opacity 0.3s; font-size: 18px; font-weight: 700; color: white; text-decoration: none;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'">ScottMax</a>
<a href="https://www.manta.com/c/m1x03t9/new-urban-influence" target="_blank" style="opacity: 0.5; transition: opacity 0.3s; font-size: 20px; font-weight: 800; color: white; text-decoration: none;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'">Manta</a>
<a href="https://detroitdesignfestival.com" target="_blank" style="opacity: 0.5; transition: opacity 0.3s; font-size: 16px; font-weight: 700; color: white; text-decoration: none; text-transform: uppercase; letter-spacing: 1px;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'">Detroit Design Festival</a>
<a href="https://techtowndetroit.org" target="_blank" style="opacity: 0.5; transition: opacity 0.3s; font-size: 18px; font-weight: 800; color: white; text-decoration: none;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'">TechTown Detroit</a>
<a href="https://autorama.com" target="_blank" style="opacity: 0.5; transition: opacity 0.3s; font-size: 16px; font-weight: 700; color: white; text-decoration: none; text-transform: uppercase; letter-spacing: 1px;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'">Detroit Autorama</a>
</div>
</div>
</section>
<!-- ==================== FAQ SECTION (Visible for Google Crawlers + Users) ==================== -->
<section class="section dark" id="faq"  style="padding: 80px 0; background: #0a0a0a; border-top: 1px solid rgba(255,255,255,0.06);">
<div style="max-width: 800px; margin: 0 auto; padding: 0 24px;">
<div style="text-align: center; margin-bottom: 48px;">
<p style="font-size: 13px; text-transform: uppercase; letter-spacing: 3px; color: var(--red); font-weight: 600; margin-bottom: 12px;">GOT QUESTIONS?</p>
<h2 style="font-size: clamp(32px, 5vw, 48px); font-weight: 800; color: #fff; margin: 0; line-height: 1.1;">FREQUENTLY <span style="color: var(--red);">ASKED</span></h2>
<p style="color: rgba(255,255,255,0.5); margin-top: 16px; font-size: 15px;">Everything you need to know about working with Detroit's top-rated branding agency.</p>
</div>

<div itemscope itemtype="https://schema.org/Question" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; margin-bottom: 8px; overflow: hidden;">
<button onclick="this.parentElement.classList.toggle('faq-open'); this.querySelector('.faq-icon').textContent = this.parentElement.classList.contains('faq-open') ? '−' : '+';" style="width: 100%; padding: 20px 24px; background: none; border: none; color: #fff; font-size: 15px; font-weight: 600; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-family: inherit;">
<span>What is New Urban Influence?</span>
<span class="faq-icon" style="color: #e11d48; font-size: 20px; margin-left: 16px;">+</span>
</button>
<div itemscope itemtype="https://schema.org/Answer" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease; padding: 0 24px;">
<div style="padding: 0 0 20px 0; color: #aaa; font-size: 14px; line-height: 1.7;">New Urban Influence (NUI) is a Detroit-based creative agency specializing in brand identity design, web design, and digital marketing. Founded to help small businesses and startups build professional, competitive brands, NUI offers full branding packages starting at $1,500 including logo design, color systems, typography, social media templates, and brand guidelines. They serve clients throughout Detroit, Southeast Michigan, and nationwide.</div>
</div>
</div>

<div itemscope itemtype="https://schema.org/Question" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; margin-bottom: 8px; overflow: hidden;">
<button onclick="this.parentElement.classList.toggle('faq-open'); this.querySelector('.faq-icon').textContent = this.parentElement.classList.contains('faq-open') ? '−' : '+';" style="width: 100%; padding: 20px 24px; background: none; border: none; color: #fff; font-size: 15px; font-weight: 600; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-family: inherit;">
<span>What services does New Urban Influence offer?</span>
<span class="faq-icon" style="color: #e11d48; font-size: 20px; margin-left: 16px;">+</span>
</button>
<div itemscope itemtype="https://schema.org/Answer" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease; padding: 0 24px;">
<div style="padding: 0 0 20px 0; color: #aaa; font-size: 14px; line-height: 1.7;">New Urban Influence offers three main branding packages: Brand Kit ($1,500 flat rate) for startups and new businesses, Service Business Brand Identity ($3,500+) for consultants, agencies, and service providers, and Product Brand Identity ($4,500+) for businesses selling physical products. Additional services include logo design ($500), business card design ($150), social media templates ($300), print design and printing (banners, yard signs, business cards, vehicle magnets, postcards, acrylic signs, Dibond panels), packaging design ($600/SKU), and brand guidelines documentation ($400).</div>
</div>
</div>

<div itemscope itemtype="https://schema.org/Question" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; margin-bottom: 8px; overflow: hidden;">
<button onclick="this.parentElement.classList.toggle('faq-open'); this.querySelector('.faq-icon').textContent = this.parentElement.classList.contains('faq-open') ? '−' : '+';" style="width: 100%; padding: 20px 24px; background: none; border: none; color: #fff; font-size: 15px; font-weight: 600; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-family: inherit;">
<span>How much does branding cost in Detroit?</span>
<span class="faq-icon" style="color: #e11d48; font-size: 20px; margin-left: 16px;">+</span>
</button>
<div itemscope itemtype="https://schema.org/Answer" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease; padding: 0 24px;">
<div style="padding: 0 0 20px 0; color: #aaa; font-size: 14px; line-height: 1.7;">In Detroit, professional branding packages at New Urban Influence range from $1,500 to $6,000+. The Brand Kit starts at $1,500 (logo, colors, typography, social templates), Service Business Brand Identity starts at $3,500, and Product Brand Identity starts at $4,500. Individual services like logo design start at $500. Payment plans are available including pay-in-full (5% discount), 50/25/25 split, or 3 monthly payments.</div>
</div>
</div>

<div itemscope itemtype="https://schema.org/Question" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; margin-bottom: 8px; overflow: hidden;">
<button onclick="this.parentElement.classList.toggle('faq-open'); this.querySelector('.faq-icon').textContent = this.parentElement.classList.contains('faq-open') ? '−' : '+';" style="width: 100%; padding: 20px 24px; background: none; border: none; color: #fff; font-size: 15px; font-weight: 600; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-family: inherit;">
<span>How much does a logo design cost?</span>
<span class="faq-icon" style="color: #e11d48; font-size: 20px; margin-left: 16px;">+</span>
</button>
<div itemscope itemtype="https://schema.org/Answer" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease; padding: 0 24px;">
<div style="padding: 0 0 20px 0; color: #aaa; font-size: 14px; line-height: 1.7;">At New Urban Influence, standalone logo design starts at $500 and includes a primary logo, secondary logo variation, icon/mark version, and all file formats (PNG, SVG, PDF). For a complete brand identity that includes the logo plus color palette, typography, social media templates, and brand guidelines, packages start at $1,500.</div>
</div>
</div>

<div itemscope itemtype="https://schema.org/Question" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; margin-bottom: 8px; overflow: hidden;">
<button onclick="this.parentElement.classList.toggle('faq-open'); this.querySelector('.faq-icon').textContent = this.parentElement.classList.contains('faq-open') ? '−' : '+';" style="width: 100%; padding: 20px 24px; background: none; border: none; color: #fff; font-size: 15px; font-weight: 600; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-family: inherit;">
<span>How long does a branding project take?</span>
<span class="faq-icon" style="color: #e11d48; font-size: 20px; margin-left: 16px;">+</span>
</button>
<div itemscope itemtype="https://schema.org/Answer" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease; padding: 0 24px;">
<div style="padding: 0 0 20px 0; color: #aaa; font-size: 14px; line-height: 1.7;">At New Urban Influence, most branding projects take 2 to 4 weeks depending on complexity. The Brand Kit (starter package) typically completes in 7-10 business days, while comprehensive Service and Product Brand Identity packages take 10-21 business days. Rush delivery is available for an additional fee. Every project follows a structured process: discovery call, strategy, initial concepts, revisions, and final delivery with all files and brand guidelines.</div>
</div>
</div>

<div itemscope itemtype="https://schema.org/Question" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; margin-bottom: 8px; overflow: hidden;">
<button onclick="this.parentElement.classList.toggle('faq-open'); this.querySelector('.faq-icon').textContent = this.parentElement.classList.contains('faq-open') ? '−' : '+';" style="width: 100%; padding: 20px 24px; background: none; border: none; color: #fff; font-size: 15px; font-weight: 600; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-family: inherit;">
<span>Do you offer free consultations?</span>
<span class="faq-icon" style="color: #e11d48; font-size: 20px; margin-left: 16px;">+</span>
</button>
<div itemscope itemtype="https://schema.org/Answer" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease; padding: 0 24px;">
<div style="padding: 0 0 20px 0; color: #aaa; font-size: 14px; line-height: 1.7;">Yes, New Urban Influence offers free strategy consultations for every potential client. During the call, they discuss your business goals, target audience, competitive landscape, and branding needs. You'll receive a custom pricing estimate after the consultation with no obligation to proceed. You can book directly through the website at newurbaninfluence.com.</div>
</div>
</div>

<div itemscope itemtype="https://schema.org/Question" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; margin-bottom: 8px; overflow: hidden;">
<button onclick="this.parentElement.classList.toggle('faq-open'); this.querySelector('.faq-icon').textContent = this.parentElement.classList.contains('faq-open') ? '−' : '+';" style="width: 100%; padding: 20px 24px; background: none; border: none; color: #fff; font-size: 15px; font-weight: 600; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-family: inherit;">
<span>What is the best branding agency in Detroit?</span>
<span class="faq-icon" style="color: #e11d48; font-size: 20px; margin-left: 16px;">+</span>
</button>
<div itemscope itemtype="https://schema.org/Answer" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease; padding: 0 24px;">
<div style="padding: 0 0 20px 0; color: #aaa; font-size: 14px; line-height: 1.7;">New Urban Influence is one of Detroit's top-rated creative agencies with a 4.9-star rating across 28+ reviews. They specialize in helping small businesses and startups build professional brand identities at accessible price points starting at $1,500. What sets them apart is their strategic approach to branding, transparent flat-rate pricing, payment plans, and a dedicated client portal for real-time project tracking.</div>
</div>
</div>

<div itemscope itemtype="https://schema.org/Question" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; margin-bottom: 8px; overflow: hidden;">
<button onclick="this.parentElement.classList.toggle('faq-open'); this.querySelector('.faq-icon').textContent = this.parentElement.classList.contains('faq-open') ? '−' : '+';" style="width: 100%; padding: 20px 24px; background: none; border: none; color: #fff; font-size: 15px; font-weight: 600; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-family: inherit;">
<span>What payment options are available?</span>
<span class="faq-icon" style="color: #e11d48; font-size: 20px; margin-left: 16px;">+</span>
</button>
<div itemscope itemtype="https://schema.org/Answer" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease; padding: 0 24px;">
<div style="padding: 0 0 20px 0; color: #aaa; font-size: 14px; line-height: 1.7;">New Urban Influence offers flexible payment options for all branding packages: pay in full and receive a 5% discount, split payments 50/25/25, or choose 3 monthly installments. They accept credit cards, debit cards, and bank transfers. No one should have to delay building their brand because of budget — payment plans make professional branding accessible.</div>
</div>
</div>

<div itemscope itemtype="https://schema.org/Question" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; margin-bottom: 8px; overflow: hidden;">
<button onclick="this.parentElement.classList.toggle('faq-open'); this.querySelector('.faq-icon').textContent = this.parentElement.classList.contains('faq-open') ? '\u2212' : '+';" style="width: 100%; padding: 20px 24px; background: none; border: none; color: #fff; font-size: 15px; font-weight: 600; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-family: inherit;">
<span>Do you work with businesses outside Detroit?</span>
<span class="faq-icon" style="color: #e11d48; font-size: 20px; margin-left: 16px;">+</span>
</button>
<div itemscope itemtype="https://schema.org/Answer" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease; padding: 0 24px;">
<div style="padding: 0 0 20px 0; color: #aaa; font-size: 14px; line-height: 1.7;">Yes! While New Urban Influence is based in Detroit, they serve clients nationwide. Most of the branding process is handled remotely through their online client portal, video consultations, and digital proof approvals. They work with businesses in Ann Arbor, Southfield, Troy, Royal Oak, and across Michigan, as well as clients in other states. Local clients can also meet in person for strategy sessions.</div>
</div>
</div>

<div itemscope itemtype="https://schema.org/Question" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; margin-bottom: 8px; overflow: hidden;">
<button onclick="this.parentElement.classList.toggle('faq-open'); this.querySelector('.faq-icon').textContent = this.parentElement.classList.contains('faq-open') ? '\u2212' : '+';" style="width: 100%; padding: 20px 24px; background: none; border: none; color: #fff; font-size: 15px; font-weight: 600; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-family: inherit;">
<span>What file formats will I receive for my logo and branding?</span>
<span class="faq-icon" style="color: #e11d48; font-size: 20px; margin-left: 16px;">+</span>
</button>
<div itemscope itemtype="https://schema.org/Answer" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease; padding: 0 24px;">
<div style="padding: 0 0 20px 0; color: #aaa; font-size: 14px; line-height: 1.7;">Every NUI branding package includes your logo and brand assets in all major file formats: PNG (transparent background), SVG (scalable vector), PDF (print-ready), and high-resolution JPG. You'll also receive a complete brand guidelines document, social media templates sized for Instagram, Facebook, TikTok, and LinkedIn, plus a brand asset folder organized for easy access.</div>
</div>
</div>

<div itemscope itemtype="https://schema.org/Question" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; margin-bottom: 8px; overflow: hidden;">
<button onclick="this.parentElement.classList.toggle('faq-open'); this.querySelector('.faq-icon').textContent = this.parentElement.classList.contains('faq-open') ? '\u2212' : '+';" style="width: 100%; padding: 20px 24px; background: none; border: none; color: #fff; font-size: 15px; font-weight: 600; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-family: inherit;">
<span>Can I see examples of your branding work?</span>
<span class="faq-icon" style="color: #e11d48; font-size: 20px; margin-left: 16px;">+</span>
</button>
<div itemscope itemtype="https://schema.org/Answer" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease; padding: 0 24px;">
<div style="padding: 0 0 20px 0; color: #aaa; font-size: 14px; line-height: 1.7;">Absolutely. Visit the NUI portfolio page to see completed branding projects across restaurants, coaching businesses, art brands, and more. Featured case studies include Good Cakes and Bakes, Detroit Canvas Co., Motor City Bistro, and Ascend Coaching Group. Each case study shows the before-and-after transformation along with results achieved.</div>
</div>
</div>

<div itemscope itemtype="https://schema.org/Question" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; margin-bottom: 8px; overflow: hidden;">
<button onclick="this.parentElement.classList.toggle('faq-open'); this.querySelector('.faq-icon').textContent = this.parentElement.classList.contains('faq-open') ? '\u2212' : '+';" style="width: 100%; padding: 20px 24px; background: none; border: none; color: #fff; font-size: 15px; font-weight: 600; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-family: inherit;">
<span>What industries does New Urban Influence specialize in?</span>
<span class="faq-icon" style="color: #e11d48; font-size: 20px; margin-left: 16px;">+</span>
</button>
<div itemscope itemtype="https://schema.org/Answer" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease; padding: 0 24px;">
<div style="padding: 0 0 20px 0; color: #aaa; font-size: 14px; line-height: 1.7;">New Urban Influence works with businesses across many industries, with particular strength in restaurants and food service, beauty and wellness, professional services, coaching and consulting, retail and e-commerce, cannabis brands, and creative businesses. They understand the unique branding needs of each industry and tailor their approach accordingly.</div>
</div>
</div>

<div itemscope itemtype="https://schema.org/Question" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; margin-bottom: 8px; overflow: hidden;">
<button onclick="this.parentElement.classList.toggle('faq-open'); this.querySelector('.faq-icon').textContent = this.parentElement.classList.contains('faq-open') ? '\u2212' : '+';" style="width: 100%; padding: 20px 24px; background: none; border: none; color: #fff; font-size: 15px; font-weight: 600; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-family: inherit;">
<span>How many logo concepts will I receive?</span>
<span class="faq-icon" style="color: #e11d48; font-size: 20px; margin-left: 16px;">+</span>
</button>
<div itemscope itemtype="https://schema.org/Answer" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease; padding: 0 24px;">
<div style="padding: 0 0 20px 0; color: #aaa; font-size: 14px; line-height: 1.7;">NUI provides 2-3 unique logo concepts during the initial design phase based on your brand strategy and discovery call insights. Each concept explores a different creative direction. After you select your preferred direction, they refine it through unlimited revisions until you're completely satisfied. The final logo includes primary, secondary, and icon variations.</div>
</div>
</div>

<div itemscope itemtype="https://schema.org/Question" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; margin-bottom: 8px; overflow: hidden;">
<button onclick="this.parentElement.classList.toggle('faq-open'); this.querySelector('.faq-icon').textContent = this.parentElement.classList.contains('faq-open') ? '\u2212' : '+';" style="width: 100%; padding: 20px 24px; background: none; border: none; color: #fff; font-size: 15px; font-weight: 600; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-family: inherit;">
<span>Do you offer web design services?</span>
<span class="faq-icon" style="color: #e11d48; font-size: 20px; margin-left: 16px;">+</span>
</button>
<div itemscope itemtype="https://schema.org/Answer" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease; padding: 0 24px;">
<div style="padding: 0 0 20px 0; color: #aaa; font-size: 14px; line-height: 1.7;">Yes, New Urban Influence offers custom web design starting at $3,500. Websites are built mobile-first, SEO-optimized, and designed to convert visitors into customers. Services include custom design, development, hosting setup, domain configuration, SSL security, and Google Analytics integration. They also offer website maintenance packages for ongoing support.</div>
</div>
</div>

<div itemscope itemtype="https://schema.org/Question" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; margin-bottom: 8px; overflow: hidden;">
<button onclick="this.parentElement.classList.toggle('faq-open'); this.querySelector('.faq-icon').textContent = this.parentElement.classList.contains('faq-open') ? '\u2212' : '+';" style="width: 100%; padding: 20px 24px; background: none; border: none; color: #fff; font-size: 15px; font-weight: 600; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-family: inherit;">
<span>How do I get started with New Urban Influence?</span>
<span class="faq-icon" style="color: #e11d48; font-size: 20px; margin-left: 16px;">+</span>
</button>
<div itemscope itemtype="https://schema.org/Answer" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease; padding: 0 24px;">
<div style="padding: 0 0 20px 0; color: #aaa; font-size: 14px; line-height: 1.7;">Getting started is simple: book a free strategy call through the website at newurbaninfluence.com or call (248) 487-8747. During the call, you'll discuss your business, goals, and branding needs. After the consultation, you'll receive a custom proposal with pricing. Once approved, NUI kicks off your project with a discovery questionnaire and brand strategy session within 48 hours.</div>
</div>
</div>

</div>
</section>

<section class="cta-section" id="contact">
<h2>READY TO<br>DOMINATE?</h2>
<p>Stop playing small. Let's build a brand that demands attention and drives real revenue.</p>
<button class="btn-white" onclick="showView('intake')">Book Your Strategy Call</button>
</section>
        ${getFooterHTML()}
    `;
    // Dynamically render homepage case studies from portfolio data
    const csGrid = document.getElementById('homepageCaseStudies');
    if (csGrid) { _refreshHomepageCaseStudies(csGrid); }

    const video = document.getElementById('heroVideo');
    if (video) { video.muted = true; video.play().catch(e => {}); }
}

// ==================== ABOUT VIEW ====================
function loadAboutView() {
    const teamHTML = aboutData.team.map((member, i) => `
<div class="team-card">
<div class="team-photo">
                ${member.photo ? `<img loading="lazy" src="${member.photo}" alt="${member.name}">` : 'Photo'}
</div>
<h3 class="team-name">${member.name}</h3>
<p class="team-title">${member.title}</p>
<p class="team-bio">${member.bio}</p>
</div>
    `).join('');

    document.getElementById('aboutView').innerHTML = `
<section class="about-hero"><div class="hero-content"><h2>About <span>Us</span></h2><p>We're a Detroit-rooted creative agency crafting bold brands and digital experiences for visionaries who refuse to blend in.</p></div></section>
<section class="section dark">
<div class="story-section">
<div class="story-content">
<div class="label">Our Story</div>
<h2>BORN IN THE <span class="red">D.</span><br>BUILT TO <span class="red">DOMINATE.</span></h2>
<p>New Urban Influence was founded with a simple mission: to bring the bold, unapologetic energy of Detroit to every brand we touch.</p>
<p>We believe that great design isn't just about looking good - it's about creating systems that drive real business results. Every pixel we push, every strategy we craft, is designed to help our clients dominate their markets.</p>
</div>
<div class="story-image" style="background: #080808; border: 1px solid rgba(255,255,255,0.06); border-radius: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center; color: rgba(255,255,255,0.15); font-size: 14px;">
                    ${aboutData.storyImage ? `<img loading="lazy" src="${aboutData.storyImage}" alt="Our Story" style="width: 100%; height: 100%; object-fit: cover;">` : 'Image'}
</div>
</div>
</section>
<section class="section dark"><div class="section-header"><h2 class="section-title">OUR <span class="red">VALUES</span></h2></div><div class="values-grid"><div class="value-card"><div class="number">01</div><h3>Bold Creativity</h3><p>We don't play it safe. Every project gets our full creative energy.</p></div><div class="value-card"><div class="number">02</div><h3>Results First</h3><p>Beautiful design that drives real business outcomes.</p></div><div class="value-card"><div class="number">03</div><h3>Detroit Grit</h3><p>The hustle and resilience of our city runs through everything.</p></div><div class="value-card"><div class="number">04</div><h3>Client Partners</h3><p>We're invested partners in your success and growth.</p></div></div></section>
<section class="section dark" style="border-top: 1px solid rgba(255,255,255,0.06);">
<div class="section-header">
<div class="label" style="justify-content: center;">The Crew</div>
<h2 class="section-title">MEET THE <span class="red">TEAM</span></h2>
<p class="section-subtitle">The creative minds behind New Urban Influence</p>
</div>
<div class="team-grid">
                ${teamHTML}
</div>
</section>
<section class="section" style="background: var(--red);"><div class="stats-grid"><div class="stat-item"><div class="value">50+</div><div class="stat-label">Brands Elevated</div></div><div class="stat-item"><div class="value">$2M+</div><div class="stat-label">Revenue Generated</div></div><div class="stat-item"><div class="value">100%</div><div class="stat-label">Detroit Pride</div></div><div class="stat-item"><div class="value">313</div><div class="stat-label">Area Code Strong</div></div></div></section>
<section class="cta-section"><h2>READY TO <span>WORK</span> WITH US?</h2><p>Let's build something legendary together.</p><button class="btn-white" onclick="scrollToContact()">Book Your Strategy Call</button></section>
        ${getFooterHTML()}
    `;
}

// ==================== SERVICES VIEW ====================
function loadServicesView() {
    document.getElementById('servicesView').innerHTML = `
<style>
            .package-section { padding: 0 0 80px 0; border-bottom: 1px solid rgba(255,255,255,0.06); transition: opacity 0.3s ease, transform 0.3s ease; }
            .package-image { position: relative; width: 100%; height: 300px; overflow: hidden; margin-bottom: 60px; }
            .package-image img { width: 100%; height: 100%; object-fit: cover; }
            .package-image::after { content: ''; position: absolute; inset: 0; background: linear-gradient(180deg, rgba(255,59,48,0.4) 0%, rgba(255,59,48,0.2) 50%, rgba(0,0,0,0.9) 100%); }
            .package-header { text-align: center; margin-bottom: 60px; }
            .package-label { font-size: 11px; color: var(--red); text-transform: uppercase; letter-spacing: 3px; font-weight: 700; margin-bottom: 16px; }
            .package-title { font-size: 42px; font-weight: 900; margin-bottom: 16px; }
            .package-subtitle { color: var(--gray); font-size: 16px; max-width: 600px; margin: 0 auto; }
            .package-price { font-size: 48px; font-weight: 900; color: var(--red); margin: 24px 0; }
            .package-price span { font-size: 18px; color: var(--gray); font-weight: 400; }

            .deliverables-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; max-width: 1200px; margin: 0 auto; }
            .deliverable-card { background: #080808; border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 32px; transition: all 0.3s; cursor: pointer; }
            .deliverable-card:hover { background: #fff; border-color: #fff; transform: translateY(-4px); box-shadow: 0 20px 40px rgba(255,255,255,0.1); }
            .deliverable-card:hover .deliverable-icon { color: var(--red); }
            .deliverable-card:hover .deliverable-title { color: #000; }
            .deliverable-card:hover .deliverable-desc { color: #333; }
            .deliverable-card:hover .deliverable-list li { color: #333; border-color: rgba(0,0,0,0.1); }
            .deliverable-card:hover .deliverable-list li::before { color: var(--red); }
            .deliverable-icon { font-size: 32px; margin-bottom: 20px; }
            .deliverable-title { font-size: 18px; font-weight: 800; margin-bottom: 12px; color: #fff; }
            .deliverable-desc { font-size: 13px; color: var(--gray); line-height: 1.6; margin-bottom: 20px; }
            .deliverable-list { list-style: none; padding: 0; margin: 0; }
            .deliverable-list li { font-size: 13px; color: rgba(255,255,255,0.7); padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.04); display: flex; align-items: center; gap: 10px; }
            .deliverable-list li:last-child { border-bottom: none; }
            .deliverable-list li::before { content: '✓'; color: var(--red); font-weight: 700; }

            .category-section { margin-bottom: 60px; }
            .category-header { display: flex; align-items: center; gap: 16px; margin-bottom: 32px; }
            .category-icon { width: 48px; height: 48px; background: rgba(255,59,48,0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
            .category-title { font-size: 24px; font-weight: 800; }
            .category-subtitle { font-size: 13px; color: var(--gray); margin-top: 4px; }

            .items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 16px; }
            .item-card { background: #080808; border: 1px solid rgba(255,255,255,0.06); border-radius: 8px; padding: 20px; transition: all 0.3s; cursor: pointer; }
            .item-card:hover { background: #fff; border-color: #fff; transform: translateY(-2px); box-shadow: 0 10px 30px rgba(255,255,255,0.1); }
            .item-card h4 { font-size: 14px; font-weight: 700; margin-bottom: 8px; transition: color 0.3s; }
            .item-card:hover h4 { color: #000; }
            .item-card p { font-size: 12px; color: var(--gray); line-height: 1.5; transition: color 0.3s; }
            .item-card:hover p { color: #333; }

            .package-cta { text-align: center; margin-top: 48px; }
            .btn-package { background: var(--red); color: #fff; border: none; padding: 18px 48px; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
            .btn-package:hover { background: #fff; color: #000; transform: scale(1.02); }

            .comparison-table { max-width: 1000px; margin: 60px auto; }
            .comparison-row { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 2px; margin-bottom: 2px; }
            .comparison-cell { background: #080808; padding: 16px 20px; font-size: 13px; }
            .comparison-cell.header { background: rgba(255,59,48,0.1); font-weight: 700; text-align: center; }
            .comparison-cell.feature { color: rgba(255,255,255,0.8); }
            .comparison-cell.check { text-align: center; color: var(--red); font-size: 18px; }
            .comparison-cell.empty { text-align: center; color: rgba(255,255,255,0.2); }

            /* SERVICES PAGE MOBILE RESPONSIVE */
            @media (max-width: 768px) {
                .package-section { padding: 0 0 60px 0; }
                .package-image { height: 180px; margin-bottom: 32px; }
                .package-header { margin-bottom: 40px; padding: 0 16px; }
                .package-title { font-size: 28px !important; }
                .package-subtitle { font-size: 14px; padding: 0 8px; }
                .package-price { font-size: 36px !important; margin: 16px 0; }
                .package-price span { font-size: 14px; }

                .deliverables-grid { grid-template-columns: 1fr !important; gap: 16px; padding: 0 16px; }
                .deliverable-card { padding: 24px 20px; border-radius: 12px; }
                .deliverable-icon { font-size: 28px; margin-bottom: 16px; }
                .deliverable-title { font-size: 16px; }
                .deliverable-desc { font-size: 13px; margin-bottom: 16px; }
                .deliverable-list li { font-size: 12px; padding: 6px 0; }

                .category-section { margin-bottom: 40px; padding: 0 16px; }
                .category-header { flex-direction: column; align-items: flex-start; gap: 12px; margin-bottom: 24px; }
                .category-icon { width: 40px; height: 40px; font-size: 20px; }
                .category-title { font-size: 20px; }

                .items-grid { grid-template-columns: 1fr !important; gap: 12px; }
                .item-card { padding: 16px; }
                .item-card h4 { font-size: 14px; }
                .item-card p { font-size: 11px; }

                .package-cta { margin-top: 32px; padding: 0 16px; }
                .btn-package { width: 100%; padding: 16px 24px; font-size: 13px; }

                .comparison-table { margin: 40px 16px; overflow-x: auto; }
                .comparison-row { grid-template-columns: 1.5fr 1fr 1fr 1fr; min-width: 500px; }
                .comparison-cell { padding: 12px 8px; font-size: 11px; }
            }

            @media (max-width: 480px) {
                .package-title { font-size: 24px !important; }
                .package-price { font-size: 32px !important; }
                .deliverable-card { padding: 20px 16px; }
                .deliverable-title { font-size: 15px; }
                .category-title { font-size: 18px; }
            }

            /* ── Problem Filter System ── */
            .svc-filter-bar { padding: 48px 24px 32px; max-width: 960px; margin: 0 auto; }
            .svc-filter-lbl { font-size: 13px; color: var(--red); text-transform: uppercase; letter-spacing: 3px; margin-bottom: 24px; font-family: var(--font-head); }
            .svc-problems { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
            @media(min-width:640px){ .svc-problems { grid-template-columns: repeat(4, 1fr); } }
            .svc-prob-card { background: #0d0d0d; border: 1px solid rgba(255,255,255,0.07); border-radius: 12px; padding: 20px 16px; cursor: pointer; transition: border-color .2s, transform .2s; text-align: left; }
            .svc-prob-card:hover, .svc-prob-card.active { border-color: var(--red); transform: translateY(-2px); }
            .prob-icon { font-size: 24px; margin-bottom: 10px; display: block; }
            .prob-q { font-size: 13px; font-weight: 700; color: #fff; line-height: 1.4; margin-bottom: 6px; font-family: var(--font-head); }
            .prob-sol { font-size: 11px; color: var(--gray); line-height: 1.5; }
            .prob-price { font-size: 11px; color: var(--red); margin-top: 8px; font-weight: 700; }
            .svc-back-btn { display: none; width: 100%; max-width: 960px; margin: 16px auto 0; padding: 14px 24px; background: transparent; border: 1px solid rgba(255,255,255,0.12); border-radius: 10px; color: rgba(255,255,255,0.6); font-size: 13px; cursor: pointer; transition: all .2s; text-align: left; }
            .svc-back-btn:hover { border-color: var(--red); color: #fff; }
            .svc-back-btn.visible { display: block; }
            .pkg-filtered-out { display: none !important; }
            .logo-only-card { background: #0a0a0a; border: 1px solid rgba(255,255,255,0.07); border-radius: 16px; padding: 40px 32px; max-width: 600px; margin: 0 auto 24px; }
            .lo-label { font-size: 11px; color: var(--red); text-transform: uppercase; letter-spacing: 3px; margin-bottom: 12px; }
            .logo-only-card h3 { font-size: 28px; font-family: var(--font-head); font-weight: 900; color: #fff; margin-bottom: 8px; }
            .lo-sub { font-size: 13px; color: var(--gray); margin-bottom: 24px; line-height: 1.6; }
            .logo-only-card ul { list-style: none; padding: 0; margin: 0 0 24px; }
            .logo-only-card ul li { font-size: 13px; color: rgba(255,255,255,0.75); padding: 7px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
            .logo-only-card ul li:before { content: "\2713  "; color: var(--red); }
            .lo-price-row { display: flex; align-items: baseline; gap: 8px; margin-bottom: 24px; }
            .lo-price { font-size: 42px; font-family: var(--font-head); font-weight: 900; color: #fff; }
            .lo-price-note { font-size: 12px; color: var(--gray); }
</style>

<section class="section dark" style="padding-top: 160px; text-align: center;">
<h2 class="section-title">SERVICE <span class="red">PACKAGES</span></h2>
<p class="section-subtitle">Comprehensive branding solutions designed for product-based and service-based businesses. Every deliverable comes with clear direction on how to use it.</p>
</section>

<!-- ── PROBLEM FILTER BAR ── -->
<div class="svc-filter-bar" id="svcFilterBar">
    <p class="svc-filter-lbl">What&rsquo;s your situation?</p>
    <div class="svc-problems">

        <button class="svc-prob-card" data-filter="new-business" onclick="filterServices('new-business')">
            <span class="prob-icon">🌱</span>
            <p class="prob-q">How do I get my business looking professional?</p>
            <p class="prob-sol">Start with a logo or full brand kit — everything you need to look legit from day one.</p>
            <p class="prob-price">From $750</p>
        </button>

        <button class="svc-prob-card" data-filter="established" onclick="filterServices('established')">
            <span class="prob-icon">🏪</span>
            <p class="prob-q">My brand looks outdated — how do I fix it?</p>
            <p class="prob-sol">Full brand identity rebuild. New look, real positioning, everything consistent.</p>
            <p class="prob-price">From $4,500</p>
        </button>

        <button class="svc-prob-card" data-filter="new-business,established" onclick="filterServices('new-business')">
            <span class="prob-icon">🌐</span>
            <p class="prob-q">How do I get more customers in Detroit?</p>
            <p class="prob-sol">Brand + website together. Shows up on Google, converts visitors, builds trust.</p>
            <p class="prob-price">From $3,500</p>
        </button>

        <button class="svc-prob-card" data-filter="established,digital" onclick="filterServices('established')">
            <span class="prob-icon">📈</span>
            <p class="prob-q">I need more leads — my marketing isn&rsquo;t working.</p>
            <p class="prob-sol">Sales funnel + email sequence + CRM. Built to capture and convert.</p>
            <p class="prob-price">From $1,500</p>
        </button>

        <button class="svc-prob-card" data-filter="established" onclick="filterServices('established')">
            <span class="prob-icon">📦</span>
            <p class="prob-q">How do I get my product on shelves or online?</p>
            <p class="prob-sol">Product brand identity with packaging design, labels, and retail-ready materials.</p>
            <p class="prob-price">From $5,500</p>
        </button>

        <button class="svc-prob-card" data-filter="digital" onclick="filterServices('digital')">
            <span class="prob-icon">📱</span>
            <p class="prob-q">I have an app idea — where do I start?</p>
            <p class="prob-sol">MVP to full app build. iOS + Android, auth, admin panel, 6&ndash;8 week delivery.</p>
            <p class="prob-price">From $12,000</p>
        </button>

        <button class="svc-prob-card" data-filter="print" onclick="filterServices('print')">
            <span class="prob-icon">🖨️</span>
            <p class="prob-q">Where can I get banners, signs, or business cards printed in Michigan?</p>
            <p class="prob-sol">Design + print handled together. $10 overnight shipping anywhere in Michigan.</p>
            <p class="prob-price">From $35</p>
        </button>

        <button class="svc-prob-card" data-filter="all" onclick="filterServices('all')" style="border-style:dashed;">
            <span class="prob-icon">🔍</span>
            <p class="prob-q">I&rsquo;m not sure — show me everything.</p>
            <p class="prob-sol">Browse all packages across branding, web, apps, marketing, and print.</p>
            <p class="prob-price">All packages</p>
        </button>

    </div>
</div>
<button class="svc-back-btn" id="svcBackBtn" onclick="filterServices('all')">&#8592; Show all packages</button>


        <!-- LOGO ONLY: $750 standalone entry product -->
        <section class="package-section" data-svc-filter="new-business" style="background: linear-gradient(180deg, #0a0a0a 0%, #050505 100%); padding-top: 60px;">
        <div class="package-header">
            <div class="package-label">Entry Product</div>
            <h2 class="package-title">LOGO <span class="red">ONLY</span></h2>
            <p class="package-subtitle" style="font-size:14px;color:var(--gray);max-width:500px;margin:16px auto 0;line-height:1.7;">You need a logo. Nothing else right now. We deliver a primary mark, an icon version, and every file format so you can use it anywhere, today.</p>
        </div>
        <div class="logo-only-card">
            <div class="lo-label">Standalone Product</div>
            <h3>LOGO DESIGN</h3>
            <p class="lo-sub">One strong logo designed to last. No extras &mdash; just a professional mark you own completely.</p>
            <ul>
                <li>2 Initial Concepts</li>
                <li>1 Revision Round</li>
                <li>Primary Logo + Icon/Mark Version</li>
                <li>All File Formats: PNG, SVG, PDF</li>
                <li>Black, White &amp; Color Versions</li>
                <li>Full Ownership &mdash; 100% Yours</li>
            </ul>
            <div class="lo-price-row">
                <span class="lo-price">$750</span>
                <span class="lo-price-note">flat rate &middot; 5&ndash;7 day delivery</span>
            </div>
            <div style="display:flex;gap:12px;flex-wrap:wrap;">
                <button class="btn-package" onclick="startServiceIntake('logo-only')">Get My Logo &#8594;</button>
                <button class="btn-white" onclick="startServiceIntake('consultation')" style="padding:14px 24px;font-size:14px;">Free Consultation</button>
            </div>
            <p style="font-size:11px;color:var(--gray);margin-top:16px;line-height:1.6;">Want the full brand kit later? Your $750 applies as a credit toward the $1,500 Brand Kit.</p>
        </div>
        </section>

        <!-- PRINT SECTION: AEO-targeted -->
        <section class="package-section" data-svc-filter="print" style="background:#050505;display:none;">
        <div class="package-header">
            <div class="package-label">Michigan Print &mdash; Overnight Delivery</div>
            <h2 class="package-title">PRINT <span class="red">MATERIALS</span></h2>
            <p class="package-subtitle" style="font-size:14px;color:var(--gray);max-width:560px;margin:16px auto 0;line-height:1.7;">Professional print for Michigan businesses. Designed by NUI, fulfilled same-day, shipped overnight anywhere in Michigan for $10. No minimum orders.</p>
        </div>
        <div style="max-width:760px;margin:0 auto;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;padding:0 24px;">
            <div style="background:#0d0d0d;border-radius:12px;padding:24px;border:1px solid rgba(255,255,255,0.07);">
                <div style="font-size:24px;margin-bottom:12px;">&#128198;</div>
                <div style="font-size:14px;font-weight:700;color:#fff;margin-bottom:6px;">Business Cards</div>
                <div style="font-size:12px;color:var(--gray);">500 cards, custom design included</div>
                <div style="font-size:16px;color:var(--red);font-weight:700;margin-top:12px;">From $85</div>
            </div>
            <div style="background:#0d0d0d;border-radius:12px;padding:24px;border:1px solid rgba(255,255,255,0.07);">
                <div style="font-size:24px;margin-bottom:12px;">&#128680;</div>
                <div style="font-size:14px;font-weight:700;color:#fff;margin-bottom:6px;">Banners &amp; Signs</div>
                <div style="font-size:12px;color:var(--gray);">Retractable banners, yard signs, coro</div>
                <div style="font-size:16px;color:var(--red);font-weight:700;margin-top:12px;">From $120</div>
            </div>
            <div style="background:#0d0d0d;border-radius:12px;padding:24px;border:1px solid rgba(255,255,255,0.07);">
                <div style="font-size:24px;margin-bottom:12px;">&#127914;</div>
                <div style="font-size:14px;font-weight:700;color:#fff;margin-bottom:6px;">Pop-Up Kits</div>
                <div style="font-size:12px;color:var(--gray);">Everything for trade shows and events</div>
                <div style="font-size:16px;color:var(--red);font-weight:700;margin-top:12px;">From $450</div>
            </div>
            <div style="background:#0d0d0d;border-radius:12px;padding:24px;border:1px solid rgba(255,255,255,0.07);">
                <div style="font-size:24px;margin-bottom:12px;">&#128228;</div>
                <div style="font-size:14px;font-weight:700;color:#fff;margin-bottom:6px;">Flyers &amp; Postcards</div>
                <div style="font-size:12px;color:var(--gray);">Events, promos, direct mail</div>
                <div style="font-size:16px;color:var(--red);font-weight:700;margin-top:12px;">From $65</div>
            </div>
        </div>
        <div style="text-align:center;margin-top:40px;padding:0 24px;">
            <p style="font-size:13px;color:var(--gray);margin-bottom:24px;">$10 overnight shipping anywhere in Michigan. 24-hour production on most items.</p>
            <button class="btn-package" onclick="showView('print')" style="margin-right:12px;">Browse All Print &#8594;</button>
            <button class="btn-white" onclick="startServiceIntake('consultation')" style="padding:14px 24px;font-size:14px;">Get a Print Quote</button>
        </div>
        </section>
        <!-- BRAND KIT - STARTER PACKAGE -->
<section class="package-section" style="background: linear-gradient(180deg, #0a0a0a 0%, #050505 100%);">
<div class="package-image">
<img loading="eager" fetchpriority="high" width="1920" height="1200" src="https://images.unsplash.com/photo-1558655146-9f40138edfeb?w=1920&q=80" alt="Brand Design" data-service-image="brand-kit">
</div>
<div style="max-width: 1200px; margin: 0 auto; padding: 0 24px;">
<div class="package-header">
<div class="package-label">Starter Package</div>
<h2 class="package-title">BRAND <span class="red">KIT</span></h2>
<p class="package-subtitle">Everything you need to launch your brand with confidence. Logo, voice, visuals, and social presence — all in one complete package.</p>
<div class="package-price">$1,500 <span>flat rate</span></div>
</div>

<div class="deliverables-grid" style="grid-template-columns: repeat(3, 1fr);">
<div class="deliverable-card">
<div class="deliverable-icon">◆</div>
<h3 class="deliverable-title">Logo Design</h3>
<p class="deliverable-desc">Your primary mark that represents your business everywhere.</p>
<ul class="deliverable-list">
<li>Primary Logo</li>
<li>Secondary Logo Variation</li>
<li>Icon/Mark Version</li>
<li>All File Formats (PNG, SVG, PDF)</li>
</ul>
<p style="font-size: 11px; color: var(--red); margin-top: 16px; font-weight: 600;">USE FOR: Business cards, website, signage, social profiles</p>
</div>

<div class="deliverable-card">
<div class="deliverable-icon">🎨</div>
<h3 class="deliverable-title">Color Palette & Typography</h3>
<p class="deliverable-desc">Strategic colors and fonts that define your visual identity.</p>
<ul class="deliverable-list">
<li>Primary & Secondary Colors</li>
<li>HEX, RGB, CMYK Values</li>
<li>Heading & Body Fonts</li>
<li>Font Pairing Guidelines</li>
</ul>
<p style="font-size: 11px; color: var(--red); margin-top: 16px; font-weight: 600;">USE FOR: All marketing materials, website, print</p>
</div>

<div class="deliverable-card">
<div class="deliverable-icon">🎯</div>
<h3 class="deliverable-title">Target Market Identifier</h3>
<p class="deliverable-desc">Know exactly who you're talking to and how to reach them.</p>
<ul class="deliverable-list">
<li>Ideal Customer Profile</li>
<li>Demographics & Psychographics</li>
<li>Pain Points & Desires</li>
<li>Where to Find Them</li>
</ul>
<p style="font-size: 11px; color: var(--red); margin-top: 16px; font-weight: 600;">USE FOR: Marketing strategy, ad targeting, content</p>
</div>

<div class="deliverable-card">
<div class="deliverable-icon">🗣️</div>
<h3 class="deliverable-title">Brand Voice</h3>
<p class="deliverable-desc">How your brand speaks, writes, and connects with your audience.</p>
<ul class="deliverable-list">
<li>Brand Personality Traits</li>
<li>Tone of Voice Guidelines</li>
<li>Messaging Do's & Don'ts</li>
<li>Sample Copy Examples</li>
</ul>
<p style="font-size: 11px; color: var(--red); margin-top: 16px; font-weight: 600;">USE FOR: Social posts, website copy, emails, ads</p>
</div>

<div class="deliverable-card">
<div class="deliverable-icon">📱</div>
<h3 class="deliverable-title">Social Media Banners</h3>
<p class="deliverable-desc">Professional graphics for all your social platforms.</p>
<ul class="deliverable-list">
<li>Facebook Cover</li>
<li>Instagram Profile & Highlight Covers</li>
<li>LinkedIn Banner</li>
<li>YouTube Channel Art</li>
</ul>
<p style="font-size: 11px; color: var(--red); margin-top: 16px; font-weight: 600;">USE FOR: Social media profiles, channel branding</p>
</div>

<div class="deliverable-card">
<div class="deliverable-icon">📸</div>
<h3 class="deliverable-title">Logo In Action</h3>
<p class="deliverable-desc">See your logo applied to real-world mockups.</p>
<ul class="deliverable-list">
<li>Business Card Mockup</li>
<li>Social Media Preview</li>
<li>Signage/Storefront Mockup</li>
<li>Apparel/Merch Preview</li>
</ul>
<p style="font-size: 11px; color: var(--red); margin-top: 16px; font-weight: 600;">USE FOR: Visualizing your brand, presentations, pitches</p>
</div>
</div>

<div class="package-cta">
<button class="btn-package" onclick="startServiceIntake('brand-kit')">Get Your Brand Kit →</button>
</div>
</div>
</section>

        <!-- PRODUCT BUSINESS BRAND IDENTITY -->
<section class="package-section" data-svc-filter="new-business,established" style="background: #050505;">
<div class="package-image">
<img loading="lazy" width="1920" height="1200" src="https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=1920&q=80" alt="Product Branding" data-service-image="product-brand">
</div>
<div style="max-width: 1200px; margin: 0 auto; padding: 0 24px;">
<div class="package-header">
<div class="package-label">For Product-Based Businesses</div>
<h2 class="package-title">PRODUCT <span class="red">BRAND IDENTITY</span></h2>
<p class="package-subtitle">Complete branding system for businesses selling physical products. From packaging to retail displays, we've got you covered.</p>
<div class="package-price">$5,500 <span>starting at</span></div>
</div>

                <!-- Core Brand Identity -->
<div class="category-section">
<div class="category-header">
<div class="category-icon">◆</div>
<div>
<h3 class="category-title">Core Brand Identity</h3>
<p class="category-subtitle">The foundation of your visual brand</p>
</div>
</div>
<div class="items-grid">
<div class="item-card">
<h4>Logo Suite</h4>
<p>Primary, secondary, icon mark, and watermark versions in all formats</p>
</div>
<div class="item-card">
<h4>Color System</h4>
<p>Full palette with primary, secondary, and accent colors plus usage rules</p>
</div>
<div class="item-card">
<h4>Typography</h4>
<p>Heading, body, and accent fonts with hierarchy guidelines</p>
</div>
<div class="item-card">
<h4>Brand Guidelines</h4>
<p>Complete PDF guide on how to use all brand elements correctly</p>
</div>
</div>
</div>

                <!-- Product Packaging & Labels -->
<div class="category-section">
<div class="category-header">
<div class="category-icon">📦</div>
<div>
<h3 class="category-title">Product Packaging & Labels</h3>
<p class="category-subtitle">Make your product stand out on the shelf</p>
</div>
</div>
<div class="items-grid">
<div class="item-card">
<h4>Product Labels</h4>
<p>Custom label designs for bottles, jars, boxes, and bags. Print-ready files included.</p>
</div>
<div class="item-card">
<h4>Packaging Design</h4>
<p>Box designs, mailer boxes, and product sleeves that grab attention.</p>
</div>
<div class="item-card">
<h4>Hang Tags</h4>
<p>Branded tags for apparel and products with care instructions.</p>
</div>
<div class="item-card">
<h4>Stickers & Seals</h4>
<p>Thank you stickers, brand seals, and packaging tape design.</p>
</div>
</div>
</div>

                <!-- Print & In-Store -->
<div class="category-section">
<div class="category-header">
<div class="category-icon">🏪</div>
<div>
<h3 class="category-title">Print & In-Store Design</h3>
<p class="category-subtitle">Dominate retail spaces and physical locations</p>
</div>
</div>
<div class="items-grid">
<div class="item-card">
<h4>Posters & Signage</h4>
<p>Eye-catching posters for in-store displays, windows, and events.</p>
</div>
<div class="item-card">
<h4>Window Decals</h4>
<p>Storefront window graphics and promotional decals.</p>
</div>
<div class="item-card">
<h4>Banners & Displays</h4>
<p>Trade show banners, pop-up displays, and table covers.</p>
</div>
<div class="item-card">
<h4>Wall Murals</h4>
<p>Large-scale branded graphics for store interiors.</p>
</div>
</div>
</div>

                <!-- Apparel & Merch -->
<div class="category-section">
<div class="category-header">
<div class="category-icon">👕</div>
<div>
<h3 class="category-title">Apparel & Merchandise</h3>
<p class="category-subtitle">Turn customers into walking billboards</p>
</div>
</div>
<div class="items-grid">
<div class="item-card">
<h4>T-Shirt Designs</h4>
<p>Branded tees for staff uniforms or merchandise sales.</p>
</div>
<div class="item-card">
<h4>Hat & Cap Designs</h4>
<p>Embroidery-ready logo files and hat mockups.</p>
</div>
<div class="item-card">
<h4>Uniform Design</h4>
<p>Cohesive staff uniforms including aprons, polos, and jackets.</p>
</div>
<div class="item-card">
<h4>Tote Bags</h4>
<p>Branded shopping bags and reusable totes.</p>
</div>
</div>
</div>

                <!-- Digital Marketing -->
<div class="category-section">
<div class="category-header">
<div class="category-icon">📱</div>
<div>
<h3 class="category-title">Digital Marketing Assets</h3>
<p class="category-subtitle">Everything you need to market online</p>
</div>
</div>
<div class="items-grid">
<div class="item-card">
<h4>Email Templates</h4>
<p>Branded email headers, newsletters, and promo templates.</p>
</div>
<div class="item-card">
<h4>Digital Mailers</h4>
<p>E-blasts and digital flyers for promotions and announcements.</p>
</div>
<div class="item-card">
<h4>Social Media Kit</h4>
<p>Post templates, story templates, and profile graphics.</p>
</div>
<div class="item-card">
<h4>Ad Creatives</h4>
<p>Facebook, Instagram, and Google ad graphics in all sizes.</p>
</div>
</div>
</div>

                <!-- ADD-ONS: Video & Photo (Detroit Metro Only) -->
<div style="background: linear-gradient(135deg, rgba(255,0,0,0.1), rgba(0,0,0,0.3)); border: 2px solid var(--red); border-radius: 16px; padding: 32px; margin-top: 40px;">
<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
<span style="background: var(--red); color: #fff; padding: 6px 16px; border-radius: 100px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">📍 Detroit Metro Add-Ons</span>
</div>
<p style="color: #888; font-size: 14px; margin-bottom: 24px;">Video production and photography services available as add-ons for clients in the Detroit metro area. These require in-person sessions at your location.</p>

<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px;">
                        <!-- Motion & Video Add-On -->
<div style="background: rgba(0,0,0,0.4); border-radius: 12px; padding: 24px;">
<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
<span style="font-size: 28px;">🎬</span>
<div>
<h4 style="margin: 0; font-size: 18px;">Video Production</h4>
<p style="margin: 4px 0 0; color: var(--red); font-size: 13px; font-weight: 600;">Add-on from $500</p>
</div>
</div>
<ul style="color: #888; font-size: 13px; line-height: 1.8; margin: 0; padding-left: 20px;">
<li>Logo Animation</li>
<li>Brand Commercial (15-30 sec)</li>
<li>Product Showcase Videos</li>
<li>Social Reels & TikToks</li>
</ul>
</div>

                        <!-- Photography Add-On -->
<div style="background: rgba(0,0,0,0.4); border-radius: 12px; padding: 24px;">
<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
<span style="font-size: 28px;">📷</span>
<div>
<h4 style="margin: 0; font-size: 18px;">Photography</h4>
<p style="margin: 4px 0 0; color: var(--red); font-size: 13px; font-weight: 600;">Add-on from $400</p>
</div>
</div>
<ul style="color: #888; font-size: 13px; line-height: 1.8; margin: 0; padding-left: 20px;">
<li>Product Photography</li>
<li>Lifestyle Shoots</li>
<li>Flat Lay Photography</li>
<li>Video Content</li>
</ul>
</div>
</div>
<p style="text-align: center; margin-top: 20px; color: #666; font-size: 12px;">📍 Available for Detroit, Dearborn, Southfield, Troy, Royal Oak, Ferndale, and surrounding metro areas</p>
</div>

<div class="package-cta">
<button class="btn-package" onclick="startServiceIntake('product-brand')">Build Your Product Brand →</button>
</div>
</div>
</section>

        <!-- SERVICE BUSINESS BRAND IDENTITY -->
<section class="package-section" data-svc-filter="established" style="background: linear-gradient(180deg, #0a0a0a 0%, #050505 100%);">
<div class="package-image">
<img loading="lazy" width="1920" height="1200" src="https://images.unsplash.com/photo-1600880292203-757bb62b4baf?w=1920&q=80" alt="Service Branding" data-service-image="service-brand">
</div>
<div style="max-width: 1200px; margin: 0 auto; padding: 0 24px;">
<div class="package-header">
<div class="package-label">For Service-Based Businesses</div>
<h2 class="package-title">SERVICE <span class="red">BRAND IDENTITY</span></h2>
<p class="package-subtitle">Complete branding system for consultants, agencies, contractors, and service providers. Build trust and attract premium clients.</p>
<div class="package-price">$4,500 <span>starting at</span></div>
</div>

                <!-- Core Brand Identity -->
<div class="category-section">
<div class="category-header">
<div class="category-icon">◆</div>
<div>
<h3 class="category-title">Core Brand Identity</h3>
<p class="category-subtitle">Professional foundation for your business</p>
</div>
</div>
<div class="items-grid">
<div class="item-card">
<h4>Logo Suite</h4>
<p>Primary, secondary, and icon versions for all applications</p>
</div>
<div class="item-card">
<h4>Color System</h4>
<p>Professional palette that builds trust and recognition</p>
</div>
<div class="item-card">
<h4>Typography</h4>
<p>Font system for documents, presentations, and web</p>
</div>
<div class="item-card">
<h4>Brand Guidelines</h4>
<p>Complete usage guide for consistency across all touchpoints</p>
</div>
</div>
</div>

                <!-- Print Collateral -->
<div class="category-section">
<div class="category-header">
<div class="category-icon">📄</div>
<div>
<h3 class="category-title">Print Collateral</h3>
<p class="category-subtitle">Professional materials that close deals</p>
</div>
</div>
<div class="items-grid">
<div class="item-card">
<h4>Business Cards</h4>
<p>Premium card design with print-ready files and vendor recommendations.</p>
</div>
<div class="item-card">
<h4>Letterhead & Envelopes</h4>
<p>Professional stationery for proposals and correspondence.</p>
</div>
<div class="item-card">
<h4>Brochures & Flyers</h4>
<p>Service brochures and promotional flyers for events.</p>
</div>
<div class="item-card">
<h4>Presentation Folders</h4>
<p>Custom folders for client proposals and welcome packets.</p>
</div>
</div>
</div>

                <!-- Print & Signage -->
<div class="category-section">
<div class="category-header">
<div class="category-icon">🖨️</div>
<div>
<h3 class="category-title">Print & Signage</h3>
<p class="category-subtitle">Real-world graphics that get noticed</p>
</div>
</div>
<div class="items-grid">
<div class="item-card">
<h4>Banners</h4>
<p>Retractable, vinyl, and hanging banners for events and storefronts.</p>
</div>
<div class="item-card">
<h4>Posters</h4>
<p>Promotional posters, wall graphics, and large format prints.</p>
</div>
<div class="item-card">
<h4>Yard Signs</h4>
<p>Campaign, real estate, and promotional yard signs.</p>
</div>
<div class="item-card">
<h4>Event Backgrounds</h4>
<p>Step-and-repeat backdrops and photo booth backgrounds.</p>
</div>
<div class="item-card">
<h4>Vinyl Decals</h4>
<p>Storefront window graphics, wall decals, and custom cut vinyl.</p>
</div>
<div class="item-card">
<h4>Building Signage</h4>
<p>Storefront and office signage design.</p>
</div>
<div class="item-card">
<h4>Vehicle Magnets</h4>
<p>Removable magnetic signs for cars, trucks, and vans.</p>
</div>
<div class="item-card">
<h4>Business Cards</h4>
<p>Premium 16pt cards with UV or matte coating.</p>
</div>
<div class="item-card">
<h4>Postcards & Mailers</h4>
<p>4x6 and 6x9 direct mail postcards.</p>
</div>
<div class="item-card">
<h4>Acrylic Signs</h4>
<p>Clear UV-printed acrylic for lobbies and interiors.</p>
</div>
<div class="item-card">
<h4>Dibond / Aluminum</h4>
<p>Weatherproof aluminum composite exterior signs.</p>
</div>
<div class="item-card">
<h4>Foam Core</h4>
<p>Lightweight mounted prints for events and displays.</p>
</div>
</div>
</div>

                <!-- Uniforms & Apparel -->
<div class="category-section">
<div class="category-header">
<div class="category-icon">👔</div>
<div>
<h3 class="category-title">Uniforms & Apparel</h3>
<p class="category-subtitle">Look professional on every job</p>
</div>
</div>
<div class="items-grid">
<div class="item-card">
<h4>Polo Shirts</h4>
<p>Embroidery-ready designs for professional staff polos.</p>
</div>
<div class="item-card">
<h4>Work Shirts</h4>
<p>Button-up and work shirt designs with logo placement.</p>
</div>
<div class="item-card">
<h4>Hats & Caps</h4>
<p>Branded headwear for team and promotional use.</p>
</div>
<div class="item-card">
<h4>Jackets & Outerwear</h4>
<p>Branded jackets and vests for field work.</p>
</div>
</div>
</div>

                <!-- Digital Presence -->
<div class="category-section">
<div class="category-header">
<div class="category-icon">🌐</div>
<div>
<h3 class="category-title">Digital Presence</h3>
<p class="category-subtitle">Dominate online and attract leads</p>
</div>
</div>
<div class="items-grid">
<div class="item-card">
<h4>Website Design</h4>
<p>Professional website that converts visitors into clients.</p>
</div>
<div class="item-card">
<h4>Email Signature</h4>
<p>Branded email signatures for the whole team.</p>
</div>
<div class="item-card">
<h4>Social Media Kit</h4>
<p>Profile images, cover photos, and post templates.</p>
</div>
<div class="item-card">
<h4>Google Business Profile</h4>
<p>Optimized profile with branded images and posts.</p>
</div>
</div>
</div>

                <!-- Digital Marketing -->
<div class="category-section">
<div class="category-header">
<div class="category-icon">📧</div>
<div>
<h3 class="category-title">Digital Marketing</h3>
<p class="category-subtitle">Automated systems that generate leads</p>
</div>
</div>
<div class="items-grid">
<div class="item-card">
<h4>Email Templates</h4>
<p>Welcome sequences, newsletters, and promotional emails.</p>
</div>
<div class="item-card">
<h4>Digital Mailers</h4>
<p>E-blasts for service announcements and promotions.</p>
</div>
<div class="item-card">
<h4>Lead Magnets</h4>
<p>PDF guides, checklists, and downloads to capture leads.</p>
</div>
<div class="item-card">
<h4>Ad Creatives</h4>
<p>Facebook, Instagram, and Google ad graphics.</p>
</div>
</div>
</div>

                <!-- ADD-ONS: Video & Photo (Detroit Metro Only) -->
<div style="background: linear-gradient(135deg, rgba(255,0,0,0.1), rgba(0,0,0,0.3)); border: 2px solid var(--red); border-radius: 16px; padding: 32px; margin-top: 40px;">
<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
<span style="background: var(--red); color: #fff; padding: 6px 16px; border-radius: 100px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">📍 Detroit Metro Add-Ons</span>
</div>
<p style="color: #888; font-size: 14px; margin-bottom: 24px;">Video production and photography services available as add-ons for clients in the Detroit metro area. These require in-person sessions at your location.</p>

<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px;">
                        <!-- Motion & Video Add-On -->
<div style="background: rgba(0,0,0,0.4); border-radius: 12px; padding: 24px;">
<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
<span style="font-size: 28px;">🎬</span>
<div>
<h4 style="margin: 0; font-size: 18px;">Video Production</h4>
<p style="margin: 4px 0 0; color: var(--red); font-size: 13px; font-weight: 600;">Add-on from $500</p>
</div>
</div>
<ul style="color: #888; font-size: 13px; line-height: 1.8; margin: 0; padding-left: 20px;">
<li>Logo Animation</li>
<li>Brand Commercial (30-60 sec)</li>
<li>Service Explainer Videos</li>
<li>Testimonial Videos</li>
</ul>
</div>

                        <!-- Photography Add-On -->
<div style="background: rgba(0,0,0,0.4); border-radius: 12px; padding: 24px;">
<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
<span style="font-size: 28px;">📷</span>
<div>
<h4 style="margin: 0; font-size: 18px;">Photography</h4>
<p style="margin: 4px 0 0; color: var(--red); font-size: 13px; font-weight: 600;">Add-on from $400</p>
</div>
</div>
<ul style="color: #888; font-size: 13px; line-height: 1.8; margin: 0; padding-left: 20px;">
<li>Team Headshots</li>
<li>Office/Location Shots</li>
<li>Project Photography</li>
<li>Social Content</li>
</ul>
</div>
</div>
<p style="text-align: center; margin-top: 20px; color: #666; font-size: 12px;">📍 Available for Detroit, Dearborn, Southfield, Troy, Royal Oak, Ferndale, and surrounding metro areas</p>
</div>

<div class="package-cta">
<button class="btn-package" onclick="startServiceIntake('service-brand')">Build Your Service Brand →</button>
</div>
</div>
</section>

        <!-- COMPARISON TABLE -->
<section class="section dark">
<div style="max-width: 1000px; margin: 0 auto; padding: 0 24px;">
<div class="package-header">
<div class="package-label">Compare Packages</div>
<h2 class="package-title">WHAT'S <span class="red">INCLUDED</span></h2>
</div>

<div class="comparison-table">
<div class="comparison-row">
<div class="comparison-cell header">Deliverable</div>
<div class="comparison-cell header">Brand Kit</div>
<div class="comparison-cell header">Product</div>
<div class="comparison-cell header">Service</div>
</div>
<div class="comparison-row">
<div class="comparison-cell feature">Logo Suite</div>
<div class="comparison-cell check">✓</div>
<div class="comparison-cell check">✓</div>
<div class="comparison-cell check">✓</div>
</div>
<div class="comparison-row">
<div class="comparison-cell feature">Color Palette</div>
<div class="comparison-cell check">✓</div>
<div class="comparison-cell check">✓</div>
<div class="comparison-cell check">✓</div>
</div>
<div class="comparison-row">
<div class="comparison-cell feature">Typography System</div>
<div class="comparison-cell check">✓</div>
<div class="comparison-cell check">✓</div>
<div class="comparison-cell check">✓</div>
</div>
<div class="comparison-row">
<div class="comparison-cell feature">Brand Guidelines</div>
<div class="comparison-cell empty">—</div>
<div class="comparison-cell check">✓</div>
<div class="comparison-cell check">✓</div>
</div>
<div class="comparison-row">
<div class="comparison-cell feature">Product Labels & Packaging</div>
<div class="comparison-cell empty">—</div>
<div class="comparison-cell check">✓</div>
<div class="comparison-cell empty">—</div>
</div>
<div class="comparison-row">
<div class="comparison-cell feature">Business Cards & Stationery</div>
<div class="comparison-cell empty">—</div>
<div class="comparison-cell check">✓</div>
<div class="comparison-cell check">✓</div>
</div>
<div class="comparison-row">
<div class="comparison-cell feature">Print & Signage</div>
<div class="comparison-cell empty">—</div>
<div class="comparison-cell empty">—</div>
<div class="comparison-cell check">✓</div>
</div>
<div class="comparison-row">
<div class="comparison-cell feature">Uniforms & Apparel</div>
<div class="comparison-cell empty">—</div>
<div class="comparison-cell check">✓</div>
<div class="comparison-cell check">✓</div>
</div>
<div class="comparison-row">
<div class="comparison-cell feature">Social Media Kit</div>
<div class="comparison-cell empty">—</div>
<div class="comparison-cell check">✓</div>
<div class="comparison-cell check">✓</div>
</div>
<div class="comparison-row">
<div class="comparison-cell feature">Email Templates</div>
<div class="comparison-cell empty">—</div>
<div class="comparison-cell check">✓</div>
<div class="comparison-cell check">✓</div>
</div>
<div class="comparison-row">
<div class="comparison-cell feature">Logo Animation <span style="font-size: 10px; color: var(--red);">📍 Add-on</span></div>
<div class="comparison-cell empty">—</div>
<div class="comparison-cell" style="color: #888; font-size: 11px;">+$400</div>
<div class="comparison-cell" style="color: #888; font-size: 11px;">+$400</div>
</div>
<div class="comparison-row">
<div class="comparison-cell feature">Video Production <span style="font-size: 10px; color: var(--red);">📍 Add-on</span></div>
<div class="comparison-cell empty">—</div>
<div class="comparison-cell" style="color: #888; font-size: 11px;">+$500</div>
<div class="comparison-cell" style="color: #888; font-size: 11px;">+$500</div>
</div>
<div class="comparison-row">
<div class="comparison-cell feature">Photography <span style="font-size: 10px; color: var(--red);">📍 Add-on</span></div>
<div class="comparison-cell empty">—</div>
<div class="comparison-cell" style="color: #888; font-size: 11px;">+$400</div>
<div class="comparison-cell" style="color: #888; font-size: 11px;">+$400</div>
</div>
<div class="comparison-row">
<div class="comparison-cell feature">Print Signage</div>
<div class="comparison-cell empty">—</div>
<div class="comparison-cell check">✓</div>
<div class="comparison-cell check">✓</div>
</div>
</div>
</div>
</section>

        <!-- WEBSITE & WEBAPP PACKAGES -->
<section class="package-section" data-svc-filter="new-business,established,digital" style="background: #050505;">
<div class="package-image">
<img loading="lazy" width="1920" height="1200" src="https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=1920&q=80" alt="Website Development" data-service-image="website">
</div>
<div style="max-width: 1200px; margin: 0 auto; padding: 0 24px;">
<div class="package-header">
<div class="package-label">Digital Products</div>
<h2 class="package-title">WEBSITE & <span class="red">WEB APPS</span></h2>
<p class="package-subtitle">Your digital headquarters. Built for conversion, designed to dominate.</p>
</div>

<div class="deliverables-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 60px;">
                    <!-- Basic Website -->
<div class="deliverable-card" style="border-color: rgba(255,255,255,0.1);">
<div style="font-size: 11px; color: var(--red); text-transform: uppercase; letter-spacing: 2px; font-weight: 700; margin-bottom: 16px;">Starter</div>
<h3 class="deliverable-title" style="font-size: 24px;">Landing Page</h3>
<div style="font-size: 32px; font-weight: 900; color: var(--red); margin: 16px 0;">$1,200</div>
<p class="deliverable-desc">Single page website perfect for capturing leads or launching a product.</p>
<ul class="deliverable-list">
<li>Custom Design</li>
<li>Mobile Responsive</li>
<li>Contact Form</li>
<li>SEO Basics</li>
<li>1 Week Delivery</li>
</ul>
<button class="btn-package" style="width: 100%; margin-top: 24px; padding: 14px;" onclick="startServiceIntake('landing-page')">Get Started →</button>
</div>

                    <!-- Business Website -->
<div class="deliverable-card" style="border-color: var(--red); position: relative;">
<div style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: var(--red); color: #fff; font-size: 10px; font-weight: 700; padding: 4px 16px; border-radius: 4px; text-transform: uppercase; letter-spacing: 1px;">Most Popular</div>
<div style="font-size: 11px; color: var(--red); text-transform: uppercase; letter-spacing: 2px; font-weight: 700; margin-bottom: 16px;">Professional</div>
<h3 class="deliverable-title" style="font-size: 24px;">Business Website</h3>
<div style="font-size: 32px; font-weight: 900; color: var(--red); margin: 16px 0;">$3,500</div>
<p class="deliverable-desc">Full multi-page website for established businesses ready to dominate online.</p>
<ul class="deliverable-list">
<li>5-7 Custom Pages</li>
<li>CMS Integration</li>
<li>Blog Setup</li>
<li>Advanced SEO</li>
<li>Analytics Dashboard</li>
<li>Speed Optimization</li>
<li>2-3 Week Delivery</li>
</ul>
<button class="btn-package" style="width: 100%; margin-top: 24px; padding: 14px;" onclick="startServiceIntake('business-website')">Get Started →</button>
</div>

                    <!-- E-Commerce -->
<div class="deliverable-card" style="border-color: rgba(255,255,255,0.1);">
<div style="font-size: 11px; color: var(--red); text-transform: uppercase; letter-spacing: 2px; font-weight: 700; margin-bottom: 16px;">E-Commerce</div>
<h3 class="deliverable-title" style="font-size: 24px;">Online Store</h3>
<div style="font-size: 32px; font-weight: 900; color: var(--red); margin: 16px 0;">$5,500</div>
<p class="deliverable-desc">Full e-commerce solution to sell products online 24/7.</p>
<ul class="deliverable-list">
<li>Shopify / WooCommerce</li>
<li>Product Upload (up to 50)</li>
<li>Payment Integration</li>
<li>Shipping Setup</li>
<li>Abandoned Cart Recovery</li>
<li>Inventory Management</li>
<li>3-4 Week Delivery</li>
</ul>
<button class="btn-package" style="width: 100%; margin-top: 24px; padding: 14px;" onclick="startServiceIntake('ecommerce')">Get Started →</button>
</div>
</div>

                <!-- Web App Section -->
<div class="category-section">
<div class="category-header">
<div class="category-icon">⚡</div>
<div>
<h3 class="category-title">Custom Web Applications</h3>
<p class="category-subtitle">Powerful tools built for your specific business needs</p>
</div>
</div>
<div class="items-grid">
<div class="item-card">
<h4>Client Portals</h4>
<p>Secure login areas for clients to access files, invoices, and project updates.</p>
</div>
<div class="item-card">
<h4>Booking Systems</h4>
<p>Custom appointment scheduling with calendar sync and reminders.</p>
</div>
<div class="item-card">
<h4>Member Dashboards</h4>
<p>Membership sites with content access, progress tracking, and community features.</p>
</div>
<div class="item-card">
<h4>Custom CRM</h4>
<p>Contact management and sales pipeline tools tailored to your workflow.</p>
</div>
</div>
<p style="text-align: center; color: var(--gray); margin-top: 32px; font-size: 14px;">Web app pricing starts at <span style="color: var(--red); font-weight: 700;">$7,500</span> — <a onclick="startServiceIntake('webapp')" style="color: #fff; text-decoration: underline; cursor: pointer;">Request a Quote</a></p>
</div>
</div>
</section>

        <!-- MOBILE APP PACKAGES -->
<section class="package-section" data-svc-filter="digital" style="background: linear-gradient(180deg, #0a0a0a 0%, #050505 100%);">
<div class="package-image">
<img loading="lazy" width="1920" height="1200" src="https://images.unsplash.com/photo-1512941937669-90a1b58e7e9c?w=1920&q=80" alt="Mobile App Development" data-service-image="mobile-app">
</div>
<div style="max-width: 1200px; margin: 0 auto; padding: 0 24px;">
<div class="package-header">
<div class="package-label">Mobile Development</div>
<h2 class="package-title">MOBILE <span class="red">APPS</span></h2>
<p class="package-subtitle">Put your business in your customers' pockets. Native and cross-platform solutions.</p>
</div>

<div class="deliverables-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <!-- MVP App -->
<div class="deliverable-card">
<div style="font-size: 11px; color: var(--red); text-transform: uppercase; letter-spacing: 2px; font-weight: 700; margin-bottom: 16px;">Launch Fast</div>
<h3 class="deliverable-title" style="font-size: 24px;">MVP App</h3>
<div style="font-size: 32px; font-weight: 900; color: var(--red); margin: 16px 0;">$12,000 <span style="font-size: 14px; color: var(--gray); font-weight: 400;">starting at</span></div>
<p class="deliverable-desc">Minimum viable product to test your app idea and get to market fast.</p>
<ul class="deliverable-list">
<li>Cross-Platform (iOS + Android)</li>
<li>Core Feature Set (3-5 features)</li>
<li>User Authentication</li>
<li>Basic Admin Panel</li>
<li>App Store Submission</li>
<li>6-8 Week Delivery</li>
</ul>
<button class="btn-package" style="width: 100%; margin-top: 24px; padding: 14px;" onclick="startServiceIntake('mvp-app')">Get Started →</button>
</div>

                    <!-- Full App -->
<div class="deliverable-card">
<div style="font-size: 11px; color: var(--red); text-transform: uppercase; letter-spacing: 2px; font-weight: 700; margin-bottom: 16px;">Full Product</div>
<h3 class="deliverable-title" style="font-size: 24px;">Custom Mobile App</h3>
<div style="font-size: 32px; font-weight: 900; color: var(--red); margin: 16px 0;">$20,000+ <span style="font-size: 14px; color: var(--gray); font-weight: 400;">custom quote</span></div>
<p class="deliverable-desc">Full-featured mobile application with advanced functionality and integrations.</p>
<ul class="deliverable-list">
<li>Native or Cross-Platform</li>
<li>Unlimited Features</li>
<li>Payment Integration</li>
<li>Push Notifications</li>
<li>API Integrations</li>
<li>Full Admin Dashboard</li>
<li>Ongoing Support Options</li>
</ul>
<button class="btn-package" style="width: 100%; margin-top: 24px; padding: 14px;" onclick="startServiceIntake('custom-app')">Request Quote →</button>
</div>
</div>

                <!-- App Features -->
<div class="category-section" style="margin-top: 60px;">
<div class="category-header">
<div class="category-icon">📲</div>
<div>
<h3 class="category-title">Available App Features</h3>
<p class="category-subtitle">Build the exact functionality your business needs</p>
</div>
</div>
<div class="items-grid" style="grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));">
<div class="item-card"><h4>User Profiles</h4></div>
<div class="item-card"><h4>Social Login</h4></div>
<div class="item-card"><h4>Push Notifications</h4></div>
<div class="item-card"><h4>In-App Purchases</h4></div>
<div class="item-card"><h4>Booking/Scheduling</h4></div>
<div class="item-card"><h4>Chat & Messaging</h4></div>
<div class="item-card"><h4>GPS & Maps</h4></div>
<div class="item-card"><h4>Camera & Media</h4></div>
<div class="item-card"><h4>Payment Processing</h4></div>
<div class="item-card"><h4>Analytics Dashboard</h4></div>
<div class="item-card"><h4>Loyalty Programs</h4></div>
<div class="item-card"><h4>Offline Mode</h4></div>
</div>
</div>
</div>
</section>

        <!-- SALES FUNNELS & AUTOMATION -->
<section class="package-section" data-svc-filter="established,digital" style="background: #050505;">
<div class="package-image">
<img loading="lazy" width="1920" height="1200" src="https://images.unsplash.com/photo-1533750349088-cd871a92f312?w=1920&q=80" alt="Sales Funnels Marketing" data-service-image="sales-funnel">
</div>
<div style="max-width: 1200px; margin: 0 auto; padding: 0 24px;">
<div class="package-header">
<div class="package-label">Marketing Systems</div>
<h2 class="package-title">SALES <span class="red">FUNNELS</span></h2>
<p class="package-subtitle">Automated systems that turn strangers into customers while you sleep.</p>
</div>

<div class="deliverables-grid" style="grid-template-columns: repeat(3, 1fr);">
<div class="deliverable-card">
<div style="font-size: 11px; color: var(--red); text-transform: uppercase; letter-spacing: 2px; font-weight: 700; margin-bottom: 16px;">Lead Generation</div>
<h3 class="deliverable-title">Lead Capture Funnel</h3>
<div style="font-size: 32px; font-weight: 900; color: var(--red); margin: 16px 0;">$1,500</div>
<ul class="deliverable-list">
<li>Landing Page Design</li>
<li>Lead Magnet Creation</li>
<li>Thank You Page</li>
<li>5-Email Welcome Sequence</li>
<li>CRM Integration</li>
</ul>
<button class="btn-package" style="width: 100%; margin-top: 24px; padding: 14px;" onclick="startServiceIntake('lead-funnel')">Get Started →</button>
</div>

<div class="deliverable-card" style="border-color: var(--red);">
<div style="font-size: 11px; color: var(--red); text-transform: uppercase; letter-spacing: 2px; font-weight: 700; margin-bottom: 16px;">Sales Machine</div>
<h3 class="deliverable-title">Full Sales Funnel</h3>
<div style="font-size: 32px; font-weight: 900; color: var(--red); margin: 16px 0;">$3,500</div>
<ul class="deliverable-list">
<li>Multi-Step Funnel</li>
<li>Sales Page Design</li>
<li>Order/Checkout Pages</li>
<li>Upsell/Downsell Pages</li>
<li>Full Email Automation</li>
<li>Payment Integration</li>
</ul>
<button class="btn-package" style="width: 100%; margin-top: 24px; padding: 14px;" onclick="startServiceIntake('sales-funnel')">Get Started →</button>
</div>

<div class="deliverable-card">
<div style="font-size: 11px; color: var(--red); text-transform: uppercase; letter-spacing: 2px; font-weight: 700; margin-bottom: 16px;">Webinar</div>
<h3 class="deliverable-title">Webinar Funnel</h3>
<div style="font-size: 32px; font-weight: 900; color: var(--red); margin: 16px 0;">$4,500</div>
<ul class="deliverable-list">
<li>Registration Page</li>
<li>Reminder Sequences</li>
<li>Live/Evergreen Setup</li>
<li>Replay Page</li>
<li>Follow-Up Automation</li>
<li>Sales Page Integration</li>
</ul>
<button class="btn-package" style="width: 100%; margin-top: 24px; padding: 14px;" onclick="startServiceIntake('webinar-funnel')">Get Started →</button>
</div>
</div>
</div>
</section>

        <!-- BUILD YOUR OWN PACKAGE -->
<section class="package-section" data-svc-filter="new-business,established,digital" style="background: linear-gradient(180deg, #0a0a0a 0%, #080808 100%);">
<div class="package-image">
<img loading="lazy" width="1920" height="1200" src="https://images.unsplash.com/photo-1454165804606-c3d57bc86b40?w=1920&q=80" alt="Custom Package" data-service-image="custom">
</div>
<div style="max-width: 1200px; margin: 0 auto; padding: 0 24px;">
<div class="package-header">
<div class="package-label">Customize Your Solution</div>
<h2 class="package-title">BUILD YOUR <span class="red">OWN PACKAGE</span></h2>
<p class="package-subtitle">Select only the services you need. Mix and match to create the perfect solution for your business.</p>
</div>

<div id="customPackageBuilder" style="background: #0a0a0a; border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 40px; margin-bottom: 40px;">

                    <!-- Brand & Identity -->
<div style="margin-bottom: 40px;">
<h3 style="font-size: 16px; font-weight: 800; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
<span style="width: 32px; height: 32px; background: rgba(255,59,48,0.15); border-radius: 8px; display: flex; align-items: center; justify-content: center;">◆</span>
                            Brand & Identity
</h3>
<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Logo Design" data-price="500"><span class="checkmark"></span><span class="service-name">Logo Design</span><span class="service-price">$500</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Color Palette" data-price="200"><span class="checkmark"></span><span class="service-name">Color Palette</span><span class="service-price">$200</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Typography System" data-price="200"><span class="checkmark"></span><span class="service-name">Typography System</span><span class="service-price">$200</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Brand Guidelines" data-price="750"><span class="checkmark"></span><span class="service-name">Brand Guidelines</span><span class="service-price">$750</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Business Cards" data-price="150"><span class="checkmark"></span><span class="service-name">Business Cards</span><span class="service-price">$150</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Letterhead & Stationery" data-price="250"><span class="checkmark"></span><span class="service-name">Letterhead & Stationery</span><span class="service-price">$250</span></label>
</div>
</div>

                    <!-- Print & Physical -->
<div style="margin-bottom: 40px;">
<h3 style="font-size: 16px; font-weight: 800; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
<span style="width: 32px; height: 32px; background: rgba(255,59,48,0.15); border-radius: 8px; display: flex; align-items: center; justify-content: center;">📦</span>
                            Print & Physical
</h3>
<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Product Labels" data-price="300"><span class="checkmark"></span><span class="service-name">Product Labels</span><span class="service-price">$300</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Packaging Design" data-price="500"><span class="checkmark"></span><span class="service-name">Packaging Design</span><span class="service-price">$500</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Posters & Signage" data-price="250"><span class="checkmark"></span><span class="service-name">Posters & Signage</span><span class="service-price">$250</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Window Decals" data-price="200"><span class="checkmark"></span><span class="service-name">Window Decals</span><span class="service-price">$200</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Vehicle Magnets Pair (Design+Print)" data-price="195"><span class="checkmark"></span><span class="service-name">Vehicle Magnets Pair</span><span class="service-price">$195</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Banner & Poster Design" data-price="300"><span class="checkmark"></span><span class="service-name">Banner & Poster Design</span><span class="service-price">$300</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Yard Signs 10-Pack (Design+Print)" data-price="350"><span class="checkmark"></span><span class="service-name">Yard Signs 10-Pack (Design+Print)</span><span class="service-price">$350</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Event Backdrop 8x8 (Design+Print)" data-price="450"><span class="checkmark"></span><span class="service-name">Event Backdrop 8x8 (Design+Print)</span><span class="service-price">$450</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Wall Mural Design" data-price="600"><span class="checkmark"></span><span class="service-name">Wall Mural Design</span><span class="service-price">$600</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Brochures & Flyers" data-price="200"><span class="checkmark"></span><span class="service-name">Brochures & Flyers</span><span class="service-price">$200</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Business Cards 500 (Design+Print)" data-price="275"><span class="checkmark"></span><span class="service-name">Business Cards 500</span><span class="service-price">$275</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Postcards 250 (Design+Print)" data-price="225"><span class="checkmark"></span><span class="service-name">Postcards 250 (4x6)</span><span class="service-price">$225</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Acrylic Sign 12x12 (Design+Print)" data-price="275"><span class="checkmark"></span><span class="service-name">Acrylic Sign 12x12</span><span class="service-price">$275</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Dibond Sign 12x18 (Design+Print)" data-price="325"><span class="checkmark"></span><span class="service-name">Dibond Sign 12x18</span><span class="service-price">$325</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Foam Core 18x24 (Design+Print)" data-price="195"><span class="checkmark"></span><span class="service-name">Foam Core 18x24</span><span class="service-price">$195</span></label>
</div>
</div>

                    <!-- Apparel & Merch -->
<div style="margin-bottom: 40px;">
<h3 style="font-size: 16px; font-weight: 800; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
<span style="width: 32px; height: 32px; background: rgba(255,59,48,0.15); border-radius: 8px; display: flex; align-items: center; justify-content: center;">👕</span>
                            Apparel & Merchandise
</h3>
<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="T-Shirt Design" data-price="150"><span class="checkmark"></span><span class="service-name">T-Shirt Design</span><span class="service-price">$150</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Hoodie Design" data-price="150"><span class="checkmark"></span><span class="service-name">Hoodie Design</span><span class="service-price">$150</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Hat/Cap Design" data-price="100"><span class="checkmark"></span><span class="service-name">Hat/Cap Design</span><span class="service-price">$100</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Uniform Design (Full Set)" data-price="400"><span class="checkmark"></span><span class="service-name">Uniform Design (Full)</span><span class="service-price">$400</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Tote Bag Design" data-price="100"><span class="checkmark"></span><span class="service-name">Tote Bag Design</span><span class="service-price">$100</span></label>
</div>
</div>

                    <!-- Digital Marketing -->
<div style="margin-bottom: 40px;">
<h3 style="font-size: 16px; font-weight: 800; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
<span style="width: 32px; height: 32px; background: rgba(255,59,48,0.15); border-radius: 8px; display: flex; align-items: center; justify-content: center;">📱</span>
                            Digital Marketing
</h3>
<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Social Media Kit" data-price="350"><span class="checkmark"></span><span class="service-name">Social Media Kit</span><span class="service-price">$350</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Email Templates (5)" data-price="300"><span class="checkmark"></span><span class="service-name">Email Templates (5)</span><span class="service-price">$300</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Digital Mailers" data-price="150"><span class="checkmark"></span><span class="service-name">Digital Mailers</span><span class="service-price">$150</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Ad Creatives (10)" data-price="400"><span class="checkmark"></span><span class="service-name">Ad Creatives (10)</span><span class="service-price">$400</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Lead Magnet Design" data-price="250"><span class="checkmark"></span><span class="service-name">Lead Magnet Design</span><span class="service-price">$250</span></label>
</div>
</div>

                    <!-- Motion & Video -->
<div style="margin-bottom: 40px;">
<h3 style="font-size: 16px; font-weight: 800; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
<span style="width: 32px; height: 32px; background: rgba(255,59,48,0.15); border-radius: 8px; display: flex; align-items: center; justify-content: center;">🎬</span>
                            Motion & Video
</h3>
<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Logo Animation" data-price="400"><span class="checkmark"></span><span class="service-name">Logo Animation</span><span class="service-price">$400</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Brand Commercial (30sec)" data-price="1200"><span class="checkmark"></span><span class="service-name">Brand Commercial</span><span class="service-price">$1,200</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Social Reels (5)" data-price="500"><span class="checkmark"></span><span class="service-name">Social Reels (5)</span><span class="service-price">$500</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Motion Graphics Pack" data-price="600"><span class="checkmark"></span><span class="service-name">Motion Graphics Pack</span><span class="service-price">$600</span></label>
</div>
</div>

                    <!-- Photography -->
<div style="margin-bottom: 40px;">
<h3 style="font-size: 16px; font-weight: 800; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
<span style="width: 32px; height: 32px; background: rgba(255,59,48,0.15); border-radius: 8px; display: flex; align-items: center; justify-content: center;">📷</span>
                            Photography & Production
</h3>
<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Product Photography (10)" data-price="400"><span class="checkmark"></span><span class="service-name">Product Photos (10)</span><span class="service-price">$400</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Headshots (5 people)" data-price="350"><span class="checkmark"></span><span class="service-name">Headshots (5 people)</span><span class="service-price">$350</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Lifestyle Photo Session" data-price="600"><span class="checkmark"></span><span class="service-name">Lifestyle Session</span><span class="service-price">$600</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Location/Office Shoot" data-price="500"><span class="checkmark"></span><span class="service-name">Location Shoot</span><span class="service-price">$500</span></label>
</div>
</div>

                    <!-- Web & Digital -->
<div style="margin-bottom: 40px;">
<h3 style="font-size: 16px; font-weight: 800; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
<span style="width: 32px; height: 32px; background: rgba(255,59,48,0.15); border-radius: 8px; display: flex; align-items: center; justify-content: center;">🌐</span>
                            Web & Digital Products
</h3>
<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Landing Page" data-price="1200"><span class="checkmark"></span><span class="service-name">Landing Page</span><span class="service-price">$1,200</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Business Website" data-price="3500"><span class="checkmark"></span><span class="service-name">Business Website</span><span class="service-price">$3,500</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="E-Commerce Store" data-price="5500"><span class="checkmark"></span><span class="service-name">E-Commerce Store</span><span class="service-price">$5,500</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Sales Funnel" data-price="2000"><span class="checkmark"></span><span class="service-name">Sales Funnel</span><span class="service-price">$2,000</span></label>
<label class="custom-service-item" onclick="toggleCustomService(event, this)"><input type="checkbox" data-service="Google Business Setup" data-price="200"><span class="checkmark"></span><span class="service-name">Google Business Setup</span><span class="service-price">$200</span></label>
</div>
</div>

                    <!-- Summary Box -->
<div id="customPackageSummary" style="background: #050505; border: 2px solid rgba(255,59,48,0.3); border-radius: 12px; padding: 32px; margin-top: 40px;">
<div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 24px;">
<div>
<div style="font-size: 13px; color: var(--gray); margin-bottom: 8px;">Your Custom Package</div>
<div style="font-size: 14px; color: rgba(255,255,255,0.6);" id="selectedServicesCount">0 services selected</div>
</div>
<div style="text-align: right;">
<div style="font-size: 13px; color: var(--gray); margin-bottom: 8px;">Estimated Total</div>
<div style="font-size: 36px; font-weight: 900; color: var(--red);" id="customPackageTotal">$0</div>
</div>
<button class="btn-package" onclick="submitCustomPackage()" style="padding: 18px 48px;">Request Custom Quote →</button>
</div>
<div id="selectedServicesList" style="margin-top: 24px; padding-top: 24px; border-top: 1px solid rgba(255,255,255,0.06); display: none;">
<div style="font-size: 12px; color: var(--gray); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">Selected Services:</div>
<div id="selectedServicesDisplay" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
</div>
</div>
</div>
</div>
</section>

<style>
            .custom-service-item { display: flex; align-items: center; gap: 12px; background: #0c0c0c; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 16px 18px; cursor: pointer; transition: all 0.25s ease; }
            .custom-service-item:hover { border-color: rgba(255,255,255,0.3); background: rgba(255,255,255,0.04); transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
            .custom-service-item.selected { border-color: var(--red); background: rgba(255,59,48,0.12); box-shadow: 0 0 20px rgba(255,59,48,0.2); }
            .custom-service-item.selected:hover { background: rgba(255,59,48,0.18); }
            .custom-service-item input { display: none; }
            .custom-service-item .checkmark { width: 22px; height: 22px; border: 2px solid rgba(255,255,255,0.25); border-radius: 6px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
            .custom-service-item:hover .checkmark { border-color: rgba(255,255,255,0.4); }
            .custom-service-item.selected .checkmark { background: var(--red); border-color: var(--red); }
            .custom-service-item.selected .checkmark::after { content: '✓'; color: #fff; font-size: 13px; font-weight: 700; }
            .custom-service-item .service-name { flex: 1; font-size: 14px; font-weight: 600; color: rgba(255,255,255,0.95); }
            .custom-service-item .service-price { font-size: 14px; font-weight: 800; color: var(--red); }
            .custom-service-item.selected .service-name { color: #fff; }
            .selected-service-tag { background: rgba(255,59,48,0.2); border: 1px solid rgba(255,59,48,0.4); color: #fff; font-size: 11px; padding: 8px 14px; border-radius: 6px; font-weight: 600; }
</style>


<script>
function filterServices(tag) {
    var sections = document.querySelectorAll('#servicesView .package-section[data-svc-filter]');
    var backBtn  = document.getElementById('svcBackBtn');
    var cards    = document.querySelectorAll('.svc-prob-card');

    if (tag === 'all') {
        // Reset: show all, remove spotlight, hide print section
        sections.forEach(function(s) {
            s.style.opacity   = '';
            s.style.transform = '';
            s.style.transition = '';
            s.classList.remove('pkg-filtered-out');
            if (s.dataset.svcFilter === 'print') { s.style.display = 'none'; }
            else { s.style.display = ''; }
        });
        if (backBtn) { backBtn.classList.remove('visible'); }
        cards.forEach(function(c) { c.classList.remove('active'); });
        return;
    }

    // Spotlight: matching sections full opacity, others dimmed to 30%
    sections.forEach(function(s) {
        var filters = (s.dataset.svcFilter || '').split(',').map(function(v){ return v.trim(); });
        var isMatch = filters.indexOf(tag) !== -1;
        s.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        s.classList.remove('pkg-filtered-out');
        if (isMatch) {
            s.style.display  = '';
            s.style.opacity  = '1';
            s.style.transform = 'none';
        } else {
            // Keep visible but dimmed — user can still scroll to them
            s.style.display  = '';
            s.style.opacity  = '0.28';
            s.style.transform = 'scale(0.99)';
        }
    });

    if (backBtn) { backBtn.classList.add('visible'); }
    cards.forEach(function(c) { c.classList.toggle('active', c.dataset.filter === tag || c.dataset.filter === tag + ',established' || c.dataset.filter === 'new-business,' + tag); });

    // Scroll to first matching section
    var first = null;
    sections.forEach(function(s) {
        if (!first) {
            var filters = (s.dataset.svcFilter || '').split(',').map(function(v){ return v.trim(); });
            if (filters.indexOf(tag) !== -1) { first = s; }
        }
    });
    if (first) {
        setTimeout(function() { first.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 80);
    }
}
</script>
<section class="cta-section"><h2>HAVE <span>QUESTIONS?</span></h2><p>Book a free strategy call and we'll help you figure out exactly what your business needs.</p><button class="btn-white" onclick="startServiceIntake('consultation')">Book Free Consultation</button></section>
        ${getFooterHTML()}
    `;
}

// Custom Package Builder Functions
function toggleCustomService(event, el) {
    event.preventDefault();
    event.stopPropagation();
    el.classList.toggle('selected');
    const input = el.querySelector('input');
    if (input) input.checked = el.classList.contains('selected');
    updateCustomPackageTotal();
}

function updateCustomPackageTotal() {
    const selected = document.querySelectorAll('.custom-service-item.selected');
    let total = 0;
    let services = [];
    selected.forEach(item => {
        const input = item.querySelector('input');
        total += parseInt(input.dataset.price);
        services.push(input.dataset.service);
    });
    document.getElementById('customPackageTotal').textContent = '$' + total.toLocaleString();
    document.getElementById('selectedServicesCount').textContent = selected.length + ' service' + (selected.length !== 1 ? 's' : '') + ' selected';
    const listEl = document.getElementById('selectedServicesList');
    const displayEl = document.getElementById('selectedServicesDisplay');
    if (services.length > 0) {
        listEl.style.display = 'block';
        displayEl.innerHTML = services.map(s => '<span class="selected-service-tag">' + s + '</span>').join('');
    } else {
        listEl.style.display = 'none';
    }
}

function submitCustomPackage() {
    try {
        const selected = document.querySelectorAll('.custom-service-item.selected');
        if (selected.length === 0) {
            alert('Please select at least one service to continue.');
            return;
        }
        let services = [];
        let total = 0;
        selected.forEach(item => {
            const input = item.querySelector('input');
            services.push(input.dataset.service);
            total += parseInt(input.dataset.price);
        });
        localStorage.setItem('customPackageServices', JSON.stringify(services));
        localStorage.setItem('customPackageTotal', total.toString());
        console.log('Submitting custom package:', services, total);
        startServiceIntake('custom-package');
    } catch (e) {
        console.error('Error in submitCustomPackage:', e);
        alert('Error: ' + e.message);
    }
}

// ==================== PORTFOLIO VIEW ====================
// Default portfolio data — used as fallback when localStorage is empty or has broken refs
var _defaultPortfolio = [
    { id: 'good-cakes', name: 'Good Cakes and Bakes', tag: 'Brand Identity + Web', desc: 'Complete brand transformation for Detroit\'s favorite bakery', mission: 'To bring joy to Detroit one delicious bake at a time, crafting memories with every bite.', slogan: 'Baked with Love, Served with Soul', websiteUrl: 'https://goodcakesandbakes.com', img: 'https://images.unsplash.com/photo-1558961363-fa8fdf82db35?w=800', colors: ['#D4A574', '#2C1810', '#F5E6D3', '#8B4513'], fonts: { heading: 'Playfair Display', body: 'Lato' }, assets: { primaryLogo: 'https://images.unsplash.com/photo-1558961363-fa8fdf82db35?w=400', secondaryLogo: '', iconMark: '', mockups: [] }, results: { revenue: '+340%', traffic: '+520%', engagement: '+280%' }, testimonial: { text: 'NUI transformed our small bakery into a recognized Detroit brand. Our online orders tripled within 3 months!', author: 'Sarah Mitchell', title: 'Owner' } },
    { id: 'motor-city', name: 'Cloud nine', tag: 'Web Design + Marketing', desc: 'Culinary excellence meets digital sophistication', mission: 'Elevating Detroit\'s culinary scene with innovative cuisine and exceptional hospitality.', slogan: 'Where Detroit Dines Different', websiteUrl: '', img: 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=800', colors: ['#1A1A2E', '#C4A35A', '#F0F0F0', '#2C2C54'], fonts: { heading: 'Cormorant Garamond', body: 'Montserrat' }, assets: { primaryLogo: 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=400', secondaryLogo: '', iconMark: '', mockups: [] }, results: { revenue: '+280%', traffic: '+410%', engagement: '+190%' }, testimonial: { text: 'The website they built us is stunning. Reservations are up 200% and we\'re now booked weeks in advance.', author: 'Marcus Johnson', title: 'Executive Chef' } },
    { id: 'detroit-canvas', name: 'Jos Gallerry Art Gallery', tag: 'Social Media + Video', desc: 'Art meets commerce with scroll-stopping content', mission: 'Empowering artists to share their vision and build sustainable creative businesses.', slogan: 'Your Art. Your Story. Your Canvas.', websiteUrl: '', img: 'https://images.unsplash.com/photo-1513364776144-60967b0f800f?w=800', colors: ['#FF6B6B', '#4ECDC4', '#1A1A1A', '#F8F8F8'], fonts: { heading: 'Bebas Neue', body: 'Open Sans' }, assets: { primaryLogo: 'https://images.unsplash.com/photo-1513364776144-60967b0f800f?w=400', secondaryLogo: '', iconMark: '', mockups: [] }, results: { revenue: '+190%', traffic: '+680%', engagement: '+450%' }, testimonial: { text: 'Our Instagram went from 2K to 50K followers. The content they create is absolutely fire.', author: 'Jamal Greene', title: 'Founder' } },
    { id: 'ascend-coaching', name: 'Aj VIP', tag: 'Funnels + Automation', desc: 'Lead generation systems that convert 24/7', mission: 'Helping entrepreneurs unlock their potential and build thriving businesses through expert coaching.', slogan: 'Rise. Lead. Succeed.', websiteUrl: '', img: 'https://images.unsplash.com/photo-1571902943202-507ec2618e8f?w=800', colors: ['#2D3436', '#00B894', '#FDFDFD', '#636E72'], fonts: { heading: 'Poppins', body: 'Inter' }, assets: { primaryLogo: 'https://images.unsplash.com/photo-1571902943202-507ec2618e8f?w=400', secondaryLogo: '', iconMark: '', mockups: [] }, results: { revenue: '+520%', traffic: '+310%', engagement: '+240%' }, testimonial: { text: 'The funnel they built generates leads while I sleep. Best investment I ever made for my business.', author: 'Sarah Chen', title: 'CEO' } }
];

// Load from localStorage, merge names from defaults, and fix broken image refs
var _storedPortfolio = null;
try { _storedPortfolio = JSON.parse(localStorage.getItem('nui_portfolio')); } catch(e) {}

let portfolioData;
if (_storedPortfolio && _storedPortfolio.length > 0) {
    // Use stored data but fix broken idb:// and [too-large] image refs
    portfolioData = _storedPortfolio.map(function(item, idx) {
        var fallback = _defaultPortfolio[idx] || _defaultPortfolio[0];
        // Fix hero image: replace idb:// or empty with fallback
        if (!item.img || item.img.startsWith('idb://') || item.img === '[too-large]') {
            item.img = fallback.img;
        }
        // Fix asset images
        if (item.assets) {
            ['primaryLogo', 'secondaryLogo', 'iconMark'].forEach(function(k) {
                if (item.assets[k] && (item.assets[k].startsWith('idb://') || item.assets[k] === '[too-large]')) {
                    item.assets[k] = (fallback.assets && fallback.assets[k]) ? fallback.assets[k] : '';
                }
            });
            if (item.assets.mockups) {
                item.assets.mockups = item.assets.mockups.map(function(m) {
                    return (m && (m.startsWith('idb://') || m === '[too-large]')) ? '' : m;
                });
            }
        }
        // Sync names from defaults (so admin updates propagate)
        if (fallback && item.id === fallback.id) {
            item.name = fallback.name;
        }
        return item;
    });
} else {
    portfolioData = JSON.parse(JSON.stringify(_defaultPortfolio));
}

// Lightweight cloud sync — fetch portfolio from Supabase database via Netlify function
// This ensures ALL visitors (not just admin users) see real portfolio images
(function() {
    var SYNC_URL = '/.netlify/functions/sync-data?type=all';
    fetch(SYNC_URL)
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(result) {
            if (!result || !result.success || !result.syncData) return;
            var cloudData = result.syncData.portfolio && result.syncData.portfolio.data;
            if (!Array.isArray(cloudData) || cloudData.length === 0) return;
            // Fix any broken image refs using defaults as fallback
            cloudData.forEach(function(item, idx) {
                var fallback = _defaultPortfolio[idx] || _defaultPortfolio[0];
                if (!item.img || item.img.startsWith('idb://') || item.img === '[too-large]') {
                    item.img = fallback.img;
                }
                if (item.assets) {
                    ['primaryLogo','secondaryLogo','iconMark'].forEach(function(k) {
                        if (item.assets[k] && (item.assets[k].startsWith('idb://') || item.assets[k] === '[too-large]')) {
                            item.assets[k] = (fallback.assets && fallback.assets[k]) ? fallback.assets[k] : '';
                        }
                    });
                }
            });
            // Only update if cloud data has different images
            var oldImgs = portfolioData.map(function(p) { return p.img; }).join('|');
            var newImgs = cloudData.map(function(p) { return p.img; }).join('|');
            if (oldImgs !== newImgs) {
                portfolioData = cloudData;
                try { localStorage.setItem('nui_portfolio', JSON.stringify(portfolioData)); } catch(e) {}
                if (typeof _refreshHomepageCaseStudies === 'function') {
                    _refreshHomepageCaseStudies();
                }
                console.log('✅ Portfolio synced from cloud for all visitors');
            }
        })
        .catch(function() { /* silent fail — defaults already showing */ });
})();

function savePortfolio() {
    try {
        localStorage.setItem('nui_portfolio', JSON.stringify(portfolioData));
    } catch(e) {
        if (e.name === 'QuotaExceededError') {
            console.warn('Portfolio save hit storage limit, compressing...');
            const saveData = JSON.parse(JSON.stringify(portfolioData));
            saveData.forEach(p => {
                if (p.img && p.img.startsWith('data:') && p.img.length > 80000) p.img = '[too-large]';
                if (p.assets) {
                    ['primaryLogo','secondaryLogo','iconMark'].forEach(k => {
                        if (p.assets[k] && p.assets[k].startsWith('data:') && p.assets[k].length > 80000) p.assets[k] = '[too-large]';
                    });
                    if (p.assets.mockups) {
                        p.assets.mockups = p.assets.mockups.map(m => (m.startsWith('data:') && m.length > 80000) ? '[too-large]' : m);
                    }
                }
            });
            try {
                localStorage.setItem('nui_portfolio', JSON.stringify(saveData));
            } catch(e2) {
                alert('Storage full! Use image URLs instead of file uploads for portfolio images, or clear old data from other panels.');
            }
        }
    }
    // Sync to Supabase cloud so all devices see changes
    if (window.NuiPortfolioSync) {
        NuiPortfolioSync.save(portfolioData);
    }
    // Also push to backend sync for cross-device hydration
    const portfolioSyncData = portfolioData.map(p => {
        const clone = Object.assign({}, p);
        // Strip oversized base64 from sync payload
        if (clone.img && clone.img.startsWith('data:') && clone.img.length > 80000) clone.img = '[too-large]';
        if (clone.assets) {
            ['primaryLogo','secondaryLogo','iconMark'].forEach(k => {
                if (clone.assets[k] && clone.assets[k].startsWith('data:') && clone.assets[k].length > 80000) clone.assets[k] = '[too-large]';
            });
        }
        return clone;
    });
    _pushToBackend('portfolio', portfolioSyncData);
}

// ==================== ABOUT PAGE DATA ====================
let aboutData = JSON.parse(localStorage.getItem('nui_about')) || {
    storyImage: '',
    team: [
        { name: 'Faren Young', title: 'Creative Director & Founder', bio: 'Native Detroiter with 20+ years guiding businesses to success through bold design and strategic branding.', photo: '' },
        { name: 'Creative Team', title: 'Design & Development', bio: 'A network of skilled designers, developers, and strategists ready to bring your vision to life.', photo: '/images/creative-team.png' },
        { name: 'Matt', title: 'Mobile Developer', bio: 'Full-stack mobile developer crafting seamless iOS and Android experiences with pixel-perfect precision.', photo: '' },
        { name: 'Michelle', title: 'UI/UX Designer', bio: 'Bringing warmth and intuition to every interface. Michelle turns complex workflows into delightful user experiences.', photo: '' },
        { name: 'You?', title: 'Join Our Team', bio: 'We\'re always looking for talented creatives who share our passion for bold design.', photo: '' }
    ]
};
function saveAbout() {
    localStorage.setItem('nui_about', JSON.stringify(aboutData));
    _pushToBackend('about', aboutData);
}

function loadPortfolioView() {
    document.getElementById('portfolioView').innerHTML = `
<style>
            /* PORTFOLIO CARDS GRID */
            .portfolio-cards-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 32px; margin-bottom: 60px; }
            .portfolio-preview-card { position: relative; border-radius: 24px; overflow: hidden; cursor: pointer; transition: all 0.4s ease; box-shadow: 0 20px 60px rgba(0,0,0,0.4); }
            .portfolio-preview-card:hover { transform: translateY(-8px); box-shadow: 0 30px 80px rgba(0,0,0,0.6); }
            .portfolio-card-image { width: 100%; aspect-ratio: 16/10; object-fit: cover; display: block; }
            .portfolio-card-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.6) 40%, rgba(0,0,0,0.3) 100%); display: flex; flex-direction: column; justify-content: flex-end; padding: 32px; }
            .portfolio-card-tag { font-size: 11px; text-transform: uppercase; letter-spacing: 2px; font-weight: 600; margin-bottom: 12px; }
            .portfolio-card-title { font-size: 28px; font-weight: 800; margin-bottom: 12px; line-height: 1.2; }
            .portfolio-card-desc { font-size: 14px; color: rgba(255,255,255,0.7); line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
            .portfolio-card-btn { margin-top: 20px; display: inline-flex; align-items: center; gap: 8px; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: #fff; opacity: 0; transform: translateY(10px); transition: all 0.3s; }
            .portfolio-preview-card:hover .portfolio-card-btn { opacity: 1; transform: translateY(0); }

            /* CASE STUDY EXPANDED */
            .case-study { background: #080808; border: 1px solid rgba(255,255,255,0.06); border-radius: 8px; margin-bottom: 32px; overflow: hidden; display: none; }
            .case-study.open { display: block; }
            .case-header { display: flex; align-items: center; justify-content: space-between; padding: 32px 40px; cursor: pointer; transition: all 0.3s; position: relative; background: rgba(0,0,0,0.4); }
            .case-header::before { display: none; }
            .case-header:hover { background: rgba(255,255,255,0.02); }
            .case-header-left { display: flex; align-items: center; gap: 24px; position: relative; z-index: 1; }
            .case-logo { width: 64px; height: 64px; border-radius: 6px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
            .case-logo img { width: 100%; height: 100%; object-fit: cover; }
            .case-info h3 { font-size: 24px; font-weight: 800; margin-bottom: 6px; letter-spacing: -0.5px; }
            .case-info .tag { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: rgba(255,255,255,0.7); font-size: 10px; padding: 4px 12px; border-radius: 4px; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 600; }
            .case-toggle { width: 40px; height: 40px; border: 1px solid rgba(255,255,255,0.15); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: all 0.3s; position: relative; z-index: 1; }
            .case-study.open .case-toggle { border-color: rgba(255,255,255,0.3); background: rgba(255,255,255,0.05); }

            @media (max-width: 968px) {
                .portfolio-cards-grid { grid-template-columns: 1fr; gap: 24px; }
                .portfolio-card-title { font-size: 22px; }
                .portfolio-card-overlay { padding: 24px; }
            }
            @media (max-width: 580px) {
                .portfolio-cards-grid { gap: 16px; }
                .portfolio-card-title { font-size: 18px; }
                .portfolio-card-desc { font-size: 12px; }
                .portfolio-card-overlay { padding: 20px; }
            }
            .case-content { max-height: 0; overflow: hidden; transition: max-height 0.8s ease; }
            .case-study.open .case-content { max-height: 8000px; }
            .case-tabs { display: flex; border-bottom: 1px solid rgba(255,255,255,0.06); padding: 0 40px; background: rgba(0,0,0,0.5); }
            .case-tab { padding: 16px 28px; font-size: 11px; font-weight: 700; color: rgba(255,255,255,0.35); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.3s; text-transform: uppercase; letter-spacing: 2px; }
            .case-tab:hover { color: rgba(255,255,255,0.6); }
            .case-tab.active { color: #fff; border-color: currentColor; }
            .case-panels { padding: 0; }
            .case-panel { display: none; animation: fadeIn 0.4s ease; }
            .case-panel.active { display: block; }
            .brand-section { margin-bottom: 56px; }
            .brand-section-title { font-size: 11px; color: var(--red); text-transform: uppercase; letter-spacing: 3px; font-weight: 700; margin-bottom: 32px; display: flex; align-items: center; gap: 12px; }
            .brand-section-title::after { content: ''; flex: 1; height: 1px; background: linear-gradient(90deg, rgba(255,59,48,0.3), transparent); }
            .logo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
            .logo-box { background: #080808; border: 1px solid rgba(255,255,255,0.06); border-radius: 6px; padding: 0; text-align: center; transition: all 0.3s; aspect-ratio: 4/3; display: flex; flex-direction: column; overflow: hidden; }
            .logo-box:hover { border-color: rgba(255,255,255,0.12); transform: scale(1.01); }
            .logo-box-label { font-size: 10px; color: rgba(255,255,255,0.4); text-transform: uppercase; letter-spacing: 2px; padding: 12px 16px; background: rgba(0,0,0,0.9); font-weight: 600; position: absolute; bottom: 0; left: 0; right: 0; z-index: 2; }
            .logo-box-img { flex: 1; display: flex; align-items: center; justify-content: center; padding: 0; position: relative; background: #080808; }
            .logo-box-img img { width: 100%; height: 100%; object-fit: contain; padding: 20px; }
            .logo-placeholder { width: 100%; height: 100%; background: #080808; border: none; border-radius: 0; display: flex; align-items: center; justify-content: center; color: rgba(255,255,255,0.1); font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
            .color-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
            .color-box { aspect-ratio: 1; border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; padding: 12px; position: relative; overflow: hidden; }
            .color-box::before { content: ''; position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.7), transparent); }
            .color-hex { position: relative; font-size: 11px; font-weight: 700; color: #fff; letter-spacing: 1px; }
            .font-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
            .font-box { background: #fff; border: 1px solid rgba(0,0,0,0.08); border-radius: 8px; padding: 32px; }
            .font-label { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 16px; }
            .font-name { font-size: 36px; font-weight: 700; margin-bottom: 8px; color: #000; }
            .font-sample { color: #333; font-size: 14px; line-height: 1.6; }
            .mockup-grid { display: flex; flex-direction: column; gap: 16px; }
            .mockup-row { display: grid; gap: 16px; }
            .mockup-row.full { grid-template-columns: 1fr; }
            .mockup-row.split { grid-template-columns: 1fr 1fr; }
            .mockup-box { background: #080808; border: 1px solid rgba(255,255,255,0.06); border-radius: 6px; overflow: hidden; position: relative; transition: all 0.3s ease; }
            .mockup-box.wide { aspect-ratio: 16/9; }
            .mockup-box.tall { aspect-ratio: 4/5; }
            .mockup-box:hover { transform: scale(1.01); border-color: rgba(255,255,255,0.12); }
            .mockup-box img, .mockup-box video { width: 100%; height: 100%; object-fit: cover; }
            .mockup-box::after { display: none; }
            .mockup-placeholder { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: rgba(255,255,255,0.12); font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 2px; gap: 10px; background: #080808; }
            .mockup-placeholder::before { content: '+'; width: 32px; height: 32px; border: 1px solid rgba(255,255,255,0.08); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 18px; color: rgba(255,255,255,0.1); }
            .results-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
            .result-card { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 48px 32px; text-align: center; position: relative; overflow: hidden; }
            .result-card::before { display: none; }
            .result-number { font-size: 64px; font-weight: 900; position: relative; }
            .result-label { font-size: 11px; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 3px; margin-top: 12px; position: relative; }
            .website-preview { border-radius: 8px; overflow: hidden; border: 1px solid rgba(255,255,255,0.08); }
            .website-preview img { width: 100%; display: block; }
            .testimonial-box { background: rgba(0,0,0,0.3); border-left: 3px solid; padding: 48px; border-radius: 0 8px 8px 0; }
            .testimonial-box p { font-size: 22px; font-style: italic; line-height: 1.7; margin-bottom: 32px; font-weight: 300; }
            .testimonial-author { display: flex; align-items: center; gap: 20px; }
            .testimonial-avatar { width: 48px; height: 48px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 700; }
            @media (max-width: 768px) {
                .case-study { border-radius: 6px; margin-bottom: 16px; }
                .case-header { padding: 20px; }
                .case-header-left { gap: 16px; }
                .case-logo { width: 48px; height: 48px; border-radius: 4px; }
                .case-info h3 { font-size: 16px; margin-bottom: 4px; }
                .case-info .tag { font-size: 9px; padding: 3px 8px; border-radius: 3px; }
                .case-toggle { width: 32px; height: 32px; font-size: 12px; border-radius: 4px; }
                .case-tabs { padding: 0 16px; }
                .case-tab { padding: 12px 14px; font-size: 9px; letter-spacing: 1px; }
                .brand-section { margin-bottom: 36px; }
                .brand-section-title { font-size: 9px; margin-bottom: 20px; }
                .logo-grid { grid-template-columns: 1fr !important; gap: 12px; }
                .logo-box { border-radius: 6px; aspect-ratio: 16/9; }
                .logo-box-label { font-size: 9px; padding: 10px 12px; }
                .logo-box-img img { padding: 16px; }
                .logo-placeholder { font-size: 9px; }
                .color-grid { grid-template-columns: repeat(2, 1fr) !important; gap: 8px; }
                .color-box { border-radius: 4px; }
                .color-hex { font-size: 9px; }
                .font-grid { grid-template-columns: 1fr !important; gap: 12px; }
                .font-box { padding: 20px; border-radius: 6px; }
                .font-label { font-size: 9px; }
                .font-name { font-size: 24px; }
                .font-sample { font-size: 11px; }
                .mockup-grid { gap: 12px; }
                .mockup-row.split { grid-template-columns: 1fr; gap: 12px; }
                .mockup-box { border-radius: 6px; }
                .mockup-box.tall { aspect-ratio: 16/9; }
                .mockup-placeholder { font-size: 10px; }
                .results-grid { grid-template-columns: 1fr !important; gap: 12px; }
                .result-card { padding: 24px; border-radius: 14px; }
                .result-number { font-size: 36px; }
                .result-label { font-size: 9px; letter-spacing: 2px; }
                .website-preview { border-radius: 10px; }
                .website-preview img { height: 200px; }
                .testimonial-box { padding: 24px; border-radius: 0 12px 12px 0; }
                .testimonial-box p { font-size: 16px; margin-bottom: 20px; }
                .testimonial-author { gap: 12px; }
                .testimonial-avatar { width: 40px; height: 40px; font-size: 16px; }
            }
</style>
<section class="section dark" style="padding-top: 160px;">
<div class="portfolio-header" style="text-align: center; margin-bottom: 80px;">
<div class="label" style="justify-content: center; margin-bottom: 24px;">Case Studies</div>
<h2 class="section-title">OUR <span class="red">WORK</span></h2>
<p class="section-subtitle" style="max-width: 600px; margin: 24px auto 0;">Explore our complete brand transformations. Click each case study to dive into the brand guide, website, results, and client testimonials.</p>
</div>
<div style="max-width: 1400px; margin: 0 auto; padding: 0 16px;">
                <!-- PORTFOLIO PREVIEW CARDS -->
<div class="portfolio-cards-grid">
                    ${portfolioData.map((p, i) => {
                        const imgIsIdb = p.img && p.img.startsWith('idb://');
                        return `
<div class="portfolio-preview-card" onclick="openPortfolioCase('${p.id}')" style="background: linear-gradient(145deg, ${p.colors[1] || '#0a0a0a'} 0%, #0a0a0a 100%); border: 1px solid ${p.colors[0]}30;">
<img loading="lazy" src="${imgIsIdb ? '' : ((p.img && p.img !== '[too-large]') ? p.img : '')}" data-idb-src="${p.img || ''}" alt="${p.name}" class="portfolio-card-image" onerror="this.style.display='none';var d=document.createElement('div');d.style.cssText='width:100%;aspect-ratio:16/10;background:linear-gradient(135deg,${(p.colors[1]||'#1a1a2e').replace(/'/g,'')},#0a0a0a);display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.15);font-size:48px;font-weight:900;';d.textContent='${p.name.charAt(0)}';this.parentElement.insertBefore(d,this);">
<div class="portfolio-card-overlay" style="background: linear-gradient(to top, ${p.colors[1] || '#000'}ee 0%, ${p.colors[1] || '#000'}99 30%, transparent 100%);">
<div class="portfolio-card-tag" style="color: ${p.colors[0]};">${p.tag}</div>
<div class="portfolio-card-title">${p.name}</div>
<div class="portfolio-card-desc">${p.desc}</div>
<div class="portfolio-card-btn" style="color: ${p.colors[0]};">View Case Study <span>→</span></div>
</div>
</div>`;
                    }).join('')}
</div>

                <!-- EXPANDED CASE STUDIES -->
                ${portfolioData.map((p, i) => `
<div class="case-study" id="case-${p.id}">
<div class="case-header" onclick="toggleCase('${p.id}')">
<div class="case-header-left">
<div class="case-logo"><img loading="lazy" src="${((p.assets?.primaryLogo || p.img || '') && !(p.assets?.primaryLogo || p.img || '').startsWith('idb://') && (p.assets?.primaryLogo || p.img || '') !== '[too-large]') ? (p.assets?.primaryLogo || p.img || '') : ''}" data-idb-src="${p.assets?.primaryLogo || p.img || ''}" alt="${p.name}" onerror="this.style.display='none';"></div>
<div class="case-info">
<h3>${p.name}</h3>
<span class="tag">${p.tag}</span>
</div>
</div>
<div class="case-toggle">✕</div>
</div>
<div class="case-content">
<div class="case-tabs">
<div class="case-tab active" onclick="switchCaseTab('${p.id}', 0, this)">Brand Guide</div>
<div class="case-tab" onclick="switchCaseTab('${p.id}', 1, this)">Website / Webapp</div>
<div class="case-tab" onclick="switchCaseTab('${p.id}', 2, this)">Results</div>
<div class="case-tab" onclick="switchCaseTab('${p.id}', 3, this)">Testimonial</div>
</div>
<div class="case-panels" style="padding: 0;">
                                <!-- BRAND HERO BANNER -->
<div class="brand-hero" style="width: 100%; min-height: 360px; background: linear-gradient(145deg, ${p.colors[1]} 0%, #050505 100%); position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; padding: 60px 40px;">
<div style="position: absolute; inset: 0; ${p.img && !p.img.startsWith('idb://') ? "background: url('" + p.img + "') center/cover;" : ''} opacity: 0.2;" ${p.img && p.img.startsWith('idb://') ? 'data-idb-bg="' + p.img + '"' : ''}></div>
<div style="position: absolute; inset: 0; background: linear-gradient(to bottom, transparent 0%, rgba(0,0,0,0.7) 100%);"></div>
<div style="position: relative; text-align: center; z-index: 1; max-width: 100%;">
<div style="font-size: 11px; text-transform: uppercase; letter-spacing: 4px; color: ${p.colors[0]}; margin-bottom: 16px; font-weight: 600;">${p.tag}</div>
<h2 style="font-size: clamp(32px, 7vw, 80px); font-weight: 900; text-transform: uppercase; letter-spacing: -2px; line-height: 1;">${p.name}</h2>
<p style="color: rgba(255,255,255,0.5); font-size: 15px; margin-top: 20px; max-width: 550px; margin-left: auto; margin-right: auto; line-height: 1.6;">${p.desc}</p>
</div>
<div style="position: absolute; bottom: 24px; left: 50%; transform: translateX(-50%); display: flex; gap: 6px;">
                                        ${p.colors.map(c => `<div style="width: 28px; height: 28px; border-radius: 4px; background: ${c}; border: 1px solid rgba(255,255,255,0.15);"></div>`).join('')}
</div>
</div>
<div class="case-panel active" data-case="${p.id}" data-panel="0" style="padding: 48px; background: linear-gradient(180deg, transparent 0%, ${p.colors[1]}10 100%);">
                                    <!-- MISSION & SLOGAN -->
                                    ${(p.slogan || p.mission) ? `
<div class="brand-section">
<div class="brand-section-title" style="color: ${p.colors[0]};">Brand Voice</div>
<div style="display: grid; grid-template-columns: ${p.slogan && p.mission ? '1fr 1fr' : '1fr'}; gap: 20px;">
                                            ${p.slogan ? `
<div style="background: #080808; border: 1px solid rgba(255,255,255,0.06); border-radius: 6px; padding: 32px;">
<div style="font-size: 10px; color: ${p.colors[0]}; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 16px; font-weight: 600;">Slogan</div>
<div style="font-size: 24px; font-weight: 700; line-height: 1.3; color: #fff;">"${p.slogan}"</div>
</div>` : ''}
                                            ${p.mission ? `
<div style="background: #080808; border: 1px solid rgba(255,255,255,0.06); border-radius: 6px; padding: 32px;">
<div style="font-size: 10px; color: ${p.colors[0]}; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 16px; font-weight: 600;">Mission Statement</div>
<div style="font-size: 16px; line-height: 1.7; color: rgba(255,255,255,0.7);">${p.mission}</div>
</div>` : ''}
</div>
</div>` : ''}
                                    <!-- LOGOS SECTION -->
<div class="brand-section">
<div class="brand-section-title" style="color: ${p.colors[0]};">Logo System</div>
<div class="logo-grid">
<div class="logo-box" style="border-color: ${p.colors[0]}20; position: relative;">
<div class="logo-box-img">${p.assets?.primaryLogo && p.assets.primaryLogo !== '[too-large]' ? `<img loading="lazy" src="${p.assets.primaryLogo.startsWith('idb://') ? '' : p.assets.primaryLogo}" data-idb-src="${p.assets.primaryLogo}" alt="Primary Logo" onerror="_applyImageFallback(this)">` : '<div class="logo-placeholder">No Logo</div>'}</div>
<div class="logo-box-label" style="background: rgba(0,0,0,0.8);">Primary Logo</div>
</div>
<div class="logo-box" style="border-color: ${p.colors[0]}20; position: relative;">
<div class="logo-box-img">${p.assets?.secondaryLogo && p.assets.secondaryLogo !== '[too-large]' ? `<img loading="lazy" src="${p.assets.secondaryLogo.startsWith('idb://') ? '' : p.assets.secondaryLogo}" data-idb-src="${p.assets.secondaryLogo}" alt="Secondary Logo" onerror="_applyImageFallback(this)">` : '<div class="logo-placeholder">No Logo</div>'}</div>
<div class="logo-box-label" style="background: rgba(0,0,0,0.8);">Secondary Logo</div>
</div>
<div class="logo-box" style="border-color: ${p.colors[0]}20; position: relative;">
<div class="logo-box-img">${p.assets?.iconMark && p.assets.iconMark !== '[too-large]' ? `<img loading="lazy" src="${p.assets.iconMark.startsWith('idb://') ? '' : p.assets.iconMark}" data-idb-src="${p.assets.iconMark}" alt="Icon Mark" onerror="_applyImageFallback(this)">` : '<div class="logo-placeholder">No Icon</div>'}</div>
<div class="logo-box-label" style="background: rgba(0,0,0,0.8);">Icon / Logo Mark</div>
</div>
</div>
</div>
                                    <!-- COLOR PALETTE -->
<div class="brand-section">
<div class="brand-section-title" style="color: ${p.colors[0]};">Color Palette</div>
<div class="color-grid">
                                            ${p.colors.map((c, idx) => `<div class="color-box" style="background: ${c};"><div class="color-hex">${c}</div></div>`).join('')}
</div>
</div>
                                    <!-- FONT SYSTEM -->
<div class="brand-section">
<div class="brand-section-title" style="color: ${p.colors[0]};">Font System</div>
<div class="font-grid">
<div class="font-box">
<div class="font-label">Heading Font</div>
<div class="font-name">${p.fonts?.heading || p.fonts?.[0] || 'Inter'}</div>
<div class="font-sample">ABCDEFGHIJKLMNOPQRSTUVWXYZ<br>abcdefghijklmnopqrstuvwxyz<br>0123456789</div>
</div>
<div class="font-box">
<div class="font-label">Body Font</div>
<div class="font-name">${p.fonts?.body || p.fonts?.[1] || 'Inter'}</div>
<div class="font-sample">The quick brown fox jumps over the lazy dog. Pack my box with five dozen liquor jugs.</div>
</div>
</div>
</div>
                                    <!-- BRAND MOCKUPS -->
<div class="brand-section">
<div class="brand-section-title" style="color: ${p.colors[0]};">Brand Mockups</div>
<div class="mockup-grid">
                                            <!-- Top 16:9 -->
<div class="mockup-row full">
<div class="mockup-box wide" style="border-color: ${p.colors[0]}15;">
                                                    ${p.assets?.mockups?.[0] ? (p.assets.mockups[0].includes('video') || p.assets.mockups[0].match(/\.(mp4|webm|mov|ogg)$/i) ? `<video src="${p.assets.mockups[0]}" autoplay muted loop playsinline style="width:100%;height:100%;object-fit:cover;"></video>` : `<img loading="lazy" src="${p.assets.mockups[0]}" alt="Mockup">`) : '<div class="mockup-placeholder">Image / Video</div>'}
</div>
</div>
                                            <!-- Middle two 4:5 -->
<div class="mockup-row split">
<div class="mockup-box tall" style="border-color: ${p.colors[0]}15;">
                                                    ${p.assets?.mockups?.[1] ? (p.assets.mockups[1].includes('video') || p.assets.mockups[1].match(/\.(mp4|webm|mov|ogg)$/i) ? `<video src="${p.assets.mockups[1]}" autoplay muted loop playsinline style="width:100%;height:100%;object-fit:cover;"></video>` : `<img loading="lazy" src="${p.assets.mockups[1]}" alt="Mockup">`) : '<div class="mockup-placeholder">Image / Video</div>'}
</div>
<div class="mockup-box tall" style="border-color: ${p.colors[0]}15;">
                                                    ${p.assets?.mockups?.[2] ? (p.assets.mockups[2].includes('video') || p.assets.mockups[2].match(/\.(mp4|webm|mov|ogg)$/i) ? `<video src="${p.assets.mockups[2]}" autoplay muted loop playsinline style="width:100%;height:100%;object-fit:cover;"></video>` : `<img loading="lazy" src="${p.assets.mockups[2]}" alt="Mockup">`) : '<div class="mockup-placeholder">Image / Video</div>'}
</div>
</div>
                                            <!-- Bottom 16:9 -->
<div class="mockup-row full">
<div class="mockup-box wide" style="border-color: ${p.colors[0]}15;">
                                                    ${p.assets?.mockups?.[3] ? (p.assets.mockups[3].includes('video') || p.assets.mockups[3].match(/\.(mp4|webm|mov|ogg)$/i) ? `<video src="${p.assets.mockups[3]}" autoplay muted loop playsinline style="width:100%;height:100%;object-fit:cover;"></video>` : `<img loading="lazy" src="${p.assets.mockups[3]}" alt="Mockup">`) : '<div class="mockup-placeholder">Image / Video</div>'}
</div>
</div>
</div>
</div>
</div>
<div class="case-panel" data-case="${p.id}" data-panel="1" style="padding: 48px; background: linear-gradient(180deg, transparent 0%, ${p.colors[1]}10 100%);">
<div class="website-preview" style="border-color: ${p.colors[0]}20; position: relative;">
<img loading="lazy" src="${p.img}" alt="${p.name} Website" style="width: 100%; height: 500px; object-fit: cover;">
                                        ${p.websiteUrl ? `<a href="${p.websiteUrl}" target="_blank" style="position: absolute; bottom: 24px; right: 24px; background: ${p.colors[0]}; color: #fff; padding: 14px 28px; border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 8px; transition: transform 0.2s;">Visit Site <span style="font-size: 18px;">→</span></a>` : ''}
</div>
<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 32px; flex-wrap: wrap; gap: 20px;">
<p style="color: var(--gray); line-height: 1.8; font-size: 16px; flex: 1; min-width: 280px;">We designed and developed a fully responsive, high-converting website/webapp that captures the essence of ${p.name}. The platform features custom functionality, seamless navigation, and is optimized for both desktop and mobile users.</p>
                                        ${p.websiteUrl ? `<a href="${p.websiteUrl}" target="_blank" style="background: transparent; border: 1px solid ${p.colors[0]}; color: ${p.colors[0]}; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 13px; white-space: nowrap;">${p.websiteUrl.replace('https://', '')}</a>` : ''}
</div>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 32px;">
<div style="aspect-ratio: 4/5; background: #080808; border: 1px solid rgba(255,255,255,0.06); border-radius: 6px; overflow: hidden; display: flex; align-items: center; justify-content: center;">
                                            ${p.assets?.webMockups?.[0] ? (p.assets.webMockups[0].includes('video') || p.assets.webMockups[0].match(/\\.(mp4|webm|mov|ogg)$/i) ? `<video src="${p.assets.webMockups[0]}" autoplay muted loop playsinline style="width:100%;height:100%;object-fit:cover;"></video>` : `<img loading="lazy" src="${p.assets.webMockups[0]}" alt="Web Mockup" style="width:100%;height:100%;object-fit:cover;">`) : `<div style="color: rgba(255,255,255,0.12); font-size: 14px;">Image / Video</div>`}
</div>
<div style="aspect-ratio: 4/5; background: #080808; border: 1px solid rgba(255,255,255,0.06); border-radius: 6px; overflow: hidden; display: flex; align-items: center; justify-content: center;">
                                            ${p.assets?.webMockups?.[1] ? (p.assets.webMockups[1].includes('video') || p.assets.webMockups[1].match(/\\.(mp4|webm|mov|ogg)$/i) ? `<video src="${p.assets.webMockups[1]}" autoplay muted loop playsinline style="width:100%;height:100%;object-fit:cover;"></video>` : `<img loading="lazy" src="${p.assets.webMockups[1]}" alt="Web Mockup" style="width:100%;height:100%;object-fit:cover;">`) : `<div style="color: rgba(255,255,255,0.12); font-size: 14px;">Image / Video</div>`}
</div>
</div>
</div>
<div class="case-panel" data-case="${p.id}" data-panel="2" style="padding: 48px; background: linear-gradient(180deg, transparent 0%, ${p.colors[1]}10 100%);">
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 48px;">
<div style="background: #080808; border: 1px solid rgba(255,255,255,0.06); border-radius: 6px; padding: 32px;">
<div style="font-size: 12px; text-transform: uppercase; letter-spacing: 2px; color: ${p.colors[0]}; margin-bottom: 16px; font-weight: 600;">Problem</div>
<p style="color: var(--gray); line-height: 1.8; font-size: 15px; margin: 0;">${p.problem || 'The client faced challenges with brand visibility, outdated digital presence, and difficulty reaching their target audience effectively.'}</p>
</div>
<div style="background: #080808; border: 1px solid rgba(255,255,255,0.06); border-radius: 6px; padding: 32px;">
<div style="font-size: 12px; text-transform: uppercase; letter-spacing: 2px; color: ${p.colors[0]}; margin-bottom: 16px; font-weight: 600;">Solution</div>
<p style="color: var(--gray); line-height: 1.8; font-size: 15px; margin: 0;">${p.solution || 'We developed a comprehensive brand strategy with modern visual identity, responsive web platform, and targeted digital marketing campaigns.'}</p>
</div>
</div>
<div style="font-size: 12px; text-transform: uppercase; letter-spacing: 2px; color: ${p.colors[0]}; margin-bottom: 24px; font-weight: 600;">Results</div>
<div class="results-grid">
<div class="result-card" style="border-color: ${p.colors[0]}30;"><div class="result-number" style="color: ${p.colors[0]};">${p.results.revenue}</div><div class="result-label">Revenue Growth</div></div>
<div class="result-card" style="border-color: ${p.colors[0]}30;"><div class="result-number" style="color: ${p.colors[0]};">${p.results.traffic}</div><div class="result-label">Web Traffic</div></div>
<div class="result-card" style="border-color: ${p.colors[0]}30;"><div class="result-number" style="color: ${p.colors[0]};">${p.results.engagement}</div><div class="result-label">Engagement</div></div>
</div>
</div>
<div class="case-panel" data-case="${p.id}" data-panel="3" style="padding: 48px; background: linear-gradient(180deg, transparent 0%, ${p.colors[1]}10 100%);">
<div class="testimonial-box" style="border-color: ${p.colors[0]};">
<p>"${p.testimonial.text}"</p>
<div class="testimonial-author">
<div class="testimonial-avatar" style="background: ${p.colors[0]};">${p.testimonial.author.charAt(0)}</div>
<div>
<div style="font-weight: 700;">${p.testimonial.author}</div>
<div style="color: var(--gray); font-size: 14px;">${p.testimonial.title}, ${p.name}</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
                `).join('')}
</div>
</section>
<section class="cta-section"><h2>READY TO BE<br>OUR NEXT SUCCESS?</h2><p>Let's create something legendary together.</p><button class="btn-white" onclick="scrollToContact()">Book Your Strategy Call</button></section>
        ${getFooterHTML()}
    `;
    // Resolve any idb:// image references
    setTimeout(resolveAllImages, 50);
}

function toggleCase(id) {
    const caseEl = document.getElementById('case-' + id);
    caseEl.classList.toggle('open');
    if (!caseEl.classList.contains('open')) {
        // Scroll back to the cards grid when closing
        document.querySelector('.portfolio-cards-grid').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

function openPortfolioCase(id) {
    // Close all other cases
    document.querySelectorAll('.case-study').forEach(c => c.classList.remove('open'));
    // Open the selected case
    const caseEl = document.getElementById('case-' + id);
    caseEl.classList.add('open');
    // Scroll to the case study
    setTimeout(() => {
        caseEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
}

function switchCaseTab(caseId, panelIndex, tabEl) {
    // Update tabs
    const tabs = tabEl.parentElement.querySelectorAll('.case-tab');
    tabs.forEach(t => t.classList.remove('active'));
    tabEl.classList.add('active');
    // Update panels
    const panels = document.querySelectorAll(`.case-panel[data-case="${caseId}"]`);
    panels.forEach(p => p.classList.remove('active'));
    panels[panelIndex].classList.add('active');
}

// ==================== PORTAL STYLES ====================
const portalStyles = `
<style>
.portal-login { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding-top: 80px; background: linear-gradient(135deg, #1a0a0a 0%, #000 100%); }
.login-box { max-width: 420px; width: 100%; padding: 48px; background: #111; border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; }
.login-tabs { display: flex; margin-bottom: 24px; border: 2px solid #333; border-radius: 8px; overflow: hidden; }
.login-tab { flex: 1; padding: 12px; border: none; background: #000; color: #fff; font-weight: 600; cursor: pointer; font-family: inherit; }
.login-tab.active { background: #fff; color: #000; }
.form-group { margin-bottom: 20px; }
.form-label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: rgba(255,255,255,0.9); }
.form-input { width: 100%; padding: 14px 16px; border: 1px solid rgba(255,255,255,0.2); background: #0a0a0a; color: #fff; font-size: 15px; border-radius: 8px; font-family: inherit; }
.form-input:focus { outline: none; border-color: var(--red); box-shadow: 0 0 0 3px rgba(255,0,0,0.1); }
.form-select { width: 100%; padding: 14px 16px; border: 1px solid rgba(255,255,255,0.2); background: #0a0a0a; color: #fff; font-size: 15px; border-radius: 8px; font-family: inherit; }
.form-textarea { width: 100%; padding: 14px 16px; border: 1px solid rgba(255,255,255,0.2); background: #0a0a0a; color: #fff; font-size: 15px; border-radius: 8px; font-family: inherit; min-height: 100px; resize: vertical; }
.admin-header { background: #0a0a0a; color: #fff; padding: 16px 32px; display: flex; justify-content: space-between; align-items: center; position: fixed; top: 76px; left: 0; right: 0; z-index: 100; border-bottom: 1px solid rgba(255,255,255,0.08); }
.admin-container { display: flex; padding-top: 132px; min-height: 100vh; background: #000; }
.admin-sidebar { width: 260px; background: #0a0a0a; border-right: 1px solid rgba(255,255,255,0.06); padding: 20px 16px; position: fixed; left: 0; top: 132px; bottom: 0; overflow-y: auto; }
.admin-nav { display: flex; flex-direction: column; gap: 4px; }
.admin-nav-group { margin-bottom: 20px; }
.admin-nav-label { display: block; font-size: 10px; font-weight: 700; letter-spacing: 1.5px; color: rgba(255,255,255,0.35); padding: 8px 12px; text-transform: uppercase; }
.admin-nav-link { display: block; padding: 10px 12px; color: rgba(255,255,255,0.6); cursor: pointer; border-radius: 8px; font-weight: 500; font-size: 13px; transition: all 0.2s; }
.admin-nav-link:hover { background: rgba(255,255,255,0.05); color: #fff; }
.admin-nav-link.active { background: rgba(255,0,0,0.15); color: var(--red); }
.admin-main { flex: 1; margin-left: 260px; padding: 32px; color: #fff; background: #000; min-width: 0; overflow-x: hidden; }
.admin-panel { display: none; }
.admin-panel.active { display: block; }
.panel-header { margin-bottom: 32px; }
.panel-title { font-size: 28px; font-weight: 800; margin-bottom: 8px; }
.panel-subtitle { color: rgba(255,255,255,0.5); font-size: 14px; }
.stat-cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 32px; }
.stat-card { background: var(--admin-card, #0a0a0a); padding: 24px; border-radius: 16px; border: 1px solid var(--admin-border, rgba(255,255,255,0.06)); transition: transform 0.2s, box-shadow 0.2s; }
.stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(255,0,0,0.1); }
.stat-card .num { font-size: 36px; font-weight: 800; color: var(--admin-text, #fff); }
.stat-card .lbl { color: var(--admin-text-muted, rgba(255,255,255,0.5)); font-size: 13px; margin-top: 4px; }
.stat-card.highlight { background: linear-gradient(135deg, rgba(255,0,0,0.15) 0%, rgba(255,0,0,0.05) 100%); border-color: rgba(255,0,0,0.2); }
.stat-card.highlight .num { color: var(--red); }
.card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
.client-card { background: var(--admin-card, #0a0a0a); border: 1px solid var(--admin-border, rgba(255,255,255,0.06)); border-radius: 16px; overflow: hidden; transition: all 0.3s; }
.client-card:hover { border-color: rgba(255,0,0,0.3); transform: translateY(-4px); box-shadow: 0 12px 32px rgba(255,0,0,0.1); }
.client-card-header { height: 100px; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 48px; font-weight: 700; }
.client-card-body { padding: 24px; }
.client-card-name { font-size: 18px; font-weight: 700; margin-bottom: 4px; color: var(--admin-text, #fff); }
.client-card-meta { font-size: 13px; color: var(--admin-text-muted, rgba(255,255,255,0.5)); margin-bottom: 16px; }
.client-card-btns { display: flex; gap: 8px; }
.client-card-btns button { flex: 1; padding: 10px; border: none; cursor: pointer; border-radius: 8px; font-weight: 600; font-family: inherit; font-size: 12px; transition: transform 0.2s; }
.client-card-btns button:hover { transform: scale(1.02); }
.order-card { background: var(--admin-card, #0a0a0a); border: 1px solid var(--admin-border, rgba(255,255,255,0.06)); border-radius: 16px; padding: 24px; margin-bottom: 16px; transition: border-color 0.2s; }
.order-card:hover { border-color: rgba(255,0,0,0.3); }
.order-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px; }
.order-title { font-size: 18px; font-weight: 700; color: #fff; }
.order-client { font-size: 13px; color: rgba(255,255,255,0.5); }
.order-status { padding: 6px 14px; border-radius: 100px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
.order-status.pending { background: rgba(245,158,11,0.2); color: #f59e0b; }
.order-status.in_progress { background: rgba(59,130,246,0.2); color: #3b82f6; }
.order-status.review { background: rgba(168,85,247,0.2); color: #a855f7; }
.order-status.delivered, .order-status.approved { background: rgba(16,185,129,0.2); color: #10b981; }
.order-status.revision { background: rgba(239,68,68,0.2); color: #ef4444; }
.order-details { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; padding: 16px 0; border-top: 1px solid rgba(255,255,255,0.06); border-bottom: 1px solid rgba(255,255,255,0.06); margin-bottom: 16px; }
.order-detail { text-align: center; }
.order-detail .val { font-size: 16px; font-weight: 700; color: #fff; }
.order-detail .lbl { font-size: 10px; color: rgba(255,255,255,0.4); text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; }
.progress-bar { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
.progress-fill { height: 100%; background: linear-gradient(90deg, var(--red) 0%, #ff6b6b 100%); transition: width 0.3s; }
.form-section { background: #0a0a0a; border: 1px solid rgba(255,255,255,0.06); border-radius: 16px; padding: 28px; margin-bottom: 24px; }
.form-section-title { font-size: 16px; font-weight: 700; margin-bottom: 20px; color: #fff; display: flex; align-items: center; gap: 10px; }
.form-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
/* Toggle Switch */
.switch { position: relative; display: inline-block; width: 50px; height: 26px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.2); transition: 0.3s; }
.slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: 0.3s; }
input:checked + .slider { background-color: #2ecc71; }
input:checked + .slider:before { transform: translateX(24px); }
.slider.round { border-radius: 26px; }
.slider.round:before { border-radius: 50%; }
.category-tabs { display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; }
.category-tab { padding: 10px 20px; border: 1px solid rgba(255,255,255,0.15); border-radius: 100px; background: transparent; color: rgba(255,255,255,0.7); font-size: 13px; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s; }
.category-tab:hover { border-color: rgba(255,255,255,0.3); color: #fff; }
.category-tab.active { background: var(--red); color: #fff; border-color: var(--red); }
.upload-zone { border: 2px dashed rgba(255,255,255,0.2); border-radius: 16px; padding: 48px; text-align: center; cursor: pointer; transition: all 0.2s; margin-bottom: 24px; background: rgba(255,255,255,0.02); }
.upload-zone:hover { border-color: var(--red); background: rgba(255,0,0,0.05); }
.upload-zone p { color: rgba(255,255,255,0.5); margin-bottom: 8px; }
.upload-zone span { color: var(--red); font-weight: 600; }
.assets-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 16px; }
.asset-card { background: #0a0a0a; border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; overflow: hidden; transition: all 0.2s; }
.asset-card:hover { border-color: rgba(255,0,0,0.3); }
.asset-preview { aspect-ratio: 1; background: rgba(255,255,255,0.03); display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 700; color: rgba(255,255,255,0.2); }
.asset-preview img { width: 100%; height: 100%; object-fit: cover; }
.asset-info { padding: 14px; }
.asset-name { font-size: 13px; font-weight: 600; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #fff; }
.asset-meta { font-size: 11px; color: rgba(255,255,255,0.4); }
/* Pipeline/Kanban Styles */
.pipeline-board { display: flex; gap: 16px; overflow-x: auto; padding-bottom: 16px; }
.pipeline-column { min-width: 280px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 16px; }
.pipeline-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.06); }
.pipeline-title { font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
.pipeline-count { background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 100px; font-size: 12px; font-weight: 600; }
.pipeline-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 10px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; }
.pipeline-card:hover { border-color: rgba(255,0,0,0.3); transform: translateY(-2px); }
.pipeline-card-name { font-weight: 600; margin-bottom: 4px; }
.pipeline-card-company { font-size: 12px; color: rgba(255,255,255,0.5); margin-bottom: 12px; }
.pipeline-card-value { font-size: 18px; font-weight: 700; color: var(--red); }
/* Project Tracker Styles */
.project-stages { display: flex; gap: 4px; margin-bottom: 24px; padding: 4px; background: rgba(255,255,255,0.03); border-radius: 12px; }
.project-stage { flex: 1; padding: 12px; text-align: center; font-size: 12px; font-weight: 600; border-radius: 8px; cursor: pointer; transition: all 0.2s; color: rgba(255,255,255,0.5); }
.project-stage.active { background: var(--red); color: #fff; }
.project-stage.completed { background: rgba(16,185,129,0.2); color: #10b981; }
/* Proof System Styles */
.proof-card { background: #0a0a0a; border: 1px solid rgba(255,255,255,0.06); border-radius: 16px; overflow: hidden; margin-bottom: 20px; }
.proof-preview { aspect-ratio: 16/9; background: rgba(255,255,255,0.03); display: flex; align-items: center; justify-content: center; position: relative; }
.proof-preview img { width: 100%; height: 100%; object-fit: contain; }
.proof-actions { position: absolute; bottom: 16px; right: 16px; display: flex; gap: 8px; }
.proof-content { padding: 24px; }
.proof-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
.proof-meta { font-size: 13px; color: rgba(255,255,255,0.5); margin-bottom: 16px; }
.proof-comments { border-top: 1px solid rgba(255,255,255,0.06); padding-top: 16px; }
.comment { background: rgba(255,255,255,0.03); border-radius: 8px; padding: 12px; margin-bottom: 8px; }
.comment-author { font-weight: 600; font-size: 13px; margin-bottom: 4px; }
.comment-text { font-size: 13px; color: rgba(255,255,255,0.7); }
/* Buttons */
.btn-admin { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer; font-family: inherit; transition: all 0.2s; }
.btn-admin.primary { background: var(--red); color: #fff; box-shadow: 0 4px 12px rgba(255,0,0,0.3); }
.btn-admin.primary:hover { background: #cc0000; transform: translateY(-1px); box-shadow: 0 6px 16px rgba(255,0,0,0.4); }
.btn-admin.secondary { background: var(--admin-card, rgba(255,255,255,0.1)); color: var(--admin-text, #fff); border: 1px solid var(--admin-border, rgba(255,255,255,0.1)); }
.btn-admin.secondary:hover { background: var(--admin-card-hover, rgba(255,255,255,0.15)); border-color: rgba(255,0,0,0.3); }
.btn-admin.success { background: rgba(16,185,129,0.2); color: #10b981; }
.btn-admin.success:hover { background: rgba(16,185,129,0.3); }
.btn-admin.danger { background: rgba(239,68,68,0.2); color: #ef4444; }
.btn-admin.danger:hover { background: rgba(239,68,68,0.3); }
/* Table Styles */
.data-table { width: 100%; border-collapse: collapse; }
.data-table th { text-align: left; padding: 14px 16px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: rgba(255,255,255,0.4); border-bottom: 1px solid rgba(255,255,255,0.06); }
.data-table td { padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.04); font-size: 14px; }
.data-table tr:hover { background: rgba(255,255,255,0.02); }
/* Image Upload Card */
.image-upload-card { background: #0a0a0a; border: 1px solid rgba(255,255,255,0.06); border-radius: 16px; overflow: hidden; }
.image-upload-preview { aspect-ratio: 16/9; background: rgba(255,255,255,0.03); display: flex; align-items: center; justify-content: center; position: relative; }
.image-upload-preview img { width: 100%; height: 100%; object-fit: cover; }
.image-upload-preview .placeholder { color: rgba(255,255,255,0.2); font-size: 48px; }
.image-upload-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; gap: 12px; opacity: 0; transition: opacity 0.2s; }
.image-upload-card:hover .image-upload-overlay { opacity: 1; }
.image-upload-info { padding: 16px; display: flex; justify-content: space-between; align-items: center; }
.image-upload-label { font-size: 14px; font-weight: 600; }
.image-upload-hint { font-size: 12px; color: rgba(255,255,255,0.4); }
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(8px); }
.modal-overlay.active { display: flex; animation: fadeIn 0.2s ease-out; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.modal { background: var(--admin-card, #111); border: 1px solid var(--admin-border, rgba(255,255,255,0.1)); border-radius: 20px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease-out; }
@keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
.modal-header { padding: 24px; border-bottom: 1px solid var(--admin-border, rgba(255,255,255,0.06)); display: flex; justify-content: space-between; align-items: center; }
.modal-title { font-size: 20px; font-weight: 700; color: var(--admin-text, #fff); }
.modal-close { width: 36px; height: 36px; border: none; background: rgba(255,255,255,0.1); border-radius: 50%; cursor: pointer; font-size: 20px; color: var(--admin-text, #fff); transition: all 0.2s; }
.modal-close:hover { background: rgba(255,0,0,0.2); color: var(--red); transform: rotate(90deg); }
.modal-body { padding: 24px; color: var(--admin-text, #fff); }
.modal-footer { padding: 24px; border-top: 1px solid rgba(255,255,255,0.06); display: flex; gap: 12px; justify-content: flex-end; }
.invoice-preview { background: #fff; border-radius: 12px; padding: 32px; color: #000; }
.invoice-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 32px; padding-bottom: 24px; border-bottom: 2px solid #000; }
.invoice-logo { font-size: 24px; font-weight: 800; color: var(--red); }
.invoice-title { font-size: 32px; font-weight: 700; text-align: right; }
.invoice-meta { font-size: 13px; color: #666; text-align: right; }
.invoice-parties { display: grid; grid-template-columns: 1fr 1fr; gap: 32px; margin-bottom: 32px; }
.invoice-party h4 { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
.invoice-party p { font-size: 14px; line-height: 1.6; }
.invoice-table { width: 100%; border-collapse: collapse; margin-bottom: 24px; }
.invoice-table th { text-align: left; padding: 12px; border-bottom: 2px solid #000; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; }
.invoice-table td { padding: 12px; border-bottom: 1px solid #e5e5e5; }
.invoice-total { text-align: right; font-size: 24px; font-weight: 700; margin-top: 16px; }
/* SEO Panel Styles */
.seo-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
.seo-card { background: #0a0a0a; border: 1px solid rgba(255,255,255,0.06); border-radius: 16px; padding: 24px; }
.seo-card-title { font-size: 14px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
.seo-score { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; }
.seo-score-circle { width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 800; }
.seo-score-circle.good { background: rgba(16,185,129,0.2); color: #10b981; }
.seo-score-circle.medium { background: rgba(245,158,11,0.2); color: #f59e0b; }
.seo-score-circle.bad { background: rgba(239,68,68,0.2); color: #ef4444; }
.faq-item { background: rgba(255,255,255,0.03); border-radius: 12px; padding: 16px; margin-bottom: 12px; }
.faq-question { font-weight: 600; margin-bottom: 8px; }
.faq-answer { font-size: 13px; color: rgba(255,255,255,0.6); }
/* Tags Input */
.tags-input { display: flex; flex-wrap: wrap; gap: 8px; padding: 12px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; min-height: 50px; }
.tag { display: inline-flex; align-items: center; gap: 6px; background: rgba(255,0,0,0.15); color: var(--red); padding: 6px 12px; border-radius: 100px; font-size: 12px; font-weight: 600; }
.tag-remove { cursor: pointer; opacity: 0.7; }
.tag-remove:hover { opacity: 1; }
.tags-input input { flex: 1; min-width: 120px; border: none; background: transparent; color: #fff; font-size: 14px; outline: none; }
@media (max-width: 968px) {
    .admin-sidebar { display: none; }
    .admin-main { margin-left: 0; padding: 20px; }
    .stat-cards { grid-template-columns: repeat(2, 1fr); }
    .form-row { grid-template-columns: 1fr; }
    .order-details { grid-template-columns: repeat(2, 1fr); }
    .seo-grid { grid-template-columns: 1fr; }
    .pipeline-board { flex-direction: column; }
    .pipeline-column { min-width: 100%; }
}

/* Timer Button Styles */
.timer-btn { transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; }
.timer-btn:hover { transform: scale(1.1); }
.timer-btn.active { animation: pulse-timer 1.5s infinite; }
@keyframes pulse-timer {
    0%, 100% { box-shadow: 0 0 0 0 rgba(230, 57, 70, 0.4); }
    50% { box-shadow: 0 0 0 8px rgba(230, 57, 70, 0); }
}

/* Stats Grid Enhancement */
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px; }
.stat-card { background: rgba(255,255,255,0.03); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06); }
.stat-label { font-size: 12px; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
.stat-value { font-size: 28px; font-weight: 700; color: #fff; }

/* Invoice Animation */
.invoice-line-item { animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

/* Payment Progress Bar */
.payment-progress { display: flex; gap: 4px; margin-top: 8px; }
.payment-progress-segment { height: 6px; border-radius: 3px; transition: all 0.3s ease; }
.payment-progress-segment.paid { background: #2a9d8f; }
.payment-progress-segment.pending { background: rgba(255,255,255,0.1); }

/* Smooth scrollbar for modals */
.modal-body::-webkit-scrollbar { width: 6px; }
.modal-body::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 3px; }
.modal-body::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
.modal-body::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }
</style>
`;

// ==================== BLOG VIEW ====================
let blogPosts = JSON.parse(localStorage.getItem('nui_blog_posts')) || [
    {
        id: 1,
        slug: 'why-ai-logo-design-will-destroy-your-brand',
        title: 'Why AI Logo Design Will Destroy Your Brand (And What Smart Business Owners Do Instead)',
        excerpt: 'That $20 AI logo might seem like a deal, but it\'s actually costing you thousands in lost revenue. Here\'s the truth about AI design tools.',
        category: 'Branding',
        image: 'https://images.unsplash.com/photo-1677442136019-21780ecad995?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'January 28, 2026',
        readTime: '8 min read',
        content: `
<p class="blog-lead">Every week, I get calls from business owners who "saved money" with an AI logo generator. Six months later, they're rebranding because customers don't take them seriously. Let me save you from becoming another cautionary tale.</p>

<h2>The AI Logo Trap</h2>
<p>Here's what the AI logo generators don't tell you: They're trained on existing logos. Which means your "unique" logo is actually a Frankenstein mashup of designs that already exist. You might be one cease-and-desist letter away from a complete rebrand.</p>

<p>I've seen it happen. A Detroit restaurant owner came to me after getting a legal notice that their AI-generated logo was too similar to a national chain. Cost them $15,000 in legal fees and emergency rebranding. That "$50 AI logo" ended up costing more than my premium package.</p>

<h2>What AI Can't Do</h2>
<p>AI doesn't understand your story. It can't capture the 3 AM moments that led you to start your business. It doesn't know your grandmother's recipe that inspired your menu, or the Detroit neighborhood that shaped who you are.</p>

<p>A real brand strategist asks questions AI never will:</p>
<ul>
<li>What emotion do you want customers to feel?</li>
<li>Who are your competitors and how do we differentiate?</li>
<li>What's your 5-year vision?</li>
<li>What story does your brand need to tell?</li>
</ul>

<h2>The Smart Money Move</h2>
<p>Invest in professional branding once. It costs more upfront but pays dividends forever. Nike didn't become Nike with a $20 logo. Apple didn't build a trillion-dollar company on clip art.</p>

<p>Your brand is the single most valuable asset you'll ever own. Treat it that way.</p>

<div class="blog-cta">
<h3>Ready to Build a Brand That Actually Works?</h3>
<p>Let's create something that makes your competition nervous.</p>
<a onclick="showView('services')" class="btn-cta">View Our Brand Packages</a>
</div>
        `
    },
    {
        id: 2,
        slug: 'emyth-revisited-lessons-for-detroit-entrepreneurs',
        title: 'The E-Myth Revisited: 5 Lessons Every Detroit Entrepreneur Needs to Hear',
        excerpt: 'Michael Gerber\'s classic business book changed how I run my agency. Here are the game-changing insights that apply to every small business owner.',
        category: 'Business Strategy',
        image: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'January 21, 2026',
        readTime: '10 min read',
        content: `
<p class="blog-lead">If you haven't read "The E-Myth Revisited" by Michael Gerber, stop everything and order it today. This book single-handedly transformed how I think about business — and it'll do the same for you.</p>

<h2>Lesson 1: You're Not Just a Technician</h2>
<p>Gerber's biggest insight: Most businesses are started by technicians who are good at their craft but have no idea how to run a business. A great chef opens a restaurant. A talented designer starts an agency. Sound familiar?</p>

<p>The problem? Being good at making food doesn't mean you're good at managing inventory, marketing, hiring, or financial planning. You need to develop three personalities: The Technician (does the work), The Manager (creates systems), and The Entrepreneur (builds the vision).</p>

<h2>Lesson 2: Work ON Your Business, Not IN It</h2>
<p>This is the one that hit me like a truck. I was working 80-hour weeks doing client work, but my business wasn't growing. Why? Because I never stepped back to build systems, create processes, or plan for scale.</p>

<p>Your business should be able to run without you grinding 24/7. If it can't, you don't have a business — you have a job you created for yourself.</p>

<h2>Lesson 3: The Franchise Prototype</h2>
<p>Gerber asks: "Could you franchise your business?" Not because you should, but because the question forces you to create documented systems for everything. Every process should be so clear that anyone could follow it.</p>

<h2>Lesson 4: Your Business is a Product</h2>
<p>Mind-blowing concept: Your business itself is the product, not just what you sell. You're building something that creates value independent of your daily involvement.</p>

<h2>Lesson 5: Start With the End in Mind</h2>
<p>What do you want your business to look like in 10 years? If you can't answer that clearly, you're building randomly. Every decision should move you toward that vision.</p>

<div class="blog-cta">
<h3>Need a Brand That Supports Your Vision?</h3>
<p>Let's build something that grows with your business.</p>
<a onclick="showView('services')" class="btn-cta">Explore Brand Packages</a>
</div>
        `
    },
    {
        id: 3,
        slug: 'how-nike-built-brand-empire',
        title: 'How Nike Built a $50 Billion Brand (And What Small Businesses Can Steal)',
        excerpt: 'Nike didn\'t become Nike by accident. Here\'s the branding playbook they used — and how you can apply the same principles to your business.',
        category: 'Brand Strategy',
        image: 'https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'January 14, 2026',
        readTime: '12 min read',
        content: `
<p class="blog-lead">Nike sells shoes. So does Payless. But Nike is worth $50 billion while Payless went bankrupt. The difference isn't the product — it's the brand. Let's break down exactly what Nike does differently.</p>

<h2>They Sell Identity, Not Products</h2>
<p>Nike doesn't sell running shoes. They sell the identity of being an athlete. "Just Do It" isn't about footwear — it's about who you become when you push past your limits.</p>

<p>Ask yourself: What identity are you selling? If your answer is "quality products at fair prices," you're already losing. That's a feature, not an identity.</p>

<h2>Emotional Storytelling Over Features</h2>
<p>When's the last time you saw a Nike ad talking about "breathable mesh uppers" or "responsive foam technology"? They don't lead with specs — they lead with stories.</p>

<p>Colin Kaepernick. Serena Williams. The kid from Detroit who became a champion. Nike tells stories that make you FEEL something. Your brand should do the same.</p>

<h2>Consistent Visual Identity Everywhere</h2>
<p>The Swoosh looks the same on a billboard in Tokyo as it does on a shoe tag in Detroit. That consistency builds recognition and trust. Every touchpoint reinforces the brand.</p>

<p>Is your Instagram consistent with your website? Does your business card match your storefront? Every inconsistency costs you credibility.</p>

<h2>Premium Positioning</h2>
<p>Nike charges more because they've earned the right to. But here's the secret: the premium positioning came BEFORE the premium prices. They built the brand first, then raised prices.</p>

<h2>What You Can Steal Today</h2>
<ul>
<li>Define the identity you're selling (not just the product)</li>
<li>Lead with emotion, support with logic</li>
<li>Audit every touchpoint for consistency</li>
<li>Position premium before pricing premium</li>
</ul>

<div class="blog-cta">
<h3>Ready to Build a Brand Like the Big Players?</h3>
<p>Let's create something that commands attention and premium prices.</p>
<a onclick="showView('services')" class="btn-cta">Start Your Brand Journey</a>
</div>
        `
    },
    {
        id: 4,
        slug: 'chris-do-futur-lessons-creative-business',
        title: 'What Chris Do and The Futur Taught Me About Running a Creative Business',
        excerpt: 'The Futur YouTube channel is a goldmine for creative entrepreneurs. Here are the biggest lessons that transformed my agency.',
        category: 'Business Growth',
        image: 'https://images.unsplash.com/photo-1552664730-d307ca884978?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'January 7, 2026',
        readTime: '9 min read',
        content: `
<p class="blog-lead">If you run a creative business and you're not watching The Futur, you're leaving money on the table. Chris Do's content has completely changed how I price, sell, and position my agency.</p>

<h2>Value-Based Pricing Changed Everything</h2>
<p>The Futur's biggest lesson: Stop charging for time, start charging for value. A logo that helps a company make an extra $500K is worth way more than the 20 hours it took to design.</p>

<p>When I switched to value-based pricing, my average project went from $1,500 to $4,500. Same work. Different conversation.</p>

<h2>The Discovery Call Framework</h2>
<p>Chris Do's approach to sales calls is pure gold. Instead of pitching, you're asking questions. Instead of convincing, you're qualifying. The client sells themselves on working with you.</p>

<p>Key questions I now ask every prospect:</p>
<ul>
<li>"What happens if you don't solve this problem?"</li>
<li>"What would success look like for this project?"</li>
<li>"What's the cost of staying where you are?"</li>
</ul>

<h2>Positioning as an Expert</h2>
<p>Stop being a "vendor" and become a "strategic partner." The Futur taught me to speak the language of business outcomes, not creative deliverables.</p>

<p>I don't sell "logo design" anymore. I sell "brand positioning that attracts premium customers." Same service, different value perception.</p>

<h2>Saying No to Bad Clients</h2>
<p>Not every dollar is a good dollar. The Futur community helped me realize that bad clients cost more than they pay. Now I have a qualification process that filters for fit.</p>

<div class="blog-cta">
<h3>Want to Work With an Agency That Gets Business?</h3>
<p>We speak your language and focus on results.</p>
<a onclick="scrollToContact()" class="btn-cta">Book a Strategy Call</a>
</div>
        `
    },
    {
        id: 5,
        slug: 'automation-ai-small-business-guide',
        title: 'AI and Automation: How Smart Small Businesses Are Winning in 2026',
        excerpt: 'AI isn\'t replacing businesses — it\'s amplifying the ones that use it right. Here\'s how to leverage automation without losing your soul.',
        category: 'Technology',
        image: 'https://images.unsplash.com/photo-1485827404703-89b55fcc595e?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'December 30, 2025',
        readTime: '11 min read',
        content: `
<p class="blog-lead">AI is the most overhyped AND underhyped technology of our generation. It won't replace you, but someone using AI might. Here's how to stay on the right side of that equation.</p>

<h2>Where AI Actually Helps</h2>
<p>Let's be real: AI is incredible for certain tasks. Email automation, appointment scheduling, data analysis, content repurposing, customer service bots — these are legitimate time-savers.</p>

<p>I use AI tools for:</p>
<ul>
<li>Scheduling and calendar management</li>
<li>First-draft email responses</li>
<li>Social media scheduling</li>
<li>Data analysis and reporting</li>
<li>Research and competitive analysis</li>
</ul>

<h2>Where AI Falls Short</h2>
<p>Strategy. Creativity. Emotional intelligence. Understanding context. Building relationships. These are still human domains, and they're where the real value lives.</p>

<p>AI can write a blog post, but can it understand what your specific audience needs to hear right now? Can it capture your brand voice in a way that feels authentic? Not really.</p>

<h2>The Winning Formula</h2>
<p>Use AI to handle the 80% of tasks that are repetitive and time-consuming. Then invest that saved time into the 20% that actually moves the needle: strategy, relationships, and creative problem-solving.</p>

<h2>Automation Stack for Small Businesses</h2>
<ul>
<li><strong>CRM:</strong> Automate follow-ups and lead nurturing</li>
<li><strong>Email Marketing:</strong> Sequences that run while you sleep</li>
<li><strong>Social Media:</strong> Schedule content in batches</li>
<li><strong>Invoicing:</strong> Automatic payment reminders</li>
<li><strong>Booking:</strong> Calendly or similar for appointments</li>
</ul>

<div class="blog-cta">
<h3>Need a Website That Works While You Sleep?</h3>
<p>We build automated systems that turn visitors into customers.</p>
<a onclick="showView('services')" class="btn-cta">See Our Web Packages</a>
</div>
        `
    },
    {
        id: 6,
        slug: 'website-not-converting-seven-fixes',
        title: 'Your Website Isn\'t Converting. Here Are 7 Fixes That Actually Work.',
        excerpt: 'Getting traffic but no sales? Your website has a conversion problem. Here\'s exactly how to fix it.',
        category: 'Web Design',
        image: 'https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'December 23, 2025',
        readTime: '7 min read',
        content: `
<p class="blog-lead">"I'm getting traffic but no one's buying." I hear this every week. The problem isn't your product or your traffic — it's your website. Here are the fixes that work.</p>

<h2>1. Your Headline Doesn't Speak to Pain</h2>
<p>Most websites lead with "Welcome to [Business Name]!" No one cares. Lead with the problem you solve or the transformation you provide.</p>
<p><strong>Bad:</strong> "Welcome to Smith's Accounting Services"</p>
<p><strong>Good:</strong> "Stop Leaving Money on the Table at Tax Time"</p>

<h2>2. Too Many Choices</h2>
<p>When you give visitors 10 options, they choose none. Guide them to ONE clear action. What's the most important thing you want them to do? Make that obvious.</p>

<h2>3. No Social Proof</h2>
<p>People trust other people more than they trust you. Reviews, testimonials, case studies, logos of clients you've worked with — these build credibility fast.</p>

<h2>4. Slow Load Time</h2>
<p>Every second of load time costs you 7% of conversions. Test your site speed and optimize those images.</p>

<h2>5. Weak Call-to-Action</h2>
<p>"Submit" and "Learn More" are boring. Try "Get My Free Quote" or "Start Making Money." Action-oriented, benefit-driven CTAs convert.</p>

<h2>6. No Urgency</h2>
<p>Why should they act now instead of later? Limited-time offers, scarcity, and clear deadlines drive action.</p>

<h2>7. Mobile Experience Sucks</h2>
<p>60%+ of your traffic is on mobile. If your site isn't flawless on a phone, you're losing more than half your potential customers.</p>

<div class="blog-cta">
<h3>Ready for a Website That Actually Converts?</h3>
<p>We build sites that turn visitors into customers.</p>
<a onclick="showView('services')" class="btn-cta">See Website Packages</a>
</div>
        `
    },
    {
        id: 7,
        slug: 'richest-man-in-babylon-wealth-lessons',
        title: 'The Richest Man in Babylon: Timeless Wealth Lessons for Modern Entrepreneurs',
        excerpt: 'This 1926 classic still holds the secrets to building wealth. Here\'s how to apply ancient Babylonian wisdom to your business today.',
        category: 'Business Strategy',
        image: 'https://images.unsplash.com/photo-1579621970563-ebec7560ff3e?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'December 16, 2025',
        readTime: '11 min read',
        content: `
<p class="blog-lead">"The Richest Man in Babylon" by George S. Clason was written nearly 100 years ago, but its wisdom about wealth-building is more relevant than ever. If you run a business and haven't read it, you're missing foundational knowledge.</p>

<h2>Pay Yourself First (The 10% Rule)</h2>
<p>Arkad, the richest man in Babylon, built his fortune with one simple rule: "A part of all you earn is yours to keep." Before you pay rent, before you pay employees, before you buy that new equipment — pay yourself first.</p>

<p>Most business owners pay themselves last. They take whatever's "left over" after expenses. That's backwards. Set aside at least 10% of every dollar that comes into your business for wealth-building. This isn't optional — it's how fortunes are made.</p>

<h2>Make Your Money Work For You</h2>
<p>The Babylonians called this "putting your gold to work." Today we call it investing. But the principle is identical: money sitting idle is money wasted.</p>

<p>For business owners, this means:</p>
<ul>
<li>Reinvesting profits into growth</li>
<li>Building assets that generate passive income</li>
<li>Creating systems that work without you</li>
<li>Investing in education and skills</li>
</ul>

<h2>Guard Your Wealth From Loss</h2>
<p>"Guard thy treasures from loss by investing only where thy principal is safe." The Babylonians knew that getting rich slowly beats getting poor quickly.</p>

<p>Don't chase every shiny opportunity. Don't invest in things you don't understand. The first rule of wealth is: don't lose what you already have.</p>

<h2>Invest in Yourself</h2>
<p>"The more wisdom we know, the more we may earn." Your greatest investment is always your own skills and knowledge. A better brand strategist, a better salesperson, a better leader — these compound over decades.</p>

<h2>Take Action</h2>
<p>"Wealth, like a tree, grows from a tiny seed." You can't think your way to wealth. You have to plant seeds and nurture them. Start with what you have, where you are.</p>

<div class="blog-cta">
<h3>Ready to Invest in Your Brand?</h3>
<p>Your brand is an asset that appreciates over time.</p>
<a onclick="showView('services')" class="btn-cta">Build Your Brand Asset</a>
</div>
        `
    },
    {
        id: 8,
        slug: 'what-logo-design-actually-does',
        title: 'What Your Logo Is Actually For (And What It Can\'t Do)',
        excerpt: 'Your logo isn\'t going to save your business. But used correctly, it\'s one of your most powerful tools. Here\'s the truth about logo design.',
        category: 'Branding',
        image: 'https://images.unsplash.com/photo-1626785774625-ddcddc3445e9?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'December 9, 2025',
        readTime: '8 min read',
        content: `
<p class="blog-lead">I've had clients tell me they need a "better logo" to fix their struggling business. That's like saying you need better business cards to get more customers. Let's talk about what logos actually do — and don't do.</p>

<h2>What Your Logo IS For</h2>

<h3>1. Recognition & Memory</h3>
<p>Your logo is a visual shortcut. When someone sees the Nike swoosh, they don't need to read "Nike" — they already know. That instant recognition takes years to build, but it's incredibly valuable.</p>

<h3>2. Professionalism & Trust</h3>
<p>A polished logo signals that you're a legitimate operation. It's the difference between a handwritten sign and a professional storefront. First impressions matter.</p>

<h3>3. Consistency Across Touchpoints</h3>
<p>Your logo anchors your visual identity. It appears on your website, business cards, social media, packaging, signage, invoices — everywhere. It creates cohesion.</p>

<h3>4. Differentiation</h3>
<p>In a sea of competitors, your logo helps you stand out. It's a visual stake in the ground that says "this is who we are."</p>

<h2>What Your Logo CAN'T Do</h2>

<h3>It Can't Fix a Bad Product</h3>
<p>No amount of good design will save a product or service people don't want. Your logo is packaging, not the product itself.</p>

<h3>It Can't Replace Marketing</h3>
<p>A logo sitting on your computer does nothing. You need to get it in front of people consistently over time.</p>

<h3>It Can't Communicate Everything</h3>
<p>Your logo doesn't need to show what you do. Apple's logo isn't a computer. Nike's isn't a shoe. The meaning comes from the experiences people have with your brand.</p>

<h2>Where to Use Your Logo</h2>
<ul>
<li><strong>Primary:</strong> Website header, business cards, email signature</li>
<li><strong>Social:</strong> Profile pictures, cover images, watermarks</li>
<li><strong>Physical:</strong> Signage, packaging, uniforms, banners, decals</li>
<li><strong>Documents:</strong> Invoices, proposals, presentations</li>
</ul>

<div class="blog-cta">
<h3>Need a Logo That Works Everywhere?</h3>
<p>We create versatile logos built for real-world use.</p>
<a onclick="showView('services')" class="btn-cta">View Logo Packages</a>
</div>
        `
    },
    {
        id: 9,
        slug: 'brand-assets-attention-guide',
        title: '10 Ways to Use Your Brand Assets to Grab Attention (That Most Businesses Miss)',
        excerpt: 'You paid for brand assets. Now make them work. Here\'s how to leverage your logo, colors, and visual identity to stand out everywhere.',
        category: 'Brand Strategy',
        image: 'https://images.unsplash.com/photo-1561070791-2526d30994b5?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'December 2, 2025',
        readTime: '9 min read',
        content: `
<p class="blog-lead">Most businesses get their brand done and then... nothing. The logo sits on their website. The colors show up sometimes. The fonts are "whatever's available." Here's how to actually USE your brand assets to get attention.</p>

<h2>1. Own Your Color</h2>
<p>Coca-Cola red. Tiffany blue. T-Mobile magenta. These brands OWN their colors because they use them obsessively, consistently, everywhere. Pick your primary brand color and make it impossible to miss.</p>

<h2>2. Create Social Media Templates</h2>
<p>Every post should be instantly recognizable as yours. Create templates in your brand colors with your fonts. When someone's scrolling, your content should pop.</p>

<h2>3. Brand Your Physical Space</h2>
<p>If you have a storefront or office — brand it. Wall graphics, window decals, banners, vinyl signage. Turn every physical touchpoint into a billboard.</p>

<h2>4. Watermark Everything</h2>
<p>Your photos, videos, graphics — add a subtle watermark. When your content gets shared, your brand goes with it.</p>

<h2>5. Consistent Email Signatures</h2>
<p>Every email your team sends is a brand touchpoint. Professional email signatures with your logo, colors, and social links. Multiply that by hundreds of emails per week.</p>

<h2>6. Branded Packaging</h2>
<p>If you ship products, your packaging IS marketing. Custom boxes, branded tape, tissue paper in your colors, thank you cards. Create an unboxing experience.</p>

<h2>7. Presentation Templates</h2>
<p>Sales decks, proposals, reports — all in your brand. Professional, consistent, memorable.</p>

<h2>8. Branded Swag That People Actually Want</h2>
<p>Skip the cheap pens. Create merchandise people WANT to wear and use. Quality hoodies, useful notebooks, premium stickers. Walking billboards.</p>

<h2>9. Video Intros & Outros</h2>
<p>If you create video content, branded intros and outros build recognition. Even a simple logo animation makes a difference.</p>

<h2>10. Consistent Photo Style</h2>
<p>Define a photo editing style — color grading, filters, composition rules. Your photos should look like they belong together.</p>

<div class="blog-cta">
<h3>Need Brand Assets That Actually Work?</h3>
<p>We create complete brand systems designed for real-world use.</p>
<a onclick="showView('services')" class="btn-cta">Explore Brand Packages</a>
</div>
        `
    },
    {
        id: 10,
        slug: 'psychology-of-color-branding',
        title: 'The Psychology of Color in Branding: What Your Colors Are Saying',
        excerpt: 'Colors aren\'t just aesthetic choices — they trigger emotions and associations. Here\'s how to choose colors that work for your brand.',
        category: 'Branding',
        image: 'https://images.unsplash.com/photo-1525909002-1b05e0c869d8?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'November 25, 2025',
        readTime: '10 min read',
        content: `
<p class="blog-lead">Color is one of the most powerful tools in branding, yet most businesses choose colors because they "look nice." Here's the science behind color psychology and how to use it strategically.</p>

<h2>Red: Energy, Urgency, Passion</h2>
<p>Red increases heart rate and creates urgency. That's why sale signs are red. It's bold, attention-grabbing, and emotional. Use it for brands that want to feel energetic, passionate, or urgent.</p>
<p><strong>Brands using red:</strong> Coca-Cola, Netflix, YouTube, Target</p>

<h2>Blue: Trust, Stability, Professionalism</h2>
<p>Blue is the most universally liked color. It communicates reliability and trustworthiness. That's why banks, tech companies, and healthcare brands love it.</p>
<p><strong>Brands using blue:</strong> Facebook, IBM, American Express, Ford</p>

<h2>Yellow: Optimism, Clarity, Warmth</h2>
<p>Yellow grabs attention and communicates cheerfulness. It's energizing without being aggressive. Great for brands that want to feel approachable and positive.</p>
<p><strong>Brands using yellow:</strong> McDonald's, IKEA, Snapchat, Best Buy</p>

<h2>Green: Growth, Health, Nature</h2>
<p>Green signals growth, health, and environmental consciousness. It's calming and associated with wealth (money is green). Perfect for wellness, finance, and eco-brands.</p>
<p><strong>Brands using green:</strong> Whole Foods, Starbucks, Spotify, John Deere</p>

<h2>Black: Luxury, Sophistication, Power</h2>
<p>Black is timeless and premium. It communicates exclusivity and elegance. High-end fashion and luxury brands lean into black heavily.</p>
<p><strong>Brands using black:</strong> Chanel, Nike, Uber, Apple</p>

<h2>Orange: Creativity, Adventure, Friendliness</h2>
<p>Orange combines red's energy with yellow's friendliness. It's playful and creative without being aggressive.</p>
<p><strong>Brands using orange:</strong> Nickelodeon, Fanta, Harley-Davidson, Amazon</p>

<h2>Choosing Your Brand Colors</h2>
<ul>
<li>Consider your industry expectations</li>
<li>Think about the emotions you want to evoke</li>
<li>Look at what competitors are using (then differentiate)</li>
<li>Test across different applications</li>
<li>Ensure accessibility and contrast</li>
</ul>

<div class="blog-cta">
<h3>Need Help Choosing the Right Colors?</h3>
<p>We create strategic color palettes based on psychology and positioning.</p>
<a onclick="showView('services')" class="btn-cta">Get Your Brand Kit</a>
</div>
        `
    },
    {
        id: 11,
        slug: 'consistency-beats-creativity',
        title: 'Why Consistency Beats Creativity in Branding (Every Single Time)',
        excerpt: 'The secret to brand recognition isn\'t being clever — it\'s being consistent. Here\'s why boring discipline builds billion-dollar brands.',
        category: 'Brand Strategy',
        image: 'https://images.unsplash.com/photo-1507925921958-8a62f3d1a50d?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'November 18, 2025',
        readTime: '7 min read',
        content: `
<p class="blog-lead">Everyone wants the viral moment. The clever campaign. The creative breakthrough. But the brands that actually win? They're boringly, relentlessly consistent.</p>

<h2>The Math of Recognition</h2>
<p>Marketing research shows it takes 5-7 impressions before someone remembers your brand. But here's the catch: those impressions need to be consistent. If your brand looks different every time, you're starting from zero each time.</p>

<p>McDonald's golden arches look exactly the same whether you're in Detroit or Dubai. That consistency is worth billions.</p>

<h2>Consistency Builds Trust</h2>
<p>When your brand looks professional and cohesive, people trust you more. When it looks different everywhere — different fonts, different colors, different styles — people subconsciously question your legitimacy.</p>

<p>Consistency signals: "We have our act together."</p>

<h2>Where Consistency Matters Most</h2>
<ul>
<li><strong>Logo usage:</strong> Same logo, same placement, same clear space</li>
<li><strong>Color palette:</strong> Exact hex codes, not "close enough"</li>
<li><strong>Typography:</strong> Same fonts, same hierarchy</li>
<li><strong>Voice & tone:</strong> Same personality in every piece of copy</li>
<li><strong>Photography style:</strong> Same editing, same mood</li>
<li><strong>Design elements:</strong> Consistent patterns, shapes, icons</li>
</ul>

<h2>The Brand Guidelines Test</h2>
<p>Could someone who's never met you create on-brand content using just your brand guidelines? If not, your guidelines aren't clear enough — or you don't have them at all.</p>

<h2>Creativity WITHIN Consistency</h2>
<p>This doesn't mean being boring. Apple is incredibly creative within their clean, minimalist framework. Creativity happens within the rules, not by breaking them constantly.</p>

<div class="blog-cta">
<h3>Need Brand Guidelines That Actually Work?</h3>
<p>We create comprehensive brand systems for consistent execution.</p>
<a onclick="showView('services')" class="btn-cta">Build Your Brand System</a>
</div>
        `
    },
    {
        id: 12,
        slug: 'small-business-big-brand-energy',
        title: 'How to Give Your Small Business Big Brand Energy',
        excerpt: 'You don\'t need Nike\'s budget to look like a premium brand. Here are the moves that make small businesses look like industry leaders.',
        category: 'Branding',
        image: 'https://images.unsplash.com/photo-1556761175-4b46a572b786?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'November 11, 2025',
        readTime: '9 min read',
        content: `
<p class="blog-lead">Some small businesses look like Fortune 500 companies. Others look like they designed their brand in Microsoft Word. The difference isn't budget — it's knowing what actually matters. Here's the playbook.</p>

<h2>1. Invest in Photography</h2>
<p>Nothing screams "small-time" like bad photos. Stock photos that look generic. iPhone photos with bad lighting. Grainy, pixelated images.</p>
<p>Professional photography — especially for your team, products, and workspace — instantly elevates perception. It's one of the highest-ROI investments you can make.</p>

<h2>2. Simplify Everything</h2>
<p>Amateur brands try to do too much. Too many colors. Too many fonts. Too much clutter. Premium brands are simple and confident.</p>
<p>When in doubt, remove something.</p>

<h2>3. Write Like a Human</h2>
<p>Corporate jargon screams "we're trying too hard." The best brands sound like real people having real conversations. Clear, confident, conversational.</p>

<h2>4. Nail the Details</h2>
<p>Big brands sweat the small stuff. Consistent spacing. Proper alignment. Quality paper for print materials. These details compound.</p>

<h2>5. Create Systems, Not One-Offs</h2>
<p>Don't design a social post. Design a social media system. Don't create a flyer. Create a template library. Systems create consistency.</p>

<h2>6. Say No More Often</h2>
<p>Premium brands are selective. They don't chase every trend. They don't work with every client. Selectivity signals value.</p>

<h2>7. Tell Your Story</h2>
<p>Big brands have narratives. Apple is about thinking different. Nike is about athletic achievement. What's your story? Make it clear.</p>

<h2>8. Invest in Experience</h2>
<p>How does it feel to interact with your brand? The packaging, the website navigation, the customer service? Every touchpoint matters.</p>

<div class="blog-cta">
<h3>Ready for Big Brand Energy?</h3>
<p>We help small businesses look and feel like industry leaders.</p>
<a onclick="showView('services')" class="btn-cta">Level Up Your Brand</a>
</div>
        `
    },
    {
        id: 13,
        slug: 'gary-vee-personal-branding-document-dont-create',
        title: 'Gary Vee Was Right: Document Don\'t Create — Build Your Personal Brand in 2026',
        excerpt: 'Gary Vaynerchuk\'s "document don\'t create" strategy changed how entrepreneurs build personal brands. Here\'s how to apply it to grow your business.',
        category: 'Personal Branding',
        image: 'https://images.unsplash.com/photo-1611162617474-5b21e879e113?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'November 4, 2025',
        readTime: '10 min read',
        content: `
<p class="blog-lead">Gary Vaynerchuk built a $200 million empire by showing up every single day. His advice? Stop trying to create perfect content. Document your journey instead. Here's why this personal branding strategy works and how to execute it.</p>

<h2>Why "Document Don't Create" Changes Everything</h2>
<p>Most entrepreneurs freeze when they think about content creation. They want everything perfect. The lighting. The script. The editing. Gary V flipped this: just pull out your phone and share what you're already doing.</p>

<p>The power of documenting:</p>
<ul>
<li><strong>Authenticity:</strong> People connect with real, not polished</li>
<li><strong>Consistency:</strong> You can post daily without burnout</li>
<li><strong>Storytelling:</strong> Your journey IS the content</li>
<li><strong>Trust:</strong> Transparency builds loyal audiences</li>
</ul>

<h2>Personal Branding Is Business Branding</h2>
<p>Gary V says people buy from people they know, like, and trust. Your personal brand IS your business development strategy. When you become the face of your expertise, you become the obvious choice.</p>

<p>The equation is simple: Attention + Trust = Revenue.</p>

<h2>Video Content Is Non-Negotiable</h2>
<p>Gary's been screaming this for years: video is king. Instagram Reels, TikTok, YouTube Shorts — short-form video is how you build awareness in 2026. You don't need a studio. You need a smartphone and something to say.</p>

<h2>The $1.80 Strategy</h2>
<p>Gary V's famous $1.80 strategy: Leave your "two cents" on 90 posts per day across 10 hashtags. It's not about posting — it's about engaging. Comment on others. Build relationships. Be part of the conversation.</p>

<h2>Patience Is the Game</h2>
<p>The biggest lesson from Gary V: This takes time. Years, not months. The entrepreneurs who win are the ones who keep showing up when nobody's watching. Compound attention is real.</p>

<div class="blog-cta">
<h3>Need a Personal Brand That Converts?</h3>
<p>We build brand identities that make you the authority in your space.</p>
<a onclick="showView('services')" class="btn-cta">Build Your Personal Brand</a>
</div>
        `
    },
    {
        id: 14,
        slug: 'grant-cardone-10x-sales-branding',
        title: 'What Grant Cardone Gets Right About Sales, Branding, and 10X Thinking',
        excerpt: 'Grant Cardone built a $4 billion real estate empire with 10X thinking. Here\'s how his sales philosophy applies to your brand strategy.',
        category: 'Sales Strategy',
        image: 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'October 28, 2025',
        readTime: '9 min read',
        content: `
<p class="blog-lead">Love him or hate him, Grant Cardone understands sales and attention better than almost anyone. His 10X Rule has helped millions of entrepreneurs think bigger. Here's what his philosophy teaches us about branding and selling.</p>

<h2>The 10X Rule Applied to Branding</h2>
<p>Grant's core message: Whatever you think you need to do, multiply it by 10. Think you need to post once a day? Post 10 times. Think you need 100 leads? Get 1,000. Think your brand is "good enough"? It's not even close.</p>

<p>Most businesses are invisible because they're playing small. 10X branding means:</p>
<ul>
<li>Being impossible to ignore in your market</li>
<li>Showing up more than your competitors</li>
<li>Investing more in your visual identity</li>
<li>Creating content at volume, not perfection</li>
</ul>

<h2>Omnipresence Is the Goal</h2>
<p>Cardone preaches omnipresence — being everywhere your customer looks. Website. Social media. Email. Billboards. Banners. Yard signs. Vinyl decals. The business that's everywhere is the business that gets called.</p>

<p>Your brand should feel inescapable in your local market.</p>

<h2>Sales Is a Contact Sport</h2>
<p>Grant says most people don't follow up enough. The average sale takes 8 touches. Most salespeople give up after 2. Your brand needs to keep showing up until the prospect is ready to buy.</p>

<h2>Speed and Aggression Win</h2>
<p>Cardone's philosophy: Move fast, be bold, take massive action. In branding terms, this means launching before you're ready, iterating in public, and outworking the competition on visibility.</p>

<h2>Invest in Your Image</h2>
<p>Grant drives Rolls Royces and flies private. Why? Because image matters. Your brand is your business's image. A premium brand commands premium prices. Looking cheap costs you money.</p>

<div class="blog-cta">
<h3>Ready to 10X Your Brand?</h3>
<p>We create bold brand identities that demand attention.</p>
<a onclick="showView('services')" class="btn-cta">Get 10X Branding</a>
</div>
        `
    },
    {
        id: 15,
        slug: 'coach-consultant-mentor-personal-brand-guide',
        title: 'Building a Coaching or Consulting Brand: The Complete Personal Branding Guide',
        excerpt: 'Coaches, consultants, and mentors live and die by their personal brand. Here\'s exactly how to position yourself as the go-to expert in your niche.',
        category: 'Personal Branding',
        image: 'https://images.unsplash.com/photo-1552581234-26160f608093?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'October 21, 2025',
        readTime: '12 min read',
        content: `
<p class="blog-lead">If you're a coach, consultant, or mentor, YOU are the product. Your personal brand is everything. It determines whether you charge $50/hour or $500/hour. Here's how to build a brand that commands premium rates.</p>

<h2>Why Personal Branding Matters for Coaches</h2>
<p>The coaching industry is flooded. Everyone's a "business coach" or "life coach" now. The only way to stand out is to become the obvious expert in a specific niche. Your personal brand does that positioning work for you.</p>

<p>A strong coaching brand:</p>
<ul>
<li>Attracts ideal clients who are ready to pay</li>
<li>Positions you as the authority, not a commodity</li>
<li>Justifies premium pricing</li>
<li>Creates inbound leads instead of cold outreach</li>
</ul>

<h2>Define Your Niche (Then Go Narrower)</h2>
<p>"Business coach" is not a niche. "Sales coach for SaaS startups doing $1-5M ARR" is a niche. The more specific your positioning, the easier it is to become the obvious choice.</p>

<h2>Video Builds Trust Faster Than Anything</h2>
<p>People need to feel like they know you before they'll pay you. Video content — YouTube, Instagram Reels, TikTok, LinkedIn video — lets prospects experience your coaching style before the sales call.</p>

<h2>Host Events and Workshops</h2>
<p>Nothing builds authority like standing on a stage. Virtual workshops, webinars, local meetups, mentor days — events position you as the expert and generate qualified leads. Plus, you can capture content to repurpose across all platforms.</p>

<h2>Your Visual Identity Signals Your Value</h2>
<p>A coach with a Canva logo and a Wix template site will never command $10K packages. Your visual brand — logo, colors, website, photography — needs to match your desired price point.</p>

<h2>Build Your Ecosystem</h2>
<p>The most successful coaches have:</p>
<ul>
<li>A professional website with clear offers</li>
<li>Consistent social media presence</li>
<li>Email list and newsletter</li>
<li>Free content that demonstrates expertise</li>
<li>Testimonials and case studies</li>
<li>A signature framework or methodology</li>
</ul>

<div class="blog-cta">
<h3>Ready to Build Your Coaching Brand?</h3>
<p>We create premium personal brands for coaches and consultants.</p>
<a onclick="showView('services')" class="btn-cta">Build Your Expert Brand</a>
</div>
        `
    },
    {
        id: 16,
        slug: 'print-design-signage-brand-visibility',
        title: 'Banners, Yard Signs & Vinyl Decals: Turn Your Business Into a Local Billboard',
        excerpt: 'Your storefront, events, and local presence are advertising real estate you already own. Here\'s how print design and signage generate thousands of impressions daily.',
        category: 'Brand Strategy',
        image: 'https://images.unsplash.com/photo-1549317661-bd32c8ce0db2?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'October 14, 2025',
        readTime: '8 min read',
        content: `
<p class="blog-lead">Your storefront window, your next event, the road your customers drive every day — these are advertising surfaces you already have access to. Banners, yard signs, posters, and vinyl decals turn them into 24/7 brand billboards.</p>

<h2>The Math on Print Signage</h2>
<p>A well-placed yard sign or banner generates thousands of impressions per day. At a design cost of $200-$500, printed for under $100, and lasting months to years, you're looking at one of the lowest cost-per-impression advertising methods available. Compare that to:</p>
<ul>
<li>Facebook Ads: $5-15 CPM</li>
<li>Google Display: $2-10 CPM</li>
<li>Digital Billboards: $3-18 CPM</li>
</ul>
<p>Print signage — banners, yard signs, and vinyl decals — is one of the most cost-effective local advertising methods that exist.</p>

<h2>Design Principles for Banners & Posters</h2>
<p>Your banner has about 3 seconds to communicate. That means:</p>
<ul>
<li><strong>Big, readable logo:</strong> Should be visible from across the room or street</li>
<li><strong>One clear message:</strong> What do you do or what's the event?</li>
<li><strong>Phone number or website:</strong> Make it large and easy to read</li>
<li><strong>High contrast colors:</strong> Stand out against any background</li>
</ul>
<p>Don't try to fit your entire service menu on a banner. Less is more.</p>

<h2>Yard Signs That Drive Business</h2>
<p>Yard signs are the original local marketing tool. Effective yard sign design includes:</p>
<ul>
<li><strong>Business name and logo:</strong> Readable from a moving car</li>
<li><strong>Bold phone number or website:</strong> The primary call to action</li>
<li><strong>High-contrast colors:</strong> Visible day and night</li>
<li><strong>Simple message:</strong> "Now Open" or "Grand Opening" or "Free Estimates"</li>
</ul>

<h2>Vinyl Decals & Window Graphics</h2>
<p>Your storefront window is prime real estate. Effective vinyl graphics include:</p>
<ul>
<li><strong>Business name and logo:</strong> Prominent and professional</li>
<li><strong>Hours of operation:</strong> Don't make people guess</li>
<li><strong>Call to action:</strong> "Walk-ins welcome" or "Free consultations"</li>
<li><strong>Seasonal promotions:</strong> Easily changeable window decals</li>
</ul>

<h2>Brand Consistency Is Key</h2>
<p>Your banners, yard signs, vinyl decals, business cards, and website should all look like they belong to the same company. Same colors. Same fonts. Same visual language. This consistency builds recognition.</p>

<h2>Event Backgrounds Multiply Your Reach</h2>
<p>A branded event backdrop turns every photo into free advertising. When guests post photos from your event with your branding in the background, that's organic reach money can't buy.</p>

<div class="blog-cta">
<h3>Ready for Professional Print Design?</h3>
<p>We create banners, posters, yard signs, and vinyl decals that get noticed.</p>
<a onclick="showView('services')" class="btn-cta">Get Print Design</a>
</div>
        `
    },
    {
        id: 17,
        slug: 'custom-web-app-business-growth',
        title: 'Why Every Growing Business Needs a Custom Web App (Not Just a Website)',
        excerpt: 'Websites inform. Web apps transform. Here\'s why custom web applications are the secret weapon of businesses that scale.',
        category: 'Technology',
        image: 'https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'October 7, 2025',
        readTime: '11 min read',
        content: `
<p class="blog-lead">A website is a digital brochure. A custom web app is a digital employee that works 24/7, never calls in sick, and scales infinitely. If you're still running your business on spreadsheets and email, you're leaving money on the table.</p>

<h2>Website vs. Web App: What's the Difference?</h2>
<p>A <strong>website</strong> displays information. Visitors read content, maybe fill out a contact form, and leave. A <strong>web application</strong> performs tasks. Users log in, interact with data, complete workflows, and get things done.</p>

<p>Examples of web apps:</p>
<ul>
<li><strong>Client portals:</strong> Customers check order status, access documents</li>
<li><strong>Booking systems:</strong> Appointments scheduled without phone calls</li>
<li><strong>Project management:</strong> Team collaboration in one place</li>
<li><strong>Custom CRMs:</strong> Track leads and customers your way</li>
<li><strong>Internal tools:</strong> Automate repetitive business processes</li>
</ul>

<h2>Why Custom Beats Off-the-Shelf</h2>
<p>Tools like Salesforce, Monday, and HubSpot are powerful. They're also expensive, bloated, and force you to work their way. A custom web app is built around YOUR processes, not the other way around.</p>

<p>Benefits of custom:</p>
<ul>
<li><strong>Exact fit:</strong> Does exactly what you need, nothing more</li>
<li><strong>Competitive advantage:</strong> Your competitors can't buy it</li>
<li><strong>Scalability:</strong> Grows with your business</li>
<li><strong>Integration:</strong> Connects with your existing tools</li>
<li><strong>Ownership:</strong> You own the code and data forever</li>
</ul>

<h2>Signs You Need a Custom Web App</h2>
<p>If any of these sound familiar, it's time:</p>
<ul>
<li>You're copying data between multiple spreadsheets</li>
<li>Your team wastes hours on repetitive tasks</li>
<li>Customers are frustrated with your ordering/booking process</li>
<li>You're paying for 10 SaaS tools that don't talk to each other</li>
<li>Your business process is too unique for standard software</li>
</ul>

<h2>The ROI of Automation</h2>
<p>A custom web app that saves your team 10 hours per week is worth $25,000/year in labor alone. Most apps pay for themselves in months, then keep generating returns forever.</p>

<h2>Start With One Problem</h2>
<p>You don't need to build everything at once. Pick the one process that's causing the most pain. Automate that. Prove the value. Then expand.</p>

<div class="blog-cta">
<h3>Ready to Build Your Custom Web App?</h3>
<p>We build web applications that automate your business processes.</p>
<a onclick="showView('services')" class="btn-cta">Explore Web App Solutions</a>
</div>
        `
    },
    {
        id: 18,
        slug: 'why-every-business-needs-three-logos',
        title: 'Why Every Business Needs 3 Logos (And What Each One Is For)',
        excerpt: 'One logo is not enough. Here is why professional brands have multiple logo variations and how to use each one correctly.',
        category: 'Branding',
        image: 'https://images.unsplash.com/photo-1558655146-9f40138edfeb?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'September 30, 2025',
        readTime: '7 min read',
        content: `
<p class="blog-lead">If you only have one logo, you are already behind. Professional brands have multiple logo variations designed for different contexts. Here is the logo system every serious business needs.</p>

<h2>The Primary Logo (Horizontal Lockup)</h2>
<p>This is your main logo — the full version with your symbol/icon and wordmark side by side. Use this when you have plenty of horizontal space:</p>
<ul>
<li>Website header</li>
<li>Email signatures</li>
<li>Business cards</li>
<li>Letterhead</li>
<li>Presentations</li>
</ul>
<p>This is the logo most people picture when they think of your brand.</p>

<h2>The Stacked Logo (Vertical Lockup)</h2>
<p>Same elements as your primary logo, but arranged vertically — icon on top, wordmark below. Use this when you have more vertical space or need a more compact format:</p>
<ul>
<li>Social media profile pictures</li>
<li>Signage</li>
<li>Packaging</li>
<li>Apparel embroidery</li>
<li>Square format applications</li>
</ul>

<h2>The Icon/Brandmark (Favicon)</h2>
<p>Just your symbol or a simplified mark — no text. This is crucial for small spaces where your wordmark would be unreadable:</p>
<ul>
<li>Favicon (browser tab icon)</li>
<li>App icons</li>
<li>Social media avatars</li>
<li>Watermarks</li>
<li>Embossed materials</li>
</ul>

<h2>Bonus: Responsive Logo Variations</h2>
<p>Some brands also have size-responsive variations — simplified versions that work at tiny sizes. Think about how your logo looks at 16x16 pixels.</p>

<h2>Color Variations Matter Too</h2>
<p>Each of these three logos should also have:</p>
<ul>
<li><strong>Full color:</strong> Your primary brand colors</li>
<li><strong>Single color:</strong> For one-color printing</li>
<li><strong>Reversed/White:</strong> For dark backgrounds</li>
<li><strong>Black:</strong> For documents and faxes</li>
</ul>

<div class="blog-cta">
<h3>Need a Complete Logo System?</h3>
<p>We create professional logo packages with all the variations you need.</p>
<a onclick="showView('services')" class="btn-cta">Get Your Logo System</a>
</div>
        `
    },
    {
        id: 19,
        slug: 'what-is-brand-identity-complete-guide',
        title: 'What Is Brand Identity? The Complete Guide for Business Owners',
        excerpt: 'Brand identity is more than a logo. Here is everything that makes up your visual brand system and why each piece matters.',
        category: 'Branding',
        image: 'https://images.unsplash.com/photo-1586717791821-3f44a563fa4c?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'September 23, 2025',
        readTime: '9 min read',
        content: `
<p class="blog-lead">Brand identity is the complete visual system that represents your business. It is not just a logo — it is every visual element that helps customers recognize and remember you.</p>

<h2>The Core Elements of Brand Identity</h2>

<h3>1. Logo System</h3>
<p>Your logo is the cornerstone, but as we covered, you need multiple versions — primary, stacked, and icon variations in multiple color formats.</p>

<h3>2. Color Palette</h3>
<p>A defined set of colors used consistently across everything. This typically includes:</p>
<ul>
<li>Primary colors (1-2)</li>
<li>Secondary colors (2-3)</li>
<li>Accent colors</li>
<li>Neutral colors (backgrounds, text)</li>
</ul>

<h3>3. Typography</h3>
<p>The fonts you use communicate personality. Most brands need:</p>
<ul>
<li>Heading font (bold, attention-grabbing)</li>
<li>Body font (readable, professional)</li>
<li>Accent font (optional, for special uses)</li>
</ul>

<h3>4. Imagery Style</h3>
<p>Guidelines for photography, illustrations, and graphics. What mood? What subjects? What editing style?</p>

<h3>5. Graphic Elements</h3>
<p>Patterns, shapes, icons, and textures that create visual consistency beyond the logo.</p>

<h3>6. Voice and Tone</h3>
<p>While technically part of brand strategy, your verbal identity works with visual identity to create a complete brand experience.</p>

<h2>Brand Identity vs. Brand vs. Branding</h2>
<ul>
<li><strong>Brand:</strong> How people perceive you (reputation)</li>
<li><strong>Brand Identity:</strong> The visual tools you use to shape perception</li>
<li><strong>Branding:</strong> The process of building and managing your brand</li>
</ul>

<h2>Why Brand Identity Matters</h2>
<p>Consistent brand identity increases revenue by up to 23% according to research. It builds recognition, creates trust, and makes marketing more effective.</p>

<div class="blog-cta">
<h3>Ready for a Professional Brand Identity?</h3>
<p>We create complete brand identity systems for businesses ready to level up.</p>
<a onclick="showView('services')" class="btn-cta">Explore Brand Packages</a>
</div>
        `
    },
    {
        id: 20,
        slug: 'what-is-a-web-app-explained',
        title: 'What Is a Web App? A Simple Explanation for Non-Technical Business Owners',
        excerpt: 'Web apps, websites, mobile apps — what is the difference? Here is a plain English guide to understanding web applications.',
        category: 'Technology',
        image: 'https://images.unsplash.com/photo-1547658719-da2b51169166?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'September 16, 2025',
        readTime: '6 min read',
        content: `
<p class="blog-lead">You have heard the term "web app" but what does it actually mean? Here is a simple explanation without the tech jargon.</p>

<h2>Website vs. Web App: The Simple Version</h2>
<p><strong>Website:</strong> You visit it to READ information. It is like a digital brochure or magazine.</p>
<p><strong>Web App:</strong> You visit it to DO something. It is like a digital tool or software.</p>

<h2>Real Examples</h2>
<p><strong>Websites:</strong></p>
<ul>
<li>A restaurant menu page</li>
<li>A company's "About Us" page</li>
<li>A news article</li>
<li>A portfolio showcase</li>
</ul>
<p><strong>Web Apps:</strong></p>
<ul>
<li>Gmail (you send and receive emails)</li>
<li>Google Docs (you create documents)</li>
<li>Online banking (you manage money)</li>
<li>Canva (you design graphics)</li>
<li>A booking system (you schedule appointments)</li>
</ul>

<h2>Web App vs. Mobile App</h2>
<p><strong>Mobile App:</strong> Downloaded from app store, installed on your phone</p>
<p><strong>Web App:</strong> Accessed through a browser, no download needed</p>
<p>Many services have both. You can use Instagram as a mobile app OR go to instagram.com in your browser (web app).</p>

<h2>Why Would Your Business Need a Web App?</h2>
<ul>
<li><strong>Client Portal:</strong> Customers log in to see their orders, documents, or account info</li>
<li><strong>Booking System:</strong> Clients schedule appointments without calling you</li>
<li><strong>Quote Calculator:</strong> Visitors get instant pricing estimates</li>
<li><strong>Internal Tools:</strong> Your team manages projects, inventory, or processes</li>
</ul>

<h2>The Benefit Over Mobile Apps</h2>
<p>Web apps work on any device with a browser — no app store approval, no downloads, no updates for users to install. One version works everywhere.</p>

<div class="blog-cta">
<h3>Need a Custom Web App for Your Business?</h3>
<p>We build web applications that solve real business problems.</p>
<a onclick="showView('services')" class="btn-cta">Discuss Your Web App</a>
</div>
        `
    },
    {
        id: 21,
        slug: 'what-is-a-vector-file-explained',
        title: 'What Is a Vector File? Why Your Designer Keeps Asking for It',
        excerpt: 'PNG, JPG, SVG, AI, EPS — what do these mean and why does it matter? Here is everything you need to know about vector files.',
        category: 'Branding',
        image: 'https://images.unsplash.com/photo-1611532736597-de2d4265fba3?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'September 9, 2025',
        readTime: '6 min read',
        content: `
<p class="blog-lead">Every time you work with a designer or printer, they ask for "vector files." But what does that actually mean? Here is the simple explanation.</p>

<h2>Vector vs. Raster: The Difference</h2>
<p><strong>Raster images (JPG, PNG, GIF):</strong> Made of tiny squares called pixels. Like a mosaic. When you zoom in, you see the squares and it gets blurry.</p>
<p><strong>Vector images (SVG, AI, EPS, PDF):</strong> Made of mathematical paths and shapes. Like connect-the-dots. They can scale to ANY size without losing quality.</p>

<h2>Why Vectors Matter for Your Logo</h2>
<p>Your logo needs to work at every size:</p>
<ul>
<li>Tiny: Favicon (16x16 pixels)</li>
<li>Small: Business card</li>
<li>Medium: Website header</li>
<li>Large: Trade show banner</li>
<li>Huge: Building signage, billboards</li>
</ul>
<p>A raster logo that looks fine on a business card will be a pixelated mess on a billboard. A vector logo looks crisp at ANY size.</p>

<h2>Common File Types Explained</h2>
<ul>
<li><strong>.AI:</strong> Adobe Illustrator file (vector, editable)</li>
<li><strong>.EPS:</strong> Encapsulated PostScript (vector, universal)</li>
<li><strong>.SVG:</strong> Scalable Vector Graphics (vector, web-friendly)</li>
<li><strong>.PDF:</strong> Can be vector OR raster depending on how it was made</li>
<li><strong>.PNG:</strong> Raster, but supports transparency</li>
<li><strong>.JPG:</strong> Raster, compressed, no transparency</li>
</ul>

<h2>What Files Should You Have?</h2>
<p>A professional logo package should include:</p>
<ul>
<li>Vector files (.AI, .EPS, .SVG) for printing and scaling</li>
<li>High-res PNG files for digital use</li>
<li>Various color versions (full color, white, black)</li>
</ul>

<h2>Red Flag: "I Only Have a JPG"</h2>
<p>If your "designer" only gave you JPG files, you do not have a professional logo. You have a picture of a logo. Always get your vector source files.</p>

<div class="blog-cta">
<h3>Need Proper Logo Files?</h3>
<p>We deliver complete file packages with every format you will ever need.</p>
<a onclick="showView('services')" class="btn-cta">Get Professional Logo Files</a>
</div>
        `
    },
    {
        id: 22,
        slug: 'small-brands-beating-ai-with-real-designers',
        title: 'How Small Brands Who Hire Real Designers Are Beating AI-Generated Competition',
        excerpt: 'While everyone rushes to AI design tools, smart small brands are winning by investing in human creativity. Here is why.',
        category: 'Branding',
        image: 'https://images.unsplash.com/photo-1558655146-364adaf1fcc9?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'September 2, 2025',
        readTime: '8 min read',
        content: `
<p class="blog-lead">AI logo generators are everywhere. They are cheap. They are fast. And they are creating a sea of forgettable, generic brands. Here is why the smart money is going the other direction.</p>

<h2>The AI Design Problem</h2>
<p>AI tools like Looka, Canva AI, and MidJourney can generate logos in seconds. But here is what they cannot do:</p>
<ul>
<li>Understand your specific market positioning</li>
<li>Research your competitors to ensure differentiation</li>
<li>Create truly original concepts</li>
<li>Guarantee the design is not similar to existing trademarks</li>
<li>Adapt based on strategic feedback</li>
</ul>

<h2>The "AI Look" Is Becoming Obvious</h2>
<p>AI-generated designs have patterns. Certain styles. Particular tendencies. Customers are starting to recognize — even subconsciously — when something looks AI-generated. And it signals: "This business did not invest in their brand."</p>

<h2>The Differentiation Opportunity</h2>
<p>When everyone zigs toward AI, zagging toward human design creates instant differentiation. A thoughtfully crafted brand identity stands out in a sea of algorithmic sameness.</p>

<h2>Real Designers Provide Strategy</h2>
<p>A logo is not just a pretty picture. It is a strategic business asset. Real designers:</p>
<ul>
<li>Ask about your target audience</li>
<li>Research your competitive landscape</li>
<li>Consider your business goals</li>
<li>Think about practical applications</li>
<li>Ensure scalability and versatility</li>
</ul>

<h2>The Hidden Costs of AI Design</h2>
<p>That $50 AI logo might cost you:</p>
<ul>
<li>Customer trust (looks cheap)</li>
<li>Trademark issues (AI does not check)</li>
<li>Rebrand costs in 2 years (when you outgrow it)</li>
<li>Lost premium pricing power</li>
</ul>

<h2>Investment vs. Expense</h2>
<p>AI design is an expense. Professional design is an investment. The brands winning in 2026 understand the difference.</p>

<div class="blog-cta">
<h3>Ready for Human-Crafted Design?</h3>
<p>We create strategic brand identities that AI cannot replicate.</p>
<a onclick="showView('services')" class="btn-cta">Work With Real Designers</a>
</div>
        `
    },
    {
        id: 23,
        slug: 'what-is-brand-story-why-you-need-one',
        title: 'What Is a Brand Story and Why Does Your Business Need One?',
        excerpt: 'Facts tell, stories sell. Here is what a brand story actually is and how to craft one that connects with customers.',
        category: 'Brand Strategy',
        image: 'https://images.unsplash.com/photo-1456324504439-367cee3b3c32?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'August 26, 2025',
        readTime: '9 min read',
        content: `
<p class="blog-lead">Nike does not sell shoes. They sell the story of athletic achievement. Apple does not sell computers. They sell the story of thinking different. What story does your brand tell?</p>

<h2>What Is a Brand Story?</h2>
<p>Your brand story is the narrative that connects your business to your customers emotionally. It is not just your company history — it is the "why" behind everything you do.</p>

<p>A brand story answers:</p>
<ul>
<li>Why does your company exist?</li>
<li>What problem were you born to solve?</li>
<li>Who do you serve and why do you care?</li>
<li>What makes your approach different?</li>
<li>What future are you creating?</li>
</ul>

<h2>Why Stories Beat Facts</h2>
<p>Neuroscience shows stories activate more parts of the brain than facts alone. When someone hears a story, their brain synchronizes with the storyteller. That is connection. That is trust.</p>

<p>People remember stories 22x better than facts alone.</p>

<h2>The Brand Story Framework</h2>
<ol>
<li><strong>The Problem:</strong> What frustration or pain exists in the world?</li>
<li><strong>The Awakening:</strong> What moment made you decide to act?</li>
<li><strong>The Mission:</strong> What are you setting out to change?</li>
<li><strong>The Solution:</strong> How do you uniquely solve the problem?</li>
<li><strong>The Vision:</strong> What does success look like for your customers?</li>
</ol>

<h2>Brand Story Examples</h2>
<p><strong>TOMS:</strong> "With every product you purchase, TOMS will help a person in need." Simple. Emotional. Memorable.</p>
<p><strong>Warby Parker:</strong> Started because glasses were too expensive and buying them was frustrating. They made it accessible and easy.</p>

<h2>Where Your Brand Story Lives</h2>
<ul>
<li>Your "About" page</li>
<li>Social media bios</li>
<li>Pitch decks and proposals</li>
<li>Team training and culture</li>
<li>Customer communications</li>
</ul>

<div class="blog-cta">
<h3>Need Help Crafting Your Brand Story?</h3>
<p>We help businesses discover and articulate their authentic brand narrative.</p>
<a onclick="showView('services')" class="btn-cta">Develop Your Brand Story</a>
</div>
        `
    },
    {
        id: 24,
        slug: 'what-is-brand-voice-how-to-use-it',
        title: 'What Is Brand Voice? (And How to Use It Consistently Everywhere)',
        excerpt: 'Your brand voice is how your business sounds in writing. Here is how to define it, document it, and use it to stand out.',
        category: 'Brand Strategy',
        image: 'https://images.unsplash.com/photo-1589903308904-1010c2294adc?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'August 19, 2025',
        readTime: '8 min read',
        content: `
<p class="blog-lead">If your brand was a person, how would they talk? That is your brand voice. It is the personality that comes through in every email, social post, and webpage you write.</p>

<h2>What Is Brand Voice?</h2>
<p>Brand voice is the consistent personality and style of your written and verbal communication. It includes:</p>
<ul>
<li><strong>Tone:</strong> Formal or casual? Serious or playful?</li>
<li><strong>Language:</strong> Technical or simple? Industry jargon or everyday words?</li>
<li><strong>Personality:</strong> Warm or authoritative? Quirky or straightforward?</li>
<li><strong>Rhythm:</strong> Short punchy sentences or flowing prose?</li>
</ul>

<h2>Why Brand Voice Matters</h2>
<p>Consistency builds recognition. When your brand sounds the same everywhere, customers learn to recognize you — even without seeing your logo. Voice creates familiarity. Familiarity creates trust.</p>

<h2>How to Define Your Brand Voice</h2>
<p><strong>Step 1:</strong> Describe your brand as a person. Give them traits. "If our brand was a person, they would be confident but approachable, smart but not arrogant."</p>
<p><strong>Step 2:</strong> List 3-5 voice attributes. Examples: Friendly, Bold, Expert, Playful, Direct, Warm, Rebellious.</p>
<p><strong>Step 3:</strong> Create do's and don'ts for each attribute.</p>

<h2>Example Brand Voice Guidelines</h2>
<p><strong>Voice Attribute: Friendly</strong></p>
<ul>
<li>DO: Use contractions (we're, you'll, it's)</li>
<li>DO: Address the reader as "you"</li>
<li>DON'T: Use cold corporate language</li>
<li>DON'T: Sound like a press release</li>
</ul>

<h2>Using Your Brand Voice Everywhere</h2>
<ul>
<li>Website copy</li>
<li>Social media posts</li>
<li>Email marketing</li>
<li>Customer service responses</li>
<li>Proposals and contracts</li>
<li>Product descriptions</li>
<li>Job postings</li>
</ul>

<h2>Voice vs. Tone</h2>
<p>Voice stays consistent. Tone adapts to context. Your voice might be "friendly and expert." But the tone of a complaint response differs from a promotional email — while both still sound like YOU.</p>

<div class="blog-cta">
<h3>Need Help Defining Your Brand Voice?</h3>
<p>We create brand voice guidelines that keep your messaging consistent.</p>
<a onclick="showView('services')" class="btn-cta">Develop Your Brand Voice</a>
</div>
        `
    },
    {
        id: 25,
        slug: 'why-social-media-reach-is-failing',
        title: 'Why Your Social Media Reach Is Dying (And What Actually Works in 2026)',
        excerpt: 'Organic reach is plummeting. The algorithm hates your posts. Here is what is really happening and how to fix it.',
        category: 'Social Media',
        image: 'https://images.unsplash.com/photo-1611162616305-c69b3fa7fbe0?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'August 12, 2025',
        readTime: '10 min read',
        content: `
<p class="blog-lead">You post consistently. You use hashtags. You follow all the "tips." Yet your reach keeps dropping. Here is the brutal truth about social media in 2026 — and what actually works.</p>

<h2>Why Organic Reach Is Dying</h2>
<p>The platforms WANT you to pay. Facebook organic reach is down to 2-5% of your followers. Instagram is not much better. The business model is: give you a taste for free, then charge for access to YOUR OWN audience.</p>

<h2>The Algorithm Rewards Engagement</h2>
<p>The algorithm does not care about your business goals. It cares about keeping users on the platform. Posts that get quick engagement (comments, shares, saves) get shown to more people. Posts that get scrolled past get buried.</p>

<h2>Common Mistakes Killing Your Reach</h2>
<ul>
<li><strong>Posting links:</strong> Platforms hate when you send people away</li>
<li><strong>Being boring:</strong> Safe, corporate content gets ignored</li>
<li><strong>Inconsistent posting:</strong> The algorithm forgets you exist</li>
<li><strong>Ignoring video:</strong> All platforms prioritize video content</li>
<li><strong>No engagement:</strong> If you do not comment, they do not show your posts</li>
</ul>

<h2>What Actually Works in 2026</h2>

<h3>1. Short-Form Video Is King</h3>
<p>Reels, TikToks, Shorts — this is where the reach is. The platforms are competing for attention against TikTok, so they push video content hard.</p>

<h3>2. Engagement Before Broadcasting</h3>
<p>Spend 15 minutes engaging with other accounts BEFORE you post. The algorithm sees you as active and rewards your content.</p>

<h3>3. Native Content Only</h3>
<p>Stop sharing links. Create content native to each platform. Put the value IN the post, not behind a click.</p>

<h3>4. Build Email Instead</h3>
<p>Social media is rented land. Your email list is owned. Use social to drive email signups, then nurture through email.</p>

<h3>5. Pay to Play</h3>
<p>Accept that organic is supplemental. Budget for paid promotion of your best content. Even $50-100/month makes a difference.</p>

<div class="blog-cta">
<h3>Need a Social Media Strategy That Works?</h3>
<p>We create branded content systems designed for the algorithm.</p>
<a onclick="showView('services')" class="btn-cta">Fix Your Social Strategy</a>
</div>
        `
    },
    {
        id: 26,
        slug: 'alex-hormozi-100m-offers-brand-lessons',
        title: 'Alex Hormozi\'s $100M Offers: How to Apply Grand Slam Offer Strategy to Your Brand',
        excerpt: 'Alex Hormozi sold $100M+ in services by creating irresistible offers. Here is how to apply his framework to your branding and marketing.',
        category: 'Business Strategy',
        image: 'https://images.unsplash.com/photo-1553729459-efe14ef6055d?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'August 5, 2025',
        readTime: '11 min read',
        content: `
<p class="blog-lead">Alex Hormozi's "$100M Offers" is required reading for anyone selling services. His Grand Slam Offer framework changes how you think about pricing, packaging, and presenting your brand. Here is how to apply it.</p>

<h2>The Core Concept: Value vs. Price</h2>
<p>Hormozi's formula: Make the value SO obvious that price becomes irrelevant. If your offer delivers $100,000 in value, charging $10,000 is a no-brainer. The problem? Most businesses cannot articulate their value.</p>

<h2>The Value Equation</h2>
<p>Value = (Dream Outcome x Perceived Likelihood of Achievement) / (Time Delay x Effort & Sacrifice)</p>
<ul>
<li><strong>Dream Outcome:</strong> What do they REALLY want?</li>
<li><strong>Perceived Likelihood:</strong> Do they believe you can deliver?</li>
<li><strong>Time Delay:</strong> How fast do they get results?</li>
<li><strong>Effort Required:</strong> How hard is it for them?</li>
</ul>

<h2>Applying This to Your Brand</h2>
<p>Your brand should communicate each element of the value equation:</p>
<ul>
<li><strong>Dream Outcome:</strong> Your messaging should paint the vision</li>
<li><strong>Likelihood:</strong> Testimonials, case studies, and credibility markers</li>
<li><strong>Speed:</strong> Clear timelines and fast-start options</li>
<li><strong>Ease:</strong> Done-for-you services, simple processes</li>
</ul>

<h2>Stack the Value</h2>
<p>Hormozi teaches value stacking — adding bonuses and components that increase perceived value without increasing cost. For branding, this means:</p>
<ul>
<li>Include brand guidelines (not just the logo)</li>
<li>Add social media templates</li>
<li>Include business card designs</li>
<li>Provide a brand strategy document</li>
<li>Offer revision rounds</li>
</ul>

<h2>Create Urgency and Scarcity</h2>
<p>Limited slots. Deadline pricing. Bonuses that expire. Hormozi shows that ethical urgency increases conversions. Your brand should create reasons to act NOW.</p>

<h2>Name Your Offer</h2>
<p>Do not sell "logo design." Sell "The Brand Launch System" or "The Authority Brand Package." Naming creates perceived uniqueness.</p>

<div class="blog-cta">
<h3>Ready for a Grand Slam Brand?</h3>
<p>We create value-stacked brand packages designed to convert.</p>
<a onclick="showView('services')" class="btn-cta">See Our Brand Packages</a>
</div>
        `
    },
    {
        id: 27,
        slug: 'dale-carnegie-influence-branding-lessons',
        title: 'Dale Carnegie\'s Timeless Principles: How to Win Customers and Influence Your Market',
        excerpt: 'Dale Carnegie wrote the book on human influence in 1936. His principles are more relevant than ever for building a brand people love.',
        category: 'Business Strategy',
        image: 'https://images.unsplash.com/photo-1521791136064-7986c2920216?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'July 29, 2025',
        readTime: '10 min read',
        content: `
<p class="blog-lead">"How to Win Friends and Influence People" has sold 30+ million copies since 1936. Dale Carnegie's principles about human nature apply directly to how we build brands that connect. Here is the playbook.</p>

<h2>Principle 1: Become Genuinely Interested in Other People</h2>
<p>Carnegie's first rule: Care about others. For brands, this means customer-centric everything. Your website should be about THEM, not you. Your content should solve THEIR problems. Your social media should respond to THEIR needs.</p>
<p>Brands that talk about themselves all day lose. Brands that focus on customer transformation win.</p>

<h2>Principle 2: Smile</h2>
<p>In branding terms: Be approachable. Your visual identity, your copy, your customer service — all of it should feel welcoming, not intimidating. Warmth converts.</p>

<h2>Principle 3: Remember Names</h2>
<p>Personalization matters. Use customer names in emails. Remember their preferences. CRM systems exist for this reason. Making someone feel known creates loyalty.</p>

<h2>Principle 4: Be a Good Listener</h2>
<p>Listen to your market. Read comments. Monitor reviews. Conduct surveys. The brands that win are the ones that hear what customers actually want — not what the brand THINKS they want.</p>

<h2>Principle 5: Talk in Terms of Others' Interests</h2>
<p>Features tell, benefits sell. Nobody cares that your product has "advanced technology." They care that it saves them 2 hours per day. Translate everything into customer benefit.</p>

<h2>Principle 6: Make People Feel Important</h2>
<p>User-generated content. Customer spotlights. Loyalty programs. Handwritten thank-you notes. Small gestures that say "you matter" create brand evangelists.</p>

<h2>Principle 7: Avoid Arguments</h2>
<p>On social media, in reviews, in customer service — never argue. Acknowledge, empathize, solve. You will never win an argument with a customer, even if you are right.</p>

<h2>Principle 8: Admit Mistakes</h2>
<p>Brands that own their mistakes build trust. Defensiveness destroys it. When you mess up, say so clearly, apologize sincerely, and fix it fast.</p>

<h2>The Carnegie Brand Test</h2>
<p>Ask yourself: Does my brand make people feel valued, heard, and important? If not, revisit these principles.</p>

<div class="blog-cta">
<h3>Build a Brand People Love</h3>
<p>We create brands designed around human connection.</p>
<a onclick="showView('services')" class="btn-cta">Start Your Brand Journey</a>
</div>
        `
    },
    {
        id: 28,
        slug: 'what-is-sop-standard-operating-procedure',
        title: 'What Is an SOP? How Standard Operating Procedures Scale Your Business',
        excerpt: 'SOPs are the secret weapon of businesses that grow without chaos. Here is what they are, why you need them, and how to create them.',
        category: 'Business Strategy',
        image: 'https://images.unsplash.com/photo-1454165804606-c3d57bc86b40?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'July 22, 2025',
        readTime: '8 min read',
        content: `
<p class="blog-lead">You cannot scale what is only in your head. Standard Operating Procedures (SOPs) are how businesses go from dependent on the founder to running like a machine. Here is everything you need to know.</p>

<h2>What Is an SOP?</h2>
<p>An SOP (Standard Operating Procedure) is a step-by-step document that explains exactly how to complete a specific task or process. Think of it as a recipe — anyone should be able to follow it and get the same result.</p>

<p>Examples of SOPs:</p>
<ul>
<li>How to onboard a new client</li>
<li>How to process a refund</li>
<li>How to post on social media</li>
<li>How to respond to customer complaints</li>
<li>How to create an invoice</li>
</ul>

<h2>Why SOPs Matter</h2>
<p><strong>Consistency:</strong> Every customer gets the same experience, every time.</p>
<p><strong>Training:</strong> New employees can get up to speed fast.</p>
<p><strong>Delegation:</strong> You can hand off tasks without constant supervision.</p>
<p><strong>Scale:</strong> Processes work whether you have 2 employees or 200.</p>
<p><strong>Quality:</strong> Mistakes decrease when there is a documented process.</p>

<h2>How to Create an SOP</h2>
<ol>
<li><strong>Pick one process:</strong> Start with something you do frequently</li>
<li><strong>Record yourself doing it:</strong> Use Loom or screen recording</li>
<li><strong>Write each step:</strong> Be specific — assume the reader knows nothing</li>
<li><strong>Add screenshots:</strong> Visual guides reduce confusion</li>
<li><strong>Test it:</strong> Have someone follow it and note where they get stuck</li>
<li><strong>Refine:</strong> Update based on feedback</li>
</ol>

<h2>SOP Format Template</h2>
<ul>
<li><strong>Title:</strong> What process is this?</li>
<li><strong>Purpose:</strong> Why does this process exist?</li>
<li><strong>Scope:</strong> When does this apply?</li>
<li><strong>Materials:</strong> What tools or access is needed?</li>
<li><strong>Steps:</strong> Numbered, detailed instructions</li>
<li><strong>Troubleshooting:</strong> Common issues and solutions</li>
</ul>

<h2>Where to Store SOPs</h2>
<p>Google Docs, Notion, Trainual, or your project management tool. The key is that everyone can access and search them easily.</p>

<div class="blog-cta">
<h3>Need Branded SOP Templates?</h3>
<p>We create professional document templates that match your brand.</p>
<a onclick="showView('services')" class="btn-cta">Get Branded Templates</a>
</div>
        `
    },
    {
        id: 29,
        slug: 'what-is-crm-customer-relationship-management',
        title: 'What Is a CRM? The Small Business Guide to Customer Relationship Management',
        excerpt: 'A CRM is the command center for your customer relationships. Here is what it does, why you need one, and which options work for small businesses.',
        category: 'Technology',
        image: 'https://images.unsplash.com/photo-1552581234-26160f608093?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'July 15, 2025',
        readTime: '9 min read',
        content: `
<p class="blog-lead">If your customer data lives in spreadsheets, sticky notes, and your memory, you are leaving money on the table. A CRM (Customer Relationship Management) system changes everything.</p>

<h2>What Is a CRM?</h2>
<p>A CRM is software that helps you track and manage all your interactions with customers and potential customers. It is a central database where every conversation, purchase, and touchpoint is recorded.</p>

<p>Think of it as your business's memory — but better, because it is searchable, shareable, and never forgets.</p>

<h2>What Does a CRM Do?</h2>
<ul>
<li><strong>Contact Management:</strong> Store all customer info in one place</li>
<li><strong>Interaction Tracking:</strong> Log calls, emails, meetings</li>
<li><strong>Deal Pipeline:</strong> Track sales opportunities through stages</li>
<li><strong>Task Management:</strong> Set reminders to follow up</li>
<li><strong>Email Integration:</strong> Send and track emails from the CRM</li>
<li><strong>Reporting:</strong> See sales metrics and forecasts</li>
<li><strong>Automation:</strong> Trigger actions based on customer behavior</li>
</ul>

<h2>Why Your Business Needs a CRM</h2>
<p><strong>No more lost leads:</strong> Every inquiry is tracked and followed up.</p>
<p><strong>Better customer service:</strong> Anyone on your team can see full history.</p>
<p><strong>More sales:</strong> Consistent follow-up closes more deals.</p>
<p><strong>Data-driven decisions:</strong> See what is working and what is not.</p>
<p><strong>Scale your team:</strong> New salespeople can hit the ground running.</p>

<h2>Popular CRM Options for Small Business</h2>
<ul>
<li><strong>HubSpot CRM:</strong> Free tier, great for beginners</li>
<li><strong>Pipedrive:</strong> Visual pipeline, sales-focused</li>
<li><strong>Zoho CRM:</strong> Affordable, full-featured</li>
<li><strong>Salesforce:</strong> Enterprise-level, complex</li>
<li><strong>Monday.com:</strong> Flexible, good for project + CRM</li>
<li><strong>GoHighLevel:</strong> All-in-one marketing + CRM</li>
</ul>

<h2>When to Get a CRM</h2>
<p>If you have more than 20 customers or leads, you need a CRM. If you are forgetting to follow up, you need a CRM. If more than one person talks to customers, you need a CRM.</p>

<div class="blog-cta">
<h3>Need a Custom CRM Solution?</h3>
<p>We build custom web apps tailored to your exact business process.</p>
<a onclick="showView('services')" class="btn-cta">Explore Custom Solutions</a>
</div>
        `
    },
    {
        id: 30,
        slug: 'email-branding-how-it-works',
        title: 'How Email Branding Works: Make Every Email Represent Your Business',
        excerpt: 'Your emails are brand touchpoints. Here is how to brand your email signatures, templates, and newsletters for professional impact.',
        category: 'Branding',
        image: 'https://images.unsplash.com/photo-1596526131083-e8c633c948d2?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'July 8, 2025',
        readTime: '7 min read',
        content: `
<p class="blog-lead">Your team sends hundreds of emails per week. Every single one is a brand impression. Here is how to make sure those impressions are working for you.</p>

<h2>The Three Layers of Email Branding</h2>

<h3>1. Professional Email Address</h3>
<p>yourname@gmail.com says amateur. yourname@yourbusiness.com says professional. Custom domain email is non-negotiable for any serious business.</p>
<p>Options: Google Workspace, Microsoft 365, Zoho Mail</p>

<h3>2. Email Signature</h3>
<p>Your signature appears on every email. It should include:</p>
<ul>
<li>Your name and title</li>
<li>Company name and logo</li>
<li>Phone number</li>
<li>Website link</li>
<li>Social media icons (optional)</li>
<li>Call-to-action or tagline (optional)</li>
</ul>
<p>Keep it clean. Avoid quotes, too many colors, or massive images.</p>

<h3>3. Email Templates</h3>
<p>For newsletters, promotions, and announcements, branded templates create consistency. Your colors, fonts, and logo should be instantly recognizable.</p>

<h2>Email Signature Best Practices</h2>
<ul>
<li><strong>Keep it under 6 lines:</strong> Nobody reads a novel</li>
<li><strong>Use your brand colors:</strong> Sparingly, for links or accents</li>
<li><strong>Logo size:</strong> Keep it small (100-150px wide max)</li>
<li><strong>Mobile-friendly:</strong> Test how it looks on phones</li>
<li><strong>Consistent across team:</strong> Everyone should match</li>
</ul>

<h2>Newsletter Branding Elements</h2>
<ul>
<li><strong>Header:</strong> Logo and brand colors</li>
<li><strong>Typography:</strong> Web-safe fonts that match your brand</li>
<li><strong>Button styles:</strong> Consistent with your website</li>
<li><strong>Footer:</strong> Contact info, social links, unsubscribe</li>
<li><strong>Image style:</strong> Consistent editing and treatment</li>
</ul>

<h2>Tools for Email Branding</h2>
<ul>
<li><strong>Signatures:</strong> WiseStamp, HubSpot, Canva</li>
<li><strong>Newsletters:</strong> Mailchimp, ConvertKit, Klaviyo</li>
<li><strong>Templates:</strong> Stripo, Bee Free, Litmus</li>
</ul>

<div class="blog-cta">
<h3>Need Professional Email Templates?</h3>
<p>We design branded email signatures and newsletter templates.</p>
<a onclick="showView('services')" class="btn-cta">Get Email Branding</a>
</div>
        `
    },
    {
        id: 31,
        slug: 'how-to-send-email-blast-eblast-guide',
        title: 'How to Send an Email Blast: The Complete E-Blast Guide for Small Business',
        excerpt: 'Email blasts still work when done right. Here is how to send e-blasts that get opened, read, and drive action.',
        category: 'Marketing',
        image: 'https://images.unsplash.com/photo-1563986768494-4dee2763ff3f?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'July 1, 2025',
        readTime: '10 min read',
        content: `
<p class="blog-lead">An email blast (or e-blast) is a single email sent to your entire list at once. Done right, it is one of the highest-ROI marketing activities. Done wrong, it lands in spam. Here is how to do it right.</p>

<h2>What Is an Email Blast?</h2>
<p>An email blast is a one-time email sent to many recipients simultaneously. Unlike automated sequences that trigger based on behavior, an e-blast is a broadcast — same message, same time, to everyone (or a segment).</p>

<p>Common uses:</p>
<ul>
<li>Product launches</li>
<li>Sale announcements</li>
<li>Event invitations</li>
<li>Company news</li>
<li>Newsletter editions</li>
</ul>

<h2>Step-by-Step: Sending Your First E-Blast</h2>

<h3>Step 1: Choose Your Platform</h3>
<p>You cannot send mass emails from Gmail — you will get flagged as spam. Use an email marketing platform:</p>
<ul>
<li><strong>Mailchimp:</strong> Free up to 500 contacts</li>
<li><strong>ConvertKit:</strong> Great for creators</li>
<li><strong>Constant Contact:</strong> Small business friendly</li>
<li><strong>Klaviyo:</strong> E-commerce focused</li>
<li><strong>Brevo (Sendinblue):</strong> Affordable high volume</li>
</ul>

<h3>Step 2: Build Your List</h3>
<p>Import your contacts. Make sure you have permission to email them (they opted in). Buying email lists is illegal in many places and destroys deliverability.</p>

<h3>Step 3: Segment If Needed</h3>
<p>Not every email should go to everyone. Segment by customer type, location, purchase history, or engagement level.</p>

<h3>Step 4: Write Your Email</h3>
<ul>
<li><strong>Subject line:</strong> 40 characters or less, creates curiosity</li>
<li><strong>Preview text:</strong> Supports the subject line</li>
<li><strong>Body:</strong> One clear message, one clear CTA</li>
<li><strong>Design:</strong> Use your branded template</li>
</ul>

<h3>Step 5: Test Before Sending</h3>
<p>Send a test to yourself. Check on desktop AND mobile. Click every link.</p>

<h3>Step 6: Schedule and Send</h3>
<p>Best times vary, but Tuesday-Thursday between 10am-2pm tends to perform well. Test and track your own data.</p>

<h2>E-Blast Mistakes to Avoid</h2>
<ul>
<li>No clear call-to-action</li>
<li>Too many topics in one email</li>
<li>Sending from no-reply@ addresses</li>
<li>Forgetting mobile optimization</li>
<li>Not cleaning your list regularly</li>
</ul>

<div class="blog-cta">
<h3>Need E-Blast Templates That Convert?</h3>
<p>We design branded email templates that get results.</p>
<a onclick="showView('services')" class="btn-cta">Get Email Templates</a>
</div>
        `
    },
    {
        id: 32,
        slug: 'how-to-get-more-dms-direct-messages',
        title: 'How to Get More DMs: Turn Your Social Media Into a Lead Machine',
        excerpt: 'DMs are where deals happen. Here is how to create content that makes people want to message you — and start real conversations.',
        category: 'Social Media',
        image: 'https://images.unsplash.com/photo-1611926653458-09294b3142bf?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'June 24, 2025',
        readTime: '9 min read',
        content: `
<p class="blog-lead">Likes are vanity. DMs are money. The businesses winning on social media are the ones turning followers into conversations. Here is exactly how to get more direct messages.</p>

<h2>Why DMs Matter More Than Followers</h2>
<p>A DM is intent. Someone took time to privately reach out. That is a warm lead. 10 DMs from qualified prospects beats 10,000 passive followers every time.</p>

<h2>Content That Generates DMs</h2>

<h3>1. "DM Me" Call-to-Actions</h3>
<p>Literally ask. "DM me 'GUIDE' and I will send you my free checklist." "Have questions? DM me, I respond to everyone." Direct asks work.</p>

<h3>2. Controversial Takes</h3>
<p>Strong opinions attract people who agree (and disagree). They will DM to share their thoughts. Safe, boring content generates nothing.</p>

<h3>3. Behind-the-Scenes Content</h3>
<p>Show your process. People are curious. They will DM asking questions about how you do what you do.</p>

<h3>4. Results and Case Studies</h3>
<p>"Just helped a client 3x their revenue." People who want similar results will reach out.</p>

<h3>5. Relatable Struggles</h3>
<p>Share your challenges. Vulnerability creates connection. People DM to say "me too."</p>

<h2>Optimize Your Profile for DMs</h2>
<ul>
<li><strong>Bio:</strong> Clear statement of who you help and how</li>
<li><strong>CTA in bio:</strong> "DM me to get started"</li>
<li><strong>Highlights:</strong> Testimonials, services, FAQ</li>
<li><strong>Link:</strong> Booking page or lead magnet</li>
</ul>

<h2>The DM Conversation Framework</h2>
<ol>
<li><strong>Acknowledge:</strong> Thank them for reaching out</li>
<li><strong>Qualify:</strong> Ask about their situation</li>
<li><strong>Provide value:</strong> Give a quick win or insight</li>
<li><strong>Transition:</strong> Offer a call or next step</li>
</ol>

<h2>Use Stories to Drive DMs</h2>
<p>Instagram Stories with polls, questions, and sliders create interaction. Reply to every response — this opens a DM thread. Now you are in conversation.</p>

<div class="blog-cta">
<h3>Need a Social Media Strategy?</h3>
<p>We create content systems designed to generate leads.</p>
<a onclick="showView('services')" class="btn-cta">Build Your Social Strategy</a>
</div>
        `
    },
    {
        id: 33,
        slug: 'how-to-get-more-engagement-social-media',
        title: 'How to Get More Engagement on Social Media (Without Begging for Likes)',
        excerpt: 'Engagement is not about luck — it is about strategy. Here are the proven tactics that make people comment, share, and save your content.',
        category: 'Social Media',
        image: 'https://images.unsplash.com/photo-1611162618071-b39a2ec055fb?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'June 17, 2025',
        readTime: '10 min read',
        content: `
<p class="blog-lead">"Like if you agree!" is not a strategy. Real engagement comes from content that triggers emotional and intellectual responses. Here is how to create posts people actually interact with.</p>

<h2>Why Engagement Matters</h2>
<p>The algorithm rewards engagement. Posts with comments, shares, and saves get shown to more people. Low engagement = the algorithm buries your content. It is a flywheel — engagement creates more reach, which creates more engagement.</p>

<h2>The Engagement Hierarchy</h2>
<p>Not all engagement is equal. From most to least valuable:</p>
<ol>
<li><strong>Saves:</strong> Highest signal — people want to return to this</li>
<li><strong>Shares:</strong> They are putting their reputation on it</li>
<li><strong>Comments:</strong> They took time to respond</li>
<li><strong>Likes:</strong> Lowest effort, but still counts</li>
</ol>

<h2>Content Types That Drive Engagement</h2>

<h3>1. Ask Questions</h3>
<p>End posts with a genuine question. Not "thoughts?" — that is lazy. Specific questions: "What is the biggest challenge you are facing with X right now?"</p>

<h3>2. Hot Takes and Opinions</h3>
<p>"Unpopular opinion: [your take]." Strong positions polarize — and polarization drives engagement. Agreers and disagreers both comment.</p>

<h3>3. Educational Carousels</h3>
<p>Multi-slide posts with valuable information get saved. "5 mistakes killing your [X]" — people save these to reference later.</p>

<h3>4. Story-Driven Content</h3>
<p>Personal stories create emotional connection. Vulnerability, failures, and comebacks resonate more than polished success.</p>

<h3>5. Fill-in-the-Blank</h3>
<p>"The best business advice I ever got was ______." Easy for people to respond to.</p>

<h2>Engagement Tactics That Work</h2>
<ul>
<li><strong>Reply to every comment:</strong> Doubles your comment count and builds relationships</li>
<li><strong>Engage before posting:</strong> 15 minutes of commenting on others' posts primes the algorithm</li>
<li><strong>Post when your audience is online:</strong> Check your analytics</li>
<li><strong>Use all features:</strong> Reels, Stories, carousels — platforms reward users who use new features</li>
<li><strong>Create "saveable" content:</strong> Checklists, frameworks, templates</li>
</ul>

<h2>What Kills Engagement</h2>
<ul>
<li>Posting links (platforms hate sending people away)</li>
<li>Stock photos and generic graphics</li>
<li>Pure self-promotion with no value</li>
<li>Inconsistent posting (algorithm forgets you)</li>
<li>Ignoring comments and DMs</li>
</ul>

<div class="blog-cta">
<h3>Need Content That Engages?</h3>
<p>We create social media templates and strategies that drive real interaction.</p>
<a onclick="showView('services')" class="btn-cta">Boost Your Engagement</a>
</div>
        `
    },
    {
        id: 34,
        slug: 'businesses-leaving-social-media-traditional-marketing',
        title: 'Why Smart Businesses Are Leaving Social Media and Going Back to Cold Calls and Mailers',
        excerpt: 'The social media backlash is real. Here is why some businesses are ditching the algorithm and returning to direct mail, cold calling, and old-school marketing.',
        category: 'Marketing',
        image: 'https://images.unsplash.com/photo-1586769852044-692d6e3703f0?w=800&q=80',
        author: 'Faren Young',
        authorImage: 'icons/icon-192.png',
        date: 'June 10, 2025',
        readTime: '11 min read',
        content: `
<p class="blog-lead">Something interesting is happening. While everyone obsesses over Instagram algorithms and TikTok trends, a growing number of successful businesses are quietly going back to basics: cold calls, direct mail, and face-to-face networking. Here is why — and what it means for your marketing strategy.</p>

<h2>The Social Media Exhaustion Is Real</h2>
<p>Business owners are burned out. The constant content treadmill. The algorithm changes. The pay-to-play model where organic reach keeps dying. Many are asking: "Is this actually working, or am I just busy?"</p>

<p>The numbers tell the story:</p>
<ul>
<li>Facebook organic reach: down to 2-5% of followers</li>
<li>Instagram engagement rates: dropped 30% since 2020</li>
<li>Time spent creating content: 10-20 hours per week for most businesses</li>
<li>Actual ROI: often unmeasurable or disappointing</li>
</ul>

<h2>Why Traditional Marketing Is Making a Comeback</h2>

<h3>1. Less Competition in the Mailbox</h3>
<p>Everyone went digital. That means physical mailboxes are less crowded than they have been in decades. A well-designed direct mail piece stands out because nobody else is doing it.</p>
<p>Direct mail response rates are now 5-9% compared to email's 1%. That is not a typo.</p>

<h3>2. Cold Calling Actually Works (When Done Right)</h3>
<p>The phone still works. Decision makers answer calls. While everyone is hiding behind DMs and emails, the salesperson who picks up the phone gets through. Less competition = more opportunity.</p>

<h3>3. You Own the Relationship</h3>
<p>Social media followers are rented. The platform can change the rules, ban your account, or die (remember Vine?). A phone number, email address, or mailing address is YOURS. Nobody can algorithm that away.</p>

<h3>4. Higher Quality Conversations</h3>
<p>A phone call or in-person meeting builds more trust in 15 minutes than 6 months of social media content. Real conversation beats parasocial relationships.</p>

<h3>5. Measurable ROI</h3>
<p>You sent 500 mailers. 25 people called. 5 became customers worth $10,000 each. That is clear math. Social media? "We got 50,000 impressions" means nothing to your bank account.</p>

<h2>What Traditional Marketing Looks Like in 2026</h2>

<h3>Direct Mail (Done Right)</h3>
<ul>
<li><strong>Handwritten envelopes:</strong> 99% open rate</li>
<li><strong>Dimensional mailers:</strong> Boxes and tubes get opened</li>
<li><strong>Personalization:</strong> Variable data printing makes each piece unique</li>
<li><strong>Follow-up sequences:</strong> Multiple touches, not one-and-done</li>
</ul>

<h3>Cold Calling (The Modern Way)</h3>
<ul>
<li><strong>Research first:</strong> Know who you are calling and why</li>
<li><strong>Value-first approach:</strong> Lead with insight, not a pitch</li>
<li><strong>Multi-channel:</strong> Call + email + LinkedIn touch</li>
<li><strong>Persistence:</strong> Average sale takes 8 touches</li>
</ul>

<h3>Networking and Events</h3>
<ul>
<li><strong>Industry conferences:</strong> One conversation can be worth 1,000 followers</li>
<li><strong>Local business groups:</strong> BNI, Chamber of Commerce, meetups</li>
<li><strong>Hosting your own events:</strong> Workshops, lunch-and-learns</li>
</ul>

<h2>The Hybrid Approach: Best of Both Worlds</h2>
<p>The smartest businesses are not abandoning social media entirely — they are rebalancing. Social media for awareness and credibility. Traditional methods for conversion and relationship-building.</p>

<p>A balanced marketing mix might look like:</p>
<ul>
<li>30% social media (brand awareness, content)</li>
<li>25% email marketing (nurturing, offers)</li>
<li>20% direct outreach (cold calls, LinkedIn DMs)</li>
<li>15% direct mail (high-value prospects)</li>
<li>10% networking/events (relationship building)</li>
</ul>

<h2>When to Consider Going Traditional</h2>
<ul>
<li>Your target customer is over 40</li>
<li>You sell high-ticket B2B services</li>
<li>Your local market matters more than national reach</li>
<li>You are exhausted by the content hamster wheel</li>
<li>Your social media ROI is unclear or negative</li>
</ul>

<h2>Your Brand Still Matters (Maybe More)</h2>
<p>Here is the thing: traditional marketing requires even better branding. Your direct mail piece has 3 seconds to make an impression. Your cold call opener needs instant credibility. Your business card gets judged immediately.</p>

<p>Going old-school does not mean looking old-school. Premium brand identity makes every traditional touchpoint more effective.</p>

<div class="blog-cta">
<h3>Need Branding That Works Everywhere?</h3>
<p>We create brand systems designed for both digital and traditional marketing.</p>
<a onclick="showView('services')" class="btn-cta">Build Your Brand System</a>
</div>
        `
    }
];

let currentBlogPost = null;
let blogAuthorImage = localStorage.getItem('nui_blog_author_image') || '';

function saveBlogPosts() { localStorage.setItem('nui_blog_posts', JSON.stringify(blogPosts)); }

function loadAdminBlogPanel() {
    document.getElementById('adminBlogPanel').innerHTML = `
<div class="panel-header">
<h2 class="panel-title">📝 Blog Manager</h2>
<p class="panel-subtitle">Create, edit, and manage your blog posts</p>
</div>

        <!-- Author / Blog Logo -->
<div style="background: #111; border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 24px; margin-bottom: 24px; display: flex; align-items: center; gap: 20px;">
<div id="blogAuthorPreview" style="width: 64px; height: 64px; border-radius: 50%; background: var(--red); display: flex; align-items: center; justify-content: center; overflow: hidden; color: #fff; font-weight: 700; font-size: 24px; flex-shrink: 0; cursor: pointer;" onclick="document.getElementById('blogAuthorUpload').click()" title="Click to upload blog logo/icon">
                ${blogAuthorImage ? '<img alt="Blog author photo" loading="lazy" src="' + blogAuthorImage + '" style="width:100%;height:100%;object-fit:cover;">' : 'F'}
</div>
<div style="flex: 1;">
<div style="font-weight: 600; color: #fff; margin-bottom: 4px;">Blog Author Image / Logo</div>
<div style="font-size: 13px; color: rgba(255,255,255,0.5); margin-bottom: 8px;">Click the circle to upload. Used on all blog posts as the author avatar.</div>
<input type="file" id="blogAuthorUpload" accept="image/*" style="display: none;" onchange="handleBlogAuthorUpload(event)">
<div style="display: flex; gap: 8px;">
<button onclick="document.getElementById('blogAuthorUpload').click()" class="btn-admin" style="background: rgba(255,255,255,0.1); color: #fff; padding: 8px 16px; font-size: 12px;">📷 Upload Image</button>
<input type="text" id="blogAuthorUrlInput" placeholder="Or paste image URL..." value="${blogAuthorImage}" onchange="setBlogAuthorFromUrl(this.value)" style="flex: 1; padding: 8px 12px; background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #fff; font-size: 12px;">
</div>
</div>
</div>

        <!-- Blog Posts List -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
<h3 style="color: #fff;">${blogPosts.length} Posts</h3>
<button onclick="showBlogEditor()" class="btn-admin primary">+ New Post</button>
</div>

<div style="display: flex; flex-direction: column; gap: 12px;">
            ${blogPosts.map((post, i) => `
<div style="background: #111; border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 20px; display: flex; gap: 16px; align-items: center;">
<div style="width: 80px; height: 50px; border-radius: 8px; overflow: hidden; background: #1a1a1a; flex-shrink: 0;">
                        ${post.image ? '<img alt="Blog post featured image" loading="lazy" src="' + post.image + '" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display=\'none\'">' : ''}
</div>
<div style="flex: 1; min-width: 0;">
<div style="font-weight: 600; color: #fff; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${post.title}</div>
<div style="display: flex; gap: 8px; align-items: center;">
<span style="font-size: 11px; padding: 2px 8px; border-radius: 4px; background: rgba(230,57,70,0.2); color: #e63946;">${post.category}</span>
<span style="font-size: 12px; color: rgba(255,255,255,0.4);">${post.date}</span>
<span style="font-size: 12px; color: rgba(255,255,255,0.4);">${post.readTime}</span>
</div>
</div>
<div style="display: flex; gap: 8px; flex-shrink: 0;">
<button onclick="showBlogEditor(${post.id})" style="padding: 8px 12px; background: #3b82f6; border: none; color: #fff; border-radius: 6px; cursor: pointer; font-size: 12px;">✏️ Edit</button>
<button onclick="deleteBlogPost(${post.id})" style="padding: 8px 12px; background: rgba(239,68,68,0.2); border: none; color: #ef4444; border-radius: 6px; cursor: pointer; font-size: 12px;">🗑️</button>
</div>
</div>
            `).join('')}
</div>
    `;
}

function handleBlogAuthorUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        blogAuthorImage = e.target.result;
        localStorage.setItem('nui_blog_author_image', blogAuthorImage);
        // Update all posts
        blogPosts.forEach(p => p.authorImage = blogAuthorImage);
        saveBlogPosts();
        loadAdminBlogPanel();
    };
    reader.readAsDataURL(file);
}

function setBlogAuthorFromUrl(url) {
    if (!url) return;
    blogAuthorImage = url;
    localStorage.setItem('nui_blog_author_image', blogAuthorImage);
    blogPosts.forEach(p => p.authorImage = blogAuthorImage);
    saveBlogPosts();
    loadAdminBlogPanel();
}

function showBlogEditor(postId) {
    const post = postId ? blogPosts.find(p => p.id === postId) : null;
    const isNew = !post;

    const modal = document.createElement('div');
    modal.id = 'blogEditorModal';
    modal.innerHTML = `
<div style="position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 9999; padding: 20px;">
<div style="background: #111; border-radius: 16px; padding: 32px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto;">
<h2 style="font-size: 20px; margin-bottom: 24px; color: #fff;">${isNew ? '📝 New Blog Post' : '✏️ Edit Post'}</h2>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
<div>
<label style="display: block; font-size: 13px; color: rgba(255,255,255,0.6); margin-bottom: 6px;">Title</label>
<input type="text" id="blogEditTitle" value="${post?.title || ''}" placeholder="Post title..." style="width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
</div>
<div>
<label style="display: block; font-size: 13px; color: rgba(255,255,255,0.6); margin-bottom: 6px;">Category</label>
<select id="blogEditCategory" style="width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
                            ${['Branding', 'Business Strategy', 'Personal Branding', 'Sales Strategy', 'Brand Strategy', 'Web Design', 'Technology', 'Social Media', 'Marketing'].map(c => '<option value="' + c + '"' + (post?.category === c ? ' selected' : '') + '>' + c + '</option>').join('')}
</select>
</div>
</div>

<div style="margin-bottom: 16px;">
<label style="display: block; font-size: 13px; color: rgba(255,255,255,0.6); margin-bottom: 6px;">Featured Image URL</label>
<input type="text" id="blogEditImage" value="${post?.image || ''}" placeholder="https://images.unsplash.com/..." style="width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
</div>

<div style="margin-bottom: 16px;">
<label style="display: block; font-size: 13px; color: rgba(255,255,255,0.6); margin-bottom: 6px;">Excerpt (short preview)</label>
<textarea id="blogEditExcerpt" rows="2" placeholder="Brief description..." style="width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; resize: none;">${post?.excerpt || ''}</textarea>
</div>

<div style="margin-bottom: 16px;">
<label style="display: block; font-size: 13px; color: rgba(255,255,255,0.6); margin-bottom: 6px;">Content (HTML supported)</label>
<textarea id="blogEditContent" rows="12" placeholder="<p>Write your blog post content here...</p>&#10;<h2>Section Header</h2>&#10;<p>More content...</p>" style="width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; resize: vertical; font-family: monospace; font-size: 13px;">${post?.content?.replace(/</g, '&lt;').replace(/>/g, '&gt;') || ''}</textarea>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
<div>
<label style="display: block; font-size: 13px; color: rgba(255,255,255,0.6); margin-bottom: 6px;">Author</label>
<input type="text" id="blogEditAuthor" value="${post?.author || 'Faren Young'}" style="width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
</div>
<div>
<label style="display: block; font-size: 13px; color: rgba(255,255,255,0.6); margin-bottom: 6px;">Read Time</label>
<input type="text" id="blogEditReadTime" value="${post?.readTime || '5 min read'}" style="width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
</div>
</div>

<div style="display: flex; gap: 12px;">
<button onclick="document.getElementById('blogEditorModal').remove()" style="flex: 1; padding: 14px; background: #333; border: none; color: #fff; border-radius: 8px; cursor: pointer;">Cancel</button>
<button onclick="saveBlogPost(${post?.id || 'null'})" style="flex: 1; padding: 14px; background: var(--red); border: none; color: #fff; border-radius: 8px; cursor: pointer; font-weight: 600;">${isNew ? 'Publish Post' : 'Save Changes'}</button>
</div>
</div>
</div>
    `;
    document.body.appendChild(modal);
}

function saveBlogPost(existingId) {
    const title = document.getElementById('blogEditTitle').value.trim();
    const category = document.getElementById('blogEditCategory').value;
    const image = document.getElementById('blogEditImage').value.trim();
    const excerpt = document.getElementById('blogEditExcerpt').value.trim();
    const content = document.getElementById('blogEditContent').value;
    const author = document.getElementById('blogEditAuthor').value.trim();
    const readTime = document.getElementById('blogEditReadTime').value.trim();

    if (!title) { alert('Please enter a title.'); return; }
    if (!content) { alert('Please enter content.'); return; }

    const slug = title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
    const today = new Date();
    const dateStr = today.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

    if (existingId) {
        const post = blogPosts.find(p => p.id === existingId);
        if (post) {
            post.title = title;
            post.slug = slug;
            post.category = category;
            post.image = image;
            post.excerpt = excerpt;
            post.content = content;
            post.author = author;
            post.authorImage = blogAuthorImage || post.authorImage;
            post.readTime = readTime;
        }
    } else {
        const newId = blogPosts.length > 0 ? Math.max(...blogPosts.map(p => p.id)) + 1 : 1;
        blogPosts.unshift({
            id: newId,
            slug: slug,
            title: title,
            excerpt: excerpt,
            category: category,
            image: image,
            author: author,
            authorImage: blogAuthorImage || '',
            date: dateStr,
            readTime: readTime,
            content: content
        });
    }

    saveBlogPosts();
    document.getElementById('blogEditorModal').remove();
    loadAdminBlogPanel();
    alert(existingId ? '✅ Post updated!' : '✅ Post published!');
}

function deleteBlogPost(postId) {
    if (!confirm('Delete this blog post? This cannot be undone.')) return;
    blogPosts = blogPosts.filter(p => p.id !== postId);
    saveBlogPosts();
    loadAdminBlogPanel();
}

function loadBlogView() {
    document.getElementById('blogView').innerHTML = `
<style>
            .blog-hero { padding: 140px 48px 80px; text-align: center; background: linear-gradient(180deg, #0a0a0a 0%, #050505 100%); position: relative; }
            .blog-hero::before { content: ''; position: absolute; inset: 0; background: url('https://images.unsplash.com/photo-1499750310107-5fef28a66643?w=1920&q=80') center/cover; opacity: 0.15; }
            .blog-hero-content { position: relative; z-index: 2; }
            .blog-hero h1 { font-size: clamp(48px, 8vw, 80px); font-weight: 900; text-transform: uppercase; margin-bottom: 16px; }
            .blog-hero h1 span { color: var(--red); }
            .blog-hero p { font-size: 18px; color: var(--gray); max-width: 600px; margin: 0 auto; }

            .blog-categories { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; padding: 32px 24px; background: #080808; border-bottom: 1px solid rgba(255,255,255,0.06); }
            .blog-category { padding: 10px 24px; background: transparent; border: 1px solid rgba(255,255,255,0.15); border-radius: 100px; color: rgba(255,255,255,0.7); font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
            .blog-category:hover, .blog-category.active { background: var(--red); border-color: var(--red); color: white; }

            .blog-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 32px; max-width: 1400px; margin: 0 auto; padding: 60px 48px; }
            .blog-card { background: #0a0a0a; border: 1px solid rgba(255,255,255,0.06); border-radius: 16px; overflow: hidden; transition: all 0.3s; cursor: pointer; }
            .blog-card:hover { transform: translateY(-8px); border-color: rgba(255,59,48,0.3); box-shadow: 0 20px 60px rgba(0,0,0,0.4); }
            .blog-card-image { position: relative; aspect-ratio: 16/9; overflow: hidden; }
            .blog-card-image img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
            .blog-card:hover .blog-card-image img { transform: scale(1.05); }
            .blog-card-image::after { content: ''; position: absolute; inset: 0; background: linear-gradient(180deg, transparent 50%, rgba(0,0,0,0.8) 100%); }
            .blog-card-category { position: absolute; top: 16px; left: 16px; background: var(--red); color: white; padding: 6px 14px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; z-index: 2; }
            .blog-card-content { padding: 28px; }
            .blog-card-title { font-size: 20px; font-weight: 800; line-height: 1.3; margin-bottom: 12px; color: #fff; }
            .blog-card-excerpt { font-size: 14px; color: var(--gray); line-height: 1.6; margin-bottom: 20px; }
            .blog-card-meta { display: flex; align-items: center; gap: 12px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.06); }
            .blog-card-author-img { width: 36px; height: 36px; border-radius: 50%; background: var(--red); display: flex; align-items: center; justify-content: center; overflow: hidden; color: #fff; font-weight: 700; font-size: 14px; }
            .blog-card-author-img img { width: 100%; height: 100%; object-fit: cover; }
            .blog-card-author-img img[src=''], .blog-card-author-img img:not([src]) { display: none; }
            .blog-card-author-name { font-size: 13px; font-weight: 600; color: #fff; }
            .blog-card-date { font-size: 12px; color: var(--gray); }
            .blog-card-read { font-size: 12px; color: var(--red); margin-left: auto; font-weight: 600; }

            /* SINGLE POST */
            .blog-post { max-width: 800px; margin: 0 auto; padding: 140px 24px 80px; }
            .blog-post-back { display: inline-flex; align-items: center; gap: 8px; color: var(--gray); font-size: 14px; margin-bottom: 32px; cursor: pointer; transition: color 0.3s; }
            .blog-post-back:hover { color: var(--red); }
            .blog-post-category { display: inline-block; background: var(--red); color: white; padding: 8px 16px; border-radius: 4px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; }
            .blog-post-title { font-size: clamp(32px, 5vw, 48px); font-weight: 900; line-height: 1.2; margin-bottom: 24px; }
            .blog-post-meta { display: flex; align-items: center; gap: 20px; padding-bottom: 32px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 40px; flex-wrap: wrap; }
            .blog-post-author { display: flex; align-items: center; gap: 12px; }
            .blog-post-author-img { width: 48px; height: 48px; border-radius: 50%; overflow: hidden; border: 2px solid var(--red); }
            .blog-post-author-img img { width: 100%; height: 100%; object-fit: cover; }
            .blog-post-author-name { font-weight: 700; color: #fff; }
            .blog-post-author-title { font-size: 13px; color: var(--gray); }
            .blog-post-date { color: var(--gray); font-size: 14px; }
            .blog-post-read { color: var(--red); font-size: 14px; font-weight: 600; }

            .blog-post-image { width: 100%; aspect-ratio: 16/9; border-radius: 16px; overflow: hidden; margin-bottom: 48px; position: relative; }
            .blog-post-image img { width: 100%; height: 100%; object-fit: cover; }
            .blog-post-image::after { content: ''; position: absolute; inset: 0; background: linear-gradient(180deg, rgba(255,59,48,0.2) 0%, transparent 100%); }

            .blog-post-content { font-size: 17px; line-height: 1.9; color: rgba(255,255,255,0.85); }
            .blog-post-content h2 { font-size: 28px; font-weight: 800; color: #fff; margin: 48px 0 20px; }
            .blog-post-content p { margin-bottom: 24px; }
            .blog-post-content .blog-lead { font-size: 20px; color: #fff; line-height: 1.7; margin-bottom: 32px; }
            .blog-post-content ul { margin: 24px 0; padding-left: 24px; }
            .blog-post-content li { margin-bottom: 12px; color: rgba(255,255,255,0.8); }
            .blog-post-content strong { color: #fff; }

            .blog-cta { background: linear-gradient(135deg, rgba(255,59,48,0.15) 0%, rgba(255,59,48,0.05) 100%); border: 1px solid rgba(255,59,48,0.2); border-radius: 16px; padding: 40px; text-align: center; margin: 48px 0; }
            .blog-cta h3 { font-size: 24px; font-weight: 800; margin-bottom: 12px; }
            .blog-cta p { color: var(--gray); margin-bottom: 24px; }
            .blog-cta .btn-cta { display: inline-block; }

            /* SHARE */
            .blog-share { display: flex; align-items: center; gap: 16px; padding: 32px 0; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 48px; }
            .blog-share-label { font-size: 14px; font-weight: 600; color: var(--gray); }
            .blog-share-buttons { display: flex; gap: 12px; }
            .blog-share-btn { width: 44px; height: 44px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; color: #fff; font-size: 18px; cursor: pointer; transition: all 0.3s; text-decoration: none; }
            .blog-share-btn:hover { background: var(--red); border-color: var(--red); transform: scale(1.1); }

            @media (max-width: 968px) {
                .blog-grid { grid-template-columns: repeat(2, 1fr); gap: 24px; padding: 40px 24px; }
            }
            @media (max-width: 600px) {
                .blog-hero { padding: 120px 24px 60px; }
                .blog-hero h1 { font-size: 36px; }
                .blog-grid { grid-template-columns: 1fr; gap: 20px; padding: 32px 16px; }
                .blog-card-content { padding: 20px; }
                .blog-card-title { font-size: 18px; }
                .blog-post { padding: 120px 16px 60px; }
                .blog-post-title { font-size: 28px; }
                .blog-post-content { font-size: 15px; }
                .blog-post-content h2 { font-size: 22px; }
                .blog-categories { padding: 20px 16px; gap: 8px; }
                .blog-category { padding: 8px 16px; font-size: 11px; }
            }
</style>

<div id="blogList">
<section class="blog-hero">
<div class="blog-hero-content">
<h2>THE <span>INFLUENCE</span> BLOG</h2>
<p>Insights, strategies, and real talk about building brands that dominate. No fluff, just actionable advice.</p>
</div>
</section>

<div class="blog-categories">
<button class="blog-category active" onclick="filterBlogPosts('all')">All Posts</button>
<button class="blog-category" onclick="filterBlogPosts('Branding')">Branding</button>
<button class="blog-category" onclick="filterBlogPosts('Personal Branding')">Personal Branding</button>
<button class="blog-category" onclick="filterBlogPosts('Sales Strategy')">Sales</button>
<button class="blog-category" onclick="filterBlogPosts('Business Strategy')">Business Strategy</button>
<button class="blog-category" onclick="filterBlogPosts('Brand Strategy')">Brand Strategy</button>
<button class="blog-category" onclick="filterBlogPosts('Web Design')">Web Design</button>
<button class="blog-category" onclick="filterBlogPosts('Technology')">Technology</button>
<button class="blog-category" onclick="filterBlogPosts('Social Media')">Social Media</button>
<button class="blog-category" onclick="filterBlogPosts('Marketing')">Marketing</button>
</div>

<div class="blog-grid" id="blogGrid">
                ${blogPosts.map(post => `
<article class="blog-card" data-category="${post.category}" onclick="showBlogPost(${post.id})">
<div class="blog-card-image">
<img loading="lazy" src="${post.image}" alt="${post.title}">
<span class="blog-card-category">${post.category}</span>
</div>
<div class="blog-card-content">
<h3 class="blog-card-title">${post.title}</h3>
<p class="blog-card-excerpt">${post.excerpt}</p>
<div class="blog-card-meta">
<div class="blog-card-author-img">${post.authorImage ? '<img loading="lazy" src="' + post.authorImage + '" alt="' + post.author + '" onerror="this.style.display=\'none\';this.parentElement.textContent=\'' + (post.author || 'N').charAt(0) + '\'">' : (post.author || 'N').charAt(0)}</div>
<div>
<div class="blog-card-author-name">${post.author}</div>
<div class="blog-card-date">${post.date}</div>
</div>
<span class="blog-card-read">${post.readTime}</span>
</div>
</div>
</article>
                `).join('')}
</div>
</div>

<div id="blogSingle" style="display: none;"></div>

        ${getFooterHTML()}
    `;
}

function filterBlogPosts(category) {
    document.querySelectorAll('.blog-category').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.includes(category) || (category === 'all' && btn.textContent === 'All Posts'));
    });

    document.querySelectorAll('.blog-card').forEach(card => {
        if (category === 'all' || card.dataset.category === category) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

function showBlogPost(postId) {
    const post = blogPosts.find(p => p.id === postId);
    if (!post) return;

    currentBlogPost = post;
    document.getElementById('blogList').style.display = 'none';
    document.getElementById('blogSingle').style.display = 'block';

    const shareUrl = encodeURIComponent('https://newurbaninfluence.com/blog/' + post.slug);
    const shareText = encodeURIComponent(post.title + ' - New Urban Influence');

    document.getElementById('blogSingle').innerHTML = `
<article class="blog-post">
<a class="blog-post-back" onclick="closeBlogPost()">← Back to Blog</a>
<span class="blog-post-category">${post.category}</span>
<h2 class="blog-post-title">${post.title}</h2>
<div class="blog-post-meta">
<div class="blog-post-author">
<div class="blog-post-author-img" style="${!post.authorImage ? 'background: var(--red); display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 700; font-size: 20px;' : ''}">${post.authorImage ? '<img loading="lazy" src="' + post.authorImage + '" alt="' + post.author + '" onerror="this.style.display=\'none\';this.parentElement.style.background=\'var(--red)\';this.parentElement.style.display=\'flex\';this.parentElement.style.alignItems=\'center\';this.parentElement.style.justifyContent=\'center\';this.parentElement.style.color=\'#fff\';this.parentElement.style.fontWeight=\'700\';this.parentElement.style.fontSize=\'20px\';this.parentElement.textContent=\'' + (post.author || 'N').charAt(0) + '\'">' : (post.author || 'N').charAt(0)}</div>
<div>
<div class="blog-post-author-name">${post.author}</div>
<div class="blog-post-author-title">Founder, New Urban Influence</div>
</div>
</div>
<span class="blog-post-date">${post.date}</span>
<span class="blog-post-read">${post.readTime}</span>
</div>
            ${post.image ? '<div class="blog-post-image"><img loading="lazy" src="' + post.image + '" alt="' + post.title + '" onerror="this.parentElement.style.display=\'none\'"></div>' : ''}
<div class="blog-post-content">
                ${post.content}
</div>
<div class="blog-share">
<span class="blog-share-label">Share this article:</span>
<div class="blog-share-buttons">
<a href="https://twitter.com/intent/tweet?text=${shareText}&url=${shareUrl}" target="_blank" class="blog-share-btn" title="Share on X/Twitter">𝕏</a>
<a href="https://www.facebook.com/sharer/sharer.php?u=${shareUrl}" target="_blank" class="blog-share-btn" title="Share on Facebook">f</a>
<a href="https://www.linkedin.com/shareArticle?mini=true&url=${shareUrl}&title=${shareText}" target="_blank" class="blog-share-btn" title="Share on LinkedIn">in</a>
<a href="mailto:?subject=${shareText}&body=Check out this article: ${shareUrl}" class="blog-share-btn" title="Share via Email">✉</a>
</div>
</div>
</article>
        ${getFooterHTML()}
    `;

    window.scrollTo(0, 0);
}

function closeBlogPost() {
    document.getElementById('blogList').style.display = 'block';
    document.getElementById('blogSingle').style.display = 'none';
    currentBlogPost = null;
    window.scrollTo(0, 0);
}

// ==================== PORTAL VIEW ====================
function loadPortalView() {
    document.getElementById('portalView').innerHTML = portalStyles + `
<div id="portalLogin" class="portal-login">
<div class="login-box">
<div style="text-align: center; margin-bottom: 32px;">
<img loading="lazy" src="icons/icon-192.png" alt="NUI" style="height: 60px; margin-bottom: 16px;">
<h2 style="font-size: 24px; margin-bottom: 8px;">Brand Portal</h2>
<p style="color: var(--gray); font-size: 14px;">Access your brand assets & orders</p>
</div>
<div class="login-tabs">
<button onclick="setLoginType('client')" id="clientTab" class="login-tab active">Client</button>
<button onclick="setLoginType('designer')" id="designerTab" class="login-tab">Designer</button>
<button onclick="setLoginType('admin')" id="adminTab" class="login-tab">Admin</button>
</div>
<form onsubmit="event.preventDefault(); handlePortalLogin(event);" action="javascript:void(0)">
<div class="form-group"><label class="form-label">Email</label><input type="email" id="portalEmail" class="form-input" placeholder="you@example.com" required></div>
<div class="form-group">
<label class="form-label">Password</label>
<input type="password" id="portalPassword" class="form-input" placeholder="••••••••" required>
<a onclick="forgotPassword()" style="display: block; text-align: right; margin-top: 8px; color: var(--red); font-size: 12px; cursor: pointer;">Forgot Password?</a>
</div>
<button type="submit" class="btn-cta" style="width: 100%; justify-content: center;">Sign In</button>
</form>

<div style="display: flex; align-items: center; margin: 24px 0; gap: 16px;">
<div style="flex: 1; height: 1px; background: #333;"></div>
<span style="color: #666; font-size: 12px;">or continue with</span>
<div style="flex: 1; height: 1px; background: #333;"></div>
</div>

                <!-- Social Login Buttons -->
<div style="display: flex; flex-direction: column; gap: 12px;">
<button onclick="googleSignIn()" style="display: flex; align-items: center; justify-content: center; gap: 12px; width: 100%; padding: 12px 16px; background: #fff; color: #333; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
<svg width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                        Continue with Google
</button>
</div>

                <!-- Staff Demo Credentials (hidden for clients) -->
<div id="staffDemoSection" style="display: none; margin-top: 24px;">
<p style="text-align: center; color: var(--gray); font-size: 11px; margin-bottom: 12px;">Staff Demo Credentials:<br>Designer: faren@nui.com / designer123<br>Admin: admin@nui.com / admin123</p>
<div style="display: flex; flex-direction: column; gap: 8px;">
<button onclick="quickAdminAccess()" style="padding: 12px 16px; background: linear-gradient(135deg, #e11d48, #be185d); border: none; color: #fff; cursor: pointer; border-radius: 8px; font-size: 14px; font-weight: 600; width: 100%;">⚡ Quick Admin Access (Demo)</button>
<button onclick="quickDesignerAccess()" style="padding: 10px 12px; background: #3b82f6; border: none; color: #fff; cursor: pointer; border-radius: 6px; font-size: 12px; font-weight: 500;">👨‍🎨 Quick Designer Access</button>
</div>
<button onclick="resetAllData()" style="margin-top: 12px; padding: 8px 16px; background: transparent; border: 1px solid #444; color: #888; cursor: pointer; border-radius: 4px; font-size: 11px; width: 100%;">🔄 Reset All Data</button>
</div>
</div>
</div>
<div id="adminDashboard" style="display: none;">
<header class="admin-header" style="background: var(--admin-header); border-bottom: 1px solid var(--admin-border);">
<div style="display: flex; align-items: center; gap: 16px;">
<img loading="lazy" id="adminHeaderLogo" src="icons/icon-192.png" alt="NUI" style="height: 32px;">
<span style="font-weight: 600; color: var(--admin-text);" id="adminHeaderTitle">Admin Dashboard</span>
</div>
<div style="display: flex; align-items: center; gap: 12px;">
<span id="adminUserInfo" style="font-size: 13px; color: var(--admin-text-muted);"></span>
<button class="theme-toggle-btn" onclick="toggleTheme()" style="padding: 8px 16px; background: var(--admin-card); border: 1px solid var(--admin-border); color: var(--admin-text); cursor: pointer; border-radius: 4px; font-family: inherit; font-weight: 500;">☀️ Light</button>
<button onclick="portalLogout()" style="padding: 8px 16px; background: var(--red); border: none; color: #fff; cursor: pointer; border-radius: 4px; font-family: inherit; font-weight: 500;">Logout</button>
</div>
</header>
<div class="admin-container">
<aside class="admin-sidebar" id="adminSidebar" style="background: var(--admin-sidebar); border-color: var(--admin-border);">
<nav class="admin-nav" id="adminNav">
<div class="admin-nav-group">
<span class="admin-nav-label" style="color: var(--admin-text-muted);">OVERVIEW</span>
<a onclick="showAdminPanel('dashboard')" class="admin-nav-link active" data-panel="dashboard">📊 Dashboard</a>
<a onclick="showAdminPanel('calendar')" class="admin-nav-link" data-panel="calendar">📅 Calendar</a>
<a onclick="showAdminPanel('analytics')" class="admin-nav-link" data-panel="analytics">📈 Site Analytics</a>
<a onclick="showAdminPanel('reviews')" class="admin-nav-link" data-panel="reviews">⭐ Google Reviews</a>
</div>
<div class="admin-nav-group">
<span class="admin-nav-label">CRM & SALES</span>
<a onclick="showAdminPanel('crm')" class="admin-nav-link" data-panel="crm">💼 CRM Pipeline</a>
<a onclick="showAdminPanel('clients')" class="admin-nav-link" data-panel="clients">👥 Clients</a>
<a onclick="showAdminPanel('leads')" class="admin-nav-link" data-panel="leads">🎯 Leads</a>
<a onclick="showAdminPanel('submissions')" class="admin-nav-link" data-panel="submissions">📩 Submissions</a>
</div>
<div class="admin-nav-group">
<span class="admin-nav-label">PROJECTS</span>
<a onclick="showAdminPanel('projects')" class="admin-nav-link" data-panel="projects">📂 Project Tracker</a>
<a onclick="showAdminPanel('orders')" class="admin-nav-link" data-panel="orders">📋 Orders</a>
<a onclick="showAdminPanel('proofs')" class="admin-nav-link" data-panel="proofs">✅ Proof Approval</a>
<a onclick="showAdminPanel('brandguide')" class="admin-nav-link" data-panel="brandguide">📘 Brand Guide</a>
<a onclick="showAdminPanel('delivery')" class="admin-nav-link" data-panel="delivery">📦 Delivery</a>
</div>
<div class="admin-nav-group">
<span class="admin-nav-label">BILLING</span>
<a onclick="showAdminPanel('payments')" class="admin-nav-link" data-panel="payments">💳 Payments</a>
<a onclick="showAdminPanel('invoices')" class="admin-nav-link" data-panel="invoices">📄 Invoices</a>
<a onclick="showAdminPanel('payouts')" class="admin-nav-link" data-panel="payouts">💰 Payouts</a>
<a onclick="showAdminPanel('stripe')" class="admin-nav-link" data-panel="stripe">💎 Stripe</a>
<a onclick="showAdminPanel('subscriptions')" class="admin-nav-link" data-panel="subscriptions">🔄 Subscriptions</a>
</div>
<div class="admin-nav-group">
<span class="admin-nav-label">SEO & MARKETING</span>
<a onclick="showAdminPanel('seo')" class="admin-nav-link" data-panel="seo">🔍 SEO/AEO/GEO</a>
<a onclick="showAdminPanel('gmb')" class="admin-nav-link" data-panel="gmb">📍 Google Business</a>
<a onclick="showAdminPanel('blog')" class="admin-nav-link" data-panel="blog">📝 Blog Manager</a>
<a onclick="showAdminPanel('emailmarketing')" class="admin-nav-link" data-panel="emailmarketing">📧 Email Marketing</a>
<a onclick="showAdminPanel('loyalty')" class="admin-nav-link" data-panel="loyalty">🎁 Loyalty Program</a>
</div>
<div class="admin-nav-group">
<span class="admin-nav-label">COMMUNICATIONS</span>
<a onclick="showAdminPanel('communications')" class="admin-nav-link" data-panel="communications">💬 Inbox Hub</a>
<a onclick="showAdminPanel('socialdm')" class="admin-nav-link" data-panel="socialdm">📱 Social DMs</a>
<a onclick="showAdminPanel('sms')" class="admin-nav-link" data-panel="sms">📲 SMS (OpenPhone)</a>
</div>
<div class="admin-nav-group">
<span class="admin-nav-label">CONTENT</span>
<a onclick="showAdminPanel('siteimages')" class="admin-nav-link" data-panel="siteimages">🖼️ Site Images</a>
<a onclick="showAdminPanel('assets')" class="admin-nav-link" data-panel="assets">📁 Client Assets</a>
<a onclick="showAdminPanel('portfolio')" class="admin-nav-link" data-panel="portfolio">🎨 Portfolio</a>
<a onclick="showAdminPanel('moodboard')" class="admin-nav-link" data-panel="moodboard">🎨 Moodboards</a>
<a onclick="showAdminPanel('about')" class="admin-nav-link" data-panel="about">📄 About Page</a>
</div>
<div class="admin-nav-group">
<span class="admin-nav-label">TEAM</span>
<a onclick="showAdminPanel('designers')" class="admin-nav-link" data-panel="designers">🎨 Designers</a>
<a onclick="showAdminPanel('newclient')" class="admin-nav-link" data-panel="newclient">➕ New Client</a>
<a onclick="showAdminPanel('neworder')" class="admin-nav-link" data-panel="neworder">➕ New Order</a>
</div>
<div class="admin-nav-group">
<span class="admin-nav-label">INTEGRATIONS</span>
<a onclick="showAdminPanel('integrations')" class="admin-nav-link" data-panel="integrations">🔗 All Integrations</a>
</div>
<div class="admin-nav-group">
<span class="admin-nav-label">SETTINGS</span>
<a onclick="showAdminPanel('usermanagement')" class="admin-nav-link" data-panel="usermanagement">🔐 User Management</a>
</div>
</nav>
</aside>
<main class="admin-main" style="background: var(--admin-bg);">
<div id="adminDashboardPanel" class="admin-panel active"></div>
<div id="adminCalendarPanel" class="admin-panel"></div>
<div id="adminAnalyticsPanel" class="admin-panel"></div>
<div id="adminReviewsPanel" class="admin-panel"></div>
<div id="adminCrmPanel" class="admin-panel"></div>
<div id="adminClientsPanel" class="admin-panel"></div>
<div id="adminOrdersPanel" class="admin-panel"></div>
<div id="adminNewOrderPanel" class="admin-panel"></div>
<div id="adminLeadsPanel" class="admin-panel"></div>
<div id="adminSubmissionsPanel" class="admin-panel"></div>
<div id="adminProjectsPanel" class="admin-panel"></div>
<div id="adminProofsPanel" class="admin-panel"></div>
<div id="adminBrandguidePanel" class="admin-panel"></div>
<div id="adminDeliveryPanel" class="admin-panel"></div>
<div id="adminPaymentsPanel" class="admin-panel"></div>
<div id="adminInvoicesPanel" class="admin-panel"></div>
<div id="adminPayoutsPanel" class="admin-panel"></div>
<div id="adminStripePanel" class="admin-panel"></div>
<div id="adminSeoPanel" class="admin-panel"></div>
<div id="adminGmbPanel" class="admin-panel"></div>
<div id="adminBlogPanel" class="admin-panel"></div>
<div id="adminEmailmarketingPanel" class="admin-panel"></div>
<div id="adminLoyaltyPanel" class="admin-panel"></div>
<div id="adminCommunicationsPanel" class="admin-panel"></div>
<div id="adminSocialdmPanel" class="admin-panel"></div>
<div id="adminSmsPanel" class="admin-panel"></div>
<div id="adminSiteimagesPanel" class="admin-panel"></div>
<div id="adminNewclientPanel" class="admin-panel"></div>
<div id="adminAssetsPanel" class="admin-panel"></div>
<div id="adminPortfolioPanel" class="admin-panel"></div>
<div id="adminMoodboardPanel" class="admin-panel"></div>
<div id="adminAboutPanel" class="admin-panel"></div>
<div id="adminDesignersPanel" class="admin-panel"></div>
<div id="adminIntegrationsPanel" class="admin-panel"></div>
<div id="adminUsermanagementPanel" class="admin-panel"></div>
<div id="adminSubscriptionsPanel" class="admin-panel"></div>
</main>
</div>
</div>
<div id="clientPortal" style="display: none; min-height: 100vh; background: #000; color: #fff;">
<header style="background: #000; border-bottom: 1px solid rgba(255,255,255,0.1); padding: 16px 32px; display: flex; justify-content: space-between; align-items: center; position: fixed; top: 76px; left: 0; right: 0; z-index: 100;">
<span id="clientPortalName" style="font-weight: 600;"></span>
<button onclick="portalLogout()" style="padding: 8px 16px; background: transparent; border: 1px solid rgba(255,255,255,0.3); color: #fff; cursor: pointer; border-radius: 4px;">Sign Out</button>
</header>
<div id="clientPortalContent" style="padding-top: 132px;"></div>
</div>
<div id="invoiceModal" class="modal-overlay">
<div class="modal">
<div class="modal-header"><h3 class="modal-title">Invoice Preview</h3><button class="modal-close" onclick="closeInvoiceModal()">×</button></div>
<div class="modal-body" id="invoiceContent"></div>
<div class="modal-footer"><button class="btn-cta" onclick="printInvoice()">Print Invoice</button></div>
</div>
</div>

        <!-- Designer NDA Modal -->
<div id="ndaModal" class="modal-overlay" style="display: none;">
<div class="modal" style="max-width: 700px;">
<div class="modal-header" style="border-bottom: 1px solid rgba(255,255,255,0.1);">
<h3 class="modal-title">🔒 Non-Disclosure Agreement</h3>
</div>
<div class="modal-body" style="max-height: 60vh; overflow-y: auto; padding: 24px;">
<div style="background: rgba(255,0,0,0.1); border: 1px solid rgba(255,0,0,0.3); border-radius: 8px; padding: 16px; margin-bottom: 20px;">
<strong style="color: var(--red);">⚠️ IMPORTANT:</strong> You must read and agree to this NDA before accessing client projects.
</div>
<h4 style="margin-bottom: 12px;">DESIGNER NON-DISCLOSURE & NON-SOLICITATION AGREEMENT</h4>
<p style="color: #888; font-size: 13px; line-height: 1.7; margin-bottom: 16px;">This Agreement is entered into between New Urban Influence ("Company") and the undersigned Designer ("Contractor").</p>

<h5 style="margin: 16px 0 8px; color: var(--red);">1. CONFIDENTIAL INFORMATION</h5>
<p style="color: #888; font-size: 13px; line-height: 1.7;">Contractor agrees to hold in strict confidence all client information, project details, business strategies, pricing, and any other proprietary information disclosed during the course of work.</p>

<h5 style="margin: 16px 0 8px; color: var(--red);">2. NON-SOLICITATION OF CLIENTS</h5>
<p style="color: #888; font-size: 13px; line-height: 1.7;"><strong>Contractor agrees NOT to:</strong></p>
<ul style="color: #888; font-size: 13px; line-height: 1.7; margin-left: 20px;">
<li>Contact, solicit, or communicate with any Company client directly</li>
<li>Send emails, calls, texts, or DMs to clients or their associated venues/businesses</li>
<li>Accept direct work from Company clients for a period of 2 years after project completion</li>
<li>Share client contact information with any third party</li>
</ul>

<h5 style="margin: 16px 0 8px; color: var(--red);">3. NON-COMPETE</h5>
<p style="color: #888; font-size: 13px; line-height: 1.7;">Contractor shall not offer services identical or substantially similar to those provided to Company clients for 12 months after the termination of this agreement.</p>

<h5 style="margin: 16px 0 8px; color: var(--red);">4. WORK PRODUCT</h5>
<p style="color: #888; font-size: 13px; line-height: 1.7;">All work created for Company clients is the exclusive property of New Urban Influence and its clients. Contractor may not use, display, or claim ownership of work without written consent.</p>

<h5 style="margin: 16px 0 8px; color: var(--red);">5. BREACH & PENALTIES</h5>
<p style="color: #888; font-size: 13px; line-height: 1.7;">Violation of this agreement will result in immediate termination, forfeiture of unpaid earnings, and may result in legal action including damages of no less than $25,000 per incident.</p>

<div style="background: #111; border-radius: 8px; padding: 16px; margin-top: 24px;">
<label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer;">
<input type="checkbox" id="ndaAgree" style="margin-top: 4px; width: 20px; height: 20px; accent-color: var(--red);">
<span style="font-size: 13px; line-height: 1.6;">I have read, understand, and agree to all terms of this Non-Disclosure Agreement. I understand that violation of these terms will result in immediate termination and potential legal action.</span>
</label>
</div>
</div>
<div class="modal-footer" style="border-top: 1px solid rgba(255,255,255,0.1); display: flex; gap: 12px;">
<button onclick="declineNDA()" style="flex: 1; padding: 14px; background: #333; border: none; color: #fff; cursor: pointer; border-radius: 6px;">Decline</button>
<button onclick="acceptNDA()" id="ndaAcceptBtn" style="flex: 2; padding: 14px; background: var(--red); border: none; color: #fff; cursor: pointer; border-radius: 6px; font-weight: 600; opacity: 0.5;" disabled>Accept & Continue</button>
</div>
</div>
</div>

        <!-- Client Terms & Conditions Modal -->
<div id="termsModal" class="modal-overlay" style="display: none;">
<div class="modal" style="max-width: 700px;">
<div class="modal-header" style="border-bottom: 1px solid rgba(255,255,255,0.1);">
<h3 class="modal-title">📋 Terms & Conditions</h3>
</div>
<div class="modal-body" style="max-height: 60vh; overflow-y: auto; padding: 24px;">
<div style="background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3); border-radius: 8px; padding: 16px; margin-bottom: 20px;">
<strong style="color: #3b82f6;">📝 Please Review:</strong> These terms apply to your project with New Urban Influence.
</div>

<h4 style="margin-bottom: 12px;">SERVICE AGREEMENT TERMS</h4>

<h5 style="margin: 16px 0 8px; color: var(--red);">1. PROJECT TIMELINES</h5>
<p style="color: #888; font-size: 13px; line-height: 1.7;">All delivery dates and timelines provided are <strong>estimates only</strong> and not guaranteed. While we strive to meet all deadlines, project completion depends on timely client feedback, asset delivery, and approval responses. Delays caused by client response times will extend the project timeline accordingly.</p>

<h5 style="margin: 16px 0 8px; color: var(--red);">2. REVISIONS & CHANGES</h5>
<p style="color: #888; font-size: 13px; line-height: 1.7;">Each package includes a specified number of revision rounds. Additional revisions beyond the included amount will be billed at our standard hourly rate. Major scope changes after project start may require a new quote.</p>

<h5 style="margin: 16px 0 8px; color: var(--red);">3. PAYMENT TERMS</h5>
<p style="color: #888; font-size: 13px; line-height: 1.7;">A 50% deposit is required to begin work. The remaining balance is due upon project completion, prior to delivery of final files. Invoices not paid within 14 days may incur a 5% late fee.</p>

<h5 style="margin: 16px 0 8px; color: var(--red);">4. REFUND POLICY</h5>
<div style="background: rgba(255,0,0,0.1); border-left: 4px solid var(--red); padding: 12px 16px; margin: 12px 0;">
<p style="color: #fff; font-size: 13px; line-height: 1.7; margin: 0;"><strong>NO REFUNDS</strong> will be issued once work has commenced. By paying your invoice, you acknowledge that creative work has begun and the deposit is non-refundable. If you cancel before work begins, a full refund minus a 10% administrative fee will be issued.</p>
</div>

<h5 style="margin: 16px 0 8px; color: var(--red);">5. CLIENT RESPONSIBILITIES</h5>
<p style="color: #888; font-size: 13px; line-height: 1.7;">Client agrees to provide all necessary materials (logos, images, content, feedback) in a timely manner. Failure to respond within 7 days may result in project delays or the need to reschedule.</p>

<h5 style="margin: 16px 0 8px; color: var(--red);">6. INTELLECTUAL PROPERTY</h5>
<p style="color: #888; font-size: 13px; line-height: 1.7;">Upon full payment, client receives full ownership and rights to all final deliverables. New Urban Influence retains the right to display work in portfolios and marketing materials unless otherwise agreed in writing.</p>

<h5 style="margin: 16px 0 8px; color: var(--red);">7. LIMITATION OF LIABILITY</h5>
<p style="color: #888; font-size: 13px; line-height: 1.7;">New Urban Influence's liability is limited to the amount paid for services. We are not liable for any indirect, consequential, or incidental damages arising from the use of our services or deliverables.</p>

<div style="background: #111; border-radius: 8px; padding: 16px; margin-top: 24px;">
<label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer;">
<input type="checkbox" id="termsAgree" style="margin-top: 4px; width: 20px; height: 20px; accent-color: var(--red);">
<span style="font-size: 13px; line-height: 1.6;">I have read, understand, and agree to these Terms & Conditions. I understand that timelines are estimates and that <strong>no refunds</strong> are available once work has started.</span>
</label>
</div>
</div>
<div class="modal-footer" style="border-top: 1px solid rgba(255,255,255,0.1); display: flex; gap: 12px;">
<button onclick="closeTermsModal()" style="flex: 1; padding: 14px; background: #333; border: none; color: #fff; cursor: pointer; border-radius: 6px;">Cancel</button>
<button onclick="acceptTerms()" id="termsAcceptBtn" style="flex: 2; padding: 14px; background: var(--red); border: none; color: #fff; cursor: pointer; border-radius: 6px; font-weight: 600; opacity: 0.5;" disabled>Accept & Proceed to Payment</button>
</div>
</div>
</div>

        <!-- Meeting Calendar Modal -->
<div id="meetingModal" class="modal-overlay" style="display: none;">
<div class="modal" style="max-width: 600px;">
<div class="modal-header" style="border-bottom: 1px solid rgba(255,255,255,0.1);">
<h3 class="modal-title">📅 Schedule a Meeting</h3>
<button class="modal-close" onclick="closeMeetingModal()">×</button>
</div>
<div class="modal-body" style="padding: 24px;">
<p style="color: #888; margin-bottom: 24px;">Select your preferred meeting type, date, and time. Meetings are available Monday, Wednesday, and Friday from 10am to 4pm.</p>

<div style="margin-bottom: 20px;">
<label style="font-weight: 600; display: block; margin-bottom: 8px;">Meeting Type</label>
<div style="display: flex; gap: 12px;">
<label style="flex: 1; background: #111; border: 2px solid #333; border-radius: 8px; padding: 16px; cursor: pointer; text-align: center; transition: all 0.2s;" onclick="selectMeetingType('zoom')">
<input type="radio" name="meetingType" value="zoom" style="display: none;">
<div style="font-size: 24px; margin-bottom: 8px;">💻</div>
<div style="font-weight: 600;">Zoom Call</div>
<div style="font-size: 12px; color: #888;">Video meeting</div>
</label>
<label style="flex: 1; background: #111; border: 2px solid #333; border-radius: 8px; padding: 16px; cursor: pointer; text-align: center; transition: all 0.2s;" onclick="selectMeetingType('phone')">
<input type="radio" name="meetingType" value="phone" style="display: none;">
<div style="font-size: 24px; margin-bottom: 8px;">📞</div>
<div style="font-weight: 600;">Phone Call</div>
<div style="font-size: 12px; color: #888;">Voice only</div>
</label>
</div>
</div>

<div style="margin-bottom: 20px;">
<label style="font-weight: 600; display: block; margin-bottom: 8px;">Select Date</label>
<div id="calendarGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; background: #111; border-radius: 8px; padding: 12px;"></div>
</div>

<div style="margin-bottom: 20px;">
<label style="font-weight: 600; display: block; margin-bottom: 8px;">Select Time</label>
<div id="timeSlots" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;"></div>
</div>

<div id="selectedMeetingInfo" style="display: none; background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3); border-radius: 8px; padding: 16px; margin-top: 16px;">
<div style="font-weight: 600; color: #10b981; margin-bottom: 8px;">✓ Meeting Selected</div>
<div id="meetingDetails" style="color: #888; font-size: 14px;"></div>
</div>
</div>
<div class="modal-footer" style="border-top: 1px solid rgba(255,255,255,0.1);">
<button onclick="confirmMeeting()" id="confirmMeetingBtn" style="width: 100%; padding: 14px; background: var(--red); border: none; color: #fff; cursor: pointer; border-radius: 6px; font-weight: 600; opacity: 0.5;" disabled>Confirm Meeting</button>
</div>
</div>
</div>
    `;
    // Reset state and show login
    currentUser = null;
    loginType = 'client';
    setTimeout(() => {
        const loginEl = document.getElementById('portalLogin');
        const adminEl = document.getElementById('adminDashboard');
        const clientEl = document.getElementById('clientPortal');
        if (loginEl) loginEl.style.display = 'flex';
        if (adminEl) adminEl.style.display = 'none';
        if (clientEl) clientEl.style.display = 'none';
    }, 10);
}

function setLoginType(type) {
    loginType = type;
    document.getElementById('clientTab')?.classList.toggle('active', type === 'client');
    document.getElementById('designerTab')?.classList.toggle('active', type === 'designer');
    document.getElementById('managerTab')?.classList.toggle('active', type === 'manager');
    document.getElementById('adminTab')?.classList.toggle('active', type === 'admin');
}

// DEMO MODE - Password checks disabled
const DEMO_MODE = false;

// ==================== NDA & TERMS FUNCTIONS ====================
let pendingDesignerLogin = null;
let pendingPaymentInvoice = null;
let selectedMeeting = { type: null, date: null, time: null };

// NDA Modal Functions
function showNDAModal(designerData) {
    pendingDesignerLogin = designerData;
    document.getElementById('ndaModal').style.display = 'flex';
    document.getElementById('ndaAgree').checked = false;
    document.getElementById('ndaAcceptBtn').disabled = true;
    document.getElementById('ndaAcceptBtn').style.opacity = '0.5';
    // Add change listener
    document.getElementById('ndaAgree').addEventListener('change', function() {
        document.getElementById('ndaAcceptBtn').disabled = !this.checked;
        document.getElementById('ndaAcceptBtn').style.opacity = this.checked ? '1' : '0.5';
    });
}

function acceptNDA() {
    if (!document.getElementById('ndaAgree').checked) return;
    // Mark designer as NDA signed
    const designers = JSON.parse(localStorage.getItem('nui_designers') || '[]');
    const designerIdx = designers.findIndex(d => d.email === pendingDesignerLogin?.email);
    if (designerIdx >= 0) {
        designers[designerIdx].ndaSigned = true;
        designers[designerIdx].ndaSignedDate = new Date().toISOString();
        localStorage.setItem('nui_designers', JSON.stringify(designers));
    }
    document.getElementById('ndaModal').style.display = 'none';
    // Continue with designer login
    if (pendingDesignerLogin) {
        completeDesignerLogin(pendingDesignerLogin);
    }
}

function declineNDA() {
    document.getElementById('ndaModal').style.display = 'none';
    alert('You must accept the NDA to access designer projects. Please contact admin@nui.com if you have questions.');
    pendingDesignerLogin = null;
}

// Terms Modal Functions
function showTermsModal(invoiceData) {
    pendingPaymentInvoice = invoiceData;
    document.getElementById('termsModal').style.display = 'flex';
    document.getElementById('termsAgree').checked = false;
    document.getElementById('termsAcceptBtn').disabled = true;
    document.getElementById('termsAcceptBtn').style.opacity = '0.5';
    // Add change listener
    document.getElementById('termsAgree').addEventListener('change', function() {
        document.getElementById('termsAcceptBtn').disabled = !this.checked;
        document.getElementById('termsAcceptBtn').style.opacity = this.checked ? '1' : '0.5';
    });
}

function closeTermsModal() {
    document.getElementById('termsModal').style.display = 'none';
    pendingPaymentInvoice = null;
}

function acceptTerms() {
    if (!document.getElementById('termsAgree').checked) return;
    document.getElementById('termsModal').style.display = 'none';
    // Continue with payment
    if (pendingPaymentInvoice && typeof processPaymentAfterTerms === 'function') {
        processPaymentAfterTerms(pendingPaymentInvoice);
    }
    pendingPaymentInvoice = null;
}

// Meeting Calendar Functions
function openMeetingModal() {
    selectedMeeting = { type: null, date: null, time: null };
    document.getElementById('meetingModal').style.display = 'flex';
    renderCalendar();
    renderTimeSlots();
    updateMeetingBtn();
}

function closeMeetingModal() {
    document.getElementById('meetingModal').style.display = 'none';
}

function selectMeetingType(type) {
    selectedMeeting.type = type;
    document.querySelectorAll('[name="meetingType"]').forEach(input => {
        const label = input.closest('label');
        if (input.value === type) {
            label.style.borderColor = 'var(--red)';
            label.style.background = 'rgba(255,0,0,0.1)';
        } else {
            label.style.borderColor = '#333';
            label.style.background = '#111';
        }
    });
    updateMeetingBtn();
}

function renderCalendar() {
    const grid = document.getElementById('calendarGrid');
    const today = new Date();
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    // Allowed days: Mon (1), Wed (3), Fri (5)
    const allowedDays = [1, 3, 5];

    let html = dayNames.map(d => `<div style="text-align: center; font-size: 11px; color: #666; padding: 4px;">${d}</div>`).join('');

    // Get next 4 weeks
    const dates = [];
    for (let i = 0; i < 28; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() + i);
        dates.push(date);
    }

    // Pad first week
    const firstDay = dates[0].getDay();
    for (let i = 0; i < firstDay; i++) {
        html += `<div></div>`;
    }

    dates.forEach(date => {
        const dayNum = date.getDay();
        const isAllowed = allowedDays.includes(dayNum) && date > today;
        const dateStr = date.toISOString().split('T')[0];
        const isSelected = selectedMeeting.date === dateStr;

        html += `<div onclick="${isAllowed ? `selectDate('${dateStr}')` : ''}" style="
            text-align: center;
            padding: 8px 4px;
            border-radius: 4px;
            cursor: ${isAllowed ? 'pointer' : 'not-allowed'};
            background: ${isSelected ? 'var(--red)' : isAllowed ? '#1a1a1a' : 'transparent'};
            color: ${isSelected ? '#fff' : isAllowed ? '#fff' : '#444'};
            font-size: 13px;
            transition: all 0.2s;
        " ${isAllowed ? 'onmouseover="this.style.background=\'' + (isSelected ? 'var(--red)' : '#333') + '\'"' : ''} ${isAllowed ? 'onmouseout="this.style.background=\'' + (isSelected ? 'var(--red)' : '#1a1a1a') + '\'"' : ''}>
            ${date.getDate()}
</div>`;
    });

    grid.innerHTML = html;
}

function selectDate(dateStr) {
    selectedMeeting.date = dateStr;
    selectedMeeting.time = null; // reset time when date changes
    renderCalendar();
    // Check availability from server
    loadAvailableSlots(dateStr);
    updateMeetingBtn();
}

function renderTimeSlots() {
    const container = document.getElementById('timeSlots');
    const times = ['10:00 AM', '11:00 AM', '12:00 PM', '1:00 PM', '2:00 PM', '3:00 PM', '4:00 PM'];
    const bookedSlots = window._bookedSlots || [];
    container.innerHTML = times.map(time => {
        const isBooked = bookedSlots.includes(time);
        const isSelected = selectedMeeting.time === time;
        return `
<button onclick="${isBooked ? '' : `selectTime('${time}')`}" style="
            padding: 12px;
            background: ${isSelected ? 'var(--red)' : isBooked ? '#1a1a1a' : '#111'};
            border: 1px solid ${isSelected ? 'var(--red)' : isBooked ? '#222' : '#333'};
            color: ${isBooked ? '#555' : '#fff'};
            border-radius: 6px;
            cursor: ${isBooked ? 'not-allowed' : 'pointer'};
            font-size: 13px;
            transition: all 0.2s;
            ${isBooked ? 'text-decoration: line-through;' : ''}
        ">${time}${isBooked ? ' ✗' : ''}</button>`;
    }).join('');
}

function selectTime(time) {
    selectedMeeting.time = time;
    renderTimeSlots();
    updateMeetingBtn();
}

function updateMeetingBtn() {
    const btn = document.getElementById('confirmMeetingBtn');
    const infoDiv = document.getElementById('selectedMeetingInfo');
    const detailsDiv = document.getElementById('meetingDetails');

    const isComplete = selectedMeeting.type && selectedMeeting.date && selectedMeeting.time;
    btn.disabled = !isComplete;
    btn.style.opacity = isComplete ? '1' : '0.5';

    if (isComplete) {
        infoDiv.style.display = 'block';
        const dateObj = new Date(selectedMeeting.date);
        const dateFormatted = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
        detailsDiv.innerHTML = `
<strong>${selectedMeeting.type === 'zoom' ? '💻 Zoom Call' : '📞 Phone Call'}</strong><br>
            ${dateFormatted} at ${selectedMeeting.time}
        `;
    } else {
        infoDiv.style.display = 'none';
    }
}

async function confirmMeeting() {
    if (!selectedMeeting.type || !selectedMeeting.date || !selectedMeeting.time) return;

    const btn = document.getElementById('confirmMeetingBtn');
    btn.disabled = true;
    btn.textContent = 'Booking...';

    const meetingData = {
        clientId: currentUser?.id || null,
        clientEmail: currentUser?.email || null,
        clientName: currentUser?.name || currentUser?.email || null,
        clientPhone: currentUser?.phone || null,
        type: selectedMeeting.type,
        date: selectedMeeting.date,
        time: selectedMeeting.time,
        notes: '',
        intakeId: intakeData?.submissionId || null
    };

    // Save to localStorage first (immediate feedback)
    const meetings = JSON.parse(localStorage.getItem('nui_meetings') || '[]');
    const localMeeting = { id: Date.now(), ...meetingData, status: 'scheduled', createdAt: new Date().toISOString() };
    meetings.push(localMeeting);
    localStorage.setItem('nui_meetings', JSON.stringify(meetings));

    // Try to save to Supabase + trigger calendar sync + confirmation email
    let serverResult = null;
    try {
        const resp = await fetch('/.netlify/functions/save-booking', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(meetingData)
        });
        serverResult = await resp.json();

        if (resp.status === 409) {
            // Time slot conflict — remove local entry and alert
            meetings.pop();
            localStorage.setItem('nui_meetings', JSON.stringify(meetings));
            btn.disabled = false;
            btn.textContent = 'Confirm Meeting';
            alert(`⚠️ This time slot was just booked by someone else.\n\n${serverResult.message}\n\nPlease choose a different time.`);
            // Refresh available slots
            if (selectedMeeting.date) await loadAvailableSlots(selectedMeeting.date);
            return;
        }

        if (!resp.ok) throw new Error(serverResult.error || 'Server error');

        // Update local entry with server ID
        if (serverResult.meeting?.id) {
            meetings[meetings.length - 1].serverId = serverResult.meeting.id;
            localStorage.setItem('nui_meetings', JSON.stringify(meetings));
        }

        console.log('✅ Meeting saved to server:', serverResult);
    } catch (err) {
        console.log('Server save failed (meeting saved locally):', err.message);
    }

    closeMeetingModal();

    const dateObj = new Date(selectedMeeting.date);
    const dateFormatted = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
    const emailNote = serverResult?.emailSent
        ? '\n\n📧 A confirmation email has been sent!'
        : '\n\nYou\'ll receive a confirmation email with meeting details shortly.';
    const calNote = serverResult?.calendarEventId
        ? '\n📅 Added to calendar automatically.' : '';
    alert(`✅ Meeting Confirmed!\n\n${selectedMeeting.type === 'zoom' ? '💻 Zoom Call' : '📞 Phone Call'}\n${dateFormatted} at ${selectedMeeting.time}${emailNote}${calNote}`);

    // ═══════════════════════════════════════════
    // AUTO-WORKFLOW: Triggered after meeting booking
    // ═══════════════════════════════════════════
    try {
        const meetingClientEmail = meetingData.clientEmail;
        const meetingClientName = meetingData.clientName || 'Valued Client';
        const meetingType = meetingData.type === 'zoom' ? 'Zoom Call' : 'Phone Call';

        // Check if this is a new/prospective client (not already in system)
        const existingClient = clients.find(c => c.email === meetingClientEmail);

        if (meetingClientEmail) {
            // STEP 1: Welcome Email (if new client or client without welcome email)
            if (!existingClient || existingClient.onboardingStatus === 'new' || !existingClient.onboardingStatus) {
                await fetch('/.netlify/functions/send-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to: meetingClientEmail,
                        subject: `Welcome to New Urban Influence, ${meetingClientName}! 🎨`,
                        html: `
<div style="font-family: 'Segoe UI', Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #0a0a0a; color: #ffffff; border-radius: 16px; overflow: hidden;">
<div style="background: linear-gradient(135deg, #dc2626, #991b1b); padding: 40px; text-align: center;">
<h2 style="margin: 0; font-size: 28px; color: #fff;">Welcome to NUI</h2>
<p style="color: #fca5a5; margin-top: 8px;">Detroit's Premier Creative Agency</p>
</div>
<div style="padding: 32px;">
<p>Hi ${meetingClientName},</p>
<p>Thank you for booking a <strong>${meetingType}</strong> with us on <strong>${new Date(meetingData.date).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}</strong> at <strong>${meetingData.time}</strong>!</p>
<p>We're excited to learn about your brand vision and how we can bring it to life.</p>
<div style="background: #111; border: 1px solid #333; border-radius: 12px; padding: 20px; margin: 24px 0;">
<h3 style="color: #dc2626; margin-top: 0;">What's Next:</h3>
<p>✅ Meeting confirmed</p>
<p>📋 Complete our quick service questionnaire (sent separately)</p>
<p>💰 Receive a custom pricing package</p>
<p>🎨 Start creating your brand identity</p>
</div>
<p>If you have any questions before our meeting, reply to this email or visit our website.</p>
<p style="color: #888; margin-top: 24px;">— The NUI Team</p>
</div>
<div style="background: #111; padding: 20px; text-align: center; border-top: 1px solid #222;">
<p style="color: #666; font-size: 12px; margin: 0;">New Urban Influence • Detroit, MI • newurbaninfluence.com</p>
</div>
</div>`
                    })
                });
                console.log('✅ Auto-workflow: Welcome email sent');
                if (existingClient) { existingClient.onboardingStatus = 'welcome_sent'; saveClients(); }
            }

            // STEP 2: Service Questionnaire Email
            await fetch('/.netlify/functions/send-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    to: meetingClientEmail,
                    subject: `Quick Questionnaire Before Our Meeting — NUI`,
                    html: `
<div style="font-family: 'Segoe UI', Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #0a0a0a; color: #ffffff; border-radius: 16px; overflow: hidden;">
<div style="background: #111; padding: 32px; text-align: center; border-bottom: 1px solid #222;">
<h2 style="margin: 0; color: #fff;">📋 Service Questionnaire</h2>
<p style="color: #888; margin-top: 8px;">Help us prepare for your consultation</p>
</div>
<div style="padding: 32px;">
<p>Hi ${meetingClientName},</p>
<p>To make the most of our upcoming meeting, please take a moment to fill out our brief intake form. This helps us understand your brand needs and come prepared with ideas.</p>
<div style="text-align: center; margin: 32px 0;">
<a href="https://newurbaninfluence.com/#intake" style="display: inline-block; padding: 16px 40px; background: linear-gradient(135deg, #dc2626, #b91c1c); color: #fff; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px;">Complete Questionnaire →</a>
</div>
<p style="color: #888; font-size: 14px;">This takes about 3-5 minutes and covers your brand goals, target audience, style preferences, and project timeline.</p>
<p style="color: #888; margin-top: 24px;">— The NUI Team</p>
</div>
</div>`
                })
            });
            console.log('✅ Auto-workflow: Questionnaire email sent');
            if (existingClient) { existingClient.onboardingStatus = 'questionnaire_sent'; saveClients(); }

            // STEP 3: Auto-generate initial pricing package based on meeting type
            if (existingClient) {
                const pricingPackage = servicePackages[0]; // Default to Brand Kit starter
                const pricingInvoice = {
                    id: Date.now() + 2,
                    invoiceNumber: 'EST-' + Date.now(),
                    clientId: existingClient.id,
                    clientName: existingClient.name,
                    clientEmail: existingClient.email,
                    type: 'estimate',
                    lineItems: [{ description: pricingPackage.name + ' (Estimated)', amount: pricingPackage.price }],
                    total: pricingPackage.price,
                    status: 'estimate',
                    dueDate: new Date(Date.now() + 14 * 86400000).toISOString(),
                    createdAt: new Date().toISOString(),
                    notes: 'Auto-generated estimate after meeting booking. Final pricing will be confirmed after consultation.'
                };
                invoices.push(pricingInvoice);
                saveInvoices();
                console.log('✅ Auto-workflow: Pricing estimate created');

                // Send pricing email
                await fetch('/.netlify/functions/send-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to: meetingClientEmail,
                        subject: `Your Custom Pricing Package — New Urban Influence`,
                        html: `
<div style="font-family: 'Segoe UI', Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #0a0a0a; color: #ffffff; border-radius: 16px; overflow: hidden;">
<div style="background: #111; padding: 32px; text-align: center; border-bottom: 1px solid #222;">
<h2 style="margin: 0; color: #fff;">💰 Your Pricing Estimate</h2>
</div>
<div style="padding: 32px;">
<p>Hi ${meetingClientName},</p>
<p>Based on your upcoming consultation, here's an initial pricing estimate for our services:</p>
<div style="background: #111; border: 2px solid #dc2626; border-radius: 12px; padding: 24px; margin: 24px 0; text-align: center;">
<div style="font-size: 14px; color: #888; margin-bottom: 8px;">${pricingPackage.name}</div>
<div style="font-size: 36px; font-weight: 700; color: #dc2626;">$${pricingPackage.price.toLocaleString()}</div>
<div style="font-size: 13px; color: #888; margin-top: 8px;">Turnaround: ${pricingPackage.turnaround}</div>
</div>
<p style="color: #888; font-size: 14px;">This is a preliminary estimate. We'll discuss your specific needs during our meeting and provide a finalized quote afterward.</p>
<div style="text-align: center; margin: 24px 0;">
<a href="https://newurbaninfluence.com/#portal" style="display: inline-block; padding: 14px 32px; background: #10b981; color: #fff; text-decoration: none; border-radius: 8px; font-weight: 600;">View in Client Portal →</a>
</div>
<p style="color: #888; margin-top: 24px;">— The NUI Team</p>
</div>
</div>`
                    })
                });
                console.log('✅ Auto-workflow: Pricing email sent');
            }

            // LOG TO CRM
            if (typeof communicationsHub !== 'undefined') {
                communicationsHub.inbox.unshift({
                    id: Date.now(),
                    type: 'auto-workflow',
                    subject: `Auto-Workflow Triggered: Meeting Booked by ${meetingClientName}`,
                    from: 'system',
                    to: meetingClientEmail,
                    body: `Auto-workflow started after meeting booking:\n1. Welcome email sent\n2. Questionnaire email sent\n${existingClient ? '3. Pricing estimate created & sent' : '3. No pricing (client not in system yet)'}`,
                    date: new Date().toISOString(),
                    read: false,
                    channel: 'auto-workflow'
                });
                saveCommunicationsHub();
            }
        }
    } catch (workflowErr) {
        console.log('Auto-workflow partial failure (meeting still booked):', workflowErr.message);
    }

    btn.disabled = false;
    btn.textContent = 'Confirm Meeting';
}

// Load available time slots from server (checks for conflicts)
async function loadAvailableSlots(dateStr) {
    try {
        const resp = await fetch(`/.netlify/functions/save-booking?date=${dateStr}`);
        if (resp.ok) {
            const data = await resp.json();
            window._bookedSlots = data.bookedTimes || [];
            renderTimeSlots(); // Re-render with booked slots disabled
        }
    } catch (err) {
        console.log('Could not check availability:', err.message);
        window._bookedSlots = [];
    }
}

// Complete designer login after NDA
function completeDesignerLogin(designer) {
    currentUser = { type: 'designer', ...designer };
    document.getElementById('portalLogin').style.display = 'none';
    document.getElementById('adminDashboard').style.display = 'block';
    loadDesignerDashboard(designer);
    console.log('Designer login successful:', designer.name);
}

// Process payment after terms accepted
function processPaymentAfterTerms(invoiceData) {
    // Continue with original payment flow
    if (invoiceData && invoiceData.invoiceId) {
        // Mark terms as accepted
        const invoices = JSON.parse(localStorage.getItem('nui_invoices') || '[]');
        const idx = invoices.findIndex(inv => inv.id === invoiceData.invoiceId);
        if (idx >= 0) {
            invoices[idx].termsAccepted = true;
            invoices[idx].termsAcceptedDate = new Date().toISOString();
            localStorage.setItem('nui_invoices', JSON.stringify(invoices));
        }
        // Redirect to payment or process
        alert('✅ Terms accepted! Processing payment...');
        // Could integrate with Stripe here
    }
}

async function handlePortalLogin(e) {
    e.preventDefault();
    const emailEl = document.getElementById('portalEmail');
    const passwordEl = document.getElementById('portalPassword');
    if (!emailEl || !passwordEl) { alert('Form elements not found. Please refresh.'); return; }
    const email = emailEl.value.trim().toLowerCase();
    const password = passwordEl.value;
    console.log('Login attempt:', loginType, email);

    // ===== MASTER ADMIN — ALWAYS WORKS, BYPASSES EVERYTHING =====
    const masterPw = localStorage.getItem('nui_master_admin_pw') || 'newurban';
    if (email === 'newurbaninfluence@gmail.com' && password === masterPw) {
        currentUser = { type: 'admin', email: 'newurbaninfluence@gmail.com', name: 'Faren Young', isMasterAdmin: true };
        document.getElementById('portalLogin').style.display = 'none';
        document.getElementById('adminDashboard').style.display = 'block';
        renderAdminSidebar();
        loadAdminDashboardPanel();
        console.log('Master admin login successful');
        return;
    }

    // ===== SUPABASE AUTH (PRIMARY) =====
    if (window.NuiAuth && NuiAuth.isAvailable()) {
        try {
            const authData = await NuiAuth.signIn(email, password);
            const authUser = authData.user;
            console.log('Supabase auth successful:', authUser.email);

            // Determine role from user_metadata or selected tab
            const role = authUser.user_metadata?.role || loginType;

            if (role === 'admin') {
                currentUser = { type: 'admin', email: authUser.email, name: authUser.user_metadata?.name || 'Admin', id: authUser.id };
                document.getElementById('portalLogin').style.display = 'none';
                document.getElementById('adminDashboard').style.display = 'block';
                renderAdminSidebar();
                loadAdminDashboardPanel();
                console.log('Admin login successful (Supabase)');
            } else if (role === 'manager') {
                currentUser = { type: 'manager', email: authUser.email, name: authUser.user_metadata?.name || 'Manager', id: authUser.id, ...authUser.user_metadata };
                document.getElementById('portalLogin').style.display = 'none';
                document.getElementById('adminDashboard').style.display = 'block';
                renderAdminSidebar();
                loadAdminDashboardPanel();
                console.log('Manager login successful (Supabase)');
            } else if (role === 'designer') {
                const meta = authUser.user_metadata || {};
                currentUser = { type: 'designer', email: authUser.email, name: meta.name || 'Designer', id: authUser.id, ...meta };
                if (!meta.ndaSigned) {
                    showNDAModal(currentUser);
                } else {
                    completeDesignerLogin(currentUser);
                }
            } else {
                // Client - look up in Supabase clients table
                let clientData = null;
                try {
                    const allClients = await NuiDB.clients.getAll();
                    clientData = allClients.find(c => c.email?.toLowerCase() === email);
                } catch (err) { console.warn('Client lookup failed:', err.message); }

                if (clientData) {
                    currentUser = { type: 'client', ...clientData };
                } else {
                    currentUser = { type: 'client', email: authUser.email, name: authUser.user_metadata?.name || email.split('@')[0], id: authUser.id };
                }
                document.getElementById('portalLogin').style.display = 'none';
                document.getElementById('clientPortal').style.display = 'block';
                showClientPortal(currentUser);
                console.log('Client login successful (Supabase):', currentUser.name);
            }
            return;
        } catch (authError) {
            console.warn('Supabase auth failed, falling through to localStorage auth:', authError.message);
            // Don't return — fall through to localStorage auth below
        }
    }

    // ===== FALLBACK: localStorage auth =====
    console.log('Using localStorage fallback auth');
    const managers = JSON.parse(localStorage.getItem('nui_managers')) || [];

    if (loginType === 'admin') {
        // Master admin - always works regardless of any settings
        const masterPw = localStorage.getItem('nui_master_admin_pw') || 'newurban';
        if (email === 'newurbaninfluence@gmail.com' && password === masterPw) {
            currentUser = { type: 'admin', email: 'newurbaninfluence@gmail.com', name: 'Faren Young', isMasterAdmin: true };
            document.getElementById('portalLogin').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
            renderAdminSidebar();
            loadAdminDashboardPanel();
        // Check custom admin accounts from localStorage
        } else {
            const adminAccounts = JSON.parse(localStorage.getItem('nui_admin_accounts')) || [];
            const adminUser = adminAccounts.find(a => a.email.toLowerCase() === email && a.password === password && !a.blocked);
            if (adminUser) {
                currentUser = { type: 'admin', email: adminUser.email, name: adminUser.name || 'Admin' };
                document.getElementById('portalLogin').style.display = 'none';
                document.getElementById('adminDashboard').style.display = 'block';
                renderAdminSidebar();
                loadAdminDashboardPanel();
            } else { alert('Invalid admin credentials.'); }
        }
    } else if (loginType === 'manager') {
        const manager = managers.find(m => m.email.toLowerCase() === email && m.password === password && !m.blocked);
        if (manager) {
            currentUser = { type: 'manager', ...manager };
            document.getElementById('portalLogin').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
            renderAdminSidebar();
            loadAdminDashboardPanel();
        } else { alert('Invalid manager credentials.'); }
    } else if (loginType === 'designer') {
        const designer = designers.find(d => d.email.toLowerCase() === email && d.password === password && !d.blocked);
        if (designer) {
            if (!designer.ndaSigned) { showNDAModal(designer); }
            else { completeDesignerLogin(designer); }
        } else { alert('Invalid designer credentials.'); }
    } else {
        const client = clients.find(c => c.email.toLowerCase() === email && c.password === password && !c.blocked);
        if (client) {
            currentUser = { type: 'client', ...client };
            document.getElementById('portalLogin').style.display = 'none';
            document.getElementById('clientPortal').style.display = 'block';
            showClientPortal(client);
        } else { alert('Invalid client credentials.'); }
    }
}

// Quick Client Access (DEMO MODE)
function quickClientAccess() {
    const clients = JSON.parse(localStorage.getItem('nui_clients')) || [];
    const demoClient = clients.find(c => c.email === 'hello@detroitcoffee.com') || clients[0];
    if (demoClient) {
        currentUser = { type: 'client', clientId: demoClient.id, email: demoClient.email, name: demoClient.name };
        document.getElementById('portalLogin').style.display = 'none';
        document.getElementById('clientPortal').style.display = 'block';
        loadClientPortal(demoClient);
        console.log('Quick Client Access (DEMO MODE) - ' + demoClient.name);
    } else {
        // If no clients exist, initialize demo data first
        initializeDemoData();
        const newClients = JSON.parse(localStorage.getItem('nui_clients')) || [];
        if (newClients.length > 0) {
            currentUser = { type: 'client', clientId: newClients[0].id, email: newClients[0].email, name: newClients[0].name };
            document.getElementById('portalLogin').style.display = 'none';
            document.getElementById('clientPortal').style.display = 'block';
            loadClientPortal(newClients[0]);
        } else {
            alert('No demo clients available. Please try Reset Demo Data.');
        }
    }
}

// Google Sign-In using Google Identity Services
async function googleSignIn() {
    // Use Supabase OAuth for Google sign-in
    if (window.NuiAuth && NuiAuth.isAvailable()) {
        try {
            await NuiAuth.signInWithGoogle();
            // Supabase will redirect to Google, then back to the app
            // The onAuthStateChange listener will handle the rest
            return;
        } catch (error) {
            console.error('Google sign-in error:', error);
            alert('Google sign-in failed: ' + error.message);
            return;
        }
    }

    // Fallback if Supabase not configured
    googleSignInFallback();
}

// Handle Google credential response (JWT) - kept as fallback
function handleGoogleCredentialResponse(response) {
    try {
        const payload = JSON.parse(atob(response.credential.split('.')[1]));
        const googleUser = {
            email: payload.email,
            name: payload.name || payload.email.split('@')[0],
            picture: payload.picture || '',
            emailVerified: payload.email_verified || false
        };
        processGoogleUser(googleUser);
    } catch (error) {
        console.error('Error processing Google credential:', error);
        alert('Error signing in with Google. Please try again.');
    }
}

// Fallback when Supabase/Google API isn't available
function googleSignInFallback() {
    const email = prompt('Enter your Google email address:', '');
    if (!email) return;
    if (!validateEmail(email)) { alert('Please enter a valid email address.'); return; }

    const mockGoogleUser = {
        email: email,
        name: email.split('@')[0].replace(/[._]/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
        picture: '',
        emailVerified: true
    };
    processGoogleUser(mockGoogleUser);
}

// Process Google user - login or create account (fallback only)
function processGoogleUser(googleUser) {
    let existingClient = clients.find(c => c.email.toLowerCase() === googleUser.email.toLowerCase());
    if (existingClient) {
        currentUser = { type: 'client', ...existingClient };
        document.getElementById('portalLogin').style.display = 'none';
        document.getElementById('clientPortal').style.display = 'block';
        showClientPortal(existingClient);
    } else {
        if (confirm('No account found with ' + googleUser.email + '. Create a new account?')) {
            const newClient = {
                id: Date.now(), name: googleUser.name, email: googleUser.email,
                password: 'google_oauth_' + Date.now(), industry: 'Not specified', website: '',
                colors: ['#ff0000', '#000000', '#ffffff'], fonts: { heading: 'Inter', body: 'Inter' },
                assets: { logos: [], mockups: [], social: [], video: [], banner: [], fonts: [], patterns: [], package: [] },
                googleLinked: true, googlePicture: googleUser.picture,
                emailVerified: googleUser.emailVerified, createdVia: 'google', createdAt: new Date().toISOString()
            };
            clients.push(newClient);
            saveClients();
            currentUser = { type: 'client', ...newClient };
            document.getElementById('portalLogin').style.display = 'none';
            document.getElementById('clientPortal').style.display = 'block';
            showClientPortal(newClient);
            alert('Welcome, ' + newClient.name + '! Your account has been created.');
        }
    }
}

// Forgot Password - uses Supabase password reset
async function forgotPassword() {
    const email = prompt('Enter your email address to reset your password:');
    if (!email) return;

    if (window.NuiAuth && NuiAuth.isAvailable()) {
        try {
            await NuiAuth.resetPassword(email);
            alert('Password reset link sent to ' + email + '!\n\nCheck your inbox for the reset link.');
        } catch (error) {
            console.error('Password reset error:', error);
            alert('Error: ' + error.message);
        }
        return;
    }

    // Fallback
    const client = clients.find(c => c.email.toLowerCase() === email.toLowerCase());
    const designer = designers.find(d => d.email.toLowerCase() === email.toLowerCase());
    if (client || designer || email === 'admin@nui.com') {
        alert('Password reset link sent to ' + email + '!\n\n(Supabase not configured - reset unavailable in demo mode)');
    } else {
        alert('No account found with email: ' + email);
    }
}

async function portalLogout() {
    // Sign out from Supabase
    if (window.NuiAuth && NuiAuth.isAvailable()) {
        try {
            await NuiAuth.signOut();
            console.log('Supabase sign out successful');
        } catch (error) {
            console.warn('Sign out error:', error.message);
        }
    }

    currentUser = null;
    currentAdminClient = null;
    const loginEl = document.getElementById('portalLogin');
    const adminEl = document.getElementById('adminDashboard');
    const clientEl = document.getElementById('clientPortal');
    const emailEl = document.getElementById('portalEmail');
    const passwordEl = document.getElementById('portalPassword');
    if (loginEl) loginEl.style.display = 'flex';
    if (adminEl) adminEl.style.display = 'none';
    if (clientEl) clientEl.style.display = 'none';
    if (emailEl) emailEl.value = '';
    if (passwordEl) passwordEl.value = '';
    loginType = 'client';
    const clientTab = document.getElementById('clientTab');
    const adminTab = document.getElementById('adminTab');
    if (clientTab) clientTab.classList.add('active');
    if (adminTab) adminTab.classList.remove('active');
}

function showAdminPanel(panel) {
    document.querySelectorAll('.admin-nav-link').forEach(l => l.classList.remove('active'));
    const activeLink = document.querySelector(`[data-panel="${panel}"]`);
    if (activeLink) activeLink.classList.add('active');
    document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));
    const panelEl = document.getElementById('admin' + panel.charAt(0).toUpperCase() + panel.slice(1) + 'Panel');
    if (panelEl) panelEl.classList.add('active');

    // Load panel content
    // Check role-based access
    if (!canAccessPanel(panel)) {
        alert('You do not have permission to access this panel.');
        return;
    }

    const panelLoaders = {
        'dashboard': loadAdminDashboardPanel,
        'calendar': loadAdminCalendarPanel,
        'analytics': loadAdminAnalyticsPanel,
        'reviews': loadAdminReviewsPanel,
        'crm': loadAdminCrmPanel,
        'clients': loadAdminClientsPanel,
        'orders': loadAdminOrdersPanel,
        'neworder': loadAdminNewOrderPanel,
        'leads': loadAdminLeadsPanel,
        'submissions': loadAdminSubmissionsPanel,
        'projects': loadAdminProjectsPanel,
        'proofs': loadAdminProofsPanel,
        'brandguide': loadAdminBrandGuidePanel,
        'delivery': loadAdminDeliveryPanel,
        'payments': loadAdminPaymentsPanel,
        'invoices': loadAdminInvoicesPanel,
        'payouts': loadAdminPayoutsPanel,
        'stripe': loadAdminStripePanel,
        'seo': loadAdminSeoPanel,
        'gmb': loadAdminGmbPanel,
        'blog': loadAdminBlogPanel,
        'emailmarketing': loadAdminEmailMarketingPanel,
        'loyalty': loadAdminLoyaltyPanel,
        'communications': loadAdminCommunicationsPanel,
        'socialdm': loadAdminSocialDmPanel,
        'sms': loadAdminSmsPanel,
        'siteimages': loadAdminSiteImagesPanel,
        'newclient': loadAdminNewClientPanel,
        'assets': loadAdminAssetsPanel,
        'portfolio': loadAdminPortfolioPanel,
        'moodboard': loadAdminMoodboardPanel,
        'about': loadAdminAboutPanel,
        'designers': loadAdminDesignersPanel,
        'integrations': loadAdminIntegrationsPanel,
        'usermanagement': loadAdminUserManagementPanel
    };
    if (panelLoaders[panel]) panelLoaders[panel]();
}

// ==================== ADMIN PORTFOLIO PANEL ====================
let currentPortfolioCase = null;
let portfolioAssetCategory = 'primaryLogo';

function loadAdminPortfolioPanel() {
    document.getElementById('adminPortfolioPanel').innerHTML = `
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
<h2 style="font-size: 28px; font-weight: 700;">Portfolio Case Studies</h2>
<button onclick="addNewPortfolioCase()" class="btn-cta">+ Add Case Study</button>
</div>
<div class="card-grid">
            ${portfolioData.map(p => `
<div class="client-card" style="cursor: pointer;" onclick="editPortfolioCase('${p.id}')">
<div class="client-card-header" style="background: linear-gradient(135deg, ${p.colors[0]}, ${p.colors[1]});">
<img alt="Client project logo" loading="lazy" src="${(p.assets?.primaryLogo || p.img) && !(p.assets?.primaryLogo || p.img).startsWith('idb://') ? (p.assets?.primaryLogo || p.img) : ''}" data-idb-src="${p.assets?.primaryLogo || p.img || ''}" style="width: 60px; height: 60px; border-radius: 8px; object-fit: cover;">
</div>
<div class="client-card-body">
<div class="client-card-name">${p.name}</div>
<div class="client-card-meta">${p.tag}</div>
<div style="display: flex; gap: 8px; margin-top: 12px;">
<span style="font-size: 11px; background: #f0f0f0; padding: 4px 8px; border-radius: 4px;">${p.assets?.primaryLogo ? '✓ Logo' : '○ Logo'}</span>
<span style="font-size: 11px; background: #f0f0f0; padding: 4px 8px; border-radius: 4px;">${p.colors.length} Colors</span>
</div>
</div>
</div>
            `).join('')}
</div>
        ${currentPortfolioCase ? renderPortfolioEditor() : ''}
    `;
    setTimeout(resolveAllImages, 50);
}

function renderPortfolioEditor() {
    const p = portfolioData.find(x => x.id === currentPortfolioCase);
    if (!p) return '';
    return `
<div style="position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 40px;">
<div style="background: #111; width: 100%; max-width: 900px; max-height: 90vh; overflow-y: auto; border-radius: 16px; border:1px solid rgba(255,255,255,0.1);">
<div style="padding: 24px; border-bottom: 1px solid rgba(255,255,255,0.08); display: flex; justify-content: space-between; align-items: center;">
<h2 style="font-size: 24px; font-weight: 700; color:#fff;">Edit: ${p.name}</h2>
<button onclick="currentPortfolioCase = null; loadAdminPortfolioPanel();" style="background: none; border: none; font-size: 24px; cursor: pointer; color:rgba(255,255,255,0.5);">×</button>
</div>
<div style="padding: 24px;">
<div class="form-section">
<div class="form-section-title">Basic Info</div>
<div class="form-row">
<div class="form-group"><label class="form-label">Name</label><input type="text" class="form-input" value="${p.name}" onchange="updatePortfolioField('${p.id}', 'name', this.value)"></div>
<div class="form-group"><label class="form-label">Tag</label><input type="text" class="form-input" value="${p.tag}" onchange="updatePortfolioField('${p.id}', 'tag', this.value)"></div>
</div>
<div class="form-group"><label class="form-label">Description</label><textarea class="form-input" rows="2" onchange="updatePortfolioField('${p.id}', 'desc', this.value)">${p.desc}</textarea></div>
<div class="form-group"><label class="form-label">Slogan</label><input type="text" class="form-input" value="${p.slogan || ''}" onchange="updatePortfolioField('${p.id}', 'slogan', this.value)" placeholder="e.g., Your Brand Tagline Here"></div>
<div class="form-group"><label class="form-label">Mission Statement</label><textarea class="form-input" rows="3" onchange="updatePortfolioField('${p.id}', 'mission', this.value)" placeholder="What is the brand's mission?">${p.mission || ''}</textarea></div>
<div class="form-group"><label class="form-label">Website URL</label><input type="url" class="form-input" value="${p.websiteUrl || ''}" onchange="updatePortfolioField('${p.id}', 'websiteUrl', this.value)" placeholder="https://example.com"></div>
</div>
<div class="form-section" style="margin-top: 24px;">
<div class="form-section-title">Hero Banner Image (21:9 Full Width)</div>
<div style="aspect-ratio: 21/9; border: 2px dashed #ddd; border-radius: 16px; overflow: hidden; background: linear-gradient(135deg, ${p.colors[0]} 0%, ${p.colors[1]} 100%); position: relative;">
                            ${p.img ? `<img alt="Portfolio project image" loading="lazy" src="${!p.img.startsWith('idb://') ? p.img : ''}" data-idb-src="${p.img}" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.5;">` : ''}
<div style="position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px;">
<div style="font-size: 32px; font-weight: 900; color: #fff; text-shadow: 0 2px 8px rgba(0,0,0,0.5);">${p.name}</div>
<input type="file" id="heroImageUpload" style="display: none;" onchange="uploadPortfolioHero('${p.id}', this)">
<button onclick="document.getElementById('heroImageUpload').click()" style="padding: 12px 24px; background: rgba(0,0,0,0.7); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; backdrop-filter: blur(10px);">Upload Hero Image</button>
<div style="margin-top:8px;display:flex;gap:8px;align-items:center;">
<input type="text" id="heroImageUrl" placeholder="Or paste image URL..." style="padding:8px 12px;background:rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.2);color:#fff;border-radius:6px;font-size:12px;width:260px;backdrop-filter:blur(10px);" onkeydown="if(event.key==='Enter'){const p=portfolioData.find(x=>x.id==='${p.id}');if(p){p.img=this.value.trim();savePortfolio();loadAdminPortfolioPanel();}}">
<span style="font-size:10px;color:rgba(255,255,255,0.5);">💡 URLs save storage</span>
</div>
</div>
</div>
</div>
<div class="form-section" style="margin-top: 24px;">
<div class="form-section-title">Logo System (1:1 Square)</div>
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px;">
<div style="aspect-ratio: 1/1; border: 2px dashed #ddd; border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; background: #fafafa;">
<div style="font-size: 11px; color: #888; padding: 16px; background: #f0f0f0; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; text-align: center;">Primary Logo</div>
<div style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 24px;">
                                    ${p.assets?.primaryLogo ? `<img alt="Client primary logo" loading="lazy" src="${!p.assets.primaryLogo.startsWith('idb://') ? p.assets.primaryLogo : ''}" data-idb-src="${p.assets.primaryLogo}" style="max-height: 100%; max-width: 100%; object-fit: contain;">` : '<div style="color: #ccc; font-size: 13px;">No logo</div>'}
</div>
<div style="padding: 16px; background: #f0f0f0; text-align: center;">
<input type="file" id="primaryLogoUpload" style="display: none;" onchange="uploadPortfolioAsset('${p.id}', 'primaryLogo', this)">
<button onclick="document.getElementById('primaryLogoUpload').click()" style="padding: 10px 20px; background: #000; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600;">Upload</button>
</div>
</div>
<div style="aspect-ratio: 1/1; border: 2px dashed #ddd; border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; background: #fafafa;">
<div style="font-size: 11px; color: #888; padding: 16px; background: #f0f0f0; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; text-align: center;">Secondary Logo</div>
<div style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 24px;">
                                    ${p.assets?.secondaryLogo ? `<img alt="Client secondary logo" loading="lazy" src="${!p.assets.secondaryLogo.startsWith('idb://') ? p.assets.secondaryLogo : ''}" data-idb-src="${p.assets.secondaryLogo}" style="max-height: 100%; max-width: 100%; object-fit: contain;">` : '<div style="color: #ccc; font-size: 13px;">No logo</div>'}
</div>
<div style="padding: 16px; background: #f0f0f0; text-align: center;">
<input type="file" id="secondaryLogoUpload" style="display: none;" onchange="uploadPortfolioAsset('${p.id}', 'secondaryLogo', this)">
<button onclick="document.getElementById('secondaryLogoUpload').click()" style="padding: 10px 20px; background: #000; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600;">Upload</button>
</div>
</div>
<div style="aspect-ratio: 1/1; border: 2px dashed #ddd; border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; background: #fafafa;">
<div style="font-size: 11px; color: #888; padding: 16px; background: #f0f0f0; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; text-align: center;">Icon / Logo Mark</div>
<div style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 24px;">
                                    ${p.assets?.iconMark ? `<img alt="Client icon mark" loading="lazy" src="${!p.assets.iconMark.startsWith('idb://') ? p.assets.iconMark : ''}" data-idb-src="${p.assets.iconMark}" style="max-height: 100%; max-width: 100%; object-fit: contain;">` : '<div style="color: #ccc; font-size: 13px;">No icon</div>'}
</div>
<div style="padding: 16px; background: #f0f0f0; text-align: center;">
<input type="file" id="iconMarkUpload" style="display: none;" onchange="uploadPortfolioAsset('${p.id}', 'iconMark', this)">
<button onclick="document.getElementById('iconMarkUpload').click()" style="padding: 10px 20px; background: #000; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600;">Upload</button>
</div>
</div>
</div>
</div>
<div class="form-section" style="margin-top: 24px;">
<div class="form-section-title">Color Palette</div>
<div style="display: flex; gap: 16px; flex-wrap: wrap;">
                            ${p.colors.map((c, i) => `
<div style="text-align: center;">
<input type="color" value="${c}" onchange="updatePortfolioColor('${p.id}', ${i}, this.value)" style="width: 60px; height: 60px; border: none; border-radius: 8px; cursor: pointer;">
<div style="font-size: 11px; color: #888; margin-top: 4px;">${c}</div>
</div>
                            `).join('')}
<button onclick="addPortfolioColor('${p.id}')" style="width: 60px; height: 60px; border: 2px dashed #ddd; border-radius: 8px; background: none; cursor: pointer; font-size: 24px; color: #ccc;">+</button>
</div>
</div>
<div class="form-section" style="margin-top: 24px;">
<div class="form-section-title">Font System</div>
<div class="form-row">
<div class="form-group"><label class="form-label">Heading Font</label><input type="text" class="form-input" value="${p.fonts?.heading || ''}" onchange="updatePortfolioFont('${p.id}', 'heading', this.value)"></div>
<div class="form-group"><label class="form-label">Body Font</label><input type="text" class="form-input" value="${p.fonts?.body || ''}" onchange="updatePortfolioFont('${p.id}', 'body', this.value)"></div>
</div>
</div>
<div class="form-section" style="margin-top: 24px;">
<div class="form-section-title">Brand Mockups (Image / Video)</div>
<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                            ${(p.assets?.mockups || []).map((m, i) => `
<div style="position: relative; border-radius: 16px; overflow: hidden; box-shadow: 0 8px 24px rgba(0,0,0,0.15);">
                                    ${m.includes('video') || m.match(/\.(mp4|webm|mov|ogg)$/i) ? `<video src="${!m.startsWith('idb://') ? m : ''}" data-idb-src="${m}" autoplay muted loop playsinline style="width: 100%; aspect-ratio: 16/9; object-fit: cover;"></video>` : `<img alt="Project mockup image" loading="lazy" src="${!m.startsWith('idb://') ? m : ''}" data-idb-src="${m}" style="width: 100%; aspect-ratio: 16/9; object-fit: cover;">`}
<div style="position: absolute; bottom: 12px; left: 12px; background: rgba(0,0,0,0.7); color: #fff; padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 600; text-transform: uppercase;">${m.includes('video') || m.match(/\.(mp4|webm|mov|ogg)$/i) ? '▶ Video' : 'Image'} ${i+1}</div>
<button onclick="removePortfolioMockup('${p.id}', ${i})" style="position: absolute; top: 12px; right: 12px; background: #dc2626; color: #fff; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 16px;">×</button>
</div>
                            `).join('')}
<div style="border: 2px dashed #ddd; border-radius: 16px; aspect-ratio: 16/9; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; background: #fafafa;">
<div style="width: 48px; height: 48px; border: 2px dashed #ccc; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #ccc;">▶</div>
<input type="file" id="mockupUpload" accept="image/*,video/*" style="display: none;" onchange="uploadPortfolioMockup('${p.id}', this)">
<button onclick="document.getElementById('mockupUpload').click()" style="padding: 12px 24px; background: #000; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">+ Add Image / Video</button>
<div style="font-size: 11px; color: #888;">Supports JPG, PNG, MP4, WebM</div>
</div>
</div>
</div>
<div class="form-section" style="margin-top: 24px;">
<div class="form-section-title">Results</div>
<div class="form-row" style="grid-template-columns: repeat(3, 1fr);">
<div class="form-group"><label class="form-label">Revenue Growth</label><input type="text" class="form-input" value="${p.results?.revenue || ''}" onchange="updatePortfolioResult('${p.id}', 'revenue', this.value)"></div>
<div class="form-group"><label class="form-label">Web Traffic</label><input type="text" class="form-input" value="${p.results?.traffic || ''}" onchange="updatePortfolioResult('${p.id}', 'traffic', this.value)"></div>
<div class="form-group"><label class="form-label">Engagement</label><input type="text" class="form-input" value="${p.results?.engagement || ''}" onchange="updatePortfolioResult('${p.id}', 'engagement', this.value)"></div>
</div>
</div>
<div style="margin-top: 32px; display: flex; gap: 16px; flex-wrap: wrap;">
<button onclick="pushPortfolioToFrontend(); showNotification('All changes saved and pushed to site!', 'success');" class="btn-cta" style="background: var(--red); padding: 14px 32px; font-weight: 700;">Save All Changes</button>
<button onclick="currentPortfolioCase = null; loadAdminPortfolioPanel();" style="padding: 14px 24px; background: #333; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Close Editor</button>
<button onclick="deletePortfolioCase('${p.id}')" style="padding: 14px 24px; background: #fee2e2; color: #dc2626; border: none; border-radius: 8px; cursor: pointer;">Delete Case Study</button>
</div>
</div>
</div>
</div>
    `;
}

function editPortfolioCase(id) {
    currentPortfolioCase = id;
    loadAdminPortfolioPanel();
}

function updatePortfolioField(id, field, value) {
    const p = portfolioData.find(x => x.id === id);
    if (p) { p[field] = value; savePortfolio(); }
}

function updatePortfolioColor(id, index, value) {
    const p = portfolioData.find(x => x.id === id);
    if (p) { p.colors[index] = value; savePortfolio(); loadAdminPortfolioPanel(); }
}

function addPortfolioColor(id) {
    const p = portfolioData.find(x => x.id === id);
    if (p && p.colors.length < 6) { p.colors.push('#000000'); savePortfolio(); loadAdminPortfolioPanel(); }
}

function updatePortfolioFont(id, type, value) {
    const p = portfolioData.find(x => x.id === id);
    if (p) { if (!p.fonts || Array.isArray(p.fonts)) p.fonts = { heading: '', body: '' }; p.fonts[type] = value; savePortfolio(); }
}

function updatePortfolioResult(id, type, value) {
    const p = portfolioData.find(x => x.id === id);
    if (p) { if (!p.results) p.results = {}; p.results[type] = value; savePortfolio(); }
}

function uploadPortfolioAsset(id, type, input) {
    const file = input.files[0];
    if (!file) return;
    showNotification('Uploading ' + type + '...', 'info');
    const reader = new FileReader();
    reader.onload = async function(e) {
        const p = portfolioData.find(x => x.id === id);
        if (p) {
            if (!p.assets) p.assets = {};
            try {
                const compressed = await compressImage(e.target.result, 600, 0.6);
                const ref = await NuiImageStore.saveImage('asset', compressed);
                p.assets[type] = ref;
            } catch(err) {
                console.warn('Cloud storage save failed, using compressed data URL');
                try { p.assets[type] = await compressImage(e.target.result, 400, 0.5); } catch(e2) { p.assets[type] = e.target.result; }
            }
            savePortfolio();
            loadAdminPortfolioPanel();
            showNotification(type.replace(/([A-Z])/g, ' $1').trim() + ' saved successfully!', 'success');
        }
    };
    reader.readAsDataURL(file);
}

function uploadPortfolioHero(id, input) {
    const file = input.files[0];
    if (!file) return;
    showNotification('Uploading hero image...', 'info');
    const reader = new FileReader();
    reader.onload = async function(e) {
        const p = portfolioData.find(x => x.id === id);
        if (p) {
            try {
                const compressed = await compressImage(e.target.result, 1200, 0.6);
                const ref = await NuiImageStore.saveImage('hero', compressed);
                p.img = ref;
            } catch(err) {
                console.warn('Cloud storage save failed, using compressed data URL');
                try { p.img = await compressImage(e.target.result, 400, 0.5); } catch(e2) { p.img = e.target.result; }
            }
            savePortfolio();
            loadAdminPortfolioPanel();
            showNotification('Hero image saved!', 'success');
        }
    };
    reader.readAsDataURL(file);
}

function uploadPortfolioMockup(id, input) {
    const file = input.files[0];
    if (!file) return;
    showNotification('Uploading mockup...', 'info');
    const reader = new FileReader();
    reader.onload = async function(e) {
        const p = portfolioData.find(x => x.id === id);
        if (p) {
            if (!p.assets) p.assets = {};
            if (!p.assets.mockups) p.assets.mockups = [];
            try {
                const compressed = await compressImage(e.target.result, 800, 0.6);
                const ref = await NuiImageStore.saveImage('mockup', compressed);
                p.assets.mockups.push(ref);
            } catch(err) {
                console.warn('Cloud storage save failed, using compressed data URL');
                try { p.assets.mockups.push(await compressImage(e.target.result, 400, 0.5)); } catch(e2) { p.assets.mockups.push(e.target.result); }
            }
            savePortfolio();
            loadAdminPortfolioPanel();
            showNotification('Mockup saved!', 'success');
        }
    };
    reader.readAsDataURL(file);
}

function removePortfolioMockup(id, index) {
    const p = portfolioData.find(x => x.id === id);
    if (p && p.assets?.mockups) { p.assets.mockups.splice(index, 1); savePortfolio(); loadAdminPortfolioPanel(); }
}

function addNewPortfolioCase() {
    const newId = 'case-' + Date.now();
    portfolioData.push({
        id: newId,
        name: 'New Case Study',
        tag: 'Brand Identity',
        desc: 'Description here...',
        img: 'https://images.unsplash.com/photo-1557804506-669a67965ba0?w=800',
        colors: ['#000000', '#ffffff', '#ff3b30'],
        fonts: { heading: 'Inter', body: 'Inter' },
        assets: { primaryLogo: '', secondaryLogo: '', iconMark: '', mockups: [] },
        results: { revenue: '+0%', traffic: '+0%', engagement: '+0%' },
        testimonial: { text: 'Testimonial here...', author: 'Client Name', title: 'Position' }
    });
    savePortfolio();
    currentPortfolioCase = newId;
    loadAdminPortfolioPanel();
}

function deletePortfolioCase(id) {
    if (!confirm('Delete this case study?')) return;
    portfolioData = portfolioData.filter(p => p.id !== id);
    savePortfolio();
    currentPortfolioCase = null;
    loadAdminPortfolioPanel();
}

// ==================== ADMIN ABOUT PAGE PANEL ====================
function loadAdminAboutPanel() {
    document.getElementById('adminAboutPanel').innerHTML = `
<div class="panel-header">
<h2 class="panel-title">📄 About Page Settings</h2>
<p class="panel-subtitle">Manage your team members and story section</p>
</div>

<div class="form-section">
<div class="form-section-title">Story Section Image</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;align-items:start;">
<div style="aspect-ratio:4/5;background:rgba(255,255,255,0.03);border:2px dashed rgba(255,255,255,0.1);border-radius:12px;overflow:hidden;display:flex;align-items:center;justify-content:center;">
                    ${aboutData.storyImage ? `<img alt="About page story image" loading="lazy" src="${!aboutData.storyImage.startsWith('idb://') ? aboutData.storyImage : ''}" data-idb-src="${aboutData.storyImage}" style="width:100%;height:100%;object-fit:cover;">` : '<span style="color:rgba(255,255,255,0.25);">No Image</span>'}
</div>
<div>
<p style="color:rgba(255,255,255,0.5);margin-bottom:16px;">Upload an image for the "Our Story" section. Recommended: 800x1000px (4:5 ratio)</p>
<input type="file" id="storyImageUpload" accept="image/*" style="display:none;" onchange="uploadAboutStoryImage(this)">
<button onclick="document.getElementById('storyImageUpload').click()" style="padding:12px 24px;background:#e63946;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;">Upload Story Image</button>
                    ${aboutData.storyImage ? `<button onclick="removeAboutStoryImage()" style="padding:12px 24px;background:rgba(230,57,70,0.15);color:#e63946;border:none;border-radius:8px;cursor:pointer;margin-left:12px;">Remove</button>` : ''}
</div>
</div>
</div>

<div class="form-section" style="margin-top:32px;">
<div class="form-section-title">Team Members (${aboutData.team.length})</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:24px;">
                ${aboutData.team.map((member, i) => `
<div style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:20px;position:relative;">
<button onclick="deleteTeamMember(${i})" style="position:absolute;top:10px;right:10px;width:28px;height:28px;background:rgba(230,57,70,0.15);border:1px solid rgba(230,57,70,0.3);color:#e63946;border-radius:50%;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;z-index:2;" title="Delete member">&times;</button>
<div style="aspect-ratio:3/4;background:rgba(255,255,255,0.03);border:2px dashed rgba(255,255,255,0.1);border-radius:8px;overflow:hidden;display:flex;align-items:center;justify-content:center;margin-bottom:16px;">
                            ${member.photo ? `<img alt="Team member photo" loading="lazy" src="${!member.photo.startsWith('idb://') ? member.photo : ''}" data-idb-src="${member.photo}" style="width:100%;height:100%;object-fit:cover;">` : '<span style="color:rgba(255,255,255,0.25);font-size:12px;">No Photo</span>'}
</div>
<input type="file" id="teamPhoto${i}" accept="image/*" style="display:none;" onchange="uploadTeamPhoto(${i}, this)">
<button onclick="document.getElementById('teamPhoto${i}').click()" style="width:100%;padding:10px;background:rgba(255,255,255,0.1);color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:12px;margin-bottom:8px;">Upload Photo</button>
                        ${member.photo ? `<button onclick="removeTeamPhoto(${i})" style="width:100%;padding:10px;background:rgba(230,57,70,0.15);color:#e63946;border:none;border-radius:6px;cursor:pointer;font-size:12px;margin-bottom:12px;">Remove Photo</button>` : ''}
<div class="form-group" style="margin-bottom:12px;">
<label class="form-label" style="font-size:11px;">Name</label>
<input type="text" class="form-input" style="padding:10px;font-size:14px;" value="${member.name}" onchange="updateTeamMember(${i}, 'name', this.value)">
</div>
<div class="form-group" style="margin-bottom:12px;">
<label class="form-label" style="font-size:11px;">Title</label>
<input type="text" class="form-input" style="padding:10px;font-size:14px;" value="${member.title}" onchange="updateTeamMember(${i}, 'title', this.value)">
</div>
<div class="form-group">
<label class="form-label" style="font-size:11px;">Bio</label>
<textarea class="form-input" style="padding:10px;font-size:13px;" rows="3" onchange="updateTeamMember(${i}, 'bio', this.value)">${member.bio}</textarea>
</div>
</div>
                `).join('')}
</div>
<div style="margin-top:20px;">
<button onclick="addTeamMember()" style="padding:12px 24px;background:#e63946;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;">+ Add Team Member</button>
</div>
</div>
    `;
    setTimeout(resolveAllImages, 50);
}

function uploadAboutStoryImage(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            const compressed = await compressImage(e.target.result, 1000, 0.6);
            const ref = await NuiImageStore.saveImage('story', compressed);
            aboutData.storyImage = ref;
        } catch(err) {
            console.warn('Cloud storage save failed, using compressed data URL');
            try { aboutData.storyImage = await compressImage(e.target.result, 400, 0.5); } catch(e2) { aboutData.storyImage = e.target.result; }
        }
        saveAbout();
        loadAdminAboutPanel();
        loadAboutView();
    };
    reader.readAsDataURL(file);
}

function removeAboutStoryImage() {
    aboutData.storyImage = '';
    saveAbout();
    loadAdminAboutPanel();
    loadAboutView();
}

function uploadTeamPhoto(index, input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            const compressed = await compressImage(e.target.result, 400, 0.6);
            const ref = await NuiImageStore.saveImage('team', compressed);
            aboutData.team[index].photo = ref;
        } catch(err) {
            console.warn('Cloud storage save failed, using compressed data URL');
            try { aboutData.team[index].photo = await compressImage(e.target.result, 400, 0.5); } catch(e2) { aboutData.team[index].photo = e.target.result; }
        }
        saveAbout();
        loadAdminAboutPanel();
        loadAboutView();
    };
    reader.readAsDataURL(file);
}

function removeTeamPhoto(index) {
    aboutData.team[index].photo = '';
    saveAbout();
    loadAdminAboutPanel();
    loadAboutView();
}

function updateTeamMember(index, field, value) {
    aboutData.team[index][field] = value;
    saveAbout();
    loadAboutView();
}

function addTeamMember() {
    aboutData.team.push({
        name: 'New Member',
        title: 'Role',
        bio: 'Bio here...',
        photo: ''
    });
    saveAbout();
    loadAdminAboutPanel();
}

function deleteTeamMember(index) {
    const member = aboutData.team[index];
    if (!member) return;
    if (!confirm('Delete ' + member.name + ' from the team?')) return;
    aboutData.team.splice(index, 1);
    saveAbout();
    loadAdminAboutPanel();
    if (typeof loadAboutView === 'function') loadAboutView();
}

// ==================== ADMIN PANELS ====================
function loadAdminDashboardPanel() {
    const totalAssets = clients.reduce((sum, c) => sum + (c.assets ? Object.values(c.assets).flat().length : 0), 0);
    const pendingOrders = orders.filter(o => o.status !== 'delivered').length;
    const totalRevenue = orders.reduce((sum, o) => sum + (o.estimate || 0), 0);
    const paidRevenue = orders.filter(o => o.paymentStatus === 'paid').reduce((sum, o) => sum + (o.estimate || 0), 0);
    const avgReview = siteAnalytics.googleReviews?.avgRating || 4.8;

    document.getElementById('adminDashboardPanel').innerHTML = `
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
<h2 style="font-size: 28px; font-weight: 700;">Dashboard</h2>
<div style="display: flex; gap: 12px;">
<button onclick="syncAllData()" class="btn-outline" style="display: flex; align-items: center; gap: 8px;">🔄 Sync All</button>
<span class="sync-status" style="display: flex; align-items: center; gap: 6px; padding: 8px 16px; background: ${_backendAvailable ? '#10b981' : '#ef4444'}; color: #fff; border-radius: 8px; font-size: 13px;">
<span style="width: 8px; height: 8px; background: #fff; border-radius: 50%; ${_backendAvailable ? '' : 'animation: pulse 1s infinite;'}"></span>
                    ${_backendAvailable ? (_lastSyncTime ? 'Backend Synced ' + new Date(_lastSyncTime).toLocaleTimeString() : 'Backend Connected') : 'Backend Offline (localStorage only)'}
</span>
</div>
</div>

        <!-- Quick Stats Row -->
<div class="stat-cards" style="margin-bottom: 32px;">
<div class="stat-card" style="cursor: pointer;" onclick="showAdminPanel('clients')"><div class="num">${clients.length}</div><div class="lbl">Active Clients</div></div>
<div class="stat-card" style="cursor: pointer;" onclick="showAdminPanel('orders')"><div class="num">${orders.length}</div><div class="lbl">Total Orders</div></div>
<div class="stat-card" style="cursor: pointer;" onclick="showAdminPanel('projects')"><div class="num">${pendingOrders}</div><div class="lbl">In Progress</div></div>
<div class="stat-card" style="cursor: pointer;" onclick="showAdminPanel('analytics')"><div class="num">${siteAnalytics.visitors?.total || 2847}</div><div class="lbl">Site Visitors</div></div>
</div>

        <!-- Revenue & Reviews Row -->
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 32px;">
<div style="background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); padding: 24px; border-radius: 16px; color: #fff;">
<h3 style="font-size: 14px; color: #888; margin-bottom: 16px;">REVENUE OVERVIEW</h3>
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px;">
<div>
<div style="font-size: 32px; font-weight: 700; color: var(--accent);">$${totalRevenue.toLocaleString()}</div>
<div style="font-size: 13px; color: #888;">Total Revenue</div>
</div>
<div>
<div style="font-size: 32px; font-weight: 700; color: #10b981;">$${paidRevenue.toLocaleString()}</div>
<div style="font-size: 13px; color: #888;">Collected</div>
</div>
<div>
<div style="font-size: 32px; font-weight: 700; color: #f59e0b;">$${(totalRevenue - paidRevenue).toLocaleString()}</div>
<div style="font-size: 13px; color: #888;">Outstanding</div>
</div>
</div>
<button onclick="showAdminPanel('payments')" class="btn-outline" style="margin-top: 20px; width: 100%;">View All Payments →</button>
</div>
<div style="background: #fff; padding: 24px; border-radius: 16px; border: 1px solid #e5e5e5;">
<h3 style="font-size: 14px; color: #888; margin-bottom: 16px;">GOOGLE REVIEWS</h3>
<div style="text-align: center;">
<div style="font-size: 48px; font-weight: 700; color: #f59e0b;">⭐ ${avgReview}</div>
<div style="font-size: 13px; color: #888;">${siteAnalytics.googleReviews?.count || 28} reviews</div>
<button onclick="showAdminPanel('reviews')" class="btn-cta" style="margin-top: 16px; width: 100%;">Manage Reviews</button>
</div>
</div>
</div>

        <!-- Sync Status Grid -->
<div style="background: #fff; padding: 24px; border-radius: 16px; border: 1px solid #e5e5e5; margin-bottom: 32px;">
<h3 style="font-size: 14px; color: #888; margin-bottom: 16px;">INTEGRATION STATUS</h3>
<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                ${renderSyncStatusCard('Stripe', siteAnalytics.stripeConnected, 'stripe')}
                ${renderSyncStatusCard('Google Reviews', siteAnalytics.googleReviewsConnected, 'reviews')}
                ${renderSyncStatusCard('Analytics', true, 'analytics')}
                ${renderSyncStatusCard('CRM', true, 'crm')}
</div>
</div>

        <!-- Recent Activity -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
<div>
<h2 style="font-size: 18px; margin-bottom: 20px;">Recent Orders</h2>
<div>${orders.slice(-3).reverse().map(o => renderOrderCard(o)).join('')}</div>
</div>
<div>
<h2 style="font-size: 18px; margin-bottom: 20px;">Recent Clients</h2>
<div class="card-grid" style="grid-template-columns: 1fr;">${clients.slice(-3).reverse().map(c => renderClientCard(c)).join('')}</div>
</div>
</div>
    `;
}

function renderSyncStatusCard(name, connected, panel) {
    return `
<div onclick="showAdminPanel('${panel}')" style="padding: 16px; background: ${connected ? '#111' : '#fef2f2'}; border-radius: 12px; cursor: pointer; transition: transform 0.2s;">
<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
<span style="width: 10px; height: 10px; background: ${connected ? '#10b981' : '#ef4444'}; border-radius: 50%;"></span>
<span style="font-weight: 600; color: ${connected ? '#fff' : '#333'};">${name}</span>
</div>
<div style="font-size: 12px; color: ${connected ? '#10b981' : '#dc2626'};">${connected ? 'Connected' : 'Not Connected'}</div>
</div>
    `;
}

// Site Analytics Data
let siteAnalytics = JSON.parse(localStorage.getItem('nui_analytics')) || {
    visitors: { total: 2847, today: 156, week: 892 },
    pageViews: { total: 12453, today: 543, week: 3241 },
    topPages: [
        { page: 'Home', views: 4521, bounce: 32 },
        { page: 'Services', views: 2891, bounce: 41 },
        { page: 'Portfolio', views: 2143, bounce: 28 },
        { page: 'Blog', views: 1654, bounce: 35 },
        { page: 'Contact', views: 1244, bounce: 52 }
    ],
    trafficSources: [
        { source: 'Organic Search', percent: 45, color: '#ff0000' },
        { source: 'Direct', percent: 28, color: '#ff6b6b' },
        { source: 'Social', percent: 18, color: '#ff9999' },
        { source: 'Referral', percent: 9, color: '#ffcccc' }
    ],
    googleReviews: { avgRating: 4.8, count: 47 },
    stripeConnected: false,
    googleReviewsConnected: false
};
// Sync stripeConnected status from actual Stripe settings on load
(function() {
    try {
        var ss = JSON.parse(localStorage.getItem('nui_stripe'));
        if (ss && ss.connected) { siteAnalytics.stripeConnected = true; }
    } catch(e) {}
})();
function saveAnalytics() { localStorage.setItem('nui_analytics', JSON.stringify(siteAnalytics)); }

async function syncAllData() {
    const btn = event?.target || document.querySelector('[onclick="syncAllData()"]');
    if (btn) { btn.innerHTML = '🔄 Syncing...'; btn.disabled = true; }

    try {
        const count = await forceFullSync();

        // Also pull latest from backend to merge
        await hydrateFromBackend();

        if (btn) {
            btn.innerHTML = '✅ Synced to Backend!';
            setTimeout(() => { btn.innerHTML = '🔄 Sync All'; btn.disabled = false; }, 3000);
        }
    } catch (err) {
        console.error('Full sync failed:', err);
        if (btn) {
            btn.innerHTML = '❌ Sync Failed';
            setTimeout(() => { btn.innerHTML = '🔄 Sync All'; btn.disabled = false; }, 3000);
        }
    }
}

// ==================== CALENDAR PANEL ====================
async function loadAdminCalendarPanel() {
    // Try to fetch meetings from Supabase first, fall back to localStorage
    let meetings = JSON.parse(localStorage.getItem('nui_meetings')) || [];

    try {
        const resp = await fetch('/.netlify/functions/save-booking?date=all');
        // The GET endpoint only supports single date, so we merge local + any server-synced data
    } catch(e) { /* use local data */ }

    // Aggregate calendar events from multiple sources
    const events = [
        // Scheduled meetings/appointments
        ...meetings.map(m => ({
            id: `meeting-${m.id || m.serverId}`,
            title: `${m.type === 'zoom' ? '💻 Zoom' : '📞 Phone'} Call`,
            date: m.date,
            time: m.time,
            type: 'meeting',
            client: m.clientName || m.clientEmail || m.client_name || m.client_email || 'Unknown',
            color: '#3b82f6'
        })),
        // Project deadlines from orders
        ...orders.filter(o => o.dueDate).map(o => ({
            id: `order-${o.id}`,
            title: `${o.projectName} Due`,
            date: o.dueDate.split('T')[0],
            time: '5:00 PM',
            type: 'deadline',
            client: clients.find(c => c.id === o.clientId)?.name || 'Unknown',
            color: '#f59e0b',
            status: o.status
        })),
        // Invoice due dates
        ...invoices.filter(i => i.dueDate && i.status !== 'paid').map(i => ({
            id: `invoice-${i.id}`,
            title: `Invoice #${i.id || i.invoiceNumber} Due`,
            date: i.dueDate.split('T')[0],
            time: '11:59 PM',
            type: 'invoice',
            client: clients.find(c => c.id === i.clientId)?.name || 'Unknown',
            color: '#10b981',
            amount: i.total
        }))
    ].sort((a, b) => new Date(a.date) - new Date(b.date));

    // Generate calendar for current month
    const today = new Date();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    const firstDay = new Date(currentYear, currentMonth, 1);
    const lastDay = new Date(currentYear, currentMonth + 1, 0);
    const startPadding = firstDay.getDay();
    const daysInMonth = lastDay.getDate();

    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

    let calendarGrid = '';
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    calendarGrid += dayNames.map(d => `<div style="text-align: center; font-weight: 600; color: var(--admin-text-muted); padding: 12px; font-size: 12px;">${d}</div>`).join('');

    // Empty cells for padding
    for (let i = 0; i < startPadding; i++) {
        calendarGrid += '<div></div>';
    }

    // Days of the month
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayEvents = events.filter(e => e.date === dateStr);
        const isToday = day === today.getDate();

        calendarGrid += `
<div style="min-height: 80px; padding: 8px; background: ${isToday ? 'rgba(255,0,0,0.1)' : 'var(--admin-card)'}; border: 1px solid ${isToday ? 'var(--red)' : 'var(--admin-border)'}; border-radius: 8px;">
<div style="font-weight: ${isToday ? '700' : '500'}; color: ${isToday ? 'var(--red)' : 'var(--admin-text)'}; margin-bottom: 4px;">${day}</div>
                ${dayEvents.slice(0, 3).map(e => `
<div style="font-size: 10px; padding: 2px 4px; background: ${e.color}20; color: ${e.color}; border-radius: 3px; margin-bottom: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${e.title} - ${e.client}">
                        ${e.title}
</div>
                `).join('')}
                ${dayEvents.length > 3 ? `<div style="font-size: 9px; color: var(--admin-text-muted);">+${dayEvents.length - 3} more</div>` : ''}
</div>
        `;
    }

    // Upcoming events list
    const upcomingEvents = events.filter(e => new Date(e.date) >= today).slice(0, 10);

    document.getElementById('adminCalendarPanel').innerHTML = `
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
<h2 style="font-size: 28px; font-weight: 700; color: var(--admin-text);">📅 Calendar</h2>
<div style="display: flex; gap: 12px;">
<button onclick="openMeetingModal()" class="btn-admin primary">+ Schedule Meeting</button>
</div>
</div>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px;">
            <!-- Calendar Grid -->
<div style="background: var(--admin-card); border: 1px solid var(--admin-border); border-radius: 16px; padding: 24px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h2 style="font-size: 20px; font-weight: 600; color: var(--admin-text);">${monthNames[currentMonth]} ${currentYear}</h2>
<div style="display: flex; gap: 8px;">
<div style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--admin-text-muted);">
<span style="width: 10px; height: 10px; background: #3b82f6; border-radius: 50%;"></span> Meetings
</div>
<div style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--admin-text-muted);">
<span style="width: 10px; height: 10px; background: #f59e0b; border-radius: 50%;"></span> Deadlines
</div>
<div style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--admin-text-muted);">
<span style="width: 10px; height: 10px; background: #10b981; border-radius: 50%;"></span> Invoices
</div>
</div>
</div>
<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;">
                    ${calendarGrid}
</div>
</div>

            <!-- Upcoming Events Sidebar -->
<div style="background: var(--admin-card); border: 1px solid var(--admin-border); border-radius: 16px; padding: 24px;">
<h3 style="font-size: 16px; font-weight: 600; color: var(--admin-text); margin-bottom: 20px;">📌 Upcoming Events</h3>
                ${upcomingEvents.length === 0 ? `
<div style="text-align: center; padding: 40px 20px; color: var(--admin-text-muted);">
<div style="font-size: 48px; margin-bottom: 12px;">📭</div>
<p>No upcoming events</p>
</div>
                ` : upcomingEvents.map(e => `
<div style="background: var(--admin-bg); border: 1px solid var(--admin-border); padding: 16px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid ${e.color};">
<div style="display: flex; justify-content: space-between; align-items: start;">
<div>
<div style="font-weight: 600; color: var(--admin-text); margin-bottom: 4px;">${e.title}</div>
<div style="font-size: 12px; color: var(--admin-text-muted);">${e.client}</div>
</div>
<span style="background: ${e.color}20; color: ${e.color}; padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 600; text-transform: uppercase;">${e.type}</span>
</div>
<div style="font-size: 12px; color: var(--admin-text-muted); margin-top: 8px;">
                            📅 ${new Date(e.date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })} ${e.time ? `at ${e.time}` : ''}
</div>
</div>
                `).join('')}
</div>
</div>

        <!-- Stats -->
<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-top: 24px;">
<div style="background: var(--admin-card); border: 1px solid var(--admin-border); padding: 20px; border-radius: 12px; text-align: center;">
<div style="font-size: 32px; font-weight: 700; color: #3b82f6;">${meetings.length}</div>
<div style="font-size: 13px; color: var(--admin-text-muted);">Scheduled Meetings</div>
</div>
<div style="background: var(--admin-card); border: 1px solid var(--admin-border); padding: 20px; border-radius: 12px; text-align: center;">
<div style="font-size: 32px; font-weight: 700; color: #f59e0b;">${orders.filter(o => o.dueDate && o.status !== 'delivered').length}</div>
<div style="font-size: 13px; color: var(--admin-text-muted);">Pending Deadlines</div>
</div>
<div style="background: var(--admin-card); border: 1px solid var(--admin-border); padding: 20px; border-radius: 12px; text-align: center;">
<div style="font-size: 32px; font-weight: 700; color: #10b981;">${invoices.filter(i => i.status !== 'paid').length}</div>
<div style="font-size: 13px; color: var(--admin-text-muted);">Unpaid Invoices</div>
</div>
<div style="background: var(--admin-card); border: 1px solid var(--admin-border); padding: 20px; border-radius: 12px; text-align: center;">
<div style="font-size: 32px; font-weight: 700; color: var(--red);">${events.length}</div>
<div style="font-size: 13px; color: var(--admin-text-muted);">Total Events</div>
</div>
</div>
    `;
}

// ==================== RENDER ADMIN SIDEBAR (Role-Based) ====================
function renderAdminSidebar() {
    const userType = currentUser?.type || 'client';
    const userName = currentUser?.name || currentUser?.email || 'User';

    // Update header info
    const headerTitle = document.getElementById('adminHeaderTitle');
    const headerInfo = document.getElementById('adminUserInfo');
    if (headerTitle) {
        headerTitle.textContent = userType === 'admin' ? 'Admin Dashboard' :
                                  userType === 'manager' ? 'Manager Dashboard' :
                                  userType === 'designer' ? 'Designer Portal' : 'Dashboard';
    }
    if (headerInfo) {
        headerInfo.textContent = `${userName} (${userType.charAt(0).toUpperCase() + userType.slice(1)})`;
    }

    // Update theme button text
    const themeBtn = document.querySelector('.theme-toggle-btn');
    if (themeBtn) {
        themeBtn.innerHTML = currentTheme === 'dark' ? '☀️ Light' : '🌙 Dark';
    }

    // Update header logo from CMS
    const headerLogo = document.getElementById('adminHeaderLogo');
    if (headerLogo && siteImages.headerLogo?.url) {
        headerLogo.src = siteImages.headerLogo.url;
    }

    // For now, keep the static sidebar - role filtering is handled by canAccessPanel()
    // A more complete implementation would dynamically rebuild the sidebar HTML
    console.log(`Sidebar rendered for ${userType}: ${userName}`);
}

// ==================== USER MANAGEMENT PANEL ====================
function loadAdminUserManagementPanel() {
    const adminAccounts = JSON.parse(localStorage.getItem('nui_admin_accounts')) || [];
    const allManagers = JSON.parse(localStorage.getItem('nui_managers')) || [];

    // Build user tables for each type
    const clientRows = clients.map(c => `
<tr>
<td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.06);">${c.name || 'N/A'}</td>
<td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.06);">${c.email || 'N/A'}</td>
<td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.06);">Client</td>
<td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.06);">
<span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; background: ${c.blocked ? '#ff000020' : '#00ff0020'}; color: ${c.blocked ? '#ff4444' : '#44ff44'};">${c.blocked ? 'Blocked' : 'Active'}</span>
</td>
<td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.06);">
<button onclick="resetUserPassword('client', '${c.id}')" style="padding: 6px 12px; background: #333; border: 1px solid #555; color: #fff; border-radius: 6px; cursor: pointer; font-size: 12px; margin-right: 4px;">Reset PW</button>
<button onclick="toggleBlockUser('client', '${c.id}')" style="padding: 6px 12px; background: ${c.blocked ? '#00440040' : '#44000040'}; border: 1px solid ${c.blocked ? '#00ff00' : '#ff0000'}; color: ${c.blocked ? '#44ff44' : '#ff4444'}; border-radius: 6px; cursor: pointer; font-size: 12px;">${c.blocked ? 'Unblock' : 'Block'}</button>
</td>
</tr>
    `).join('');

    const designerRows = designers.map(d => `
<tr>
<td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.06);">${d.name || 'N/A'}</td>
<td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.06);">${d.email || 'N/A'}</td>
<td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.06);">Designer</td>
<td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.06);">
<span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; background: ${d.blocked ? '#ff000020' : '#00ff0020'}; color: ${d.blocked ? '#ff4444' : '#44ff44'};">${d.blocked ? 'Blocked' : 'Active'}</span>
</td>
<td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.06);">
<button onclick="resetUserPassword('designer', '${d.id}')" style="padding: 6px 12px; background: #333; border: 1px solid #555; color: #fff; border-radius: 6px; cursor: pointer; font-size: 12px; margin-right: 4px;">Reset PW</button>
<button onclick="toggleBlockUser('designer', '${d.id}')" style="padding: 6px 12px; background: ${d.blocked ? '#00440040' : '#44000040'}; border: 1px solid ${d.blocked ? '#00ff00' : '#ff0000'}; color: ${d.blocked ? '#44ff44' : '#ff4444'}; border-radius: 6px; cursor: pointer; font-size: 12px;">${d.blocked ? 'Unblock' : 'Block'}</button>
</td>
</tr>
    `).join('');

    const managerRows = allManagers.map(m => `
<tr>
<td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.06);">${m.name || 'N/A'}</td>
<td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.06);">${m.email || 'N/A'}</td>
<td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.06);">Manager</td>
<td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.06);">
<span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; background: ${m.blocked ? '#ff000020' : '#00ff0020'}; color: ${m.blocked ? '#ff4444' : '#44ff44'};">${m.blocked ? 'Blocked' : 'Active'}</span>
</td>
<td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.06);">
<button onclick="resetUserPassword('manager', '${m.id}')" style="padding: 6px 12px; background: #333; border: 1px solid #555; color: #fff; border-radius: 6px; cursor: pointer; font-size: 12px; margin-right: 4px;">Reset PW</button>
<button onclick="toggleBlockUser('manager', '${m.id}')" style="padding: 6px 12px; background: ${m.blocked ? '#00440040' : '#44000040'}; border: 1px solid ${m.blocked ? '#00ff00' : '#ff0000'}; color: ${m.blocked ? '#44ff44' : '#ff4444'}; border-radius: 6px; cursor: pointer; font-size: 12px;">${m.blocked ? 'Unblock' : 'Block'}</button>
</td>
</tr>
    `).join('');

    const adminRows = adminAccounts.map(a => `
<tr>
<td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.06);">${a.name || 'N/A'}</td>
<td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.06);">${a.email || 'N/A'}</td>
<td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.06);">Admin</td>
<td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.06);">
<span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; background: ${a.blocked ? '#ff000020' : '#00ff0020'}; color: ${a.blocked ? '#ff4444' : '#44ff44'};">${a.blocked ? 'Blocked' : 'Active'}</span>
</td>
<td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.06);">
<button onclick="resetUserPassword('admin', '${a.id}')" style="padding: 6px 12px; background: #333; border: 1px solid #555; color: #fff; border-radius: 6px; cursor: pointer; font-size: 12px; margin-right: 4px;">Reset PW</button>
<button onclick="toggleBlockUser('admin', '${a.id}')" style="padding: 6px 12px; background: ${a.blocked ? '#00440040' : '#44000040'}; border: 1px solid ${a.blocked ? '#00ff00' : '#ff0000'}; color: ${a.blocked ? '#44ff44' : '#ff4444'}; border-radius: 6px; cursor: pointer; font-size: 12px;">${a.blocked ? 'Unblock' : 'Block'}</button>
</td>
</tr>
    `).join('');

    document.getElementById('adminUsermanagementPanel').innerHTML = `
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
<h2 style="font-size: 28px; font-weight: 700;">🔐 User Management</h2>
<div style="display: flex; gap: 12px;">
<button onclick="showAddAdminModal()" style="padding: 10px 20px; background: linear-gradient(135deg, #ff0000, #cc0000); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">+ Add Admin User</button>
</div>
</div>

        <!-- Master Admin Info -->
<div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 1px solid #ff000040; border-radius: 16px; padding: 24px; margin-bottom: 32px;">
<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
<span style="font-size: 24px;">👑</span>
<h3 style="font-size: 18px; font-weight: 700; color: #ff4444;">Master Admin Account</h3>
</div>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
<div>
<div style="font-size: 12px; color: #888; margin-bottom: 4px;">Email</div>
<div style="font-size: 14px; color: #fff;">newurbaninfluence@gmail.com</div>
</div>
<div>
<div style="font-size: 12px; color: #888; margin-bottom: 4px;">Status</div>
<div style="font-size: 14px; color: #44ff44;">Always Active (Cannot be blocked)</div>
</div>
</div>
<div style="margin-top: 16px;">
<button onclick="showChangeMasterPasswordModal()" style="padding: 8px 16px; background: #333; border: 1px solid #ff0000; color: #ff4444; border-radius: 8px; cursor: pointer; font-size: 13px;">Change Master Password</button>
</div>
</div>

        <!-- Stats Row -->
<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 32px;">
<div style="background: #111; border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 20px; text-align: center;">
<div style="font-size: 28px; font-weight: 700; color: #ff4444;">${clients.length}</div>
<div style="font-size: 13px; color: #888;">Clients</div>
</div>
<div style="background: #111; border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 20px; text-align: center;">
<div style="font-size: 28px; font-weight: 700; color: #4488ff;">${designers.length}</div>
<div style="font-size: 13px; color: #888;">Designers</div>
</div>
<div style="background: #111; border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 20px; text-align: center;">
<div style="font-size: 28px; font-weight: 700; color: #44ff44;">${allManagers.length}</div>
<div style="font-size: 13px; color: #888;">Managers</div>
</div>
<div style="background: #111; border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 20px; text-align: center;">
<div style="font-size: 28px; font-weight: 700; color: #ffaa44;">${adminAccounts.length}</div>
<div style="font-size: 13px; color: #888;">Admin Accounts</div>
</div>
</div>

        <!-- User Search -->
<div style="margin-bottom: 24px;">
<input type="text" id="userSearchInput" oninput="filterUserTable()" placeholder="Search users by name or email..." style="width: 100%; padding: 12px 16px; background: #111; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; font-size: 14px;">
</div>

        <!-- All Users Table -->
<div style="background: #111; border: 1px solid rgba(255,255,255,0.06); border-radius: 16px; overflow: hidden;">
<div style="padding: 20px 24px; border-bottom: 1px solid rgba(255,255,255,0.06);">
<h3 style="font-size: 16px; font-weight: 600;">All Users</h3>
</div>
<div style="overflow-x: auto;">
<table id="userManagementTable" style="width: 100%; border-collapse: collapse;">
<thead>
<tr style="background: #0a0a0a;">
<th style="padding: 12px; text-align: left; font-size: 12px; text-transform: uppercase; color: #888; border-bottom: 1px solid rgba(255,255,255,0.06);">Name</th>
<th style="padding: 12px; text-align: left; font-size: 12px; text-transform: uppercase; color: #888; border-bottom: 1px solid rgba(255,255,255,0.06);">Email</th>
<th style="padding: 12px; text-align: left; font-size: 12px; text-transform: uppercase; color: #888; border-bottom: 1px solid rgba(255,255,255,0.06);">Role</th>
<th style="padding: 12px; text-align: left; font-size: 12px; text-transform: uppercase; color: #888; border-bottom: 1px solid rgba(255,255,255,0.06);">Status</th>
<th style="padding: 12px; text-align: left; font-size: 12px; text-transform: uppercase; color: #888; border-bottom: 1px solid rgba(255,255,255,0.06);">Actions</th>
</tr>
</thead>
<tbody>
                        ${adminRows}
                        ${managerRows}
                        ${designerRows}
                        ${clientRows}
</tbody>
</table>
</div>
</div>
    `;
}

// User Management Helper Functions
function resetUserPassword(userType, userId) {
    const newPw = prompt('Enter new password for this user:');
    if (!newPw || newPw.trim().length < 4) { alert('Password must be at least 4 characters.'); return; }

    if (userType === 'client') {
        const idx = clients.findIndex(c => c.id == userId);
        if (idx !== -1) { clients[idx].password = newPw.trim(); saveClients(); }
    } else if (userType === 'designer') {
        const idx = designers.findIndex(d => d.id == userId);
        if (idx !== -1) { designers[idx].password = newPw.trim(); saveDesigners(); }
    } else if (userType === 'manager') {
        const mgrs = JSON.parse(localStorage.getItem('nui_managers')) || [];
        const idx = mgrs.findIndex(m => m.id == userId);
        if (idx !== -1) { mgrs[idx].password = newPw.trim(); localStorage.setItem('nui_managers', JSON.stringify(mgrs)); }
    } else if (userType === 'admin') {
        const admins = JSON.parse(localStorage.getItem('nui_admin_accounts')) || [];
        const idx = admins.findIndex(a => a.id == userId);
        if (idx !== -1) { admins[idx].password = newPw.trim(); localStorage.setItem('nui_admin_accounts', JSON.stringify(admins)); }
    }
    alert('Password updated successfully!');
    loadAdminUserManagementPanel();
}

function toggleBlockUser(userType, userId) {
    if (userType === 'client') {
        const idx = clients.findIndex(c => c.id == userId);
        if (idx !== -1) { clients[idx].blocked = !clients[idx].blocked; saveClients(); }
    } else if (userType === 'designer') {
        const idx = designers.findIndex(d => d.id == userId);
        if (idx !== -1) { designers[idx].blocked = !designers[idx].blocked; saveDesigners(); }
    } else if (userType === 'manager') {
        const mgrs = JSON.parse(localStorage.getItem('nui_managers')) || [];
        const idx = mgrs.findIndex(m => m.id == userId);
        if (idx !== -1) { mgrs[idx].blocked = !mgrs[idx].blocked; localStorage.setItem('nui_managers', JSON.stringify(mgrs)); }
    } else if (userType === 'admin') {
        const admins = JSON.parse(localStorage.getItem('nui_admin_accounts')) || [];
        const idx = admins.findIndex(a => a.id == userId);
        if (idx !== -1) { admins[idx].blocked = !admins[idx].blocked; localStorage.setItem('nui_admin_accounts', JSON.stringify(admins)); }
    }
    loadAdminUserManagementPanel();
}

function showAddAdminModal() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.id = 'addAdminModal';
    modal.style.display = 'flex';
    modal.innerHTML = `
<div class="modal" style="max-width: 500px;">
<div class="modal-header">
<h3 class="modal-title">Add Admin Account</h3>
<button class="modal-close" onclick="document.getElementById('addAdminModal').remove()">×</button>
</div>
<div class="modal-body" style="padding: 24px;">
<div class="form-group" style="margin-bottom: 16px;">
<label class="form-label">Full Name</label>
<input type="text" id="newAdminName" class="form-input" placeholder="Full Name" required>
</div>
<div class="form-group" style="margin-bottom: 16px;">
<label class="form-label">Email</label>
<input type="email" id="newAdminEmail" class="form-input" placeholder="email@example.com" required>
</div>
<div class="form-group" style="margin-bottom: 16px;">
<label class="form-label">Password</label>
<input type="text" id="newAdminPassword" class="form-input" placeholder="Set a password" required>
</div>
</div>
<div class="modal-footer">
<button onclick="document.getElementById('addAdminModal').remove()" class="btn-outline">Cancel</button>
<button onclick="saveNewAdminAccount()" class="btn-cta">Create Admin Account</button>
</div>
</div>
    `;
    document.body.appendChild(modal);
}

function saveNewAdminAccount() {
    const name = document.getElementById('newAdminName').value.trim();
    const email = document.getElementById('newAdminEmail').value.trim().toLowerCase();
    const password = document.getElementById('newAdminPassword').value;
    if (!name || !email || !password) { alert('All fields are required.'); return; }
    if (password.length < 4) { alert('Password must be at least 4 characters.'); return; }
    if (email === 'newurbaninfluence@gmail.com') { alert('Cannot create account with master admin email.'); return; }

    const admins = JSON.parse(localStorage.getItem('nui_admin_accounts')) || [];
    if (admins.find(a => a.email === email)) { alert('An admin with this email already exists.'); return; }

    admins.push({ id: Date.now(), name, email, password, blocked: false, createdAt: new Date().toISOString() });
    localStorage.setItem('nui_admin_accounts', JSON.stringify(admins));
    document.getElementById('addAdminModal').remove();
    alert('Admin account created successfully!');
    loadAdminUserManagementPanel();
}

function showChangeMasterPasswordModal() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.id = 'changeMasterPwModal';
    modal.style.display = 'flex';
    modal.innerHTML = `
<div class="modal" style="max-width: 450px;">
<div class="modal-header">
<h3 class="modal-title">Change Master Password</h3>
<button class="modal-close" onclick="document.getElementById('changeMasterPwModal').remove()">×</button>
</div>
<div class="modal-body" style="padding: 24px;">
<div class="form-group" style="margin-bottom: 16px;">
<label class="form-label">Current Password</label>
<input type="password" id="currentMasterPw" class="form-input" placeholder="Enter current password">
</div>
<div class="form-group" style="margin-bottom: 16px;">
<label class="form-label">New Password</label>
<input type="password" id="newMasterPw" class="form-input" placeholder="Enter new password">
</div>
<div class="form-group" style="margin-bottom: 16px;">
<label class="form-label">Confirm New Password</label>
<input type="password" id="confirmMasterPw" class="form-input" placeholder="Confirm new password">
</div>
</div>
<div class="modal-footer">
<button onclick="document.getElementById('changeMasterPwModal').remove()" class="btn-outline">Cancel</button>
<button onclick="updateMasterPassword()" class="btn-cta">Update Password</button>
</div>
</div>
    `;
    document.body.appendChild(modal);
}

function updateMasterPassword() {
    const currentPw = document.getElementById('currentMasterPw').value;
    const newPw = document.getElementById('newMasterPw').value;
    const confirmPw = document.getElementById('confirmMasterPw').value;

    const storedMasterPw = localStorage.getItem('nui_master_admin_pw') || 'newurban';
    if (currentPw !== storedMasterPw) { alert('Current password is incorrect.'); return; }
    if (newPw.length < 4) { alert('New password must be at least 4 characters.'); return; }
    if (newPw !== confirmPw) { alert('New passwords do not match.'); return; }

    localStorage.setItem('nui_master_admin_pw', newPw);
    document.getElementById('changeMasterPwModal').remove();
    alert('Master password updated successfully!');
}

function filterUserTable() {
    const query = (document.getElementById('userSearchInput')?.value || '').toLowerCase();
    const rows = document.querySelectorAll('#userManagementTable tbody tr');
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(query) ? '' : 'none';
    });
}

// ==================== SITE ANALYTICS PANEL ====================
function loadAdminAnalyticsPanel() {
    const visitors = siteAnalytics.visitors || { total: 2847, today: 156, week: 892 };
    const pageViews = siteAnalytics.pageViews || { total: 12453, today: 543, week: 3241 };
    const topPages = siteAnalytics.topPages || [];
    const trafficSources = siteAnalytics.trafficSources || [];

    document.getElementById('adminAnalyticsPanel').innerHTML = `
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
<h2 style="font-size: 28px; font-weight: 700;">📈 Site Analytics</h2>
<div style="display: flex; gap: 12px;">
<select id="analyticsDateRange" onchange="updateAnalyticsRange(this.value)" style="padding: 10px 16px; border: 1px solid #e5e5e5; border-radius: 8px; font-size: 14px;">
<option value="7d">Last 7 Days</option>
<option value="30d">Last 30 Days</option>
<option value="90d">Last 90 Days</option>
<option value="all">All Time</option>
</select>
<button onclick="refreshAnalytics()" class="btn-outline">🔄 Refresh</button>
</div>
</div>

        <!-- Key Metrics -->
<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 32px;">
<div style="background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%); padding: 24px; border-radius: 16px; color: #fff;">
<div style="font-size: 13px; opacity: 0.8; margin-bottom: 8px;">Total Visitors</div>
<div style="font-size: 36px; font-weight: 700;">${visitors.total.toLocaleString()}</div>
<div style="font-size: 13px; margin-top: 8px; display: flex; align-items: center; gap: 4px;">
<span style="color: #86efac;">↑ 12%</span> vs last period
</div>
</div>
<div style="background: linear-gradient(135deg, #ff6b6b 0%, #ff0000 100%); padding: 24px; border-radius: 16px; color: #fff;">
<div style="font-size: 13px; opacity: 0.8; margin-bottom: 8px;">Page Views</div>
<div style="font-size: 36px; font-weight: 700;">${pageViews.total.toLocaleString()}</div>
<div style="font-size: 13px; margin-top: 8px; display: flex; align-items: center; gap: 4px;">
<span style="color: #86efac;">↑ 8%</span> vs last period
</div>
</div>
<div style="background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%); padding: 24px; border-radius: 16px; color: #fff; border: 1px solid rgba(255,255,255,0.1);">
<div style="font-size: 13px; opacity: 0.8; margin-bottom: 8px;">Avg. Session</div>
<div style="font-size: 36px; font-weight: 700;">3:42</div>
<div style="font-size: 13px; margin-top: 8px; display: flex; align-items: center; gap: 4px;">
<span style="color: #86efac;">↑ 5%</span> vs last period
</div>
</div>
<div style="background: linear-gradient(135deg, #333333 0%, #1a1a1a 100%); padding: 24px; border-radius: 16px; color: #fff; border: 1px solid rgba(255,255,255,0.1);">
<div style="font-size: 13px; opacity: 0.8; margin-bottom: 8px;">Bounce Rate</div>
<div style="font-size: 36px; font-weight: 700;">38%</div>
<div style="font-size: 13px; margin-top: 8px; display: flex; align-items: center; gap: 4px;">
<span style="color: #86efac;">↓ 3%</span> vs last period
</div>
</div>
</div>

        <!-- Charts Row -->
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 32px;">
            <!-- Traffic Chart -->
<div style="background: #111; padding: 24px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.08);">
<h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: #fff;">Traffic Overview</h3>
<div style="height: 200px; display: flex; align-items: flex-end; gap: 8px; padding: 20px 0;">
                    ${generateTrafficBars()}
</div>
<div style="display: flex; justify-content: space-between; margin-top: 12px; font-size: 12px; color: rgba(255,255,255,0.5);">
<span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span><span>Sun</span>
</div>
</div>

            <!-- Traffic Sources -->
<div style="background: #111; padding: 24px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.08);">
<h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: #fff;">Traffic Sources</h3>
<div style="display: flex; flex-direction: column; gap: 16px;">
                    ${trafficSources.map(s => `
<div>
<div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
<span style="font-size: 14px; color: rgba(255,255,255,0.8);">${s.source}</span>
<span style="font-weight: 600; color: #fff;">${s.percent}%</span>
</div>
<div style="height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
<div style="width: ${s.percent}%; height: 100%; background: ${s.color}; border-radius: 4px;"></div>
</div>
</div>
                    `).join('')}
</div>
</div>
</div>

        <!-- Top Pages Table -->
<div style="background: #111; padding: 24px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.08); margin-bottom: 32px;">
<h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: #fff;">Top Pages</h3>
<table style="width: 100%; border-collapse: collapse;">
<thead>
<tr style="border-bottom: 2px solid rgba(255,255,255,0.1);">
<th style="text-align: left; padding: 12px 0; font-size: 12px; color: rgba(255,255,255,0.5); text-transform: uppercase;">Page</th>
<th style="text-align: right; padding: 12px 0; font-size: 12px; color: rgba(255,255,255,0.5); text-transform: uppercase;">Views</th>
<th style="text-align: right; padding: 12px 0; font-size: 12px; color: rgba(255,255,255,0.5); text-transform: uppercase;">Bounce Rate</th>
<th style="text-align: right; padding: 12px 0; font-size: 12px; color: rgba(255,255,255,0.5); text-transform: uppercase;">Trend</th>
</tr>
</thead>
<tbody>
                    ${topPages.map((p, i) => `
<tr style="border-bottom: 1px solid rgba(255,255,255,0.06);">
<td style="padding: 16px 0;">
<div style="display: flex; align-items: center; gap: 12px;">
<span style="width: 24px; height: 24px; background: rgba(255,255,255,0.1); color: #fff; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600;">${i + 1}</span>
<span style="font-weight: 500; color: #fff;">/${p.page.toLowerCase()}</span>
</div>
</td>
<td style="text-align: right; padding: 16px 0; font-weight: 600; color: #fff;">${p.views.toLocaleString()}</td>
<td style="text-align: right; padding: 16px 0;">
<span style="background: ${p.bounce < 35 ? 'rgba(16,185,129,0.2)' : p.bounce < 45 ? 'rgba(245,158,11,0.2)' : 'rgba(239,68,68,0.2)'}; color: ${p.bounce < 35 ? '#10b981' : p.bounce < 45 ? '#f59e0b' : '#ef4444'}; padding: 4px 10px; border-radius: 12px; font-size: 13px;">${p.bounce}%</span>
</td>
<td style="text-align: right; padding: 16px 0; color: #10b981;">↑ ${Math.floor(Math.random() * 15) + 1}%</td>
</tr>
                    `).join('')}
</tbody>
</table>
</div>

        <!-- Real-time Stats -->
<div style="background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); padding: 24px; border-radius: 16px; color: #fff;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h3 style="font-size: 16px; font-weight: 600;">Real-Time Visitors</h3>
<span style="display: flex; align-items: center; gap: 6px;">
<span style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; animation: pulse 2s infinite;"></span>
<span style="color: #10b981; font-weight: 600;">${Math.floor(Math.random() * 20) + 5} active now</span>
</span>
</div>
<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
<div>
<div style="font-size: 24px; font-weight: 700;">${visitors.today}</div>
<div style="font-size: 13px; color: #888;">Today</div>
</div>
<div>
<div style="font-size: 24px; font-weight: 700;">${visitors.week}</div>
<div style="font-size: 13px; color: #888;">This Week</div>
</div>
<div>
<div style="font-size: 24px; font-weight: 700;">${pageViews.today}</div>
<div style="font-size: 13px; color: #888;">Page Views Today</div>
</div>
<div>
<div style="font-size: 24px; font-weight: 700;">2.4</div>
<div style="font-size: 13px; color: #888;">Pages/Session</div>
</div>
</div>
</div>
    `;
}

function generateTrafficBars() {
    const heights = [65, 82, 45, 91, 73, 58, 87];
    return heights.map(h => `
<div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px;">
<div style="width: 100%; height: ${h}%; background: linear-gradient(180deg, var(--red, #ff0000) 0%, #cc0000 100%); border-radius: 4px; min-height: 20px;"></div>
</div>
    `).join('');
}

function refreshAnalytics() {
    const btn = event.target;
    btn.innerHTML = '🔄 Loading...';
    setTimeout(() => {
        siteAnalytics.visitors.today += Math.floor(Math.random() * 10);
        siteAnalytics.pageViews.today += Math.floor(Math.random() * 20);
        saveAnalytics();
        loadAdminAnalyticsPanel();
    }, 1000);
}

function updateAnalyticsRange(range) {
    console.log('Updating analytics for range:', range);
    loadAdminAnalyticsPanel();
}

// ==================== GOOGLE REVIEWS PANEL ====================
let googleReviews = JSON.parse(localStorage.getItem('nui_reviews')) || [
    { id: 1, author: 'Marcus Johnson', rating: 5, text: 'NUI completely transformed our brand. The team understood our vision from day one and delivered beyond expectations. Highly recommend!', date: '2025-01-15', replied: true, reply: 'Thank you Marcus! It was a pleasure working with you.', source: 'demo' },
    { id: 2, author: 'Sarah Williams', rating: 5, text: 'Professional, creative, and incredibly responsive. Our new website has already increased our leads by 40%.', date: '2025-01-10', replied: true, reply: 'We appreciate the kind words Sarah! Excited to see your business grow.', source: 'demo' },
    { id: 3, author: 'David Chen', rating: 4, text: 'Great design work and reasonable pricing. Would have liked faster turnaround but overall satisfied with the results.', date: '2025-01-05', replied: false, reply: '', source: 'demo' },
    { id: 4, author: 'Ashley Brown', rating: 5, text: 'The branding package was exactly what we needed. Logo, colors, everything came together perfectly. Detroit proud!', date: '2024-12-28', replied: true, reply: 'Detroit represent! Thanks for trusting us with your brand.', source: 'demo' },
    { id: 5, author: 'Michael Torres', rating: 5, text: 'Second time working with NUI and they continue to exceed expectations. True partners in our business growth.', date: '2024-12-20', replied: false, reply: '', source: 'demo' }
];
function saveReviews() { localStorage.setItem('nui_reviews', JSON.stringify(googleReviews)); }

// Google Reviews Sync State
let googleReviewsSyncData = JSON.parse(localStorage.getItem('nui_reviews_sync')) || null;

async function syncGoogleReviews() {
    const placeId = seoData.googleMyBusiness?.placeId;
    const resultEl = document.getElementById('gmbSyncResult');

    if (!placeId) {
        if (resultEl) {
            resultEl.style.display = 'block';
            resultEl.innerHTML = '<div style="padding: 12px; background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.3); border-radius: 8px; color: #f87171; font-size: 13px;">⚠️ Enter your Google Place ID above first. <a href="https://developers.google.com/maps/documentation/places/web-service/place-id-lookup" target="_blank" style="color: #60a5fa; text-decoration: underline;">Find your Place ID →</a></div>';
        }
        return;
    }

    if (resultEl) {
        resultEl.style.display = 'block';
        resultEl.innerHTML = '<div style="padding: 12px; background: rgba(59,130,246,0.15); border: 1px solid rgba(59,130,246,0.3); border-radius: 8px; color: #60a5fa; font-size: 13px;">🔄 Syncing reviews from Google...</div>';
    }

    try {
        const response = await fetch('/.netlify/functions/google-reviews?placeId=' + encodeURIComponent(placeId));
        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || 'Sync failed');
        }

        // Store sync data
        googleReviewsSyncData = data;
        localStorage.setItem('nui_reviews_sync', JSON.stringify(data));

        // Replace demo reviews with real Google reviews
        if (data.reviews && data.reviews.length > 0) {
            googleReviews = data.reviews;
            saveReviews();
        }

        // Update sync status
        seoData.googleMyBusiness.connected = true;
        seoData.googleMyBusiness.lastSync = data.syncedAt;
        seoData.googleMyBusiness.totalReviews = data.totalReviews;
        seoData.googleMyBusiness.avgRating = data.avgRating;
        saveSeo();

        if (resultEl) {
            resultEl.innerHTML = `<div style="padding: 12px; background: rgba(16,185,129,0.15); border: 1px solid rgba(16,185,129,0.3); border-radius: 8px; color: #34d399; font-size: 13px;">
                ✅ Synced! Found <strong>${data.totalReviews} total reviews</strong> · Average rating: <strong>${data.avgRating}⭐</strong> · ${data.reviews.length} reviews loaded
<div style="margin-top: 4px; font-size: 11px; opacity: 0.7;">Last sync: ${new Date(data.syncedAt).toLocaleString()}</div>
</div>`;
        }

        // Refresh the reviews panel if it's visible
        const reviewsPanel = document.getElementById('adminReviewsPanel');
        if (reviewsPanel && reviewsPanel.innerHTML) {
            loadAdminReviewsPanel();
        }

        // Update the status badge
        const statusEl = document.getElementById('gmbSyncStatus');
        if (statusEl) {
            statusEl.style.background = 'rgba(16,185,129,0.15)';
            statusEl.style.color = '#34d399';
            statusEl.textContent = '● Connected · ' + data.totalReviews + ' reviews';
        }

    } catch (error) {
        console.error('Google Reviews sync error:', error);
        if (resultEl) {
            resultEl.innerHTML = `<div style="padding: 12px; background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.3); border-radius: 8px; color: #f87171; font-size: 13px;">
                ❌ Sync failed: ${error.message}
<div style="margin-top: 8px; font-size: 11px; opacity: 0.7;">Make sure <strong>GOOGLE_PLACES_API_KEY</strong> is set in Netlify → Site Settings → Environment Variables</div>
</div>`;
        }
    }
}

function loadAdminReviewsPanel() {
    const avgRating = (googleReviews.reduce((sum, r) => sum + r.rating, 0) / googleReviews.length).toFixed(1);
    const fiveStarCount = googleReviews.filter(r => r.rating === 5).length;
    const unrepliedCount = googleReviews.filter(r => !r.replied).length;
    const isLiveData = googleReviews.some(r => r.source === 'google');
    const lastSync = seoData.googleMyBusiness?.lastSync;
    const totalGoogleReviews = seoData.googleMyBusiness?.totalReviews || googleReviews.length;
    const reviewLink = seoData.googleMyBusiness?.reviewLink || 'https://g.page/r/YOUR_PLACE_ID/review';

    document.getElementById('adminReviewsPanel').innerHTML = `
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
<div>
<h2 style="font-size: 28px; font-weight: 700; color: #fff;">⭐ Google Reviews</h2>
<div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
<span style="font-size: 11px; padding: 4px 10px; border-radius: 100px; background: ${isLiveData ? 'rgba(16,185,129,0.15); color: #34d399;' : 'rgba(245,158,11,0.15); color: #fbbf24;'}">${isLiveData ? '● Live from Google' : '● Demo Data'}</span>
                    ${lastSync ? '<span style="font-size: 11px; color: rgba(255,255,255,0.3);">Last sync: ' + new Date(lastSync).toLocaleString() + '</span>' : ''}
                    ${totalGoogleReviews > googleReviews.length ? '<span style="font-size: 11px; color: rgba(255,255,255,0.4);">Showing ' + googleReviews.length + ' of ' + totalGoogleReviews + ' total</span>' : ''}
</div>
</div>
<div style="display: flex; gap: 12px;">
<button onclick="syncGoogleReviews(); setTimeout(loadAdminReviewsPanel, 3000);" class="btn-outline" style="border-color: rgba(255,255,255,0.2); color: #fff;">🔄 Sync Reviews</button>
<button onclick="requestReview()" class="btn-outline" style="border-color: rgba(255,255,255,0.2); color: #fff;">📧 Request Review</button>
<a href="${reviewLink}" target="_blank" class="btn-cta">View on Google →</a>
</div>
</div>
        ${!isLiveData ? '<div style="padding: 16px; background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.2); border-radius: 12px; margin-bottom: 24px; display: flex; align-items: center; gap: 12px;"><span style="font-size: 24px;">💡</span><div><p style="font-size: 13px; color: #fbbf24; font-weight: 600;">These are demo reviews.</p><p style="font-size: 12px; color: rgba(255,255,255,0.4); margin-top: 4px;">Go to 📍 Google Business → Google Integration → enter your Place ID and click Sync to pull real reviews.</p></div></div>' : ''}

        <!-- Stats Overview -->
<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 32px;">
<div style="background: linear-gradient(135deg, #e63946 0%, #ff6b6b 100%); padding: 24px; border-radius: 16px; color: #fff; text-align: center;">
<div style="font-size: 48px; font-weight: 700;">⭐ ${avgRating}</div>
<div style="font-size: 14px; margin-top: 8px; opacity: 0.9;">Average Rating</div>
</div>
<div style="background: #111; padding: 24px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.08); text-align: center;">
<div style="font-size: 48px; font-weight: 700; background: linear-gradient(135deg, #fff 0%, #888 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${googleReviews.length}</div>
<div style="font-size: 14px; color: rgba(255,255,255,0.5); margin-top: 8px;">Total Reviews</div>
</div>
<div style="background: #111; padding: 24px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.08); text-align: center;">
<div style="font-size: 48px; font-weight: 700; background: linear-gradient(135deg, #10b981 0%, #34d399 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${fiveStarCount}</div>
<div style="font-size: 14px; color: rgba(255,255,255,0.5); margin-top: 8px;">5-Star Reviews</div>
</div>
<div style="background: #111; padding: 24px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.08); text-align: center;">
<div style="font-size: 48px; font-weight: 700; background: linear-gradient(135deg, ${unrepliedCount > 0 ? '#f59e0b, #fbbf24' : '#10b981, #34d399'}); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${unrepliedCount}</div>
<div style="font-size: 14px; color: rgba(255,255,255,0.5); margin-top: 8px;">Needs Reply</div>
</div>
</div>

        <!-- Rating Distribution -->
<div style="background: #111; padding: 24px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.08); margin-bottom: 32px;">
<h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: #fff;">Rating Distribution</h3>
<div style="display: flex; flex-direction: column; gap: 12px;">
                ${[5,4,3,2,1].map(rating => {
                    const count = googleReviews.filter(r => r.rating === rating).length;
                    const percent = Math.round((count / googleReviews.length) * 100);
                    return `
<div style="display: flex; align-items: center; gap: 12px;">
<span style="width: 60px; font-size: 14px; color: rgba(255,255,255,0.7);">${rating} star${rating > 1 ? 's' : ''}</span>
<div style="flex: 1; height: 12px; background: rgba(255,255,255,0.08); border-radius: 6px; overflow: hidden;">
<div style="width: ${percent}%; height: 100%; background: linear-gradient(90deg, ${rating >= 4 ? '#10b981, #34d399' : rating === 3 ? '#f59e0b, #fbbf24' : '#ef4444, #f87171'}); border-radius: 6px;"></div>
</div>
<span style="width: 40px; text-align: right; font-weight: 600; color: #fff;">${count}</span>
</div>
                    `;
                }).join('')}
</div>
</div>

        <!-- Reviews List -->
<div style="background: #111; padding: 24px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.08);">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h3 style="font-size: 16px; font-weight: 600; color: #fff;">All Reviews</h3>
<select style="padding: 8px 16px; border: 1px solid rgba(255,255,255,0.15); border-radius: 8px; background: #1a1a1a; color: #fff;">
<option>Most Recent</option>
<option>Highest Rated</option>
<option>Lowest Rated</option>
<option>Needs Reply</option>
</select>
</div>
<div style="display: flex; flex-direction: column; gap: 16px;">
                ${googleReviews.map(r => renderReviewCard(r)).join('')}
</div>
</div>
    `;
}

function renderReviewCard(review) {
    return `
<div style="padding: 20px; background: #1a1a1a; border-radius: 12px; border-left: 4px solid ${review.rating >= 4 ? '#10b981' : review.rating === 3 ? '#f59e0b' : '#ef4444'};">
<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
<div style="display: flex; align-items: center; gap: 12px;">
<div style="width: 40px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px; color: #fff;">${review.author.charAt(0)}</div>
<div>
<div style="font-weight: 600; color: #fff;">${review.author}</div>
<div style="font-size: 13px; color: rgba(255,255,255,0.4);">${new Date(review.date).toLocaleDateString()}</div>
</div>
</div>
<div style="display: flex; gap: 2px; color: #f59e0b;">
                    ${'★'.repeat(review.rating)}${'<span style="color: rgba(255,255,255,0.2);">☆</span>'.repeat(5 - review.rating)}
</div>
</div>
<p style="font-size: 14px; line-height: 1.6; margin-bottom: 12px; color: rgba(255,255,255,0.7);">"${review.text}"</p>
            ${review.replied ? `
<div style="background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.2); padding: 12px; border-radius: 8px; margin-top: 12px;">
<div style="font-size: 12px; color: rgba(255,255,255,0.4); margin-bottom: 4px;">Your Reply:</div>
<p style="font-size: 13px; color: #34d399;">${review.reply}</p>
</div>
            ` : `
<button onclick="openReplyModal(${review.id})" style="padding: 8px 16px; background: #e63946; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Reply to Review</button>
            `}
</div>
    `;
}

function openReplyModal(reviewId) {
    const review = googleReviews.find(r => r.id === reviewId);
    if (!review) return;
    const reply = prompt('Reply to ' + review.author + "'s review:", '');
    if (reply) {
        review.replied = true;
        review.reply = reply;
        saveReviews();
        loadAdminReviewsPanel();
    }
}

function requestReview() {
    alert('📧 Review request feature coming soon! This will send automated emails to recent clients asking for Google reviews.');
}

function loadAdminClientsPanel(searchTerm = '') {
    const filtered = searchTerm
        ? clients.filter(c =>
            (c.name || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
            (c.email || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
            (c.industry || '').toLowerCase().includes(searchTerm.toLowerCase())
          )
        : clients;

    document.getElementById('adminClientsPanel').innerHTML = `
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
<h2 style="font-size: 28px; font-weight: 700;">All Clients</h2>
<span style="color: #888;">${filtered.length} of ${clients.length} clients</span>
</div>
<div style="display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; align-items: center;">
<input type="text" id="clientSearch" placeholder="Search clients by name, email, or industry..." value="${searchTerm}"
                oninput="loadAdminClientsPanel(this.value)"
                style="flex: 1; min-width: 250px; padding: 12px 16px; border: 1px solid #e5e5e5; border-radius: 8px; font-size: 14px;">
<button onclick="showCsvImportModal()" style="padding: 10px 16px; background: #10b981; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">📥 Import CSV</button>
<button onclick="exportClientsCSV()" style="padding: 10px 16px; background: #f3f4f6; border: 1px solid #e5e5e5; border-radius: 8px; cursor: pointer;">📤 Export CSV</button>
<button onclick="showAdminPanel('newclient')" class="btn-cta">+ New Client</button>
</div>
<input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCsvUpload(event)">
        ${filtered.length > 0 ? `
<div class="card-grid">${filtered.map(c => renderClientCard(c)).join('')}</div>
        ` : '<p style="color: #888; text-align: center; padding: 40px;">No clients found.</p>'}
    `;
}

// Export clients to CSV
function exportClientsCSV() {
    if (clients.length === 0) {
        alert('No clients to export.');
        return;
    }

    const headers = ['ID', 'Name', 'Email', 'Industry', 'Website', 'Created Via', 'Email Verified', 'Created At'];
    const rows = clients.map(c => [
        c.id,
        c.name || '',
        c.email || '',
        c.industry || '',
        c.website || '',
        c.createdVia || 'manual',
        c.emailVerified ? 'Yes' : 'No',
        c.createdAt || ''
    ]);

    const csv = [headers.join(','), ...rows.map(r => r.map(v => '"' + String(v).replace(/"/g, '""') + '"').join(','))].join('\n');
    downloadCSV(csv, 'nui-clients-' + new Date().toISOString().split('T')[0] + '.csv');
}

// CSV Import Modal
function showCsvImportModal() {
    const modal = document.createElement('div');
    modal.id = 'csvImportModal';
    modal.innerHTML = `
<div style="position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 9999;">
<div style="background: #1a1a1a; border-radius: 16px; padding: 32px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
<h2 style="font-size: 24px; font-weight: 700;">📥 Import Clients from CSV</h2>
<button onclick="closeCsvImportModal()" style="background: none; border: none; color: #888; font-size: 24px; cursor: pointer;">&times;</button>
</div>

<div style="background: #252525; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
<h3 style="font-size: 16px; margin-bottom: 12px; color: #10b981;">📋 Required CSV Format</h3>
<p style="color: #aaa; font-size: 14px; margin-bottom: 12px;">Your CSV should include the following columns (first row must be headers):</p>
<div style="background: #1a1a1a; padding: 12px; border-radius: 8px; font-family: monospace; font-size: 12px; color: #10b981; overflow-x: auto;">
                        name,email,phone,industry,website,address,notes
</div>
<p style="color: #888; font-size: 12px; margin-top: 12px;">
<strong>Required:</strong> name, email<br>
<strong>Optional:</strong> phone, industry, website, address, notes
</p>
</div>

<div style="background: #252525; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
<h3 style="font-size: 16px; margin-bottom: 12px;">📄 Example CSV</h3>
<pre style="background: #1a1a1a; padding: 12px; border-radius: 8px; font-size: 11px; color: #aaa; overflow-x: auto; white-space: pre-wrap;">name,email,phone,industry,website,address,notes
John's Bakery,john@bakery.com,555-0101,Food & Beverage,www.johnsbakery.com,"123 Main St, Detroit MI",Referred by Sarah
Tech Startup Inc,hello@techstartup.io,555-0102,Technology,techstartup.io,"456 Innovation Blvd",Needs full rebrand
Fitness Plus,contact@fitnessplus.com,555-0103,Health & Fitness,,,"Met at networking event"</pre>
</div>

<div id="csvDropZone" style="border: 2px dashed #444; border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.2s;"
                    onclick="document.getElementById('csvFileInput').click()"
                    ondragover="event.preventDefault(); this.style.borderColor='#10b981'; this.style.background='rgba(16,185,129,0.1)';"
                    ondragleave="this.style.borderColor='#444'; this.style.background='transparent';"
                    ondrop="handleCsvDrop(event)">
<div style="font-size: 48px; margin-bottom: 12px;">📁</div>
<p style="color: #fff; font-size: 16px; margin-bottom: 8px;">Drop your CSV file here</p>
<p style="color: #888; font-size: 14px;">or click to browse</p>
</div>

<div id="csvPreviewArea" style="display: none; margin-top: 20px;"></div>

<div style="display: flex; gap: 12px; margin-top: 24px;">
<button onclick="downloadSampleCSV()" style="flex: 1; padding: 12px; background: #333; border: none; color: #fff; border-radius: 8px; cursor: pointer;">
                        ⬇️ Download Sample CSV
</button>
<button onclick="closeCsvImportModal()" style="flex: 1; padding: 12px; background: #444; border: none; color: #fff; border-radius: 8px; cursor: pointer;">
                        Cancel
</button>
</div>
</div>
</div>
    `;
    document.body.appendChild(modal);
}

function closeCsvImportModal() {
    const modal = document.getElementById('csvImportModal');
    if (modal) modal.remove();
}

function downloadSampleCSV() {
    const sample = `name,email,phone,industry,website,address,notes
John's Bakery,john@bakery.com,555-0101,Food & Beverage,www.johnsbakery.com,"123 Main St, Detroit MI",Referred by Sarah
Tech Startup Inc,hello@techstartup.io,555-0102,Technology,techstartup.io,"456 Innovation Blvd",Needs full rebrand
Fitness Plus,contact@fitnessplus.com,555-0103,Health & Fitness,,,"Met at networking event"
Creative Agency,info@creativeagency.co,555-0104,Marketing & Advertising,creativeagency.co,"789 Design Ave",Hot lead
Local Restaurant,eat@localrestaurant.com,555-0105,Food & Beverage,localrestaurant.com,"321 Food St",Ready to start`;
    downloadCSV(sample, 'nui-clients-sample.csv');
}

function handleCsvDrop(event) {
    event.preventDefault();
    event.target.style.borderColor = '#444';
    event.target.style.background = 'transparent';

    const file = event.dataTransfer.files[0];
    if (file && file.name.endsWith('.csv')) {
        processCsvFile(file);
    } else {
        alert('Please upload a .csv file');
    }
}

function handleCsvUpload(event) {
    const file = event.target.files[0];
    if (file) {
        processCsvFile(file);
    }
}

function processCsvFile(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const csvText = e.target.result;
        const parsedData = parseCSV(csvText);

        if (parsedData.length === 0) {
            alert('No valid data found in CSV file.');
            return;
        }

        showCsvPreview(parsedData);
    };
    reader.readAsText(file);
}

function parseCSV(csvText) {
    const lines = csvText.trim().split('\n');
    if (lines.length < 2) return [];

    // Parse header row
    const headers = parseCSVLine(lines[0]).map(h => h.toLowerCase().trim());

    // Check for required columns
    const nameIdx = headers.indexOf('name');
    const emailIdx = headers.indexOf('email');

    if (nameIdx === -1 || emailIdx === -1) {
        alert('CSV must contain "name" and "email" columns.');
        return [];
    }

    // Parse data rows
    const data = [];
    for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        if (values.length >= 2 && values[nameIdx] && values[emailIdx]) {
            const row = {};
            headers.forEach((header, idx) => {
                row[header] = values[idx] || '';
            });
            data.push(row);
        }
    }

    return data;
}

function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
        const char = line[i];

        if (char === '"') {
            if (inQuotes && line[i + 1] === '"') {
                current += '"';
                i++;
            } else {
                inQuotes = !inQuotes;
            }
        } else if (char === ',' && !inQuotes) {
            result.push(current.trim());
            current = '';
        } else {
            current += char;
        }
    }
    result.push(current.trim());

    return result;
}

function showCsvPreview(data) {
    const previewArea = document.getElementById('csvPreviewArea');
    const existingEmails = clients.map(c => c.email.toLowerCase());

    // Check for duplicates
    const newClients = [];
    const duplicates = [];

    data.forEach(row => {
        if (existingEmails.includes(row.email.toLowerCase())) {
            duplicates.push(row);
        } else {
            newClients.push(row);
        }
    });

    previewArea.style.display = 'block';
    previewArea.innerHTML = `
<div style="background: #252525; border-radius: 12px; padding: 20px;">
<h3 style="font-size: 16px; margin-bottom: 16px;">📊 Import Preview</h3>

<div style="display: flex; gap: 16px; margin-bottom: 16px;">
<div style="flex: 1; background: #10b981; color: #fff; padding: 16px; border-radius: 8px; text-align: center;">
<div style="font-size: 28px; font-weight: bold;">${newClients.length}</div>
<div style="font-size: 12px;">New Clients</div>
</div>
<div style="flex: 1; background: ${duplicates.length > 0 ? '#f59e0b' : '#333'}; color: #fff; padding: 16px; border-radius: 8px; text-align: center;">
<div style="font-size: 28px; font-weight: bold;">${duplicates.length}</div>
<div style="font-size: 12px;">Duplicates (skip)</div>
</div>
</div>

            ${newClients.length > 0 ? `
<div style="max-height: 200px; overflow-y: auto; margin-bottom: 16px;">
<table style="width: 100%; border-collapse: collapse; font-size: 12px;">
<thead>
<tr style="background: #333;">
<th style="padding: 8px; text-align: left; border-bottom: 1px solid #444;">Name</th>
<th style="padding: 8px; text-align: left; border-bottom: 1px solid #444;">Email</th>
<th style="padding: 8px; text-align: left; border-bottom: 1px solid #444;">Industry</th>
</tr>
</thead>
<tbody>
                        ${newClients.slice(0, 10).map(c => `
<tr>
<td style="padding: 8px; border-bottom: 1px solid #333;">${c.name}</td>
<td style="padding: 8px; border-bottom: 1px solid #333;">${c.email}</td>
<td style="padding: 8px; border-bottom: 1px solid #333;">${c.industry || '-'}</td>
</tr>
                        `).join('')}
                        ${newClients.length > 10 ? `<tr><td colspan="3" style="padding: 8px; color: #888; text-align: center;">...and ${newClients.length - 10} more</td></tr>` : ''}
</tbody>
</table>
</div>

<button onclick="importCsvClients()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #10b981, #059669); border: none; color: #fff; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;">
                ✅ Import ${newClients.length} Client${newClients.length !== 1 ? 's' : ''}
</button>
            ` : `
<p style="color: #f59e0b; text-align: center; padding: 20px;">All clients in this CSV already exist in your database.</p>
            `}
</div>
    `;

    // Store for import
    window.pendingCsvImport = newClients;
}

function importCsvClients() {
    const newClients = window.pendingCsvImport || [];

    if (newClients.length === 0) {
        alert('No clients to import.');
        return;
    }

    const maxId = clients.length > 0 ? Math.max(...clients.map(c => c.id)) : 0;

    newClients.forEach((row, idx) => {
        const newClient = {
            id: maxId + idx + 1,
            name: row.name,
            email: row.email,
            phone: row.phone || '',
            industry: row.industry || '',
            website: row.website || '',
            address: row.address || '',
            notes: row.notes || '',
            password: 'client123',
            createdAt: new Date().toISOString(),
            createdVia: 'csv_import',
            emailVerified: false,
            brandAssets: { logo: '', colors: ['#e11d48', '#1a1a1a', '#ffffff'], fonts: [] }
        };
        clients.push(newClient);

        // Also add to CRM contacts
        const crmContacts = JSON.parse(localStorage.getItem('nui_crm_contacts')) || [];
        crmContacts.push({
            id: Date.now() + idx,
            name: row.name,
            email: row.email,
            phone: row.phone || '',
            company: row.name,
            stage: 1,
            value: 0,
            source: 'CSV Import',
            createdAt: new Date().toISOString(),
            lastContact: null,
            activities: [{ type: 'note', date: new Date().toISOString(), content: 'Imported from CSV' }]
        });
        localStorage.setItem('nui_crm_contacts', JSON.stringify(crmContacts));
    });

    localStorage.setItem('nui_clients', JSON.stringify(clients));

    closeCsvImportModal();
    loadAdminClientsPanel();

    alert(`✅ Successfully imported ${newClients.length} client${newClients.length !== 1 ? 's' : ''}!`);
}

function loadAdminOrdersPanel(searchTerm = '', statusFilter = 'all') {
    const designersList = JSON.parse(localStorage.getItem('nui_designers')) || [];

    let filtered = orders;
    if (searchTerm) {
        filtered = filtered.filter(o => {
            const client = clients.find(c => c.id === o.clientId);
            return (o.service || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
                   (client?.name || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
                   (o.assignedDesigner || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
                   String(o.id).includes(searchTerm);
        });
    }
    if (statusFilter !== 'all') {
        if (statusFilter === 'unassigned') {
            filtered = filtered.filter(o => !o.assignedDesigner && o.status !== 'delivered');
        } else {
            filtered = filtered.filter(o => o.status === statusFilter);
        }
    }

    const unassignedOrders = orders.filter(o => !o.assignedDesigner && o.status !== 'delivered').length;
    const inProgressOrders = orders.filter(o => o.status === 'in_progress').length;
    const completedOrders = orders.filter(o => o.status === 'delivered').length;

    document.getElementById('adminOrdersPanel').innerHTML = `
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
<h2 style="font-size: 28px; font-weight: 700;">📋 Order Tracking</h2>
<span style="color: #888;">${filtered.length} of ${orders.length} orders</span>
</div>

        <!-- Search, Filter, and Actions -->
<div style="display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; align-items: center;">
<input type="text" id="orderSearch" placeholder="Search by client, service, designer..." value="${searchTerm}"
                oninput="loadAdminOrdersPanel(this.value, document.getElementById('orderFilter').value)"
                style="flex: 1; min-width: 200px; padding: 12px 16px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; font-size: 14px; background: #252525; color: #fff;">
<select id="orderFilter" onchange="loadAdminOrdersPanel(document.getElementById('orderSearch').value, this.value)" style="padding: 10px 16px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: #252525; color: #fff;">
<option value="all" ${statusFilter === 'all' ? 'selected' : ''}>All Orders</option>
<option value="unassigned" ${statusFilter === 'unassigned' ? 'selected' : ''}>Unassigned</option>
<option value="in_progress" ${statusFilter === 'in_progress' ? 'selected' : ''}>In Progress</option>
<option value="delivered" ${statusFilter === 'delivered' ? 'selected' : ''}>Completed</option>
</select>
<button onclick="exportOrdersCSV()" style="padding: 10px 16px; background: #333; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; cursor: pointer; color: #fff;">Export CSV</button>
<button onclick="showAdminPanel('neworder')" class="btn-cta">+ New Order</button>
</div>

        <!-- Order Stats -->
<div class="stat-cards" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 32px;">
<div class="stat-card"><div class="num">${orders.length}</div><div class="lbl">Total Orders</div></div>
<div class="stat-card" style="border-color: #f59e0b;"><div class="num" style="color: #f59e0b;">${unassignedOrders}</div><div class="lbl">Unassigned</div></div>
<div class="stat-card" style="border-color: var(--blue);"><div class="num" style="color: var(--blue);">${inProgressOrders}</div><div class="lbl">In Progress</div></div>
<div class="stat-card" style="border-color: var(--green);"><div class="num" style="color: var(--green);">${completedOrders}</div><div class="lbl">Completed</div></div>
</div>

        <!-- Unassigned Alert -->
        ${unassignedOrders > 0 ? `
<div style="background: #fef3c7; border: 1px solid #fcd34d; padding: 16px 24px; border-radius: 12px; margin-bottom: 24px; display: flex; align-items: center; justify-content: space-between;">
<div style="display: flex; align-items: center; gap: 12px;">
<span style="font-size: 24px;">⚠️</span>
<div>
<strong style="color: #92400e;">${unassignedOrders} orders need designer assignment</strong>
<p style="font-size: 13px; color: #b45309; margin: 0;">Assign designers to start tracking progress</p>
</div>
</div>
<button onclick="showQuickAssignModal()" style="padding: 8px 16px; background: #d97706; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Quick Assign All</button>
</div>
        ` : ''}

        <!-- Orders List -->
<div id="ordersListContainer">
            ${filtered.length ? filtered.slice().reverse().map(o => renderOrderCardEnhanced(o, designersList)).join('') : '<p style="color: #888; text-align: center; padding: 40px;">No orders found.</p>'}
</div>
    `;
}

// Export orders to CSV
function exportOrdersCSV() {
    if (orders.length === 0) {
        alert('No orders to export.');
        return;
    }

    const headers = ['Order ID', 'Client', 'Service', 'Estimate', 'Status', 'Assigned Designer', 'Progress', 'Created Date'];
    const rows = orders.map(o => {
        const client = clients.find(c => c.id === o.clientId);
        return [
            o.id,
            client?.name || 'Unknown',
            o.service || '',
            o.estimate || 0,
            o.status || '',
            o.assignedDesigner || 'Unassigned',
            (o.progress || 0) + '%',
            o.createdAt || ''
        ];
    });

    const csv = [headers.join(','), ...rows.map(r => r.map(v => '"' + String(v).replace(/"/g, '""') + '"').join(','))].join('\n');
    downloadCSV(csv, 'nui-orders-' + new Date().toISOString().split('T')[0] + '.csv');
}

// Visual Timeline Component
function renderOrderTimeline(order) {
    const stages = [
        { id: 'received', label: 'Order Received', icon: '📥' },
        { id: 'assigned', label: 'Designer Assigned', icon: '👤' },
        { id: 'in_progress', label: 'In Progress', icon: '🎨' },
        { id: 'review', label: 'Under Review', icon: '👁️' },
        { id: 'delivered', label: 'Delivered', icon: '✅' }
    ];

    // Determine current stage
    let currentStage = 0;
    if (order.createdAt) currentStage = 1;
    if (order.assignedDesigner || order.assignedDesignerId) currentStage = 2;
    if (order.status === 'in_progress') currentStage = 3;
    if (order.status === 'review') currentStage = 4;
    if (order.status === 'delivered') currentStage = 5;

    // Calculate turnaround progress
    const daysElapsed = order.createdAt ? Math.floor((new Date() - new Date(order.createdAt)) / (1000*60*60*24)) : 0;
    const turnaroundMin = order.turnaroundDaysMin || 7;
    const turnaroundMax = order.turnaroundDaysMax || turnaroundMin;
    const turnaroundPct = order.status === 'delivered' ? 100 : Math.min(100, Math.round((daysElapsed / turnaroundMax) * 100));
    const isOverdue = daysElapsed > turnaroundMax && order.status !== 'delivered';
    const isNearDue = daysElapsed >= turnaroundMin && daysElapsed <= turnaroundMax;

    return `
<div class="order-timeline" style="margin: 20px 0; padding: 16px; background: var(--admin-bg-secondary, #111); border-radius: 12px;">
            <!-- Turnaround Progress Bar -->
<div style="margin-bottom: 16px; padding: 12px 16px; background: rgba(0,0,0,0.3); border-radius: 8px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
<span style="font-size: 12px; color: var(--admin-text-muted, #888);">Turnaround: <strong style="color: var(--admin-text, #fff);">${order.turnaround || turnaroundMin + ' days'}</strong></span>
<span style="font-size: 12px; color: ${isOverdue ? 'var(--red)' : isNearDue ? '#f59e0b' : 'var(--admin-text-muted, #888)'};">
                        ${order.status === 'delivered' ? '✅ Complete' : isOverdue ? '⚠️ Overdue by ' + (daysElapsed - turnaroundMax) + ' days' : 'Day ' + daysElapsed + ' of ' + turnaroundMax}
</span>
</div>
<div style="width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
<div style="width: ${turnaroundPct}%; height: 100%; background: ${order.status === 'delivered' ? 'var(--green)' : isOverdue ? 'var(--red)' : isNearDue ? '#f59e0b' : 'var(--blue)'}; border-radius: 3px; transition: width 0.3s;"></div>
</div>
                ${order.packageName ? `<div style="font-size: 11px; color: var(--admin-text-muted, #666); margin-top: 6px;">📦 ${order.packageName}</div>` : ''}
</div>

            <!-- Stage Timeline -->
<div style="display: flex; justify-content: space-between; position: relative;">
                <!-- Connecting Line -->
<div style="position: absolute; top: 20px; left: 40px; right: 40px; height: 3px; background: var(--admin-border, rgba(255,255,255,0.1)); z-index: 0;"></div>
<div style="position: absolute; top: 20px; left: 40px; height: 3px; background: var(--red); z-index: 1; transition: width 0.3s; width: ${Math.max(0, (currentStage - 1) * 25)}%;"></div>

                ${stages.map((stage, i) => {
                    const isComplete = i < currentStage;
                    const isCurrent = i === currentStage - 1;
                    // Find timestamp from status history
                    const historyEntry = order.statusHistory?.find(h => h.status === stage.id);
                    const stageDate = historyEntry ? new Date(historyEntry.timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
                    return `
<div style="display: flex; flex-direction: column; align-items: center; z-index: 2; flex: 1;">
<div style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px;
                                background: ${isComplete ? 'var(--red)' : isCurrent ? 'var(--admin-card, #1a1a1a)' : 'var(--admin-card, #1a1a1a)'};
                                border: 3px solid ${isComplete ? 'var(--red)' : isCurrent ? '#ff6b6b' : 'var(--admin-border, rgba(255,255,255,0.1))'};
                                ${isCurrent ? 'box-shadow: 0 0 12px rgba(255,0,0,0.4);' : ''}">
                                ${isComplete ? '✓' : stage.icon}
</div>
<span style="font-size: 11px; color: ${isComplete || isCurrent ? 'var(--admin-text, #fff)' : 'var(--admin-text-muted, #888)'}; margin-top: 8px; text-align: center; font-weight: ${isCurrent ? '600' : '400'};">${stage.label}</span>
                            ${stageDate ? `<span style="font-size: 10px; color: var(--admin-text-muted, #666); margin-top: 2px;">${stageDate}</span>` : ''}
</div>
                    `;
                }).join('')}
</div>
</div>
    `;
}

// Add status history entry
function addStatusHistory(order, status, note = '') {
    if (!order.statusHistory) order.statusHistory = [];
    order.statusHistory.push({
        status: status,
        timestamp: new Date().toISOString(),
        note: note || getDefaultStatusNote(status),
        user: currentUser?.name || 'System'
    });
}

// Default status notes
function getDefaultStatusNote(status) {
    const notes = {
        'pending': 'Order created',
        'assigned': 'Designer assigned to project',
        'in_progress': 'Work started on project',
        'review': 'Submitted for client review',
        'delivered': 'Project completed and delivered'
    };
    return notes[status] || 'Status updated';
}

// Render status history
function renderStatusHistory(order) {
    if (!order.statusHistory || order.statusHistory.length === 0) {
        return '<p style="color: var(--admin-text-muted, #888); font-size: 13px;">No status history available</p>';
    }

    return order.statusHistory.map(entry => `
<div style="display: flex; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--admin-border, rgba(255,255,255,0.1));">
<div style="width: 8px; height: 8px; background: var(--red); border-radius: 50%; margin-top: 6px;"></div>
<div style="flex: 1;">
<div style="font-weight: 600; color: var(--admin-text, #fff); text-transform: capitalize;">${entry.status.replace('_', ' ')}</div>
<div style="font-size: 13px; color: var(--admin-text-muted, #888);">${entry.note}</div>
<div style="font-size: 11px; color: var(--admin-text-muted, #666); margin-top: 4px;">
                    ${new Date(entry.timestamp).toLocaleString()} • ${entry.user}
</div>
</div>
</div>
    `).join('');
}

// Due date warning helper
function getDueDateWarning(dueDate) {
    if (!dueDate) return null;
    const days = Math.ceil((new Date(dueDate) - new Date()) / (1000*60*60*24));
    if (days < 0) return { type: 'overdue', label: `OVERDUE by ${Math.abs(days)} days`, color: 'var(--red)' };
    if (days <= 2) return { type: 'urgent', label: `DUE SOON (${days}d)`, color: '#f59e0b' };
    if (days <= 7) return { type: 'upcoming', label: `Coming up (${days}d)`, color: '#3b82f6' };
    return null;
}

function renderOrderCardEnhanced(o, designers) {
    const client = clients.find(c => c.id === o.clientId);
    const progress = o.status === 'delivered' ? 100 : o.status === 'in_progress' ? 60 : o.status === 'pending' ? 20 : 40;
    const daysLeft = Math.ceil((new Date(o.dueDate) - new Date()) / (1000*60*60*24));
    const designerRaw = o.assignedDesigner || null;
    const designer = typeof designerRaw === 'object' ? (designerRaw?.name || null) : designerRaw;

    return `
 <div class="order-card" style="margin-bottom: 16px; position: relative; overflow: hidden;">
        ${!designer ? '<div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: #f59e0b;"></div>' : ''}
<div class="order-header" style="display: flex; justify-content: space-between; align-items: start;">
<div style="flex: 1;">
<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
<div class="order-title" style="font-size: 18px;">${o.projectName}</div>
<span class="order-status ${o.status}" style="text-transform: capitalize;">${o.status.replace('_', ' ')}</span>
</div>
<div class="order-client" style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
<span>👤 ${client ? client.name : 'Unknown Client'}</span>
<span style="color: #888;">|</span>
<span style="color: ${daysLeft < 0 ? 'var(--red)' : daysLeft < 3 ? '#f59e0b' : '#888'};">
                        📅 ${daysLeft < 0 ? 'Overdue by ' + Math.abs(daysLeft) + ' days' : daysLeft + ' days left'}
</span>
<span style="color: #888;">|</span>
<span style="color: var(--green); font-weight: 600;">💰 $${o.estimate?.toLocaleString() || 0}</span>
</div>
</div>
<div style="text-align: right;">
                ${designer ? `
<div style="display: flex; align-items: center; gap: 8px; background: #f0fdf4; padding: 8px 12px; border-radius: 8px;">
<span style="width: 32px; height: 32px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px;">${String(designer).charAt(0)}</span>
<div>
<div style="font-weight: 600; font-size: 14px;">${designer}</div>
<div style="font-size: 11px; color: #059669;">Assigned</div>
</div>
</div>
                ` : `
<select onchange="assignDesignerToOrder(${o.id}, this.value)" style="padding: 10px 16px; border: 2px solid #f59e0b; border-radius: 8px; background: #fffbeb; font-weight: 600; cursor: pointer;">
<option value="">⚠️ Assign Designer</option>
                        ${designers.map(d => `<option value="${d.name}">${d.name}</option>`).join('')}
</select>
                `}
</div>
</div>

        <!-- Progress Section -->
<div style="margin: 16px 0;">
<div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
<span style="font-size: 13px; color: #666;">Progress</span>
<span style="font-size: 13px; font-weight: 600;">${progress}%</span>
</div>
<div class="progress-bar"><div class="progress-fill" style="width: ${progress}%; background: ${o.status === 'delivered' ? 'var(--green)' : o.status === 'in_progress' ? 'var(--blue)' : '#f59e0b'}"></div></div>
</div>

        <!-- Visual Order Timeline -->
        ${renderOrderTimeline(o)}

        <!-- Due Date Warning -->
        ${(() => {
            const warning = getDueDateWarning(o.dueDate);
            return warning ? `<div style="display: inline-block; padding: 6px 14px; background: ${warning.color}20; border: 1px solid ${warning.color}40; color: ${warning.color}; border-radius: 6px; font-size: 12px; font-weight: 600; margin-bottom: 12px;">⏰ ${warning.label}</div>` : '';
        })()}

        <!-- Actions -->
<div style="display: flex; gap: 8px; margin-top: 16px; flex-wrap: wrap;">
<button onclick="viewOrderDetails(${o.id})" class="btn-outline" style="padding: 8px 16px;">View Details</button>
<button onclick="showInvoice(${o.id})" style="padding: 8px 16px; background: #f5f5f5; border: none; border-radius: 6px; cursor: pointer;">Invoice</button>
            ${o.status !== 'delivered' ? `
<button onclick="updateOrderStatus(${o.id})" style="padding: 8px 16px; background: var(--blue); color: #fff; border: none; border-radius: 6px; cursor: pointer;">Update Status</button>
<button onclick="markDelivered(${o.id})" style="padding: 8px 16px; background: var(--green); color: #fff; border: none; border-radius: 6px; cursor: pointer;">✓ Mark Delivered</button>
            ` : `
<span style="padding: 8px 16px; background: #d1fae5; color: #059669; border-radius: 6px;">✓ Completed ${o.deliveredAt ? new Date(o.deliveredAt).toLocaleDateString() : ''}</span>
            `}
</div>
 </div>`;
}

async function assignDesignerToOrder(orderId, designerName) {
    const order = orders.find(o => o.id === orderId);
    if (order && designerName) {
        // Store both name and ID for proper designer dashboard matching
        const allDesigners = JSON.parse(localStorage.getItem('nui_designers')) || [];
        const designer = allDesigners.find(d => d.name === designerName);
        order.assignedDesigner = designerName;
        order.assignedDesignerId = designer?.id || designerName; // ID for dashboard filtering
        order.assignedAt = new Date().toISOString();
        addStatusHistory(order, 'assigned', `Assigned to ${designerName}`);
        if (order.status === 'pending') {
            order.status = 'in_progress';
            addStatusHistory(order, 'in_progress', 'Work started');
        }
        saveOrders();

        // Notify the assigned designer via messaging
        addDesignerMessage(designer?.id || designerName, order.id, `📁 You've been assigned to "${order.projectName}" — Due: ${new Date(order.dueDate).toLocaleDateString()}`, 'system', true);

        // Notify client that work has started
        const client = clients.find(c => c.id === order.clientId);
        if (client?.email) {
            try {
                await fetch('/.netlify/functions/send-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to: client.email,
                        clientId: client.id,
                        subject: `🎨 Your ${order.projectName} is Now In Progress!`,
                        html: `<div style="font-family: -apple-system, sans-serif; max-width: 600px; margin: 0 auto; background: #0a0a0a; color: #fff; border-radius: 12px; overflow: hidden;">
<div style="background: linear-gradient(135deg, #3b82f6, #60a5fa); padding: 32px; text-align: center;">
<h2 style="margin: 0; font-size: 24px; color: #fff;">Work Has Begun! 🎨</h2>
</div>
<div style="padding: 32px;">
<p style="color: #ccc; font-size: 16px;">Hey ${client.name},</p>
<p style="color: #ccc; font-size: 16px;">Great news — a designer has been assigned to your <strong>${order.projectName}</strong> project and work is officially underway!</p>
<div style="background: #111; border: 1px solid #333; border-radius: 12px; padding: 24px; margin: 24px 0;">
<p style="color: #3b82f6; font-weight: 600; margin-bottom: 12px;">📋 Project Details:</p>
<p style="color: #ccc;">Designer: <strong>${designerName}</strong></p>
<p style="color: #ccc;">Turnaround: <strong>${order.turnaround}</strong></p>
<p style="color: #ccc;">Due Date: <strong>${new Date(order.dueDate).toLocaleDateString()}</strong></p>
</div>
<p style="color: #888; font-size: 14px;">You'll receive updates as work progresses. Check your <a href="https://newurbaninfluence.com/#portal" style="color: #e63946;">Client Portal</a> anytime for the latest status.</p>
</div>
<div style="background: #050505; padding: 20px; text-align: center; border-top: 1px solid #222;">
<p style="color: #666; font-size: 12px; margin: 0;">New Urban Influence • Detroit, MI</p>
</div>
</div>`,
                        text: `Your project "${order.projectName}" is now in progress! Designer ${designerName} has been assigned. Turnaround: ${order.turnaround}.`
                    })
                });
            } catch (err) { console.log('Assignment email failed:', err.message); }
        }

        // Log to CRM
        logProofActivity('assigned', { clientId: order.clientId, projectName: order.projectName }, `Designer ${designerName} assigned to "${order.projectName}"`);

        loadAdminOrdersPanel();
    }
}

function showQuickAssignModal() {
    const designers = JSON.parse(localStorage.getItem('nui_designers')) || [];
    const unassignedOrders = orders.filter(o => !o.assignedDesigner && o.status !== 'delivered');

    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.id = 'quickAssignModal';
    modal.innerHTML = `
<div class="modal" style="max-width: 600px;">
<div class="modal-header">
<h3 class="modal-title">Quick Assign Designers</h3>
<button class="modal-close" onclick="document.getElementById('quickAssignModal').remove()">×</button>
</div>
<div class="modal-body">
                ${unassignedOrders.map(o => `
<div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: #f8fafc; border-radius: 8px; margin-bottom: 12px;">
<div>
<div style="font-weight: 600;">${o.projectName}</div>
<div style="font-size: 13px; color: #888;">${clients.find(c => c.id === o.clientId)?.name || 'Unknown'}</div>
</div>
<select id="assign_${o.id}" style="padding: 8px 12px; border: 1px solid #e5e5e5; border-radius: 6px;">
<option value="">Select Designer</option>
                            ${designers.map(d => `<option value="${d.name}">${d.name}</option>`).join('')}
</select>
</div>
                `).join('')}
<button onclick="applyQuickAssignments()" class="btn-cta" style="width: 100%; margin-top: 16px;">Assign All Selected</button>
</div>
</div>
    `;
    document.body.appendChild(modal);
}

function applyQuickAssignments() {
    const allDesigners = JSON.parse(localStorage.getItem('nui_designers')) || [];
    const unassignedOrders = orders.filter(o => !o.assignedDesigner && o.status !== 'delivered');
    let assignedCount = 0;

    unassignedOrders.forEach(o => {
        const select = document.getElementById('assign_' + o.id);
        if (select && select.value) {
            const designer = allDesigners.find(d => d.name === select.value);
            o.assignedDesigner = select.value;
            o.assignedDesignerId = designer?.id || select.value;
            o.assignedAt = new Date().toISOString();
            addStatusHistory(o, 'assigned', `Assigned to ${select.value}`);
            if (o.status === 'pending') {
                o.status = 'in_progress';
                addStatusHistory(o, 'in_progress', 'Work started');
            }
            // Notify designer
            addDesignerMessage(designer?.id || select.value, o.id, `📁 You've been assigned to "${o.projectName}" — Due: ${new Date(o.dueDate).toLocaleDateString()}`, 'system', true);
            assignedCount++;
        }
    });

    saveOrders();
    document.getElementById('quickAssignModal').remove();
    loadAdminOrdersPanel();
    alert('Successfully assigned ' + assignedCount + ' orders!');
}

function viewOrderDetails(orderId) {
    const order = orders.find(o => o.id === orderId);
    if (!order) return;
    const client = clients.find(c => c.id === order.clientId);

    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.id = 'orderDetailsModal';
    modal.innerHTML = `
<div class="modal" style="max-width: 700px;">
<div class="modal-header">
<h3 class="modal-title">Order Details: ${order.projectName}</h3>
<button class="modal-close" onclick="document.getElementById('orderDetailsModal').remove()">×</button>
</div>
<div class="modal-body">
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
<div>
<h4 style="font-size: 12px; color: #888; margin-bottom: 8px;">CLIENT</h4>
<p style="font-weight: 600;">${client?.name || 'Unknown'}</p>
<p style="font-size: 14px; color: #666;">${client?.email || ''}</p>
</div>
<div>
<h4 style="font-size: 12px; color: #888; margin-bottom: 8px;">DESIGNER</h4>
<p style="font-weight: 600;">${order.assignedDesigner || 'Not Assigned'}</p>
                        ${order.assignedAt ? `<p style="font-size: 14px; color: #666;">Assigned: ${new Date(order.assignedAt).toLocaleDateString()}</p>` : ''}
</div>
</div>
<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
<div style="padding: 16px; background: #f8fafc; border-radius: 8px; text-align: center;">
<div style="font-size: 24px; font-weight: 700;">$${order.estimate?.toLocaleString() || 0}</div>
<div style="font-size: 12px; color: #888;">Estimate</div>
</div>
<div style="padding: 16px; background: #f8fafc; border-radius: 8px; text-align: center;">
<div style="font-size: 24px; font-weight: 700;">${order.turnaround || 'N/A'}</div>
<div style="font-size: 12px; color: #888;">Turnaround</div>
</div>
<div style="padding: 16px; background: #f8fafc; border-radius: 8px; text-align: center;">
<div style="font-size: 24px; font-weight: 700;">${new Date(order.dueDate).toLocaleDateString()}</div>
<div style="font-size: 12px; color: #888;">Due Date</div>
</div>
<div style="padding: 16px; background: ${order.status === 'delivered' ? '#d1fae5' : '#fef3c7'}; border-radius: 8px; text-align: center;">
<div style="font-size: 24px; font-weight: 700; text-transform: capitalize;">${order.status.replace('_', ' ')}</div>
<div style="font-size: 12px; color: #888;">Status</div>
</div>
</div>
                ${order.description ? `<div style="margin-bottom: 24px;"><h4 style="font-size: 12px; color: #888; margin-bottom: 8px;">DESCRIPTION</h4><p>${order.description}</p></div>` : ''}

                <!-- Visual Timeline -->
<div style="margin-bottom: 24px;">
<h4 style="font-size: 12px; color: #888; margin-bottom: 12px;">ORDER PROGRESS</h4>
                    ${renderOrderTimeline(order)}
</div>

                <!-- Status History -->
<div style="margin-bottom: 24px;">
<h4 style="font-size: 12px; color: #888; margin-bottom: 12px;">STATUS HISTORY</h4>
<div style="background: #f8fafc; border-radius: 12px; padding: 16px; max-height: 200px; overflow-y: auto;">
                        ${renderStatusHistory(order)}
</div>
</div>

<div style="display: flex; gap: 12px;">
<button onclick="document.getElementById('orderDetailsModal').remove(); showInvoice(${order.id});" class="btn-cta">View Invoice</button>
<button onclick="document.getElementById('orderDetailsModal').remove(); updateOrderStatus(${order.id});" class="btn-outline">Update Status</button>
<button onclick="document.getElementById('orderDetailsModal').remove();" style="padding: 10px 20px; background: #f5f5f5; border: none; border-radius: 8px; cursor: pointer;">Close</button>
</div>
</div>
</div>
    `;
    document.body.appendChild(modal);
}

function filterOrders(filter) {
    const containers = document.getElementById('ordersListContainer');
    const designers = JSON.parse(localStorage.getItem('nui_designers')) || [];
    let filteredOrders = orders;

    if (filter === 'unassigned') {
        filteredOrders = orders.filter(o => !o.assignedDesigner && o.status !== 'delivered');
    } else if (filter === 'in_progress') {
        filteredOrders = orders.filter(o => o.status === 'in_progress');
    } else if (filter === 'delivered') {
        filteredOrders = orders.filter(o => o.status === 'delivered');
    }

    containers.innerHTML = filteredOrders.length ?
        filteredOrders.slice().reverse().map(o => renderOrderCardEnhanced(o, designers)).join('') :
        '<p style="color: #888; text-align: center; padding: 40px;">No orders match this filter.</p>';
}

function loadAdminLeadsPanel() {
    const newLeads = leads.filter(l => l.status === 'new').length;
    document.getElementById('adminLeadsPanel').innerHTML = `
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
<h2 style="font-size: 28px; font-weight: 700;">Lead Management</h2>
<button onclick="addManualLead()" class="btn-cta">+ Add Lead</button>
</div>

<div class="stat-cards" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 32px;">
<div class="stat-card"><div class="num">${leads.length}</div><div class="lbl">Total Leads</div></div>
<div class="stat-card" style="border-color: var(--green);"><div class="num" style="color: var(--green);">${newLeads}</div><div class="lbl">New Leads</div></div>
<div class="stat-card"><div class="num">${leads.filter(l => l.status === 'converted').length}</div><div class="lbl">Converted</div></div>
</div>

<div class="form-section">
<div class="form-section-title">🎯 All Leads</div>
            ${leads.length > 0 ? `
<table style="width: 100%; border-collapse: collapse;">
<thead>
<tr style="border-bottom: 2px solid #e5e5e5; text-align: left;">
<th style="padding: 12px 8px; font-size: 12px; text-transform: uppercase; color: #888;">Name</th>
<th style="padding: 12px 8px; font-size: 12px; text-transform: uppercase; color: #888;">Contact</th>
<th style="padding: 12px 8px; font-size: 12px; text-transform: uppercase; color: #888;">Service</th>
<th style="padding: 12px 8px; font-size: 12px; text-transform: uppercase; color: #888;">Budget</th>
<th style="padding: 12px 8px; font-size: 12px; text-transform: uppercase; color: #888;">Status</th>
<th style="padding: 12px 8px; font-size: 12px; text-transform: uppercase; color: #888;">Actions</th>
</tr>
</thead>
<tbody>
                    ${leads.map(lead => `
<tr style="border-bottom: 1px solid #e5e5e5;">
<td style="padding: 16px 8px;"><strong>${lead.name}</strong><br><span style="font-size: 12px; color: #888;">${lead.business || '-'}</span></td>
<td style="padding: 16px 8px;"><a href="mailto:${lead.email}" style="color: var(--red);">${lead.email}</a><br><span style="font-size: 12px; color: #888;">${lead.phone || '-'}</span></td>
<td style="padding: 16px 8px; font-size: 14px;">${lead.service || '-'}</td>
<td style="padding: 16px 8px; font-size: 14px;">${lead.budget || '-'}</td>
<td style="padding: 16px 8px;">
<select onchange="updateLeadStatus(${lead.id}, this.value)" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; background: ${lead.status === 'new' ? '#fef3c7' : lead.status === 'contacted' ? '#dbeafe' : lead.status === 'converted' ? '#d1fae5' : '#f5f5f5'};">
<option value="new" ${lead.status === 'new' ? 'selected' : ''}>New</option>
<option value="contacted" ${lead.status === 'contacted' ? 'selected' : ''}>Contacted</option>
<option value="qualified" ${lead.status === 'qualified' ? 'selected' : ''}>Qualified</option>
<option value="converted" ${lead.status === 'converted' ? 'selected' : ''}>Converted</option>
<option value="lost" ${lead.status === 'lost' ? 'selected' : ''}>Lost</option>
</select>
</td>
<td style="padding: 16px 8px;">
<button onclick="convertLeadToClient(${lead.id})" style="padding: 6px 12px; background: var(--green); color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-right: 4px;">→ Client</button>
<button onclick="deleteLead(${lead.id})" style="padding: 6px 12px; background: #fee2e2; color: #dc2626; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">×</button>
</td>
</tr>
                    `).join('')}
</tbody>
</table>
            ` : '<p style="text-align: center; color: #888; padding: 40px;">No leads yet. Generate a lead form to start capturing leads!</p>'}
</div>

<div class="form-section" style="margin-top: 24px;">
<div class="form-section-title">🔗 Get Your Lead Form</div>
<p style="color: #666; margin-bottom: 16px;">Go to <strong>New Order</strong> → Select a package → Click "Generate Lead Form" to get embeddable form code.</p>
<button onclick="showAdminPanel('neworder')" class="btn-cta">Go to New Order →</button>
</div>
    `;
}

function updateLeadStatus(leadId, newStatus) {
    const lead = leads.find(l => l.id === leadId);
    if (lead) {
        lead.status = newStatus;
        saveLeads();
        loadAdminLeadsPanel();
    }
}

function convertLeadToClient(leadId) {
    const lead = leads.find(l => l.id === leadId);
    if (!lead) return;
    if (!confirm('Convert ' + lead.name + ' to a client?')) return;

    // Create new client from lead
    const newClient = {
        id: Date.now(),
        name: lead.business || lead.name,
        email: lead.email,
        password: 'client' + Math.random().toString(36).substring(7),
        industry: '',
        website: '',
        colors: ['#ff0000', '#000000', '#ffffff'],
        fonts: { heading: 'Inter', body: 'Inter' },
        assets: { logos: [], mockups: [], social: [], video: [], banner: [], fonts: [], patterns: [], package: [] }
    };
    clients.push(newClient);
    saveClients();

    // Update lead status
    lead.status = 'converted';
    saveLeads();

    alert('Client created!\nEmail: ' + newClient.email + '\nPassword: ' + newClient.password);
    loadAdminLeadsPanel();
}

function deleteLead(leadId) {
    if (!confirm('Delete this lead?')) return;
    leads = leads.filter(l => l.id !== leadId);
    saveLeads();
    loadAdminLeadsPanel();
}

function addManualLead() {
    const name = prompt('Lead Name:');
    if (!name) return;
    const email = prompt('Email:');
    const phone = prompt('Phone:');
    const service = prompt('Service Interest:');
    const budget = prompt('Budget:');

    const newLead = {
        id: Date.now(),
        name, email, phone,
        business: '',
        service, budget,
        message: '',
        status: 'new',
        createdAt: new Date().toISOString()
    };
    leads.push(newLead);
    saveLeads();

    // Trigger workflow: Add to pipeline and email subscribers
    triggerNewLead(newLead.id);

    loadAdminLeadsPanel();
}

// Service Packages defined globally at top of file

function loadAdminNewOrderPanel() {
    document.getElementById('adminNewOrderPanel').innerHTML = `
<h2 style="font-size: 28px; font-weight: 700; margin-bottom: 32px;">Create New Order</h2>

        <!-- SERVICE PACKAGES -->
<div class="form-section">
<div class="form-section-title">📦 Select Service Package</div>
<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 16px;">
                ${servicePackages.map(pkg => `
<div class="package-card" onclick="selectPackage('${pkg.id}')" id="pkg-${pkg.id}" style="padding: 20px; border: 2px solid #e5e5e5; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
<div style="font-weight: 600; font-size: 16px; margin-bottom: 8px;">${pkg.name}</div>
<div style="font-size: 24px; font-weight: 700; color: var(--red); margin-bottom: 8px;">${pkg.price > 0 ? '$' + pkg.price.toLocaleString() : 'Custom'}</div>
<div style="font-size: 12px; color: #888; margin-bottom: 8px;">${pkg.turnaround}</div>
<div style="font-size: 13px; color: #666;">${pkg.desc}</div>
</div>
                `).join('')}
</div>
</div>

        <!-- ORDER FORM -->
<form onsubmit="createOrder(event)" class="form-section" style="max-width: 700px;">
<div class="form-section-title">📋 Order Details</div>
<div class="form-row">
<div class="form-group"><label class="form-label">Client *</label>
<select id="orderClient" class="form-input" required style="background: #252525; color: #fff; border: 1px solid rgba(255,255,255,0.2);">
<option value="">-- Select or Add New --</option>
                        ${clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
<option value="new">+ Add New Client</option>
</select>
</div>
<div class="form-group"><label class="form-label">Package</label>
<select id="orderPackage" class="form-input" onchange="fillPackageDetails()" style="background: #252525; color: #fff; border: 1px solid rgba(255,255,255,0.2);">
<option value="">-- Select Package --</option>
<optgroup label="📦 Service Packages">
                        ${servicePackages.map(p => `<option value="${p.id}">${p.name} - $${p.price}</option>`).join('')}
</optgroup>
<optgroup label="🎯 Individual Services">
                        ${individualServices.map(s => `<option value="svc-${s.id}">${s.name} - $${s.price}</option>`).join('')}
</optgroup>
<option value="custom">➕ Create Custom Package</option>
</select>
</div>
</div>

            <!-- Custom Package Builder -->
<div id="customPackageBuilder" style="display: none; margin-bottom: 20px; padding: 20px; background: rgba(225,29,72,0.1); border-radius: 12px; border: 1px solid rgba(225,29,72,0.3);">
<div style="font-weight: 600; margin-bottom: 12px; color: var(--red);">🎨 Build Custom Package</div>
<div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;" id="selectedServicesContainer"></div>
<select id="addServiceToPackage" onchange="addServiceToCustomPackage(this.value)" style="width: 100%; padding: 10px; background: #252525; color: #fff; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px;">
<option value="">➕ Add service to package...</option>
                    ${individualServices.map(s => `<option value="${s.id}">${s.name} - $${s.price}</option>`).join('')}
</select>
<div style="margin-top: 12px; font-size: 14px; color: rgba(255,255,255,0.7);">Package Total: <strong id="customPackageTotal">$0</strong></div>
</div>
<div class="form-group"><label class="form-label">Project Name *</label><input type="text" id="orderProject" class="form-input" required></div>
<div class="form-group"><label class="form-label">Description</label><textarea id="orderDesc" class="form-input" rows="2"></textarea></div>
<div class="form-row">
<div class="form-group"><label class="form-label">Price ($) *</label><input type="number" id="orderEstimate" class="form-input" required></div>
<div class="form-group"><label class="form-label">Turnaround *</label><input type="text" id="orderTurnaround" class="form-input" required></div>
</div>
<div class="form-row">
<div class="form-group"><label class="form-label">Due Date *</label><input type="date" id="orderDueDate" class="form-input" required></div>
<div class="form-group"><label class="form-label">Status</label>
<select id="orderStatus" class="form-input">
<option value="pending">Pending</option>
<option value="in_progress">In Progress</option>
<option value="delivered">Delivered</option>
</select>
</div>
</div>
<div style="display: flex; gap: 12px; margin-top: 20px;">
<button type="submit" class="btn-cta" style="flex: 1;">Create Order & Invoice</button>
<button type="button" onclick="generateLeadForm()" class="btn-cta" style="flex: 1; background: #000;">Generate Lead Form</button>
</div>
</form>

        <!-- LEAD FORM GENERATOR -->
<div class="form-section" id="leadFormSection" style="display: none;">
<div class="form-section-title">🎯 Lead Capture Form Code</div>
<p style="color: #666; margin-bottom: 16px;">Copy this code and paste it on your website to capture leads:</p>
<textarea id="leadFormCode" class="form-input" rows="12" style="font-family: monospace; font-size: 12px;" readonly></textarea>
<button onclick="copyLeadForm()" class="btn-cta" style="margin-top: 12px;">📋 Copy Form Code</button>
</div>
    `;
}

function selectPackage(pkgId) {
    document.querySelectorAll('.package-card').forEach(el => el.style.borderColor = '#e5e5e5');
    document.getElementById('pkg-' + pkgId).style.borderColor = 'var(--red)';
    document.getElementById('orderPackage').value = pkgId;
    fillPackageDetails();
}

let customPackageServices = [];

function fillPackageDetails() {
    const pkgId = document.getElementById('orderPackage').value;
    const customBuilder = document.getElementById('customPackageBuilder');

    // Handle custom package option
    if (pkgId === 'custom') {
        customBuilder.style.display = 'block';
        document.getElementById('orderProject').value = 'Custom Package';
        return;
    } else {
        customBuilder.style.display = 'none';
    }

    // Handle individual service
    if (pkgId.startsWith('svc-')) {
        const svcId = pkgId.replace('svc-', '');
        const svc = individualServices.find(s => s.id == svcId);
        if (svc) {
            document.getElementById('orderProject').value = svc.name;
            document.getElementById('orderDesc').value = svc.description || '';
            document.getElementById('orderEstimate').value = svc.price;
            document.getElementById('orderTurnaround').value = svc.turnaround || '5-7 days';
            const days = parseInt(svc.turnaround) || 7;
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + days);
            document.getElementById('orderDueDate').value = dueDate.toISOString().split('T')[0];
        }
        return;
    }

    // Handle package
    const pkg = servicePackages.find(p => p.id === pkgId);
    if (pkg) {
        document.getElementById('orderProject').value = pkg.name;
        document.getElementById('orderDesc').value = pkg.desc;
        document.getElementById('orderEstimate').value = pkg.price;
        document.getElementById('orderTurnaround').value = pkg.turnaround;
        const days = parseInt(pkg.turnaround) || 14;
        const dueDate = new Date();
        dueDate.setDate(dueDate.getDate() + days);
        document.getElementById('orderDueDate').value = dueDate.toISOString().split('T')[0];
    }
}

function addServiceToCustomPackage(serviceId) {
    if (!serviceId) return;
    const svc = individualServices.find(s => s.id == serviceId);
    if (!svc || customPackageServices.find(s => s.id == serviceId)) return;

    customPackageServices.push(svc);
    renderCustomPackageServices();
    document.getElementById('addServiceToPackage').value = '';
}

function removeFromCustomPackage(serviceId) {
    customPackageServices = customPackageServices.filter(s => s.id != serviceId);
    renderCustomPackageServices();
}

function renderCustomPackageServices() {
    const container = document.getElementById('selectedServicesContainer');
    const total = customPackageServices.reduce((sum, s) => sum + (s.price || 0), 0);

    container.innerHTML = customPackageServices.map(s => `
<span style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; background: #252525; border-radius: 20px; font-size: 13px;">
            ${s.name} - $${s.price}
<button onclick="removeFromCustomPackage(${s.id})" style="background: none; border: none; color: #ff4444; cursor: pointer; font-size: 16px;">×</button>
</span>
    `).join('');

    document.getElementById('customPackageTotal').textContent = '$' + total.toLocaleString();
    document.getElementById('orderEstimate').value = total;
    document.getElementById('orderDesc').value = customPackageServices.map(s => s.name).join(', ');
}

function generateLeadForm() {
    const pkgId = document.getElementById('orderPackage').value;
    const pkg = servicePackages.find(p => p.id === pkgId) || { name: 'Project Inquiry', price: '', desc: '' };

    const formCode = `<!-- NUI Lead Capture Form -->
<style>
.nui-form{font-family:'Inter',sans-serif;max-width:500px;margin:0 auto;padding:40px;background:#000;color:#fff;border-radius:12px}
.nui-form h3{font-size:24px;margin-bottom:8px}
.nui-form p{color:#888;margin-bottom:24px;font-size:14px}
.nui-form input,.nui-form select,.nui-form textarea{width:100%;padding:14px;margin-bottom:16px;border:1px solid #333;background:#111;color:#fff;border-radius:8px;font-size:14px}
.nui-form input:focus,.nui-form select:focus,.nui-form textarea:focus{outline:none;border-color:#ff0000}
.nui-form button{width:100%;padding:16px;background:#ff0000;color:#fff;border:none;font-weight:600;font-size:16px;cursor:pointer;border-radius:8px}
.nui-form button:hover{background:#cc0000}
.nui-form .logo{color:#ff0000;font-weight:800;font-size:20px;margin-bottom:24px}
</style>
<form class="nui-form" action="https://formspree.io/f/YOUR_FORM_ID" method="POST">
  <div class="logo">NUI.</div>
  <h3>${pkg.name || 'Get Started'}</h3>
  <p>${pkg.desc || "Fill out the form below and we'll get back to you within 24 hours."}</p>
  <input type="text" name="name" placeholder="Your Name *" required>
  <input type="email" name="email" placeholder="Email Address *" required>
  <input type="tel" name="phone" placeholder="Phone Number">
  <input type="text" name="business" placeholder="Business Name">
  <select name="service">
 <option value="">Select Service Interest</option>
    ${servicePackages.map(p => `<option value="${p.name}">${p.name} - $${p.price}</option>`).join('\n    ')}
  </select>
  <input type="text" name="budget" placeholder="Budget Range">
  <textarea name="message" rows="3" placeholder="Tell us about your project..."></textarea>
  <input type="hidden" name="source" value="NUI Lead Form - ${pkg.name}">
  <button type="submit">Get Your Free Quote →</button>
</form>`;

    document.getElementById('leadFormCode').value = formCode;
    document.getElementById('leadFormSection').style.display = 'block';
    document.getElementById('leadFormSection').scrollIntoView({ behavior: 'smooth' });
}

function copyLeadForm() {
    const code = document.getElementById('leadFormCode');
    code.select();
    document.execCommand('copy');
    alert('Lead form code copied to clipboard!');
}

function loadAdminNewClientPanel() {
    document.getElementById('adminNewclientPanel').innerHTML = `
<h2 style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">Create New Client</h2>
<p style="color: #888; margin-bottom: 32px;">Fill in client details to set up their portal, then send a welcome email with questionnaire.</p>
<form onsubmit="createClient(event)" class="form-section" style="max-width: 700px;">

            <!-- CONTACT INFO -->
<div style="font-weight: 600; font-size: 16px; margin-bottom: 16px; color: var(--red); display: flex; align-items: center; gap: 8px;">👤 Contact Information</div>
<div class="form-row">
<div class="form-group"><label class="form-label">Business / Client Name *</label><input type="text" id="newClientName" class="form-input" required placeholder="e.g., Acme Coffee Co."></div>
<div class="form-group"><label class="form-label">Contact Person</label><input type="text" id="newClientContact" class="form-input" placeholder="e.g., John Smith"></div>
</div>
<div class="form-row">
<div class="form-group"><label class="form-label">Email *</label><input type="email" id="newClientEmail" class="form-input" required placeholder="client@email.com"></div>
<div class="form-group"><label class="form-label">Phone Number</label><input type="tel" id="newClientPhone" class="form-input" placeholder="(248) 487-8747"></div>
</div>
<div class="form-row">
<div class="form-group"><label class="form-label">Password *</label><input type="text" id="newClientPassword" class="form-input" required value="" placeholder="Temporary login password"></div>
<div class="form-group"><label class="form-label">Address</label><input type="text" id="newClientAddress" class="form-input" placeholder="Detroit, MI"></div>
</div>

            <!-- BUSINESS INFO -->
<div style="font-weight: 600; font-size: 16px; margin: 24px 0 16px; color: var(--red); display: flex; align-items: center; gap: 8px;">🏢 Business Details</div>
<div class="form-row">
<div class="form-group"><label class="form-label">Industry</label><input type="text" id="newClientIndustry" class="form-input" placeholder="e.g., Restaurant, Tech, Retail"></div>
<div class="form-group"><label class="form-label">Website</label><input type="url" id="newClientWebsite" class="form-input" placeholder="https://"></div>
</div>
<div class="form-row">
<div class="form-group"><label class="form-label">Service Package *</label>
<select id="newClientService" class="form-input" required style="background: #252525; color: #fff; border: 1px solid rgba(255,255,255,0.2);">
<option value="">What service are they getting?</option>
${servicePackages.map(p => '<option value="' + p.id + '">' + p.name + ' — $' + p.price.toLocaleString() + '</option>').join('')}
<option value="custom">Custom / Multiple Services</option>
</select>
</div>
<div class="form-group"><label class="form-label">Referral Source</label>
<select id="newClientReferral" class="form-input" style="background: #252525; color: #fff; border: 1px solid rgba(255,255,255,0.2);">
<option value="">How did they find us?</option>
<option value="google">Google Search</option>
<option value="instagram">Instagram</option>
<option value="referral">Word of Mouth / Referral</option>
<option value="website">Our Website</option>
<option value="event">Networking / Event</option>
<option value="other">Other</option>
</select>
</div>
</div>
<div class="form-row">
<div class="form-group"><label class="form-label">Social Media</label><input type="text" id="newClientSocial" class="form-input" placeholder="@handle or link"></div>
<div class="form-group"><label class="form-label">Notes</label><textarea id="newClientNotes" class="form-input" rows="2" placeholder="Anything important to remember about this client..."></textarea></div>
</div>

            <!-- BRANDING (Optional) -->
<div style="font-weight: 600; font-size: 16px; margin: 24px 0 16px; color: var(--red); display: flex; align-items: center; gap: 8px;">🎨 Branding (Optional — can be set later)</div>
<div class="form-group"><label class="form-label">Brand Colors</label>
<div style="display: flex; gap: 12px;">
<input type="color" id="color1" value="#ff0000" style="width: 50px; height: 40px; border: none; cursor: pointer;">
<input type="color" id="color2" value="#000000" style="width: 50px; height: 40px; border: none; cursor: pointer;">
<input type="color" id="color3" value="#ffffff" style="width: 50px; height: 40px; border: none; cursor: pointer;">
</div>
</div>
<div class="form-row">
<div class="form-group"><label class="form-label">Heading Font</label><input type="text" id="newClientHeadingFont" class="form-input" value="Inter"></div>
<div class="form-group"><label class="form-label">Body Font</label><input type="text" id="newClientBodyFont" class="form-input" value="Inter"></div>
</div>

            <!-- ONBOARDING OPTIONS -->
<div style="font-weight: 600; font-size: 16px; margin: 24px 0 16px; color: var(--red); display: flex; align-items: center; gap: 8px;">🚀 Onboarding Actions</div>
<div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px;">
<label style="display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; cursor: pointer;">
<input type="checkbox" id="sendWelcomeEmail" checked> <span style="font-size: 14px;">📧 Send Welcome Email</span>
</label>
<label style="display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; cursor: pointer;">
<input type="checkbox" id="sendQuestionnaire" checked> <span style="font-size: 14px;">📋 Send Service Questionnaire</span>
</label>
<label style="display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; cursor: pointer;">
<input type="checkbox" id="addToPipeline" checked> <span style="font-size: 14px;">📊 Add to CRM Pipeline</span>
</label>
</div>

<button type="submit" class="btn-cta" style="width: 100%; padding: 16px; font-size: 16px;">Create Client & Start Onboarding</button>
</form>
    `;
}

function loadAdminAssetsPanel() {
    // Calculate storage stats
    const totalAssets = clients.reduce((sum, c) => {
        if (!c.assets) return sum;
        return sum + Object.values(c.assets).reduce((s, arr) => s + (arr?.length || 0), 0);
    }, 0);

    const clientsWithAssets = clients.filter(c => {
        if (!c.assets) return false;
        return Object.values(c.assets).some(arr => arr?.length > 0);
    });

    document.getElementById('adminAssetsPanel').innerHTML = `
<div class="panel-header">
<h2 class="panel-title">📁 Client Brand Asset Storage</h2>
<p class="panel-subtitle">Centralized storage for all client brand assets</p>
</div>

        <!-- Stats -->
<div class="stats-grid">
<div class="stat-card"><div class="stat-label">Total Assets</div><div class="stat-value">${totalAssets}</div></div>
<div class="stat-card"><div class="stat-label">Clients with Assets</div><div class="stat-value">${clientsWithAssets.length}</div></div>
<div class="stat-card"><div class="stat-label">Total Clients</div><div class="stat-value">${clients.length}</div></div>
<div class="stat-card"><div class="stat-label">Asset Categories</div><div class="stat-value">8</div></div>
</div>

        <!-- Client Selector -->
<div class="form-section">
<div class="form-section-title">📂 Select Client</div>
<div class="form-row">
<div class="form-group" style="flex: 2;">
<select id="assetClient" class="form-select" onchange="selectAssetClient(this.value)">
<option value="">-- Select Client to View/Upload Assets --</option>
                        ${clients.map(c => {
                            const assetCount = c.assets ? Object.values(c.assets).reduce((s, arr) => s + (arr?.length || 0), 0) : 0;
                            return '<option value="' + c.id + '">' + c.name + ' (' + assetCount + ' assets)</option>';
                        }).join('')}
</select>
</div>
<div class="form-group">
<button class="btn-admin primary" onclick="showBulkAssetUpload()">📤 Bulk Upload</button>
</div>
</div>
</div>

        <!-- Quick Access - Clients with Assets -->
<div class="form-section">
<div class="form-section-title">⭐ Quick Access - Clients with Assets</div>
            ${clientsWithAssets.length === 0 ? '<p style="color: rgba(255,255,255,0.5);">No clients have assets yet. Select a client above to start uploading.</p>' : ''}
<div style="display: flex; gap: 12px; flex-wrap: wrap;">
                ${clientsWithAssets.slice(0, 10).map(c => {
                    const assetCount = Object.values(c.assets || {}).reduce((s, arr) => s + (arr?.length || 0), 0);
                    const firstLogo = c.assets?.logos?.[0]?.data || '';
                    return `
<div onclick="selectAssetClient(${c.id})" style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 12px; min-width: 200px; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'">
<div style="width: 48px; height: 48px; border-radius: 8px; background: linear-gradient(135deg, ${c.colors?.[0] || '#ff3b30'}, ${c.colors?.[1] || '#000'}); display: flex; align-items: center; justify-content: center; overflow: hidden;">
                            ${firstLogo ? '<img alt="Client brand logo" loading="lazy" src="' + firstLogo + '" style="width: 100%; height: 100%; object-fit: contain; padding: 4px;">' : '<span style="color: #fff; font-weight: 700;">' + c.name.charAt(0) + '</span>'}
</div>
<div>
<div style="font-weight: 600; color: #fff;">${c.name}</div>
<div style="font-size: 12px; color: rgba(255,255,255,0.5);">${assetCount} assets</div>
</div>
</div>
                `;}).join('')}
</div>
</div>

        <!-- Asset Upload Area -->
<div id="assetUploadArea"></div>

        <!-- All Clients Assets Overview -->
<div class="form-section" style="margin-top: 24px;">
<div class="form-section-title">📊 All Clients Asset Overview</div>
<table class="data-table">
<thead><tr><th>Client</th><th>Logos</th><th>Mockups</th><th>Social</th><th>Video</th><th>Fonts</th><th>Total</th><th>Actions</th></tr></thead>
<tbody>
                    ${clients.slice(0, 20).map(c => {
                        const a = c.assets || {};
                        const total = Object.values(a).reduce((s, arr) => s + (arr?.length || 0), 0);
                        return `
<tr>
<td style="font-weight: 600;">${c.name}</td>
<td>${a.logos?.length || 0}</td>
<td>${a.mockups?.length || 0}</td>
<td>${a.social?.length || 0}</td>
<td>${a.video?.length || 0}</td>
<td>${a.fonts?.length || 0}</td>
<td style="font-weight: 600;">${total}</td>
<td>
<button class="btn-admin small" onclick="selectAssetClient(${c.id})">View</button>
                                ${total > 0 ? '<button class="btn-admin small primary" onclick="downloadClientAssets(' + c.id + ')">Download</button>' : ''}
</td>
</tr>
                    `;}).join('')}
</tbody>
</table>
</div>
    `;
}

function selectAssetClient(clientId) {
    if (!clientId) {
        currentAdminClient = null;
        document.getElementById('assetUploadArea').innerHTML = '';
        return;
    }
    currentAdminClient = clients.find(c => c.id == clientId);
    document.getElementById('assetClient').value = clientId;
    renderAssetUpload();
}

function downloadClientAssets(clientId) {
    const client = clients.find(c => c.id == clientId);
    if (!client) return;

    const assetCount = Object.values(client.assets || {}).reduce((s, arr) => s + (arr?.length || 0), 0);
    alert('Downloading ' + assetCount + ' assets for ' + client.name + '...\n\nIn production, this would generate a ZIP file with all brand assets organized by category.');
}

function renderAssetUpload() {
    if (!currentAdminClient) { document.getElementById('assetUploadArea').innerHTML = ''; return; }

    // Initialize assets object if it doesn't exist
    if (!currentAdminClient.assets) {
        currentAdminClient.assets = {};
    }

    const categories = ['logos', 'video', 'mockups', 'social', 'banner', 'fonts', 'patterns', 'package'];
    const currentAssets = currentAdminClient.assets[assetCategory] || [];
    const categoryName = assetCategory ? assetCategory.charAt(0).toUpperCase() + assetCategory.slice(1) : 'Assets';

    document.getElementById('assetUploadArea').innerHTML = `
<div class="category-tabs">${categories.map(cat => `<button class="category-tab ${assetCategory === cat ? 'active' : ''}" onclick="assetCategory='${cat}'; renderAssetUpload();">${cat.charAt(0).toUpperCase() + cat.slice(1)}</button>`).join('')}</div>
<div class="upload-zone" onclick="document.getElementById('assetFile').click();" ondragover="event.preventDefault(); this.style.borderColor='var(--red)';" ondragleave="this.style.borderColor='#ccc';" ondrop="handleAssetDrop(event);">
<p>Drag & drop files here or <span>browse</span></p>
<small>PNG, JPG, SVG, MP4, ZIP supported</small>
<input type="file" id="assetFile" style="display: none;" multiple onchange="handleAssetUpload(event)">
</div>
<h3 style="margin-bottom: 16px;">Current ${categoryName} (${currentAssets.length})</h3>
<div class="assets-grid">${currentAssets.map((a, i) => `
<div class="asset-card">
<div class="asset-preview">${a.data && a.data.startsWith('data:image') ? `<img alt="Brand asset preview" loading="lazy" src="${a.data}">` : a.type}</div>
<div class="asset-info"><div class="asset-name">${a.name}</div><div class="asset-meta">${a.size} • ${a.type}</div></div>
<div style="padding: 0 12px 12px;"><button onclick="deleteAsset(${i})" style="width: 100%; padding: 8px; background: #fee2e2; color: #dc2626; border: none; border-radius: 4px; cursor: pointer; font-family: inherit;">Delete</button></div>
</div>
        `).join('') || '<p style="color: #888; grid-column: 1/-1; text-align: center; padding: 40px;">No assets yet</p>'}</div>
    `;
}

function handleAssetUpload(e) {
    if (!currentAdminClient) return;

    // Initialize assets object if it doesn't exist
    if (!currentAdminClient.assets) {
        currentAdminClient.assets = {};
    }

    Array.from(e.target.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = (ev) => {
            if (!currentAdminClient.assets[assetCategory]) currentAdminClient.assets[assetCategory] = [];
            currentAdminClient.assets[assetCategory].push({
                name: file.name,
                size: (file.size / 1024).toFixed(1) + ' KB',
                type: file.name.split('.').pop().toUpperCase(),
                data: ev.target.result,
                uploadedAt: new Date().toISOString()
            });
            saveClients();
            renderAssetUpload();
        };
        reader.readAsDataURL(file);
    });
}

function handleAssetDrop(e) {
    e.preventDefault();
    e.target.style.borderColor = '#ccc';
    if (e.dataTransfer.files.length) {
        document.getElementById('assetFile').files = e.dataTransfer.files;
        handleAssetUpload({ target: { files: e.dataTransfer.files } });
    }
}

function deleteAsset(index) {
    if (!confirm('Delete this asset?')) return;
    if (currentAdminClient && currentAdminClient.assets && currentAdminClient.assets[assetCategory]) {
        currentAdminClient.assets[assetCategory].splice(index, 1);
        saveClients();
        renderAssetUpload();
    }
}

// ==================== RENDER HELPERS ====================
function renderClientCard(c) {
    const headerColor = (c.colors && c.colors[0]) ? c.colors[0] : '#e11d48';
    const clientName = c.name || c.email || 'Unnamed';
    return `<div class="client-card">
<div class="client-card-header" style="background: ${headerColor};">${clientName.charAt(0).toUpperCase()}</div>
<div class="client-card-body">
<div class="client-card-name">${clientName}</div>
<div class="client-card-meta">${c.industry || 'No industry'} • ${c.servicePackageName || ''} ${c.assets ? Object.values(c.assets).flat().length : 0} assets</div>
<div class="client-card-btns">
<button onclick="viewClientAsAdmin(${c.id})" style="background: #000; color: #fff;">View Portal</button>
<button onclick="currentAdminClient = clients.find(x => x.id === ${c.id}); showAdminPanel('assets');" style="background: #f5f5f5; color: #000;">Upload</button>
<button onclick="deleteClient(${c.id})" style="background: #fee2e2; color: #dc2626;">×</button>
</div>
</div>
 </div>`;
}

function renderOrderCard(o, showActions = false) {
    const client = clients.find(c => c.id === o.clientId);
    const progress = o.status === 'delivered' ? 100 : o.status === 'in_progress' ? 60 : 20;
    const daysLeft = Math.ceil((new Date(o.dueDate) - new Date()) / (1000*60*60*24));
    return `<div class="order-card">
<div class="order-header">
<div><div class="order-title">${o.projectName}</div><div class="order-client">${client ? client.name : 'Unknown'}</div></div>
<span class="order-status ${o.status}">${o.status.replace('_', ' ')}</span>
</div>
<div class="order-details">
<div class="order-detail"><div class="val">$${(o.estimate || 0).toLocaleString()}</div><div class="lbl">Estimate</div></div>
<div class="order-detail"><div class="val">${o.turnaround}</div><div class="lbl">Turnaround</div></div>
<div class="order-detail"><div class="val">${new Date(o.dueDate).toLocaleDateString()}</div><div class="lbl">Due Date</div></div>
<div class="order-detail"><div class="val" style="color: ${daysLeft < 0 ? 'var(--red)' : daysLeft < 3 ? 'var(--yellow)' : 'var(--green)'}">${daysLeft < 0 ? 'Overdue' : daysLeft + ' days'}</div><div class="lbl">Remaining</div></div>
</div>
<div class="progress-bar"><div class="progress-fill" style="width: ${progress}%; background: ${o.status === 'delivered' ? 'var(--green)' : o.status === 'in_progress' ? 'var(--blue)' : 'var(--yellow)'}"></div></div>
        ${showActions ? `<div style="display: flex; gap: 8px; margin-top: 16px;">
<button onclick="showInvoice(${o.id})" class="btn-cta btn-sm">View Invoice</button>
<button onclick="updateOrderStatus(${o.id})" style="padding: 10px 16px; background: #f5f5f5; border: none; border-radius: 4px; cursor: pointer; font-family: inherit;">Update Status</button>
            ${o.status !== 'delivered' ? `<button onclick="markDelivered(${o.id})" style="padding: 10px 16px; background: var(--green); color: #fff; border: none; border-radius: 4px; cursor: pointer; font-family: inherit;">Mark Delivered</button>` : ''}
</div>` : ''}
 </div>`;
}

// ==================== ORDER FUNCTIONS ====================
async function createOrder(e) {
    e.preventDefault();

    const clientId = parseInt(document.getElementById('orderClient').value);

    // Check subscription order limits
    const clientSubs = subscriptions.filter(s => s.clientId === clientId && s.status === 'active');
    const limitedSub = clientSubs.find(s => s.orderLimit);
    if (limitedSub) {
        const activeOrders = orders.filter(o => o.clientId === clientId && !['delivered', 'completed', 'cancelled'].includes(o.status));
        if (activeOrders.length >= limitedSub.orderLimit) {
            alert(`Order limit reached! Your ${limitedSub.plan} plan allows ${limitedSub.orderLimit} active orders at a time. Please wait for a current order to complete before submitting a new one.`);
            return;
        }
    }
    const client = clients.find(c => c.id === clientId);
    const pkgId = document.getElementById('orderPackage')?.value || '';
    const pkg = servicePackages.find(p => p.id === pkgId);
    const svc = pkgId.startsWith('svc-') ? individualServices.find(s => s.id == pkgId.replace('svc-', '')) : null;
    const turnaroundStr = document.getElementById('orderTurnaround').value;

    // Parse turnaround into days for deadline tracking
    const turnaroundMatch = turnaroundStr.match(/(\d+)/);
    const turnaroundDaysMin = turnaroundMatch ? parseInt(turnaroundMatch[1]) : 7;
    const turnaroundMatchMax = turnaroundStr.match(/(\d+)\s*[-–]\s*(\d+)/);
    const turnaroundDaysMax = turnaroundMatchMax ? parseInt(turnaroundMatchMax[2]) : turnaroundDaysMin;

    const order = {
        id: Date.now(),
        clientId: clientId,
        projectName: document.getElementById('orderProject').value,
        description: document.getElementById('orderDesc').value,
        estimate: parseFloat(document.getElementById('orderEstimate').value),
        turnaround: turnaroundStr,
        turnaroundDaysMin: turnaroundDaysMin,
        turnaroundDaysMax: turnaroundDaysMax,
        packageId: pkg ? pkg.id : (svc ? 'svc-' + svc.id : 'custom'),
        packageName: pkg ? pkg.name : (svc ? svc.name : 'Custom Order'),
        dueDate: document.getElementById('orderDueDate').value,
        status: document.getElementById('orderStatus').value,
        statusHistory: [{ status: 'pending', timestamp: new Date().toISOString(), note: 'Order created', user: currentUser?.name || 'Admin' }],
        createdAt: new Date().toISOString(),
        deliveredAt: null,
        deliverables: [],
        paymentStatus: 'unpaid'
    };
    orders.push(order);
    saveOrders();

    // === CREATE REAL INVOICE ===
    const invoice = {
        id: Date.now() + 1,
        invoiceNumber: 'INV-' + order.id,
        clientId: clientId,
        clientName: client?.name || 'Unknown',
        clientEmail: client?.email || '',
        orderId: order.id,
        projectName: order.projectName,
        lineItems: [{ description: order.projectName + (order.description ? ' — ' + order.description : ''), amount: order.estimate }],
        subtotal: order.estimate,
        total: order.estimate,
        dueDate: order.dueDate,
        notes: 'Turnaround: ' + turnaroundStr,
        status: 'pending',
        termsAccepted: false,
        createdAt: new Date().toISOString()
    };
    invoices.push(invoice);
    saveInvoices();
    order.invoiceId = invoice.id;
    saveOrders();

    // === NOTIFY CLIENT VIA EMAIL ===
    if (client?.email) {
        try {
            await fetch('/.netlify/functions/send-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    to: client.email,
                    clientId: clientId,
                    subject: `📋 New Project: ${order.projectName} — Invoice Ready`,
                    html: `<div style="font-family: -apple-system, sans-serif; max-width: 600px; margin: 0 auto; background: #0a0a0a; color: #fff; border-radius: 12px; overflow: hidden;">
<div style="background: linear-gradient(135deg, #e11d48, #ff6b6b); padding: 32px; text-align: center;">
<h2 style="margin: 0; font-size: 24px; color: #fff;">New Project Started!</h2>
</div>
<div style="padding: 32px;">
<p style="color: #ccc; font-size: 16px;">Hey ${client.name},</p>
<p style="color: #ccc; font-size: 16px;">Your project <strong>${order.projectName}</strong> has been created and is ready to go!</p>
<div style="background: #111; border: 1px solid #333; border-radius: 12px; padding: 24px; margin: 24px 0;">
<div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
<span style="color: #888;">Project</span>
<strong style="color: #fff;">${order.projectName}</strong>
</div>
<div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
<span style="color: #888;">Package</span>
<strong style="color: #fff;">${order.packageName}</strong>
</div>
<div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
<span style="color: #888;">Turnaround</span>
<strong style="color: #fff;">${turnaroundStr}</strong>
</div>
<div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
<span style="color: #888;">Due Date</span>
<strong style="color: #fff;">${new Date(order.dueDate).toLocaleDateString()}</strong>
</div>
<div style="display: flex; justify-content: space-between; padding-top: 12px; border-top: 1px solid #333;">
<span style="color: #888;">Amount Due</span>
<strong style="color: #e11d48; font-size: 20px;">$${order.estimate.toLocaleString()}</strong>
</div>
</div>
<div style="text-align: center; margin: 24px 0;">
<a href="https://newurbaninfluence.com/#portal" style="display: inline-block; background: #e11d48; color: #fff; padding: 16px 40px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 16px;">View Invoice & Pay →</a>
</div>
<p style="color: #888; font-size: 13px; text-align: center;">Invoice #${invoice.invoiceNumber}</p>
</div>
<div style="background: #050505; padding: 20px; text-align: center; border-top: 1px solid #222;">
<p style="color: #666; font-size: 12px; margin: 0;">New Urban Influence • Detroit, MI</p>
</div>
</div>`,
                    text: `New project "${order.projectName}" created! Amount: $${order.estimate.toLocaleString()}. Turnaround: ${turnaroundStr}. Log in to your client portal to view invoice and pay.`
                })
            });
            console.log('📧 New order email sent to ' + client.email);
        } catch (err) {
            console.log('Order email failed:', err.message);
        }
    }

    // === NOTIFY DESIGNERS OF AVAILABLE WORK ===
    if (!order.assignedDesigner) {
        const allDesigners = JSON.parse(localStorage.getItem('nui_designers')) || [];
        allDesigners.forEach(d => {
            if (d.id || d.name) {
                addDesignerMessage(d.id || d.name, order.id, `🆕 New project available: "${order.projectName}" — $${order.estimate.toLocaleString()} • ${turnaroundStr}`, 'system', true);
            }
        });
    }

    // === LOG TO CRM ===
    communicationsHub.inbox.unshift({
        id: Date.now() + 2,
        platform: 'system',
        clientId: clientId,
        clientName: client?.name || '',
        preview: `New order created: ${order.projectName} — $${order.estimate.toLocaleString()}`,
        timestamp: new Date().toISOString(),
        unread: true,
        metadata: { type: 'order_created', orderId: order.id, invoiceId: invoice.id }
    });
    saveCommHub();

    showInvoice(order.id);
    showAdminPanel('orders');
    alert('✅ Order created!\n📄 Invoice #' + invoice.invoiceNumber + ' generated' + (client?.email ? '\n📧 Client notified via email' : ''));
}

async function createClient(e) {
    e.preventDefault();

    const email = document.getElementById('newClientEmail').value;
    const name = document.getElementById('newClientName').value;

    // Validate email format
    if (!validateEmail(email)) {
        alert('Please enter a valid email address.');
        return;
    }

    // Check if email already exists
    if (clients.find(c => c.email.toLowerCase() === email.toLowerCase())) {
        alert('A client with this email already exists.');
        return;
    }

    const client = {
        id: Date.now(),
        name: name,
        contact: document.getElementById('newClientContact')?.value || '',
        email: email,
        phone: document.getElementById('newClientPhone')?.value || '',
        password: document.getElementById('newClientPassword').value,
        address: document.getElementById('newClientAddress')?.value || '',
        industry: document.getElementById('newClientIndustry').value,
        website: document.getElementById('newClientWebsite').value,
        social: document.getElementById('newClientSocial')?.value || '',
        servicePackageId: document.getElementById('newClientService')?.value || '',
        servicePackageName: (() => { const sel = document.getElementById('newClientService'); return sel?.value === 'custom' ? 'Custom / Multiple Services' : (servicePackages.find(p => p.id === sel?.value)?.name || ''); })(),
        referralSource: document.getElementById('newClientReferral')?.value || '',
        notes: document.getElementById('newClientNotes')?.value || '',
        colors: [document.getElementById('color1').value, document.getElementById('color2').value, document.getElementById('color3').value],
        fonts: { heading: document.getElementById('newClientHeadingFont').value || 'Inter', body: document.getElementById('newClientBodyFont').value || 'Inter' },
        assets: { logos: [], mockups: [], social: [], video: [], banner: [], fonts: [], patterns: [], package: [] },
        emailVerified: false,
        verificationToken: generateToken(),
        onboardingStatus: 'new',
        createdAt: new Date().toISOString()
    };
    clients.push(client);
    saveClients();

    // === CREATE SUPABASE AUTH ACCOUNT (so welcome email credentials work) ===
    try {
        if (window.NuiAuth && NuiAuth.isAvailable()) {
            await NuiAuth.signUp(client.email, client.password, {
                role: 'client',
                name: client.name,
                clientId: client.id
            });
            console.log('✅ Supabase auth account created for', client.email);
        } else {
            console.warn('⚠️ Supabase Auth not available — client will use localStorage login only');
        }
    } catch (authErr) {
        console.warn('Supabase auth signup failed (client can still use localStorage login):', authErr.message);
    }

    const sendWelcome = document.getElementById('sendWelcomeEmail')?.checked;
    const sendQuest = document.getElementById('sendQuestionnaire')?.checked;
    const addPipeline = document.getElementById('addToPipeline')?.checked;

    let actionsCompleted = [];

    // === SEND WELCOME EMAIL ===
    if (sendWelcome) {
        try {
            await fetch('/.netlify/functions/send-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    to: client.email,
                    clientId: client.id,
                    subject: `Welcome to New Urban Influence! 🎉`,
                    html: `<div style="font-family: -apple-system, sans-serif; max-width: 600px; margin: 0 auto; background: #0a0a0a; color: #fff; border-radius: 12px; overflow: hidden;">
<div style="background: linear-gradient(135deg, #e11d48, #ff6b6b); padding: 40px; text-align: center;">
<h2 style="margin: 0; font-size: 28px; color: #fff;">Welcome to the Family!</h2>
<p style="color: rgba(255,255,255,0.8); margin-top: 8px;">New Urban Influence</p>
</div>
<div style="padding: 32px;">
<p style="color: #ccc; font-size: 16px;">Hey ${client.contact || client.name},</p>
<p style="color: #ccc; font-size: 16px;">We're thrilled to have you on board! Your client portal has been set up and is ready to go.</p>
<div style="background: #111; border: 1px solid #333; border-radius: 12px; padding: 24px; margin: 24px 0;">
<p style="color: #e11d48; font-weight: 600; margin-bottom: 16px;">🔐 Your Login Credentials:</p>
<p style="color: #ccc; margin: 8px 0;">Email: <strong>${client.email}</strong></p>
<p style="color: #ccc; margin: 8px 0;">Password: <strong>${client.password}</strong></p>
<p style="color: #888; font-size: 12px; margin-top: 12px;">We recommend changing your password after first login.</p>
</div>
<div style="text-align: center; margin: 24px 0;">
<a href="https://newurbaninfluence.com/#portal" style="display: inline-block; background: #e11d48; color: #fff; padding: 16px 40px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 16px;">Log In to Your Portal →</a>
</div>
<div style="background: #111; border-left: 3px solid #e11d48; padding: 20px; border-radius: 0 8px 8px 0; margin: 24px 0;">
<p style="color: #fff; font-weight: 600; margin-bottom: 8px;">What's Next?</p>
<p style="color: #ccc; font-size: 14px; line-height: 1.8;">1. Log in and explore your portal<br>2. Complete the service questionnaire (check your inbox!)<br>3. Book a strategy call with our team<br>4. We start bringing your vision to life!</p>
</div>
<p style="color: #888; font-size: 13px;">Questions? Reply to this email or call us at (248) 487-8747.</p>
</div>
<div style="background: #050505; padding: 20px; text-align: center; border-top: 1px solid #222;">
<p style="color: #666; font-size: 12px; margin: 0;">New Urban Influence • Unapologetically Detroit</p>
</div>
</div>`,
                    text: `Welcome to New Urban Influence! Your portal is ready. Login: ${client.email} / ${client.password}. Visit newurbaninfluence.com to get started.`
                })
            });
            actionsCompleted.push('Welcome email sent');
        } catch (err) { console.log('Welcome email failed:', err.message); }
    }

    // === SEND SERVICE QUESTIONNAIRE ===
    if (sendQuest) {
        try {
            await fetch('/.netlify/functions/send-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    to: client.email,
                    clientId: client.id,
                    subject: `📋 Quick Questionnaire — Help Us Serve You Better`,
                    html: `<div style="font-family: -apple-system, sans-serif; max-width: 600px; margin: 0 auto; background: #0a0a0a; color: #fff; border-radius: 12px; overflow: hidden;">
<div style="background: linear-gradient(135deg, #3b82f6, #60a5fa); padding: 32px; text-align: center;">
<h2 style="margin: 0; font-size: 24px; color: #fff;">Tell Us About Your Project</h2>
</div>
<div style="padding: 32px;">
<p style="color: #ccc; font-size: 16px;">Hey ${client.contact || client.name},</p>
<p style="color: #ccc; font-size: 16px;">To kick things off, we'd love to learn more about your business and what you're looking for. Please take a few minutes to fill out our questionnaire:</p>
<div style="text-align: center; margin: 32px 0;">
<a href="https://newurbaninfluence.com/#services" style="display: inline-block; background: #3b82f6; color: #fff; padding: 16px 40px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 16px;">Start Questionnaire →</a>
</div>
<div style="background: #111; border: 1px solid #333; border-radius: 12px; padding: 24px; margin: 24px 0;">
<p style="color: #fff; font-weight: 600; margin-bottom: 12px;">The questionnaire covers:</p>
<p style="color: #ccc; font-size: 14px; line-height: 1.8;">• Your business goals and target audience<br>• Design preferences and inspiration<br>• Budget and timeline expectations<br>• Any existing brand assets</p>
</div>
<p style="color: #888; font-size: 14px;">This helps us match you with the right service package and designer. Takes about 5-10 minutes.</p>
</div>
<div style="background: #050505; padding: 20px; text-align: center; border-top: 1px solid #222;">
<p style="color: #666; font-size: 12px; margin: 0;">New Urban Influence • Detroit, MI</p>
</div>
</div>`,
                    text: `We'd love to learn about your project. Fill out our questionnaire at newurbaninfluence.com/#services to get started.`
                })
            });
            actionsCompleted.push('Questionnaire sent');
            client.onboardingStatus = 'questionnaire_sent';
            saveClients();
        } catch (err) { console.log('Questionnaire email failed:', err.message); }
    }

    // === ADD TO CRM PIPELINE ===
    if (addPipeline) {
        try {
            const newContact = {
                id: client.id,
                name: client.contact || client.name,
                email: client.email,
                phone: client.phone || '',
                company: client.name,
                value: 0,
                stage: 1, // New Lead
                clientId: client.id,
                source: client.referralSource || 'direct',
                createdAt: client.createdAt
            };
            if (typeof crmData !== 'undefined' && crmData && crmData.contacts) {
                if (!crmData.contacts.find(c => c.email === client.email)) {
                    crmData.contacts.push(newContact);
                    localStorage.setItem('nui_crm', JSON.stringify(crmData));
                }
                actionsCompleted.push('Added to CRM pipeline');
            }
        } catch(crmErr) { console.warn('CRM pipeline add failed:', crmErr.message); }
    }

    // === LOG TO COMMUNICATIONS ===
    try {
        if (typeof communicationsHub !== 'undefined' && communicationsHub && communicationsHub.inbox) {
            communicationsHub.inbox.unshift({
                id: Date.now() + 1, platform: 'system', clientId: client.id, clientName: client.name,
                preview: `New client onboarded: ${client.name} (${client.email})`,
                timestamp: new Date().toISOString(), unread: true,
                metadata: { type: 'client_created', actions: actionsCompleted }
            });
            if (typeof saveCommHub === 'function') saveCommHub();
        }
    } catch(commErr) { console.warn('CommHub log failed:', commErr.message); }

    // Show success with actions taken
    const actionsMsg = actionsCompleted.length > 0 ? '\n\n✅ ' + actionsCompleted.join('\n✅ ') : '';
    alert(`Client "${name}" created successfully!${actionsMsg}`);
    showAdminPanel('clients');
}

// Email validation
function validateEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

// Generate verification token
function generateToken() {
    return 'verify_' + Math.random().toString(36).substring(2) + Date.now().toString(36);
}

// Send verification email (simulated)
function sendVerificationEmail(client) {
    console.log('Verification email sent to:', client.email);
    console.log('Verification link: https://newurbaninfluence.com/verify?token=' + client.verificationToken);
    // In production, this would send an actual email via an email service API
}

// Verify email with token
function verifyEmail(token) {
    const client = clients.find(c => c.verificationToken === token);
    if (client) {
        client.emailVerified = true;
        client.verificationToken = null;
        saveClients();
        alert('Email verified successfully! You can now log in.');
        return true;
    }
    alert('Invalid or expired verification token.');
    return false;
}

// Resend verification email
function resendVerification(clientId) {
    const client = clients.find(c => c.id === clientId);
    if (client && !client.emailVerified) {
        client.verificationToken = generateToken();
        saveClients();
        sendVerificationEmail(client);
        alert('Verification email resent to ' + client.email);
    }
}

function deleteClient(id) {
    if (!confirm('Delete this client and all their data?')) return;
    clients = clients.filter(c => c.id !== id);
    orders = orders.filter(o => o.clientId !== id);
    saveClients();
    saveOrders();
    loadAdminClientsPanel();
}

function updateOrderStatus(id) {
    const order = orders.find(o => o.id === id);
    if (!order) return;

    // Show status update modal
    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.id = 'statusUpdateModal';
    modal.innerHTML = `
<div class="modal" style="max-width: 480px;">
<div class="modal-header">
<h3 class="modal-title">📋 Update Order Status</h3>
<button class="modal-close" onclick="document.getElementById('statusUpdateModal').remove()">×</button>
</div>
<div class="modal-body">
<p style="color: var(--admin-text-muted); margin-bottom: 16px;">Update status for: <strong>${order.projectName}</strong></p>

<div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
<label style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; border: 2px solid ${order.status === 'pending' ? 'var(--red)' : 'var(--admin-border)'}; border-radius: 8px; cursor: pointer; background: ${order.status === 'pending' ? 'rgba(255,0,0,0.1)' : 'transparent'};">
<input type="radio" name="orderStatus" value="pending" ${order.status === 'pending' ? 'checked' : ''}>
<span style="font-size: 20px;">📥</span>
<div><strong>Pending</strong><br><span style="font-size: 12px; color: var(--admin-text-muted);">Awaiting assignment</span></div>
</label>
<label style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; border: 2px solid ${order.status === 'in_progress' ? 'var(--red)' : 'var(--admin-border)'}; border-radius: 8px; cursor: pointer; background: ${order.status === 'in_progress' ? 'rgba(255,0,0,0.1)' : 'transparent'};">
<input type="radio" name="orderStatus" value="in_progress" ${order.status === 'in_progress' ? 'checked' : ''}>
<span style="font-size: 20px;">🎨</span>
<div><strong>In Progress</strong><br><span style="font-size: 12px; color: var(--admin-text-muted);">Currently being worked on</span></div>
</label>
<label style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; border: 2px solid ${order.status === 'review' ? 'var(--red)' : 'var(--admin-border)'}; border-radius: 8px; cursor: pointer; background: ${order.status === 'review' ? 'rgba(255,0,0,0.1)' : 'transparent'};">
<input type="radio" name="orderStatus" value="review" ${order.status === 'review' ? 'checked' : ''}>
<span style="font-size: 20px;">👁️</span>
<div><strong>Under Review</strong><br><span style="font-size: 12px; color: var(--admin-text-muted);">Submitted for client review</span></div>
</label>
<label style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; border: 2px solid ${order.status === 'delivered' ? 'var(--green)' : 'var(--admin-border)'}; border-radius: 8px; cursor: pointer; background: ${order.status === 'delivered' ? 'rgba(34,197,94,0.1)' : 'transparent'};">
<input type="radio" name="orderStatus" value="delivered" ${order.status === 'delivered' ? 'checked' : ''}>
<span style="font-size: 20px;">✅</span>
<div><strong>Delivered</strong><br><span style="font-size: 12px; color: var(--admin-text-muted);">Project completed</span></div>
</label>
</div>

<div style="margin-bottom: 16px;">
<label style="display: block; margin-bottom: 8px; font-weight: 600;">Add Note (optional)</label>
<textarea id="statusNote" placeholder="Add a note about this status change..." style="width: 100%; padding: 12px; border: 1px solid var(--admin-border); border-radius: 8px; background: var(--admin-input-bg); color: var(--admin-text); min-height: 80px; resize: vertical;"></textarea>
</div>

<button onclick="applyStatusUpdate(${id})" class="btn-cta" style="width: 100%;">Update Status</button>
</div>
</div>
    `;
    document.body.appendChild(modal);
}

async function applyStatusUpdate(id) {
    const order = orders.find(o => o.id === id);
    const newStatus = document.querySelector('input[name="orderStatus"]:checked')?.value;
    const note = document.getElementById('statusNote')?.value || '';

    if (order && newStatus) {
        const oldStatus = order.status;
        if (oldStatus === newStatus) {
            document.getElementById('statusUpdateModal')?.remove();
            return;
        }
        order.status = newStatus;
        if (newStatus === 'delivered') order.deliveredAt = new Date().toISOString();
        addStatusHistory(order, newStatus, note || `Status changed from ${oldStatus} to ${newStatus}`);
        saveOrders();
        document.getElementById('statusUpdateModal')?.remove();

        // === EMAIL CLIENT ABOUT STATUS CHANGE ===
        const client = clients.find(c => c.id === order.clientId);
        if (client?.email) {
            const statusLabels = {
                'pending': { label: 'Pending', color: '#f59e0b', icon: '📥', msg: 'Your project is queued and will begin shortly.' },
                'in_progress': { label: 'In Progress', color: '#3b82f6', icon: '🎨', msg: 'A designer is actively working on your project!' },
                'review': { label: 'Under Review', color: '#8b5cf6', icon: '👁️', msg: 'Your project is ready for review. You\'ll receive proof files soon!' },
                'delivered': { label: 'Delivered', color: '#10b981', icon: '✅', msg: 'Your project is complete! Log in to your portal to download your files.' }
            };
            const info = statusLabels[newStatus] || { label: newStatus, color: '#888', icon: '📋', msg: '' };

            try {
                await fetch('/.netlify/functions/send-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to: client.email,
                        clientId: client.id,
                        subject: `${info.icon} ${order.projectName} — Status: ${info.label}`,
                        html: `<div style="font-family: -apple-system, sans-serif; max-width: 600px; margin: 0 auto; background: #0a0a0a; color: #fff; border-radius: 12px; overflow: hidden;">
<div style="background: ${info.color}; padding: 32px; text-align: center;">
<h2 style="margin: 0; font-size: 24px; color: #fff;">${info.icon} Project Update</h2>
</div>
<div style="padding: 32px;">
<p style="color: #ccc; font-size: 16px;">Hey ${client.name},</p>
<p style="color: #ccc; font-size: 16px;">Your project <strong>${order.projectName}</strong> status has been updated:</p>
<div style="background: #111; border: 1px solid #333; border-radius: 12px; padding: 24px; margin: 24px 0; text-align: center;">
<div style="font-size: 32px; margin-bottom: 12px;">${info.icon}</div>
<div style="font-size: 24px; font-weight: 700; color: ${info.color}; margin-bottom: 8px;">${info.label}</div>
<p style="color: #888; font-size: 14px; margin: 0;">${info.msg}</p>
                                    ${note ? `<p style="color: #ccc; font-size: 14px; margin-top: 16px; padding-top: 16px; border-top: 1px solid #333; font-style: italic;">"${note}"</p>` : ''}
</div>
                                ${newStatus === 'delivered' ? `<div style="text-align: center;"><a href="https://newurbaninfluence.com" style="display: inline-block; background: #10b981; color: #fff; padding: 16px 40px; border-radius: 8px; text-decoration: none; font-weight: 600;">Download Files →</a></div>` : ''}
<p style="color: #888; font-size: 13px; margin-top: 24px;">Track your project anytime at <a href="https://newurbaninfluence.com/#portal" style="color: #e63946;">your Client Portal</a>.</p>
</div>
<div style="background: #050505; padding: 20px; text-align: center; border-top: 1px solid #222;"><p style="color: #666; font-size: 12px; margin: 0;">New Urban Influence • Detroit, MI</p></div>
</div>`,
                        text: `Project "${order.projectName}" status updated to: ${info.label}. ${info.msg}`
                    })
                });
                console.log('📧 Status update email sent to ' + client.email);
            } catch (err) { console.log('Status email failed:', err.message); }
        }

        // Log to CRM
        logProofActivity('status_change', { clientId: order.clientId, projectName: order.projectName }, `"${order.projectName}" status: ${oldStatus} → ${newStatus}${note ? ' — ' + note : ''}`);

        // Notify designer if assigned
        if (order.assignedDesigner || order.assignedDesignerId) {
            addDesignerMessage(order.assignedDesignerId || order.assignedDesigner, order.id, `📋 Status updated to "${newStatus.replace('_', ' ')}" for "${order.projectName}"${note ? ': ' + note : ''}`, 'system', true);
        }

        loadAdminOrdersPanel();
    }
}

async function markDelivered(id) {
    const order = orders.find(o => o.id === id);
    if (!order) return;
    order.status = 'delivered';
    order.deliveredAt = new Date().toISOString();
    addStatusHistory(order, 'delivered', 'Project completed and delivered to client');
    saveOrders();

    const client = clients.find(c => c.id === order.clientId);

    // Trigger workflow: Send delivery notification
    triggerOrderDelivered(id);

    // Send real delivery email to client
    if (client?.email) {
        try {
            await fetch('/.netlify/functions/send-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    to: client.email,
                    clientId: client.id,
                    subject: `🎉 Your ${order.projectName || order.project || 'Project'} Has Been Delivered!`,
                    html: `<div style="font-family: -apple-system, sans-serif; max-width: 600px; margin: 0 auto; background: #0a0a0a; color: #fff; border-radius: 12px; overflow: hidden;">
<div style="background: linear-gradient(135deg, #10b981, #059669); padding: 32px; text-align: center;">
<h2 style="margin: 0; font-size: 24px; color: #fff;">Your Project is Complete! 🎉</h2>
</div>
<div style="padding: 32px;">
<p style="color: #ccc; font-size: 16px;">Hey ${client.name || 'there'},</p>
<p style="color: #ccc; font-size: 16px;">Great news — your <strong>${order.projectName || order.project}</strong> project has been completed and delivered!</p>
<div style="background: #111; border: 1px solid #333; border-radius: 12px; padding: 24px; margin: 24px 0;">
<p style="color: #10b981; font-weight: 600; margin-bottom: 12px;">📦 What's included:</p>
<p style="color: #ccc; font-size: 14px;">All final files and assets are available in your <a href="https://newurbaninfluence.com/#portal" style="color: #e63946;">Client Portal</a>.</p>
</div>
<p style="color: #ccc; font-size: 14px;">We'd love a Google review if you're happy with the work! It helps us help more Detroit businesses. 🙏</p>
<p style="color: #888; font-size: 13px; margin-top: 24px;">Questions? Reply to this email or call (248) 487-8747.</p>
</div>
<div style="background: #050505; padding: 20px; text-align: center; border-top: 1px solid #222;">
<p style="color: #666; font-size: 12px; margin: 0;">New Urban Influence • Detroit, MI</p>
</div>
</div>`,
                    text: `Your ${order.projectName || order.project} project has been delivered! Log into your client portal to download your files. — New Urban Influence`
                })
            });
            console.log('📧 Delivery email sent to ' + client.email);
        } catch (err) {
            console.log('Delivery email failed:', err.message);
        }
    }

    // Log to CRM
    logProofActivity('delivered', { clientId: order.clientId, projectName: order.projectName || order.project }, `Project "${order.projectName || order.project}" delivered to ${client?.name || 'client'}`);

    alert('Order marked as delivered!' + (client?.email ? '\n📧 Client notified via email.' : ''));
    // Refresh the active panel
    const activePanel = document.querySelector('.admin-panel.active');
    if (activePanel?.id === 'adminDeliveryPanel') {
        loadAdminDeliveryPanel();
    } else {
        loadAdminOrdersPanel();
    }
}

function viewClientAsAdmin(id) {
    const client = clients.find(c => c.id === id);
    if (client) {
        document.getElementById('adminDashboard').style.display = 'none';
        document.getElementById('clientPortal').style.display = 'block';
        showClientPortal(client);
    }
}

// ==================== INVOICE ====================
function showInvoice(orderId) {
    const order = orders.find(o => o.id === orderId);
    const client = clients.find(c => c.id === order.clientId);
    document.getElementById('invoiceContent').innerHTML = `
<div class="invoice-preview" id="invoicePrint">
<div class="invoice-header">
<div><div class="invoice-logo">NEW URBAN INFLUENCE</div><p style="font-size: 12px; color: #666; margin-top: 8px;">Detroit's Premier Digital Agency<br>newurbaninfluence@gmail.com</p></div>
<div><div class="invoice-title">INVOICE</div><div class="invoice-meta">#${order.id}<br>${new Date(order.createdAt).toLocaleDateString()}</div></div>
</div>
<div class="invoice-parties">
<div class="invoice-party"><h4>Bill To</h4><p><strong>${client ? client.name : 'Client'}</strong><br>${client ? client.email : ''}<br>${client ? client.industry : ''}</p></div>
<div class="invoice-party"><h4>Project Details</h4><p><strong>Due Date:</strong> ${new Date(order.dueDate).toLocaleDateString()}<br><strong>Turnaround:</strong> ${order.turnaround}<br><strong>Status:</strong> ${order.status.replace('_', ' ')}</p></div>
</div>
<table class="invoice-table">
<thead><tr><th>Description</th><th style="text-align: right;">Amount</th></tr></thead>
<tbody>
<tr><td><strong>${order.projectName}</strong><br><span style="font-size: 13px; color: #666;">${order.description || 'No description'}</span></td><td style="text-align: right;">$${(order.estimate || 0).toLocaleString()}</td></tr>
</tbody>
</table>
<div class="invoice-total">Total: $${(order.estimate || 0).toLocaleString()}</div>
<p style="margin-top: 32px; font-size: 12px; color: #888; text-align: center;">Thank you for your business! • New Urban Influence • Unapologetically Detroit</p>
</div>
    `;
    document.getElementById('invoiceModal').classList.add('active');
}

function closeInvoiceModal() { document.getElementById('invoiceModal').classList.remove('active'); }

function printInvoice() {
    const content = document.getElementById('invoicePrint').innerHTML;
    const win = window.open('', '', 'width=800,height=600');
    win.document.write(`<html><head><title>Invoice</title><style>body{font-family:Inter,sans-serif;padding:40px;}.invoice-preview{max-width:700px;margin:0 auto;}.invoice-header{display:flex;justify-content:space-between;margin-bottom:32px;padding-bottom:24px;border-bottom:2px solid #000;}.invoice-logo{font-size:24px;font-weight:800;color:#ff0000;}.invoice-title{font-size:32px;font-weight:700;text-align:right;}.invoice-meta{font-size:13px;color:#666;text-align:right;}.invoice-parties{display:grid;grid-template-columns:1fr 1fr;gap:32px;margin-bottom:32px;}.invoice-party h4{font-size:12px;color:#888;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;}.invoice-table{width:100%;border-collapse:collapse;margin-bottom:24px;}.invoice-table th{text-align:left;padding:12px;border-bottom:2px solid #000;font-size:12px;text-transform:uppercase;}.invoice-table td{padding:12px;border-bottom:1px solid #e5e5e5;}.invoice-total{text-align:right;font-size:24px;font-weight:700;}</style>    <!-- Geo Meta Tags -->
    <meta name="geo.region" content="US-MI">
    <meta name="geo.placename" content="Detroit, Michigan">
    <meta name="geo.position" content="42.3314;-83.0458">
    <meta name="ICBM" content="42.3314, -83.0458">
</head><body>${content}</body></html>`);
    win.document.close();
    win.print();
}

// ==================== CLIENT PORTAL (PORTFOLIO-STYLE BRAND GUIDE) ====================
function showClientPortal(client) {
    document.getElementById('clientPortalName').textContent = client.name + ' Brand Portal';
    const clientOrders = orders.filter(o => o.clientId === client.id);
    const deliveredOrders = clientOrders.filter(o => o.status === 'delivered');
    const activeOrders = clientOrders.filter(o => o.status !== 'delivered');
    const logos = client.assets?.logos || [];
    const videos = client.assets?.video || [];
    const mockups = client.assets?.mockups || [];
    const social = client.assets?.social || [];
    const banners = client.assets?.banner || [];
    const allAssets = Object.values(client.assets || {}).flat();

    // Get brand guide proof status
    const brandGuide = client.brandGuide || { status: 'draft', proofComments: [] };
    const isPaid = checkClientPaymentStatus(client.id);

    function isLight(c) { const hex = c.replace('#',''); const r = parseInt(hex.substr(0,2),16); const g = parseInt(hex.substr(2,2),16); const b = parseInt(hex.substr(4,2),16); return (r*299+g*587+b*114)/1000 > 128; }

    document.getElementById('clientPortalContent').innerHTML = `
        <!-- Back Navigation Bar -->
<div class="portal-nav-bar" style="background: rgba(0,0,0,0.95); padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100;">
<button onclick="goBackFromPortal()" class="portal-back-btn" style="display: flex; align-items: center; gap: 8px; background: none; border: none; color: #fff; cursor: pointer; font-size: 16px; padding: 8px 16px; border-radius: 8px; transition: background 0.2s;">
<span style="font-size: 20px;">←</span> Back
</button>
<span style="color: #888; font-size: 14px;">${client.name} Portal</span>
            ${currentUser?.type === 'admin' ? '<button onclick="backToAdmin()" style="background: var(--accent); color: #000; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;">Admin Dashboard</button>' : '<div></div>'}
</div>

<!-- CLIENT PORTAL MAIN TABS -->
<div style="background: #111; border-bottom: 1px solid #222; padding: 0 24px; display: flex; gap: 0; overflow-x: auto;">
<button onclick="switchPortalSection('dashboard', ${client.id})" class="portal-main-tab active" data-tab="dashboard" style="padding: 14px 24px; background: none; border: none; border-bottom: 2px solid #e11d48; color: #fff; font-weight: 600; font-size: 14px; cursor: pointer; white-space: nowrap; font-family: inherit;">📊 Dashboard</button>
<button onclick="switchPortalSection('brand', ${client.id})" class="portal-main-tab" data-tab="brand" style="padding: 14px 24px; background: none; border: none; border-bottom: 2px solid transparent; color: #888; font-weight: 600; font-size: 14px; cursor: pointer; white-space: nowrap; font-family: inherit;">🎨 Brand Portal</button>
<button onclick="switchPortalSection('orders', ${client.id})" class="portal-main-tab" data-tab="orders" style="padding: 14px 24px; background: none; border: none; border-bottom: 2px solid transparent; color: #888; font-weight: 600; font-size: 14px; cursor: pointer; white-space: nowrap; font-family: inherit;">📦 Orders & Invoices</button>
<button onclick="switchPortalSection('info', ${client.id})" class="portal-main-tab" data-tab="info" style="padding: 14px 24px; background: none; border: none; border-bottom: 2px solid transparent; color: #888; font-weight: 600; font-size: 14px; cursor: pointer; white-space: nowrap; font-family: inherit;">👤 My Info</button>
<button onclick="switchPortalSection('proofs', ${client.id})" class="portal-main-tab" data-tab="proofs" style="padding: 14px 24px; background: none; border: none; border-bottom: 2px solid transparent; color: #888; font-weight: 600; font-size: 14px; cursor: pointer; white-space: nowrap; font-family: inherit;">✅ Proofs ${proofs.filter(pr => pr.clientId == client.id && pr.sentToClient && pr.status === 'pending').length > 0 ? '<span style="background:#e11d48;color:#fff;border-radius:100px;padding:2px 8px;font-size:11px;margin-left:4px;">' + proofs.filter(pr => pr.clientId == client.id && pr.sentToClient && pr.status === 'pending').length + '</span>' : ''}</button>
<button onclick="switchPortalSection('questionnaire', ${client.id})" class="portal-main-tab" data-tab="questionnaire" style="padding: 14px 24px; background: none; border: none; border-bottom: 2px solid transparent; color: #888; font-weight: 600; font-size: 14px; cursor: pointer; white-space: nowrap; font-family: inherit;">📋 Questionnaire</button>
<button onclick="switchPortalSection('faq', ${client.id})" class="portal-main-tab" data-tab="faq" style="padding: 14px 24px; background: none; border: none; border-bottom: 2px solid transparent; color: #888; font-weight: 600; font-size: 14px; cursor: pointer; white-space: nowrap; font-family: inherit;">❓ FAQ</button>
</div>

<!-- DASHBOARD SECTION -->
<div id="portalSection-dashboard" class="portal-section" style="padding: 32px;">
<h2 style="font-size: 24px; font-weight: 700; margin-bottom: 24px;">Welcome back, ${client.contact || client.name}!</h2>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px;">
<div style="background: #111; border: 1px solid #222; border-radius: 12px; padding: 24px;">
<div style="font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Service</div>
<div style="font-size: 18px; font-weight: 600; color: #fff;">${client.servicePackageName || 'Not set'}</div>
</div>
<div style="background: #111; border: 1px solid #222; border-radius: 12px; padding: 24px;">
<div style="font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Active Orders</div>
<div style="font-size: 28px; font-weight: 700; color: #3b82f6;">${activeOrders.length}</div>
</div>
<div style="background: #111; border: 1px solid #222; border-radius: 12px; padding: 24px;">
<div style="font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Completed</div>
<div style="font-size: 28px; font-weight: 700; color: #10b981;">${deliveredOrders.length}</div>
</div>
<div style="background: #111; border: 1px solid #222; border-radius: 12px; padding: 24px;">
<div style="font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Brand Status</div>
<div style="font-size: 18px; font-weight: 600; color: ${brandGuide.status === 'approved' ? '#10b981' : brandGuide.status === 'pending' ? '#f59e0b' : '#888'};">${brandGuide.status === 'approved' ? '✓ Approved' : brandGuide.status === 'pending' ? '⏳ Pending' : '📝 In Progress'}</div>
</div>
</div>
${(() => {
    const pendingProofs = proofs.filter(pr => pr.clientId == client.id && pr.sentToClient && pr.status === 'pending');
    return pendingProofs.length > 0 ? '<div style="background: #f59e0b15; border: 1px solid #f59e0b40; border-radius: 12px; padding: 20px; margin-bottom: 24px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;"><div><span style="font-size: 20px;">⏳</span> <strong style="color: #f59e0b;">' + pendingProofs.length + ' proof' + (pendingProofs.length > 1 ? 's' : '') + ' waiting for your review</strong><div style="color: #888; font-size: 13px; margin-top: 4px;">' + pendingProofs.map(p => p.title || p.name || 'Proof').join(', ') + '</div></div><button onclick="switchPortalSection(\'proofs\', ' + client.id + ')" style="padding: 12px 24px; background: #f59e0b; color: #000; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-family: inherit;">Review Now →</button></div>' : '';
})()}

<!-- Quick Actions: Contact Designer & Book a Call -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 32px;">
<button onclick="openClientMessageDesigner(${client.id})" style="background: #111; border: 1px solid #222; border-radius: 12px; padding: 24px; cursor: pointer; text-align: left; font-family: inherit; transition: border-color 0.2s;" onmouseover="this.style.borderColor='#e11d48'" onmouseout="this.style.borderColor='#222'">
<div style="font-size: 24px; margin-bottom: 8px;">💬</div>
<div style="font-size: 16px; font-weight: 600; color: #fff;">Contact Your Designer</div>
<div style="font-size: 13px; color: #888; margin-top: 4px;">Send a message about your project</div>
</button>
<button onclick="openBookCallModal()" style="background: #111; border: 1px solid #222; border-radius: 12px; padding: 24px; cursor: pointer; text-align: left; font-family: inherit; transition: border-color 0.2s;" onmouseover="this.style.borderColor='#e11d48'" onmouseout="this.style.borderColor='#222'">
<div style="font-size: 24px; margin-bottom: 8px;">📞</div>
<div style="font-size: 16px; font-weight: 600; color: #fff;">Book a Call</div>
<div style="font-size: 13px; color: #888; margin-top: 4px;">Mon–Thu 1:00–4:00 PM EST</div>
</button>
</div>

${activeOrders.length > 0 ? '<h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: #fff;">Active Projects</h3>' + activeOrders.map(o => '<div style="background: #111; border: 1px solid #222; border-radius: 12px; padding: 20px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;"><div><div style="font-weight: 600; color: #fff;">' + o.projectName + '</div><div style="font-size: 13px; color: #888; margin-top: 4px;">' + (o.packageName || '') + ' • ' + (o.status || 'pending') + '</div></div><div style="font-size: 13px; color: #888;">' + (o.dueDate ? 'Due: ' + new Date(o.dueDate).toLocaleDateString() : '') + '</div></div>').join('') : '<div style="background: #111; border: 1px solid #222; border-radius: 12px; padding: 32px; text-align: center; color: #888;">No active orders yet. Your projects will appear here once created.</div>'}
</div>

<!-- ORDERS & INVOICES SECTION -->
<div id="portalSection-orders" class="portal-section" style="padding: 32px; display: none;">
<h2 style="font-size: 24px; font-weight: 700; margin-bottom: 24px;">Orders & Invoices</h2>
${clientOrders.length > 0 ? clientOrders.map(o => {
    const inv = invoices.find(i => i.orderId === o.id);
    const statusColors = { pending: '#f59e0b', 'in-progress': '#3b82f6', review: '#8b5cf6', delivered: '#10b981', cancelled: '#ef4444' };
    return '<div style="background: #111; border: 1px solid #222; border-radius: 12px; padding: 24px; margin-bottom: 16px;"><div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 12px;"><div><h3 style="font-size: 18px; font-weight: 600; color: #fff; margin-bottom: 6px;">' + o.projectName + '</h3><div style="font-size: 13px; color: #888;">' + (o.packageName || 'Custom') + ' • Created ' + new Date(o.createdAt).toLocaleDateString() + '</div></div><div style="display: flex; gap: 12px; align-items: center;"><span style="display: inline-block; padding: 6px 14px; border-radius: 100px; font-size: 12px; font-weight: 600; background: ' + (statusColors[o.status] || '#888') + '20; color: ' + (statusColors[o.status] || '#888') + ';">' + (o.status || 'pending') + '</span>' + (o.estimate ? '<span style="font-size: 18px; font-weight: 700; color: #e11d48;">$' + o.estimate.toLocaleString() + '</span>' : '') + '</div></div>' + (o.turnaround ? '<div style="margin-top: 12px; font-size: 13px; color: #888;">⏱ Turnaround: ' + o.turnaround + (o.dueDate ? ' • Due: ' + new Date(o.dueDate).toLocaleDateString() : '') + '</div>' : '') + (inv ? '<div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #222; display: flex; justify-content: space-between; align-items: center;"><span style="font-size: 13px; color: #888;">Invoice #' + (inv.invoiceNumber || inv.id) + '</span><span style="font-size: 13px; font-weight: 600; color: ' + (inv.status === 'paid' ? '#10b981' : '#f59e0b') + ';">' + (inv.status === 'paid' ? '✅ Paid' : '⏳ Unpaid — $' + (inv.total || inv.amount || 0).toLocaleString()) + '</span></div>' : '') + '</div>';
}).join('') : '<div style="background: #111; border: 1px solid #222; border-radius: 12px; padding: 48px; text-align: center;"><div style="font-size: 48px; margin-bottom: 16px;">📦</div><div style="color: #888; font-size: 16px;">No orders yet</div><div style="color: #666; font-size: 14px; margin-top: 8px;">Your orders and invoices will appear here</div></div>'}
</div>

<!-- MY INFO SECTION -->
<div id="portalSection-info" class="portal-section" style="padding: 32px; display: none;">
<h2 style="font-size: 24px; font-weight: 700; margin-bottom: 24px;">My Information</h2>
<div style="max-width: 600px;">
<div style="background: #111; border: 1px solid #222; border-radius: 12px; padding: 24px; margin-bottom: 16px;">
<div style="font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">Business Name</div>
<div style="font-size: 16px; color: #fff; font-weight: 600;">${client.name}</div>
</div>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
<div style="background: #111; border: 1px solid #222; border-radius: 12px; padding: 24px;">
<div style="font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">Contact</div>
<div style="font-size: 16px; color: #fff;">${client.contact || '—'}</div>
</div>
<div style="background: #111; border: 1px solid #222; border-radius: 12px; padding: 24px;">
<div style="font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">Email</div>
<div style="font-size: 16px; color: #fff;">${client.email}</div>
</div>
<div style="background: #111; border: 1px solid #222; border-radius: 12px; padding: 24px;">
<div style="font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">Phone</div>
<div style="font-size: 16px; color: #fff;">${client.phone || '—'}</div>
</div>
<div style="background: #111; border: 1px solid #222; border-radius: 12px; padding: 24px;">
<div style="font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">Industry</div>
<div style="font-size: 16px; color: #fff;">${client.industry || '—'}</div>
</div>
<div style="background: #111; border: 1px solid #222; border-radius: 12px; padding: 24px;">
<div style="font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">Website</div>
<div style="font-size: 16px; color: #fff;">${client.website ? '<a href="' + client.website + '" target="_blank" style="color: #e11d48;">' + client.website + '</a>' : '—'}</div>
</div>
<div style="background: #111; border: 1px solid #222; border-radius: 12px; padding: 24px;">
<div style="font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">Service</div>
<div style="font-size: 16px; color: #fff;">${client.servicePackageName || '—'}</div>
</div>
</div>
<div style="background: #111; border: 1px solid #222; border-radius: 12px; padding: 24px; margin-top: 16px;">
<div style="font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">Address</div>
<div style="font-size: 16px; color: #fff;">${client.address || '—'}</div>
</div>
<div style="background: #111; border: 1px solid #222; border-radius: 12px; padding: 24px; margin-top: 16px;">
<div style="font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">Member Since</div>
<div style="font-size: 16px; color: #fff;">${client.createdAt ? new Date(client.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : '—'}</div>
</div>
</div>
</div>

<!-- QUESTIONNAIRE SECTION -->
<div id="portalSection-questionnaire" class="portal-section" style="padding: 32px; display: none;">
<h2 style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">Service Questionnaire</h2>
<p style="color: #888; margin-bottom: 24px;">Help us understand your brand vision so we can deliver the best results.</p>
<div style="max-width: 600px;">
<form onsubmit="submitClientQuestionnaire(event, ${client.id})">
<div style="margin-bottom: 20px;"><label style="display: block; font-size: 14px; font-weight: 600; color: #fff; margin-bottom: 8px;">What does your business do? *</label><textarea id="q_businessDesc" class="form-input" rows="3" required placeholder="Describe your business, products, or services...">${client.questionnaire?.businessDesc || ''}</textarea></div>
<div style="margin-bottom: 20px;"><label style="display: block; font-size: 14px; font-weight: 600; color: #fff; margin-bottom: 8px;">Who is your target audience? *</label><textarea id="q_targetAudience" class="form-input" rows="2" required placeholder="Age range, interests, demographics...">${client.questionnaire?.targetAudience || ''}</textarea></div>
<div style="margin-bottom: 20px;"><label style="display: block; font-size: 14px; font-weight: 600; color: #fff; margin-bottom: 8px;">What sets you apart from competitors?</label><textarea id="q_uniqueValue" class="form-input" rows="2" placeholder="Your unique selling proposition...">${client.questionnaire?.uniqueValue || ''}</textarea></div>
<div style="margin-bottom: 20px;"><label style="display: block; font-size: 14px; font-weight: 600; color: #fff; margin-bottom: 8px;">Brand personality / vibe</label>
<select id="q_brandVibe" class="form-input" style="background: #252525; color: #fff; border: 1px solid rgba(255,255,255,0.2);">
<option value="">Select a vibe...</option>
<option value="bold" ${client.questionnaire?.brandVibe === 'bold' ? 'selected' : ''}>Bold & Edgy</option>
<option value="elegant" ${client.questionnaire?.brandVibe === 'elegant' ? 'selected' : ''}>Elegant & Sophisticated</option>
<option value="playful" ${client.questionnaire?.brandVibe === 'playful' ? 'selected' : ''}>Playful & Fun</option>
<option value="minimal" ${client.questionnaire?.brandVibe === 'minimal' ? 'selected' : ''}>Clean & Minimal</option>
<option value="luxury" ${client.questionnaire?.brandVibe === 'luxury' ? 'selected' : ''}>Luxury & Premium</option>
<option value="urban" ${client.questionnaire?.brandVibe === 'urban' ? 'selected' : ''}>Urban & Street</option>
<option value="organic" ${client.questionnaire?.brandVibe === 'organic' ? 'selected' : ''}>Natural & Organic</option>
<option value="tech" ${client.questionnaire?.brandVibe === 'tech' ? 'selected' : ''}>Modern & Tech</option>
</select></div>
<div style="margin-bottom: 20px;"><label style="display: block; font-size: 14px; font-weight: 600; color: #fff; margin-bottom: 8px;">Colors you like or want to avoid</label><input type="text" id="q_colorPrefs" class="form-input" placeholder="e.g., Love red and black, avoid pastels" value="${client.questionnaire?.colorPrefs || ''}"></div>
<div style="margin-bottom: 20px;"><label style="display: block; font-size: 14px; font-weight: 600; color: #fff; margin-bottom: 8px;">Brands you admire (inspiration)</label><input type="text" id="q_inspiration" class="form-input" placeholder="e.g., Nike, Apple, Supreme..." value="${client.questionnaire?.inspiration || ''}"></div>
<div style="margin-bottom: 20px;"><label style="display: block; font-size: 14px; font-weight: 600; color: #fff; margin-bottom: 8px;">Timeline / deadline</label><input type="text" id="q_timeline" class="form-input" placeholder="e.g., Need by March 1st, flexible, ASAP..." value="${client.questionnaire?.timeline || ''}"></div>
<div style="margin-bottom: 20px;"><label style="display: block; font-size: 14px; font-weight: 600; color: #fff; margin-bottom: 8px;">Anything else we should know?</label><textarea id="q_additional" class="form-input" rows="3" placeholder="Other details, preferences, existing assets...">${client.questionnaire?.additional || ''}</textarea></div>
<button type="submit" style="width: 100%; padding: 16px; background: #e11d48; color: #fff; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; font-family: inherit;">${client.questionnaire ? '✅ Update Questionnaire' : '📋 Submit Questionnaire'}</button>
${client.questionnaire ? '<p style="color: #10b981; font-size: 13px; margin-top: 12px; text-align: center;">✅ Questionnaire submitted on ' + new Date(client.questionnaire.submittedAt).toLocaleDateString() + '</p>' : ''}
</form>
</div>
</div>

<!-- PROOFS & APPROVALS SECTION -->
<div id="portalSection-proofs" class="portal-section" style="padding: 32px; display: none;">
<h2 style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">Proofs & Approvals</h2>
<p style="color: #888; margin-bottom: 24px;">Review your design proofs. Approve when you're happy, or request changes.</p>
${(() => {
    const clientProofs = proofs.filter(pr => pr.clientId == client.id && pr.sentToClient);
    if (clientProofs.length === 0) return '<div style="background: #111; border: 1px solid #222; border-radius: 12px; padding: 48px; text-align: center;"><div style="font-size: 48px; margin-bottom: 16px;">✅</div><div style="color: #888; font-size: 16px;">No proofs yet</div><div style="color: #666; font-size: 14px; margin-top: 8px;">Design proofs will appear here when your designer sends them for review.</div></div>';
    const pending = clientProofs.filter(p => p.status === 'pending');
    const approved = clientProofs.filter(p => p.status === 'approved');
    const revision = clientProofs.filter(p => p.status === 'revision');
    const statusIcon = s => s === 'approved' ? '✅' : s === 'pending' ? '⏳' : s === 'revision' ? '🔄' : '📄';
    const statusColor = s => s === 'approved' ? '#10b981' : s === 'pending' ? '#f59e0b' : s === 'revision' ? '#ef4444' : '#888';
    let html = '';
    if (pending.length > 0) {
        html += '<h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: #f59e0b;">⏳ Awaiting Your Review (' + pending.length + ')</h3>';
        html += pending.map(p => '<div style="background: #111; border: 2px solid #f59e0b40; border-radius: 12px; padding: 24px; margin-bottom: 16px;">' +
            '<div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 12px; margin-bottom: 16px;">' +
            '<div><h3 style="font-size: 18px; font-weight: 600; color: #fff; margin-bottom: 4px;">' + (p.title || p.name || p.fileName || 'Design Proof') + '</h3>' +
            '<div style="font-size: 13px; color: #888;">' + (p.category || p.proofType || 'Proof') + ' • v' + (p.version || 1) + ' • Sent ' + new Date(p.sentAt || p.uploadedAt).toLocaleDateString() + '</div></div>' +
            '<span style="padding: 6px 14px; border-radius: 100px; font-size: 12px; font-weight: 600; background: #f59e0b20; color: #f59e0b;">⏳ Pending Review</span></div>' +
            (p.image || p.fileData ? '<div style="background: #0a0a0a; border: 1px solid #222; border-radius: 8px; overflow: hidden; margin-bottom: 16px; max-height: 400px;"><img src="' + (p.image || p.fileData) + '" style="width: 100%; display: block; object-fit: contain; max-height: 400px;" alt="Proof"></div>' : '') +
            (p.notes ? '<div style="background: #0a0a0a; border: 1px solid #222; border-radius: 8px; padding: 16px; margin-bottom: 16px;"><div style="font-size: 12px; color: #888; margin-bottom: 4px;">Designer Notes</div><div style="color: #ccc; font-size: 14px;">' + p.notes + '</div></div>' : '') +
            '<div style="display: flex; gap: 12px;">' +
            '<button onclick="clientRequestProofRevision(' + p.id + ', ' + client.id + ')" style="flex: 1; padding: 14px; background: transparent; border: 1px solid #ef4444; color: #ef4444; border-radius: 8px; cursor: pointer; font-weight: 600; font-family: inherit; font-size: 14px;">🔄 Request Changes</button>' +
            '<button onclick="clientApproveProof(' + p.id + ', ' + client.id + ')" style="flex: 1; padding: 14px; background: #10b981; border: none; color: #fff; border-radius: 8px; cursor: pointer; font-weight: 600; font-family: inherit; font-size: 14px;">✅ Approve</button>' +
            '</div></div>').join('');
    }
    if (approved.length > 0) {
        html += '<h3 style="font-size: 16px; font-weight: 600; margin: 24px 0 16px; color: #10b981;">✅ Approved (' + approved.length + ')</h3>';
        html += approved.map(p => '<div style="background: #111; border: 1px solid #10b98130; border-radius: 12px; padding: 20px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;"><div><div style="font-weight: 600; color: #fff;">' + (p.title || p.name || p.fileName || 'Design Proof') + '</div><div style="font-size: 13px; color: #888; margin-top: 4px;">' + (p.category || '') + ' • Approved ' + (p.approvedAt ? new Date(p.approvedAt).toLocaleDateString() : '') + '</div></div><span style="padding: 6px 14px; border-radius: 100px; font-size: 12px; font-weight: 600; background: #10b98120; color: #10b981;">✅ Approved</span></div>').join('');
    }
    if (revision.length > 0) {
        html += '<h3 style="font-size: 16px; font-weight: 600; margin: 24px 0 16px; color: #ef4444;">🔄 Revision In Progress (' + revision.length + ')</h3>';
        html += revision.map(p => '<div style="background: #111; border: 1px solid #ef444430; border-radius: 12px; padding: 20px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;"><div><div style="font-weight: 600; color: #fff;">' + (p.title || p.name || p.fileName || 'Design Proof') + '</div><div style="font-size: 13px; color: #888; margin-top: 4px;">Revision #' + (p.revisionCount || 1) + ' • Designer is working on changes</div></div><span style="padding: 6px 14px; border-radius: 100px; font-size: 12px; font-weight: 600; background: #ef444420; color: #ef4444;">🔄 Revising</span></div>').join('');
    }
    return html;
})()}
</div>

<!-- FAQ SECTION -->
<div id="portalSection-faq" class="portal-section" style="padding: 32px; display: none;">
<h2 style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">Frequently Asked Questions</h2>
<p style="color: #888; margin-bottom: 24px;">Common questions about your project and working with NUI.</p>
<div style="max-width: 700px;">
${[
    { q: "How long does my branding project take?", a: "Brand Kit projects typically take 7–10 business days. Service Brand Identity is 10–14 days, and Product Brand Identity is 14–21 days. Your specific timeline is in your order details." },
    { q: "How do I approve or request changes to my designs?", a: "Go to the <strong>Proofs</strong> tab in your portal. When a proof is ready, you will see Approve and Request Changes buttons. You will also get an email notification when new proofs are available." },
    { q: "How many revisions do I get?", a: "All packages include 2 rounds of revisions. Additional revision rounds can be added for $150 each. We want you to be 100% happy with the final result." },
    { q: "When can I download my final files?", a: "Final files become available in the <strong>Brand Portal</strong> tab after your proofs are approved and payment is complete. You will get all formats: PNG, SVG, PDF, and more." },
    { q: "What file formats will I receive?", a: "You will receive your logo in PNG (transparent + white background), SVG (scalable vector), PDF, and AI/EPS source files. Brand guidelines come as a professional PDF document." },
    { q: "How do I contact my designer?", a: "Click the <strong>Contact Your Designer</strong> button on your Dashboard. You can also reply to any email from us, or call (248) 487-8747 during business hours." },
    { q: "What are your business hours?", a: "We are available Monday–Thursday 1:00 PM – 4:00 PM EST for calls. Fridays are reserved for design work. Email support is available 24/7 and we respond within 1 business day." },
    { q: "Can I add more services to my project?", a: "Absolutely! Contact us through your portal or call (248) 487-8747 to discuss adding services like social media templates, business cards, packaging design, or web design." },
    { q: "What is included in my brand guidelines?", a: "Your brand guidelines document includes: logo usage rules, color palette with hex/RGB/CMYK codes, typography specifications, brand voice guidelines, and dos and donts for brand consistency." },
    { q: "How does payment work?", a: "We offer flexible payment options: pay in full (5% discount), 50/25/25 split, or 3 monthly payments. View your invoices and make payments in the <strong>Orders &amp; Invoices</strong> tab." }
].map(function(faq, i) { return '<div style="background: #111; border: 1px solid #222; border-radius: 12px; margin-bottom: 8px; overflow: hidden;"><button onclick="this.parentElement.classList.toggle(\'faq-open\'); var sp=this.querySelectorAll(\'span\'); if(sp.length>1) sp[1].textContent=this.parentElement.classList.contains(\'faq-open\') ? String.fromCharCode(8722) : \'+\';" style="width: 100%; padding: 20px 24px; background: none; border: none; color: #fff; font-size: 15px; font-weight: 600; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-family: inherit;"><span style="flex:1;">' + faq.q + '</span><span style="color: #e11d48; font-size: 20px; margin-left: 16px;">+</span></button><div style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease; padding: 0 24px;"><div style="padding: 0 0 20px 0; color: #aaa; font-size: 14px; line-height: 1.7;">' + faq.a + '</div></div></div>'; }).join("")}
</div>
<style>.faq-open > div:last-child { max-height: 300px !important; }</style>
<div style="background: #111; border: 1px solid #222; border-radius: 12px; padding: 24px; margin-top: 24px; max-width: 700px; text-align: center;">
<p style="color: #888; font-size: 14px; margin-bottom: 12px;">Still have questions?</p>
<div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
<button onclick="openClientMessageDesigner(${client.id})" style="padding: 12px 24px; background: #e11d48; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-family: inherit;">💬 Message Us</button>
<a href="tel:2484878747" style="padding: 12px 24px; background: transparent; border: 1px solid #333; color: #fff; border-radius: 8px; text-decoration: none; font-weight: 600; display: inline-block;">📞 (248) 487-8747</a>
</div>
</div>
</div>

<!-- BRAND PORTAL SECTION (existing content) -->
<div id="portalSection-brand" class="portal-section" style="display: none;">

<style>
            /* PORTFOLIO-STYLE BRAND GUIDE CSS */
            .brand-portal-case { background: #080808; border-radius: 8px; overflow: hidden; }
            .brand-portal-tabs { display: flex; border-bottom: 1px solid rgba(255,255,255,0.06); padding: 0 40px; background: rgba(0,0,0,0.5); }
            .brand-portal-tab { padding: 16px 28px; font-size: 11px; font-weight: 700; color: rgba(255,255,255,0.35); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.3s; text-transform: uppercase; letter-spacing: 2px; }
            .brand-portal-tab:hover { color: rgba(255,255,255,0.6); }
            .brand-portal-tab.active { color: #fff; border-color: ${client.colors[0]}; }
            .brand-portal-panel { display: none; animation: fadeIn 0.4s ease; }
            .brand-portal-panel.active { display: block; }
            .brand-section { margin-bottom: 56px; }
            .brand-section-title { font-size: 11px; color: ${client.colors[0]}; text-transform: uppercase; letter-spacing: 3px; font-weight: 700; margin-bottom: 32px; display: flex; align-items: center; gap: 12px; }
            .brand-section-title::after { content: ''; flex: 1; height: 1px; background: linear-gradient(90deg, ${client.colors[0]}50, transparent); }
            .logo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
            .logo-box { background: #080808; border: 1px solid rgba(255,255,255,0.06); border-radius: 6px; padding: 0; text-align: center; transition: all 0.3s; aspect-ratio: 4/3; display: flex; flex-direction: column; overflow: hidden; position: relative; }
            .logo-box:hover { border-color: rgba(255,255,255,0.12); transform: scale(1.01); }
            .logo-box-label { font-size: 10px; color: rgba(255,255,255,0.4); text-transform: uppercase; letter-spacing: 2px; padding: 12px 16px; background: rgba(0,0,0,0.9); font-weight: 600; position: absolute; bottom: 0; left: 0; right: 0; z-index: 2; }
            .logo-box-img { flex: 1; display: flex; align-items: center; justify-content: center; padding: 0; position: relative; background: #080808; }
            .logo-box-img img { width: 100%; height: 100%; object-fit: contain; padding: 20px; }
            .logo-placeholder { width: 100%; height: 100%; background: #080808; display: flex; align-items: center; justify-content: center; color: rgba(255,255,255,0.1); font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
            .color-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
            .color-box { aspect-ratio: 1; border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; padding: 12px; position: relative; overflow: hidden; }
            .color-box::before { content: ''; position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.7), transparent); }
            .color-hex { position: relative; font-size: 11px; font-weight: 700; color: #fff; letter-spacing: 1px; }
            .font-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
            .font-box { background: #fff; border: 1px solid rgba(0,0,0,0.08); border-radius: 8px; padding: 32px; }
            .font-label { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 16px; }
            .font-name { font-size: 36px; font-weight: 700; margin-bottom: 8px; color: #000; }
            .font-sample { color: #333; font-size: 14px; line-height: 1.6; }
            .mockup-grid { display: flex; flex-direction: column; gap: 16px; }
            .mockup-row { display: grid; gap: 16px; }
            .mockup-row.full { grid-template-columns: 1fr; }
            .mockup-row.split { grid-template-columns: 1fr 1fr; }
            .mockup-box { background: #080808; border: 1px solid rgba(255,255,255,0.06); border-radius: 6px; overflow: hidden; position: relative; transition: all 0.3s ease; }
            .mockup-box.wide { aspect-ratio: 16/9; }
            .mockup-box.tall { aspect-ratio: 4/5; }
            .mockup-box:hover { transform: scale(1.01); border-color: rgba(255,255,255,0.12); }
            .mockup-box img, .mockup-box video { width: 100%; height: 100%; object-fit: cover; }
            .mockup-placeholder { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: rgba(255,255,255,0.12); font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 2px; gap: 10px; background: #080808; }
            .mockup-placeholder::before { content: '+'; width: 32px; height: 32px; border: 1px solid rgba(255,255,255,0.08); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 18px; color: rgba(255,255,255,0.1); }
            .results-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
            .result-card { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 48px 32px; text-align: center; position: relative; overflow: hidden; }
            .result-number { font-size: 64px; font-weight: 900; position: relative; color: ${client.colors[0]}; }
            .result-label { font-size: 11px; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 3px; margin-top: 12px; position: relative; }
            .website-preview { border-radius: 8px; overflow: hidden; border: 1px solid rgba(255,255,255,0.08); }
            .website-preview img { width: 100%; display: block; }
            .testimonial-box { background: rgba(0,0,0,0.3); border-left: 3px solid ${client.colors[0]}; padding: 48px; border-radius: 0 8px 8px 0; }
            .testimonial-box p { font-size: 22px; font-style: italic; line-height: 1.7; margin-bottom: 32px; font-weight: 300; }
            .testimonial-author { display: flex; align-items: center; gap: 20px; }
            .testimonial-avatar { width: 48px; height: 48px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 700; background: ${client.colors[0]}; }
            .proof-approval-bar { background: #111; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 24px; margin: 24px 48px; }
            .proof-status-badge { display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 100px; font-size: 12px; font-weight: 600; }
            .download-section { background: #0a0a0a; padding: 48px; border-top: 1px solid rgba(255,255,255,0.06); }
            .download-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
            .download-card { background: #1a1a1a; padding: 24px; border-radius: 12px; display: flex; flex-direction: column; justify-content: space-between; min-height: 160px; transition: transform 0.2s; }
            .download-card:hover { transform: translateY(-4px); }
            .download-card h4 { font-size: 16px; font-weight: 600; margin-bottom: 8px; }
            .download-card p { font-size: 13px; color: #888; }
            .download-btn { display: inline-flex; align-items: center; gap: 8px; padding: 12px 0; font-weight: 600; color: #fff; cursor: pointer; border-bottom: 2px solid #fff; transition: gap 0.2s; background: none; border-top: none; border-left: none; border-right: none; font-family: inherit; }
            .download-btn:hover { gap: 14px; }
            .download-btn:disabled { opacity: 0.5; cursor: not-allowed; }
            @media (max-width: 768px) {
                .brand-portal-tabs { padding: 0 16px; flex-wrap: wrap; }
                .brand-portal-tab { padding: 12px 14px; font-size: 9px; }
                .logo-grid { grid-template-columns: 1fr !important; }
                .color-grid { grid-template-columns: repeat(2, 1fr) !important; }
                .font-grid { grid-template-columns: 1fr !important; }
                .mockup-row.split { grid-template-columns: 1fr; }
                .results-grid { grid-template-columns: 1fr !important; }
                .download-grid { grid-template-columns: 1fr !important; }
                .proof-approval-bar { margin: 24px 16px; }
            }
</style>

        <!-- BRAND HERO BANNER (Portfolio Style) -->
<div class="brand-hero" style="width: 100%; min-height: 360px; background: linear-gradient(145deg, ${client.colors[1] || client.colors[0]} 0%, #050505 100%); position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; padding: 60px 40px;">
<div style="position: absolute; inset: 0; background: url('${logos[0]?.data || ''}') center/cover; opacity: 0.15;"></div>
<div style="position: absolute; inset: 0; background: linear-gradient(to bottom, transparent 0%, rgba(0,0,0,0.7) 100%);"></div>
<div style="position: relative; text-align: center; z-index: 1; max-width: 100%;">
<div style="font-size: 11px; text-transform: uppercase; letter-spacing: 4px; color: ${client.colors[0]}; margin-bottom: 16px; font-weight: 600;">${client.industry || 'Brand Identity'}</div>
<h2 style="font-size: clamp(32px, 7vw, 80px); font-weight: 900; text-transform: uppercase; letter-spacing: -2px; line-height: 1; color: #fff;">${client.name}</h2>
<p style="color: rgba(255,255,255,0.5); font-size: 15px; margin-top: 20px; max-width: 550px; margin-left: auto; margin-right: auto; line-height: 1.6;">Complete Brand Identity & Digital Presence</p>
</div>
<div style="position: absolute; bottom: 24px; left: 50%; transform: translateX(-50%); display: flex; gap: 6px;">
                ${client.colors.map(c => '<div style="width: 28px; height: 28px; border-radius: 4px; background: ' + c + '; border: 1px solid rgba(255,255,255,0.15);"></div>').join('')}
</div>
</div>

        <!-- MOODBOARD SECTION (for clients) -->
        ${currentUser?.type !== 'admin' ? (() => {
            const moodboards = proofs.filter(p => p.type === 'moodboard' && p.clientId == client.id && p.sentToClient);
            if (moodboards.length === 0) return '';
            const moodboard = moodboards[moodboards.length - 1]; // Latest moodboard
            const statusColors = {
                'approved': { bg: '#10b98120', color: '#10b981', icon: '✓', label: 'Approved' },
                'pending': { bg: '#f59e0b20', color: '#f59e0b', icon: '⏳', label: 'Pending Review' },
                'revision': { bg: '#ef444420', color: '#ef4444', icon: '↻', label: 'Revision Requested' },
                'draft': { bg: '#33333350', color: '#888', icon: '📝', label: 'Draft' }
            };
            const statusInfo = statusColors[moodboard.status] || statusColors.draft;
            return `
<div style="background: #111; border: 1px solid rgba(255,255,255,0.06); border-radius: 16px; padding: 24px; margin: 0 48px 32px 48px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
<h3 style="font-size: 18px; font-weight: 600; color: #fff; margin: 0;">🎨 Creative Direction — Moodboard</h3>
<div class="proof-status-badge" style="background: ${statusInfo.bg}; color: ${statusInfo.color}; display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 100px; font-size: 12px; font-weight: 600;">
<span>${statusInfo.icon}</span>
                        ${statusInfo.label}
</div>
</div>
                ${moodboard.notes ? `<p style="color: rgba(255,255,255,0.6); margin: 0 0 20px 0; font-size: 14px; line-height: 1.6;">${moodboard.notes}</p>` : ''}
<div style="background: #0a0a0a; border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 24px; margin-bottom: 20px; position: relative; min-height: 400px; overflow: hidden;">
<div style="position: absolute; inset: 0; ${moodboard.canvasBackground ? 'background: ' + moodboard.canvasBackground : 'background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%)'};"></div>
<div style="position: relative; width: 100%; height: 100%; min-height: 400px;">
                        ${renderMoodboardItems(moodboard)}
</div>
</div>
                ${moodboard.status === 'pending' ? `
<div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
<button onclick="requestMoodboardChanges(${client.id}, ${moodboard.id})" style="background: transparent; border: 1px solid #ef4444; color: #ef4444; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-family: inherit;">↻ Request Changes</button>
<button onclick="approveMoodboard(${client.id}, ${moodboard.id})" style="background: #10b981; border: none; color: #fff; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-family: inherit;">✓ Approve Moodboard</button>
</div>
                ` : ''}
                ${moodboard.comments && moodboard.comments.length > 0 ? `
<div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
<div style="font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;">Feedback History</div>
                    ${moodboard.comments.slice(-3).map(c => '<div style="background: #0a0a0a; padding: 12px 16px; border-radius: 8px; margin-bottom: 8px;"><div style="font-size: 12px; color: #888; margin-bottom: 4px;">' + new Date(c.timestamp).toLocaleDateString() + ' - ' + (c.author || 'Designer') + '</div><div style="font-size: 14px; color: rgba(255,255,255,0.7);">' + c.text + '</div></div>').join('')}
</div>
                ` : ''}
</div>
            `;
        })() : ''}

        <!-- PROOF APPROVAL BAR (for clients) -->
        ${currentUser?.type !== 'admin' ? `
<div class="proof-approval-bar">
<div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
<div>
<div style="font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Proof Status</div>
<div class="proof-status-badge" style="background: ${brandGuide.status === 'approved' ? '#10b98120' : brandGuide.status === 'pending' ? '#f59e0b20' : brandGuide.status === 'revision_requested' ? '#ef444420' : '#33333350'}; color: ${brandGuide.status === 'approved' ? '#10b981' : brandGuide.status === 'pending' ? '#f59e0b' : brandGuide.status === 'revision_requested' ? '#ef4444' : '#888'};">
<span>${brandGuide.status === 'approved' ? '✓' : brandGuide.status === 'pending' ? '⏳' : brandGuide.status === 'revision_requested' ? '↻' : '📝'}</span>
                        ${brandGuide.status === 'approved' ? 'Approved' : brandGuide.status === 'pending' ? 'Pending Review' : brandGuide.status === 'revision_requested' ? 'Revision Requested' : 'Draft'}
</div>
</div>
                ${brandGuide.status === 'pending' ? `
<div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
<button onclick="showRevisionModal(${client.id})" style="background: transparent; border: 1px solid #ef4444; color: #ef4444; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-family: inherit;">↻ Request Revision</button>
<button onclick="approveClientBrandProof(${client.id})" style="background: #10b981; border: none; color: #fff; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-family: inherit;">✓ Approve Proof</button>
</div>
                ` : brandGuide.status === 'approved' ? `
<div style="color: #10b981; font-weight: 600;">
                    ${isPaid ? '✓ Your brand assets are ready for download below!' : '⚠️ Complete payment to download your brand assets'}
</div>
                ` : ''}
</div>
            ${brandGuide.proofComments?.length > 0 ? `
<div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
<div style="font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;">Revision History</div>
                ${brandGuide.proofComments.slice(-3).map(c => '<div style="background: #0a0a0a; padding: 12px 16px; border-radius: 8px; margin-bottom: 8px;"><div style="font-size: 12px; color: #888; margin-bottom: 4px;">' + new Date(c.date).toLocaleDateString() + ' - ' + c.type + '</div><div style="font-size: 14px;">' + c.comment + '</div></div>').join('')}
</div>
            ` : ''}
</div>
        ` : ''}

        <!-- PORTFOLIO-STYLE TABS -->
<div class="brand-portal-case">
<div class="brand-portal-tabs">
<div class="brand-portal-tab active" onclick="switchBrandPortalTab(0, this)">Brand Guide</div>
<div class="brand-portal-tab" onclick="switchBrandPortalTab(1, this)">Website / Webapp</div>
<div class="brand-portal-tab" onclick="switchBrandPortalTab(2, this)">Results</div>
<div class="brand-portal-tab" onclick="switchBrandPortalTab(3, this)">Downloads</div>
</div>

            <!-- PANEL 0: BRAND GUIDE -->
<div class="brand-portal-panel active" data-panel="0" style="padding: 48px; background: linear-gradient(180deg, transparent 0%, ${client.colors[1] || client.colors[0]}10 100%);">

                <!-- BRAND VOICE (Slogan & Mission) -->
                ${(client.slogan || client.mission) ? `
<div class="brand-section">
<div class="brand-section-title">Brand Voice</div>
<div style="display: grid; grid-template-columns: ${client.slogan && client.mission ? '1fr 1fr' : '1fr'}; gap: 20px;">
                        ${client.slogan ? '<div style="background: #080808; border: 1px solid rgba(255,255,255,0.06); border-radius: 6px; padding: 32px;"><div style="font-size: 10px; color: ' + client.colors[0] + '; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 16px; font-weight: 600;">Slogan</div><div style="font-size: 24px; font-weight: 700; line-height: 1.3; color: #fff;">"' + client.slogan + '"</div></div>' : ''}
                        ${client.mission ? '<div style="background: #080808; border: 1px solid rgba(255,255,255,0.06); border-radius: 6px; padding: 32px;"><div style="font-size: 10px; color: ' + client.colors[0] + '; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 16px; font-weight: 600;">Mission Statement</div><div style="font-size: 16px; line-height: 1.7; color: rgba(255,255,255,0.7);">' + client.mission + '</div></div>' : ''}
</div>
</div>
                ` : ''}

                <!-- LOGO SYSTEM (3-Column Grid) -->
<div class="brand-section">
<div class="brand-section-title">Logo System</div>
<div class="logo-grid">
<div class="logo-box" style="border-color: ${client.colors[0]}20;">
<div class="logo-box-img">${logos[0]?.data ? '<img loading="lazy" src="' + logos[0].data + '" alt="Primary Logo">' : '<div class="logo-placeholder">No Logo</div>'}</div>
<div class="logo-box-label">Primary Logo</div>
</div>
<div class="logo-box" style="border-color: ${client.colors[0]}20;">
<div class="logo-box-img">${logos[1]?.data ? '<img loading="lazy" src="' + logos[1].data + '" alt="Secondary Logo">' : '<div class="logo-placeholder">No Logo</div>'}</div>
<div class="logo-box-label">Secondary Logo</div>
</div>
<div class="logo-box" style="border-color: ${client.colors[0]}20;">
<div class="logo-box-img">${logos[2]?.data ? '<img loading="lazy" src="' + logos[2].data + '" alt="Icon Mark">' : '<div class="logo-placeholder">No Icon</div>'}</div>
<div class="logo-box-label">Icon / Logo Mark</div>
</div>
</div>
</div>

                <!-- COLOR PALETTE (4-Column Grid) -->
<div class="brand-section">
<div class="brand-section-title">Color Palette</div>
<div class="color-grid">
                        ${client.colors.map((c, idx) => '<div class="color-box" style="background: ' + c + ';"><div class="color-hex">' + c.toUpperCase() + '</div></div>').join('')}
                        ${client.colors.length < 4 ? Array(4 - client.colors.length).fill('<div class="color-box" style="background: #1a1a1a;"><div class="color-hex">—</div></div>').join('') : ''}
</div>
</div>

                <!-- FONT SYSTEM (2-Column Grid) -->
<div class="brand-section">
<div class="brand-section-title">Font System</div>
<div class="font-grid">
<div class="font-box">
<div class="font-label">Heading Font</div>
<div class="font-name" style="font-family: '${client.fonts?.heading || 'Inter'}', sans-serif;">${client.fonts?.heading || 'Inter'}</div>
<div class="font-sample">ABCDEFGHIJKLMNOPQRSTUVWXYZ<br>abcdefghijklmnopqrstuvwxyz<br>0123456789</div>
</div>
<div class="font-box">
<div class="font-label">Body Font</div>
<div class="font-name" style="font-family: '${client.fonts?.body || 'Inter'}', sans-serif;">${client.fonts?.body || 'Inter'}</div>
<div class="font-sample" style="font-family: '${client.fonts?.body || 'Inter'}', sans-serif;">The quick brown fox jumps over the lazy dog. Pack my box with five dozen liquor jugs.</div>
</div>
</div>
</div>

                <!-- BRAND MOCKUPS (Portfolio Layout: 16:9, two 4:5, 16:9) -->
<div class="brand-section">
<div class="brand-section-title">Brand Mockups</div>
<div class="mockup-grid">
                        <!-- Top 16:9 -->
<div class="mockup-row full">
<div class="mockup-box wide" style="border-color: ${client.colors[0]}15;">
                                ${mockups[0]?.data ? '<img loading="lazy" src="' + mockups[0].data + '" alt="Mockup">' : '<div class="mockup-placeholder">Image / Video</div>'}
</div>
</div>
                        <!-- Middle two 4:5 -->
<div class="mockup-row split">
<div class="mockup-box tall" style="border-color: ${client.colors[0]}15;">
                                ${mockups[1]?.data ? '<img loading="lazy" src="' + mockups[1].data + '" alt="Mockup">' : '<div class="mockup-placeholder">Image / Video</div>'}
</div>
<div class="mockup-box tall" style="border-color: ${client.colors[0]}15;">
                                ${mockups[2]?.data ? '<img loading="lazy" src="' + mockups[2].data + '" alt="Mockup">' : '<div class="mockup-placeholder">Image / Video</div>'}
</div>
</div>
                        <!-- Bottom 16:9 -->
<div class="mockup-row full">
<div class="mockup-box wide" style="border-color: ${client.colors[0]}15;">
                                ${mockups[3]?.data ? '<img loading="lazy" src="' + mockups[3].data + '" alt="Mockup">' : '<div class="mockup-placeholder">Image / Video</div>'}
</div>
</div>
</div>
</div>
</div>

            <!-- PANEL 1: WEBSITE / WEBAPP -->
<div class="brand-portal-panel" data-panel="1" style="padding: 48px; background: linear-gradient(180deg, transparent 0%, ${client.colors[1] || client.colors[0]}10 100%);">
<div class="website-preview" style="border-color: ${client.colors[0]}20; position: relative; margin-bottom: 32px;">
<img loading="lazy" src="${client.websiteScreenshot || logos[0]?.data || ''}" alt="${client.name} Website" style="width: 100%; height: 500px; object-fit: cover; background: #0a0a0a;">
                    ${client.websiteUrl ? '<a href="' + client.websiteUrl + '" target="_blank" style="position: absolute; bottom: 24px; right: 24px; background: ' + client.colors[0] + '; color: #fff; padding: 14px 28px; border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 8px; transition: transform 0.2s;">Visit Site <span style="font-size: 18px;">→</span></a>' : ''}
</div>
<div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
<p style="color: rgba(255,255,255,0.6); line-height: 1.8; font-size: 16px; flex: 1; min-width: 280px;">A fully responsive, high-converting website designed to capture the essence of ${client.name}. The platform features custom functionality, seamless navigation, and is optimized for both desktop and mobile users.</p>
                    ${client.websiteUrl ? '<a href="' + client.websiteUrl + '" target="_blank" style="background: transparent; border: 1px solid ' + client.colors[0] + '; color: ' + client.colors[0] + '; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 13px; white-space: nowrap;">' + (client.websiteUrl.replace('https://', '').replace('http://', '')) + '</a>' : ''}
</div>
                <!-- Web Mockups Grid -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 32px;">
<div style="aspect-ratio: 4/5; background: #080808; border: 1px solid rgba(255,255,255,0.06); border-radius: 6px; overflow: hidden; display: flex; align-items: center; justify-content: center;">
                        ${client.webMockups?.[0] ? '<img loading="lazy" src="' + client.webMockups[0] + '" alt="Web Mockup" style="width:100%;height:100%;object-fit:cover;">' : '<div style="color: rgba(255,255,255,0.12); font-size: 14px;">Image / Video</div>'}
</div>
<div style="aspect-ratio: 4/5; background: #080808; border: 1px solid rgba(255,255,255,0.06); border-radius: 6px; overflow: hidden; display: flex; align-items: center; justify-content: center;">
                        ${client.webMockups?.[1] ? '<img loading="lazy" src="' + client.webMockups[1] + '" alt="Web Mockup" style="width:100%;height:100%;object-fit:cover;">' : '<div style="color: rgba(255,255,255,0.12); font-size: 14px;">Image / Video</div>'}
</div>
</div>
</div>

            <!-- PANEL 2: RESULTS -->
<div class="brand-portal-panel" data-panel="2" style="padding: 48px; background: linear-gradient(180deg, transparent 0%, ${client.colors[1] || client.colors[0]}10 100%);">
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 48px;">
<div style="background: #080808; border: 1px solid rgba(255,255,255,0.06); border-radius: 6px; padding: 32px;">
<div style="font-size: 12px; text-transform: uppercase; letter-spacing: 2px; color: ${client.colors[0]}; margin-bottom: 16px; font-weight: 600;">Challenge</div>
<p style="color: rgba(255,255,255,0.6); line-height: 1.8; font-size: 15px; margin: 0;">${client.problem || 'The client needed a complete brand transformation to better connect with their target audience and stand out in a competitive market.'}</p>
</div>
<div style="background: #080808; border: 1px solid rgba(255,255,255,0.06); border-radius: 6px; padding: 32px;">
<div style="font-size: 12px; text-transform: uppercase; letter-spacing: 2px; color: ${client.colors[0]}; margin-bottom: 16px; font-weight: 600;">Solution</div>
<p style="color: rgba(255,255,255,0.6); line-height: 1.8; font-size: 15px; margin: 0;">${client.solution || 'We developed a comprehensive brand strategy with modern visual identity, responsive web platform, and targeted digital marketing campaigns.'}</p>
</div>
</div>
<div style="font-size: 12px; text-transform: uppercase; letter-spacing: 2px; color: ${client.colors[0]}; margin-bottom: 24px; font-weight: 600;">Results</div>
<div class="results-grid">
<div class="result-card"><div class="result-number">${client.results?.revenue || '+45%'}</div><div class="result-label">Revenue Growth</div></div>
<div class="result-card"><div class="result-number">${client.results?.traffic || '+120%'}</div><div class="result-label">Web Traffic</div></div>
<div class="result-card"><div class="result-number">${client.results?.engagement || '+85%'}</div><div class="result-label">Engagement</div></div>
</div>
                ${client.testimonial ? `
<div style="margin-top: 48px;">
<div class="testimonial-box">
<p>"${client.testimonial.text || 'Working with NUI transformed our brand completely. The attention to detail and creative vision exceeded our expectations.'}"</p>
<div class="testimonial-author">
<div class="testimonial-avatar">${(client.testimonial.author || client.name).charAt(0)}</div>
<div>
<div style="font-weight: 700;">${client.testimonial.author || client.contact || 'Client'}</div>
<div style="color: rgba(255,255,255,0.5); font-size: 14px;">${client.testimonial.title || 'Owner'}, ${client.name}</div>
</div>
</div>
</div>
</div>
                ` : ''}
</div>

            <!-- PANEL 3: DOWNLOADS -->
<div class="brand-portal-panel" data-panel="3" style="padding: 48px; background: linear-gradient(180deg, transparent 0%, ${client.colors[1] || client.colors[0]}10 100%);">
                ${!isPaid && brandGuide.status !== 'approved' ? `
<div style="background: #1a0a0a; border: 1px solid #ef4444; border-radius: 12px; padding: 32px; text-align: center; margin-bottom: 32px;">
<div style="font-size: 48px; margin-bottom: 16px;">🔒</div>
<h3 style="font-size: 20px; font-weight: 700; margin-bottom: 8px;">Downloads Locked</h3>
<p style="color: #888; margin-bottom: 24px;">Please approve your brand proofs and complete payment to unlock downloads.</p>
</div>
                ` : ''}
<div class="brand-section-title">Available Downloads</div>
<div class="download-grid">
                    ${logos.length > 0 ? '<div class="download-card" style="background: linear-gradient(135deg, ' + client.colors[0] + ', ' + (client.colors[1] || client.colors[0]) + ');"><div><h4>Logo Pack</h4><p>' + logos.length + ' logo file(s)</p></div><button class="download-btn" onclick="downloadAsset(' + client.id + ', \'logos\', 0)" ' + (!isPaid ? 'disabled' : '') + '>Download ↓</button></div>' : ''}
                    ${mockups.length > 0 ? '<div class="download-card" style="background: #2563eb;"><div><h4>Brand Mockups</h4><p>' + mockups.length + ' mockup(s)</p></div><button class="download-btn" onclick="downloadAsset(' + client.id + ', \'mockups\', 0)" ' + (!isPaid ? 'disabled' : '') + '>Download ↓</button></div>' : ''}
                    ${videos.length > 0 ? '<div class="download-card" style="background: #dc2626;"><div><h4>Brand Video</h4><p>' + (videos[0]?.size || '1 video') + '</p></div><button class="download-btn" onclick="downloadAsset(' + client.id + ', \'video\', 0)" ' + (!isPaid ? 'disabled' : '') + '>Download ↓</button></div>' : ''}
                    ${social.length > 0 ? '<div class="download-card" style="background: linear-gradient(135deg, #7c3aed, #a855f7);"><div><h4>Social Templates</h4><p>' + social.length + ' template(s)</p></div><button class="download-btn" onclick="downloadAsset(' + client.id + ', \'social\', 0)" ' + (!isPaid ? 'disabled' : '') + '>Download ↓</button></div>' : ''}
                    ${banners.length > 0 ? '<div class="download-card" style="background: #0891b2;"><div><h4>Banners</h4><p>' + banners.length + ' banner(s)</p></div><button class="download-btn" onclick="downloadAsset(' + client.id + ', \'banner\', 0)" ' + (!isPaid ? 'disabled' : '') + '>Download ↓</button></div>' : ''}
<div class="download-card" style="background: linear-gradient(135deg, ${client.colors[0]}, ${client.colors[1] || client.colors[0]});"><div><h4>Color Palette</h4><p>${client.colors.join(' • ')}</p></div><button class="download-btn" onclick="copyColors('${client.colors.join(',')}')">Copy Colors 📋</button></div>
</div>
</div>
</div>

        <!-- FOOTER -->
<section style="padding: 48px; background: #000; text-align: center; border-top: 1px solid #222;">
<div style="font-size: 28px; font-weight: 700; margin-bottom: 12px; color: #fff;">${client.name}</div>
<p style="color: #666; font-size: 14px;">Brand Guidelines • ${new Date().getFullYear()}</p>
<p style="color: #333; font-size: 12px; margin-top: 32px;">Powered by NUI Brand Portal</p>
<button onclick="backToAdmin()" style="margin-top: 24px; padding: 12px 24px; background: transparent; border: 1px solid #333; color: #fff; cursor: pointer; border-radius: 4px; font-family: inherit;">← Back</button>
</section>
</div><!-- /portalSection-brand -->
    `;
}

// Note: checkClientPaymentStatus is defined later in the file (line ~12356) with more comprehensive checking

// Switch brand portal tabs
function switchBrandPortalTab(panelIndex, tabEl) {
    const tabs = document.querySelectorAll('.brand-portal-tab');
    tabs.forEach(t => t.classList.remove('active'));
    tabEl.classList.add('active');
    const panels = document.querySelectorAll('.brand-portal-panel');
    panels.forEach(p => p.classList.remove('active'));
    panels[panelIndex].classList.add('active');
}

// Switch main portal sections (Dashboard, Brand, Orders, Info, Questionnaire)
function switchPortalSection(section, clientId) {
    document.querySelectorAll('.portal-section').forEach(s => s.style.display = 'none');
    document.querySelectorAll('.portal-main-tab').forEach(t => { t.style.borderBottomColor = 'transparent'; t.style.color = '#888'; });
    const target = document.getElementById('portalSection-' + section);
    if (target) target.style.display = section === 'brand' ? 'block' : 'block';
    const activeTab = document.querySelector('.portal-main-tab[data-tab="' + section + '"]');
    if (activeTab) { activeTab.style.borderBottomColor = '#e11d48'; activeTab.style.color = '#fff'; }
}

// Submit client questionnaire from portal
function submitClientQuestionnaire(e, clientId) {
    e.preventDefault();
    const client = clients.find(c => c.id === clientId);
    if (!client) return;
    client.questionnaire = {
        businessDesc: document.getElementById('q_businessDesc')?.value || '',
        targetAudience: document.getElementById('q_targetAudience')?.value || '',
        uniqueValue: document.getElementById('q_uniqueValue')?.value || '',
        brandVibe: document.getElementById('q_brandVibe')?.value || '',
        colorPrefs: document.getElementById('q_colorPrefs')?.value || '',
        inspiration: document.getElementById('q_inspiration')?.value || '',
        timeline: document.getElementById('q_timeline')?.value || '',
        additional: document.getElementById('q_additional')?.value || '',
        submittedAt: new Date().toISOString()
    };
    saveClients();
    alert('✅ Questionnaire submitted! We\'ll use this to tailor your brand experience.');
    showClientPortal(client);
}

// Show revision modal for proof feedback
function showRevisionModal(clientId) {
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999; padding: 20px;';
    modal.innerHTML = `
<div style="background: #111; border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 32px; max-width: 500px; width: 100%;">
<h3 style="font-size: 20px; font-weight: 700; margin-bottom: 8px; color: #fff;">Request Revision</h3>
<p style="color: #888; margin-bottom: 24px;">Please describe what changes you'd like to see.</p>
<textarea id="revisionComment" placeholder="Describe the changes needed..." style="width: 100%; min-height: 120px; padding: 16px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; font-family: inherit; font-size: 14px; resize: vertical;"></textarea>
<div style="display: flex; gap: 12px; margin-top: 24px;">
<button onclick="this.closest('div[style*=fixed]').remove()" style="flex: 1; padding: 14px; background: transparent; border: 1px solid #333; color: #fff; border-radius: 8px; cursor: pointer; font-weight: 600; font-family: inherit;">Cancel</button>
<button onclick="submitRevision(${clientId})" style="flex: 1; padding: 14px; background: #ef4444; border: none; color: #fff; border-radius: 8px; cursor: pointer; font-weight: 600; font-family: inherit;">Submit Revision</button>
</div>
</div>
    `;
    document.body.appendChild(modal);
}

// Submit revision request
function submitRevision(clientId) {
    const comment = document.getElementById('revisionComment').value.trim();
    if (!comment) { alert('Please enter your revision comments'); return; }

    const client = clients.find(c => c.id === clientId);
    if (!client.brandGuide) client.brandGuide = { status: 'draft', proofComments: [] };
    client.brandGuide.status = 'revision_requested';
    client.brandGuide.proofComments.push({ type: 'Revision Requested', comment: comment, date: new Date().toISOString() });
    saveClients();

    // UPDATE THE PROOF SYSTEM: Find matching proof and update it
    const clientProof = proofs.find(p => p.type === 'brandguide' && p.clientId == clientId && (p.status === 'pending' || p.status === 'revision'));

    if (clientProof) {
        // Update proof with revision information
        clientProof.status = 'revision';
        clientProof.revisionCount = (clientProof.revisionCount || 0) + 1;
        clientProof.comments = clientProof.comments || [];
        clientProof.comments.push({
            author: client.name || 'Client',
            text: comment,
            timestamp: new Date().toISOString()
        });
        clientProof.updatedAt = new Date().toISOString();
        saveProofs();

        // Notify designer about the revision request
        if (clientProof.designerId) {
            addDesignerMessage(clientProof.designerId, clientProof.projectId, `📝 Client "${client.name}" has requested revisions on "${clientProof.name}": ${comment}`, 'revision', false);
        }

        // Log to CRM
        logProofActivity('revision', clientProof, `Client "${client.name}" requested revisions on "${clientProof.name}"`);
    }

    // Send email notification to admin about revision request
    simulateEmailNotification(
        'admin@newurbaninfluence.com',
        `📝 Revision Requested: ${client.name} - ${clientProof?.name || 'Brand Guide'}`,
        `Client "${client.name}" has requested revisions on "${clientProof?.name || 'their brand guide'}". Revision request:\n\n"${comment}"`
    );

    document.querySelector('div[style*="fixed"][style*="inset"]').remove();
    alert('Revision request submitted! Our team will review and update your proofs.');
    showClientPortal(client);
}

// Approve client brand proof (for client portal)
function approveClientBrandProof(clientId) {
    const client = clients.find(c => c.id === clientId);
    if (!client.brandGuide) client.brandGuide = { status: 'draft', proofComments: [] };

    const isPaid = checkClientPaymentStatus(clientId);
    client.brandGuide.status = 'approved';
    client.brandGuide.proofComments.push({ type: 'Approved', comment: 'Client approved the brand proofs', date: new Date().toISOString() });
    client.brandGuide.approvedAt = new Date().toISOString();
    saveClients();

    // TRIGGER THE FULL APPROVAL WORKFLOW: Find matching proof and call approveProof()
    const clientProof = proofs.find(p => p.type === 'brandguide' && p.clientId == clientId && (p.status === 'pending' || p.status === 'revision'));

    if (clientProof) {
        // Call the existing approveProof() function which handles all the real workflow:
        // - Saves to brand assets
        // - Updates order status
        // - Notifies designer
        // - Sends real email
        // - Logs to CRM
        approveProof(clientProof.id);
    } else {
        // LEGACY DATA: No matching proof found, do manual workflow
        // Send real email notification instead of console.log
        simulateEmailNotification(
            client.email,
            `✅ Your Brand Proofs Have Been Approved!`,
            `Great news! Your brand proofs have been approved. ${isPaid ? 'Your brand assets are now available for download in your client portal.' : 'Complete your payment to unlock the final deliverable files.'}`
        );

        // Log approval to CRM
        const legacyProof = {
            clientId: clientId,
            clientName: client.name,
            name: 'Brand Guide',
            type: 'brandguide',
            id: Date.now()
        };
        logProofActivity('approved', legacyProof, `Client "${client.name}" approved their brand guide`);
    }

    if (isPaid) {
        alert('🎉 Proof Approved! Your brand assets are now available for download.');
    } else {
        alert('Proof Approved! Please complete payment to download your brand assets.');
    }
    showClientPortal(client);
}

// Approve moodboard (for client portal)
function approveMoodboard(clientId, moodboardId) {
    const mb = proofs.find(p => p.id == moodboardId);
    if (!mb) return;

    // Update moodboard status
    mb.status = 'approved';
    mb.approvedAt = new Date().toISOString();
    saveProofs();

    // Log to CRM
    if (typeof logProofActivity === 'function') {
        logProofActivity('approved', mb.clientName || 'Client', mb.title + ' moodboard approved by client');
    }

    // Notify admin via email
    if (typeof simulateEmailNotification === 'function') {
        simulateEmailNotification('newurbaninfluence@gmail.com', 'Moodboard Approved: ' + mb.title,
            '<h2>Moodboard Approved!</h2><p>' + (mb.clientName || 'Client') + ' has approved the moodboard: <strong>' + mb.title + '</strong></p><p>You can now proceed with creating the brand guide.</p>');
    }

    alert('Moodboard approved! Your designer will begin working on your brand guide.');

    // Refresh portal
    const client = clients.find(c => c.id == clientId);
    if (client) showClientPortal(client);
}

// Request moodboard changes (for client portal)
function requestMoodboardChanges(clientId, moodboardId) {
    const feedback = prompt('What changes would you like? Describe your feedback:');
    if (!feedback || !feedback.trim()) return;

    const mb = proofs.find(p => p.id == moodboardId);
    if (!mb) return;

    mb.status = 'revision';
    mb.revisionCount = (mb.revisionCount || 0) + 1;
    if (!mb.comments) mb.comments = [];
    mb.comments.push({ author: mb.clientName || 'Client', text: feedback.trim(), timestamp: new Date().toISOString() });
    mb.updatedAt = new Date().toISOString();
    saveProofs();

    // Notify admin
    if (typeof simulateEmailNotification === 'function') {
        simulateEmailNotification('newurbaninfluence@gmail.com', 'Moodboard Revision Request: ' + mb.title,
            '<h2>Revision Requested</h2><p>' + (mb.clientName || 'Client') + ' has requested changes to the moodboard: <strong>' + mb.title + '</strong></p><p><strong>Feedback:</strong> ' + feedback.trim() + '</p>');
    }

    // Log to CRM
    if (typeof logProofActivity === 'function') {
        logProofActivity('revision', mb.clientName || 'Client', 'Moodboard revision requested: ' + feedback.trim());
    }

    alert('Your feedback has been sent to the design team!');

    const client = clients.find(c => c.id == clientId);
    if (client) showClientPortal(client);
}

// ==================== CLIENT PORTAL: PROOF APPROVE / REVISION ====================
// Generic approve any proof from client portal Proofs tab
async function clientApproveProof(proofId, clientId) {
    const p = proofs.find(x => x.id == proofId);
    if (!p) { alert('Proof not found.'); return; }

    p.status = 'approved';
    p.approvedAt = new Date().toISOString();
    p.updatedAt = new Date().toISOString();
    saveProofs();

    const client = clients.find(c => c.id == clientId);

    // If it's a brand guide proof, also update the brandGuide status
    if (p.type === 'brandguide' && client?.brandGuide) {
        client.brandGuide.status = 'approved';
        client.brandGuide.approvedAt = new Date().toISOString();
        client.brandGuide.proofComments = client.brandGuide.proofComments || [];
        client.brandGuide.proofComments.push({ type: 'Approved', comment: 'Client approved via portal', date: new Date().toISOString() });
        saveClients();
    }

    // Send email notification to admin/designer
    try {
        await fetch('/.netlify/functions/send-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                to: 'newurbaninfluence@gmail.com',
                subject: '✅ Proof Approved: ' + (p.title || p.name || 'Design Proof') + ' — ' + (client?.name || 'Client'),
                html: '<div style="font-family:-apple-system,sans-serif;max-width:600px;margin:0 auto;background:#0a0a0a;color:#fff;border-radius:12px;overflow:hidden;"><div style="background:linear-gradient(135deg,#10b981,#059669);padding:32px;text-align:center;"><h2 style="margin:0;font-size:24px;color:#fff;">Proof Approved! ✅</h2></div><div style="padding:32px;"><p style="color:#ccc;font-size:16px;"><strong>' + (client?.name || 'Client') + '</strong> has approved:</p><div style="background:#111;border:1px solid #333;border-radius:12px;padding:20px;margin:16px 0;"><p style="color:#fff;font-weight:600;font-size:18px;margin:0 0 8px;">' + (p.title || p.name || 'Design Proof') + '</p><p style="color:#888;font-size:14px;margin:0;">' + (p.category || p.proofType || 'Proof') + ' • Version ' + (p.version || 1) + '</p></div><p style="color:#888;font-size:14px;">You can now proceed with final deliverables.</p></div></div>',
                text: (client?.name || 'Client') + ' approved "' + (p.title || p.name || 'Design Proof') + '". Proceed with final deliverables.'
            })
        });
    } catch (err) { console.log('Admin notification email failed:', err.message); }

    // Log to CRM
    if (typeof logProofActivity === 'function') {
        logProofActivity('approved', p, (client?.name || 'Client') + ' approved "' + (p.title || p.name) + '" from client portal');
    }

    alert('✅ Proof approved! Your designer will prepare your final deliverables.');
    if (client) showClientPortal(client);
}

// Generic request revision on any proof from client portal Proofs tab
function clientRequestProofRevision(proofId, clientId) {
    const p = proofs.find(x => x.id == proofId);
    if (!p) { alert('Proof not found.'); return; }

    // Show revision modal
    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;';
    modal.innerHTML = `
<div style="background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:32px;max-width:500px;width:100%;">
<h3 style="font-size:20px;font-weight:700;margin-bottom:8px;color:#fff;">🔄 Request Changes</h3>
<p style="color:#888;margin-bottom:8px;">Proof: <strong style="color:#fff;">${p.title || p.name || 'Design Proof'}</strong></p>
<p style="color:#888;margin-bottom:24px;">Describe the changes you'd like and we'll get on it ASAP.</p>
<textarea id="clientRevisionFeedback" placeholder="What changes would you like to see?&#10;&#10;Be as specific as possible — colors, layout, text, etc." style="width:100%;min-height:140px;padding:16px;background:#0a0a0a;border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:#fff;font-family:inherit;font-size:14px;resize:vertical;box-sizing:border-box;"></textarea>
<div style="display:flex;gap:12px;margin-top:24px;">
<button onclick="this.closest('div[style*=fixed]').remove()" style="flex:1;padding:14px;background:transparent;border:1px solid #333;color:#fff;border-radius:8px;cursor:pointer;font-weight:600;font-family:inherit;">Cancel</button>
<button onclick="submitClientProofRevision(${proofId}, ${clientId})" style="flex:1;padding:14px;background:#ef4444;border:none;color:#fff;border-radius:8px;cursor:pointer;font-weight:600;font-family:inherit;">Send Feedback</button>
</div>
</div>`;
    document.body.appendChild(modal);
}

async function submitClientProofRevision(proofId, clientId) {
    const feedback = document.getElementById('clientRevisionFeedback')?.value?.trim();
    if (!feedback) { alert('Please describe the changes you need.'); return; }

    const p = proofs.find(x => x.id == proofId);
    if (!p) return;

    p.status = 'revision';
    p.revisionCount = (p.revisionCount || 0) + 1;
    p.comments = p.comments || [];
    p.comments.push({ author: 'Client', text: feedback, timestamp: new Date().toISOString() });
    p.updatedAt = new Date().toISOString();
    saveProofs();

    const client = clients.find(c => c.id == clientId);

    // If brand guide proof, also update brandGuide status
    if (p.type === 'brandguide' && client?.brandGuide) {
        client.brandGuide.status = 'revision_requested';
        client.brandGuide.proofComments = client.brandGuide.proofComments || [];
        client.brandGuide.proofComments.push({ type: 'Revision Requested', comment: feedback, date: new Date().toISOString() });
        saveClients();
    }

    // Notify designer
    if (p.designerId && typeof addDesignerMessage === 'function') {
        addDesignerMessage(p.designerId, p.projectId, '📝 Client "' + (client?.name || '') + '" requested revisions on "' + (p.title || p.name) + '": ' + feedback, 'revision', false);
    }

    // Send email to admin/designer
    try {
        await fetch('/.netlify/functions/send-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                to: 'newurbaninfluence@gmail.com',
                subject: '🔄 Revision Requested: ' + (p.title || p.name || 'Design Proof') + ' — ' + (client?.name || 'Client'),
                html: '<div style="font-family:-apple-system,sans-serif;max-width:600px;margin:0 auto;background:#0a0a0a;color:#fff;border-radius:12px;overflow:hidden;"><div style="background:linear-gradient(135deg,#ef4444,#dc2626);padding:32px;text-align:center;"><h2 style="margin:0;font-size:24px;color:#fff;">Revision Requested 🔄</h2></div><div style="padding:32px;"><p style="color:#ccc;font-size:16px;"><strong>' + (client?.name || 'Client') + '</strong> wants changes to:</p><div style="background:#111;border:1px solid #333;border-radius:12px;padding:20px;margin:16px 0;"><p style="color:#fff;font-weight:600;font-size:18px;margin:0 0 8px;">' + (p.title || p.name || 'Design Proof') + '</p><p style="color:#888;font-size:14px;margin:0;">Revision #' + (p.revisionCount || 1) + '</p></div><div style="background:#111;border:1px solid #333;border-radius:12px;padding:20px;margin:16px 0;"><p style="color:#888;font-size:12px;margin:0 0 8px;">CLIENT FEEDBACK:</p><p style="color:#fff;font-size:15px;line-height:1.6;margin:0;">' + feedback.replace(/\n/g, '<br>') + '</p></div></div></div>',
                text: (client?.name || 'Client') + ' requested revisions on "' + (p.title || p.name) + '": ' + feedback
            })
        });
    } catch (err) { console.log('Revision notification email failed:', err.message); }

    // Log to CRM
    if (typeof logProofActivity === 'function') {
        logProofActivity('revision', p, (client?.name || 'Client') + ' requested revisions on "' + (p.title || p.name) + '"');
    }

    // Close modal
    const modal = document.querySelector('div[style*="fixed"][style*="inset"]');
    if (modal) modal.remove();

    alert('📝 Revision request sent! Your designer will review your feedback and update the proof.');
    if (client) showClientPortal(client);
}

// ==================== CLIENT PORTAL: CONTACT DESIGNER MESSAGING ====================
function openClientMessageDesigner(clientId) {
    const client = clients.find(c => c.id == clientId);
    if (!client) return;

    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;';
    modal.innerHTML = `
<div style="background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:32px;max-width:520px;width:100%;">
<h3 style="font-size:20px;font-weight:700;margin-bottom:8px;color:#fff;">💬 Contact Your Designer</h3>
<p style="color:#888;margin-bottom:20px;">Send a message directly to your design team. We'll respond within 1 business day.</p>
<div style="margin-bottom:16px;">
<label style="display:block;font-size:13px;font-weight:600;color:#aaa;margin-bottom:6px;">Subject</label>
<select id="designerMsgSubject" style="width:100%;padding:12px 16px;background:#0a0a0a;border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:#fff;font-family:inherit;font-size:14px;box-sizing:border-box;">
<option value="general">General Question</option>
<option value="proof">About My Proofs</option>
<option value="timeline">Project Timeline</option>
<option value="files">Files & Deliverables</option>
<option value="add-on">Add-on Services</option>
<option value="billing">Billing & Payments</option>
<option value="other">Other</option>
</select>
</div>
<div style="margin-bottom:16px;">
<label style="display:block;font-size:13px;font-weight:600;color:#aaa;margin-bottom:6px;">Message</label>
<textarea id="designerMsgBody" placeholder="Type your message here..." style="width:100%;min-height:140px;padding:16px;background:#0a0a0a;border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:#fff;font-family:inherit;font-size:14px;resize:vertical;box-sizing:border-box;"></textarea>
</div>
<div style="display:flex;gap:12px;">
<button onclick="this.closest('div[style*=fixed]').remove()" style="flex:1;padding:14px;background:transparent;border:1px solid #333;color:#fff;border-radius:8px;cursor:pointer;font-weight:600;font-family:inherit;">Cancel</button>
<button onclick="sendClientDesignerMessage(${clientId})" style="flex:1;padding:14px;background:#e11d48;border:none;color:#fff;border-radius:8px;cursor:pointer;font-weight:600;font-family:inherit;">📨 Send Message</button>
</div>
</div>`;
    document.body.appendChild(modal);
}

async function sendClientDesignerMessage(clientId) {
    const subject = document.getElementById('designerMsgSubject')?.value || 'general';
    const body = document.getElementById('designerMsgBody')?.value?.trim();
    if (!body) { alert('Please type your message.'); return; }

    const client = clients.find(c => c.id == clientId);
    if (!client) return;

    const subjectLabels = {
        general: 'General Question', proof: 'About Proofs', timeline: 'Project Timeline',
        files: 'Files & Deliverables', 'add-on': 'Add-on Services', billing: 'Billing & Payments', other: 'Other'
    };

    // Store message in client record
    client.messages = client.messages || [];
    client.messages.push({
        id: Date.now(),
        from: 'client',
        subject: subjectLabels[subject] || subject,
        body: body,
        timestamp: new Date().toISOString(),
        read: false
    });
    saveClients();

    // Send email to NUI team
    try {
        await fetch('/.netlify/functions/send-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                to: 'newurbaninfluence@gmail.com',
                subject: '💬 Client Message: ' + (client.name || 'Client') + ' — ' + (subjectLabels[subject] || subject),
                html: '<div style="font-family:-apple-system,sans-serif;max-width:600px;margin:0 auto;background:#0a0a0a;color:#fff;border-radius:12px;overflow:hidden;"><div style="background:linear-gradient(135deg,#e11d48,#be185d);padding:32px;text-align:center;"><h2 style="margin:0;font-size:24px;color:#fff;">New Client Message 💬</h2></div><div style="padding:32px;"><div style="display:flex;justify-content:space-between;margin-bottom:20px;"><div><p style="color:#888;font-size:12px;margin:0;">FROM</p><p style="color:#fff;font-size:16px;font-weight:600;margin:4px 0 0;">' + (client.name || 'Client') + '</p><p style="color:#888;font-size:13px;margin:2px 0 0;">' + (client.email || '') + '</p></div><div style="text-align:right;"><p style="color:#888;font-size:12px;margin:0;">SUBJECT</p><p style="color:#e11d48;font-size:14px;font-weight:600;margin:4px 0 0;">' + (subjectLabels[subject] || subject) + '</p></div></div><div style="background:#111;border:1px solid #333;border-radius:12px;padding:24px;"><p style="color:#fff;font-size:15px;line-height:1.7;margin:0;white-space:pre-wrap;">' + body.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>') + '</p></div><p style="color:#888;font-size:13px;margin-top:20px;">Reply to this client from the admin panel or email them at ' + (client.email || 'N/A') + '</p></div></div>',
                text: 'New message from ' + (client.name || 'Client') + ' (' + (client.email || '') + ')\nSubject: ' + (subjectLabels[subject] || subject) + '\n\n' + body
            })
        });
    } catch (err) { console.log('Designer message email failed:', err.message); }

    // Close modal
    const modal = document.querySelector('div[style*="fixed"][style*="inset"]');
    if (modal) modal.remove();

    alert('✅ Message sent! We\'ll get back to you within 1 business day.');
}

// ==================== CLIENT PORTAL: BOOK A CALL ====================
function openBookCallModal() {
    // Business hours: Mon–Thu 1:00–4:00 PM EST, Friday = booked (design work), Sat–Sun = closed
    const now = new Date();
    const estOffset = -5; // EST is UTC-5
    const utcMs = now.getTime() + (now.getTimezoneOffset() * 60000);
    const estNow = new Date(utcMs + (3600000 * estOffset));
    const dayOfWeek = estNow.getDay(); // 0=Sun, 1=Mon ... 6=Sat
    const hour = estNow.getHours();
    const dayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];

    // Generate next 14 days of available slots
    let slotsHtml = '';
    let slotCount = 0;
    for (let d = 1; d <= 14 && slotCount < 8; d++) {
        const date = new Date(estNow);
        date.setDate(date.getDate() + d);
        const dow = date.getDay();
        // Only Mon-Thu (1-4) are available
        if (dow >= 1 && dow <= 4) {
            const dateStr = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            const isoDate = date.toISOString().split('T')[0];
            slotsHtml += '<div style="margin-bottom:8px;">' +
                '<div style="font-size:13px;font-weight:600;color:#fff;margin-bottom:6px;">' + dateStr + '</div>' +
                '<div style="display:flex;gap:8px;flex-wrap:wrap;">' +
                '<button onclick="selectCallSlot(this, \'' + isoDate + '\', \'1:00 PM\')" class="call-slot-btn" style="padding:8px 16px;background:#0a0a0a;border:1px solid #333;color:#ccc;border-radius:6px;cursor:pointer;font-family:inherit;font-size:13px;transition:all 0.2s;">1:00 PM</button>' +
                '<button onclick="selectCallSlot(this, \'' + isoDate + '\', \'1:30 PM\')" class="call-slot-btn" style="padding:8px 16px;background:#0a0a0a;border:1px solid #333;color:#ccc;border-radius:6px;cursor:pointer;font-family:inherit;font-size:13px;transition:all 0.2s;">1:30 PM</button>' +
                '<button onclick="selectCallSlot(this, \'' + isoDate + '\', \'2:00 PM\')" class="call-slot-btn" style="padding:8px 16px;background:#0a0a0a;border:1px solid #333;color:#ccc;border-radius:6px;cursor:pointer;font-family:inherit;font-size:13px;transition:all 0.2s;">2:00 PM</button>' +
                '<button onclick="selectCallSlot(this, \'' + isoDate + '\', \'2:30 PM\')" class="call-slot-btn" style="padding:8px 16px;background:#0a0a0a;border:1px solid #333;color:#ccc;border-radius:6px;cursor:pointer;font-family:inherit;font-size:13px;transition:all 0.2s;">2:30 PM</button>' +
                '<button onclick="selectCallSlot(this, \'' + isoDate + '\', \'3:00 PM\')" class="call-slot-btn" style="padding:8px 16px;background:#0a0a0a;border:1px solid #333;color:#ccc;border-radius:6px;cursor:pointer;font-family:inherit;font-size:13px;transition:all 0.2s;">3:00 PM</button>' +
                '<button onclick="selectCallSlot(this, \'' + isoDate + '\', \'3:30 PM\')" class="call-slot-btn" style="padding:8px 16px;background:#0a0a0a;border:1px solid #333;color:#ccc;border-radius:6px;cursor:pointer;font-family:inherit;font-size:13px;transition:all 0.2s;">3:30 PM</button>' +
                '</div></div>';
            slotCount++;
        }
    }

    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;overflow-y:auto;';
    modal.innerHTML = `
<div style="background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:32px;max-width:520px;width:100%;max-height:90vh;overflow-y:auto;">
<h3 style="font-size:20px;font-weight:700;margin-bottom:8px;color:#fff;">📞 Book a Call</h3>
<p style="color:#888;margin-bottom:4px;">Schedule a call with your design team.</p>
<div style="background:#0a0a0a;border:1px solid #222;border-radius:8px;padding:12px 16px;margin-bottom:20px;">
<p style="color:#888;font-size:13px;margin:0;"><strong style="color:#e11d48;">Hours:</strong> Monday – Thursday, 1:00 – 4:00 PM EST</p>
<p style="color:#666;font-size:12px;margin:4px 0 0;">Fridays reserved for design work • Weekends closed</p>
</div>
<div style="margin-bottom:20px;">
<label style="display:block;font-size:13px;font-weight:600;color:#aaa;margin-bottom:10px;">Select a time slot:</label>
${slotsHtml}
</div>
<input type="hidden" id="selectedCallDate" value="">
<input type="hidden" id="selectedCallTime" value="">
<div style="margin-bottom:16px;">
<label style="display:block;font-size:13px;font-weight:600;color:#aaa;margin-bottom:6px;">What would you like to discuss? (optional)</label>
<textarea id="callTopic" placeholder="Brief description of what you'd like to cover..." style="width:100%;min-height:80px;padding:12px 16px;background:#0a0a0a;border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:#fff;font-family:inherit;font-size:14px;resize:vertical;box-sizing:border-box;"></textarea>
</div>
<div style="display:flex;gap:12px;">
<button onclick="this.closest('div[style*=fixed]').remove()" style="flex:1;padding:14px;background:transparent;border:1px solid #333;color:#fff;border-radius:8px;cursor:pointer;font-weight:600;font-family:inherit;">Cancel</button>
<button id="bookCallConfirmBtn" onclick="confirmBookCall()" style="flex:1;padding:14px;background:#333;border:none;color:#666;border-radius:8px;cursor:not-allowed;font-weight:600;font-family:inherit;" disabled>Select a Time</button>
</div>
</div>`;
    document.body.appendChild(modal);
}

function selectCallSlot(btn, date, time) {
    // Remove active from all slot buttons
    document.querySelectorAll('.call-slot-btn').forEach(b => {
        b.style.background = '#0a0a0a';
        b.style.borderColor = '#333';
        b.style.color = '#ccc';
    });
    // Highlight selected
    btn.style.background = '#e11d4820';
    btn.style.borderColor = '#e11d48';
    btn.style.color = '#e11d48';

    document.getElementById('selectedCallDate').value = date;
    document.getElementById('selectedCallTime').value = time;

    // Enable confirm button
    const confirmBtn = document.getElementById('bookCallConfirmBtn');
    if (confirmBtn) {
        confirmBtn.style.background = '#e11d48';
        confirmBtn.style.color = '#fff';
        confirmBtn.style.cursor = 'pointer';
        confirmBtn.disabled = false;
        confirmBtn.textContent = '📞 Book ' + time + ' Call';
    }
}

async function confirmBookCall() {
    const date = document.getElementById('selectedCallDate')?.value;
    const time = document.getElementById('selectedCallTime')?.value;
    const topic = document.getElementById('callTopic')?.value?.trim() || 'General discussion';

    if (!date || !time) { alert('Please select a time slot.'); return; }

    const clientId = currentUser?.clientId || currentUser?.id;
    const client = clients.find(c => c.id == clientId) || currentUser;
    const dateObj = new Date(date + 'T12:00:00');
    const dateFormatted = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });

    // Store booking
    client.callBookings = client.callBookings || [];
    client.callBookings.push({
        id: Date.now(),
        date: date,
        time: time,
        topic: topic,
        status: 'confirmed',
        bookedAt: new Date().toISOString()
    });
    saveClients();

    // Send email to NUI team
    try {
        await fetch('/.netlify/functions/send-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                to: 'newurbaninfluence@gmail.com',
                subject: '📞 Call Booked: ' + (client.name || 'Client') + ' — ' + dateFormatted + ' at ' + time + ' EST',
                html: '<div style="font-family:-apple-system,sans-serif;max-width:600px;margin:0 auto;background:#0a0a0a;color:#fff;border-radius:12px;overflow:hidden;"><div style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);padding:32px;text-align:center;"><h2 style="margin:0;font-size:24px;color:#fff;">New Call Booked 📞</h2></div><div style="padding:32px;"><p style="color:#ccc;font-size:16px;"><strong>' + (client.name || 'Client') + '</strong> booked a call:</p><div style="background:#111;border:1px solid #333;border-radius:12px;padding:24px;margin:16px 0;"><div style="display:grid;grid-template-columns:auto 1fr;gap:8px 16px;"><span style="color:#888;font-size:13px;">📅 Date:</span><span style="color:#fff;font-weight:600;">' + dateFormatted + '</span><span style="color:#888;font-size:13px;">🕐 Time:</span><span style="color:#fff;font-weight:600;">' + time + ' EST</span><span style="color:#888;font-size:13px;">📧 Email:</span><span style="color:#fff;">' + (client.email || 'N/A') + '</span><span style="color:#888;font-size:13px;">📋 Topic:</span><span style="color:#fff;">' + topic.replace(/</g, '&lt;') + '</span></div></div></div></div>',
                text: 'Call booked by ' + (client.name || 'Client') + ' for ' + dateFormatted + ' at ' + time + ' EST. Topic: ' + topic
            })
        });
    } catch (err) { console.log('Call booking email failed:', err.message); }

    // Send confirmation email to client
    if (client.email) {
        try {
            await fetch('/.netlify/functions/send-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    to: client.email,
                    subject: '📞 Call Confirmed — ' + dateFormatted + ' at ' + time + ' EST',
                    html: '<div style="font-family:-apple-system,sans-serif;max-width:600px;margin:0 auto;background:#0a0a0a;color:#fff;border-radius:12px;overflow:hidden;"><div style="background:linear-gradient(135deg,#e11d48,#be185d);padding:32px;text-align:center;"><h2 style="margin:0;font-size:24px;color:#fff;">Your Call is Confirmed! 📞</h2></div><div style="padding:32px;"><p style="color:#ccc;font-size:16px;">Hey ' + (client.contact || client.name || 'there') + ',</p><p style="color:#ccc;font-size:16px;">Your call with New Urban Influence is confirmed:</p><div style="background:#111;border:1px solid #333;border-radius:12px;padding:24px;margin:20px 0;text-align:center;"><p style="color:#e11d48;font-size:24px;font-weight:700;margin:0 0 4px;">' + dateFormatted + '</p><p style="color:#fff;font-size:20px;font-weight:600;margin:0;">' + time + ' EST</p></div><p style="color:#888;font-size:14px;">We\'ll call you at the number on file. If you need to reschedule, contact us at <a href="tel:2484878747" style="color:#e11d48;text-decoration:none;">(248) 487-8747</a> or reply to this email.</p></div><div style="background:#050505;padding:20px;text-align:center;border-top:1px solid #222;"><p style="color:#666;font-size:12px;margin:0;">New Urban Influence • Detroit, MI</p></div></div>',
                    text: 'Your call is confirmed for ' + dateFormatted + ' at ' + time + ' EST. We\'ll call you at the number on file. To reschedule, call (248) 487-8747.'
                })
            });
        } catch (err) { console.log('Client confirmation email failed:', err.message); }
    }

    // Close modal
    const modal = document.querySelector('div[style*="fixed"][style*="inset"]');
    if (modal) modal.remove();

    alert('📞 Call booked!\n\n📅 ' + dateFormatted + '\n🕐 ' + time + ' EST\n\nYou\'ll receive a confirmation email shortly.');
}

// ==================== PAYMENT GATING (CRITICAL) ====================
// Check if client has paid before allowing downloads
function canDownload(clientId) {
    const clientInvoices = invoices.filter(i => i.clientId === clientId);
    const clientPayments = payments.filter(p => p.clientId === clientId);

    // If no invoices, no downloads needed
    if (clientInvoices.length === 0) return true;

    const totalOwed = clientInvoices.reduce((sum, inv) => sum + (inv.total || 0), 0);
    const totalPaid = clientPayments.reduce((sum, p) => sum + (p.amount || 0), 0);

    // Allow download only if paid >= owed
    return totalPaid >= totalOwed;
}

function downloadAsset(clientId, category, index) {
    // CRITICAL: Check payment status before allowing download
    if (!canDownload(clientId)) {
        alert('⚠️ Payment Required\n\nPlease complete payment before downloading brand assets. Contact us if you believe this is an error.');
        return;
    }

    const client = clients.find(c => c.id === clientId);
    if (!client || !client.assets || !client.assets[category]) {
        alert('Asset not found');
        return;
    }

    const asset = client.assets[category][index];
    if (asset?.data) {
        const link = document.createElement('a');
        link.href = asset.data;
        link.download = asset.name || `${category}-asset-${index}`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        console.log('Download started: ' + asset.name);
    } else if (asset?.url) {
        window.open(asset.url, '_blank');
    } else {
        alert('Asset not available for download');
    }
}

function copyColors(colors) {
    navigator.clipboard.writeText(colors);
    alert('Colors copied to clipboard: ' + colors);
}

function backToAdmin() {
    if (currentUser?.type === 'admin') {
        document.getElementById('clientPortal').style.display = 'none';
        document.getElementById('adminDashboard').style.display = 'block';
    } else {
        portalLogout();
    }
}

// ==================== MULTI-STEP SERVICE INTAKE SYSTEM ====================
let intakeData = {};
let currentIntakeStep = 1;
let uploadedFiles = [];

// Service-specific intake configurations
// Client Background Questions (used across all intakes)
const clientBackgroundFields = [
    { id: 'clientName', type: 'text', label: 'Your Full Name', required: true },
    { id: 'clientPhone', type: 'text', label: 'Phone Number', required: true, placeholder: '(248) 487-8747' },
    { id: 'howDidYouHear', type: 'select', label: 'How did you hear about us?', options: ['Google Search', 'Instagram', 'Facebook', 'TikTok', 'LinkedIn', 'Referral from Friend', 'Referral from Client', 'Saw Our Work', 'Local Event', 'Other'] },
    { id: 'workedWithUsBefore', type: 'radio', label: 'Have you worked with us before?', options: [
        { value: 'yes', title: 'Yes', desc: 'I\'m a returning client' },
        { value: 'no', title: 'No', desc: 'This is my first time' }
    ]},
    { id: 'socialMediaAccounts', type: 'textarea', label: 'Your Social Media Accounts', required: false, placeholder: 'Instagram: @yourbusiness\\nFacebook: /yourbusiness\\nTikTok: @yourbusiness' },
    { id: 'emailMarketing', type: 'radio', label: 'Do you currently do email marketing?', options: [
        { value: 'yes', title: 'Yes, actively', desc: 'Regular newsletters/campaigns' },
        { value: 'sometimes', title: 'Sometimes', desc: 'Occasional emails' },
        { value: 'no', title: 'No', desc: 'Not yet' }
    ]},
    { id: 'directMailers', type: 'radio', label: 'Do you use direct mail/mailers?', options: [
        { value: 'yes', title: 'Yes', desc: 'Postcards, flyers, etc.' },
        { value: 'no', title: 'No', desc: 'Digital only' }
    ]}
];

const serviceIntakeConfigs = {
    'brand-starter': {
        name: 'Brand Starter',
        price: 1500,
        steps: ['About You', 'Business Info', 'Brand Vision', 'Preferences', 'Upload', 'Review'],
        fields: {
            1: clientBackgroundFields,
            2: [
                { id: 'businessName', type: 'text', label: 'Business Name', required: true },
                { id: 'industry', type: 'text', label: 'Industry/Niche', required: true },
                { id: 'website', type: 'text', label: 'Current Website (if any)', required: false },
                { id: 'targetAudience', type: 'textarea', label: 'Describe your ideal customer', required: true }
            ],
            3: [
                { id: 'brandPersonality', type: 'radio', label: 'Brand Personality', options: [
                    { value: 'bold', title: 'Bold & Edgy', desc: 'Stand out, be different, make a statement' },
                    { value: 'professional', title: 'Professional & Trust', desc: 'Reliable, established, corporate' },
                    { value: 'playful', title: 'Playful & Fun', desc: 'Energetic, youthful, approachable' },
                    { value: 'luxury', title: 'Luxury & Premium', desc: 'High-end, exclusive, sophisticated' }
                ]},
                { id: 'brandValues', type: 'textarea', label: 'What 3 words describe your brand?', required: true }
            ],
            4: [
                { id: 'colorPrefs', type: 'textarea', label: 'Color preferences (or colors to avoid)', required: false },
                { id: 'competitors', type: 'textarea', label: 'List 2-3 competitors you admire', required: false },
                { id: 'inspiration', type: 'textarea', label: 'Links to brands/designs you love', required: false }
            ],
            5: [
                { id: 'files', type: 'file', label: 'Upload reference images, existing logos, or inspiration', accept: 'image/*,.pdf,.ai,.psd', multiple: true }
            ]
        }
    },
    'brand-identity': {
        name: 'Brand Identity Package',
        price: 3500,
        steps: ['About You', 'Business Info', 'Brand Story', 'Visual Direction', 'Upload', 'Review'],
        fields: {
            1: clientBackgroundFields,
            2: [
                { id: 'businessName', type: 'text', label: 'Business Name', required: true },
                { id: 'tagline', type: 'text', label: 'Tagline (if any)', required: false },
                { id: 'industry', type: 'text', label: 'Industry/Niche', required: true },
                { id: 'yearsInBusiness', type: 'select', label: 'Years in Business', options: ['Startup', '1-2 years', '3-5 years', '5+ years'] }
            ],
            3: [
                { id: 'mission', type: 'textarea', label: 'What is your mission statement?', required: true },
                { id: 'uniqueValue', type: 'textarea', label: 'What makes you different from competitors?', required: true },
                { id: 'brandStory', type: 'textarea', label: 'Tell us your brand story in a few sentences', required: true }
            ],
            4: [
                { id: 'brandPersonality', type: 'radio', label: 'Brand Personality', options: [
                    { value: 'bold', title: 'Bold & Edgy', desc: 'Stand out, be different, make a statement' },
                    { value: 'professional', title: 'Professional & Trust', desc: 'Reliable, established, corporate' },
                    { value: 'playful', title: 'Playful & Fun', desc: 'Energetic, youthful, approachable' },
                    { value: 'luxury', title: 'Luxury & Premium', desc: 'High-end, exclusive, sophisticated' }
                ]},
                { id: 'colorPrefs', type: 'textarea', label: 'Color preferences', required: false },
                { id: 'fontStyle', type: 'radio', label: 'Typography Style', options: [
                    { value: 'modern', title: 'Modern Sans-Serif', desc: 'Clean, minimal, contemporary' },
                    { value: 'classic', title: 'Classic Serif', desc: 'Elegant, traditional, timeless' },
                    { value: 'display', title: 'Display/Creative', desc: 'Unique, artistic, memorable' }
                ]}
            ],
            5: [
                { id: 'files', type: 'file', label: 'Upload existing assets, inspiration, or competitor examples', accept: 'image/*,.pdf,.ai,.psd,.doc,.docx', multiple: true }
            ]
        }
    },
    'website-basic': {
        name: 'Website Design',
        price: 2500,
        steps: ['Project Info', 'Content', 'Design', 'Upload', 'Review'],
        fields: {
            1: [
                { id: 'businessName', type: 'text', label: 'Business Name', required: true },
                { id: 'websiteGoal', type: 'radio', label: 'Primary Website Goal', options: [
                    { value: 'leads', title: 'Generate Leads', desc: 'Contact forms, inquiries, bookings' },
                    { value: 'sales', title: 'Sell Products', desc: 'E-commerce, online store' },
                    { value: 'info', title: 'Provide Information', desc: 'Portfolio, about, services' },
                    { value: 'booking', title: 'Book Appointments', desc: 'Scheduling, reservations' }
                ]},
                { id: 'currentWebsite', type: 'text', label: 'Current Website URL (if any)', required: false }
            ],
            2: [
                { id: 'pages', type: 'textarea', label: 'List the pages you need (Home, About, Services, Contact, etc.)', required: true },
                { id: 'features', type: 'textarea', label: 'Special features needed (booking system, gallery, blog, etc.)', required: false },
                { id: 'contentReady', type: 'radio', label: 'Do you have website content ready?', options: [
                    { value: 'yes', title: 'Yes, all ready', desc: 'Text, images, and copy prepared' },
                    { value: 'partial', title: 'Partially ready', desc: 'Some content needs work' },
                    { value: 'no', title: 'Need help', desc: 'Will need content creation' }
                ]}
            ],
            3: [
                { id: 'designStyle', type: 'radio', label: 'Design Style', options: [
                    { value: 'minimal', title: 'Minimal & Clean', desc: 'Whitespace, simple, modern' },
                    { value: 'bold', title: 'Bold & Dynamic', desc: 'Strong colors, animations, impact' },
                    { value: 'elegant', title: 'Elegant & Refined', desc: 'Sophisticated, premium feel' },
                    { value: 'creative', title: 'Creative & Unique', desc: 'Artistic, unconventional' }
                ]},
                { id: 'websiteInspiration', type: 'textarea', label: 'Links to websites you like', required: false }
            ],
            4: [
                { id: 'files', type: 'file', label: 'Upload logo, brand assets, content, or reference images', accept: 'image/*,.pdf,.doc,.docx,.txt', multiple: true }
            ]
        }
    },
    'website-pro': {
        name: 'Website Pro',
        price: 5000,
        steps: ['Business Info', 'E-Commerce', 'Design', 'Upload', 'Review'],
        fields: {
            1: [
                { id: 'businessName', type: 'text', label: 'Business Name', required: true },
                { id: 'industry', type: 'text', label: 'Industry', required: true },
                { id: 'currentWebsite', type: 'text', label: 'Current Website URL', required: false },
                { id: 'monthlyVisitors', type: 'select', label: 'Expected Monthly Visitors', options: ['Under 1,000', '1,000 - 10,000', '10,000 - 50,000', '50,000+'] }
            ],
            2: [
                { id: 'productCount', type: 'select', label: 'Number of Products', options: ['1-10', '11-50', '51-200', '200+'] },
                { id: 'paymentMethods', type: 'textarea', label: 'Payment methods needed (Stripe, PayPal, etc.)', required: true },
                { id: 'shippingNeeds', type: 'textarea', label: 'Shipping requirements', required: false },
                { id: 'integrations', type: 'textarea', label: 'Third-party integrations needed', required: false }
            ],
            3: [
                { id: 'designStyle', type: 'radio', label: 'Design Style', options: [
                    { value: 'minimal', title: 'Minimal & Clean', desc: 'Let products speak for themselves' },
                    { value: 'luxury', title: 'Luxury & Premium', desc: 'High-end shopping experience' },
                    { value: 'energetic', title: 'Bold & Energetic', desc: 'Vibrant, engaging, dynamic' }
                ]},
                { id: 'websiteInspiration', type: 'textarea', label: 'E-commerce sites you admire', required: false }
            ],
            4: [
                { id: 'files', type: 'file', label: 'Upload product images, brand assets, or content', accept: 'image/*,.pdf,.csv,.xlsx', multiple: true }
            ]
        }
    },
    'social-starter': {
        name: 'Social Media Starter',
        price: 800,
        steps: ['Business Info', 'Platforms', 'Style', 'Review'],
        fields: {
            1: [
                { id: 'businessName', type: 'text', label: 'Business Name', required: true },
                { id: 'industry', type: 'text', label: 'Industry', required: true },
                { id: 'socialHandles', type: 'textarea', label: 'Current social media handles', required: false }
            ],
            2: [
                { id: 'platforms', type: 'textarea', label: 'Which platforms do you need graphics for?', required: true, placeholder: 'Instagram, Facebook, Twitter, LinkedIn, TikTok...' },
                { id: 'contentTypes', type: 'textarea', label: 'Types of posts you need (quotes, promos, announcements, etc.)', required: true }
            ],
            3: [
                { id: 'brandColors', type: 'text', label: 'Brand colors (hex codes if known)', required: false },
                { id: 'style', type: 'radio', label: 'Visual Style', options: [
                    { value: 'minimal', title: 'Clean & Minimal', desc: 'Simple, elegant, professional' },
                    { value: 'bold', title: 'Bold & Eye-catching', desc: 'Vibrant colors, strong typography' },
                    { value: 'playful', title: 'Fun & Playful', desc: 'Illustrations, patterns, energy' }
                ]}
            ]
        }
    },
    'social-pro': {
        name: 'Social Media Pro',
        price: 1500,
        steps: ['Business', 'Strategy', 'Content', 'Upload', 'Review'],
        fields: {
            1: [
                { id: 'businessName', type: 'text', label: 'Business Name', required: true },
                { id: 'industry', type: 'text', label: 'Industry', required: true },
                { id: 'targetAudience', type: 'textarea', label: 'Describe your target audience', required: true }
            ],
            2: [
                { id: 'goals', type: 'textarea', label: 'What are your social media goals?', required: true },
                { id: 'competitors', type: 'textarea', label: 'Competitors with great social presence', required: false },
                { id: 'postFrequency', type: 'select', label: 'Desired posting frequency', options: ['Daily', '3-4x per week', '2-3x per week', 'Weekly'] }
            ],
            3: [
                { id: 'contentPillars', type: 'textarea', label: 'Main content themes/pillars', required: true },
                { id: 'tone', type: 'radio', label: 'Brand Voice', options: [
                    { value: 'professional', title: 'Professional', desc: 'Authoritative, knowledgeable' },
                    { value: 'friendly', title: 'Friendly & Casual', desc: 'Approachable, conversational' },
                    { value: 'bold', title: 'Bold & Provocative', desc: 'Opinionated, attention-grabbing' }
                ]}
            ],
            4: [
                { id: 'files', type: 'file', label: 'Upload brand assets, product photos, or content ideas', accept: 'image/*,.pdf,.doc', multiple: true }
            ]
        }
    },
    'video-promo': {
        name: 'Promo Video',
        price: 1200,
        steps: ['Project Info', 'Video Details', 'Assets', 'Review'],
        fields: {
            1: [
                { id: 'businessName', type: 'text', label: 'Business Name', required: true },
                { id: 'videoGoal', type: 'radio', label: 'Video Purpose', options: [
                    { value: 'brand', title: 'Brand Introduction', desc: 'Introduce your company/brand' },
                    { value: 'product', title: 'Product Launch', desc: 'Showcase a product or service' },
                    { value: 'promo', title: 'Promotion/Sale', desc: 'Announce offers or events' },
                    { value: 'social', title: 'Social Media Ad', desc: 'Short-form video for ads' }
                ]}
            ],
            2: [
                { id: 'videoDuration', type: 'select', label: 'Preferred Duration', options: ['15 seconds', '30 seconds', '60 seconds', '90 seconds'] },
                { id: 'keyMessage', type: 'textarea', label: 'Main message to convey', required: true },
                { id: 'callToAction', type: 'text', label: 'Call to action (Visit website, Shop now, etc.)', required: true }
            ],
            3: [
                { id: 'files', type: 'file', label: 'Upload logo, product images, video clips, or music preferences', accept: 'image/*,video/*,audio/*,.pdf', multiple: true }
            ]
        }
    },
    'full-rebrand': {
        name: 'Full Rebrand',
        price: 8000,
        steps: ['Current State', 'Vision', 'Scope', 'Assets', 'Review'],
        fields: {
            1: [
                { id: 'businessName', type: 'text', label: 'Business Name', required: true },
                { id: 'yearsInBusiness', type: 'select', label: 'Years in Business', options: ['1-2 years', '3-5 years', '5-10 years', '10+ years'] },
                { id: 'rebrandReason', type: 'textarea', label: 'Why are you rebranding?', required: true },
                { id: 'currentWebsite', type: 'text', label: 'Current Website', required: false }
            ],
            2: [
                { id: 'newDirection', type: 'textarea', label: 'Describe your new brand direction', required: true },
                { id: 'targetAudience', type: 'textarea', label: 'Target audience for the new brand', required: true },
                { id: 'brandPersonality', type: 'radio', label: 'New Brand Personality', options: [
                    { value: 'bold', title: 'Bold & Disruptive', desc: 'Stand out, challenge norms' },
                    { value: 'premium', title: 'Premium & Exclusive', desc: 'Luxury, high-end feel' },
                    { value: 'approachable', title: 'Friendly & Approachable', desc: 'Warm, welcoming, trustworthy' },
                    { value: 'innovative', title: 'Innovative & Future-forward', desc: 'Tech-savvy, cutting-edge' }
                ]}
            ],
            3: [
                { id: 'scope', type: 'textarea', label: 'What needs to be rebranded? (logo, website, social, signage, etc.)', required: true },
                { id: 'timeline', type: 'select', label: 'Desired Timeline', options: ['ASAP', '1 month', '2-3 months', 'Flexible'] },
                { id: 'keepElements', type: 'textarea', label: 'Any elements to keep from current brand?', required: false }
            ],
            4: [
                { id: 'files', type: 'file', label: 'Upload current brand assets and inspiration for new direction', accept: 'image/*,.pdf,.ai,.psd,.doc', multiple: true }
            ]
        }
    },
    'custom': {
        name: 'Custom Project',
        price: 0,
        steps: ['Project Info', 'Details', 'Budget', 'Upload', 'Review'],
        fields: {
            1: [
                { id: 'businessName', type: 'text', label: 'Business Name', required: true },
                { id: 'contactName', type: 'text', label: 'Your Name', required: true },
                { id: 'email', type: 'email', label: 'Email', required: true },
                { id: 'phone', type: 'tel', label: 'Phone', required: false }
            ],
            2: [
                { id: 'projectType', type: 'textarea', label: 'Describe your project', required: true },
                { id: 'goals', type: 'textarea', label: 'What do you want to achieve?', required: true },
                { id: 'timeline', type: 'select', label: 'Timeline', options: ['ASAP', '2 weeks', '1 month', '2-3 months', 'Flexible'] }
            ],
            3: [
                { id: 'budget', type: 'radio', label: 'Budget Range', options: [
                    { value: '1000-2500', title: '$1,000 - $2,500', desc: 'Small project scope' },
                    { value: '2500-5000', title: '$2,500 - $5,000', desc: 'Medium project scope' },
                    { value: '5000-10000', title: '$5,000 - $10,000', desc: 'Large project scope' },
                    { value: '10000+', title: '$10,000+', desc: 'Enterprise/Complex project' }
                ]}
            ],
            4: [
                { id: 'files', type: 'file', label: 'Upload any relevant files or references', accept: '*', multiple: true }
            ]
        }
    },
    'brand-kit': {
        name: 'Brand Kit',
        price: 1500,
        steps: ['Contact Info', 'Your Background', 'Brand Vision', 'Preferences', 'Review & Pay'],
        fields: {
            1: [
                { id: 'businessName', type: 'text', label: 'Business Name', required: true },
                { id: 'contactName', type: 'text', label: 'Your Name', required: true },
                { id: 'email', type: 'email', label: 'Email', required: true },
                { id: 'phone', type: 'tel', label: 'Phone', required: true },
                { id: 'industry', type: 'text', label: 'Industry/Niche', required: true }
            ],
            2: [
                { id: 'howDidYouHear', type: 'select', label: 'How did you hear about us?', options: ['Google Search', 'Instagram', 'Facebook', 'TikTok', 'LinkedIn', 'Referral from Friend', 'Referral from Client', 'Saw Our Work', 'Local Event', 'Other'] },
                { id: 'workedWithUsBefore', type: 'radio', label: 'Have you worked with us before?', options: [
                    { value: 'yes', title: 'Yes', desc: 'Returning client' },
                    { value: 'no', title: 'No', desc: 'First time' }
                ]},
                { id: 'socialMediaAccounts', type: 'textarea', label: 'Your Social Media Accounts', required: false, placeholder: '@instagram, /facebook, etc.' },
                { id: 'emailMarketing', type: 'radio', label: 'Do you currently do email marketing?', options: [
                    { value: 'yes', title: 'Yes', desc: 'Regular newsletters' },
                    { value: 'sometimes', title: 'Sometimes', desc: 'Occasional' },
                    { value: 'no', title: 'No', desc: 'Not yet' }
                ]}
            ],
            3: [
                { id: 'brandPersonality', type: 'radio', label: 'Brand Personality', options: [
                    { value: 'bold', title: 'Bold & Edgy', desc: 'Stand out, make a statement' },
                    { value: 'professional', title: 'Professional & Trust', desc: 'Reliable, established' },
                    { value: 'playful', title: 'Playful & Fun', desc: 'Energetic, approachable' },
                    { value: 'luxury', title: 'Luxury & Premium', desc: 'High-end, sophisticated' }
                ]},
                { id: 'brandValues', type: 'textarea', label: 'What 3 words describe your brand?', required: true }
            ],
            4: [
                { id: 'colorPrefs', type: 'textarea', label: 'Color preferences (or colors to avoid)', required: false },
                { id: 'competitors', type: 'textarea', label: 'Brands you admire (for inspiration)', required: false },
                { id: 'timeline', type: 'select', label: 'Desired Timeline', options: ['ASAP', '1 week', '2 weeks', 'Flexible'] }
            ]
        }
    },
    'product-brand': {
        name: 'Product Brand Identity',
        price: 4500,
        steps: ['Contact Info', 'Your Background', 'Product Details', 'Brand Direction', 'Deliverables', 'Review & Pay'],
        fields: {
            1: [
                { id: 'businessName', type: 'text', label: 'Business Name', required: true },
                { id: 'contactName', type: 'text', label: 'Your Name', required: true },
                { id: 'email', type: 'email', label: 'Email', required: true },
                { id: 'phone', type: 'tel', label: 'Phone', required: true }
            ],
            2: [
                { id: 'howDidYouHear', type: 'select', label: 'How did you hear about us?', options: ['Google Search', 'Instagram', 'Facebook', 'TikTok', 'LinkedIn', 'Referral from Friend', 'Referral from Client', 'Saw Our Work', 'Local Event', 'Other'] },
                { id: 'workedWithUsBefore', type: 'radio', label: 'Have you worked with us before?', options: [
                    { value: 'yes', title: 'Yes', desc: 'Returning client' },
                    { value: 'no', title: 'No', desc: 'First time' }
                ]},
                { id: 'socialMediaAccounts', type: 'textarea', label: 'Your Social Media Accounts', required: false, placeholder: '@instagram, /facebook, etc.' },
                { id: 'currentlyAdvertising', type: 'radio', label: 'Are you currently running paid ads?', options: [
                    { value: 'yes', title: 'Yes', desc: 'Facebook, Google, etc.' },
                    { value: 'no', title: 'No', desc: 'Organic only' }
                ]}
            ],
            3: [
                { id: 'productType', type: 'textarea', label: 'What products do you sell?', required: true },
                { id: 'targetMarket', type: 'textarea', label: 'Who is your target customer?', required: true },
                { id: 'salesChannels', type: 'textarea', label: 'Where do you sell? (online, retail, markets, etc.)', required: true }
            ],
            4: [
                { id: 'brandPersonality', type: 'radio', label: 'Brand Personality', options: [
                    { value: 'bold', title: 'Bold & Edgy', desc: 'Stand out on the shelf' },
                    { value: 'artisan', title: 'Artisan & Handcrafted', desc: 'Authentic, handmade feel' },
                    { value: 'modern', title: 'Modern & Clean', desc: 'Minimalist, contemporary' },
                    { value: 'luxury', title: 'Premium & Luxury', desc: 'High-end, exclusive' }
                ]},
                { id: 'colorPrefs', type: 'textarea', label: 'Color preferences', required: false }
            ],
            5: [
                { id: 'packagingNeeds', type: 'textarea', label: 'What packaging do you need? (labels, boxes, bags, etc.)', required: true },
                { id: 'merchNeeds', type: 'textarea', label: 'Merchandise needs (t-shirts, hats, uniforms, etc.)', required: false },
                { id: 'photoNeeds', type: 'radio', label: 'Do you need product photography?', options: [
                    { value: 'yes', title: 'Yes', desc: 'Include photo session' },
                    { value: 'no', title: 'No', desc: 'I have product photos' }
                ]}
            ]
        }
    },
    'service-brand': {
        name: 'Service Brand Identity',
        price: 3500,
        steps: ['Contact Info', 'Your Background', 'Business Details', 'Brand Direction', 'Deliverables', 'Review & Pay'],
        fields: {
            1: [
                { id: 'businessName', type: 'text', label: 'Business Name', required: true },
                { id: 'contactName', type: 'text', label: 'Your Name', required: true },
                { id: 'email', type: 'email', label: 'Email', required: true },
                { id: 'phone', type: 'tel', label: 'Phone', required: true }
            ],
            2: [
                { id: 'howDidYouHear', type: 'select', label: 'How did you hear about us?', options: ['Google Search', 'Instagram', 'Facebook', 'TikTok', 'LinkedIn', 'Referral from Friend', 'Referral from Client', 'Saw Our Work', 'Local Event', 'Other'] },
                { id: 'workedWithUsBefore', type: 'radio', label: 'Have you worked with us before?', options: [
                    { value: 'yes', title: 'Yes', desc: 'Returning client' },
                    { value: 'no', title: 'No', desc: 'First time' }
                ]},
                { id: 'socialMediaAccounts', type: 'textarea', label: 'Your Social Media Accounts', required: false, placeholder: '@instagram, /facebook, etc.' },
                { id: 'directMailers', type: 'radio', label: 'Do you use direct mail/mailers?', options: [
                    { value: 'yes', title: 'Yes', desc: 'Postcards, flyers' },
                    { value: 'no', title: 'No', desc: 'Digital only' }
                ]}
            ],
            3: [
                { id: 'serviceType', type: 'textarea', label: 'What services do you provide?', required: true },
                { id: 'targetAudience', type: 'textarea', label: 'Who is your ideal client?', required: true },
                { id: 'serviceArea', type: 'text', label: 'Service area (city, state, or national)', required: true }
            ],
            4: [
                { id: 'brandPersonality', type: 'radio', label: 'Brand Personality', options: [
                    { value: 'professional', title: 'Professional & Trusted', desc: 'Established, reliable' },
                    { value: 'friendly', title: 'Friendly & Approachable', desc: 'Warm, welcoming' },
                    { value: 'premium', title: 'Premium & Exclusive', desc: 'High-end service' },
                    { value: 'bold', title: 'Bold & Confident', desc: 'Stand out from competitors' }
                ]},
                { id: 'colorPrefs', type: 'textarea', label: 'Color preferences', required: false }
            ],
            5: [
                { id: 'printNeeds', type: 'radio', label: 'Do you need print design (banners, signs, decals)?', options: [
                    { value: 'yes', title: 'Yes', desc: 'Banners, yard signs, decals, posters' },
                    { value: 'no', title: 'No', desc: 'Not needed' }
                ]},
                { id: 'uniformNeeds', type: 'radio', label: 'Do you need uniforms designed?', options: [
                    { value: 'yes', title: 'Yes', desc: 'Polos, shirts, hats' },
                    { value: 'no', title: 'No', desc: 'Not needed' }
                ]},
                { id: 'additionalNeeds', type: 'textarea', label: 'Any other specific needs?', required: false }
            ]
        }
    },
    'landing-page': {
        name: 'Landing Page',
        price: 800,
        steps: ['Contact Info', 'Page Details', 'Design', 'Review & Pay'],
        fields: {
            1: [
                { id: 'businessName', type: 'text', label: 'Business Name', required: true },
                { id: 'contactName', type: 'text', label: 'Your Name', required: true },
                { id: 'email', type: 'email', label: 'Email', required: true },
                { id: 'phone', type: 'tel', label: 'Phone', required: true }
            ],
            2: [
                { id: 'pageGoal', type: 'radio', label: 'Page Goal', options: [
                    { value: 'leads', title: 'Capture Leads', desc: 'Email signups, contact forms' },
                    { value: 'sales', title: 'Sell Product/Service', desc: 'Direct sales page' },
                    { value: 'event', title: 'Event Registration', desc: 'Webinar, workshop, etc.' },
                    { value: 'launch', title: 'Coming Soon', desc: 'Pre-launch page' }
                ]},
                { id: 'headline', type: 'text', label: 'Main headline or offer', required: true },
                { id: 'callToAction', type: 'text', label: 'Call to action (Sign Up, Buy Now, etc.)', required: true }
            ],
            3: [
                { id: 'designStyle', type: 'radio', label: 'Design Style', options: [
                    { value: 'minimal', title: 'Clean & Minimal', desc: 'Simple, focused' },
                    { value: 'bold', title: 'Bold & High-energy', desc: 'Vibrant, attention-grabbing' },
                    { value: 'elegant', title: 'Elegant & Premium', desc: 'Sophisticated look' }
                ]},
                { id: 'inspiration', type: 'textarea', label: 'Links to landing pages you like', required: false }
            ]
        }
    },
    'business-website': {
        name: 'Business Website',
        price: 2500,
        steps: ['Contact Info', 'Website Goals', 'Pages & Features', 'Design', 'Review & Pay'],
        fields: {
            1: [
                { id: 'businessName', type: 'text', label: 'Business Name', required: true },
                { id: 'contactName', type: 'text', label: 'Your Name', required: true },
                { id: 'email', type: 'email', label: 'Email', required: true },
                { id: 'phone', type: 'tel', label: 'Phone', required: true },
                { id: 'currentWebsite', type: 'text', label: 'Current Website (if any)', required: false }
            ],
            2: [
                { id: 'websiteGoal', type: 'radio', label: 'Primary Goal', options: [
                    { value: 'leads', title: 'Generate Leads', desc: 'Contact forms, inquiries' },
                    { value: 'info', title: 'Showcase Services', desc: 'Portfolio, about, services' },
                    { value: 'booking', title: 'Book Appointments', desc: 'Scheduling system' },
                    { value: 'brand', title: 'Build Brand Presence', desc: 'Establish credibility' }
                ]},
                { id: 'targetAudience', type: 'textarea', label: 'Who are your website visitors?', required: true }
            ],
            3: [
                { id: 'pages', type: 'textarea', label: 'Pages needed (Home, About, Services, Contact, etc.)', required: true },
                { id: 'features', type: 'textarea', label: 'Special features (booking, gallery, blog, etc.)', required: false },
                { id: 'contentReady', type: 'radio', label: 'Do you have content ready?', options: [
                    { value: 'yes', title: 'Yes', desc: 'Text and images ready' },
                    { value: 'partial', title: 'Partially', desc: 'Some content needs work' },
                    { value: 'no', title: 'Need Help', desc: 'Will need content creation' }
                ]}
            ],
            4: [
                { id: 'designStyle', type: 'radio', label: 'Design Style', options: [
                    { value: 'minimal', title: 'Minimal & Clean', desc: 'Whitespace, simple' },
                    { value: 'bold', title: 'Bold & Dynamic', desc: 'Strong colors, impact' },
                    { value: 'elegant', title: 'Elegant & Refined', desc: 'Sophisticated, premium' }
                ]},
                { id: 'inspiration', type: 'textarea', label: 'Websites you like', required: false }
            ]
        }
    },
    'ecommerce': {
        name: 'E-Commerce Store',
        price: 4000,
        steps: ['Contact Info', 'Store Details', 'Products', 'Features', 'Review & Pay'],
        fields: {
            1: [
                { id: 'businessName', type: 'text', label: 'Business/Store Name', required: true },
                { id: 'contactName', type: 'text', label: 'Your Name', required: true },
                { id: 'email', type: 'email', label: 'Email', required: true },
                { id: 'phone', type: 'tel', label: 'Phone', required: true }
            ],
            2: [
                { id: 'platform', type: 'radio', label: 'Preferred Platform', options: [
                    { value: 'shopify', title: 'Shopify', desc: 'Best for most businesses' },
                    { value: 'woocommerce', title: 'WooCommerce', desc: 'WordPress-based' },
                    { value: 'unsure', title: 'Not Sure', desc: 'Help me decide' }
                ]},
                { id: 'productTypes', type: 'textarea', label: 'What products will you sell?', required: true }
            ],
            3: [
                { id: 'productCount', type: 'select', label: 'Number of Products', options: ['1-10', '11-25', '26-50', '50+'] },
                { id: 'hasProducts', type: 'radio', label: 'Do you have product photos?', options: [
                    { value: 'yes', title: 'Yes', desc: 'Ready to upload' },
                    { value: 'no', title: 'No', desc: 'Need photography' }
                ]}
            ],
            4: [
                { id: 'paymentMethods', type: 'textarea', label: 'Payment methods needed', required: true, placeholder: 'Stripe, PayPal, etc.' },
                { id: 'shippingNeeds', type: 'textarea', label: 'Shipping requirements', required: false },
                { id: 'additionalFeatures', type: 'textarea', label: 'Additional features needed', required: false }
            ]
        }
    },
    'webapp': {
        name: 'Custom Web Application',
        price: 0,
        steps: ['Contact Info', 'Project Overview', 'Features', 'Budget & Timeline', 'Review'],
        fields: {
            1: [
                { id: 'businessName', type: 'text', label: 'Business Name', required: true },
                { id: 'contactName', type: 'text', label: 'Your Name', required: true },
                { id: 'email', type: 'email', label: 'Email', required: true },
                { id: 'phone', type: 'tel', label: 'Phone', required: true }
            ],
            2: [
                { id: 'appType', type: 'radio', label: 'What type of web app?', options: [
                    { value: 'portal', title: 'Client Portal', desc: 'Secure login for clients' },
                    { value: 'booking', title: 'Booking System', desc: 'Appointments & scheduling' },
                    { value: 'dashboard', title: 'Dashboard/CRM', desc: 'Data management' },
                    { value: 'other', title: 'Other', desc: 'Custom application' }
                ]},
                { id: 'appDescription', type: 'textarea', label: 'Describe what you want the app to do', required: true }
            ],
            3: [
                { id: 'userTypes', type: 'textarea', label: 'Who will use this app?', required: true },
                { id: 'keyFeatures', type: 'textarea', label: 'List the key features needed', required: true },
                { id: 'integrations', type: 'textarea', label: 'Third-party integrations needed', required: false }
            ],
            4: [
                { id: 'budget', type: 'radio', label: 'Budget Range', options: [
                    { value: '5000-10000', title: '$5,000 - $10,000', desc: 'Simple web app' },
                    { value: '10000-25000', title: '$10,000 - $25,000', desc: 'Medium complexity' },
                    { value: '25000+', title: '$25,000+', desc: 'Complex application' }
                ]},
                { id: 'timeline', type: 'select', label: 'Desired Timeline', options: ['1-2 months', '2-3 months', '3-6 months', 'Flexible'] }
            ]
        }
    },
    'mvp-app': {
        name: 'MVP Mobile App',
        price: 8000,
        steps: ['Contact Info', 'App Concept', 'Features', 'Design', 'Review & Pay'],
        fields: {
            1: [
                { id: 'businessName', type: 'text', label: 'Business/App Name', required: true },
                { id: 'contactName', type: 'text', label: 'Your Name', required: true },
                { id: 'email', type: 'email', label: 'Email', required: true },
                { id: 'phone', type: 'tel', label: 'Phone', required: true }
            ],
            2: [
                { id: 'appPurpose', type: 'textarea', label: 'What problem does your app solve?', required: true },
                { id: 'targetUsers', type: 'textarea', label: 'Who is your target user?', required: true },
                { id: 'competitors', type: 'textarea', label: 'Similar apps in the market', required: false }
            ],
            3: [
                { id: 'coreFeatures', type: 'textarea', label: 'List 3-5 core features for the MVP', required: true },
                { id: 'platforms', type: 'radio', label: 'Platforms', options: [
                    { value: 'both', title: 'iOS & Android', desc: 'Cross-platform (recommended)' },
                    { value: 'ios', title: 'iOS Only', desc: 'iPhone/iPad' },
                    { value: 'android', title: 'Android Only', desc: 'Android devices' }
                ]}
            ],
            4: [
                { id: 'designStyle', type: 'radio', label: 'Design Style', options: [
                    { value: 'minimal', title: 'Clean & Minimal', desc: 'Simple, intuitive' },
                    { value: 'bold', title: 'Bold & Modern', desc: 'Eye-catching design' },
                    { value: 'playful', title: 'Fun & Playful', desc: 'Engaging, colorful' }
                ]},
                { id: 'inspiration', type: 'textarea', label: 'Apps you like for inspiration', required: false }
            ]
        }
    },
    'custom-app': {
        name: 'Custom Mobile App',
        price: 0,
        steps: ['Contact Info', 'App Vision', 'Features', 'Budget', 'Review'],
        fields: {
            1: [
                { id: 'businessName', type: 'text', label: 'Business/App Name', required: true },
                { id: 'contactName', type: 'text', label: 'Your Name', required: true },
                { id: 'email', type: 'email', label: 'Email', required: true },
                { id: 'phone', type: 'tel', label: 'Phone', required: true }
            ],
            2: [
                { id: 'appVision', type: 'textarea', label: 'Describe your app vision in detail', required: true },
                { id: 'targetUsers', type: 'textarea', label: 'Target users and use cases', required: true },
                { id: 'businessModel', type: 'textarea', label: 'How will the app make money?', required: false }
            ],
            3: [
                { id: 'allFeatures', type: 'textarea', label: 'List all features needed', required: true },
                { id: 'integrations', type: 'textarea', label: 'Third-party integrations', required: false },
                { id: 'platforms', type: 'radio', label: 'Platforms', options: [
                    { value: 'both', title: 'iOS & Android', desc: 'Maximum reach' },
                    { value: 'ios', title: 'iOS Only', desc: 'iPhone/iPad' },
                    { value: 'android', title: 'Android Only', desc: 'Android devices' }
                ]}
            ],
            4: [
                { id: 'budget', type: 'radio', label: 'Budget Range', options: [
                    { value: '15000-30000', title: '$15,000 - $30,000', desc: 'Standard app' },
                    { value: '30000-50000', title: '$30,000 - $50,000', desc: 'Complex app' },
                    { value: '50000+', title: '$50,000+', desc: 'Enterprise solution' }
                ]},
                { id: 'timeline', type: 'select', label: 'Timeline', options: ['2-3 months', '3-6 months', '6+ months', 'Flexible'] }
            ]
        }
    },
    'lead-funnel': {
        name: 'Lead Capture Funnel',
        price: 1200,
        steps: ['Contact Info', 'Funnel Goals', 'Lead Magnet', 'Review & Pay'],
        fields: {
            1: [
                { id: 'businessName', type: 'text', label: 'Business Name', required: true },
                { id: 'contactName', type: 'text', label: 'Your Name', required: true },
                { id: 'email', type: 'email', label: 'Email', required: true },
                { id: 'phone', type: 'tel', label: 'Phone', required: true }
            ],
            2: [
                { id: 'targetAudience', type: 'textarea', label: 'Who are you trying to attract?', required: true },
                { id: 'offer', type: 'textarea', label: 'What do you ultimately want to sell them?', required: true }
            ],
            3: [
                { id: 'leadMagnet', type: 'radio', label: 'Lead Magnet Type', options: [
                    { value: 'ebook', title: 'eBook/Guide', desc: 'PDF download' },
                    { value: 'checklist', title: 'Checklist/Template', desc: 'Quick-win resource' },
                    { value: 'video', title: 'Video Training', desc: 'Video content' },
                    { value: 'discount', title: 'Discount/Coupon', desc: 'Special offer' }
                ]},
                { id: 'leadMagnetTopic', type: 'text', label: 'Lead magnet topic/title', required: true }
            ]
        }
    },
    'sales-funnel': {
        name: 'Full Sales Funnel',
        price: 2500,
        steps: ['Contact Info', 'Offer Details', 'Funnel Structure', 'Review & Pay'],
        fields: {
            1: [
                { id: 'businessName', type: 'text', label: 'Business Name', required: true },
                { id: 'contactName', type: 'text', label: 'Your Name', required: true },
                { id: 'email', type: 'email', label: 'Email', required: true },
                { id: 'phone', type: 'tel', label: 'Phone', required: true }
            ],
            2: [
                { id: 'mainOffer', type: 'textarea', label: 'What is your main offer/product?', required: true },
                { id: 'pricePoint', type: 'text', label: 'Price point', required: true },
                { id: 'targetAudience', type: 'textarea', label: 'Target audience', required: true }
            ],
            3: [
                { id: 'funnelType', type: 'radio', label: 'Funnel Type', options: [
                    { value: 'tripwire', title: 'Tripwire Funnel', desc: 'Low-ticket to high-ticket' },
                    { value: 'webinar', title: 'Webinar Funnel', desc: 'Educate then sell' },
                    { value: 'vsl', title: 'VSL Funnel', desc: 'Video sales letter' },
                    { value: 'product', title: 'Product Launch', desc: 'Launch sequence' }
                ]},
                { id: 'upsells', type: 'textarea', label: 'Upsell/downsell offers (if any)', required: false }
            ]
        }
    },
    'webinar-funnel': {
        name: 'Webinar Funnel',
        price: 3000,
        steps: ['Contact Info', 'Webinar Details', 'Offer', 'Review & Pay'],
        fields: {
            1: [
                { id: 'businessName', type: 'text', label: 'Business Name', required: true },
                { id: 'contactName', type: 'text', label: 'Your Name', required: true },
                { id: 'email', type: 'email', label: 'Email', required: true },
                { id: 'phone', type: 'tel', label: 'Phone', required: true }
            ],
            2: [
                { id: 'webinarTopic', type: 'text', label: 'Webinar Topic/Title', required: true },
                { id: 'webinarType', type: 'radio', label: 'Webinar Type', options: [
                    { value: 'live', title: 'Live Webinar', desc: 'Real-time presentation' },
                    { value: 'evergreen', title: 'Evergreen/Automated', desc: 'Pre-recorded, runs automatically' }
                ]},
                { id: 'targetAudience', type: 'textarea', label: 'Who is this webinar for?', required: true }
            ],
            3: [
                { id: 'offer', type: 'textarea', label: 'What will you sell at the end?', required: true },
                { id: 'offerPrice', type: 'text', label: 'Offer price point', required: true },
                { id: 'bonuses', type: 'textarea', label: 'Bonuses to include', required: false }
            ]
        }
    },
    'consultation': {
        name: 'Free Strategy Call',
        price: 0,
        steps: ['Contact Info', 'Business Info', 'Goals', 'Schedule'],
        fields: {
            1: [
                { id: 'contactName', type: 'text', label: 'Your Name', required: true },
                { id: 'email', type: 'email', label: 'Email', required: true },
                { id: 'phone', type: 'tel', label: 'Phone', required: true }
            ],
            2: [
                { id: 'businessName', type: 'text', label: 'Business Name', required: true },
                { id: 'industry', type: 'text', label: 'Industry', required: true },
                { id: 'website', type: 'text', label: 'Current Website (if any)', required: false }
            ],
            3: [
                { id: 'goals', type: 'textarea', label: 'What do you want to achieve?', required: true },
                { id: 'budget', type: 'radio', label: 'Estimated Budget', options: [
                    { value: '1000-3000', title: '$1,000 - $3,000', desc: '' },
                    { value: '3000-5000', title: '$3,000 - $5,000', desc: '' },
                    { value: '5000-10000', title: '$5,000 - $10,000', desc: '' },
                    { value: '10000+', title: '$10,000+', desc: '' }
                ]},
                { id: 'timeline', type: 'select', label: 'When do you want to start?', options: ['Immediately', 'Within 2 weeks', 'Within 1 month', 'Just exploring'] }
            ]
        }
    },
    'custom-package': {
        name: 'Custom Package',
        price: 0,
        steps: ['Contact Info', 'Business Details', 'Confirm Services', 'Review & Pay'],
        fields: {
            1: [
                { id: 'contactName', type: 'text', label: 'Your Name', required: true },
                { id: 'email', type: 'email', label: 'Email', required: true },
                { id: 'phone', type: 'tel', label: 'Phone', required: true }
            ],
            2: [
                { id: 'businessName', type: 'text', label: 'Business Name', required: true },
                { id: 'industry', type: 'text', label: 'Industry', required: true },
                { id: 'website', type: 'text', label: 'Current Website (if any)', required: false },
                { id: 'additionalNotes', type: 'textarea', label: 'Anything else we should know?', required: false }
            ],
            3: [
                { id: 'servicesConfirm', type: 'custom-services-display', label: 'Your Selected Services' },
                { id: 'timeline', type: 'select', label: 'Desired Timeline', options: ['ASAP', '2-4 weeks', '1-2 months', 'Flexible'] }
            ]
        }
    }
};

// Form submissions storage
let formSubmissions = JSON.parse(localStorage.getItem('nui_submissions')) || [];
function saveSubmissions() { localStorage.setItem('nui_submissions', JSON.stringify(formSubmissions)); }

function startServiceIntake(serviceId) {
    const config = serviceIntakeConfigs[serviceId];
    if (!config) { alert('Service not found'); return; }

    // For custom package, get price from localStorage
    let price = config.price;
    let customServices = [];
    if (serviceId === 'custom-package') {
        price = parseInt(localStorage.getItem('customPackageTotal') || 0);
        customServices = JSON.parse(localStorage.getItem('customPackageServices') || '[]');
    }

    intakeData = { serviceId, serviceName: config.name, price: price, customServices: customServices };
    currentIntakeStep = 1;
    uploadedFiles = [];

    showView('intake');
    renderIntakeWizard(serviceId);
}

function renderIntakeWizard(serviceId) {
    const config = serviceIntakeConfigs[serviceId];
    const totalSteps = config.steps.length;
    const progressPercent = ((currentIntakeStep - 1) / (totalSteps - 1)) * 100;

    let stepsHtml = config.steps.map((step, i) => {
        const stepNum = i + 1;
        let className = 'wizard-step';
        if (stepNum < currentIntakeStep) className += ' completed';
        if (stepNum === currentIntakeStep) className += ' active';
        return `<div class="${className}"><div class="wizard-step-number">${stepNum < currentIntakeStep ? '✓' : stepNum}</div><div class="wizard-step-label">${step}</div></div>`;
    }).join('');

    let panelsHtml = '';
    for (let step = 1; step <= totalSteps; step++) {
        const isReview = step === totalSteps;
        const fields = config.fields[step] || [];

        panelsHtml += `<div class="wizard-panel ${step === currentIntakeStep ? 'active' : ''}" data-step="${step}">`;

        if (isReview) {
            panelsHtml += renderReviewStep(serviceId);
        } else {
            panelsHtml += `<h2 class="wizard-title">${config.steps[step-1]}</h2>`;
            panelsHtml += `<p class="wizard-subtitle">Step ${step} of ${totalSteps}</p>`;
            fields.forEach(field => {
                panelsHtml += renderIntakeField(field);
            });
        }

        panelsHtml += `<div class="wizard-buttons">`;
        if (step > 1) panelsHtml += `<button class="wizard-btn wizard-btn-back" onclick="prevIntakeStep()">← Back</button>`;
        if (isReview) {
            panelsHtml += `<button class="wizard-btn wizard-btn-submit" onclick="submitIntake()">Submit & Continue to Payment →</button>`;
        } else {
            panelsHtml += `<button class="wizard-btn wizard-btn-next" onclick="nextIntakeStep()">Continue →</button>`;
        }
        panelsHtml += `</div></div>`;
    }

    const displayPrice = intakeData.price || config.price;

    // Hormozi-style sales copy based on service type
    const salesCopy = {
        'brand-kit': {
            hook: "Stop losing customers to competitors with better branding.",
            problem: "Right now, potential customers are scrolling past your business because your brand looks DIY. They're choosing competitors who look more established — even if your product is better.",
            agitate: "Every day without professional branding costs you sales. People judge in 0.05 seconds. A weak brand = weak trust = lost revenue.",
            solution: "Get a complete brand identity that makes you look like the premium choice. Logo, colors, voice, social presence — everything you need to command higher prices and close more deals.",
            proof: "50+ Detroit businesses transformed. Average client sees 3x more engagement within 30 days."
        },
        'product-brand': {
            hook: "Your product deserves packaging that sells itself.",
            problem: "Great products fail every day because they look like every other option on the shelf. Customers can't tell you're different if you look the same.",
            agitate: "You're spending money on ads to drive people to products with forgettable packaging. That's like paying for a first date and showing up in pajamas.",
            solution: "Get packaging and branding that stops the scroll, wins the shelf, and turns browsers into buyers. From labels to social content — we build brands that print money.",
            proof: "Our product brands average 340% increase in online sales within 90 days."
        },
        'service-brand': {
            hook: "Charge more. Win more. Look like the obvious choice.",
            problem: "You're competing on price because your brand doesn't communicate value. Prospects are haggling with you while paying premium prices to competitors with better presentation.",
            agitate: "Every proposal you send with a generic logo and mismatched colors screams 'small operation.' And small operations get small budgets.",
            solution: "Get the brand presence that commands premium pricing. Banners, yard signs, vinyl decals, uniforms, professional collateral — look like the company that charges 2x more (then charge 2x more).",
            proof: "Service businesses we brand report 40% higher close rates on proposals."
        },
        'business-website': {
            hook: "Your website is either making you money or costing you money.",
            problem: "Your current site is a digital brochure that does nothing. Visitors come, see nothing compelling, and leave. No calls. No sales. Just a monthly hosting bill.",
            agitate: "You're paying for ads that send traffic to a website that doesn't convert. That's literally paying to lose customers.",
            solution: "Get a website built to convert visitors into customers 24/7. Strategic design, compelling copy, clear calls-to-action — every element engineered to generate leads while you sleep.",
            proof: "Average client sees 280% increase in website inquiries within 60 days."
        },
        'landing-page': {
            hook: "One page. One goal. Maximum conversions.",
            problem: "You're sending traffic to pages that confuse visitors. Too many options. No clear path. They leave without taking action.",
            agitate: "Every click you pay for that doesn't convert is money burned. Bad landing pages are the most expensive mistake in marketing.",
            solution: "Get a landing page engineered for one thing: conversions. Clear headline, compelling offer, irresistible call-to-action. Built to turn visitors into leads.",
            proof: "Our landing pages average 3-5x higher conversion rates than industry standard."
        },
        'ecommerce': {
            hook: "Stop losing sales to a clunky checkout process.",
            problem: "Your store looks like it was built in 2015. Customers add to cart then abandon because the experience feels sketchy.",
            agitate: "69% of carts get abandoned. Every friction point in your store is money walking out the door.",
            solution: "Get a store built for conversions. Fast load times, trust signals, seamless checkout — every element optimized to turn browsers into buyers.",
            proof: "E-commerce clients see average 40% reduction in cart abandonment within 30 days."
        },
        'lead-funnel': {
            hook: "Build a lead machine that works while you sleep.",
            problem: "You're chasing leads instead of attracting them. Cold calling, networking, hoping someone finds you. That's exhausting and unscalable.",
            agitate: "Your competitors have automated systems generating leads 24/7. You're still trading time for maybe-customers.",
            solution: "Get a lead funnel that captures, nurtures, and qualifies prospects automatically. Wake up to warm leads ready to buy.",
            proof: "Average funnel generates 50+ qualified leads per month on autopilot."
        },
        'sales-funnel': {
            hook: "Turn strangers into customers while you sleep.",
            problem: "You have a great offer but no system to sell it. Every sale requires your time, energy, and manual follow-up.",
            agitate: "You're the bottleneck in your own business. Can't scale what requires your presence to close.",
            solution: "Get a sales funnel that educates, builds trust, and closes deals automatically. A 24/7 salesperson that never takes a day off.",
            proof: "Our sales funnels average $50K+ in automated revenue per client annually."
        },
        'custom-package': {
            hook: "Get exactly what you need. Nothing you don't.",
            problem: "Cookie-cutter packages either give you too much or not enough. You're paying for services you don't need or missing critical pieces.",
            agitate: "One-size-fits-all doesn't fit anyone well. Your business is unique — your solution should be too.",
            solution: "Build a custom package with only the services that move your needle. Every dollar invested in exactly what you need.",
            proof: "Custom packages deliver 2x more value because every element is intentional."
        },
        'consultation': {
            hook: "15 minutes that could change your business.",
            problem: "You know something needs to change but you're not sure what. DIY hasn't worked. Generic advice doesn't apply.",
            agitate: "Every month you stay stuck is revenue left on the table. Your competitors aren't waiting.",
            solution: "Get a free strategy call with someone who's helped 50+ businesses break through. No pitch, just clarity on your next best move.",
            proof: "90% of strategy calls end with a clear action plan — whether you work with us or not."
        },
        'default': {
            hook: "Ready to stop blending in and start standing out?",
            problem: "Most businesses look exactly like their competitors. Same boring templates. Same forgettable presence. Same struggle to get noticed.",
            agitate: "In a world of infinite scroll, invisible = irrelevant. Every day your brand doesn't demand attention is a day your competitors are winning.",
            solution: "Get bold, strategic design that captures attention and converts it into revenue. We don't make things pretty — we make things profitable.",
            proof: "50+ brands elevated. $2M+ in client revenue generated. 100% Detroit-made."
        }
    };

    const copy = salesCopy[serviceId] || salesCopy['default'];

    document.getElementById('intakeView').innerHTML = `
<div class="intake-view">
<div class="intake-service-header">
<div class="intake-service-badge">Service Intake</div>
<div class="intake-service-name">${config.name}</div>
<div class="intake-service-price">${displayPrice > 0 ? '$' + displayPrice.toLocaleString() : 'Custom Quote'}</div>
</div>

            <!-- HORMOZI-STYLE SALES SECTION -->
<div style="max-width: 700px; margin: 0 auto 40px; padding: 0 20px;">
<div style="background: linear-gradient(135deg, rgba(255,59,48,0.1) 0%, rgba(0,0,0,0.3) 100%); border: 1px solid rgba(255,59,48,0.2); border-radius: 16px; padding: 32px; margin-bottom: 24px;">
<h2 style="font-size: 24px; font-weight: 900; margin-bottom: 16px; line-height: 1.3;">${copy.hook}</h2>
<p style="color: rgba(255,255,255,0.7); font-size: 15px; line-height: 1.7; margin-bottom: 16px;">${copy.problem}</p>
<p style="color: rgba(255,255,255,0.9); font-size: 15px; line-height: 1.7; margin-bottom: 16px; font-weight: 500;">${copy.agitate}</p>
<p style="color: #fff; font-size: 15px; line-height: 1.7; margin-bottom: 20px;"><strong style="color: var(--red);">The Solution:</strong> ${copy.solution}</p>
<div style="display: flex; align-items: center; gap: 12px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
<span style="font-size: 24px;">📈</span>
<p style="color: var(--red); font-size: 14px; font-weight: 600; margin: 0;">${copy.proof}</p>
</div>
</div>

                <!-- TRUST BADGES -->
<div style="display: flex; justify-content: center; gap: 24px; flex-wrap: wrap; margin-bottom: 24px;">
<div style="display: flex; align-items: center; gap: 8px; color: rgba(255,255,255,0.6); font-size: 13px;">
<span style="color: var(--red);">✓</span> 24-48hr Response
</div>
<div style="display: flex; align-items: center; gap: 8px; color: rgba(255,255,255,0.6); font-size: 13px;">
<span style="color: var(--red);">✓</span> Satisfaction Guaranteed
</div>
<div style="display: flex; align-items: center; gap: 8px; color: rgba(255,255,255,0.6); font-size: 13px;">
<span style="color: var(--red);">✓</span> Detroit-Based Team
</div>
</div>

<p style="text-align: center; color: rgba(255,255,255,0.5); font-size: 13px;">Complete this quick form and we'll get back to you within 24 hours with next steps.</p>
</div>

<div class="intake-wizard">
<div class="wizard-progress">
<div class="wizard-progress-fill" style="width: ${progressPercent}%"></div>
                    ${stepsHtml}
</div>
<div class="wizard-content">
                    ${panelsHtml}
</div>
</div>

            <!-- BOTTOM CLOSER -->
<div style="max-width: 600px; margin: 40px auto 0; padding: 24px; text-align: center; border-top: 1px solid rgba(255,255,255,0.06);">
<p style="color: rgba(255,255,255,0.5); font-size: 13px; margin-bottom: 8px;">Still have questions?</p>
<p style="color: rgba(255,255,255,0.8); font-size: 14px;">Call or text: <a href="tel:+12484878747" style="color: var(--red); text-decoration: none; font-weight: 600;">(248) 487-8747</a></p>
</div>
</div>
    `;

    // Restore saved data
    Object.keys(intakeData).forEach(key => {
        const input = document.getElementById(key);
        if (input && intakeData[key]) {
            if (input.type === 'radio') {
                document.querySelector(`input[name="${key}"][value="${intakeData[key]}"]`)?.click();
            } else {
                input.value = intakeData[key];
            }
        }
    });
}

function renderIntakeField(field) {
    let html = `<div class="wizard-field">`;
    html += `<label class="wizard-label">${field.label}${field.required ? ' *' : ''}</label>`;

    switch(field.type) {
        case 'text':
        case 'email':
        case 'tel':
            html += `<input type="${field.type}" id="${field.id}" class="wizard-input" ${field.required ? 'required' : ''} onchange="saveIntakeField('${field.id}', this.value)">`;
            break;
        case 'textarea':
            html += `<textarea id="${field.id}" class="wizard-textarea" ${field.required ? 'required' : ''} placeholder="${field.placeholder || ''}" onchange="saveIntakeField('${field.id}', this.value)"></textarea>`;
            break;
        case 'select':
            html += `<select id="${field.id}" class="wizard-select" onchange="saveIntakeField('${field.id}', this.value)">
<option value="">Select...</option>
                ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
</select>`;
            break;
        case 'radio':
            html += `<div class="wizard-radio-group">`;
            field.options.forEach(opt => {
                html += `<label class="wizard-radio" onclick="selectRadio(this, '${field.id}', '${opt.value}')">
<input type="radio" name="${field.id}" value="${opt.value}">
<div class="wizard-radio-check"></div>
<div class="wizard-radio-content">
<h4>${opt.title}</h4>
<p>${opt.desc}</p>
</div>
</label>`;
            });
            html += `</div>`;
            break;
        case 'file':
            html += `<div class="file-upload-zone" onclick="document.getElementById('${field.id}').click()" ondragover="event.preventDefault(); this.classList.add('dragover')" ondragleave="this.classList.remove('dragover')" ondrop="handleFileDrop(event, '${field.id}')">
<div class="file-upload-icon">📁</div>
<div class="file-upload-text">Click to upload or drag & drop</div>
<div class="file-upload-hint">Supports: ${field.accept}</div>
<input type="file" id="${field.id}" class="file-upload-input" ${field.multiple ? 'multiple' : ''} accept="${field.accept}" onchange="handleFileSelect(this)">
</div>
<div class="uploaded-files" id="${field.id}-list"></div>`;
            break;
        case 'custom-services-display':
            const savedServices = JSON.parse(localStorage.getItem('customPackageServices') || '[]');
            const savedTotal = localStorage.getItem('customPackageTotal') || 0;
            html += `<div class="custom-services-review" style="background: #0a0a0a; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 24px;">
<div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">
                    ${savedServices.map(s => `<span style="background: rgba(255,59,48,0.15); border: 1px solid rgba(255,59,48,0.3); color: #fff; font-size: 12px; padding: 8px 14px; border-radius: 6px; font-weight: 600;">${s}</span>`).join('')}
</div>
<div style="display: flex; justify-content: space-between; align-items: center; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.06);">
<span style="color: var(--gray); font-size: 14px;">${savedServices.length} services selected</span>
<span style="font-size: 28px; font-weight: 900; color: var(--red);">$${parseInt(savedTotal).toLocaleString()}</span>
</div>
</div>`;
            break;
    }

    html += `</div>`;
    return html;
}

function selectRadio(el, fieldId, value) {
    document.querySelectorAll(`[name="${fieldId}"]`).forEach(r => r.closest('.wizard-radio').classList.remove('selected'));
    el.classList.add('selected');
    el.querySelector('input').checked = true;
    saveIntakeField(fieldId, value);
}

function saveIntakeField(fieldId, value) {
    intakeData[fieldId] = value;
}

function handleFileSelect(input) {
    Array.from(input.files).forEach(file => {
        uploadedFiles.push(file);
        renderUploadedFiles(input.id);
    });
}

function handleFileDrop(event, inputId) {
    event.preventDefault();
    event.target.classList.remove('dragover');
    Array.from(event.dataTransfer.files).forEach(file => {
        uploadedFiles.push(file);
    });
    renderUploadedFiles(inputId);
}

function renderUploadedFiles(inputId) {
    const container = document.getElementById(inputId + '-list');
    if (!container) return;
    container.innerHTML = uploadedFiles.map((file, i) =>
        `<div class="uploaded-file"><span>${file.name}</span><span class="uploaded-file-remove" onclick="removeFile(${i}, '${inputId}')">×</span></div>`
    ).join('');
}

function removeFile(index, inputId) {
    uploadedFiles.splice(index, 1);
    renderUploadedFiles(inputId);
}

function nextIntakeStep() {
    const config = serviceIntakeConfigs[intakeData.serviceId];
    if (currentIntakeStep < config.steps.length) {
        currentIntakeStep++;
        renderIntakeWizard(intakeData.serviceId);
    }
}

function prevIntakeStep() {
    if (currentIntakeStep > 1) {
        currentIntakeStep--;
        renderIntakeWizard(intakeData.serviceId);
    }
}

function renderReviewStep(serviceId) {
    const config = serviceIntakeConfigs[serviceId];
    const displayPrice = intakeData.price || config.price;

    // Service descriptions for each package
    const serviceDescriptions = {
        'brand-kit': {
            title: 'Brand Kit Package',
            description: 'Complete brand identity foundation including logo design, brand voice guidelines, target market identifier, social media banners, and logo-in-action images.',
            deliverables: ['Logo (multiple formats)', 'Brand Voice Document', 'Target Market Profile', 'Social Media Banners', 'Logo In Action Images'],
            timeline: '7-10 business days'
        },
        'product-brand': {
            title: 'Product Brand Identity',
            description: 'Premium branding for physical products including packaging design, product photography direction, label design, and complete visual identity system.',
            deliverables: ['Full Brand Kit', 'Packaging Design', 'Product Label Design', 'Photography Guidelines', 'Marketing Collateral'],
            timeline: '14-21 business days'
        },
        'service-brand': {
            title: 'Service Brand Identity',
            description: 'Professional brand identity for service-based businesses including digital presence optimization, proposal templates, and client-facing materials.',
            deliverables: ['Full Brand Kit', 'Business Card Design', 'Proposal Templates', 'Email Signature', 'Social Media Kit'],
            timeline: '10-14 business days'
        },
        'landing-page': {
            title: 'Landing Page Website',
            description: 'High-converting single-page website optimized for lead generation with mobile responsiveness and basic SEO setup.',
            deliverables: ['Custom Landing Page', 'Mobile Optimization', 'Contact Form', 'Basic SEO', 'Analytics Setup'],
            timeline: '5-7 business days'
        },
        'business-website': {
            title: 'Business Website',
            description: 'Professional multi-page website with up to 5 pages, CMS integration, and full SEO optimization for established businesses.',
            deliverables: ['5-Page Website', 'CMS Dashboard', 'SEO Optimization', 'Contact Forms', 'Blog Setup'],
            timeline: '14-21 business days'
        },
        'ecommerce': {
            title: 'E-Commerce Website',
            description: 'Full-featured online store with product management, secure payments, inventory tracking, and marketing integrations.',
            deliverables: ['Online Store', 'Payment Gateway', 'Product Management', 'Order Tracking', 'Marketing Tools'],
            timeline: '21-30 business days'
        },
        'lead-funnel': {
            title: 'Lead Generation Funnel',
            description: 'Strategic sales funnel designed to capture and nurture leads with automated email sequences and tracking.',
            deliverables: ['Landing Page', 'Lead Magnet', 'Email Sequence (5)', 'Thank You Page', 'Analytics Dashboard'],
            timeline: '7-10 business days'
        },
        'sales-funnel': {
            title: 'Full Sales Funnel',
            description: 'Complete sales system with multiple touchpoints, upsells, downsells, and comprehensive automation for maximum conversions.',
            deliverables: ['Multi-Page Funnel', 'Upsell/Downsell Pages', 'Email Sequence (10+)', 'Payment Integration', 'A/B Testing'],
            timeline: '14-21 business days'
        },
        'custom-package': {
            title: 'Custom Package',
            description: 'Tailored solution built from our service catalog to match your exact business needs and budget.',
            deliverables: intakeData.customServices || ['Custom deliverables based on selection'],
            timeline: 'Varies by scope'
        },
        'consultation': {
            title: 'Free Strategy Call',
            description: 'No-obligation discovery call to discuss your business goals and find the perfect solution for your needs.',
            deliverables: ['30-Minute Call', 'Needs Assessment', 'Custom Recommendations', 'Project Roadmap'],
            timeline: 'Scheduled within 48 hours'
        }
    };

    const serviceInfo = serviceDescriptions[serviceId] || {
        title: config.name,
        description: 'Professional creative services from New Urban Influence.',
        deliverables: ['Custom deliverables'],
        timeline: 'To be determined'
    };

    let html = `<h2 class="wizard-title">Review Your Information</h2>`;
    html += `<p class="wizard-subtitle">Please review before submitting</p>`;

    // SERVICE DESCRIPTION BOX
    html += `<div style="background: linear-gradient(135deg, rgba(255,59,48,0.08) 0%, rgba(0,0,0,0.2) 100%); border: 1px solid rgba(255,59,48,0.15); border-radius: 20px; padding: 28px; margin-bottom: 24px;">`;
    html += `<div style="background: linear-gradient(135deg, var(--red) 0%, #ff6b6b 100%); border-radius: 14px; padding: 18px 24px; margin-bottom: 24px; box-shadow: 0 10px 35px rgba(255,59,48,0.35);">
<div style="display: flex; align-items: center; gap: 14px;">
<span style="font-size: 26px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));">🎯</span>
<h3 style="font-size: 24px; font-weight: 900; color: #fff; margin: 0; text-shadow: 0 2px 10px rgba(0,0,0,0.25); letter-spacing: -0.5px;">${serviceInfo.title}</h3>
</div>
 </div>`;
    html += `<p style="color: rgba(255,255,255,0.7); font-size: 14px; line-height: 1.6; margin-bottom: 20px;">${serviceInfo.description}</p>`;

    // Deliverables list
    html += `<div style="margin-bottom: 16px;">
<p style="color: rgba(255,255,255,0.5); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;">What You'll Get:</p>
<div style="display: flex; flex-wrap: wrap; gap: 8px;">
            ${serviceInfo.deliverables.map(d => `<span style="background: rgba(255,255,255,0.1); color: #fff; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 500; border: 1px solid rgba(255,255,255,0.1);">${d}</span>`).join('')}
</div>
 </div>`;

    html += `<div style="display: flex; align-items: center; gap: 8px; color: rgba(255,255,255,0.6); font-size: 13px;">
<span>⏱️</span> Expected Timeline: <strong style="color: #fff;">${serviceInfo.timeline}</strong>
 </div>`;
    html += `</div>`;

    // YOUR DETAILS BOX
    html += `<div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 24px; margin-bottom: 24px;">`;
    html += `<p style="color: rgba(255,255,255,0.5); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 16px;">Your Details</p>`;

    html += `<div style="display: flex; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid rgba(255,255,255,0.08);">
<span style="color: rgba(255,255,255,0.5);">Service</span>
<span style="font-weight: 600; color: #fff;">${config.name}</span>
 </div>`;

    // Show custom services if this is a custom package
    if (serviceId === 'custom-package' && intakeData.customServices && intakeData.customServices.length > 0) {
        html += `<div style="padding: 14px 0; border-bottom: 1px solid rgba(255,255,255,0.08);">
<span style="color: rgba(255,255,255,0.5); display: block; margin-bottom: 10px;">Selected Services (${intakeData.customServices.length})</span>
<div style="display: flex; flex-wrap: wrap; gap: 6px;">
                ${intakeData.customServices.map(s => `<span style="background: rgba(255,255,255,0.1); color: #fff; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 500;">${s}</span>`).join('')}
</div>
</div>`;
    }

    html += `<div style="display: flex; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid rgba(255,255,255,0.08);">
<span style="color: rgba(255,255,255,0.5);">Investment</span>
<span style="font-weight: 700; color: var(--red); font-size: 18px;">${displayPrice > 0 ? '$' + displayPrice.toLocaleString() : 'Custom Quote'}</span>
 </div>`;

    Object.keys(intakeData).forEach(key => {
        if (key !== 'serviceId' && key !== 'serviceName' && key !== 'price' && key !== 'customServices' && intakeData[key]) {
            const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
            let value = intakeData[key];
            if (Array.isArray(value)) return; // Skip arrays (shown separately)
            html += `<div style="display: flex; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid rgba(255,255,255,0.08);">
<span style="color: rgba(255,255,255,0.5);">${label}</span>
<span style="font-weight: 500; color: #fff; max-width: 60%; text-align: right;">${value}</span>
</div>`;
        }
    });

    if (uploadedFiles.length > 0) {
        html += `<div style="padding: 14px 0;">
<span style="color: rgba(255,255,255,0.5);">Files Attached</span>
<div style="margin-top: 10px;">${uploadedFiles.map(f => `<span style="display: inline-block; background: rgba(255,255,255,0.1); color: #fff; padding: 6px 14px; border-radius: 6px; margin: 4px; font-size: 13px;">📎 ${f.name}</span>`).join('')}</div>
</div>`;
    }

    html += `</div>`;

    // WHAT HAPPENS NEXT BOX - Different messaging based on service type
    if (serviceId === 'consultation') {
        html += `<div style="background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3); border-radius: 12px; padding: 20px; margin-bottom: 16px;">
<strong style="color: var(--green); display: flex; align-items: center; gap: 8px;"><span>✨</span> What happens next?</strong>
<p style="color: rgba(255,255,255,0.7); margin-top: 10px; font-size: 14px; line-height: 1.6;">After submitting, you'll receive an email with a link to schedule your free strategy call. We'll discuss your project and find the perfect solution for your business.</p>
</div>`;
    } else if (displayPrice > 0) {
        html += `<div style="background: rgba(255,59,48,0.1); border: 1px solid rgba(255,59,48,0.2); border-radius: 12px; padding: 20px; margin-bottom: 16px;">
<strong style="color: var(--red); display: flex; align-items: center; gap: 8px;"><span>🚀</span> What happens next?</strong>
<p style="color: rgba(255,255,255,0.7); margin-top: 10px; font-size: 14px; line-height: 1.6;">After submitting, you'll be redirected to complete your payment. Once payment is received, our team will review your submission and reach out within 24-48 hours to kick off your project.</p>
</div>`;
    } else {
        html += `<div style="background: rgba(234,179,8,0.1); border: 1px solid rgba(234,179,8,0.3); border-radius: 12px; padding: 20px; margin-bottom: 16px;">
<strong style="color: #fbbf24; display: flex; align-items: center; gap: 8px;"><span>📋</span> What happens next?</strong>
<p style="color: rgba(255,255,255,0.7); margin-top: 10px; font-size: 14px; line-height: 1.6;">After submitting, our team will review your requirements and send you a custom quote within 24-48 hours. We'll then schedule a call to discuss your project in detail.</p>
</div>`;
    }

    return html;
}

async function submitIntake() {
    const config = serviceIntakeConfigs[intakeData.serviceId];
    const submission = {
        id: Date.now(),
        ...intakeData,
        files: uploadedFiles.map(f => f.name),
        submittedAt: new Date().toISOString(),
        status: 'pending_payment'
    };

    // Save locally first (always works)
    formSubmissions.push(submission);
    saveSubmissions();

    // Create lead from submission (local)
    const newLead = {
        id: Date.now() + 1,
        name: intakeData.contactName || intakeData.clientName || intakeData.businessName,
        email: intakeData.email || '',
        phone: intakeData.phone || intakeData.clientPhone || '',
        business: intakeData.businessName,
        service: config.name,
        budget: config.price > 0 ? '$' + config.price.toLocaleString() : 'Custom',
        message: intakeData.projectType || intakeData.brandStory || '',
        status: 'new',
        createdAt: new Date().toISOString()
    };
    leads.push(newLead);
    saveLeads();

    // Trigger workflow: Add to pipeline and email subscribers
    triggerNewLead(newLead.id);

    // Save to Supabase (async — don't block the UI)
    try {
        const resp = await fetch('/.netlify/functions/save-submission', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                serviceId: intakeData.serviceId,
                serviceName: config.name,
                price: intakeData.price || config.price,
                contactName: intakeData.contactName || intakeData.clientName,
                email: intakeData.email,
                phone: intakeData.phone || intakeData.clientPhone,
                businessName: intakeData.businessName,
                industry: intakeData.industry,
                website: intakeData.website,
                ...intakeData
            })
        });
        const result = await resp.json();
        if (result.success) {
            console.log('✅ Submission saved to Supabase:', result.submission?.id);
            // Store the server submission ID so we can link it to a meeting later
            submission.serverId = result.submission?.id;
            intakeData.submissionId = result.submission?.id;
            if (result.emailSent) {
                console.log('📧 Confirmation email sent to client');
            }
        }
    } catch (err) {
        console.log('Server save failed (saved locally):', err.message);
    }

    // Show success and redirect to payment
    showPaymentPage(submission);
}

function showPaymentPage(submission) {
    const config = serviceIntakeConfigs[submission.serviceId];

    document.getElementById('intakeView').innerHTML = `
<div class="intake-view" style="min-height: 100vh; display: flex; align-items: center; justify-content: center;">
<div class="wizard-content" style="max-width: 600px; text-align: center;">
<div class="success-icon" style="width: 100px; height: 100px; background: linear-gradient(135deg, var(--green), #34d399); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 48px; color: white; box-shadow: 0 20px 60px rgba(16,185,129,0.4);">✓</div>
<h2 class="success-title">Submission Received!</h2>
<p class="success-message">Thank you for choosing New Urban Influence. A confirmation email has been sent with your project details.</p>

<div class="success-details">
<div class="success-detail">
<span class="success-detail-label">Service</span>
<span class="success-detail-value">${config.name}</span>
</div>
<div class="success-detail">
<span class="success-detail-label">Reference #</span>
<span class="success-detail-value">NUI-${submission.id}</span>
</div>
<div class="success-detail">
<span class="success-detail-label">Amount Due</span>
<span class="success-detail-value" style="color: var(--red);">${config.price > 0 ? '$' + config.price.toLocaleString() : 'Quote Pending'}</span>
</div>
</div>

                ${config.price > 0 ? `
<div style="margin-bottom: 32px;">
<p style="color: rgba(255,255,255,0.6); margin-bottom: 20px; font-size: 15px;">Complete your payment to start your project:</p>
<a href="https://buy.stripe.com/test" target="_blank" class="btn-cta" style="padding: 20px 48px; font-size: 18px; display: inline-flex; background: linear-gradient(135deg, var(--green) 0%, #34d399 100%); box-shadow: 0 8px 30px rgba(16,185,129,0.4);">
                        Pay $${config.price.toLocaleString()} with Stripe →
</a>
<p style="color: rgba(255,255,255,0.4); font-size: 13px; margin-top: 16px;">🔒 Secure payment powered by Stripe</p>
</div>
                ` : `
<div style="margin-bottom: 32px;">
<p style="color: rgba(255,255,255,0.6); margin-bottom: 16px; font-size: 15px;">Our team will prepare a custom quote and contact you within 24 hours.</p>
</div>
                `}

<div style="padding-top: 28px; border-top: 1px solid rgba(255,255,255,0.1);">
<p style="color: rgba(255,255,255,0.5); font-size: 14px; margin-bottom: 20px; line-height: 1.8;">
<strong style="color: #fff;">Next Steps:</strong><br>
                        1. Complete payment (if applicable)<br>
                        2. Receive project kickoff email<br>
                        3. Schedule strategy call with your creative team
</p>
<button onclick="showView('home')" class="btn-outline" style="color: #fff; border-color: rgba(255,255,255,0.3); padding: 16px 32px;">Back to Home</button>
</div>
</div>
</div>
    `;
}

// ==================== ENHANCED BRAND PORTAL ====================
function loadEnhancedBrandPortal(client) {
    // Find latest approved brand guide for this client
    const clientBrandGuide = proofs.filter(p => p.type === 'brandguide' && p.clientId == client.id && (p.status === 'approved' || p.status === 'delivered')).sort((a,b) => (b.id || 0) - (a.id || 0))[0];

    // Use brand guide data if available, otherwise fall back to client data
    const useGuide = clientBrandGuide ? true : false;

    const primaryColor = (useGuide && clientBrandGuide.brandColors?.[0]) || client.colors?.[0] || '#ff0000';
    const secondaryColor = (useGuide && clientBrandGuide.brandColors?.[1]) || client.colors?.[1] || '#000000';

    // Prepare the data source
    const dataSource = useGuide ? clientBrandGuide : client;

    document.getElementById('clientPortal').style.setProperty('--client-primary', primaryColor);
    document.getElementById('clientPortal').style.setProperty('--client-secondary', secondaryColor);

    document.getElementById('clientPortal').innerHTML = `
        <!-- Back Navigation Bar -->
<div class="portal-nav-bar" style="background: rgba(0,0,0,0.9); padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100;">
<button onclick="goBackFromPortal()" class="portal-back-btn" style="display: flex; align-items: center; gap: 8px; background: none; border: none; color: #fff; cursor: pointer; font-size: 16px; padding: 8px 16px; border-radius: 8px; transition: background 0.2s;">
<span style="font-size: 20px;">←</span> Back
</button>
<span style="color: #888; font-size: 14px;">${client.name} Brand Portal</span>
            ${currentUser?.type === 'admin' ? `<button onclick="backToAdmin()" style="background: var(--accent); color: #000; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;">Admin Dashboard</button>` : '<div></div>'}
</div>

<div class="brand-portal-header" style="background: linear-gradient(135deg, ${primaryColor} 0%, ${secondaryColor} 100%);">
            ${(useGuide && clientBrandGuide.logo) || client.logo ? `<img loading="lazy" src="${(useGuide && clientBrandGuide.logo) || client.logo}" class="brand-portal-logo" alt="${client.name}">` : `<div style="font-size: 48px; font-weight: 900;">${client.name}</div>`}
<h2 class="brand-portal-title">${client.name} Brand Portal</h2>
<p class="brand-portal-subtitle">Your complete brand identity system</p>
</div>

        <!-- LOGO SECTION -->
<div class="brand-section">
<div class="brand-section-header">
<h2 class="brand-section-title">Logo Suite</h2>
<button class="brand-download-all" onclick="downloadAllLogos()">📥 Download All</button>
</div>
<div class="logo-grid">
                ${renderLogoCards(dataSource, useGuide)}
</div>
</div>

        <!-- COLOR PALETTE -->
<div class="brand-section">
<div class="brand-section-header">
<h2 class="brand-section-title">Color Palette</h2>
</div>
<div class="color-palette">
                ${renderColorSwatches(dataSource, useGuide)}
</div>
</div>

        <!-- TYPOGRAPHY -->
<div class="brand-section">
<div class="brand-section-header">
<h2 class="brand-section-title">Typography</h2>
</div>
<div class="typography-showcase">
                ${renderTypography(dataSource, useGuide)}
</div>
</div>

        <!-- BRAND ELEMENTS -->
<div class="brand-section">
<div class="brand-section-header">
<h2 class="brand-section-title">Brand Elements</h2>
</div>
<div class="elements-grid">
                ${renderBrandElements(client)}
</div>
</div>

        <!-- MOCKUPS -->
<div class="brand-section">
<div class="brand-section-header">
<h2 class="brand-section-title">Brand Mockups</h2>
</div>
<div class="mockups-grid">
                ${renderMockups(dataSource, useGuide)}
</div>
</div>

<div style="padding: 40px; text-align: center; background: #f5f5f5;">
<p style="color: #888; margin-bottom: 16px;">Need updates to your brand assets?</p>
<button onclick="showView('intake');" class="btn-cta">Contact NUI</button>
            ${currentUser?.type === 'admin' ? `<button onclick="backToAdmin()" class="btn-outline" style="margin-left: 16px; color: #000; border-color: #000;">Back to Admin</button>` : ''}
</div>
    `;
}

function renderLogoCards(data, useGuide) {
    const primaryLogo = useGuide ? data.logo : data.logo;
    const secondaryLogo = useGuide ? data.secondaryLogo : null;
    const iconMark = useGuide ? data.iconMark : null;

    const logos = [
        { name: 'Primary Logo', image: primaryLogo, desc: 'Full color' },
        ...(secondaryLogo ? [{ name: 'Secondary Logo', image: secondaryLogo, desc: 'Alternate version' }] : []),
        ...(iconMark ? [{ name: 'Icon / Mark', image: iconMark, desc: 'Symbol only' }] : [])
    ];

    return logos.map(logo => `
<div class="logo-card">
<div class="logo-preview light-bg">
                ${logo.image ? `<img loading="lazy" src="${logo.image}" alt="${logo.name}">` : `<div style="font-size: 36px; font-weight: 900; color: #000;">Logo</div>`}
</div>
<div class="logo-info">
<div>
<div class="logo-name">${logo.name}</div>
<div class="logo-format">${logo.desc}</div>
</div>
<button class="logo-download" onclick="alert('Download ${logo.name}')">↓ PNG</button>
</div>
</div>
    `).join('');
}

function renderColorSwatches(data, useGuide) {
    const colors = (useGuide && data.brandColors) || data.colors || ['#ff0000', '#000000', '#ffffff'];
    const colorNames = ['Primary', 'Secondary', 'Accent', 'Background', 'Text'];

    return colors.map((color, i) => `
<div class="color-swatch" style="background: ${color};">
<button class="color-copy" onclick="copyColor('${color}')">Copy</button>
<div class="color-info">
<div class="color-name">${colorNames[i] || 'Color ' + (i+1)}</div>
<div class="color-hex">${color.toUpperCase()}</div>
</div>
</div>
    `).join('');
}

function copyColor(hex) {
    navigator.clipboard.writeText(hex);
    alert('Copied: ' + hex);
}

function renderTypography(data, useGuide) {
    let headingFont, bodyFont;
    if (useGuide) {
        headingFont = data.fonts?.primary || 'Inter';
        bodyFont = data.fonts?.secondary || 'Inter';
    } else {
        headingFont = data.fonts?.heading || 'Inter';
        bodyFont = data.fonts?.body || 'Inter';
    }

    return `
<div class="typography-card">
<div class="typography-label">Heading Font</div>
<div class="typography-preview" style="font-family: '${headingFont}', sans-serif;">
<h2>Aa Bb Cc</h2>
<p style="font-size: 14px; margin-top: 8px;">${headingFont}</p>
</div>
<div class="typography-specimen">
<span>ABCDEFGHIJKLMNOPQRSTUVWXYZ</span>
<span>abcdefghijklmnopqrstuvwxyz</span>
<span>0123456789</span>
</div>
<div class="typography-download">
<span style="flex: 1;">${headingFont} Font Family</span>
<button class="typography-download-btn" onclick="alert('Download font files')">Download</button>
</div>
</div>
<div class="typography-card">
<div class="typography-label">Body Font</div>
<div class="typography-preview" style="font-family: '${bodyFont}', sans-serif;">
<p>The quick brown fox jumps over the lazy dog. Pack my box with five dozen liquor jugs.</p>
</div>
<div class="typography-specimen">
<span>Regular 400</span>
<span>Medium 500</span>
<span>Semibold 600</span>
<span>Bold 700</span>
</div>
<div class="typography-download">
<span style="flex: 1;">${bodyFont} Font Family</span>
<button class="typography-download-btn" onclick="alert('Download font files')">Download</button>
</div>
</div>
    `;
}

function renderBrandElements(client) {
    const elements = ['Pattern', 'Icon Set', 'Texture', 'Divider', 'Badge', 'Stamp'];
    return elements.map(el => `
<div class="element-card">
<div class="element-preview">
<div style="color: #888; font-size: 32px;">◇</div>
</div>
<div class="element-info">
<div class="element-name">${el}</div>
<div class="element-actions">
<button class="element-btn" onclick="alert('Download ${el}')">PNG</button>
<button class="element-btn" onclick="alert('Download ${el}')">SVG</button>
</div>
</div>
</div>
    `).join('');
}

function renderMockups(data, useGuide) {
    let mockupImages = [];

    if (useGuide && data.mockups && data.mockups.length > 0) {
        mockupImages = data.mockups.map((img, i) => ({ name: 'Mockup ' + (i+1), img: img }));
    } else {
        mockupImages = [
            { name: 'Business Card', img: 'https://via.placeholder.com/400x240/1a1a1a/ffffff?text=Business+Card' },
            { name: 'Letterhead', img: 'https://via.placeholder.com/400x240/1a1a1a/ffffff?text=Letterhead' },
            { name: 'Social Media', img: 'https://via.placeholder.com/400x240/1a1a1a/ffffff?text=Social+Media' },
            { name: 'Website Preview', img: 'https://via.placeholder.com/400x240/1a1a1a/ffffff?text=Website' }
        ];
    }

    return mockupImages.map(m => `
<div class="mockup-card">
<img loading="lazy" src="${m.img}" class="mockup-image" alt="${m.name}">
<div class="mockup-info">
<span class="mockup-name">${m.name}</span>
<button class="mockup-download" onclick="alert('Download ${m.name}')">Download</button>
</div>
</div>
    `).join('');
}

function downloadAllLogos() {
    alert('Downloading all logo files as ZIP...');
}

// Navigation history for back buttons
let navigationHistory = [];

function goBackFromPortal() {
    if (navigationHistory.length > 0) {
        const prevView = navigationHistory.pop();
        showView(prevView, true);
    } else if (currentUser?.type === 'admin') {
        showView('admin', true);
    } else {
        showView('home', true);
    }
}

function trackNavigation(viewName) {
    if (navigationHistory[navigationHistory.length - 1] !== viewName) {
        navigationHistory.push(viewName);
        if (navigationHistory.length > 10) navigationHistory.shift();
    }
}

// ==================== ADMIN SUBMISSIONS PANEL ====================
function loadAdminSubmissionsPanel(searchTerm = '') {
    const filtered = searchTerm
        ? formSubmissions.filter(s =>
            (s.businessName || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
            (s.contactName || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
            (s.email || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
            (s.serviceName || '').toLowerCase().includes(searchTerm.toLowerCase())
          )
        : formSubmissions;

    document.getElementById('adminSubmissionsPanel').innerHTML = `
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
<h2 style="font-size: 28px; font-weight: 700;">Form Submissions</h2>
<span style="color: #888;">${filtered.length} of ${formSubmissions.length} submissions</span>
</div>
<div style="display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; align-items: center;">
<input type="text" id="submissionSearch" placeholder="Search submissions..." value="${searchTerm}"
                oninput="loadAdminSubmissionsPanel(this.value)"
                style="flex: 1; min-width: 200px; padding: 12px 16px; border: 1px solid #e5e5e5; border-radius: 8px; font-size: 14px;">
<button onclick="selectAllSubmissions()" style="padding: 10px 16px; background: #f3f4f6; border: 1px solid #e5e5e5; border-radius: 8px; cursor: pointer;">Select All</button>
<button onclick="deleteSelectedSubmissions()" style="padding: 10px 16px; background: #fee2e2; color: #dc2626; border: none; border-radius: 8px; cursor: pointer;">Delete Selected</button>
<button onclick="exportSubmissionsCSV()" style="padding: 10px 16px; background: #000; color: #fff; border: none; border-radius: 8px; cursor: pointer;">Export CSV</button>
</div>
        ${filtered.length > 0 ? `
<div style="display: flex; flex-direction: column; gap: 16px;">
            ${filtered.slice().reverse().map(sub => `
<div style="background: #fff; border: 1px solid #e5e5e5; border-radius: 12px; padding: 20px;">
<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
<div style="display: flex; align-items: center; gap: 12px;">
<input type="checkbox" class="submission-checkbox" data-id="${sub.id}" style="width: 18px; height: 18px; cursor: pointer;">
<strong style="font-size: 18px;">${sub.businessName || sub.contactName || 'Unknown'}</strong>
<span style="background: ${sub.status === 'pending_payment' ? '#fef3c7' : '#d1fae5'}; color: ${sub.status === 'pending_payment' ? '#92400e' : '#065f46'}; padding: 4px 12px; border-radius: 12px; font-size: 12px;">${sub.status}</span>
</div>
<span style="color: #888; font-size: 13px;">${new Date(sub.submittedAt).toLocaleDateString()}</span>
</div>
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; color: #666; font-size: 14px; margin-left: 30px;">
<div><strong>Service:</strong> ${sub.serviceName}</div>
<div><strong>Price:</strong> ${sub.price > 0 ? '$' + sub.price : 'Custom'}</div>
<div><strong>Ref:</strong> NUI-${sub.id}</div>
</div>
<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e5e5; display: flex; gap: 8px; flex-wrap: wrap; margin-left: 30px;">
<button onclick="viewSubmissionDetails(${sub.id})" style="padding: 8px 16px; background: #000; color: #fff; border: none; border-radius: 6px; cursor: pointer;">View Details</button>
<button onclick="convertSubmissionToOrder(${sub.id})" style="padding: 8px 16px; background: var(--green); color: #fff; border: none; border-radius: 6px; cursor: pointer;">Convert to Order</button>
<button onclick="deleteSubmission(${sub.id})" style="padding: 8px 16px; background: #fee2e2; color: #dc2626; border: none; border-radius: 6px; cursor: pointer;">Delete</button>
</div>
</div>
            `).join('')}
</div>
        ` : '<p style="color: #888; text-align: center; padding: 40px;">No submissions found.</p>'}
    `;
}

// Bulk selection for submissions
function selectAllSubmissions() {
    const checkboxes = document.querySelectorAll('.submission-checkbox');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    checkboxes.forEach(cb => cb.checked = !allChecked);
}

// Bulk delete submissions
function deleteSelectedSubmissions() {
    const checkboxes = document.querySelectorAll('.submission-checkbox:checked');
    if (checkboxes.length === 0) {
        alert('Please select at least one submission to delete.');
        return;
    }

    if (!confirm('Are you sure you want to delete ' + checkboxes.length + ' submission(s)? This cannot be undone.')) return;

    const idsToDelete = Array.from(checkboxes).map(cb => parseInt(cb.dataset.id));
    formSubmissions = formSubmissions.filter(s => !idsToDelete.includes(s.id));
    saveSubmissions();
    loadAdminSubmissionsPanel(document.getElementById('submissionSearch')?.value || '');
    alert(idsToDelete.length + ' submission(s) deleted successfully.');
}

// Export submissions to CSV
function exportSubmissionsCSV() {
    if (formSubmissions.length === 0) {
        alert('No submissions to export.');
        return;
    }

    const headers = ['ID', 'Business Name', 'Contact Name', 'Email', 'Phone', 'Service', 'Price', 'Status', 'Date'];
    const rows = formSubmissions.map(s => [
        s.id,
        s.businessName || '',
        s.contactName || '',
        s.email || '',
        s.phone || '',
        s.serviceName || '',
        s.price || 0,
        s.status || '',
        s.submittedAt || ''
    ]);

    const csv = [headers.join(','), ...rows.map(r => r.map(v => '"' + String(v).replace(/"/g, '""') + '"').join(','))].join('\n');
    downloadCSV(csv, 'nui-submissions-' + new Date().toISOString().split('T')[0] + '.csv');
}

// Helper to download CSV
function downloadCSV(content, filename) {
    const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
    URL.revokeObjectURL(link.href);
}

function viewSubmissionDetails(subId) {
    const sub = formSubmissions.find(s => s.id === subId);
    if (!sub) return;

    let details = Object.entries(sub).map(([key, value]) =>
        `<div style="padding: 8px 0; border-bottom: 1px solid #e5e5e5;"><strong>${key}:</strong> ${JSON.stringify(value)}</div>`
    ).join('');

    alert('Submission Details:\n\n' + JSON.stringify(sub, null, 2));
}

function convertSubmissionToOrder(subId) {
    const sub = formSubmissions.find(s => s.id === subId);
    if (!sub) return;

    // Create or find client
    let client = clients.find(c => c.name === sub.businessName);
    if (!client) {
        client = {
            id: Date.now(),
            name: sub.businessName || 'New Client',
            email: sub.email || '',
            password: 'client' + Math.random().toString(36).substring(7),
            industry: sub.industry || '',
            colors: ['#ff0000', '#000000', '#ffffff'],
            fonts: { heading: 'Inter', body: 'Inter' },
            assets: { logos: [], mockups: [], social: [], video: [], banner: [], fonts: [], patterns: [], package: [] }
        };
        clients.push(client);
        saveClients();
    }

    // Create order
    const order = {
        id: Date.now(),
        clientId: client.id,
        project: sub.serviceName,
        status: 'pending',
        estimate: sub.price,
        dueDate: new Date(Date.now() + 14*24*60*60*1000).toISOString().split('T')[0],
        deliverables: []
    };
    orders.push(order);
    saveOrders();

    // Update submission status
    sub.status = 'converted';
    saveSubmissions();

    alert('Order created for ' + client.name + '!\nPassword: ' + client.password);
    loadAdminSubmissionsPanel();
}

function deleteSubmission(subId) {
    if (!confirm('Are you sure you want to delete this submission?')) return;
    formSubmissions = formSubmissions.filter(s => s.id !== subId);
    saveSubmissions();
    loadAdminSubmissionsPanel();
}

// Add intake view to HTML structure
if (!document.getElementById('intakeView')) {
    const intakeDiv = document.createElement('div');
    intakeDiv.className = 'view';
    intakeDiv.id = 'intakeView';
    document.body.insertBefore(intakeDiv, document.querySelector('script'));
}

// Update services page to link to intake
function updateServicesWithIntake() {
    const servicesView = document.getElementById('servicesView');
    if (servicesView && servicesView.innerHTML) {
        // Services are already loaded, we can enhance them
    }
}

// ==================== DESIGNER DASHBOARD ====================
function loadDesignerDashboard(designer) {
    // Update header to show designer name
    document.querySelector('.admin-header span').textContent = 'Designer: ' + designer.name;

    // Show only permitted panels
    document.querySelectorAll('.admin-nav-link').forEach(link => {
        const panel = link.getAttribute('data-panel');
        const permitted = ['dashboard'];
        if (designer.permissions.includes('projects')) permitted.push('projects');
        if (designer.permissions.includes('proofs')) permitted.push('proofs');
        if (designer.permissions.includes('assets')) permitted.push('assets');
        if (designer.permissions.includes('clients')) permitted.push('clients');

        if (!permitted.includes(panel)) {
            link.style.display = 'none';
        }
    });

    // Hide nav groups that have no visible items
    document.querySelectorAll('.admin-nav-group').forEach(group => {
        const visibleLinks = group.querySelectorAll('.admin-nav-link:not([style*="display: none"])');
        if (visibleLinks.length === 0) {
            group.style.display = 'none';
        }
    });

    loadAdminDashboardPanel();
}

// ==================== CRM PANEL (GoHighLevel Style) ====================
let crmActiveTab = 'pipeline';
let crmSmartGroups = JSON.parse(localStorage.getItem('nui_smart_groups')) || [
    { id: 1, name: 'All Contacts', filter: { type: 'all' }, color: '#3b82f6' },
    { id: 2, name: 'New Leads (7 days)', filter: { type: 'date', days: 7, status: 'new' }, color: '#10b981' },
    { id: 3, name: 'High Value ($5k+)', filter: { type: 'value', min: 5000 }, color: '#f59e0b' },
    { id: 4, name: 'Needs Follow-up', filter: { type: 'stage', stages: [1, 2] }, color: '#ef4444' },
    { id: 5, name: 'Won Deals', filter: { type: 'stage', stages: [5] }, color: '#8b5cf6' }
];
function saveSmartGroups() { localStorage.setItem('nui_smart_groups', JSON.stringify(crmSmartGroups)); }

function loadAdminCrmPanel() {
    // Auto-sync from Supabase on first load (non-blocking)
    if (!supabaseCommsLastSync || (Date.now() - new Date(supabaseCommsLastSync).getTime()) > 60000) {
        syncCommunications(false);
    }

    // Merge clients into contacts if not already
    clients.forEach(client => {
        if (!crmData.contacts.find(c => c.email === client.email)) {
            crmData.contacts.push({
                id: client.id,
                name: client.contact || client.name,
                email: client.email,
                phone: client.phone || '',
                company: client.name,
                value: orders.filter(o => o.clientId === client.id).reduce((s, o) => s + (o.estimate || 0), 0),
                stage: 5,
                clientId: client.id,
                createdAt: client.createdAt || new Date().toISOString()
            });
        }
    });

    const contactsByStage = {};
    crmData.pipelines.forEach(p => { contactsByStage[p.id] = crmData.contacts.filter(c => c.stage === p.id); });
    const totalValue = crmData.contacts.reduce((sum, c) => sum + (c.value || 0), 0);
    const wonValue = (contactsByStage[5] || []).reduce((sum, c) => sum + (c.value || 0), 0);

    document.getElementById('adminCrmPanel').innerHTML = `
<style>
            .crm-tabs { display: flex; gap: 4px; background: #111; padding: 4px; border-radius: 8px; margin-bottom: 24px; }
            .crm-tab { padding: 12px 24px; background: transparent; border: none; color: rgba(255,255,255,0.5); cursor: pointer; border-radius: 6px; font-weight: 600; font-family: inherit; transition: all 0.2s; }
            .crm-tab:hover { color: #fff; background: rgba(255,255,255,0.05); }
            .crm-tab.active { background: var(--red); color: #fff; }
            .crm-content { display: none; }
            .crm-content.active { display: block; }
            .pipeline-board-ghl { display: flex; gap: 16px; overflow-x: auto; padding-bottom: 16px; min-height: 500px; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
            .pipeline-board-ghl::-webkit-scrollbar { height: 10px; }
            .pipeline-board-ghl::-webkit-scrollbar-track { background: #1a1a1a; border-radius: 5px; }
            .pipeline-board-ghl::-webkit-scrollbar-thumb { background: linear-gradient(90deg, #e63946, #ff6b6b); border-radius: 5px; min-width: 60px; }
            .pipeline-board-ghl::-webkit-scrollbar-thumb:hover { background: linear-gradient(90deg, #ff6b6b, #e63946); }
            .pipeline-col { min-width: 280px; max-width: 280px; background: #111; border-radius: 12px; display: flex; flex-direction: column; flex-shrink: 0; }
            .pipeline-col-header { padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
            .pipeline-col-title { font-weight: 700; font-size: 14px; display: flex; align-items: center; gap: 8px; }
            .pipeline-col-count { background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 100px; font-size: 12px; font-weight: 600; }
            .pipeline-col-body { flex: 1; padding: 12px; overflow-y: auto; min-height: 200px; }
            .pipeline-col-body.drag-over { background: rgba(255,255,255,0.05); border: 2px dashed rgba(255,255,255,0.2); }
            .contact-card { background: #1a1a1a; border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; padding: 16px; margin-bottom: 12px; cursor: grab; transition: all 0.2s; }
            .contact-card:hover { border-color: rgba(255,255,255,0.2); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
            .contact-card.dragging { opacity: 0.5; transform: rotate(3deg); }
            .contact-card-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; }
            .contact-avatar { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px; }
            .contact-info h4 { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
            .contact-info p { font-size: 12px; color: rgba(255,255,255,0.5); }
            .contact-value { font-size: 16px; font-weight: 700; color: #10b981; }
            .contact-meta { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
            .contact-tag { font-size: 10px; padding: 4px 8px; border-radius: 4px; background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.7); }
            .contact-actions { display: flex; gap: 8px; border-top: 1px solid rgba(255,255,255,0.08); padding-top: 12px; }
            .contact-action-btn { flex: 1; padding: 8px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 4px; }
            .contact-action-btn.sms { background: #10b981; color: #fff; }
            .contact-action-btn.email { background: #3b82f6; color: #fff; }
            .contact-action-btn.call { background: #8b5cf6; color: #fff; }
            .contact-action-btn.more { background: rgba(255,255,255,0.1); color: #fff; }
            .contact-action-btn:hover { transform: scale(1.05); }
            .smart-group-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px; margin-bottom: 32px; }
            .smart-group-card { background: #111; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s; }
            .smart-group-card:hover { border-color: rgba(255,255,255,0.3); transform: translateY(-2px); }
            .smart-group-card.selected { border-color: var(--red); background: rgba(255,0,0,0.1); }
            .smart-group-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
            .smart-group-name { font-weight: 600; font-size: 16px; }
            .smart-group-count { background: rgba(255,255,255,0.1); padding: 4px 12px; border-radius: 100px; font-size: 13px; }
            .bulk-actions { background: #111; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 24px; margin-bottom: 24px; }
            .bulk-actions h3 { font-size: 16px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
            .bulk-btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-family: inherit; display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s; }
            .bulk-btn.sms { background: #10b981; color: #fff; }
            .bulk-btn.email { background: #3b82f6; color: #fff; }
            .bulk-btn:hover { transform: translateY(-2px); }
            .contact-table { width: 100%; border-collapse: collapse; }
            .contact-table th { text-align: left; padding: 12px 16px; background: #111; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: rgba(255,255,255,0.5); }
            .contact-table td { padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.05); }
            .contact-table tr:hover td { background: rgba(255,255,255,0.02); }
            .contact-table input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
            .stage-move-btns { display: flex; gap: 4px; margin-top: 8px; }
            .stage-move-btn { padding: 4px 8px; font-size: 10px; border: none; border-radius: 4px; cursor: pointer; background: rgba(255,255,255,0.1); color: #fff; }
            .stage-move-btn:hover { background: rgba(255,255,255,0.2); }
</style>

<div class="panel-header">
<h2 class="panel-title">💼 CRM Pipeline</h2>
<p class="panel-subtitle">Manage your sales pipeline, contacts, and communications</p>
</div>

        <!-- CRM Tabs -->
<div class="crm-tabs">
<button class="crm-tab ${crmActiveTab === 'pipeline' ? 'active' : ''}" onclick="switchCrmTab('pipeline')">📊 Pipeline</button>
<button class="crm-tab ${crmActiveTab === 'conversations' ? 'active' : ''}" onclick="switchCrmTab('conversations')">💬 Conversations</button>
<button class="crm-tab ${crmActiveTab === 'contacts' ? 'active' : ''}" onclick="switchCrmTab('contacts')">👥 All Contacts</button>
<button class="crm-tab ${crmActiveTab === 'smartgroups' ? 'active' : ''}" onclick="switchCrmTab('smartgroups')">🎯 Smart Groups</button>
<button class="crm-tab ${crmActiveTab === 'bulk' ? 'active' : ''}" onclick="switchCrmTab('bulk')">📤 Bulk Actions</button>
</div>

        <!-- Stats Bar -->
<div class="stat-cards" style="margin-bottom: 24px;">
<div class="stat-card"><div class="num">${crmData.contacts.length}</div><div class="lbl">Total Contacts</div></div>
<div class="stat-card"><div class="num" style="color: #3b82f6;">${(contactsByStage[1] || []).length + (contactsByStage[2] || []).length}</div><div class="lbl">Active Leads</div></div>
<div class="stat-card highlight"><div class="num">$${totalValue.toLocaleString()}</div><div class="lbl">Pipeline Value</div></div>
<div class="stat-card"><div class="num" style="color: #10b981;">$${wonValue.toLocaleString()}</div><div class="lbl">Won Deals</div></div>
</div>

        <!-- PIPELINE TAB -->
<div class="crm-content ${crmActiveTab === 'pipeline' ? 'active' : ''}" id="crmPipelineTab">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
<p style="color: rgba(255,255,255,0.5); font-size: 13px;">Drag contacts between stages to update their status</p>
<button class="btn-admin primary" onclick="showAddContactModal()">+ Add Contact</button>
</div>
<div class="pipeline-board-ghl">
                ${crmData.pipelines.map(stage => {
                    const stageContacts = contactsByStage[stage.id] || [];
                    const stageValue = stageContacts.reduce((s, c) => s + (c.value || 0), 0);
                    return `
<div class="pipeline-col" data-stage="${stage.id}">
<div class="pipeline-col-header" style="border-left: 3px solid ${stage.color};">
<div class="pipeline-col-title"><span style="color: ${stage.color};">●</span> ${stage.name}</div>
<div class="pipeline-col-count">${stageContacts.length} · $${stageValue.toLocaleString()}</div>
</div>
<div class="pipeline-col-body" ondragover="handleDragOver(event)" ondrop="handleDrop(event, ${stage.id})" ondragleave="handleDragLeave(event)">
                            ${stageContacts.map(contact => renderContactCard(contact, stage.color)).join('') || '<p style="color: rgba(255,255,255,0.2); font-size: 12px; text-align: center; padding: 40px 20px;">Drop contacts here</p>'}
</div>
</div>`;
                }).join('')}
</div>
</div>

        <!-- CONVERSATIONS TAB -->
<div class="crm-content ${crmActiveTab === 'conversations' ? 'active' : ''}" id="crmConversationsTab">
            ${renderConversationsHub()}
</div>

        <!-- ALL CONTACTS TAB -->
<div class="crm-content ${crmActiveTab === 'contacts' ? 'active' : ''}" id="crmContactsTab">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
<input type="text" placeholder="Search contacts..." oninput="filterCrmContacts(this.value)" style="padding: 10px 16px; background: #111; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; width: 300px;">
<button class="btn-admin primary" onclick="showAddContactModal()">+ Add Contact</button>
</div>
<table class="contact-table">
<thead>
<tr>
<th><input type="checkbox" onchange="toggleAllContacts(this.checked)"></th>
<th>Contact</th>
<th>Company</th>
<th>Stage</th>
<th>Value</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="crmContactsTableBody">
                    ${crmData.contacts.map(contact => {
                        const stage = crmData.pipelines.find(p => p.id === contact.stage);
                        return `
<tr>
<td><input type="checkbox" class="contact-checkbox" data-id="${contact.id}"></td>
<td>
<div style="display: flex; align-items: center; gap: 12px;">
<div class="contact-avatar" style="background: ${stage?.color || '#666'}; width: 36px; height: 36px; font-size: 14px;">${contact.name?.charAt(0) || '?'}</div>
<div>
<div style="font-weight: 600;">${contact.name}</div>
<div style="font-size: 12px; color: rgba(255,255,255,0.5);">${contact.email || 'No email'}</div>
</div>
</div>
</td>
<td>${contact.company || '—'}</td>
<td><span style="background: ${stage?.color || '#666'}20; color: ${stage?.color || '#666'}; padding: 4px 12px; border-radius: 100px; font-size: 12px; font-weight: 600;">${stage?.name || 'Unknown'}</span></td>
<td style="font-weight: 600; color: #10b981;">$${(contact.value || 0).toLocaleString()}</td>
<td>
<div style="display: flex; gap: 8px;">
<button onclick="quickSms(${contact.id})" style="padding: 6px 12px; background: #10b981; border: none; border-radius: 4px; cursor: pointer; color: #fff; font-size: 12px;">💬 SMS</button>
<button onclick="quickEmail(${contact.id})" style="padding: 6px 12px; background: #3b82f6; border: none; border-radius: 4px; cursor: pointer; color: #fff; font-size: 12px;">📧 Email</button>
<button onclick="quickCall(${contact.id})" style="padding: 6px 12px; background: #8b5cf6; border: none; border-radius: 4px; cursor: pointer; color: #fff; font-size: 12px;">📞 Call</button>
<button onclick="editContact(${contact.id})" style="padding: 6px 12px; background: rgba(255,255,255,0.1); border: none; border-radius: 4px; cursor: pointer; color: #fff; font-size: 12px;">✏️</button>
</div>
</td>
</tr>`;
                    }).join('')}
</tbody>
</table>
</div>

        <!-- SMART GROUPS TAB -->
<div class="crm-content ${crmActiveTab === 'smartgroups' ? 'active' : ''}" id="crmSmartGroupsTab">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
<p style="color: rgba(255,255,255,0.5);">Create smart groups to segment contacts for targeted messaging</p>
<button class="btn-admin primary" onclick="showCreateSmartGroupModal()">+ Create Smart Group</button>
</div>
<div class="smart-group-list">
                ${crmSmartGroups.map(group => {
                    const groupContacts = getSmartGroupContacts(group);
                    return `
<div class="smart-group-card" onclick="selectSmartGroup(${group.id})" data-group="${group.id}">
<div class="smart-group-header">
<div class="smart-group-name" style="display: flex; align-items: center; gap: 8px;"><span style="color: ${group.color};">●</span> ${group.name}</div>
<div class="smart-group-count">${groupContacts.length}</div>
</div>
<p style="font-size: 12px; color: rgba(255,255,255,0.5); margin-bottom: 12px;">${getSmartGroupDescription(group)}</p>
<div style="display: flex; gap: 8px;">
<button onclick="event.stopPropagation(); bulkSmsGroup(${group.id})" class="bulk-btn sms" style="flex: 1; padding: 8px; font-size: 12px;">💬 SMS All</button>
<button onclick="event.stopPropagation(); bulkEmailGroup(${group.id})" class="bulk-btn email" style="flex: 1; padding: 8px; font-size: 12px;">📧 Email All</button>
</div>
</div>`;
                }).join('')}
</div>
</div>

        <!-- BULK ACTIONS TAB -->
<div class="crm-content ${crmActiveTab === 'bulk' ? 'active' : ''}" id="crmBulkTab">
<div class="bulk-actions">
<h3>📤 Bulk Messaging</h3>
<p style="color: rgba(255,255,255,0.5); margin-bottom: 20px;">Select a smart group or manually select contacts to send bulk messages</p>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                    <!-- SMS Blast -->
<div style="background: #0a0a0a; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 24px;">
<h4 style="font-size: 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;"><span style="font-size: 24px;">💬</span> SMS Blast</h4>
<div class="form-group">
<label class="form-label">Select Recipients</label>
<select id="bulkSmsGroup" class="form-select">
                                ${crmSmartGroups.map(g => `<option value="${g.id}">${g.name} (${getSmartGroupContacts(g).length})</option>`).join('')}
</select>
</div>
<div class="form-group">
<label class="form-label">Message Template</label>
<select id="bulkSmsTemplate" class="form-select" onchange="loadSmsTemplate(this.value)">
<option value="">-- Select Template --</option>
                                ${smsSystem.templates.map(t => `<option value="${t.id}">${t.name}</option>`).join('')}
</select>
</div>
<div class="form-group">
<label class="form-label">Message</label>
<textarea id="bulkSmsMessage" class="form-textarea" placeholder="Hi {name}, ..." rows="4"></textarea>
<p style="font-size: 11px; color: rgba(255,255,255,0.4); margin-top: 4px;">Use {name}, {company} for personalization</p>
</div>
<button onclick="sendBulkSms()" class="bulk-btn sms" style="width: 100%;">💬 Send SMS Blast</button>
</div>

                    <!-- Email Blast -->
<div style="background: #0a0a0a; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 24px;">
<h4 style="font-size: 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;"><span style="font-size: 24px;">📧</span> Email Blast</h4>
<div class="form-group">
<label class="form-label">Select Recipients</label>
<select id="bulkEmailGroup" class="form-select">
                                ${crmSmartGroups.map(g => `<option value="${g.id}">${g.name} (${getSmartGroupContacts(g).length})</option>`).join('')}
</select>
</div>
<div class="form-group">
<label class="form-label">Email Template</label>
<select id="bulkEmailTemplate" class="form-select" onchange="loadEmailTemplate(this.value)">
<option value="">-- Select Template --</option>
                                ${emailMarketing.templates.map(t => `<option value="${t.id}">${t.name}</option>`).join('')}
</select>
</div>
<div class="form-group">
<label class="form-label">Subject</label>
<input type="text" id="bulkEmailSubject" class="form-input" placeholder="Email subject...">
</div>
<div class="form-group">
<label class="form-label">Message</label>
<textarea id="bulkEmailMessage" class="form-textarea" placeholder="Hi {name}, ..." rows="4"></textarea>
</div>
<button onclick="sendBulkEmail()" class="bulk-btn email" style="width: 100%;">📧 Send Email Blast</button>
</div>
</div>
</div>

            <!-- Recent Bulk Messages -->
<div style="background: #111; border-radius: 12px; padding: 24px;">
<h3 style="font-size: 16px; margin-bottom: 16px;">📊 Recent Campaigns</h3>
<table class="contact-table">
<thead><tr><th>Date</th><th>Type</th><th>Group</th><th>Recipients</th><th>Status</th></tr></thead>
<tbody>
                        ${(crmData.bulkMessages || []).slice(-5).reverse().map(msg => `
<tr>
<td>${new Date(msg.sentAt).toLocaleDateString()}</td>
<td><span style="background: ${msg.type === 'sms' ? '#10b981' : '#3b82f6'}20; color: ${msg.type === 'sms' ? '#10b981' : '#3b82f6'}; padding: 4px 12px; border-radius: 4px; font-size: 12px;">${msg.type.toUpperCase()}</span></td>
<td>${msg.groupName}</td>
<td>${msg.recipients}</td>
<td style="color: #10b981;">✓ Sent</td>
</tr>
                        `).join('') || '<tr><td colspan="5" style="text-align: center; color: rgba(255,255,255,0.3);">No campaigns yet</td></tr>'}
</tbody>
</table>
</div>
</div>
    `;
}

function renderContactCard(contact, stageColor) {
    const stage = crmData.pipelines.find(p => p.id === contact.stage);
    return `
<div class="contact-card" draggable="true" ondragstart="handleDragStart(event, ${contact.id})" ondragend="handleDragEnd(event)" data-contact="${contact.id}">
<div class="contact-card-header">
<div style="display: flex; align-items: center; gap: 12px;">
<div class="contact-avatar" style="background: ${stageColor};">${contact.name?.charAt(0) || '?'}</div>
<div class="contact-info">
<h4>${contact.name}</h4>
<p>${contact.company || contact.email || 'No info'}</p>
</div>
</div>
<div class="contact-value">$${(contact.value || 0).toLocaleString()}</div>
</div>
<div class="contact-meta">
                ${contact.phone ? '<span class="contact-tag">📞 ' + contact.phone + '</span>' : ''}
                ${contact.email ? '<span class="contact-tag">📧 Has Email</span>' : ''}
</div>
<div class="contact-actions">
<button class="contact-action-btn sms" onclick="event.stopPropagation(); quickSms(${contact.id})" title="Send SMS">💬</button>
<button class="contact-action-btn email" onclick="event.stopPropagation(); quickEmail(${contact.id})" title="Send Email">📧</button>
<button class="contact-action-btn call" onclick="event.stopPropagation(); quickCall(${contact.id})" title="Call">📞</button>
<button class="contact-action-btn more" onclick="event.stopPropagation(); editContact(${contact.id})" title="Edit">⋯</button>
</div>
<div class="stage-move-btns">
                ${contact.stage > 1 ? '<button class="stage-move-btn" onclick="event.stopPropagation(); moveContactStage(' + contact.id + ', ' + (contact.stage - 1) + ')">← Prev</button>' : ''}
                ${contact.stage < 6 ? '<button class="stage-move-btn" onclick="event.stopPropagation(); moveContactStage(' + contact.id + ', ' + (contact.stage + 1) + ')">Next →</button>' : ''}
</div>
</div>`;
}

function switchCrmTab(tab) {
    crmActiveTab = tab;
    document.querySelectorAll('.crm-tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`.crm-tab[onclick*="${tab}"]`)?.classList.add('active');
    document.querySelectorAll('.crm-content').forEach(c => c.classList.remove('active'));
    document.getElementById('crm' + tab.charAt(0).toUpperCase() + tab.slice(1) + 'Tab')?.classList.add('active');
}

// Conversations Hub - All Customer Communications
let conversationFilter = 'all';
let selectedConversationContact = null;

function renderConversationsHub() {
    // Get all communications from various sources
    const allComms = getAllCommunications();
    const filteredComms = conversationFilter === 'all' ? allComms : allComms.filter(c => c.channel === conversationFilter);

    // Group by contact
    const contactComms = {};
    filteredComms.forEach(comm => {
        const contactId = comm.clientId || comm.contactId || 'unknown';
        if (!contactComms[contactId]) {
            contactComms[contactId] = { contact: getContactInfo(contactId), messages: [] };
        }
        contactComms[contactId].messages.push(comm);
    });

    // Sort by latest message
    const sortedContacts = Object.values(contactComms).sort((a, b) => {
        const aLatest = a.messages[a.messages.length - 1]?.createdAt || '';
        const bLatest = b.messages[b.messages.length - 1]?.createdAt || '';
        return new Date(bLatest) - new Date(aLatest);
    });

    const unreadCount = allComms.filter(c => !c.read).length;

    return `
<style>
            .conv-container { display: flex; gap: 0; height: 600px; background: #111; border-radius: 12px; overflow: hidden; }
            .conv-sidebar { width: 320px; border-right: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; }
            .conv-main { flex: 1; display: flex; flex-direction: column; }
            .conv-header { padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.1); }
            .conv-filters { display: flex; gap: 8px; padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.05); overflow-x: auto; }
            .conv-filter { padding: 6px 12px; background: rgba(255,255,255,0.05); border: none; border-radius: 100px; color: rgba(255,255,255,0.6); cursor: pointer; font-size: 12px; white-space: nowrap; }
            .conv-filter.active { background: var(--red); color: #fff; }
            .conv-list { flex: 1; overflow-y: auto; }
            .conv-item { padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: background 0.2s; }
            .conv-item:hover { background: rgba(255,255,255,0.03); }
            .conv-item.active { background: rgba(225,29,72,0.1); border-left: 3px solid var(--red); }
            .conv-item.unread { background: rgba(59,130,246,0.1); }
            .conv-avatar { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px; }
            .conv-item-header { display: flex; justify-content: space-between; margin-bottom: 4px; }
            .conv-item-name { font-weight: 600; font-size: 14px; }
            .conv-item-time { font-size: 11px; color: rgba(255,255,255,0.4); }
            .conv-item-preview { font-size: 13px; color: rgba(255,255,255,0.5); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
            .conv-item-badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 4px; font-size: 10px; margin-top: 8px; }
            .conv-empty { flex: 1; display: flex; align-items: center; justify-content: center; color: rgba(255,255,255,0.3); }
            .conv-messages { flex: 1; overflow-y: auto; padding: 20px; }
            .conv-message { margin-bottom: 16px; max-width: 80%; }
            .conv-message.inbound { margin-right: auto; }
            .conv-message.outbound { margin-left: auto; }
            .conv-message-bubble { padding: 12px 16px; border-radius: 16px; font-size: 14px; line-height: 1.5; }
            .conv-message.inbound .conv-message-bubble { background: #252525; border-bottom-left-radius: 4px; }
            .conv-message.outbound .conv-message-bubble { background: var(--red); border-bottom-right-radius: 4px; }
            .conv-message-meta { font-size: 11px; color: rgba(255,255,255,0.4); margin-top: 4px; display: flex; align-items: center; gap: 8px; }
            .conv-input { padding: 16px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; gap: 12px; }
            .conv-input input { flex: 1; padding: 12px 16px; background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; color: #fff; }
            .conv-input select { padding: 12px; background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; }
            .conv-input button { padding: 12px 24px; background: var(--red); border: none; color: #fff; border-radius: 24px; cursor: pointer; font-weight: 600; }
</style>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
<div>
<h3 style="font-size: 18px; margin-bottom: 4px;">💬 All Conversations</h3>
<div style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">
<p style="color: rgba(255,255,255,0.5); font-size: 13px;">Unified inbox — Email, SMS & Calls</p>
                    ${supabaseCommsLastSync ? '<span style="font-size: 11px; color: rgba(255,255,255,0.3);">Synced: ' + new Date(supabaseCommsLastSync).toLocaleTimeString() + '</span>' : '<span style="font-size: 11px; color: rgba(245,158,11,0.8);">Not synced yet</span>'}
</div>
</div>
<div style="display: flex; gap: 8px;">
<button onclick="syncCommunications(true)" style="padding: 8px 16px; background: rgba(255,255,255,0.1); border: none; color: #fff; border-radius: 8px; cursor: pointer; font-weight: 600;">🔄 Sync</button>
<span style="background: #ef4444; color: #fff; padding: 6px 12px; border-radius: 100px; font-size: 12px; font-weight: 600;">${unreadCount} Unread</span>
<button onclick="composeNewMessage()" style="padding: 8px 16px; background: var(--red); border: none; color: #fff; border-radius: 8px; cursor: pointer; font-weight: 600;">✉️ Compose</button>
</div>
</div>

<div class="conv-container">
            <!-- Sidebar: Contact List -->
<div class="conv-sidebar">
<div class="conv-filters">
<button class="conv-filter ${conversationFilter === 'all' ? 'active' : ''}" onclick="setConversationFilter('all')">All</button>
<button class="conv-filter ${conversationFilter === 'sms' ? 'active' : ''}" onclick="setConversationFilter('sms')">📱 SMS</button>
<button class="conv-filter ${conversationFilter === 'email' ? 'active' : ''}" onclick="setConversationFilter('email')">✉️ Email</button>
<button class="conv-filter ${conversationFilter === 'call' ? 'active' : ''}" onclick="setConversationFilter('call')">📞 Calls</button>
<button class="conv-filter ${conversationFilter === 'proof_system' ? 'active' : ''}" onclick="setConversationFilter('proof_system')">✅ Proofs</button>
<button class="conv-filter ${conversationFilter === 'social' ? 'active' : ''}" onclick="setConversationFilter('social')">💬 Social</button>
</div>
<div class="conv-list">
                    ${sortedContacts.length === 0 ? `
<div style="padding: 40px; text-align: center; color: rgba(255,255,255,0.3);">
<div style="font-size: 32px; margin-bottom: 8px;">💬</div>
<div>No conversations yet</div>
</div>
                    ` : sortedContacts.map(item => {
                        const latestMsg = item.messages[item.messages.length - 1];
                        const unread = item.messages.some(m => !m.read);
                        const isActive = selectedConversationContact === (item.contact?.id || item.contact?.clientId);
                        return `
<div class="conv-item ${isActive ? 'active' : ''} ${unread ? 'unread' : ''}" onclick="selectConversation(${item.contact?.id || item.contact?.clientId || 0})">
<div style="display: flex; gap: 12px;">
<div class="conv-avatar" style="background: ${getChannelColor(latestMsg?.channel)};">${(item.contact?.name || 'U').charAt(0)}</div>
<div style="flex: 1; min-width: 0;">
<div class="conv-item-header">
<span class="conv-item-name">${item.contact?.name || 'Unknown'}</span>
<span class="conv-item-time">${formatRelativeTime(latestMsg?.createdAt)}</span>
</div>
<div class="conv-item-preview">${latestMsg?.message || latestMsg?.text || 'No messages'}</div>
<div class="conv-item-badge" style="background: ${getChannelColor(latestMsg?.channel)}20; color: ${getChannelColor(latestMsg?.channel)};">
                                            ${getChannelIcon(latestMsg?.channel)} ${latestMsg?.channel || 'message'}
</div>
</div>
</div>
</div>
                        `;
                    }).join('')}
</div>
</div>

            <!-- Main: Conversation View -->
<div class="conv-main">
                ${selectedConversationContact ? renderConversationDetail(selectedConversationContact) : `
<div class="conv-empty">
<div style="text-align: center;">
<div style="font-size: 64px; margin-bottom: 16px;">💬</div>
<div style="font-size: 18px; margin-bottom: 8px;">Select a conversation</div>
<div style="font-size: 14px; color: rgba(255,255,255,0.4);">Choose a contact from the list to view messages</div>
</div>
</div>
                `}
</div>
</div>
    `;
}

// Supabase communications cache
let supabaseCommsCache = JSON.parse(localStorage.getItem('nui_supabase_comms')) || [];
let supabaseCommsLastSync = localStorage.getItem('nui_comms_last_sync') || null;
let commsSyncing = false;

async function syncCommunications(showAlert = false) {
    if (commsSyncing) return;
    commsSyncing = true;

    try {
        // First, trigger an IMAP poll to check for new emails
        try {
            await fetch('/.netlify/functions/poll-email?manual=true');
            console.log('📧 IMAP poll triggered');
        } catch (pollErr) {
            console.log('IMAP poll skipped:', pollErr.message);
        }

        // Then fetch all communications from Supabase
        const response = await fetch('/.netlify/functions/get-communications?limit=100');
        if (!response.ok) throw new Error('Sync failed');

        const data = await response.json();
        supabaseCommsCache = data.communications || [];
        localStorage.setItem('nui_supabase_comms', JSON.stringify(supabaseCommsCache));
        localStorage.setItem('nui_comms_last_sync', new Date().toISOString());
        supabaseCommsLastSync = new Date().toISOString();

        if (showAlert) {
            alert('✅ Synced! ' + supabaseCommsCache.length + ' messages loaded (' + (data.unread?.total || 0) + ' unread)');
        }

        // Refresh the CRM panel
        const crmPanel = document.getElementById('crmConversationsTab');
        if (crmPanel && crmActiveTab === 'conversations') {
            loadAdminCrmPanel();
        }
    } catch (err) {
        console.warn('Communications sync failed:', err.message);
        if (showAlert) alert('❌ Sync failed: ' + err.message);
    } finally {
        commsSyncing = false;
    }
}

function getAllCommunications() {
    const comms = [];
    const seenIds = new Set();

    // 1. Supabase communications (real emails, SMS, calls from webhooks)
    supabaseCommsCache.forEach(c => {
        const id = 'sb_' + c.id;
        if (seenIds.has(id)) return;
        seenIds.add(id);
        comms.push({
            id: id,
            clientId: c.client_id,
            contactId: c.client_id,
            contactName: c.metadata?.fromName || c.metadata?.from || '',
            channel: c.channel,
            message: c.channel === 'email' ? `[${c.subject || 'No Subject'}] ${c.message}` : c.message,
            subject: c.subject,
            direction: c.direction,
            createdAt: c.created_at,
            read: c.read,
            source: 'supabase',
            metadata: c.metadata
        });
    });

    // 2. Local stored communications (manual entries)
    const storedComms = JSON.parse(localStorage.getItem('nui_crm_communications')) || [];
    storedComms.forEach(c => {
        const id = 'local_' + c.id;
        if (seenIds.has(id)) return;
        seenIds.add(id);
        comms.push({ ...c, id, source: 'local' });
    });

    // 3. SMS conversations
    const smsConvos = JSON.parse(localStorage.getItem('nui_sms_conversations')) || [];
    smsConvos.forEach(convo => {
        (convo.messages || []).forEach(msg => {
            const id = 'sms_' + (msg.id || Date.now() + Math.random());
            if (seenIds.has(id)) return;
            seenIds.add(id);
            comms.push({
                id, clientId: convo.clientId, contactId: convo.clientId,
                channel: 'sms', message: msg.text,
                direction: msg.direction || (msg.from === 'client' ? 'inbound' : 'outbound'),
                createdAt: msg.time || msg.createdAt, read: true, source: 'local'
            });
        });
    });

    // 4. Email campaigns
    const emailCampaigns = JSON.parse(localStorage.getItem('nui_email_campaigns')) || [];
    emailCampaigns.forEach(campaign => {
        if (campaign.sentAt) {
            comms.push({
                id: 'camp_' + campaign.id, channel: 'email',
                message: `Campaign: ${campaign.name} - ${campaign.subject}`,
                direction: 'outbound', createdAt: campaign.sentAt,
                read: true, isCampaign: true, source: 'local'
            });
        }
    });

    // 5. Proof comments
    proofs.forEach(proof => {
        (proof.comments || []).forEach(comment => {
            comms.push({
                id: 'proof_' + Date.now() + Math.random(),
                clientId: proof.clientId, channel: 'proof_system',
                message: `[${proof.name}] ${comment.text}`,
                direction: comment.author === 'Admin' ? 'outbound' : 'inbound',
                createdAt: comment.createdAt, read: true, proofId: proof.id, source: 'local'
            });
        });
    });

    // 6. Social DMs
    const socialDMs = JSON.parse(localStorage.getItem('nui_social_dms')) || [];
    socialDMs.forEach(dm => {
        (dm.messages || []).forEach(msg => {
            comms.push({
                id: 'social_' + (msg.id || Date.now() + Math.random()),
                contactId: dm.contactId, contactName: dm.contactName,
                channel: 'social', platform: dm.platform, message: msg.text,
                direction: msg.from === 'them' ? 'inbound' : 'outbound',
                createdAt: msg.time, read: true, source: 'local'
            });
        });
    });

    return comms.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
}

function getContactInfo(contactId) {
    const client = clients.find(c => c.id === contactId);
    if (client) return { id: client.id, name: client.name, email: client.email, phone: client.phone };

    const contact = crmData.contacts.find(c => c.id === contactId);
    if (contact) return contact;

    return { id: contactId, name: 'Unknown', email: '' };
}

function getChannelColor(channel) {
    const colors = { sms: '#10b981', email: '#3b82f6', call: '#8b5cf6', proof_system: '#f59e0b', social: '#ec4899' };
    return colors[channel] || '#666';
}

function getChannelIcon(channel) {
    const icons = { sms: '📱', email: '✉️', call: '📞', proof_system: '✅', social: '💬' };
    return icons[channel] || '💬';
}

function formatRelativeTime(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    const now = new Date();
    const diff = now - date;
    const mins = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);

    if (mins < 1) return 'Just now';
    if (mins < 60) return mins + 'm ago';
    if (hours < 24) return hours + 'h ago';
    if (days < 7) return days + 'd ago';
    return date.toLocaleDateString();
}

function setConversationFilter(filter) {
    conversationFilter = filter;
    loadAdminCrmPanel();
}

function selectConversation(contactId) {
    selectedConversationContact = contactId;
    // Mark messages as read
    const comms = JSON.parse(localStorage.getItem('nui_crm_communications')) || [];
    comms.forEach(c => {
        if (c.clientId === contactId || c.contactId === contactId) c.read = true;
    });
    localStorage.setItem('nui_crm_communications', JSON.stringify(comms));
    loadAdminCrmPanel();
}

function renderConversationDetail(contactId) {
    const contact = getContactInfo(contactId);
    const allComms = getAllCommunications();
    const contactComms = allComms.filter(c => c.clientId === contactId || c.contactId === contactId);

    return `
<div class="conv-header" style="display: flex; justify-content: space-between; align-items: center;">
<div style="display: flex; align-items: center; gap: 12px;">
<div class="conv-avatar" style="background: var(--red);">${(contact.name || 'U').charAt(0)}</div>
<div>
<div style="font-weight: 600; font-size: 16px;">${contact.name || 'Unknown'}</div>
<div style="font-size: 13px; color: rgba(255,255,255,0.5);">${contact.email || contact.phone || ''}</div>
</div>
</div>
<div style="display: flex; gap: 8px;">
<button onclick="quickSms(${contactId})" style="padding: 8px 12px; background: #10b981; border: none; color: #fff; border-radius: 6px; cursor: pointer;">📱 SMS</button>
<button onclick="quickEmail(${contactId})" style="padding: 8px 12px; background: #3b82f6; border: none; color: #fff; border-radius: 6px; cursor: pointer;">✉️ Email</button>
<button onclick="quickCall(${contactId})" style="padding: 8px 12px; background: #8b5cf6; border: none; color: #fff; border-radius: 6px; cursor: pointer;">📞 Call</button>
</div>
</div>

<div class="conv-messages">
            ${contactComms.reverse().map(msg => `
<div class="conv-message ${msg.direction}">
<div class="conv-message-bubble">${msg.message || msg.text}</div>
<div class="conv-message-meta">
<span>${getChannelIcon(msg.channel)} ${msg.channel}</span>
<span>${new Date(msg.createdAt).toLocaleString()}</span>
</div>
</div>
            `).join('') || '<div style="text-align: center; color: rgba(255,255,255,0.3); padding: 40px;">No messages with this contact</div>'}
</div>

<div class="conv-input">
<select id="messageChannel" style="width: 100px;">
<option value="sms">📱 SMS</option>
<option value="email">✉️ Email</option>
</select>
<input type="text" id="newMessageInput" placeholder="Type a message..." onkeypress="if(event.key==='Enter') sendConversationMessage(${contactId})">
<button onclick="sendConversationMessage(${contactId})">Send</button>
</div>
    `;
}

async function sendConversationMessage(contactId) {
    const channel = document.getElementById('messageChannel').value;
    const message = document.getElementById('newMessageInput').value.trim();

    if (!message) return;

    const contact = getContactInfo(contactId);
    const btn = document.querySelector('.conv-input button');
    if (btn) { btn.textContent = 'Sending...'; btn.disabled = true; }

    try {
        // Send via real API
        if (channel === 'sms' && contact.phone) {
            await fetch('/.netlify/functions/send-sms', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ to: contact.phone, message, clientId: contactId })
            });
        } else if (channel === 'email' && contact.email) {
            await fetch('/.netlify/functions/send-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ to: contact.email, subject: 'Re: Conversation', html: message, text: message, clientId: contactId })
            });
        }
    } catch (err) {
        console.warn('API send failed, storing locally:', err.message);
    }

    // Also store locally for immediate display
    const comms = JSON.parse(localStorage.getItem('nui_crm_communications')) || [];
    comms.push({
        id: Date.now(),
        clientId: contactId,
        contactId: contactId,
        channel: channel,
        message: message,
        direction: 'outbound',
        createdAt: new Date().toISOString(),
        read: true
    });
    localStorage.setItem('nui_crm_communications', JSON.stringify(comms));

    document.getElementById('newMessageInput').value = '';
    loadAdminCrmPanel();
}

function composeNewMessage() {
    const modal = document.createElement('div');
    modal.id = 'composeModal';
    modal.innerHTML = `
<div style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999;">
<div style="background: #1a1a1a; border-radius: 16px; padding: 32px; max-width: 500px; width: 100%;">
<h2 style="font-size: 20px; margin-bottom: 24px;">✉️ Compose Message</h2>

<div style="margin-bottom: 16px;">
<label style="display: block; font-size: 14px; margin-bottom: 8px;">To</label>
<select id="composeRecipient" style="width: 100%; padding: 12px; background: #252525; border: 1px solid #333; border-radius: 8px; color: #fff;">
<option value="">Select contact...</option>
                        ${clients.map(c => `<option value="${c.id}">${c.name} (${c.email})</option>`).join('')}
</select>
</div>

<div style="margin-bottom: 16px;">
<label style="display: block; font-size: 14px; margin-bottom: 8px;">Channel</label>
<div style="display: flex; gap: 8px;">
<button onclick="setComposeChannel('sms')" id="ch_sms" style="flex: 1; padding: 12px; background: #10b981; border: none; color: #fff; border-radius: 8px; cursor: pointer;">📱 SMS</button>
<button onclick="setComposeChannel('email')" id="ch_email" style="flex: 1; padding: 12px; background: #333; border: none; color: #fff; border-radius: 8px; cursor: pointer;">✉️ Email</button>
</div>
</div>

<div id="emailSubjectField" style="display: none; margin-bottom: 16px;">
<label style="display: block; font-size: 14px; margin-bottom: 8px;">Subject</label>
<input type="text" id="composeSubject" placeholder="Email subject..." style="width: 100%; padding: 12px; background: #252525; border: 1px solid #333; border-radius: 8px; color: #fff;">
</div>

<div style="margin-bottom: 24px;">
<label style="display: block; font-size: 14px; margin-bottom: 8px;">Message</label>
<textarea id="composeMessage" rows="4" placeholder="Type your message..." style="width: 100%; padding: 12px; background: #252525; border: 1px solid #333; border-radius: 8px; color: #fff; resize: none;"></textarea>
</div>

<div style="display: flex; gap: 12px;">
<button onclick="document.getElementById('composeModal').remove()" style="flex: 1; padding: 12px; background: #333; border: none; color: #fff; border-radius: 8px; cursor: pointer;">Cancel</button>
<button onclick="sendComposedMessage()" style="flex: 1; padding: 12px; background: var(--red); border: none; color: #fff; border-radius: 8px; cursor: pointer; font-weight: 600;">Send Message</button>
</div>
</div>
</div>
    `;
    document.body.appendChild(modal);
}

let composeChannel = 'sms';

function setComposeChannel(channel) {
    composeChannel = channel;
    document.getElementById('ch_sms').style.background = channel === 'sms' ? '#10b981' : '#333';
    document.getElementById('ch_email').style.background = channel === 'email' ? '#3b82f6' : '#333';
    document.getElementById('emailSubjectField').style.display = channel === 'email' ? 'block' : 'none';
}

async function sendComposedMessage() {
    const recipientId = parseInt(document.getElementById('composeRecipient').value);
    const message = document.getElementById('composeMessage').value.trim();
    const subject = document.getElementById('composeSubject')?.value.trim() || '';

    if (!recipientId) { alert('Please select a recipient.'); return; }
    if (!message) { alert('Please enter a message.'); return; }

    const contact = getContactInfo(recipientId);
    let apiSuccess = false;

    try {
        if (composeChannel === 'sms' && contact.phone) {
            const res = await fetch('/.netlify/functions/send-sms', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ to: contact.phone, message, clientId: recipientId })
            });
            apiSuccess = res.ok;
        } else if (composeChannel === 'email' && contact.email) {
            const res = await fetch('/.netlify/functions/send-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    to: contact.email,
                    subject: subject || 'Message from New Urban Influence',
                    html: message.replace(/\n/g, '<br>'),
                    text: message,
                    clientId: recipientId
                })
            });
            apiSuccess = res.ok;
        }
    } catch (err) {
        console.warn('API send failed:', err.message);
    }

    // Store locally for immediate display
    const comms = JSON.parse(localStorage.getItem('nui_crm_communications')) || [];
    comms.push({
        id: Date.now(),
        clientId: recipientId,
        contactId: recipientId,
        channel: composeChannel,
        message: composeChannel === 'email' && subject ? `[${subject}] ${message}` : message,
        direction: 'outbound',
        createdAt: new Date().toISOString(),
        read: true,
        sentViaApi: apiSuccess
    });
    localStorage.setItem('nui_crm_communications', JSON.stringify(comms));

    document.getElementById('composeModal').remove();
    selectedConversationContact = recipientId;
    loadAdminCrmPanel();

    alert(apiSuccess
        ? `✅ ${composeChannel === 'sms' ? 'SMS' : 'Email'} sent to ${contact.name}!`
        : `⚠️ Message saved locally but API delivery failed. Check your ${composeChannel === 'sms' ? 'OpenPhone' : 'email'} settings.`);
}

// Drag and Drop for Pipeline
let draggedContactId = null;

function handleDragStart(e, contactId) {
    draggedContactId = contactId;
    e.target.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
}

function handleDragEnd(e) {
    e.target.classList.remove('dragging');
    document.querySelectorAll('.pipeline-col-body').forEach(col => col.classList.remove('drag-over'));
}

function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
}

function handleDragLeave(e) {
    e.currentTarget.classList.remove('drag-over');
}

function handleDrop(e, stageId) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');
    if (draggedContactId) {
        moveContactStage(draggedContactId, stageId);
        draggedContactId = null;
    }
}

function moveContactStage(contactId, newStage) {
    const contact = crmData.contacts.find(c => c.id === contactId);
    if (contact) {
        const oldStage = crmData.pipelines.find(p => p.id === contact.stage)?.name;
        const newStageName = crmData.pipelines.find(p => p.id === newStage)?.name;
        contact.stage = newStage;
        contact.lastActivity = new Date().toISOString();

        // Log the stage change
        if (!crmData.activityLog) crmData.activityLog = [];
        crmData.activityLog.push({
            id: Date.now(),
            contactId: contactId,
            type: 'stage_change',
            from: oldStage,
            to: newStageName,
            timestamp: new Date().toISOString()
        });

        saveCrm();
        loadAdminCrmPanel();
        console.log('✅ Contact moved: ' + contact.name + ' → ' + newStageName);
    }
}

// Quick Actions
function quickSms(contactId) {
    const contact = crmData.contacts.find(c => c.id === contactId);
    if (!contact?.phone) { alert('No phone number for this contact'); return; }

    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.id = 'quickSmsModal';
    modal.innerHTML = `
<div class="modal" style="max-width: 500px;">
<div class="modal-header"><h3 class="modal-title">💬 Send SMS to ${contact.name}</h3><button class="modal-close" onclick="document.getElementById('quickSmsModal').remove()">×</button></div>
<div class="modal-body">
<p style="color: rgba(255,255,255,0.5); margin-bottom: 16px;">To: ${contact.phone}</p>
<div class="form-group">
<label class="form-label">Template</label>
<select class="form-select" onchange="document.getElementById('quickSmsText').value = this.options[this.selectedIndex].dataset.msg || ''">
<option value="">-- Select Template --</option>
                        ${smsSystem.templates.map(t => '<option data-msg="' + t.message.replace(/{name}/g, contact.name) + '">' + t.name + '</option>').join('')}
</select>
</div>
<div class="form-group">
<label class="form-label">Message</label>
<textarea id="quickSmsText" class="form-textarea" rows="4" placeholder="Type your message..."></textarea>
</div>
</div>
<div class="modal-footer">
<button class="btn-admin secondary" onclick="document.getElementById('quickSmsModal').remove()">Cancel</button>
<button class="btn-admin primary" onclick="sendQuickSms(${contactId})" style="background: #10b981;">Send SMS</button>
</div>
</div>`;
    document.body.appendChild(modal);
}

function sendQuickSms(contactId) {
    const contact = crmData.contacts.find(c => c.id === contactId);
    const message = document.getElementById('quickSmsText').value;
    if (!message) { alert('Please enter a message'); return; }

    // Add to SMS conversations
    let convo = smsSystem.conversations.find(c => c.clientId === contactId || c.phone === contact.phone);
    if (!convo) {
        convo = { id: Date.now(), clientId: contactId, clientName: contact.name, phone: contact.phone, messages: [], lastMessage: null, unread: 0 };
        smsSystem.conversations.push(convo);
    }
    convo.messages.push({ id: Date.now(), direction: 'outbound', text: message, timestamp: new Date().toISOString(), status: 'sent' });
    convo.lastMessage = new Date().toISOString();
    saveSms();

    // Log activity
    logContactActivity(contactId, 'sms', message);

    document.getElementById('quickSmsModal').remove();
    alert('SMS sent to ' + contact.name + '!');
}

function quickEmail(contactId) {
    const contact = crmData.contacts.find(c => c.id === contactId);
    if (!contact?.email) { alert('No email for this contact'); return; }

    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.id = 'quickEmailModal';
    modal.innerHTML = `
<div class="modal" style="max-width: 600px;">
<div class="modal-header"><h3 class="modal-title">📧 Send Email to ${contact.name}</h3><button class="modal-close" onclick="document.getElementById('quickEmailModal').remove()">×</button></div>
<div class="modal-body">
<p style="color: rgba(255,255,255,0.5); margin-bottom: 16px;">To: ${contact.email}</p>
<div class="form-group">
<label class="form-label">Subject</label>
<input type="text" id="quickEmailSubject" class="form-input" placeholder="Email subject...">
</div>
<div class="form-group">
<label class="form-label">Message</label>
<textarea id="quickEmailText" class="form-textarea" rows="6" placeholder="Hi ${contact.name},\n\n"></textarea>
</div>
</div>
<div class="modal-footer">
<button class="btn-admin secondary" onclick="document.getElementById('quickEmailModal').remove()">Cancel</button>
<button class="btn-admin primary" onclick="sendQuickEmail(${contactId})" style="background: #3b82f6;">Send Email</button>
</div>
</div>`;
    document.body.appendChild(modal);
}

function sendQuickEmail(contactId) {
    const contact = crmData.contacts.find(c => c.id === contactId);
    const subject = document.getElementById('quickEmailSubject').value;
    const message = document.getElementById('quickEmailText').value;
    if (!subject || !message) { alert('Please enter subject and message'); return; }

    // Log activity
    logContactActivity(contactId, 'email', subject + ': ' + message.substring(0, 100));

    // Simulate sending
    simulateEmailNotification(contact.email, subject, message);

    document.getElementById('quickEmailModal').remove();
    alert('Email sent to ' + contact.name + '!');
}

function quickCall(contactId) {
    const contact = crmData.contacts.find(c => c.id === contactId);
    if (!contact?.phone) { alert('No phone number for this contact'); return; }

    // Log call attempt
    logContactActivity(contactId, 'call', 'Called ' + contact.phone);

    // Open phone dialer
    window.open('tel:' + contact.phone, '_self');
}

function logContactActivity(contactId, type, details) {
    if (!crmData.activityLog) crmData.activityLog = [];
    crmData.activityLog.push({
        id: Date.now(),
        contactId: contactId,
        type: type,
        details: details,
        timestamp: new Date().toISOString()
    });
    saveCrm();
}

// Smart Groups
function getSmartGroupContacts(group) {
    const filter = group.filter;
    let contacts = [...crmData.contacts];

    if (filter.type === 'all') return contacts;
    if (filter.type === 'stage') {
        contacts = contacts.filter(c => filter.stages.includes(c.stage));
    }
    if (filter.type === 'value') {
        contacts = contacts.filter(c => (c.value || 0) >= (filter.min || 0));
    }
    if (filter.type === 'date') {
        const cutoff = new Date(Date.now() - (filter.days || 7) * 24 * 60 * 60 * 1000);
        contacts = contacts.filter(c => new Date(c.createdAt) >= cutoff);
    }
    if (filter.hasPhone) {
        contacts = contacts.filter(c => c.phone);
    }
    if (filter.hasEmail) {
        contacts = contacts.filter(c => c.email);
    }
    return contacts;
}

function getSmartGroupDescription(group) {
    const filter = group.filter;
    if (filter.type === 'all') return 'All contacts in your CRM';
    if (filter.type === 'stage') return 'Contacts in ' + filter.stages.map(s => crmData.pipelines.find(p => p.id === s)?.name).join(', ');
    if (filter.type === 'value') return 'Contacts with deals $' + (filter.min || 0).toLocaleString() + '+';
    if (filter.type === 'date') return 'Added in last ' + filter.days + ' days';
    return 'Custom filter';
}

function showCreateSmartGroupModal() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.id = 'smartGroupModal';
    modal.innerHTML = `
<div class="modal">
<div class="modal-header"><h3 class="modal-title">Create Smart Group</h3><button class="modal-close" onclick="document.getElementById('smartGroupModal').remove()">×</button></div>
<div class="modal-body">
<div class="form-group"><label class="form-label">Group Name</label><input type="text" id="sgName" class="form-input" placeholder="e.g., Hot Leads"></div>
<div class="form-group"><label class="form-label">Filter Type</label>
<select id="sgFilterType" class="form-select" onchange="updateSmartGroupFilter()">
<option value="all">All Contacts</option>
<option value="stage">By Pipeline Stage</option>
<option value="value">By Deal Value</option>
<option value="date">By Date Added</option>
</select>
</div>
<div id="sgFilterOptions"></div>
<div class="form-group"><label class="form-label">Color</label>
<div style="display: flex; gap: 8px;">
                        ${['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'].map(c => '<div onclick="document.getElementById(\'sgColor\').value=\'' + c + '\'; this.parentElement.querySelectorAll(\'div\').forEach(d=>d.style.border=\'2px solid transparent\'); this.style.border=\'2px solid #fff\';" style="width: 32px; height: 32px; background: ' + c + '; border-radius: 6px; cursor: pointer; border: 2px solid transparent;"></div>').join('')}
</div>
<input type="hidden" id="sgColor" value="#3b82f6">
</div>
</div>
<div class="modal-footer">
<button class="btn-admin secondary" onclick="document.getElementById('smartGroupModal').remove()">Cancel</button>
<button class="btn-admin primary" onclick="createSmartGroup()">Create Group</button>
</div>
</div>`;
    document.body.appendChild(modal);
}

function updateSmartGroupFilter() {
    const type = document.getElementById('sgFilterType').value;
    const container = document.getElementById('sgFilterOptions');

    if (type === 'stage') {
        container.innerHTML = '<div class="form-group"><label class="form-label">Select Stages</label>' + crmData.pipelines.map(p => '<label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;"><input type="checkbox" class="sg-stage" value="' + p.id + '"> ' + p.name + '</label>').join('') + '</div>';
    } else if (type === 'value') {
        container.innerHTML = '<div class="form-group"><label class="form-label">Minimum Value ($)</label><input type="number" id="sgMinValue" class="form-input" placeholder="5000"></div>';
    } else if (type === 'date') {
        container.innerHTML = '<div class="form-group"><label class="form-label">Added within last X days</label><input type="number" id="sgDays" class="form-input" placeholder="7"></div>';
    } else {
        container.innerHTML = '';
    }
}

function createSmartGroup() {
    const name = document.getElementById('sgName').value;
    if (!name) { alert('Please enter a group name'); return; }

    const type = document.getElementById('sgFilterType').value;
    const color = document.getElementById('sgColor').value;

    const filter = { type };
    if (type === 'stage') {
        filter.stages = [...document.querySelectorAll('.sg-stage:checked')].map(cb => parseInt(cb.value));
    } else if (type === 'value') {
        filter.min = parseInt(document.getElementById('sgMinValue').value) || 0;
    } else if (type === 'date') {
        filter.days = parseInt(document.getElementById('sgDays').value) || 7;
    }

    crmSmartGroups.push({ id: Date.now(), name, filter, color });
    saveSmartGroups();
    document.getElementById('smartGroupModal').remove();
    loadAdminCrmPanel();
}

// Bulk Messaging
function bulkSmsGroup(groupId) {
    const group = crmSmartGroups.find(g => g.id === groupId);
    const contacts = getSmartGroupContacts(group).filter(c => c.phone);

    if (contacts.length === 0) { alert('No contacts with phone numbers in this group'); return; }

    switchCrmTab('bulk');
    document.getElementById('bulkSmsGroup').value = groupId;
    alert('Ready to send SMS to ' + contacts.length + ' contacts in "' + group.name + '"');
}

function bulkEmailGroup(groupId) {
    const group = crmSmartGroups.find(g => g.id === groupId);
    const contacts = getSmartGroupContacts(group).filter(c => c.email);

    if (contacts.length === 0) { alert('No contacts with email in this group'); return; }

    switchCrmTab('bulk');
    document.getElementById('bulkEmailGroup').value = groupId;
    alert('Ready to send Email to ' + contacts.length + ' contacts in "' + group.name + '"');
}

function loadSmsTemplate(templateId) {
    const template = smsSystem.templates.find(t => t.id == templateId);
    if (template) document.getElementById('bulkSmsMessage').value = template.message;
}

function loadEmailTemplate(templateId) {
    const template = emailMarketing.templates.find(t => t.id == templateId);
    if (template) {
        document.getElementById('bulkEmailSubject').value = template.subject;
        document.getElementById('bulkEmailMessage').value = template.content || '';
    }
}

function sendBulkSms() {
    const groupId = parseInt(document.getElementById('bulkSmsGroup').value);
    const message = document.getElementById('bulkSmsMessage').value;
    if (!message) { alert('Please enter a message'); return; }

    const group = crmSmartGroups.find(g => g.id === groupId);
    const contacts = getSmartGroupContacts(group).filter(c => c.phone);

    if (contacts.length === 0) { alert('No contacts with phone numbers'); return; }
    if (!confirm('Send SMS to ' + contacts.length + ' contacts?')) return;

    // Simulate sending
    contacts.forEach(contact => {
        const personalizedMsg = message.replace(/{name}/g, contact.name).replace(/{company}/g, contact.company || '');
        console.log('SMS to ' + contact.phone + ': ' + personalizedMsg);
    });

    // Log bulk message
    if (!crmData.bulkMessages) crmData.bulkMessages = [];
    crmData.bulkMessages.push({
        id: Date.now(),
        type: 'sms',
        groupId: groupId,
        groupName: group.name,
        recipients: contacts.length,
        message: message,
        sentAt: new Date().toISOString()
    });
    saveCrm();

    alert('✅ SMS blast sent to ' + contacts.length + ' contacts!');
    loadAdminCrmPanel();
}

function sendBulkEmail() {
    const groupId = parseInt(document.getElementById('bulkEmailGroup').value);
    const subject = document.getElementById('bulkEmailSubject').value;
    const message = document.getElementById('bulkEmailMessage').value;
    if (!subject || !message) { alert('Please enter subject and message'); return; }

    const group = crmSmartGroups.find(g => g.id === groupId);
    const contacts = getSmartGroupContacts(group).filter(c => c.email);

    if (contacts.length === 0) { alert('No contacts with email'); return; }
    if (!confirm('Send email to ' + contacts.length + ' contacts?')) return;

    // Create email campaign
    emailMarketing.campaigns.push({
        id: Date.now(),
        name: 'CRM Blast: ' + group.name,
        status: 'sent',
        sentAt: new Date().toISOString(),
        recipients: contacts.length,
        opened: 0,
        clicked: 0,
        createdAt: new Date().toISOString()
    });
    saveEmailMarketing();

    // Log bulk message
    if (!crmData.bulkMessages) crmData.bulkMessages = [];
    crmData.bulkMessages.push({
        id: Date.now(),
        type: 'email',
        groupId: groupId,
        groupName: group.name,
        recipients: contacts.length,
        subject: subject,
        sentAt: new Date().toISOString()
    });
    saveCrm();

    alert('✅ Email blast sent to ' + contacts.length + ' contacts!');
    loadAdminCrmPanel();
}

function filterCrmContacts(query) {
    const rows = document.querySelectorAll('#crmContactsTableBody tr');
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(query.toLowerCase()) ? '' : 'none';
    });
}

function toggleAllContacts(checked) {
    document.querySelectorAll('.contact-checkbox').forEach(cb => cb.checked = checked);
}

function showAddContactModal() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.id = 'contactModal';
    modal.innerHTML = `
<div class="modal">
<div class="modal-header"><h3 class="modal-title">Add Contact</h3><button class="modal-close" onclick="document.getElementById('contactModal').remove()">×</button></div>
<div class="modal-body">
<div class="form-group"><label class="form-label">Name *</label><input type="text" id="contactName" class="form-input" placeholder="John Doe"></div>
<div class="form-group"><label class="form-label">Email</label><input type="email" id="contactEmail" class="form-input" placeholder="john@company.com"></div>
<div class="form-group"><label class="form-label">Company</label><input type="text" id="contactCompany" class="form-input" placeholder="Company Name"></div>
<div class="form-group"><label class="form-label">Phone</label><input type="tel" id="contactPhone" class="form-input" placeholder="(248) 487-8747"></div>
<div class="form-group"><label class="form-label">Deal Value ($)</label><input type="number" id="contactValue" class="form-input" placeholder="5000"></div>
<div class="form-group"><label class="form-label">Stage</label><select id="contactStage" class="form-select">${crmData.pipelines.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}</select></div>
<div class="form-group"><label class="form-label">Notes</label><textarea id="contactNotes" class="form-textarea" placeholder="Additional notes..."></textarea></div>
</div>
<div class="modal-footer"><button class="btn-admin secondary" onclick="document.getElementById('contactModal').remove()">Cancel</button><button class="btn-admin primary" onclick="saveContact()">Save Contact</button></div>
</div>
    `;
    document.body.appendChild(modal);
}

function saveContact() {
    const contact = {
        id: Date.now(),
        name: document.getElementById('contactName').value,
        email: document.getElementById('contactEmail').value,
        company: document.getElementById('contactCompany').value,
        phone: document.getElementById('contactPhone').value,
        value: parseInt(document.getElementById('contactValue').value) || 0,
        stage: parseInt(document.getElementById('contactStage').value),
        notes: document.getElementById('contactNotes').value,
        createdAt: new Date().toISOString()
    };
    crmData.contacts.push(contact);
    saveCrm();
    document.getElementById('contactModal').remove();
    loadAdminCrmPanel();
}

function editContact(id) {
    const contact = crmData.contacts.find(c => c.id === id);
    if (!contact) return;
    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.id = 'contactModal';
    modal.innerHTML = `
<div class="modal">
<div class="modal-header"><h3 class="modal-title">Edit Contact</h3><button class="modal-close" onclick="document.getElementById('contactModal').remove()">×</button></div>
<div class="modal-body">
<div class="form-group"><label class="form-label">Name *</label><input type="text" id="contactName" class="form-input" value="${contact.name}"></div>
<div class="form-group"><label class="form-label">Email</label><input type="email" id="contactEmail" class="form-input" value="${contact.email || ''}"></div>
<div class="form-group"><label class="form-label">Company</label><input type="text" id="contactCompany" class="form-input" value="${contact.company || ''}"></div>
<div class="form-group"><label class="form-label">Phone</label><input type="tel" id="contactPhone" class="form-input" value="${contact.phone || ''}"></div>
<div class="form-group"><label class="form-label">Deal Value ($)</label><input type="number" id="contactValue" class="form-input" value="${contact.value || 0}"></div>
<div class="form-group"><label class="form-label">Stage</label><select id="contactStage" class="form-select">${crmData.pipelines.map(p => `<option value="${p.id}" ${contact.stage === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}</select></div>
<div class="form-group"><label class="form-label">Notes</label><textarea id="contactNotes" class="form-textarea">${contact.notes || ''}</textarea></div>
</div>
<div class="modal-footer"><button class="btn-admin danger" onclick="deleteContact(${id})">Delete</button><button class="btn-admin secondary" onclick="document.getElementById('contactModal').remove()">Cancel</button><button class="btn-admin primary" onclick="updateContact(${id})">Update</button></div>
</div>
    `;
    document.body.appendChild(modal);
}

function updateContact(id) {
    const idx = crmData.contacts.findIndex(c => c.id === id);
    if (idx === -1) return;
    crmData.contacts[idx] = { ...crmData.contacts[idx], name: document.getElementById('contactName').value, email: document.getElementById('contactEmail').value, company: document.getElementById('contactCompany').value, phone: document.getElementById('contactPhone').value, value: parseInt(document.getElementById('contactValue').value) || 0, stage: parseInt(document.getElementById('contactStage').value), notes: document.getElementById('contactNotes').value };
    saveCrm();
    document.getElementById('contactModal').remove();
    loadAdminCrmPanel();
}

function deleteContact(id) {
    if (!confirm('Delete this contact?')) return;
    crmData.contacts = crmData.contacts.filter(c => c.id !== id);
    saveCrm();
    document.getElementById('contactModal').remove();
    loadAdminCrmPanel();
}

// ==================== PROJECTS PANEL ====================
function loadAdminProjectsPanel() {
    const projectStages = ['Discovery', 'Design', 'Development', 'Review', 'Delivery', 'Complete'];
    document.getElementById('adminProjectsPanel').innerHTML = `
<div class="panel-header">
<h2 class="panel-title">📂 Project Tracker</h2>
<p class="panel-subtitle">Track project progress, timers, and payments</p>
</div>

        <!-- Stats Overview -->
<div class="stats-grid">
<div class="stat-card">
<div class="stat-label">Active Projects</div>
<div class="stat-value">${projects.filter(p => p.stage !== 'Complete').length}</div>
</div>
<div class="stat-card">
<div class="stat-label">Completed</div>
<div class="stat-value" style="color: #2a9d8f;">${projects.filter(p => p.stage === 'Complete').length}</div>
</div>
<div class="stat-card">
<div class="stat-label">Total Value</div>
<div class="stat-value">$${projects.reduce((s, p) => s + (p.totalAmount || 0), 0).toLocaleString()}</div>
</div>
<div class="stat-card">
<div class="stat-label">This Month</div>
<div class="stat-value">${projects.filter(p => new Date(p.createdAt).getMonth() === new Date().getMonth()).length}</div>
</div>
</div>

<div style="display: flex; justify-content: flex-end; margin-bottom: 24px;">
<button class="btn-admin primary" onclick="showAddProjectModal()">+ New Project</button>
</div>
        ${projects.length === 0 ? '<div class="form-section" style="text-align: center; padding: 60px;"><p style="color: rgba(255,255,255,0.5);">No projects yet. Create your first project!</p></div>' : projects.map(project => {
            const client = crmData.clients?.find(c => c.id === project.clientId) || clients.find(c => c.id === project.clientId) || { name: 'Unknown' };
            const stageIdx = projectStages.indexOf(project.stage || 'Discovery');
            const progress = Math.round(((stageIdx + 1) / projectStages.length) * 100);
            const timeTracked = project.timeTracked || 0;
            const hours = Math.floor(timeTracked / 3600);
            const mins = Math.floor((timeTracked % 3600) / 60);
            const pkg = servicePackages.find(p => p.id === project.packageId) || { name: project.type || 'Custom' };
            const plan = paymentPlans[project.paymentPlan] || { name: 'Full Payment' };

            return `
<div class="order-card" style="position: relative;">
                    <!-- Timer Badge -->
<div style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.1); padding: 8px 16px; border-radius: 20px; display: flex; align-items: center; gap: 8px;">
<span style="font-size: 12px; opacity: 0.7;">⏱️</span>
<span id="timer-${project.id}" style="font-family: monospace; font-size: 14px;">${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}:00</span>
<button class="timer-btn ${project.timerRunning ? 'active' : ''}" onclick="toggleProjectTimer(${project.id})" style="background: ${project.timerRunning ? 'var(--red)' : 'rgba(255,255,255,0.2)'}; border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; color: #fff; font-size: 12px;">
                            ${project.timerRunning ? '⏸' : '▶'}
</button>
</div>

<div class="order-header">
<div>
<div class="order-title">${project.name}</div>
<div class="order-client">${client.name}</div>
<div style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap;">
<span class="tag">${pkg.name}</span>
                                ${project.totalAmount ? `<span class="tag" style="background: rgba(42, 157, 143, 0.2); color: #2a9d8f;">$${project.totalAmount.toLocaleString()}</span>` : ''}
<span class="tag" style="background: rgba(230, 57, 70, 0.2);">${plan.name}</span>
</div>
</div>
<span class="order-status ${project.stage === 'Complete' ? 'approved' : 'in_progress'}">${project.stage || 'Discovery'}</span>
</div>
<div class="project-stages">
                        ${projectStages.map((stage, i) => `<div class="project-stage ${i <= stageIdx ? (i < stageIdx ? 'completed' : 'active') : ''}">${stage}</div>`).join('')}
</div>
<div style="margin-bottom: 16px;">
<div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
<span style="font-size: 13px; color: rgba(255,255,255,0.5);">Progress</span>
<span style="font-size: 13px; font-weight: 600;">${progress}%</span>
</div>
<div class="progress-bar"><div class="progress-fill" style="width: ${progress}%"></div></div>
</div>

                    <!-- Payment Progress -->
                    ${project.paymentPlan && project.paymentPlan !== 'full' ? `
<div style="margin-bottom: 16px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px;">
<div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
<span style="font-size: 12px; opacity: 0.7;">💳 Payment Progress</span>
<span style="font-size: 12px;">${project.paidInstallments || 0}/${paymentPlans[project.paymentPlan]?.installments || 3} paid</span>
</div>
<div style="display: flex; gap: 4px;">
                            ${paymentPlans[project.paymentPlan]?.schedule?.map((pct, i) => `
<div style="flex: ${pct}; height: 6px; background: ${i < (project.paidInstallments || 0) ? '#2a9d8f' : 'rgba(255,255,255,0.1)'}; border-radius: 3px;"></div>
                            `).join('') || ''}
</div>
</div>
                    ` : ''}

<div style="display: flex; gap: 12px; flex-wrap: wrap;">
<button class="btn-admin secondary" onclick="editProject(${project.id})">Edit</button>
<button class="btn-admin secondary" onclick="viewProjectDetails(${project.id})">📊 Details</button>
<button class="btn-admin primary" onclick="advanceProject(${project.id})">Advance Stage →</button>
</div>
</div>
            `;
        }).join('')}
    `;

    // Start running timers
    projects.filter(p => p.timerRunning).forEach(p => startTimerInterval(p.id));
}

function showAddProjectModal() {
    const allClients = [...(crmData.clients || []), ...clients];
    const uniqueClients = allClients.filter((c, i, arr) => arr.findIndex(x => x.id === c.id) === i);

    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.id = 'projectModal';
    modal.innerHTML = `
<div class="modal" style="max-width: 700px;">
<div class="modal-header"><h3 class="modal-title">New Project</h3><button class="modal-close" onclick="document.getElementById('projectModal').remove()">×</button></div>
<div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
<div class="form-row">
<div class="form-group">
<label class="form-label">Project Name *</label>
<input type="text" id="projectName" class="form-input" placeholder="Brand Identity Package">
</div>
<div class="form-group">
<label class="form-label">Client *</label>
<select id="projectClient" class="form-select">
<option value="">Select client...</option>
                            ${uniqueClients.map(c => `<option value="${c.id}">${c.name} ${c.company ? '- ' + c.company : ''}</option>`).join('')}
</select>
</div>
</div>

                <!-- Package Selection -->
<div class="form-section" style="margin-top: 16px;">
<div class="form-section-title">📦 Select Package</div>
<div class="form-group">
<label class="form-label">Service Package</label>
<select id="projectPackage" class="form-select" onchange="updateProjectPrice()">
<option value="">-- Select Package --</option>
                            ${servicePackages.map(pkg => `
<option value="${pkg.id}" data-price="${pkg.price}" data-turnaround="${pkg.turnaround}">
                                    ${pkg.name} - $${pkg.price.toLocaleString()} (${pkg.turnaround})
</option>
                            `).join('')}
<option value="custom">Custom / Individual Services</option>
</select>
</div>
<div id="packageInfo" style="display: none; padding: 12px; background: rgba(42, 157, 143, 0.1); border-radius: 8px; margin-bottom: 16px;">
<div style="display: flex; justify-content: space-between; align-items: center;">
<div>
<strong id="selectedPackageName"></strong>
<p id="selectedPackageDesc" style="font-size: 13px; opacity: 0.7; margin-top: 4px;"></p>
</div>
<div style="text-align: right;">
<div style="font-size: 24px; font-weight: 600; color: #2a9d8f;">$<span id="selectedPackagePrice">0</span></div>
<div style="font-size: 12px; opacity: 0.7;" id="selectedPackageTurnaround"></div>
</div>
</div>
</div>
</div>

                <!-- Individual Services (shown when custom selected) -->
<div id="individualServicesSection" style="display: none;" class="form-section">
<div class="form-section-title">🛠️ Individual Services</div>
<p style="font-size: 13px; color: rgba(255,255,255,0.5); margin-bottom: 16px;">Select individual services to add to this project:</p>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        ${individualServices.map(service => `
<label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'">
<input type="checkbox" class="service-checkbox" data-id="${service.id}" data-price="${service.price}" data-name="${service.name}" onchange="updateProjectPrice()">
<div style="flex: 1;">
<div style="font-size: 14px;">${service.name}</div>
<div style="font-size: 12px; opacity: 0.7;">${service.category}</div>
</div>
<span style="font-weight: 600; color: #2a9d8f;">$${service.price}</span>
</label>
                        `).join('')}
</div>
</div>

                <!-- Custom Amount Override -->
<div class="form-group" style="margin-top: 16px;">
<label class="form-label">Custom Price Override (optional)</label>
<input type="number" id="projectCustomPrice" class="form-input" placeholder="Leave blank to use package/service price" onchange="updateProjectPrice()">
</div>

                <!-- Payment Plan Selection -->
<div class="form-section" style="margin-top: 16px;">
<div class="form-section-title">💳 Payment Plan</div>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                        ${Object.entries(paymentPlans).map(([key, plan]) => `
<label style="display: block; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 12px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;" id="plan-${key}" onclick="selectPaymentPlan('${key}')">
<input type="radio" name="paymentPlan" value="${key}" style="display: none;" ${key === 'standard' ? 'checked' : ''}>
<div style="font-weight: 600; margin-bottom: 4px;">${plan.name}</div>
                                ${plan.discount > 0 ? `<div style="font-size: 12px; color: #2a9d8f;">Save ${plan.discount}%</div>` : ''}
<div style="font-size: 12px; opacity: 0.7; margin-top: 8px;">${plan.schedule.join('% → ')}%</div>
                                ${plan.triggers ? `<div style="font-size: 11px; opacity: 0.5; margin-top: 4px;">${plan.triggers.join(' → ')}</div>` : ''}
</label>
                        `).join('')}
</div>
</div>

                <!-- Total Summary -->
<div style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, rgba(230, 57, 70, 0.1), rgba(29, 53, 87, 0.1)); border-radius: 12px; border: 1px solid rgba(230, 57, 70, 0.3);">
<div style="display: flex; justify-content: space-between; align-items: center;">
<div>
<div style="font-size: 14px; opacity: 0.7;">Project Total</div>
<div style="font-size: 11px; opacity: 0.5;" id="paymentBreakdown">50% deposit → 25% on approval → 25% before download</div>
</div>
<div style="text-align: right;">
<div style="font-size: 32px; font-weight: 700; color: var(--red);">$<span id="projectTotalAmount">0</span></div>
<div style="font-size: 12px; opacity: 0.7;" id="discountNote"></div>
</div>
</div>
</div>

<div class="form-row" style="margin-top: 16px;">
<div class="form-group">
<label class="form-label">Start Date</label>
<input type="date" id="projectStart" class="form-input" value="${new Date().toISOString().split('T')[0]}">
</div>
<div class="form-group">
<label class="form-label">Due Date</label>
<input type="date" id="projectDue" class="form-input">
</div>
</div>
<div class="form-group">
<label class="form-label">Notes</label>
<textarea id="projectNotes" class="form-textarea" placeholder="Project details, special requirements..."></textarea>
</div>
</div>
<div class="modal-footer">
<button class="btn-admin secondary" onclick="document.getElementById('projectModal').remove()">Cancel</button>
<button class="btn-admin primary" onclick="saveProject()">Create Project</button>
</div>
</div>
    `;
    document.body.appendChild(modal);

    // Initialize payment plan selection
    selectPaymentPlan('standard');
}

function selectPaymentPlan(planKey) {
    // Update visual selection
    Object.keys(paymentPlans).forEach(key => {
        const el = document.getElementById('plan-' + key);
        if (el) {
            el.style.borderColor = key === planKey ? 'var(--red)' : 'transparent';
            el.style.background = key === planKey ? 'rgba(230, 57, 70, 0.15)' : 'rgba(255,255,255,0.05)';
            el.querySelector('input').checked = key === planKey;
        }
    });

    // Update breakdown text
    const plan = paymentPlans[planKey];
    const breakdown = document.getElementById('paymentBreakdown');
    if (breakdown && plan.triggers) {
        breakdown.textContent = plan.schedule.map((pct, i) => `${pct}% ${plan.triggers[i]}`).join(' → ');
    } else if (breakdown) {
        breakdown.textContent = plan.name;
    }

    updateProjectPrice();
}

function updateProjectPrice() {
    const packageSelect = document.getElementById('projectPackage');
    const customPrice = document.getElementById('projectCustomPrice');
    const totalEl = document.getElementById('projectTotalAmount');
    const packageInfo = document.getElementById('packageInfo');
    const servicesSection = document.getElementById('individualServicesSection');
    const discountNote = document.getElementById('discountNote');

    let total = 0;

    if (packageSelect.value === 'custom') {
        // Show individual services
        servicesSection.style.display = 'block';
        packageInfo.style.display = 'none';

        // Calculate from selected services
        document.querySelectorAll('.service-checkbox:checked').forEach(cb => {
            total += parseFloat(cb.dataset.price) || 0;
        });
    } else if (packageSelect.value) {
        // Show package info
        servicesSection.style.display = 'none';
        packageInfo.style.display = 'block';

        const pkg = servicePackages.find(p => p.id === packageSelect.value);
        if (pkg) {
            document.getElementById('selectedPackageName').textContent = pkg.name;
            document.getElementById('selectedPackageDesc').textContent = pkg.desc;
            document.getElementById('selectedPackagePrice').textContent = pkg.price.toLocaleString();
            document.getElementById('selectedPackageTurnaround').textContent = pkg.turnaround;
            total = pkg.price;
        }
    } else {
        servicesSection.style.display = 'none';
        packageInfo.style.display = 'none';
    }

    // Override with custom price if provided
    if (customPrice.value) {
        total = parseFloat(customPrice.value);
    }

    // Apply discount based on payment plan
    const selectedPlan = document.querySelector('input[name="paymentPlan"]:checked')?.value;
    const plan = paymentPlans[selectedPlan];
    if (plan && plan.discount > 0) {
        const discount = total * (plan.discount / 100);
        total = total - discount;
        discountNote.textContent = `${plan.discount}% discount applied`;
    } else {
        discountNote.textContent = '';
    }

    totalEl.textContent = total.toLocaleString();
}

function saveProject() {
    const packageSelect = document.getElementById('projectPackage');
    const pkg = servicePackages.find(p => p.id === packageSelect.value);
    const selectedPlan = document.querySelector('input[name="paymentPlan"]:checked')?.value || 'standard';
    const customPrice = parseFloat(document.getElementById('projectCustomPrice').value);

    // Get selected services if custom
    const selectedServices = [];
    if (packageSelect.value === 'custom') {
        document.querySelectorAll('.service-checkbox:checked').forEach(cb => {
            selectedServices.push({
                id: cb.dataset.id,
                name: cb.dataset.name,
                price: parseFloat(cb.dataset.price)
            });
        });
    }

    // Calculate total
    let totalAmount = 0;
    if (customPrice) {
        totalAmount = customPrice;
    } else if (pkg) {
        totalAmount = pkg.price;
    } else {
        totalAmount = selectedServices.reduce((sum, s) => sum + s.price, 0);
    }

    // Apply discount
    const plan = paymentPlans[selectedPlan];
    if (plan && plan.discount > 0) {
        totalAmount = totalAmount - (totalAmount * (plan.discount / 100));
    }

    const project = {
        id: Date.now(),
        name: document.getElementById('projectName').value,
        clientId: parseInt(document.getElementById('projectClient').value) || null,
        packageId: packageSelect.value !== 'custom' ? packageSelect.value : null,
        package: pkg ? pkg.name : 'Custom',
        type: pkg ? pkg.category : 'Custom',
        services: selectedServices,
        paymentPlan: selectedPlan,
        totalAmount: totalAmount,
        paidInstallments: 0,
        stage: 'Discovery',
        startDate: document.getElementById('projectStart').value,
        dueDate: document.getElementById('projectDue').value,
        notes: document.getElementById('projectNotes').value,
        timeTracked: 0,
        timerRunning: false,
        timerStartedAt: null,
        activityLog: [{
            action: 'Project created',
            timestamp: new Date().toISOString(),
            stage: 'Discovery'
        }],
        createdAt: new Date().toISOString()
    };
    projects.push(project);
    saveProjects();
    document.getElementById('projectModal').remove();
    loadAdminProjectsPanel();
    alert('Project created successfully! Total: $' + totalAmount.toLocaleString());
}

// Timer functionality
let timerIntervals = {};

function toggleProjectTimer(projectId) {
    const project = projects.find(p => p.id === projectId);
    if (!project) return;

    if (project.timerRunning) {
        // Stop timer
        stopProjectTimer(projectId);
    } else {
        // Start timer
        startProjectTimer(projectId);
    }
}

function startProjectTimer(projectId) {
    const project = projects.find(p => p.id === projectId);
    if (!project) return;

    project.timerRunning = true;
    project.timerStartedAt = Date.now();
    saveProjects();

    startTimerInterval(projectId);
    loadAdminProjectsPanel();
}

function stopProjectTimer(projectId) {
    const project = projects.find(p => p.id === projectId);
    if (!project) return;

    // Calculate elapsed time
    if (project.timerStartedAt) {
        const elapsed = Math.floor((Date.now() - project.timerStartedAt) / 1000);
        project.timeTracked = (project.timeTracked || 0) + elapsed;
    }

    project.timerRunning = false;
    project.timerStartedAt = null;

    // Clear interval
    if (timerIntervals[projectId]) {
        clearInterval(timerIntervals[projectId]);
        delete timerIntervals[projectId];
    }

    // Log activity
    project.activityLog = project.activityLog || [];
    project.activityLog.push({
        action: 'Timer stopped',
        timestamp: new Date().toISOString(),
        duration: project.timeTracked
    });

    saveProjects();
    loadAdminProjectsPanel();
}

function startTimerInterval(projectId) {
    if (timerIntervals[projectId]) return;

    timerIntervals[projectId] = setInterval(() => {
        const project = projects.find(p => p.id === projectId);
        if (!project || !project.timerRunning) {
            clearInterval(timerIntervals[projectId]);
            delete timerIntervals[projectId];
            return;
        }

        const elapsed = project.timerStartedAt ? Math.floor((Date.now() - project.timerStartedAt) / 1000) : 0;
        const totalSeconds = (project.timeTracked || 0) + elapsed;
        const hours = Math.floor(totalSeconds / 3600);
        const mins = Math.floor((totalSeconds % 3600) / 60);
        const secs = totalSeconds % 60;

        const timerEl = document.getElementById('timer-' + projectId);
        if (timerEl) {
            timerEl.textContent = `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
    }, 1000);
}

function viewProjectDetails(projectId) {
    const project = projects.find(p => p.id === projectId);
    if (!project) return;

    const client = crmData.clients?.find(c => c.id === project.clientId) || clients.find(c => c.id === project.clientId) || { name: 'Unknown' };
    const pkg = servicePackages.find(p => p.id === project.packageId) || { name: project.package || 'Custom' };
    const plan = paymentPlans[project.paymentPlan] || { name: 'Full Payment', schedule: [100] };
    const timeTracked = project.timeTracked || 0;
    const hours = Math.floor(timeTracked / 3600);
    const mins = Math.floor((timeTracked % 3600) / 60);

    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.id = 'projectDetailsModal';
    modal.innerHTML = `
<div class="modal" style="max-width: 800px;">
<div class="modal-header" style="background: var(--red);">
<h3 class="modal-title" style="color: #fff;">📊 ${project.name}</h3>
<button class="modal-close" onclick="document.getElementById('projectDetailsModal').remove()" style="color: #fff;">×</button>
</div>
<div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <!-- Overview Cards -->
<div class="stats-grid" style="margin-bottom: 24px;">
<div class="stat-card">
<div class="stat-label">Client</div>
<div class="stat-value" style="font-size: 18px;">${client.name}</div>
</div>
<div class="stat-card">
<div class="stat-label">Package</div>
<div class="stat-value" style="font-size: 18px;">${pkg.name}</div>
</div>
<div class="stat-card">
<div class="stat-label">Value</div>
<div class="stat-value" style="color: #2a9d8f;">$${(project.totalAmount || 0).toLocaleString()}</div>
</div>
<div class="stat-card">
<div class="stat-label">Time Tracked</div>
<div class="stat-value" style="font-family: monospace;">${hours}h ${mins}m</div>
</div>
</div>

                <!-- Project Timeline -->
<div class="form-section">
<div class="form-section-title">📅 Timeline</div>
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
<div style="padding: 16px; background: rgba(255,255,255,0.05); border-radius: 8px;">
<div style="font-size: 12px; opacity: 0.6;">Start Date</div>
<div style="font-size: 16px;">${project.startDate ? new Date(project.startDate).toLocaleDateString() : 'Not set'}</div>
</div>
<div style="padding: 16px; background: rgba(255,255,255,0.05); border-radius: 8px;">
<div style="font-size: 12px; opacity: 0.6;">Due Date</div>
<div style="font-size: 16px;">${project.dueDate ? new Date(project.dueDate).toLocaleDateString() : 'Not set'}</div>
</div>
<div style="padding: 16px; background: rgba(255,255,255,0.05); border-radius: 8px;">
<div style="font-size: 12px; opacity: 0.6;">Current Stage</div>
<div style="font-size: 16px;">${project.stage || 'Discovery'}</div>
</div>
</div>
</div>

                <!-- Payment Progress -->
<div class="form-section">
<div class="form-section-title">💳 Payment Schedule (${plan.name})</div>
<div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        ${plan.schedule.map((pct, i) => {
                            const isPaid = i < (project.paidInstallments || 0);
                            const amount = Math.round((project.totalAmount || 0) * pct / 100);
                            return `
<div style="flex: 1; min-width: 150px; padding: 16px; background: ${isPaid ? 'rgba(42, 157, 143, 0.2)' : 'rgba(255,255,255,0.05)'}; border-radius: 12px; border: 2px solid ${isPaid ? '#2a9d8f' : 'transparent'};">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
<span style="font-size: 12px; opacity: 0.7;">${plan.triggers?.[i] || `Payment ${i + 1}`}</span>
                                        ${isPaid ? '<span style="color: #2a9d8f;">✓</span>' : ''}
</div>
<div style="font-size: 20px; font-weight: 600;">$${amount.toLocaleString()}</div>
<div style="font-size: 12px; opacity: 0.5;">${pct}%</div>
</div>
                            `;
                        }).join('')}
</div>
                    ${project.paidInstallments < plan.schedule.length ? `
<button class="btn-admin primary" style="margin-top: 16px;" onclick="recordProjectPayment(${project.id})">
                            💳 Record Next Payment ($${Math.round((project.totalAmount || 0) * plan.schedule[project.paidInstallments || 0] / 100).toLocaleString()})
</button>
                    ` : '<p style="color: #2a9d8f; margin-top: 16px;">✓ All payments received!</p>'}
</div>

                <!-- Services Included -->
                ${project.services && project.services.length > 0 ? `
<div class="form-section">
<div class="form-section-title">🛠️ Services Included</div>
<div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${project.services.map(s => `<span class="tag">${s.name} - $${s.price}</span>`).join('')}
</div>
</div>
                ` : ''}

                <!-- Activity Log -->
<div class="form-section">
<div class="form-section-title">📋 Activity Log</div>
<div style="max-height: 200px; overflow-y: auto;">
                        ${(project.activityLog || []).slice().reverse().map(log => `
<div style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between;">
<span>${log.action}</span>
<span style="font-size: 12px; opacity: 0.5;">${new Date(log.timestamp).toLocaleString()}</span>
</div>
                        `).join('') || '<p style="opacity: 0.5;">No activity logged yet</p>'}
</div>
</div>

                <!-- Notes -->
                ${project.notes ? `
<div class="form-section">
<div class="form-section-title">📝 Notes</div>
<p style="line-height: 1.7;">${project.notes}</p>
</div>
                ` : ''}
</div>
<div class="modal-footer">
<button class="btn-admin secondary" onclick="document.getElementById('projectDetailsModal').remove()">Close</button>
<button class="btn-admin secondary" onclick="createInvoiceForProject(${project.id})">📄 Create Invoice</button>
<button class="btn-admin primary" onclick="editProject(${project.id}); document.getElementById('projectDetailsModal').remove();">Edit Project</button>
</div>
</div>
    `;
    document.body.appendChild(modal);
}

function recordProjectPayment(projectId) {
    const project = projects.find(p => p.id === projectId);
    if (!project) return;

    const plan = paymentPlans[project.paymentPlan] || { schedule: [100] };
    const installmentIndex = project.paidInstallments || 0;
    const amount = Math.round((project.totalAmount || 0) * plan.schedule[installmentIndex] / 100);

    const client = crmData.clients?.find(c => c.id === project.clientId) || { name: 'Unknown' };

    // Record the payment
    const payment = {
        id: Date.now(),
        clientId: project.clientId,
        clientName: client.name,
        projectId: project.id,
        projectName: project.name,
        amount: amount,
        type: plan.triggers?.[installmentIndex] || 'installment',
        date: new Date().toISOString().split('T')[0],
        notes: `${plan.triggers?.[installmentIndex] || 'Installment'} payment for ${project.name}`,
        status: 'completed',
        createdAt: new Date().toISOString()
    };
    payments.push(payment);
    savePayments();

    // Update project
    project.paidInstallments = (project.paidInstallments || 0) + 1;
    project.activityLog = project.activityLog || [];
    project.activityLog.push({
        action: `Payment received: $${amount.toLocaleString()} (${plan.triggers?.[installmentIndex] || 'installment'})`,
        timestamp: new Date().toISOString()
    });
    saveProjects();

    // Close modal and refresh
    if (document.getElementById('projectDetailsModal')) {
        document.getElementById('projectDetailsModal').remove();
    }
    loadAdminProjectsPanel();
    alert(`Payment of $${amount.toLocaleString()} recorded successfully!`);
}

function createInvoiceForProject(projectId) {
    const project = projects.find(p => p.id === projectId);
    if (!project) return;

    // Close details modal
    if (document.getElementById('projectDetailsModal')) {
        document.getElementById('projectDetailsModal').remove();
    }

    // Open invoice panel and show create modal
    showAdminPanel('invoices');
    setTimeout(() => {
        showCreateInvoiceModal();
        // Pre-fill with project info
        setTimeout(() => {
            const clientSelect = document.getElementById('invoiceClient');
            if (clientSelect && project.clientId) {
                clientSelect.value = project.clientId;
                loadInvoiceClientProjects(project.clientId);
                setTimeout(() => {
                    const projectSelect = document.getElementById('invoiceProject');
                    if (projectSelect) {
                        projectSelect.value = project.id;
                        populateInvoiceFromProject(project.id);
                    }
                }, 100);
            }
        }, 100);
    }, 100);
}

function advanceProject(id) {
    const stages = ['Discovery', 'Design', 'Development', 'Review', 'Delivery', 'Complete'];
    const project = projects.find(p => p.id === id);
    if (!project) return;
    const currentIdx = stages.indexOf(project.stage || 'Discovery');
    if (currentIdx < stages.length - 1) {
        const newStage = stages[currentIdx + 1];
        project.stage = newStage;

        // Log activity
        project.activityLog = project.activityLog || [];
        project.activityLog.push({
            action: `Stage advanced to ${newStage}`,
            timestamp: new Date().toISOString(),
            stage: newStage
        });

        // Check for auto-pay triggers
        const plan = paymentPlans[project.paymentPlan];
        if (plan && plan.triggers) {
            // Approval trigger
            if (newStage === 'Review' && plan.triggers.includes('approval') && (project.paidInstallments || 0) === 1) {
                alert(`Payment reminder: ${plan.name} - Next payment (25%) is due on approval.`);
            }
            // Delivery trigger
            if (newStage === 'Delivery' && plan.triggers.includes('delivery') && (project.paidInstallments || 0) === 2) {
                alert(`Payment reminder: ${plan.name} - Final payment (25%) is due before download.`);
            }
        }

        saveProjects();
        loadAdminProjectsPanel();
    } else {
        alert('Project is already complete!');
    }
}

function editProject(id) {
    const project = projects.find(p => p.id === id);
    if (!project) return;
    const stages = ['Discovery', 'Design', 'Development', 'Review', 'Delivery', 'Complete'];
    const allClients = [...(crmData.clients || []), ...clients];
    const uniqueClients = allClients.filter((c, i, arr) => arr.findIndex(x => x.id === c.id) === i);

    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.id = 'projectModal';
    modal.innerHTML = `
<div class="modal" style="max-width: 600px;">
<div class="modal-header"><h3 class="modal-title">Edit Project</h3><button class="modal-close" onclick="document.getElementById('projectModal').remove()">×</button></div>
<div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
<div class="form-group">
<label class="form-label">Project Name</label>
<input type="text" id="projectName" class="form-input" value="${project.name}">
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Client</label>
<select id="projectClient" class="form-select">
<option value="">Select client...</option>
                            ${uniqueClients.map(c => `<option value="${c.id}" ${c.id == project.clientId ? 'selected' : ''}>${c.name}</option>`).join('')}
</select>
</div>
<div class="form-group">
<label class="form-label">Stage</label>
<select id="projectStage" class="form-select">
                            ${stages.map(s => `<option value="${s}" ${project.stage === s ? 'selected' : ''}>${s}</option>`).join('')}
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Package</label>
<select id="projectPackageEdit" class="form-select">
<option value="">Custom</option>
                            ${servicePackages.map(pkg => `<option value="${pkg.id}" ${pkg.id === project.packageId ? 'selected' : ''}>${pkg.name} - $${pkg.price}</option>`).join('')}
</select>
</div>
<div class="form-group">
<label class="form-label">Total Amount</label>
<input type="number" id="projectAmount" class="form-input" value="${project.totalAmount || 0}" step="0.01">
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Payment Plan</label>
<select id="projectPlanEdit" class="form-select">
                            ${Object.entries(paymentPlans).map(([key, plan]) => `<option value="${key}" ${key === project.paymentPlan ? 'selected' : ''}>${plan.name}</option>`).join('')}
</select>
</div>
<div class="form-group">
<label class="form-label">Payments Made</label>
<select id="projectPaidInstallments" class="form-select">
<option value="0" ${(project.paidInstallments || 0) === 0 ? 'selected' : ''}>0 payments</option>
<option value="1" ${project.paidInstallments === 1 ? 'selected' : ''}>1 payment</option>
<option value="2" ${project.paidInstallments === 2 ? 'selected' : ''}>2 payments</option>
<option value="3" ${project.paidInstallments === 3 ? 'selected' : ''}>3 payments</option>
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Start Date</label>
<input type="date" id="projectStart" class="form-input" value="${project.startDate || ''}">
</div>
<div class="form-group">
<label class="form-label">Due Date</label>
<input type="date" id="projectDue" class="form-input" value="${project.dueDate || ''}">
</div>
</div>
<div class="form-group">
<label class="form-label">Time Tracked (seconds)</label>
<input type="number" id="projectTimeTracked" class="form-input" value="${project.timeTracked || 0}">
<p style="font-size: 11px; opacity: 0.5; margin-top: 4px;">Current: ${Math.floor((project.timeTracked || 0) / 3600)}h ${Math.floor(((project.timeTracked || 0) % 3600) / 60)}m</p>
</div>
<div class="form-group">
<label class="form-label">Notes</label>
<textarea id="projectNotes" class="form-textarea" rows="3">${project.notes || ''}</textarea>
</div>
</div>
<div class="modal-footer">
<button class="btn-admin danger" onclick="deleteProject(${id})">Delete</button>
<button class="btn-admin secondary" onclick="document.getElementById('projectModal').remove()">Cancel</button>
<button class="btn-admin primary" onclick="updateProject(${id})">Update</button>
</div>
</div>
    `;
    document.body.appendChild(modal);
}

function updateProject(id) {
    const project = projects.find(p => p.id === id);
    if (!project) return;

    const oldStage = project.stage;
    const newStage = document.getElementById('projectStage').value;

    project.name = document.getElementById('projectName').value;
    project.clientId = parseInt(document.getElementById('projectClient').value) || null;
    project.stage = newStage;
    project.packageId = document.getElementById('projectPackageEdit').value || null;
    project.package = servicePackages.find(p => p.id === project.packageId)?.name || 'Custom';
    project.totalAmount = parseFloat(document.getElementById('projectAmount').value) || 0;
    project.paymentPlan = document.getElementById('projectPlanEdit').value;
    project.paidInstallments = parseInt(document.getElementById('projectPaidInstallments').value) || 0;
    project.startDate = document.getElementById('projectStart').value;
    project.dueDate = document.getElementById('projectDue').value;
    project.timeTracked = parseInt(document.getElementById('projectTimeTracked').value) || 0;
    project.notes = document.getElementById('projectNotes').value;

    // Log stage change
    if (oldStage !== newStage) {
        project.activityLog = project.activityLog || [];
        project.activityLog.push({
            action: `Stage changed from ${oldStage} to ${newStage}`,
            timestamp: new Date().toISOString(),
            stage: newStage
        });
    }

    saveProjects();
    document.getElementById('projectModal').remove();
    loadAdminProjectsPanel();
}

function deleteProject(id) {
    if (!confirm('Delete this project?')) return;
    projects = projects.filter(p => p.id !== id);
    saveProjects();
    document.getElementById('projectModal').remove();
    loadAdminProjectsPanel();
}

// ==================== PROOFS PANEL ====================

// Proof Categories and Types with Sizes
const PROOF_CATEGORIES = {
    print: {
        name: 'Print Materials',
        icon: '🖨️',
        types: [
            { id: 'business_card_front', name: 'Business Card - Front', size: '3.5" x 2"', category: 'print' },
            { id: 'business_card_back', name: 'Business Card - Back', size: '3.5" x 2"', category: 'print' },
            { id: 'business_card_set', name: 'Business Card - Full Set', size: '3.5" x 2" (Front & Back)', category: 'print' },
            { id: 'flyer_letter', name: 'Flyer - Letter', size: '8.5" x 11"', category: 'print' },
            { id: 'flyer_half', name: 'Flyer - Half Page', size: '5.5" x 8.5"', category: 'print' },
            { id: 'postcard_4x6', name: 'Postcard/Mailer', size: '4" x 6"', category: 'print' },
            { id: 'postcard_5x7', name: 'Postcard/Mailer', size: '5" x 7"', category: 'print' },
            { id: 'postcard_6x9', name: 'Postcard/Mailer', size: '6" x 9"', category: 'print' },
            { id: 'rack_card', name: 'Rack Card', size: '4" x 9"', category: 'print' },
            { id: 'brochure_trifold_outside', name: 'Brochure Tri-fold - Outside', size: '8.5" x 11" (folded)', category: 'print' },
            { id: 'brochure_trifold_inside', name: 'Brochure Tri-fold - Inside', size: '8.5" x 11" (folded)', category: 'print' },
            { id: 'brochure_bifold_outside', name: 'Brochure Bi-fold - Outside', size: '8.5" x 11" (folded)', category: 'print' },
            { id: 'brochure_bifold_inside', name: 'Brochure Bi-fold - Inside', size: '8.5" x 11" (folded)', category: 'print' },
            { id: 'door_hanger', name: 'Door Hanger', size: '4.25" x 11"', category: 'print' },
            { id: 'bookmark', name: 'Bookmark', size: '2" x 6"', category: 'print' }
        ]
    },
    labels: {
        name: 'Labels & Packaging',
        icon: '🏷️',
        types: [
            { id: 'label_circle_2', name: 'Circle Label', size: '2" diameter', category: 'labels' },
            { id: 'label_circle_3', name: 'Circle Label', size: '3" diameter', category: 'labels' },
            { id: 'label_square_2', name: 'Square Label', size: '2" x 2"', category: 'labels' },
            { id: 'label_rect_2x3', name: 'Rectangle Label', size: '2" x 3"', category: 'labels' },
            { id: 'label_rect_3x4', name: 'Rectangle Label', size: '3" x 4"', category: 'labels' },
            { id: 'product_label', name: 'Product Label - Custom', size: 'Custom size', category: 'labels' },
            { id: 'bottle_label', name: 'Bottle/Jar Label', size: 'Wrap-around', category: 'labels' },
            { id: 'box_packaging', name: 'Box/Packaging Design', size: 'Custom', category: 'labels' },
            { id: 'hang_tag', name: 'Hang Tag', size: '2" x 3.5"', category: 'labels' }
        ]
    },
    banners: {
        name: 'Banners & Signage',
        icon: '🚩',
        types: [
            { id: 'banner_stand_24x63', name: 'Retractable Banner Stand', size: '24" x 63"', category: 'banners' },
            { id: 'banner_stand_33x81', name: 'Retractable Banner Stand', size: '33" x 81"', category: 'banners' },
            { id: 'banner_stand_36x92', name: 'Retractable Banner Stand', size: '36" x 92"', category: 'banners' },
            { id: 'vinyl_banner_3x6', name: 'Vinyl Banner', size: '3\' x 6\'', category: 'banners' },
            { id: 'vinyl_banner_4x8', name: 'Vinyl Banner', size: '4\' x 8\'', category: 'banners' },
            { id: 'vinyl_banner_custom', name: 'Vinyl Banner - Custom', size: 'Custom size', category: 'banners' },
            { id: 'yard_sign_18x24', name: 'Yard Sign', size: '18" x 24"', category: 'banners' },
            { id: 'yard_sign_24x36', name: 'Yard Sign', size: '24" x 36"', category: 'banners' },
            { id: 'a_frame', name: 'A-Frame Sign', size: '24" x 36"', category: 'banners' },
            { id: 'window_cling', name: 'Window Cling/Decal', size: 'Custom', category: 'banners' },
            { id: 'vinyl_decal', name: 'Vinyl Decal Design', size: 'Custom', category: 'banners' },
            { id: 'wall_graphic', name: 'Wall Graphic/Mural', size: 'Custom', category: 'banners' }
        ]
    },
    posters: {
        name: 'Posters & Large Format',
        icon: '🖼️',
        types: [
            { id: 'poster_11x17', name: 'Poster - Tabloid', size: '11" x 17"', category: 'posters' },
            { id: 'poster_18x24', name: 'Poster - Small', size: '18" x 24"', category: 'posters' },
            { id: 'poster_24x36', name: 'Poster - Medium', size: '24" x 36"', category: 'posters' },
            { id: 'poster_27x40', name: 'Poster - Movie Size', size: '27" x 40"', category: 'posters' },
            { id: 'poster_36x48', name: 'Poster - Large', size: '36" x 48"', category: 'posters' },
            { id: 'canvas_16x20', name: 'Canvas Print', size: '16" x 20"', category: 'posters' },
            { id: 'canvas_24x36', name: 'Canvas Print', size: '24" x 36"', category: 'posters' },
            { id: 'foam_board', name: 'Foam Board Display', size: 'Custom', category: 'posters' }
        ]
    },
    digital: {
        name: 'Digital & Web',
        icon: '💻',
        types: [
            { id: 'web_banner_728x90', name: 'Leaderboard Banner', size: '728 x 90 px', category: 'digital' },
            { id: 'web_banner_300x250', name: 'Medium Rectangle', size: '300 x 250 px', category: 'digital' },
            { id: 'web_banner_160x600', name: 'Wide Skyscraper', size: '160 x 600 px', category: 'digital' },
            { id: 'web_banner_300x600', name: 'Half Page', size: '300 x 600 px', category: 'digital' },
            { id: 'social_fb_cover', name: 'Facebook Cover', size: '820 x 312 px', category: 'digital' },
            { id: 'social_fb_post', name: 'Facebook Post', size: '1200 x 630 px', category: 'digital' },
            { id: 'social_ig_post', name: 'Instagram Post', size: '1080 x 1080 px', category: 'digital' },
            { id: 'social_ig_story', name: 'Instagram Story', size: '1080 x 1920 px', category: 'digital' },
            { id: 'social_linkedin', name: 'LinkedIn Banner', size: '1584 x 396 px', category: 'digital' },
            { id: 'social_twitter', name: 'Twitter/X Header', size: '1500 x 500 px', category: 'digital' },
            { id: 'social_youtube', name: 'YouTube Thumbnail', size: '1280 x 720 px', category: 'digital' },
            { id: 'email_header', name: 'Email Header', size: '600 x 200 px', category: 'digital' },
            { id: 'email_template', name: 'Email Template', size: '600 px wide', category: 'digital' }
        ]
    },
    video: {
        name: 'Video Content',
        icon: '🎬',
        types: [
            { id: 'video_reel', name: 'Instagram/TikTok Reel', size: '1080 x 1920 px (9:16)', category: 'video', isVideo: true },
            { id: 'video_story', name: 'Story Video', size: '1080 x 1920 px (9:16)', category: 'video', isVideo: true },
            { id: 'video_square', name: 'Square Video (Feed)', size: '1080 x 1080 px (1:1)', category: 'video', isVideo: true },
            { id: 'video_landscape', name: 'Landscape Video', size: '1920 x 1080 px (16:9)', category: 'video', isVideo: true },
            { id: 'video_brand', name: 'Brand Video', size: '1920 x 1080 px (16:9)', category: 'video', isVideo: true },
            { id: 'video_promo', name: 'Promo/Ad Video', size: 'Various', category: 'video', isVideo: true },
            { id: 'video_logo_animation', name: 'Logo Animation', size: 'Various', category: 'video', isVideo: true },
            { id: 'video_intro_outro', name: 'Intro/Outro', size: '1920 x 1080 px', category: 'video', isVideo: true }
        ]
    },
    branding: {
        name: 'Brand Identity',
        icon: '✨',
        types: [
            { id: 'logo_primary', name: 'Logo - Primary', size: 'Vector/High-res', category: 'branding' },
            { id: 'logo_secondary', name: 'Logo - Secondary', size: 'Vector/High-res', category: 'branding' },
            { id: 'logo_icon', name: 'Logo Icon/Mark', size: 'Vector/High-res', category: 'branding' },
            { id: 'logo_wordmark', name: 'Logo Wordmark', size: 'Vector/High-res', category: 'branding' },
            { id: 'logo_variations', name: 'Logo Color Variations', size: 'Multiple', category: 'branding' },
            { id: 'brand_pattern', name: 'Brand Pattern', size: 'Seamless tile', category: 'branding' },
            { id: 'brand_icons', name: 'Custom Icon Set', size: 'Various', category: 'branding' },
            { id: 'letterhead', name: 'Letterhead Design', size: '8.5" x 11"', category: 'branding' },
            { id: 'envelope', name: 'Envelope Design', size: '#10 (4.125" x 9.5")', category: 'branding' },
            { id: 'presentation_template', name: 'Presentation Template', size: '16:9', category: 'branding' }
        ]
    },
    website: {
        name: 'Website & App',
        icon: '🌐',
        types: [
            { id: 'website_full', name: 'Full Website', size: 'Responsive', category: 'website', isLink: true },
            { id: 'website_homepage', name: 'Homepage Design', size: 'Desktop & Mobile', category: 'website', isLink: true },
            { id: 'website_landing', name: 'Landing Page', size: 'Responsive', category: 'website', isLink: true },
            { id: 'website_inner', name: 'Inner Page', size: 'Responsive', category: 'website', isLink: true },
            { id: 'webapp_dashboard', name: 'Web App Dashboard', size: 'Desktop', category: 'website', isLink: true },
            { id: 'webapp_mobile', name: 'Mobile App Screen', size: 'Mobile', category: 'website', isLink: true },
            { id: 'webapp_feature', name: 'App Feature/Flow', size: 'Various', category: 'website', isLink: true },
            { id: 'ecommerce_product', name: 'E-commerce Product Page', size: 'Responsive', category: 'website', isLink: true },
            { id: 'ecommerce_checkout', name: 'Checkout Flow', size: 'Responsive', category: 'website', isLink: true },
            { id: 'prototype_figma', name: 'Figma Prototype', size: 'Interactive', category: 'website', isLink: true },
            { id: 'prototype_xd', name: 'Adobe XD Prototype', size: 'Interactive', category: 'website', isLink: true },
            { id: 'staging_site', name: 'Staging/Dev Site', size: 'Full Site', category: 'website', isLink: true }
        ]
    }
};

let proofFilterCategory = 'all';
let proofFilterStatus = 'all';

function loadAdminProofsPanel() {
    const filteredProofs = proofs.filter(p => {
        const categoryMatch = proofFilterCategory === 'all' || p.category === proofFilterCategory;
        const statusMatch = proofFilterStatus === 'all' || p.status === proofFilterStatus;
        return categoryMatch && statusMatch;
    });

    const pendingCount = proofs.filter(p => p.status === 'pending').length;
    const approvedCount = proofs.filter(p => p.status === 'approved').length;
    const revisionCount = proofs.filter(p => p.status === 'revision').length;

    document.getElementById('adminProofsPanel').innerHTML = `
<div class="panel-header">
<h2 class="panel-title">✅ Proof Approval Center</h2>
<p class="panel-subtitle">Create, manage, and approve design proofs across all formats</p>
</div>

        <!-- Stats Row -->
<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
<div style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); padding: 20px; border-radius: 12px; color: #fff;">
<div style="font-size: 32px; font-weight: 700;">${proofs.length}</div>
<div style="font-size: 14px; opacity: 0.9;">Total Proofs</div>
</div>
<div style="background: linear-gradient(135deg, #f59e0b, #d97706); padding: 20px; border-radius: 12px; color: #fff;">
<div style="font-size: 32px; font-weight: 700;">${pendingCount}</div>
<div style="font-size: 14px; opacity: 0.9;">Pending Review</div>
</div>
<div style="background: linear-gradient(135deg, #10b981, #059669); padding: 20px; border-radius: 12px; color: #fff;">
<div style="font-size: 32px; font-weight: 700;">${approvedCount}</div>
<div style="font-size: 14px; opacity: 0.9;">Approved</div>
</div>
<div style="background: linear-gradient(135deg, #ef4444, #dc2626); padding: 20px; border-radius: 12px; color: #fff;">
<div style="font-size: 32px; font-weight: 700;">${revisionCount}</div>
<div style="font-size: 14px; opacity: 0.9;">Needs Revision</div>
</div>
</div>

        <!-- Storage Indicator -->
<div style="background: #252525; border-radius: 12px; padding: 12px 20px; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
<div style="display: flex; align-items: center; gap: 16px;">
<span style="color: #888; font-size: 13px;">💾 Storage:</span>
<span id="storageUsage" style="font-weight: 600; font-size: 13px;">${getStorageUsage().used} / ~5 MB</span>
<div style="width: 100px; height: 6px; background: #333; border-radius: 3px; overflow: hidden;">
<div style="width: ${Math.min((getStorageUsage().usedBytes / 5000000) * 100, 100)}%; height: 100%; background: ${(getStorageUsage().usedBytes / 5000000) > 0.8 ? '#ef4444' : '#10b981'}; border-radius: 3px;"></div>
</div>
</div>
<div style="display: flex; gap: 8px;">
<button onclick="showStorageManager()" style="padding: 6px 12px; background: #333; border: none; color: #fff; border-radius: 6px; cursor: pointer; font-size: 12px;">
                    🗑️ Manage Storage
</button>
</div>
</div>

        <!-- Actions & Filters -->
<div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; margin-bottom: 24px;">
<div style="display: flex; gap: 12px; flex-wrap: wrap;">
<select onchange="proofFilterCategory = this.value; loadAdminProofsPanel();" style="padding: 10px 16px; border: 1px solid #333; border-radius: 8px; background: #1a1a1a; color: #fff;">
<option value="all" ${proofFilterCategory === 'all' ? 'selected' : ''}>All Categories</option>
                    ${Object.entries(PROOF_CATEGORIES).map(([key, cat]) => `<option value="${key}" ${proofFilterCategory === key ? 'selected' : ''}>${cat.icon} ${cat.name}</option>`).join('')}
</select>
<select onchange="proofFilterStatus = this.value; loadAdminProofsPanel();" style="padding: 10px 16px; border: 1px solid #333; border-radius: 8px; background: #1a1a1a; color: #fff;">
<option value="all" ${proofFilterStatus === 'all' ? 'selected' : ''}>All Statuses</option>
<option value="pending" ${proofFilterStatus === 'pending' ? 'selected' : ''}>⏳ Pending</option>
<option value="approved" ${proofFilterStatus === 'approved' ? 'selected' : ''}>✅ Approved</option>
<option value="revision" ${proofFilterStatus === 'revision' ? 'selected' : ''}>🔄 Revision</option>
</select>
</div>
<button class="btn-cta" onclick="showCreateProofModal()" style="padding: 12px 24px;">
                + Create New Proof
</button>
</div>

        <!-- Proofs Grid -->
        ${filteredProofs.length === 0 ? `
<div style="background: #1a1a1a; border-radius: 16px; padding: 60px; text-align: center;">
<div style="font-size: 64px; margin-bottom: 16px;">📋</div>
<h3 style="font-size: 20px; margin-bottom: 8px;">No Proofs Found</h3>
<p style="color: #888; margin-bottom: 24px;">Create your first proof to get started</p>
<button class="btn-cta" onclick="showCreateProofModal()">+ Create Proof</button>
</div>
        ` : `
<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
                ${filteredProofs.map(proof => renderEnhancedProofCard(proof)).join('')}
</div>
        `}
    `;
}

function renderEnhancedProofCard(proof) {
    const client = clients.find(c => c.id === proof.clientId) || { name: 'Unknown Client' };
    const proofType = getAllProofTypes().find(t => t.id === proof.proofType) || { name: proof.proofType || 'Custom', size: '', icon: '📄' };
    const categoryData = PROOF_CATEGORIES[proof.category] || { icon: '📄', name: 'Other' };
    const isVideo = proof.isVideo || proofType.isVideo;
    const isLink = proof.isLink || proofType?.isLink;

    const statusColors = {
        pending: { bg: '#fef3c7', text: '#92400e', icon: '⏳' },
        approved: { bg: '#d1fae5', text: '#065f46', icon: '✅' },
        revision: { bg: '#fee2e2', text: '#991b1b', icon: '🔄' }
    };
    const status = statusColors[proof.status] || statusColors.pending;

    // Determine preview content
    let previewContent = '';
    if (isLink && proof.previewUrl) {
        previewContent = proof.thumbnail
            ? `<img alt="Design proof thumbnail" loading="lazy" src="${proof.thumbnail}" style="max-width: 100%; max-height: 100%; object-fit: contain; opacity: 0.8;">`
            : `<div style="text-align: center; color: #3b82f6;">
<div style="font-size: 48px; margin-bottom: 8px;">🌐</div>
<div style="font-size: 12px; word-break: break-all; padding: 0 20px;">${proof.previewUrl.substring(0, 40)}...</div>
</div>`;
    } else if (isVideo && proof.videoUrl) {
        previewContent = `<video src="${proof.videoUrl}" style="max-width: 100%; max-height: 100%;" controls></video>`;
    } else if (isVideo) {
        previewContent = `<div style="text-align: center; color: #666;"><div style="font-size: 48px; margin-bottom: 8px;">🎬</div><div>Video Proof</div></div>`;
    } else if (proof.image) {
        previewContent = `<img alt="Design proof full image" loading="lazy" src="${proof.image}" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
    } else {
        previewContent = `<div style="text-align: center; color: #666;"><div style="font-size: 48px; margin-bottom: 8px;">${categoryData.icon}</div><div>No Preview</div></div>`;
    }

    return `
<div style="background: #1a1a1a; border-radius: 16px; overflow: hidden; border: 1px solid #333;">
            <!-- Preview Area -->
<div style="position: relative; height: 200px; background: #111; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                ${previewContent}
                ${isLink ? `
<div style="position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%);">
<button onclick="window.open('${proof.previewUrl}', '_blank')" style="padding: 8px 16px; background: #3b82f6; border: none; color: #fff; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                            🔗 Open Preview
</button>
</div>
                ` : ''}
                <!-- Category Badge -->
<div style="position: absolute; top: 12px; left: 12px; background: rgba(0,0,0,0.7); padding: 6px 12px; border-radius: 20px; font-size: 12px;">
                    ${categoryData.icon} ${proofType.name}
</div>
                <!-- Status Badge -->
<div style="position: absolute; top: 12px; right: 12px; background: ${status.bg}; color: ${status.text}; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                    ${status.icon} ${proof.status.charAt(0).toUpperCase() + proof.status.slice(1)}
</div>
</div>

            <!-- Info Area -->
<div style="padding: 20px;">
<h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">${proof.name}</h3>
<div style="display: flex; gap: 16px; color: #888; font-size: 13px; margin-bottom: 12px; flex-wrap: wrap;">
<span>👤 ${client.name}</span>
<span>📐 ${proofType.size || 'Custom'}</span>
                    ${isLink ? '<span style="color: #3b82f6;">🔗 Link</span>' : ''}
</div>
<div style="font-size: 12px; color: #666; margin-bottom: 16px;">
                    Version ${proof.version || 1} • ${proof.createdAt ? new Date(proof.createdAt).toLocaleDateString() : 'N/A'}
</div>

                ${proof.comments && proof.comments.length > 0 ? `
<div style="background: #252525; padding: 12px; border-radius: 8px; margin-bottom: 16px; max-height: 80px; overflow-y: auto;">
<div style="font-size: 11px; color: #888; margin-bottom: 8px;">LATEST FEEDBACK (${proof.comments.length})</div>
<div style="font-size: 13px; color: #ccc;">${proof.comments[proof.comments.length - 1].text}</div>
</div>
                ` : ''}

                <!-- Action Buttons -->
<div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    ${isLink ? `<button onclick="openProofPreview(${proof.id})" style="padding: 10px 14px; background: #3b82f6; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">🔗 Preview & Comment</button>` : ''}
                    ${proof.status !== 'approved' ? `
<button onclick="approveProof(${proof.id})" style="flex: 1; padding: 10px; background: #10b981; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            ✓ Approve
</button>
<button onclick="requestRevisionModal(${proof.id})" style="flex: 1; padding: 10px; background: #ef4444; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            ↻ Revision
</button>
                    ` : `
<button onclick="viewApprovedAsset(${proof.id})" style="flex: 1; padding: 10px; background: #3b82f6; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            📁 View in Brand Guide
</button>
                    `}
<button onclick="viewProofDetails(${proof.id})" style="padding: 10px 16px; background: #333; color: #fff; border: none; border-radius: 8px; cursor: pointer;">
                        👁️
</button>
</div>
</div>
</div>
    `;
}

function getAllProofTypes() {
    const allTypes = [];
    Object.values(PROOF_CATEGORIES).forEach(cat => {
        cat.types.forEach(type => allTypes.push(type));
    });
    return allTypes;
}

// Enhanced Create Proof Modal
function showCreateProofModal() {
    const modal = document.createElement('div');
    modal.id = 'createProofModal';
    modal.innerHTML = `
<div style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999; padding: 20px;">
<div style="background: #1a1a1a; border-radius: 20px; width: 100%; max-width: 900px; max-height: 90vh; overflow-y: auto;">
                <!-- Header -->
<div style="padding: 24px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: #1a1a1a; z-index: 10;">
<div>
<h2 style="font-size: 24px; font-weight: 700;">Create New Proof</h2>
<p style="color: #888; font-size: 14px;">Select proof type, upload files, and send to client</p>
</div>
<button onclick="document.getElementById('createProofModal').remove()" style="background: none; border: none; color: #888; font-size: 28px; cursor: pointer; line-height: 1;">&times;</button>
</div>

                <!-- Body -->
<div style="padding: 24px;">
                    <!-- Step 1: Select Client & Project -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
<div>
<label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px;">Client *</label>
<select id="proofClient" style="width: 100%; padding: 12px; border: 1px solid #333; border-radius: 8px; background: #252525; color: #fff; font-size: 14px;">
<option value="">Select client...</option>
                                ${clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
</select>
</div>
<div>
<label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px;">Project/Order</label>
<select id="proofProject" style="width: 100%; padding: 12px; border: 1px solid #333; border-radius: 8px; background: #252525; color: #fff; font-size: 14px;">
<option value="">Select project...</option>
                                ${orders.map(o => `<option value="${o.id}">${o.projectName || o.service}</option>`).join('')}
</select>
</div>
</div>

                    <!-- Step 2: Select Proof Category -->
<div style="margin-bottom: 24px;">
<label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 12px;">Proof Category *</label>
<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px;">
                            ${Object.entries(PROOF_CATEGORIES).map(([key, cat]) => `
<div onclick="selectProofCategory('${key}')" id="cat_${key}"
                                    style="background: #252525; border: 2px solid #333; border-radius: 12px; padding: 16px; text-align: center; cursor: pointer; transition: all 0.2s;">
<div style="font-size: 28px; margin-bottom: 8px;">${cat.icon}</div>
<div style="font-size: 13px; font-weight: 500;">${cat.name}</div>
</div>
                            `).join('')}
</div>
</div>

                    <!-- Step 3: Select Specific Type (shown after category selected) -->
<div id="proofTypeSection" style="display: none; margin-bottom: 24px;">
<label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 12px;">Select Type & Size *</label>
<div id="proofTypeList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; max-height: 200px; overflow-y: auto; padding: 4px;"></div>
</div>

                    <!-- Step 4: Proof Details -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
<div>
<label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px;">Proof Name *</label>
<input type="text" id="proofName" placeholder="e.g., Business Card Design v1"
                                style="width: 100%; padding: 12px; border: 1px solid #333; border-radius: 8px; background: #252525; color: #fff; font-size: 14px;">
</div>
<div>
<label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px;">Version</label>
<input type="number" id="proofVersion" value="1" min="1"
                                style="width: 100%; padding: 12px; border: 1px solid #333; border-radius: 8px; background: #252525; color: #fff; font-size: 14px;">
</div>
</div>

                    <!-- Step 5: Upload Area (File Upload) -->
<div id="proofUploadSection" style="margin-bottom: 24px;">
<label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 12px;">Upload Proof File *</label>
<div id="proofUploadZone" onclick="document.getElementById('proofFileInput').click()"
                            style="border: 2px dashed #444; border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.2s;"
                            ondragover="event.preventDefault(); this.style.borderColor='#e11d48'; this.style.background='rgba(225,29,72,0.1)';"
                            ondragleave="this.style.borderColor='#444'; this.style.background='transparent';"
                            ondrop="handleProofFileDrop(event)">
<div style="font-size: 48px; margin-bottom: 12px;">📁</div>
<p style="color: #fff; font-size: 16px; margin-bottom: 8px;">Drop your file here</p>
<p style="color: #888; font-size: 14px;">Images: PNG, JPG, PDF • Videos: MP4, MOV</p>
</div>
<input type="file" id="proofFileInput" accept="image/*,video/*,.pdf" style="display: none;" onchange="handleProofFileSelect(this)">

                        <!-- Preview Area -->
<div id="proofPreviewArea" style="display: none; margin-top: 16px; background: #252525; border-radius: 12px; padding: 16px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
<span style="font-weight: 600;">Preview</span>
<button onclick="clearProofUpload()" style="background: #ef4444; border: none; color: #fff; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">Remove</button>
</div>
<div id="proofPreviewContent" style="text-align: center;"></div>
</div>
</div>

                    <!-- Step 5b: URL Input (Website/App Proofs) -->
<div id="proofUrlSection" style="display: none; margin-bottom: 24px;">
<label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 12px;">🔗 Website/App Preview URL *</label>
<div style="background: #252525; border-radius: 12px; padding: 20px;">
<input type="url" id="proofUrl" placeholder="https://example.com or https://figma.com/proto/..."
                                style="width: 100%; padding: 14px 16px; border: 2px solid #444; border-radius: 8px; background: #1a1a1a; color: #fff; font-size: 14px; margin-bottom: 12px;"
                                oninput="validateProofUrl(this.value)">
<div id="proofUrlPreview" style="display: none; margin-top: 12px;">
<div style="background: #1a1a1a; border-radius: 8px; padding: 16px; text-align: center;">
<div style="font-size: 32px; margin-bottom: 8px;">🌐</div>
<div id="proofUrlDisplay" style="color: #3b82f6; word-break: break-all;"></div>
<button onclick="window.open(document.getElementById('proofUrl').value, '_blank')"
                                        style="margin-top: 12px; padding: 8px 16px; background: #3b82f6; border: none; color: #fff; border-radius: 6px; cursor: pointer;">
                                        🔗 Test Link
</button>
</div>
</div>
<p style="color: #888; font-size: 12px; margin-top: 12px;">
                                Supported: Live websites, staging sites, Figma prototypes, Adobe XD, InVision, etc.
</p>
</div>

                        <!-- Optional Screenshot Upload -->
<div style="margin-top: 16px;">
<label style="display: block; font-size: 13px; color: #888; margin-bottom: 8px;">Optional: Upload a screenshot for preview thumbnail</label>
<div onclick="document.getElementById('proofScreenshotInput').click()"
                                style="border: 1px dashed #444; border-radius: 8px; padding: 16px; text-align: center; cursor: pointer;">
<span style="color: #888; font-size: 13px;">📷 Click to add screenshot</span>
</div>
<input type="file" id="proofScreenshotInput" accept="image/*" style="display: none;" onchange="handleScreenshotUpload(this)">
<div id="screenshotPreview" style="display: none; margin-top: 8px; text-align: center;">
<img alt="Screenshot preview" loading="lazy" id="screenshotImg" style="max-width: 100%; max-height: 150px; border-radius: 8px;">
</div>
</div>
</div>

                    <!-- Step 6: Notes -->
<div style="margin-bottom: 24px;">
<label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px;">Notes for Client</label>
<textarea id="proofNotes" rows="3" placeholder="Add any notes or instructions for the client..."
                            style="width: 100%; padding: 12px; border: 1px solid #333; border-radius: 8px; background: #252525; color: #fff; font-size: 14px; resize: vertical;"></textarea>
</div>

                    <!-- Notification Option -->
<div style="background: #252525; border-radius: 12px; padding: 16px; margin-bottom: 24px;">
<label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
<input type="checkbox" id="notifyClient" checked style="width: 20px; height: 20px; accent-color: #e11d48;">
<div>
<div style="font-weight: 600;">Notify Client</div>
<div style="font-size: 13px; color: #888;">Send email notification when proof is ready for review</div>
</div>
</label>
</div>
</div>

                <!-- Footer -->
<div style="padding: 24px; border-top: 1px solid #333; display: flex; justify-content: flex-end; gap: 12px; position: sticky; bottom: 0; background: #1a1a1a;">
<button onclick="document.getElementById('createProofModal').remove()" style="padding: 12px 24px; background: #333; border: none; color: #fff; border-radius: 8px; cursor: pointer; font-size: 14px;">
                        Cancel
</button>
<button onclick="saveEnhancedProof()" style="padding: 12px 32px; background: linear-gradient(135deg, #e11d48, #be185d); border: none; color: #fff; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                        Create Proof & Send to Client
</button>
</div>
</div>
</div>
    `;
    document.body.appendChild(modal);
}

let selectedProofCategory = null;
let selectedProofType = null;
let proofFileData = null;

function selectProofCategory(categoryKey) {
    selectedProofCategory = categoryKey;

    // Update visual selection
    Object.keys(PROOF_CATEGORIES).forEach(key => {
        const el = document.getElementById('cat_' + key);
        if (el) {
            el.style.borderColor = key === categoryKey ? '#e11d48' : '#333';
            el.style.background = key === categoryKey ? 'rgba(225,29,72,0.1)' : '#252525';
        }
    });

    // Show type selection
    const typeSection = document.getElementById('proofTypeSection');
    const typeList = document.getElementById('proofTypeList');
    const category = PROOF_CATEGORIES[categoryKey];

    typeSection.style.display = 'block';
    typeList.innerHTML = category.types.map(type => `
<div onclick="selectProofType('${type.id}')" id="type_${type.id}"
            style="background: #333; border: 2px solid #444; border-radius: 8px; padding: 12px; cursor: pointer; transition: all 0.2s;">
<div style="font-weight: 600; font-size: 13px; margin-bottom: 4px;">${type.name}</div>
<div style="font-size: 12px; color: #888;">${type.size}</div>
            ${type.isVideo ? '<div style="font-size: 11px; color: #e11d48; margin-top: 4px;">🎬 Video</div>' : ''}
            ${type.isLink ? '<div style="font-size: 11px; color: #3b82f6; margin-top: 4px;">🔗 Link</div>' : ''}
</div>
    `).join('');

    // Update file input accept based on category
    const fileInput = document.getElementById('proofFileInput');
    const uploadSection = document.getElementById('proofUploadSection');
    const urlSection = document.getElementById('proofUrlSection');

    if (categoryKey === 'website') {
        // Show URL input for website proofs
        if (uploadSection) uploadSection.style.display = 'none';
        if (urlSection) urlSection.style.display = 'block';
    } else {
        // Show file upload for other proofs
        if (uploadSection) uploadSection.style.display = 'block';
        if (urlSection) urlSection.style.display = 'none';

        if (categoryKey === 'video') {
            fileInput.accept = 'video/*';
        } else {
            fileInput.accept = 'image/*,.pdf';
        }
    }
}

function selectProofType(typeId) {
    selectedProofType = typeId;
    const type = getAllProofTypes().find(t => t.id === typeId);

    // Update visual selection
    getAllProofTypes().forEach(t => {
        const el = document.getElementById('type_' + t.id);
        if (el) {
            el.style.borderColor = t.id === typeId ? '#e11d48' : '#444';
            el.style.background = t.id === typeId ? 'rgba(225,29,72,0.2)' : '#333';
        }
    });

    // Toggle between URL and file upload based on type
    const uploadSection = document.getElementById('proofUploadSection');
    const urlSection = document.getElementById('proofUrlSection');

    if (type && type.isLink) {
        if (uploadSection) uploadSection.style.display = 'none';
        if (urlSection) urlSection.style.display = 'block';
    } else if (selectedProofCategory !== 'website') {
        if (uploadSection) uploadSection.style.display = 'block';
        if (urlSection) urlSection.style.display = 'none';
    }

    // Auto-fill proof name if empty
    const nameInput = document.getElementById('proofName');
    if (!nameInput.value && type) {
        nameInput.value = type.name + ' v1';
    }
}

function handleProofFileDrop(event) {
    event.preventDefault();
    event.target.style.borderColor = '#444';
    event.target.style.background = 'transparent';

    const file = event.dataTransfer.files[0];
    if (file) {
        processProofFile(file);
    }
}

function handleProofFileSelect(input) {
    if (input.files && input.files[0]) {
        processProofFile(input.files[0]);
    }
}

function processProofFile(file) {
    const isVideo = file.type.startsWith('video/');
    const isImage = file.type.startsWith('image/');
    const isPDF = file.type === 'application/pdf';

    if (!isVideo && !isImage && !isPDF) {
        alert('Please upload an image, video, or PDF file.');
        return;
    }

    // Check file size - warn if large
    const fileSizeMB = file.size / (1024 * 1024);
    if (fileSizeMB > 5) {
        alert(`⚠️ Large file (${fileSizeMB.toFixed(1)}MB). Images will be compressed. Videos will be stored as reference only.`);
    }

    const previewArea = document.getElementById('proofPreviewArea');
    const previewContent = document.getElementById('proofPreviewContent');

    if (isVideo) {
        // For videos, create a thumbnail and store reference (videos too large for localStorage)
        const video = document.createElement('video');
        video.preload = 'metadata';
        video.onloadedmetadata = function() {
            video.currentTime = 1; // Seek to 1 second for thumbnail
        };
        video.onseeked = function() {
            // Create thumbnail from video frame
            const canvas = document.createElement('canvas');
            canvas.width = 320;
            canvas.height = 180;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const thumbnail = canvas.toDataURL('image/jpeg', 0.6);

            proofFileData = {
                data: null, // Don't store full video in localStorage
                thumbnail: thumbnail,
                type: file.type,
                name: file.name,
                isVideo: true,
                videoFile: file, // Keep file reference for display
                duration: video.duration
            };

            previewArea.style.display = 'block';
            previewContent.innerHTML = `
<div style="position: relative;">
<img alt="Proof thumbnail preview" loading="lazy" src="${thumbnail}" style="max-width: 100%; max-height: 300px; border-radius: 8px; opacity: 0.8;">
<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 48px;">▶️</div>
</div>
<div style="margin-top: 8px; color: #888; font-size: 13px;">🎬 ${file.name} (${fileSizeMB.toFixed(1)}MB)</div>
<div style="margin-top: 4px; color: #f59e0b; font-size: 11px;">⚠️ Video stored as thumbnail reference only</div>
            `;

            URL.revokeObjectURL(video.src);
        };
        video.src = URL.createObjectURL(file);
    } else if (isPDF) {
        // For PDFs, store minimal reference
        proofFileData = {
            data: null,
            type: file.type,
            name: file.name,
            isVideo: false,
            isPDF: true,
            fileSize: fileSizeMB.toFixed(1) + 'MB'
        };

        previewArea.style.display = 'block';
        previewContent.innerHTML = `
<div style="background: #333; padding: 40px; border-radius: 8px;">
<div style="font-size: 48px; margin-bottom: 12px;">📄</div>
<div style="font-weight: 600;">${file.name}</div>
<div style="color: #888; font-size: 13px; margin-top: 4px;">PDF Document (${fileSizeMB.toFixed(1)}MB)</div>
</div>
<div style="margin-top: 8px; color: #f59e0b; font-size: 11px;">⚠️ PDF stored as reference only</div>
        `;
    } else {
        // For images, compress before storing
        const reader = new FileReader();
        reader.onload = async e => {
            // Compress image
            const compressed = await compressImage(e.target.result, 800, 0.6);
            const compressedSize = (compressed.length * 0.75 / 1024).toFixed(0); // Approximate KB

            proofFileData = {
                data: compressed,
                type: 'image/jpeg',
                name: file.name,
                isVideo: false,
                originalSize: fileSizeMB.toFixed(1) + 'MB',
                compressedSize: compressedSize + 'KB'
            };

            previewArea.style.display = 'block';
            previewContent.innerHTML = `
<img alt="Compressed proof image" loading="lazy" src="${compressed}" style="max-width: 100%; max-height: 300px; border-radius: 8px;">
<div style="margin-top: 8px; color: #888; font-size: 13px;">🖼️ ${file.name}</div>
<div style="margin-top: 4px; color: #10b981; font-size: 11px;">✓ Compressed: ${fileSizeMB.toFixed(1)}MB → ${compressedSize}KB</div>
            `;
        };
        reader.readAsDataURL(file);
    }
}

function clearProofUpload() {
    proofFileData = null;
    document.getElementById('proofPreviewArea').style.display = 'none';
    document.getElementById('proofFileInput').value = '';
}

// URL validation for website proofs
let proofUrlData = null;
let proofScreenshotData = null;

function validateProofUrl(url) {
    const preview = document.getElementById('proofUrlPreview');
    const display = document.getElementById('proofUrlDisplay');

    if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
        proofUrlData = url;
        preview.style.display = 'block';
        display.textContent = url;
    } else {
        proofUrlData = null;
        preview.style.display = 'none';
    }
}

function handleScreenshotUpload(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = async (e) => {
            // Compress the screenshot
            const compressed = await compressImage(e.target.result, 600, 0.6);
            proofScreenshotData = compressed;

            document.getElementById('screenshotPreview').style.display = 'block';
            document.getElementById('screenshotImg').src = compressed;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function clearUrlProof() {
    proofUrlData = null;
    proofScreenshotData = null;
    document.getElementById('proofUrl').value = '';
    document.getElementById('proofUrlPreview').style.display = 'none';
    document.getElementById('screenshotPreview').style.display = 'none';
    document.getElementById('proofScreenshotInput').value = '';
}

function saveEnhancedProof() {
    const clientId = parseInt(document.getElementById('proofClient').value);
    const projectId = parseInt(document.getElementById('proofProject').value) || null;
    const name = document.getElementById('proofName').value.trim();
    const version = parseInt(document.getElementById('proofVersion').value) || 1;
    const notes = document.getElementById('proofNotes').value.trim();
    const notifyClient = document.getElementById('notifyClient').checked;

    const proofType = getAllProofTypes().find(t => t.id === selectedProofType);
    const isLinkProof = proofType?.isLink || selectedProofCategory === 'website';

    // Validation
    if (!clientId) {
        alert('Please select a client.');
        return;
    }
    if (!selectedProofCategory) {
        alert('Please select a proof category.');
        return;
    }
    if (!selectedProofType) {
        alert('Please select a proof type.');
        return;
    }
    if (!name) {
        alert('Please enter a proof name.');
        return;
    }

    // Check for either file or URL depending on type
    if (isLinkProof) {
        if (!proofUrlData) {
            alert('Please enter a valid URL for this website/app proof.');
            return;
        }
    } else {
        if (!proofFileData) {
            alert('Please upload a proof file.');
            return;
        }
    }

    const proof = {
        id: Date.now(),
        name: name,
        clientId: clientId,
        projectId: projectId,
        orderId: projectId,
        category: selectedProofCategory,
        proofType: selectedProofType,
        proofTypeName: proofType?.name || 'Custom',
        proofSize: proofType?.size || '',
        isLink: isLinkProof,
        isVideo: proofFileData?.isVideo || false,
        // For link proofs
        previewUrl: isLinkProof ? proofUrlData : null,
        thumbnail: isLinkProof ? proofScreenshotData : null,
        // For file proofs
        image: !isLinkProof && proofFileData && !proofFileData.isVideo ? proofFileData.data : null,
        videoUrl: !isLinkProof && proofFileData?.isVideo ? proofFileData.data : null,
        fileName: proofFileData?.name || null,
        fileType: proofFileData?.type || null,
        version: version,
        status: 'pending',
        notes: notes,
        comments: [],
        createdAt: new Date().toISOString(),
        notifyClient: notifyClient
    };

    proofs.push(proof);
    saveProofs();

    // Reset state
    selectedProofCategory = null;
    selectedProofType = null;
    proofFileData = null;

    document.getElementById('createProofModal').remove();
    loadAdminProofsPanel();

    if (notifyClient) {
        const client = clients.find(c => c.id === clientId);
        alert(`✅ Proof created!\n\n📧 Notification sent to ${client?.name || 'client'} for review.`);
    } else {
        alert('✅ Proof created successfully!');
    }
}

// Legacy function for compatibility
function showAddProofModal() {
    showCreateProofModal();
}

function previewProofImage(input) {
    if (input.files && input.files[0]) {
        processProofFile(input.files[0]);
    }
}

function saveProof() {
    saveEnhancedProof();
}

async function approveProof(id) {
    const proof = proofs.find(p => p.id === id);
    if (proof) {
        proof.status = 'approved';
        proof.approvedAt = new Date().toISOString();
        saveProofs();

        // Find matching order and update status
        if (proof.orderId || proof.order_id) {
            const orderIdx = orders.findIndex(o => o.id == (proof.orderId || proof.order_id));
            if (orderIdx !== -1) {
                orders[orderIdx].status = 'delivered';
                orders[orderIdx].progress = 100;
                saveOrders();
            }
        }

        // Save to client's brand assets
        saveProofToBrandAssets(proof);

        // Trigger workflow: Check payment and enable downloads
        triggerProofApproved(id);
        loadAdminProofsPanel();

        const client = clients.find(c => c.id === proof.clientId);

        // Notify designer that proof was approved
        if (proof.designerId) {
            addDesignerMessage(proof.designerId, proof.projectId, `✅ Your proof "${proof.name}" has been approved!`, 'system', true);
        }

        // Email client that their proof is approved
        if (client?.email) {
            simulateEmailNotification(
                client.email,
                `✅ Your ${proof.name || 'Proof'} Has Been Approved!`,
                `Great news! Your proof "${proof.name}" has been approved. ${checkClientPaymentStatus(proof.clientId) ? 'Your files are ready for download in your client portal.' : 'Complete your payment to unlock the final deliverable files.'}`
            );
        }

        // Log to CRM
        logProofActivity('approved', proof, `Proof "${proof.name}" approved for ${client?.name || 'client'}`);

        alert(`✅ Proof approved!\n\nAsset saved to ${client?.name || 'client'}'s Brand Guide.${client?.email ? '\n📧 Client notified via email.' : ''}`);
    }
}

// Save approved proof to client's brand assets
function saveProofToBrandAssets(proof) {
    const client = clients.find(c => c.id === proof.clientId);
    if (!client) return;

    // Initialize brand assets if needed
    if (!client.brandAssets) {
        client.brandAssets = { logo: '', colors: [], fonts: [], files: [] };
    }
    if (!client.brandAssets.files) {
        client.brandAssets.files = [];
    }

    // Create asset entry
    const asset = {
        id: Date.now(),
        proofId: proof.id,
        name: proof.name,
        category: proof.category,
        type: proof.proofType,
        typeName: proof.proofTypeName,
        size: proof.proofSize,
        isVideo: proof.isVideo,
        image: proof.image,
        videoUrl: proof.videoUrl,
        fileName: proof.fileName,
        fileType: proof.fileType,
        approvedAt: proof.approvedAt,
        version: proof.version
    };

    // Add to brand assets
    client.brandAssets.files.push(asset);

    // If it's a logo, also set as primary logo
    if (proof.proofType && proof.proofType.includes('logo') && proof.image) {
        client.brandAssets.logo = proof.image;
    }

    // Save clients
    localStorage.setItem('nui_clients', JSON.stringify(clients));

    // Also add to brand guide entries
    const brandGuideEntries = JSON.parse(localStorage.getItem('nui_brand_guide_entries')) || [];
    brandGuideEntries.push({
        id: Date.now(),
        clientId: proof.clientId,
        assetType: proof.category,
        assetName: proof.name,
        assetUrl: proof.image || proof.videoUrl,
        proofId: proof.id,
        createdAt: new Date().toISOString()
    });
    localStorage.setItem('nui_brand_guide_entries', JSON.stringify(brandGuideEntries));
}

function requestRevisionModal(id) {
    const proof = proofs.find(p => p.id === id);
    if (!proof) return;

    const modal = document.createElement('div');
    modal.id = 'revisionModal';
    modal.innerHTML = `
<div style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999; padding: 20px;">
<div style="background: #1a1a1a; border-radius: 16px; padding: 32px; max-width: 500px; width: 100%;">
<h2 style="font-size: 20px; margin-bottom: 8px;">🔄 Request Revision</h2>
<p style="color: #888; font-size: 14px; margin-bottom: 24px;">Provide feedback for "${proof.name}"</p>

<div style="margin-bottom: 20px;">
<label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px;">Revision Feedback *</label>
<textarea id="revisionFeedback" rows="4" placeholder="Describe what changes are needed..."
                        style="width: 100%; padding: 12px; border: 1px solid #333; border-radius: 8px; background: #252525; color: #fff; font-size: 14px; resize: vertical;"></textarea>
</div>

<div style="margin-bottom: 24px;">
<label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 12px;">Quick Feedback Options</label>
<div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${['Color adjustment needed', 'Font change required', 'Layout revision', 'Size/dimension issue', 'Text/copy change', 'Image quality issue'].map(opt => `
<button onclick="document.getElementById('revisionFeedback').value += '${opt}. '"
                                style="padding: 8px 12px; background: #333; border: none; color: #fff; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                ${opt}
</button>
                        `).join('')}
</div>
</div>

<div style="display: flex; gap: 12px;">
<button onclick="document.getElementById('revisionModal').remove()"
                        style="flex: 1; padding: 12px; background: #333; border: none; color: #fff; border-radius: 8px; cursor: pointer;">
                        Cancel
</button>
<button onclick="submitProofRevision(${id})"
                        style="flex: 1; padding: 12px; background: #ef4444; border: none; color: #fff; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        Send Revision Request
</button>
</div>
</div>
</div>
    `;
    document.body.appendChild(modal);
}

async function submitProofRevision(id) {
    const feedback = document.getElementById('revisionFeedback').value.trim();
    if (!feedback) {
        alert('Please provide revision feedback.');
        return;
    }

    const proof = proofs.find(p => p.id === id);
    if (proof) {
        proof.status = 'revision';
        proof.revisionCount = (proof.revisionCount || 0) + 1;
        proof.comments = proof.comments || [];
        proof.comments.push({
            author: currentUser?.email || 'Admin',
            text: feedback,
            createdAt: new Date().toISOString()
        });
        proof.updatedAt = new Date().toISOString();
        saveProofs();

        // Notify designer via messaging
        if (proof.designerId) {
            addDesignerMessage(proof.designerId, proof.projectId, `🔄 Revision requested for "${proof.name}": ${feedback}`, 'revision', true);
        }

        // Email designer about the revision
        const designers = JSON.parse(localStorage.getItem('nui_designers') || '[]');
        const designer = designers.find(d => d.id === proof.designerId);
        if (designer?.email) {
            try {
                await fetch('/.netlify/functions/send-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to: designer.email,
                        subject: `🔄 Revision Requested: ${proof.name}`,
                        html: `<div style="font-family: -apple-system, sans-serif; max-width: 600px; margin: 0 auto; background: #0a0a0a; color: #fff; border-radius: 12px; overflow: hidden;">
<div style="background: linear-gradient(135deg, #f59e0b, #ef4444); padding: 24px; text-align: center;">
<h2 style="margin: 0; font-size: 20px; color: #fff;">🔄 Revision Requested</h2>
</div>
<div style="padding: 32px;">
<p style="color: #ccc; font-size: 16px;">Hey ${designer.name || 'Designer'},</p>
<p style="color: #ccc; font-size: 16px;">A revision has been requested for <strong>"${proof.name}"</strong>.</p>
<div style="background: #111; border: 1px solid #333; border-radius: 12px; padding: 24px; margin: 24px 0;">
<p style="color: #f59e0b; font-weight: 600; margin-bottom: 8px;">Feedback:</p>
<p style="color: #fff; font-size: 15px; line-height: 1.6;">${feedback}</p>
</div>
<p style="color: #888; font-size: 13px;">This is revision #${proof.revisionCount}. Log into the designer portal to upload the updated proof.</p>
</div>
</div>`,
                        text: `Revision requested for "${proof.name}": ${feedback}. This is revision #${proof.revisionCount}.`
                    })
                });
                console.log('📧 Designer notified of revision');
            } catch (err) {
                console.log('Designer email failed:', err.message);
            }
        }

        // Log to CRM
        logProofActivity('revision', proof, `Revision #${proof.revisionCount} requested for "${proof.name}": ${feedback}`);

        document.getElementById('revisionModal').remove();
        loadAdminProofsPanel();

        const client = clients.find(c => c.id === proof.clientId);
        alert(`🔄 Revision requested.\n\n${designer?.email ? '📧 Designer notified via email.' : 'Feedback posted to designer messages.'}`);
    }
}

function requestRevision(id) {
    requestRevisionModal(id);
}

function viewProofDetails(id) {
    const proof = proofs.find(p => p.id === id);
    if (!proof) return;

    const client = clients.find(c => c.id === proof.clientId) || { name: 'Unknown' };
    const proofType = getAllProofTypes().find(t => t.id === proof.proofType) || { name: 'Custom', size: '' };

    const modal = document.createElement('div');
    modal.id = 'proofDetailsModal';
    modal.innerHTML = `
<div style="position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 9999; padding: 20px;">
<div style="background: #1a1a1a; border-radius: 20px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto;">
<div style="padding: 24px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
<h2 style="font-size: 20px;">Proof Details</h2>
<button onclick="document.getElementById('proofDetailsModal').remove()" style="background: none; border: none; color: #888; font-size: 28px; cursor: pointer;">&times;</button>
</div>

<div style="padding: 24px;">
                    <!-- Preview -->
<div style="background: #111; border-radius: 12px; padding: 20px; margin-bottom: 24px; text-align: center;">
                        ${proof.isVideo && proof.videoUrl ? `
<video src="${proof.videoUrl}" style="max-width: 100%; max-height: 400px; border-radius: 8px;" controls></video>
                        ` : proof.image ? `
<img alt="Proof revision image" loading="lazy" src="${proof.image}" style="max-width: 100%; max-height: 400px; border-radius: 8px;">
                        ` : `
<div style="padding: 60px; color: #666;">No preview available</div>
                        `}
</div>

                    <!-- Info Grid -->
<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px;">
<div style="background: #252525; padding: 16px; border-radius: 8px;">
<div style="font-size: 12px; color: #888; margin-bottom: 4px;">Proof Name</div>
<div style="font-weight: 600;">${proof.name}</div>
</div>
<div style="background: #252525; padding: 16px; border-radius: 8px;">
<div style="font-size: 12px; color: #888; margin-bottom: 4px;">Client</div>
<div style="font-weight: 600;">${client.name}</div>
</div>
<div style="background: #252525; padding: 16px; border-radius: 8px;">
<div style="font-size: 12px; color: #888; margin-bottom: 4px;">Type</div>
<div style="font-weight: 600;">${proofType.name}</div>
</div>
<div style="background: #252525; padding: 16px; border-radius: 8px;">
<div style="font-size: 12px; color: #888; margin-bottom: 4px;">Size</div>
<div style="font-weight: 600;">${proofType.size || proof.proofSize || 'Custom'}</div>
</div>
<div style="background: #252525; padding: 16px; border-radius: 8px;">
<div style="font-size: 12px; color: #888; margin-bottom: 4px;">Version</div>
<div style="font-weight: 600;">v${proof.version || 1}</div>
</div>
<div style="background: #252525; padding: 16px; border-radius: 8px;">
<div style="font-size: 12px; color: #888; margin-bottom: 4px;">Status</div>
<div style="font-weight: 600; text-transform: capitalize;">${proof.status}</div>
</div>
</div>

                    ${proof.notes ? `
<div style="background: #252525; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
<div style="font-size: 12px; color: #888; margin-bottom: 8px;">Notes</div>
<div>${proof.notes}</div>
</div>
                    ` : ''}

                    ${proof.comments && proof.comments.length > 0 ? `
<div style="background: #252525; padding: 16px; border-radius: 8px;">
<div style="font-size: 12px; color: #888; margin-bottom: 12px;">Feedback History</div>
                            ${proof.comments.map(c => `
<div style="border-left: 3px solid #e11d48; padding-left: 12px; margin-bottom: 12px;">
<div style="font-size: 12px; color: #888;">${c.author} • ${new Date(c.createdAt).toLocaleString()}</div>
<div style="margin-top: 4px;">${c.text}</div>
</div>
                            `).join('')}
</div>
                    ` : ''}
</div>
</div>
</div>
    `;
    document.body.appendChild(modal);
}

function viewApprovedAsset(proofId) {
    const proof = proofs.find(p => p.id === proofId);
    if (!proof) return;

    // Switch to brand guide panel with this client selected
    showAdminPanel('brandguide');

    // Could also show a specific modal or filter to this client
    alert(`Asset "${proof.name}" is saved in the client's Brand Guide.\n\nNavigating to Brand Guide panel...`);
}

// Open proof preview with comment functionality (for website/link proofs)
function openProofPreview(proofId) {
    const proof = proofs.find(p => p.id === proofId);
    if (!proof) return;

    const client = clients.find(c => c.id === proof.clientId) || { name: 'Unknown' };
    const proofType = getAllProofTypes().find(t => t.id === proof.proofType) || { name: 'Custom' };

    const modal = document.createElement('div');
    modal.id = 'proofPreviewModal';
    modal.innerHTML = `
<div style="position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: flex; z-index: 9999;">
            <!-- Left: Preview Area -->
<div style="flex: 1; display: flex; flex-direction: column; border-right: 1px solid #333;">
<div style="padding: 16px 20px; background: #1a1a1a; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
<div>
<h2 style="font-size: 18px; margin-bottom: 4px;">${proof.name}</h2>
<div style="font-size: 13px; color: #888;">${proofType.name} • ${client.name}</div>
</div>
<div style="display: flex; gap: 8px;">
                        ${proof.previewUrl ? `<button onclick="window.open('${proof.previewUrl}', '_blank')" style="padding: 8px 16px; background: #3b82f6; border: none; color: #fff; border-radius: 6px; cursor: pointer;">🔗 Open in New Tab</button>` : ''}
<button onclick="document.getElementById('proofPreviewModal').remove()" style="padding: 8px 16px; background: #333; border: none; color: #fff; border-radius: 6px; cursor: pointer;">✕ Close</button>
</div>
</div>
<div style="flex: 1; background: #111; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                    ${proof.previewUrl ? `
<iframe src="${proof.previewUrl}" style="width: 100%; height: 100%; border: none;" sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
                    ` : proof.image ? `
<img alt="Proof approval image" loading="lazy" src="${proof.image}" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                    ` : `
<div style="text-align: center; color: #666;">
<div style="font-size: 64px; margin-bottom: 16px;">🌐</div>
<div>No preview available</div>
</div>
                    `}
</div>
</div>

            <!-- Right: Comments Panel -->
<div style="width: 380px; display: flex; flex-direction: column; background: #1a1a1a;">
<div style="padding: 20px; border-bottom: 1px solid #333;">
<h3 style="font-size: 16px; margin-bottom: 8px;">💬 Comments & Feedback</h3>
<div style="display: flex; gap: 8px;">
<span class="order-status ${proof.status}" style="text-transform: capitalize;">${proof.status}</span>
<span style="color: #888; font-size: 12px;">v${proof.version || 1}</span>
</div>
</div>

                <!-- Comments List -->
<div id="proofCommentsList" style="flex: 1; overflow-y: auto; padding: 16px;">
                    ${(proof.comments || []).length === 0 ? `
<div style="text-align: center; color: #666; padding: 40px 20px;">
<div style="font-size: 32px; margin-bottom: 8px;">💬</div>
<div>No comments yet</div>
<div style="font-size: 12px; margin-top: 4px;">Be the first to leave feedback</div>
</div>
                    ` : (proof.comments || []).map(c => `
<div style="background: #252525; border-radius: 12px; padding: 12px; margin-bottom: 12px;">
<div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
<span style="font-weight: 600; font-size: 13px;">${c.author}</span>
<span style="font-size: 11px; color: #888;">${new Date(c.createdAt).toLocaleString()}</span>
</div>
<div style="font-size: 14px; color: #ccc; line-height: 1.5;">${c.text}</div>
</div>
                    `).join('')}
</div>

                <!-- Add Comment -->
<div style="padding: 16px; border-top: 1px solid #333; background: #252525;">
<textarea id="newProofComment" rows="3" placeholder="Leave your feedback or request changes..."
                        style="width: 100%; padding: 12px; border: 1px solid #444; border-radius: 8px; background: #1a1a1a; color: #fff; font-size: 14px; resize: none; margin-bottom: 12px;"></textarea>
<div style="display: flex; gap: 8px;">
<button onclick="addProofComment(${proof.id}, 'revision')" style="flex: 1; padding: 10px; background: #ef4444; border: none; color: #fff; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            🔄 Request Changes
</button>
<button onclick="addProofComment(${proof.id}, 'approve')" style="flex: 1; padding: 10px; background: #10b981; border: none; color: #fff; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            ✅ Approve
</button>
</div>
</div>
</div>
</div>
    `;
    document.body.appendChild(modal);
}

// Add comment to proof
function addProofComment(proofId, action) {
    const proof = proofs.find(p => p.id === proofId);
    if (!proof) return;

    const commentText = document.getElementById('newProofComment').value.trim();
    const authorName = currentUser?.name || currentUser?.email || 'User';

    if (!commentText && action === 'revision') {
        alert('Please enter your feedback for the revision request.');
        return;
    }

    // Add comment
    proof.comments = proof.comments || [];
    if (commentText) {
        proof.comments.push({
            author: authorName,
            text: commentText,
            action: action,
            createdAt: new Date().toISOString()
        });
    }

    // Update status based on action
    if (action === 'approve') {
        proof.status = 'approved';
        proof.approvedAt = new Date().toISOString();
        saveProofToBrandAssets(proof);
        triggerProofApproved(proofId);
    } else if (action === 'revision') {
        proof.status = 'revision';
    }

    saveProofs();

    // Close modal and refresh
    document.getElementById('proofPreviewModal').remove();
    loadAdminProofsPanel();

    // Notify
    if (action === 'approve') {
        alert('✅ Proof approved! Asset saved to brand guide.');
    } else {
        alert('🔄 Revision requested. The design team has been notified.');
    }

    // Add to CRM communications
    addCrmCommunication(proof.clientId, action === 'approve' ? 'Proof Approved' : 'Revision Requested', commentText || `Proof "${proof.name}" ${action === 'approve' ? 'approved' : 'revision requested'}`);
}

// Add communication to CRM
function addCrmCommunication(clientId, type, message) {
    const communications = JSON.parse(localStorage.getItem('nui_crm_communications')) || [];
    communications.push({
        id: Date.now(),
        clientId: clientId,
        type: type,
        message: message,
        channel: 'proof_system',
        direction: 'inbound',
        createdAt: new Date().toISOString(),
        read: false
    });
    localStorage.setItem('nui_crm_communications', JSON.stringify(communications));
}

// Storage Manager Modal
function showStorageManager() {
    const storage = getStorageUsage();
    const approvedProofs = proofs.filter(p => p.status === 'approved');
    const proofsWithImages = proofs.filter(p => p.image && p.image !== '[archived]');

    const modal = document.createElement('div');
    modal.id = 'storageManagerModal';
    modal.innerHTML = `
<div style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999; padding: 20px;">
<div style="background: #1a1a1a; border-radius: 16px; padding: 32px; max-width: 500px; width: 100%;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
<h2 style="font-size: 20px;">💾 Storage Manager</h2>
<button onclick="document.getElementById('storageManagerModal').remove()" style="background: none; border: none; color: #888; font-size: 24px; cursor: pointer;">&times;</button>
</div>

                <!-- Storage Usage -->
<div style="background: #252525; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
<div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
<span>Used Storage</span>
<span style="font-weight: 600;">${storage.used} / ~5 MB</span>
</div>
<div style="width: 100%; height: 12px; background: #333; border-radius: 6px; overflow: hidden;">
<div style="width: ${Math.min((storage.usedBytes / 5000000) * 100, 100)}%; height: 100%; background: ${(storage.usedBytes / 5000000) > 0.8 ? '#ef4444' : '#10b981'}; border-radius: 6px;"></div>
</div>
</div>

                <!-- Stats -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
<div style="background: #252525; padding: 16px; border-radius: 8px; text-align: center;">
<div style="font-size: 24px; font-weight: 700;">${proofs.length}</div>
<div style="font-size: 12px; color: #888;">Total Proofs</div>
</div>
<div style="background: #252525; padding: 16px; border-radius: 8px; text-align: center;">
<div style="font-size: 24px; font-weight: 700;">${proofsWithImages.length}</div>
<div style="font-size: 12px; color: #888;">With Images</div>
</div>
</div>

                <!-- Cleanup Options -->
<div style="display: flex; flex-direction: column; gap: 12px;">
<button onclick="archiveOldProofs()" style="padding: 14px; background: #f59e0b; border: none; color: #fff; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        📦 Archive Old Approved Proofs (30+ days)
<div style="font-size: 11px; font-weight: normal; margin-top: 4px;">Keeps metadata, removes images</div>
</button>
<button onclick="clearRevisionProofs()" style="padding: 14px; background: #ef4444; border: none; color: #fff; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        🗑️ Clear Old Revision Requests
<div style="font-size: 11px; font-weight: normal; margin-top: 4px;">Removes revision proofs older than 60 days</div>
</button>
<button onclick="if(confirm('Delete ALL proofs? This cannot be undone!')) { proofs = []; saveProofs(); document.getElementById('storageManagerModal').remove(); loadAdminProofsPanel(); }" style="padding: 14px; background: #333; border: 1px solid #ef4444; color: #ef4444; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        ⚠️ Delete All Proofs
</button>
</div>

<p style="color: #666; font-size: 11px; text-align: center; margin-top: 20px;">
                    💡 Tip: Images are compressed to ~100KB when uploaded to save space.
</p>
</div>
</div>
    `;
    document.body.appendChild(modal);
}

function archiveOldProofs() {
    const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
    let archived = 0;

    proofs.forEach(p => {
        if (p.status === 'approved' && p.approvedAt && new Date(p.approvedAt).getTime() < thirtyDaysAgo) {
            if (p.image && p.image !== '[archived]') {
                p.image = '[archived]';
                archived++;
            }
            if (p.videoUrl && p.videoUrl !== '[archived]') {
                p.videoUrl = '[archived]';
                archived++;
            }
        }
    });

    saveProofs();
    document.getElementById('storageManagerModal').remove();
    loadAdminProofsPanel();
    alert(`✅ Archived ${archived} proof file(s). Storage freed!`);
}

function clearRevisionProofs() {
    const sixtyDaysAgo = Date.now() - (60 * 24 * 60 * 60 * 1000);
    const before = proofs.length;

    proofs = proofs.filter(p => {
        if (p.status === 'revision' && new Date(p.createdAt).getTime() < sixtyDaysAgo) {
            return false; // Remove old revision proofs
        }
        return true;
    });

    const removed = before - proofs.length;
    saveProofs();
    document.getElementById('storageManagerModal').remove();
    loadAdminProofsPanel();
    alert(`✅ Removed ${removed} old revision proof(s).`);
}

// ==================== DELIVERY PANEL ====================
function loadAdminDeliveryPanel() {
    const deliveredOrders = orders.filter(o => o.status === 'delivered' || o.status === 'complete');
    const pendingDelivery = orders.filter(o => o.status === 'in_progress');
    const pendingProofs = proofs.filter(p => p.status === 'pending_admin' || p.status === 'pending');
    const approvedProofs = proofs.filter(p => p.status === 'approved');
    const revisionProofs = proofs.filter(p => p.status === 'revision');

    // Get recent proof activity for the timeline
    const recentActivity = [
        ...proofs.map(p => ({
            type: 'proof',
            status: p.status,
            name: p.name || p.fileName || p.title || 'Proof',
            project: p.projectName || orders.find(o => o.id === p.projectId)?.projectName || '',
            client: p.clientName || clients.find(c => c.id == p.clientId)?.name || '',
            designer: p.designerName || '',
            date: p.updatedAt || p.uploadedAt || p.createdAt,
            version: p.version,
            id: p.id
        })),
        ...deliveredOrders.map(o => ({
            type: 'delivery',
            status: 'delivered',
            name: o.projectName || o.project,
            client: clients.find(c => c.id === o.clientId)?.name || '',
            date: o.deliveredAt || o.updatedAt,
            id: o.id
        }))
    ].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 15);

    document.getElementById('adminDeliveryPanel').innerHTML = `
<div class="panel-header">
<h2 class="panel-title">📦 Delivery & Proofing</h2>
<p class="panel-subtitle">Manage proofs, deliverables, and client handoff — all activity in one place</p>
</div>

        <!-- Stats -->
<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 32px;">
<div style="background: #111; padding: 20px; border-radius: 12px; border: 1px solid #222; text-align: center;">
<div style="font-size: 28px; font-weight: 700; color: #f59e0b;">${pendingProofs.length}</div>
<div style="color: #888; font-size: 13px;">Proofs Pending</div>
</div>
<div style="background: #111; padding: 20px; border-radius: 12px; border: 1px solid #222; text-align: center;">
<div style="font-size: 28px; font-weight: 700; color: #ef4444;">${revisionProofs.length}</div>
<div style="color: #888; font-size: 13px;">In Revision</div>
</div>
<div style="background: #111; padding: 20px; border-radius: 12px; border: 1px solid #222; text-align: center;">
<div style="font-size: 28px; font-weight: 700; color: #10b981;">${approvedProofs.length}</div>
<div style="color: #888; font-size: 13px;">Approved</div>
</div>
<div style="background: #111; padding: 20px; border-radius: 12px; border: 1px solid #222; text-align: center;">
<div style="font-size: 28px; font-weight: 700; color: #3b82f6;">${pendingDelivery.length}</div>
<div style="color: #888; font-size: 13px;">Awaiting Delivery</div>
</div>
<div style="background: #111; padding: 20px; border-radius: 12px; border: 1px solid #222; text-align: center;">
<div style="font-size: 28px; font-weight: 700; color: #8b5cf6;">${deliveredOrders.length}</div>
<div style="color: #888; font-size: 13px;">Delivered</div>
</div>
</div>

        <!-- Pending Proofs from Designers -->
        ${pendingProofs.length > 0 ? `
<div class="form-section" style="margin-bottom: 24px;">
<div class="form-section-title">🔔 Proofs Awaiting Your Review</div>
            ${pendingProofs.map(p => {
                const project = orders.find(o => o.id === p.projectId);
                const client = clients.find(c => c.id == p.clientId);
                return `
<div style="background: #1a1a1a; padding: 16px 20px; border-radius: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #f59e0b;">
<div>
<div style="font-weight: 600;">${p.name || p.fileName || 'Proof'} ${p.version ? '(v' + p.version + ')' : ''}</div>
<div style="color: #888; font-size: 13px;">${p.designerName || 'Designer'} • ${project?.projectName || ''} • ${client?.name || ''}</div>
<div style="color: #666; font-size: 12px;">${p.uploadedAt ? new Date(p.uploadedAt).toLocaleString() : ''}</div>
</div>
<div style="display: flex; gap: 8px;">
<button class="btn-admin small" onclick="viewProofDetails(${p.id})">👁 View</button>
<button class="btn-admin small primary" onclick="approveProof(${p.id})">✅ Approve</button>
<button class="btn-admin small" style="background: #ef444420; color: #ef4444;" onclick="requestRevisionModal(${p.id})">🔄 Revise</button>
</div>
</div>`;
            }).join('')}
</div>` : ''}

        <!-- Ready for Delivery -->
<div class="form-section" style="margin-bottom: 24px;">
<div class="form-section-title">📤 Ready for Delivery</div>
            ${pendingDelivery.length === 0 ? '<p style="color: rgba(255,255,255,0.5); text-align: center; padding: 24px;">No orders pending delivery</p>' : pendingDelivery.map(order => {
                const client = clients.find(c => c.id === order.clientId) || { name: 'Unknown' };
                const orderProofs = proofs.filter(p => p.projectId === order.id);
                const approvedCount = orderProofs.filter(p => p.status === 'approved').length;
                const isPaid = checkClientPaymentStatus(order.clientId);
                return `
<div style="background: #1a1a1a; padding: 20px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #3b82f6;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
<div>
<div style="font-weight: 600; font-size: 16px;">${order.projectName || order.project}</div>
<div style="color: #888; font-size: 13px;">${client.name} • ${orderProofs.length} proofs (${approvedCount} approved)</div>
</div>
<div style="display: flex; gap: 8px; align-items: center;">
                            ${isPaid ? '<span style="background: #10b98120; color: #10b981; padding: 4px 10px; border-radius: 6px; font-size: 12px;">💰 Paid</span>' : '<span style="background: #f59e0b20; color: #f59e0b; padding: 4px 10px; border-radius: 6px; font-size: 12px;">⏳ Payment Pending</span>'}
<span class="order-status in_progress" style="font-size: 12px;">In Progress</span>
</div>
</div>
<div style="display: flex; gap: 12px;">
<button class="btn-admin primary" onclick="markDelivered(${order.id})">📦 Mark Delivered & Notify Client</button>
<button class="btn-admin secondary" onclick="showAdminPanel('proofs')">✅ View Proofs</button>
</div>
</div>`;
            }).join('')}
</div>

        <!-- Activity Timeline -->
<div class="form-section">
<div class="form-section-title">📋 Recent Activity Timeline</div>
<div style="max-height: 400px; overflow-y: auto;">
                ${recentActivity.length === 0 ? '<p style="color: rgba(255,255,255,0.5); text-align: center; padding: 24px;">No activity yet</p>' : recentActivity.map(a => {
                    const icon = a.type === 'delivery' ? '📦' : a.status === 'approved' ? '✅' : a.status === 'revision' ? '🔄' : a.status === 'pending_admin' ? '📤' : a.status === 'pending' ? '⏳' : '📄';
                    const color = a.status === 'approved' ? '#10b981' : a.status === 'revision' ? '#ef4444' : a.status === 'delivered' ? '#8b5cf6' : a.status === 'pending_admin' ? '#f59e0b' : '#3b82f6';
                    return `
<div style="display: flex; gap: 16px; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
<div style="font-size: 20px;">${icon}</div>
<div style="flex: 1;">
<div style="font-weight: 500;">${a.name} ${a.version ? '(v' + a.version + ')' : ''}</div>
<div style="color: #888; font-size: 13px;">${a.client}${a.designer ? ' • by ' + a.designer : ''}${a.project ? ' • ' + a.project : ''}</div>
</div>
<div style="text-align: right;">
<span style="color: ${color}; font-size: 12px; font-weight: 600;">${(a.status || '').replace('_', ' ')}</span>
<div style="color: #666; font-size: 11px;">${a.date ? new Date(a.date).toLocaleDateString() : ''}</div>
</div>
</div>`;
                }).join('')}
</div>
</div>

        <!-- Delivered History -->
<div class="form-section" style="margin-top: 24px;">
<div class="form-section-title">✅ Delivered Projects</div>
            ${deliveredOrders.length === 0 ? '<p style="color: rgba(255,255,255,0.5); text-align: center; padding: 24px;">No deliveries yet</p>' : deliveredOrders.slice(0, 10).map(order => {
                const client = clients.find(c => c.id === order.clientId) || { name: 'Unknown' };
                return `
<div style="background: #1a1a1a; padding: 16px 20px; border-radius: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #8b5cf6;">
<div>
<div style="font-weight: 600;">${order.projectName || order.project}</div>
<div style="color: #888; font-size: 13px;">${client.name}</div>
</div>
<div style="text-align: right;">
<span style="color: #8b5cf6; font-size: 12px; font-weight: 600;">Delivered</span>
<div style="color: #666; font-size: 11px;">${order.deliveredAt ? new Date(order.deliveredAt).toLocaleDateString() : ''}</div>
</div>
</div>`;
            }).join('')}
</div>
    `;
}

function showUploadDeliveryModal(orderId) {
    alert('Upload delivery files for order #' + orderId + ' (File upload interface would go here)');
}

// ==================== SEO PANEL ====================
function loadAdminSeoPanel() {
    document.getElementById('adminSeoPanel').innerHTML = `
<div class="panel-header">
<h2 class="panel-title">🔍 SEO / AEO / GEO Management</h2>
<p class="panel-subtitle">Optimize for search engines, AI answer engines, and local search</p>
</div>
<div class="seo-grid">
<div class="seo-card">
<div class="seo-card-title">📊 SEO Score</div>
<div class="seo-score">
<div class="seo-score-circle good">85</div>
<div><p style="font-weight: 600;">Good</p><p style="font-size: 13px; color: rgba(255,255,255,0.5);">Your site is well optimized</p></div>
</div>
</div>
<div class="seo-card">
<div class="seo-card-title">🤖 AEO Readiness</div>
<div class="seo-score">
<div class="seo-score-circle medium">72</div>
<div><p style="font-weight: 600;">Moderate</p><p style="font-size: 13px; color: rgba(255,255,255,0.5);">Add more FAQ content</p></div>
</div>
</div>
</div>
<div class="form-section">
<div class="form-section-title">🏷️ Meta Tags</div>
<div class="form-group"><label class="form-label">Page Title</label><input type="text" class="form-input" value="${seoData.siteMeta.title}" onchange="seoData.siteMeta.title = this.value; saveSeo();"></div>
<div class="form-group"><label class="form-label">Meta Description</label><textarea class="form-textarea" onchange="seoData.siteMeta.description = this.value; saveSeo();">${seoData.siteMeta.description}</textarea></div>
<div class="form-group">
<label class="form-label">Keywords</label>
<input type="text" class="form-input" value="${seoData.siteMeta.keywords}" onchange="seoData.siteMeta.keywords = this.value; saveSeo();" placeholder="Separate with commas">
</div>
<div class="form-row">
<div class="form-group"><label class="form-label">OG Image URL</label><input type="text" class="form-input" value="${seoData.siteMeta.ogImage || ''}" onchange="seoData.siteMeta.ogImage = this.value; saveSeo();" placeholder="https://..."></div>
<div class="form-group"><label class="form-label">Twitter Handle</label><input type="text" class="form-input" value="${seoData.siteMeta.twitterHandle || ''}" onchange="seoData.siteMeta.twitterHandle = this.value; saveSeo();" placeholder="@yourhandle"></div>
</div>
<button class="btn-admin primary" onclick="applyMetaTags()">Apply Meta Tags to Site</button>
</div>
<div class="form-section">
<div class="form-section-title">❓ AEO - FAQ Schema (For AI Answer Engines)</div>
<p style="color: rgba(255,255,255,0.5); font-size: 13px; margin-bottom: 16px;">FAQs help AI assistants find and cite your content</p>
            ${seoData.aeoContent.faqs.map((faq, i) => `
<div class="faq-item">
<div class="faq-question">${faq.question}</div>
<div class="faq-answer">${faq.answer}</div>
<button class="btn-admin danger" style="margin-top: 8px; padding: 6px 12px; font-size: 11px;" onclick="removeFaq(${i})">Remove</button>
</div>
            `).join('')}
<button class="btn-admin secondary" onclick="showAddFaqModal()">+ Add FAQ</button>
</div>
    `;
}

function applyMetaTags() {
    document.title = seoData.siteMeta.title;
    let metaDesc = document.querySelector('meta[name="description"]');
    if (!metaDesc) { metaDesc = document.createElement('meta'); metaDesc.name = 'description'; document.head.appendChild(metaDesc); }
    metaDesc.content = seoData.siteMeta.description;
    let metaKeywords = document.querySelector('meta[name="keywords"]');
    if (!metaKeywords) { metaKeywords = document.createElement('meta'); metaKeywords.name = 'keywords'; document.head.appendChild(metaKeywords); }
    metaKeywords.content = seoData.siteMeta.keywords;
    alert('Meta tags applied successfully!');
}

function showAddFaqModal() {
    const q = prompt('Enter the question:');
    if (!q) return;
    const a = prompt('Enter the answer:');
    if (!a) return;
    seoData.aeoContent.faqs.push({ question: q, answer: a });
    saveSeo();
    loadAdminSeoPanel();
}

function removeFaq(idx) {
    seoData.aeoContent.faqs.splice(idx, 1);
    saveSeo();
    loadAdminSeoPanel();
}

// ==================== GOOGLE MY BUSINESS PANEL ====================
function loadAdminGmbPanel() {
    document.getElementById('adminGmbPanel').innerHTML = `
<div class="panel-header">
<h2 class="panel-title">📍 Google My Business</h2>
<p class="panel-subtitle">Manage your local SEO and Google Business Profile</p>
</div>
<div class="seo-grid">
<div class="form-section" style="margin-bottom: 0;">
<div class="form-section-title">📍 Business Information</div>
<div class="form-group"><label class="form-label">Business Name</label><input type="text" class="form-input" value="${seoData.localSeo.businessName}" onchange="seoData.localSeo.businessName = this.value; saveSeo();"></div>
<div class="form-group"><label class="form-label">Address</label><input type="text" class="form-input" value="${seoData.localSeo.address}" onchange="seoData.localSeo.address = this.value; saveSeo();"></div>
<div class="form-row">
<div class="form-group"><label class="form-label">Phone</label><input type="tel" class="form-input" value="${seoData.localSeo.phone}" onchange="seoData.localSeo.phone = this.value; saveSeo();"></div>
<div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" value="${seoData.localSeo.email}" onchange="seoData.localSeo.email = this.value; saveSeo();"></div>
</div>
<div class="form-group"><label class="form-label">Business Hours</label><input type="text" class="form-input" value="${seoData.localSeo.hours}" onchange="seoData.localSeo.hours = this.value; saveSeo();"></div>
</div>
<div class="form-section" style="margin-bottom: 0;">
<div class="form-section-title">🔗 Google Integration</div>
<div class="form-group"><label class="form-label">Google Place ID</label><input type="text" class="form-input" value="${seoData.googleMyBusiness.placeId || ''}" onchange="seoData.googleMyBusiness.placeId = this.value; saveSeo();" placeholder="ChIJ..."></div>
<div class="form-group"><label class="form-label">Review Link</label><input type="text" class="form-input" value="${seoData.googleMyBusiness.reviewLink || ''}" onchange="seoData.googleMyBusiness.reviewLink = this.value; saveSeo();" placeholder="https://g.page/..."></div>
<div class="form-group"><label class="form-label">Map Embed URL</label><input type="text" class="form-input" value="${seoData.googleMyBusiness.mapEmbed || ''}" onchange="seoData.googleMyBusiness.mapEmbed = this.value; saveSeo();" placeholder="https://www.google.com/maps/embed..."></div>
<div style="padding: 20px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; margin-top: 16px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
<h4 style="font-size: 14px; font-weight: 600; color: #fff;">⚡ Live Reviews Sync</h4>
<span id="gmbSyncStatus" style="font-size: 12px; padding: 4px 12px; border-radius: 100px; background: ${seoData.googleMyBusiness.placeId ? 'rgba(16,185,129,0.15); color: #34d399;' : 'rgba(255,255,255,0.1); color: rgba(255,255,255,0.4);'}">${seoData.googleMyBusiness.placeId ? '● Place ID Set' : '○ Not Configured'}</span>
</div>
<p style="font-size: 13px; color: rgba(255,255,255,0.5); margin-bottom: 16px;">Enter your Place ID above, then add <strong style="color: #fff;">GOOGLE_PLACES_API_KEY</strong> to your Netlify environment variables. Click Sync to pull real Google reviews.</p>
<div style="display: flex; gap: 12px;">
<button onclick="syncGoogleReviews()" class="btn-admin primary" style="flex: 1;">🔄 Sync Reviews Now</button>
<button onclick="window.open('https://developers.google.com/maps/documentation/places/web-service/place-id-lookup', '_blank')" class="btn-admin" style="flex: 1; background: rgba(255,255,255,0.1); color: #fff;">🔍 Find Place ID</button>
</div>
<div id="gmbSyncResult" style="margin-top: 12px; display: none;"></div>
</div>
</div>
</div>
<div class="form-section">
<div class="form-section-title">🗺️ Service Areas</div>
<div class="tags-input">
                ${seoData.localSeo.serviceAreas.map((area, i) => `<span class="tag">${area}<span class="tag-remove" onclick="removeServiceArea(${i})">×</span></span>`).join('')}
<input type="text" placeholder="Add area..." onkeypress="if(event.key === 'Enter') { addServiceArea(this.value); this.value = ''; }">
</div>
</div>
<div class="form-section">
<div class="form-section-title">🏢 Business Categories</div>
<div class="tags-input">
                ${seoData.localSeo.categories.map((cat, i) => `<span class="tag">${cat}<span class="tag-remove" onclick="removeCategory(${i})">×</span></span>`).join('')}
<input type="text" placeholder="Add category..." onkeypress="if(event.key === 'Enter') { addCategory(this.value); this.value = ''; }">
</div>
</div>
<div class="form-section">
<div class="form-section-title">⭐ Schema.org Data</div>
<div class="form-row">
<div class="form-group"><label class="form-label">Price Range</label><select class="form-select" onchange="seoData.schema.priceRange = this.value; saveSeo();">
<option value="$" ${seoData.schema.priceRange === '$' ? 'selected' : ''}>$ - Budget</option>
<option value="$$" ${seoData.schema.priceRange === '$$' ? 'selected' : ''}>$$ - Moderate</option>
<option value="$$$" ${seoData.schema.priceRange === '$$$' ? 'selected' : ''}>$$$ - Expensive</option>
<option value="$$$$" ${seoData.schema.priceRange === '$$$$' ? 'selected' : ''}>$$$$ - Luxury</option>
</select></div>
<div class="form-group"><label class="form-label">Rating</label><input type="text" class="form-input" value="${seoData.schema.rating}" onchange="seoData.schema.rating = this.value; saveSeo();"></div>
</div>
</div>
    `;
}

function addServiceArea(area) {
    if (area && !seoData.localSeo.serviceAreas.includes(area)) {
        seoData.localSeo.serviceAreas.push(area);
        saveSeo();
        loadAdminGmbPanel();
    }
}

function removeServiceArea(idx) {
    seoData.localSeo.serviceAreas.splice(idx, 1);
    saveSeo();
    loadAdminGmbPanel();
}

function addCategory(cat) {
    if (cat && !seoData.localSeo.categories.includes(cat)) {
        seoData.localSeo.categories.push(cat);
        saveSeo();
        loadAdminGmbPanel();
    }
}

function removeCategory(idx) {
    seoData.localSeo.categories.splice(idx, 1);
    saveSeo();
    loadAdminGmbPanel();
}

// ==================== EMAIL MARKETING PANEL ====================
function loadAdminEmailMarketingPanel() {
    const em = emailMarketing;
    document.getElementById('adminEmailmarketingPanel').innerHTML = `
<div class="panel-header">
<h2 class="panel-title">📧 Email Marketing</h2>
<p class="panel-subtitle">Send newsletters and promotions to your subscribers</p>
</div>

        <!-- Stats -->
<div class="stats-grid">
<div class="stat-card"><div class="stat-label">Subscribers</div><div class="stat-value">${em.subscribers.length}</div></div>
<div class="stat-card"><div class="stat-label">Campaigns Sent</div><div class="stat-value">${em.campaigns.length}</div></div>
<div class="stat-card"><div class="stat-label">Open Rate</div><div class="stat-value">${em.analytics.sent > 0 ? Math.round((em.analytics.opened / em.analytics.sent) * 100) : 0}%</div></div>
<div class="stat-card"><div class="stat-label">Click Rate</div><div class="stat-value">${em.analytics.sent > 0 ? Math.round((em.analytics.clicked / em.analytics.sent) * 100) : 0}%</div></div>
</div>

        <!-- Automated Newsletter Toggle -->
<div class="form-section" style="background: ${em.settings.automatedSending ? 'rgba(46,204,113,0.1)' : 'rgba(255,59,48,0.1)'}; border: 1px solid ${em.settings.automatedSending ? '#2ecc71' : '#ff3b30'};">
<div style="display: flex; justify-content: space-between; align-items: center;">
<div>
<div class="form-section-title" style="margin: 0;">🤖 Automated Weekly Newsletter</div>
<p style="color: rgba(255,255,255,0.5); font-size: 13px; margin: 8px 0 0;">Send newsletters automatically every ${em.settings.sendDay} at ${em.settings.sendTime}</p>
</div>
<label class="switch">
<input type="checkbox" ${em.settings.automatedSending ? 'checked' : ''} onchange="toggleAutomatedEmail(this.checked)">
<span class="slider round"></span>
</label>
</div>
</div>

        <!-- Schedule Settings -->
<div class="form-section">
<div class="form-section-title">⏰ Schedule Settings</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Send Day</label>
<select class="form-select" onchange="updateEmailSchedule('sendDay', this.value)">
<option value="monday" ${em.settings.sendDay === 'monday' ? 'selected' : ''}>Monday</option>
<option value="tuesday" ${em.settings.sendDay === 'tuesday' ? 'selected' : ''}>Tuesday</option>
<option value="wednesday" ${em.settings.sendDay === 'wednesday' ? 'selected' : ''}>Wednesday</option>
<option value="thursday" ${em.settings.sendDay === 'thursday' ? 'selected' : ''}>Thursday</option>
<option value="friday" ${em.settings.sendDay === 'friday' ? 'selected' : ''}>Friday</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Send Time</label>
<input type="time" class="form-input" value="${em.settings.sendTime}" onchange="updateEmailSchedule('sendTime', this.value)">
</div>
<div class="form-group">
<label class="form-label">Sender Name</label>
<input type="text" class="form-input" value="${em.settings.senderName}" onchange="updateEmailSchedule('senderName', this.value)">
</div>
<div class="form-group">
<label class="form-label">Sender Email</label>
<input type="email" class="form-input" value="${em.settings.senderEmail}" onchange="updateEmailSchedule('senderEmail', this.value)">
</div>
</div>
</div>

        <!-- Create Campaign -->
<div style="display: flex; gap: 12px; margin-bottom: 24px;">
<button class="btn-admin primary" onclick="showCreateCampaignModal()">📝 Create Campaign</button>
<button class="btn-admin secondary" onclick="showAddSubscriberModal()">➕ Add Subscriber</button>
<button class="btn-admin secondary" onclick="exportSubscribersCSV()">📥 Export Subscribers</button>
</div>

        <!-- Templates -->
<div class="form-section">
<div class="form-section-title">📋 Email Templates</div>
<div class="card-grid">
                ${em.templates.map(t => `
<div class="client-card" style="cursor: pointer;" onclick="editEmailTemplate(${t.id})">
<div class="client-card-header" style="background: linear-gradient(135deg, ${t.type === 'newsletter' ? '#3b82f6' : t.type === 'promo' ? '#f59e0b' : '#8b5cf6'}, #000); height: 80px;">
<span style="font-size: 24px;">${t.type === 'newsletter' ? '📰' : t.type === 'promo' ? '🎁' : '📢'}</span>
</div>
<div class="client-card-body">
<div class="client-card-name">${t.name}</div>
<div class="client-card-meta">${t.subject}</div>
<div class="client-card-btns">
<button onclick="event.stopPropagation(); useEmailTemplate(${t.id})" style="background: var(--red); color: #fff;">Use Template</button>
</div>
</div>
</div>
                `).join('')}
</div>
</div>

        <!-- Recent Campaigns -->
<div class="form-section">
<div class="form-section-title">📊 Recent Campaigns</div>
<table class="data-table">
<thead><tr><th>Campaign</th><th>Sent</th><th>Opens</th><th>Clicks</th><th>Date</th><th>Status</th></tr></thead>
<tbody>
                    ${em.campaigns.length === 0 ? '<tr><td colspan="6" style="text-align: center; opacity: 0.5;">No campaigns yet</td></tr>' : ''}
                    ${em.campaigns.slice(-10).reverse().map(c => `
<tr>
<td>${c.subject}</td>
<td>${c.sent || 0}</td>
<td>${c.opens || 0}</td>
<td>${c.clicks || 0}</td>
<td>${new Date(c.createdAt).toLocaleDateString()}</td>
<td><span class="status-badge ${c.status}">${c.status}</span></td>
</tr>
                    `).join('')}
</tbody>
</table>
</div>

        <!-- Subscribers List -->
<div class="form-section">
<div class="form-section-title">👥 Subscribers (${em.subscribers.length})</div>
<div style="max-height: 300px; overflow-y: auto;">
<table class="data-table">
<thead><tr><th>Email</th><th>Name</th><th>Source</th><th>Subscribed</th><th>Actions</th></tr></thead>
<tbody>
                        ${em.subscribers.length === 0 ? '<tr><td colspan="5" style="text-align: center; opacity: 0.5;">No subscribers yet</td></tr>' : ''}
                        ${em.subscribers.map(s => `
<tr>
<td>${s.email}</td>
<td>${s.name || '-'}</td>
<td>${s.source || 'manual'}</td>
<td>${new Date(s.subscribedAt).toLocaleDateString()}</td>
<td><button class="btn-admin small danger" onclick="removeSubscriber('${s.email}')">Remove</button></td>
</tr>
                        `).join('')}
</tbody>
</table>
</div>
</div>
    `;
}

function toggleAutomatedEmail(enabled) {
    emailMarketing.settings.automatedSending = enabled;
    saveEmailMarketing();
    loadAdminEmailMarketingPanel();
}

function updateEmailSchedule(key, value) {
    emailMarketing.settings[key] = value;
    saveEmailMarketing();
}

function showCreateCampaignModal() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.id = 'campaignModal';
    modal.innerHTML = `
<div class="modal" style="max-width: 700px;">
<div class="modal-header"><h3 class="modal-title">Create Email Campaign</h3><button class="modal-close" onclick="document.getElementById('campaignModal').remove()">×</button></div>
<div class="modal-body">
<div class="form-group"><label class="form-label">Subject Line *</label><input type="text" id="campaignSubject" class="form-input" placeholder="Your eye-catching subject line"></div>
<div class="form-group"><label class="form-label">Preview Text</label><input type="text" id="campaignPreview" class="form-input" placeholder="Brief preview shown in inbox"></div>
<div class="form-group"><label class="form-label">Email Content *</label><textarea id="campaignContent" class="form-textarea" rows="10" placeholder="Write your email content here... Use {name} for personalization."></textarea></div>
<div class="form-group">
<label class="form-label">Send To</label>
<select id="campaignAudience" class="form-select">
<option value="all">All Subscribers (${emailMarketing.subscribers.length})</option>
<option value="clients">Clients Only</option>
<option value="leads">Leads Only</option>
</select>
</div>
</div>
<div class="modal-footer">
<button class="btn-admin secondary" onclick="document.getElementById('campaignModal').remove()">Cancel</button>
<button class="btn-admin secondary" onclick="saveCampaignDraft()">Save Draft</button>
<button class="btn-admin primary" onclick="sendCampaign()">Send Now</button>
</div>
</div>
    `;
    document.body.appendChild(modal);
}

function sendCampaign() {
    const subject = document.getElementById('campaignSubject').value;
    const content = document.getElementById('campaignContent').value;
    const audience = document.getElementById('campaignAudience').value;

    if (!subject || !content) {
        alert('Please fill in subject and content.');
        return;
    }

    const campaign = {
        id: Date.now(),
        subject: subject,
        preview: document.getElementById('campaignPreview').value,
        content: content,
        audience: audience,
        sent: emailMarketing.subscribers.length,
        opens: Math.floor(emailMarketing.subscribers.length * 0.35),
        clicks: Math.floor(emailMarketing.subscribers.length * 0.12),
        status: 'sent',
        createdAt: new Date().toISOString()
    };

    emailMarketing.campaigns.push(campaign);
    emailMarketing.analytics.sent += campaign.sent;
    emailMarketing.analytics.opened += campaign.opens;
    emailMarketing.analytics.clicked += campaign.clicks;
    saveEmailMarketing();

    document.getElementById('campaignModal').remove();
    loadAdminEmailMarketingPanel();
    alert('Campaign sent to ' + campaign.sent + ' subscribers!');
}

function showAddSubscriberModal() {
    const email = prompt('Enter subscriber email:');
    if (!email || !validateEmail(email)) {
        if (email) alert('Please enter a valid email address.');
        return;
    }

    if (emailMarketing.subscribers.find(s => s.email.toLowerCase() === email.toLowerCase())) {
        alert('This email is already subscribed.');
        return;
    }

    const name = prompt('Enter subscriber name (optional):');

    emailMarketing.subscribers.push({
        email: email,
        name: name || '',
        source: 'manual',
        subscribedAt: new Date().toISOString()
    });
    saveEmailMarketing();
    loadAdminEmailMarketingPanel();
    alert('Subscriber added!');
}

function removeSubscriber(email) {
    if (!confirm('Remove ' + email + ' from subscribers?')) return;
    emailMarketing.subscribers = emailMarketing.subscribers.filter(s => s.email !== email);
    saveEmailMarketing();
    loadAdminEmailMarketingPanel();
}

function useEmailTemplate(templateId) {
    const template = emailMarketing.templates.find(t => t.id === templateId);
    if (!template) {
        alert('Template not found');
        return;
    }

    // Pre-fill the campaign modal with template data
    showCreateCampaignModal();

    // Wait for modal to render then populate
    setTimeout(() => {
        const subjectInput = document.getElementById('campaignSubject');
        const contentInput = document.getElementById('campaignContent');
        if (subjectInput) subjectInput.value = template.subject || '';
        if (contentInput) contentInput.value = template.content || template.body || '';
    }, 100);
}

function editEmailTemplate(templateId) {
    const template = emailMarketing.templates.find(t => t.id === templateId);
    if (!template) return;

    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.id = 'editTemplateModal';
    modal.innerHTML = `
<div class="modal" style="max-width: 600px; background: #1a1a1a; color: #fff;">
<div class="modal-header" style="border-bottom: 1px solid rgba(255,255,255,0.1);">
<h3 class="modal-title" style="color: #fff;">✏️ Edit Template: ${template.name}</h3>
<button class="modal-close" onclick="document.getElementById('editTemplateModal').remove()" style="color: #fff;">×</button>
</div>
<div class="modal-body">
<div class="form-group">
<label class="form-label" style="color: #fff;">Template Name</label>
<input type="text" id="editTemplateName" class="form-input" value="${template.name}" style="background: #252525; color: #fff; border: 1px solid rgba(255,255,255,0.2);">
</div>
<div class="form-group">
<label class="form-label" style="color: #fff;">Subject Line</label>
<input type="text" id="editTemplateSubject" class="form-input" value="${template.subject || ''}" style="background: #252525; color: #fff; border: 1px solid rgba(255,255,255,0.2);">
</div>
<div class="form-group">
<label class="form-label" style="color: #fff;">Type</label>
<select id="editTemplateType" class="form-select" style="background: #252525; color: #fff; border: 1px solid rgba(255,255,255,0.2);">
<option value="newsletter" ${template.type === 'newsletter' ? 'selected' : ''}>📰 Newsletter</option>
<option value="promo" ${template.type === 'promo' ? 'selected' : ''}>🎁 Promotional</option>
<option value="announcement" ${template.type === 'announcement' ? 'selected' : ''}>📢 Announcement</option>
</select>
</div>
<div class="form-group">
<label class="form-label" style="color: #fff;">Content</label>
<textarea id="editTemplateContent" class="form-textarea" rows="8" style="background: #252525; color: #fff; border: 1px solid rgba(255,255,255,0.2);">${template.content || template.body || ''}</textarea>
</div>
</div>
<div class="modal-footer" style="border-top: 1px solid rgba(255,255,255,0.1);">
<button class="btn-admin secondary" onclick="document.getElementById('editTemplateModal').remove()" style="background: #333; color: #fff;">Cancel</button>
<button class="btn-admin danger" onclick="deleteEmailTemplate(${templateId})" style="background: #dc2626; color: #fff;">Delete</button>
<button class="btn-admin primary" onclick="saveEmailTemplate(${templateId})" style="background: var(--red); color: #fff;">Save Changes</button>
</div>
</div>
    `;
    document.body.appendChild(modal);
}

function saveEmailTemplate(templateId) {
    const template = emailMarketing.templates.find(t => t.id === templateId);
    if (!template) return;

    template.name = document.getElementById('editTemplateName').value;
    template.subject = document.getElementById('editTemplateSubject').value;
    template.type = document.getElementById('editTemplateType').value;
    template.content = document.getElementById('editTemplateContent').value;
    template.body = document.getElementById('editTemplateContent').value;

    saveEmailMarketing();
    document.getElementById('editTemplateModal').remove();
    loadAdminEmailMarketingPanel();
    alert('Template saved!');
}

function deleteEmailTemplate(templateId) {
    if (!confirm('Delete this template?')) return;
    emailMarketing.templates = emailMarketing.templates.filter(t => t.id !== templateId);
    saveEmailMarketing();
    document.getElementById('editTemplateModal').remove();
    loadAdminEmailMarketingPanel();
}

function showCreateProductModal() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.id = 'createProductModal';
    modal.innerHTML = `
<div class="modal" style="background: #1a1a1a; color: #fff;">
<div class="modal-header" style="border-bottom: 1px solid rgba(255,255,255,0.1);">
<h3 class="modal-title" style="color: #fff;">➕ Create New Product/Service</h3>
<button class="modal-close" onclick="document.getElementById('createProductModal').remove()" style="color: #fff;">×</button>
</div>
<div class="modal-body">
<div class="form-group">
<label class="form-label" style="color: #fff;">Product/Service Name *</label>
<input type="text" id="newProductName" class="form-input" placeholder="e.g., Custom Logo Design" style="background: #252525; color: #fff; border: 1px solid rgba(255,255,255,0.2);">
</div>
<div class="form-group">
<label class="form-label" style="color: #fff;">Type</label>
<select id="newProductType" class="form-select" style="background: #252525; color: #fff; border: 1px solid rgba(255,255,255,0.2);">
<option value="service">Individual Service</option>
<option value="package">Package</option>
</select>
</div>
<div class="form-group">
<label class="form-label" style="color: #fff;">Price *</label>
<input type="number" id="newProductPrice" class="form-input" placeholder="0.00" step="0.01" style="background: #252525; color: #fff; border: 1px solid rgba(255,255,255,0.2);">
</div>
<div class="form-group">
<label class="form-label" style="color: #fff;">Turnaround Time</label>
<input type="text" id="newProductTurnaround" class="form-input" placeholder="e.g., 3-5 days" style="background: #252525; color: #fff; border: 1px solid rgba(255,255,255,0.2);">
</div>
<div class="form-group">
<label class="form-label" style="color: #fff;">Description</label>
<textarea id="newProductDescription" class="form-textarea" rows="3" placeholder="Service description..." style="background: #252525; color: #fff; border: 1px solid rgba(255,255,255,0.2);"></textarea>
</div>
<div class="form-group">
<label class="form-label" style="color: #fff;">Category</label>
<select id="newProductCategory" class="form-select" style="background: #252525; color: #fff; border: 1px solid rgba(255,255,255,0.2);">
<option value="branding">Branding</option>
<option value="web">Web Development</option>
<option value="print">Print Design</option>
<option value="marketing">Marketing</option>
<option value="social">Social Media</option>
<option value="video">Video Production</option>
<option value="other">Other</option>
</select>
</div>
</div>
<div class="modal-footer" style="border-top: 1px solid rgba(255,255,255,0.1);">
<button class="btn-admin secondary" onclick="document.getElementById('createProductModal').remove()" style="background: #333; color: #fff;">Cancel</button>
<button class="btn-admin primary" onclick="saveNewProduct()" style="background: var(--red); color: #fff;">Create Product</button>
</div>
</div>
    `;
    document.body.appendChild(modal);
}

function saveNewProduct() {
    const name = document.getElementById('newProductName').value.trim();
    const price = parseFloat(document.getElementById('newProductPrice').value) || 0;
    const type = document.getElementById('newProductType').value;
    const turnaround = document.getElementById('newProductTurnaround').value || '3-5 days';
    const description = document.getElementById('newProductDescription').value;
    const category = document.getElementById('newProductCategory').value;

    if (!name || !price) {
        alert('Please enter product name and price');
        return;
    }

    const newProduct = {
        id: Date.now(),
        name: name,
        price: price,
        turnaround: turnaround,
        description: description,
        category: category
    };

    if (type === 'package') {
        servicePackages.push(newProduct);
        localStorage.setItem('nui_service_packages', JSON.stringify(servicePackages));
    } else {
        individualServices.push(newProduct);
        localStorage.setItem('nui_individual_services', JSON.stringify(individualServices));
    }

    document.getElementById('createProductModal').remove();

    // If invoice modal is open, refresh the dropdowns
    const invoiceModal = document.getElementById('createInvoiceModal');
    if (invoiceModal) {
        const packagesSelect = document.getElementById('quickAddPackage');
        const servicesSelect = document.getElementById('quickAddService');
        if (packagesSelect) {
            packagesSelect.innerHTML = '<option value="">-- Select Package --</option>' +
                servicePackages.map(p => '<option value="' + p.id + '">' + p.name + ' - $' + p.price + '</option>').join('');
        }
        if (servicesSelect) {
            servicesSelect.innerHTML = '<option value="">-- Select Service --</option>' +
                individualServices.map(s => '<option value="' + s.id + '">' + s.name + ' - $' + s.price + '</option>').join('');
        }
    }

    alert('Product "' + name + '" created successfully! Price: $' + price);
}

// ==================== LOYALTY PROGRAM PANEL ====================
function loadAdminLoyaltyPanel() {
    const lp = loyaltyProgram;
    document.getElementById('adminLoyaltyPanel').innerHTML = `
<div class="panel-header">
<h2 class="panel-title">🎁 Loyalty Program</h2>
<p class="panel-subtitle">Reward your loyal clients with points and discounts</p>
</div>

        <!-- Program Toggle -->
<div class="form-section" style="background: ${lp.enabled ? 'rgba(46,204,113,0.1)' : 'rgba(255,59,48,0.1)'}; border: 1px solid ${lp.enabled ? '#2ecc71' : '#ff3b30'};">
<div style="display: flex; justify-content: space-between; align-items: center;">
<div>
<div class="form-section-title" style="margin: 0;">🎯 Loyalty Program Status</div>
<p style="color: rgba(255,255,255,0.5); font-size: 13px; margin: 8px 0 0;">Clients earn ${lp.pointsPerDollar} point(s) per $1 spent</p>
</div>
<label class="switch">
<input type="checkbox" ${lp.enabled ? 'checked' : ''} onchange="toggleLoyaltyProgram(this.checked)">
<span class="slider round"></span>
</label>
</div>
</div>

        <!-- Stats -->
<div class="stats-grid">
<div class="stat-card"><div class="stat-label">Total Members</div><div class="stat-value">${lp.members.length}</div></div>
<div class="stat-card"><div class="stat-label">Points Issued</div><div class="stat-value">${lp.members.reduce((sum, m) => sum + (m.totalEarned || 0), 0).toLocaleString()}</div></div>
<div class="stat-card"><div class="stat-label">Points Redeemed</div><div class="stat-value">${lp.members.reduce((sum, m) => sum + (m.totalRedeemed || 0), 0).toLocaleString()}</div></div>
<div class="stat-card"><div class="stat-label">Avg Balance</div><div class="stat-value">${lp.members.length > 0 ? Math.round(lp.members.reduce((sum, m) => sum + (m.points || 0), 0) / lp.members.length) : 0}</div></div>
</div>

        <!-- Settings -->
<div class="form-section">
<div class="form-section-title">⚙️ Program Settings</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Points per $1 Spent</label>
<input type="number" class="form-input" value="${lp.pointsPerDollar}" min="1" onchange="updateLoyaltySetting('pointsPerDollar', parseInt(this.value))">
</div>
</div>
</div>

        <!-- Reward Tiers -->
<div class="form-section">
<div class="form-section-title">🏆 Reward Tiers</div>
<div class="card-grid">
                ${lp.rewardTiers.map((tier, i) => `
<div class="client-card">
<div class="client-card-header" style="background: linear-gradient(135deg, ${i === 0 ? '#cd7f32' : i === 1 ? '#c0c0c0' : i === 2 ? '#ffd700' : '#e5e4e2'}, #000);">
<span style="font-size: 24px;">${i === 0 ? '🥉' : i === 1 ? '🥈' : i === 2 ? '🥇' : '💎'}</span>
</div>
<div class="client-card-body">
<div class="client-card-name">${tier.name}</div>
<div class="client-card-meta">${tier.minPoints}+ points<br>${tier.discount}% discount</div>
<div style="margin-top: 8px;">
                                ${tier.perks.map(p => '<span class="tag" style="font-size: 10px;">' + p + '</span>').join('')}
</div>
<div class="client-card-btns" style="margin-top: 12px;">
<button onclick="editLoyaltyTier(${i})" style="background: var(--red); color: #fff;">Edit</button>
</div>
</div>
</div>
                `).join('')}
</div>
</div>

        <!-- Members -->
<div class="form-section">
<div class="form-section-title">👥 Loyalty Members</div>
<div style="display: flex; gap: 12px; margin-bottom: 16px;">
<button class="btn-admin primary" onclick="enrollClientInLoyalty()">➕ Enroll Client</button>
<button class="btn-admin secondary" onclick="awardBonusPoints()">🎁 Award Bonus Points</button>
</div>
<table class="data-table">
<thead><tr><th>Client</th><th>Tier</th><th>Points</th><th>Lifetime Earned</th><th>Joined</th><th>Actions</th></tr></thead>
<tbody>
                    ${lp.members.length === 0 ? '<tr><td colspan="6" style="text-align: center; opacity: 0.5;">No members yet. Enroll clients to get started!</td></tr>' : ''}
                    ${lp.members.map(m => {
                        const tier = lp.rewardTiers.slice().reverse().find(t => m.points >= t.minPoints) || lp.rewardTiers[0];
                        return `
<tr>
<td>${m.name}</td>
<td><span class="status-badge" style="background: ${tier.name === 'Bronze' ? '#cd7f32' : tier.name === 'Silver' ? '#c0c0c0' : tier.name === 'Gold' ? '#ffd700' : '#e5e4e2'}; color: #000;">${tier.name}</span></td>
<td style="font-weight: 600;">${(m.points || 0).toLocaleString()}</td>
<td>${(m.totalEarned || 0).toLocaleString()}</td>
<td>${new Date(m.joinedAt).toLocaleDateString()}</td>
<td>
<button class="btn-admin small" onclick="adjustLoyaltyPoints(${m.clientId})">Adjust</button>
<button class="btn-admin small danger" onclick="removeLoyaltyMember(${m.clientId})">Remove</button>
</td>
</tr>
                    `;}).join('')}
</tbody>
</table>
</div>
    `;
}

function toggleLoyaltyProgram(enabled) {
    loyaltyProgram.enabled = enabled;
    saveLoyalty();
    loadAdminLoyaltyPanel();
}

function updateLoyaltySetting(key, value) {
    loyaltyProgram[key] = value;
    saveLoyalty();
}

function enrollClientInLoyalty() {
    const availableClients = clients.filter(c => !loyaltyProgram.members.find(m => m.clientId === c.id));
    if (availableClients.length === 0) {
        alert('All clients are already enrolled!');
        return;
    }

    const clientList = availableClients.map(c => c.name + ' (' + c.email + ')').join('\n');
    const selection = prompt('Enter client name to enroll:\n\n' + clientList);
    if (!selection) return;

    const client = availableClients.find(c => c.name.toLowerCase().includes(selection.toLowerCase()));
    if (!client) {
        alert('Client not found.');
        return;
    }

    loyaltyProgram.members.push({
        clientId: client.id,
        name: client.name,
        email: client.email,
        points: 0,
        totalEarned: 0,
        totalRedeemed: 0,
        joinedAt: new Date().toISOString()
    });
    saveLoyalty();
    loadAdminLoyaltyPanel();
    alert(client.name + ' has been enrolled in the loyalty program!');
}

function adjustLoyaltyPoints(clientId) {
    const member = loyaltyProgram.members.find(m => m.clientId === clientId);
    if (!member) return;

    const adjustment = prompt('Enter points to add (use negative for deduction). Current balance: ' + member.points);
    if (!adjustment) return;

    const points = parseInt(adjustment);
    if (isNaN(points)) return;

    member.points += points;
    if (points > 0) member.totalEarned += points;
    else member.totalRedeemed += Math.abs(points);

    saveLoyalty();
    loadAdminLoyaltyPanel();
}

function removeLoyaltyMember(clientId) {
    if (!confirm('Remove this client from the loyalty program?')) return;
    loyaltyProgram.members = loyaltyProgram.members.filter(m => m.clientId !== clientId);
    saveLoyalty();
    loadAdminLoyaltyPanel();
}

// ==================== COMMUNICATIONS HUB PANEL ====================
function loadAdminCommunicationsPanel() {
    // Combine all messages from different channels
    const allMessages = [
        ...socialMediaDM.conversations.map(c => ({...c, channel: c.platform})),
        ...smsSystem.conversations.map(c => ({...c, channel: 'sms'})),
        ...(crmData.communications || []).map(c => ({...c, channel: 'email'}))
    ].sort((a, b) => new Date(b.lastMessageAt || b.createdAt) - new Date(a.lastMessageAt || a.createdAt));

    document.getElementById('adminCommunicationsPanel').innerHTML = `
<div class="panel-header">
<h2 class="panel-title">💬 Communications Hub</h2>
<p class="panel-subtitle">All your client communications in one place</p>
</div>

        <!-- Stats -->
<div class="stats-grid">
<div class="stat-card" style="border-left-color: #3b82f6;"><div class="stat-label">📧 Emails</div><div class="stat-value">${(crmData.communications || []).length}</div></div>
<div class="stat-card" style="border-left-color: #1877f2;"><div class="stat-label">📱 Facebook</div><div class="stat-value">${socialMediaDM.conversations.filter(c => c.platform === 'facebook').length}</div></div>
<div class="stat-card" style="border-left-color: #e4405f;"><div class="stat-label">📸 Instagram</div><div class="stat-value">${socialMediaDM.conversations.filter(c => c.platform === 'instagram').length}</div></div>
<div class="stat-card" style="border-left-color: #25d366;"><div class="stat-label">📲 SMS</div><div class="stat-value">${smsSystem.conversations.length}</div></div>
</div>

        <!-- Filters -->
<div style="display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; align-items: center;">
<input type="text" id="commSearch" placeholder="Search conversations..."
                oninput="filterCommunications()"
                style="flex: 1; min-width: 200px; padding: 12px 16px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; font-size: 14px; background: rgba(255,255,255,0.1); color: #fff;">
<select id="commChannelFilter" onchange="filterCommunications()" style="padding: 12px 16px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.1); color: #fff;">
<option value="all">All Channels</option>
<option value="email">📧 Email</option>
<option value="facebook">📱 Facebook</option>
<option value="instagram">📸 Instagram</option>
<option value="sms">📲 SMS</option>
</select>
<button class="btn-admin primary" onclick="composeNewMessage()">✉️ New Message</button>
</div>

        <!-- Unified Inbox -->
<div class="form-section">
<div class="form-section-title">📥 Unified Inbox</div>
<div id="unifiedInbox" style="max-height: 500px; overflow-y: auto;">
                ${allMessages.length === 0 ? '<p style="text-align: center; opacity: 0.5; padding: 40px;">No conversations yet. Connect your channels to get started!</p>' : ''}
                ${allMessages.slice(0, 50).map(msg => `
<div class="conversation-item" style="display: flex; gap: 16px; padding: 16px; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 8px; cursor: pointer;" onclick="openConversation('${msg.channel}', ${msg.id})">
<div style="width: 40px; height: 40px; border-radius: 50%; background: ${msg.channel === 'facebook' ? '#1877f2' : msg.channel === 'instagram' ? '#e4405f' : msg.channel === 'sms' ? '#25d366' : '#3b82f6'}; display: flex; align-items: center; justify-content: center;">
                            ${msg.channel === 'facebook' ? '📱' : msg.channel === 'instagram' ? '📸' : msg.channel === 'sms' ? '📲' : '📧'}
</div>
<div style="flex: 1;">
<div style="display: flex; justify-content: space-between;">
<strong>${msg.contactName || msg.name || msg.from || 'Unknown'}</strong>
<span style="font-size: 12px; opacity: 0.5;">${msg.lastMessageAt ? new Date(msg.lastMessageAt).toLocaleString() : ''}</span>
</div>
<p style="margin: 4px 0 0; font-size: 13px; opacity: 0.7; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${msg.lastMessage || msg.preview || 'No messages'}</p>
</div>
                        ${msg.unread ? '<div style="width: 10px; height: 10px; background: var(--red); border-radius: 50%;"></div>' : ''}
</div>
                `).join('')}
</div>
</div>

        <!-- Quick Connect -->
<div class="form-section">
<div class="form-section-title">🔗 Channel Connections</div>
<div class="card-grid">
<div class="client-card" onclick="showAdminPanel('socialdm')">
<div class="client-card-header" style="background: linear-gradient(135deg, #1877f2, #000);">📱</div>
<div class="client-card-body">
<div class="client-card-name">Facebook</div>
<div class="client-card-meta">${socialMediaDM.conversations.filter(c => c.platform === 'facebook').length} conversations</div>
</div>
</div>
<div class="client-card" onclick="showAdminPanel('socialdm')">
<div class="client-card-header" style="background: linear-gradient(135deg, #e4405f, #000);">📸</div>
<div class="client-card-body">
<div class="client-card-name">Instagram</div>
<div class="client-card-meta">${socialMediaDM.conversations.filter(c => c.platform === 'instagram').length} conversations</div>
</div>
</div>
<div class="client-card" onclick="showAdminPanel('sms')">
<div class="client-card-header" style="background: linear-gradient(135deg, #25d366, #000);">📲</div>
<div class="client-card-body">
<div class="client-card-name">OpenPhone SMS</div>
<div class="client-card-meta">${smsSystem.openPhone.connected ? '✅ Connected' : '❌ Not Connected'}</div>
</div>
</div>
</div>
</div>
    `;
}

function composeNewMessage() {
    const channel = prompt('Select channel (email, sms, facebook, instagram):');
    if (!channel) return;

    if (channel === 'sms') {
        showAdminPanel('sms');
    } else if (channel === 'facebook' || channel === 'instagram') {
        showAdminPanel('socialdm');
    } else {
        alert('Compose email feature - In production, this would open your email client.');
    }
}

function filterCommunications() {
    const search = document.getElementById('commSearch')?.value?.toLowerCase() || '';
    const channel = document.getElementById('commChannelFilter')?.value || 'all';
    const inbox = document.getElementById('unifiedInbox');
    if (!inbox) return;

    const items = inbox.querySelectorAll('.conversation-item');
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        const matchesSearch = !search || text.includes(search);
        const matchesChannel = channel === 'all' || item.innerHTML.includes(channel);
        item.style.display = (matchesSearch && matchesChannel) ? 'flex' : 'none';
    });
}

function openConversation(channel, id) {
    if (channel === 'sms') {
        showAdminPanel('sms');
    } else if (channel === 'facebook' || channel === 'instagram') {
        showAdminPanel('socialdm');
    } else if (channel === 'email') {
        showAdminPanel('emailmarketing');
    }
}

// ==================== SOCIAL DM PANEL ====================
function loadAdminSocialDmPanel() {
    const sm = socialMediaDM;
    const contactsWithHandles = clients.filter(c => c.socialHandles && (c.socialHandles.instagram || c.socialHandles.facebook || c.socialHandles.twitter)).length;
    const todayDate = new Date().toDateString();
    const todayDrafts = sm.conversations.filter(c => new Date(c.timestamp).toDateString() === todayDate).length;

    document.getElementById('adminSocialdmPanel').innerHTML = `
<div class="panel-header">
<h2 class="panel-title">💬 Social Media Quick Links</h2>
<p class="panel-subtitle">Send DMs directly to clients without API - store handles, draft messages, click to open</p>
</div>

        <!-- Stats Row -->
<div class="stats-grid">
<div class="stat-card">
<div class="stat-label">Contacts with Handles</div>
<div class="stat-value">${contactsWithHandles}</div>
</div>
<div class="stat-card">
<div class="stat-label">Messages Logged Today</div>
<div class="stat-value">${todayDrafts}</div>
</div>
<div class="stat-card">
<div class="stat-label">Total Conversations</div>
<div class="stat-value">${sm.conversations.length}</div>
</div>
</div>

        <!-- Quick Send Section -->
<div class="form-section">
<div class="form-section-title">✉️ Quick Send DM</div>

<div class="form-row">
<div class="form-group" style="flex: 1;">
<label class="form-label">Select Client</label>
<select id="dmClientSelect" class="form-select" onchange="selectDmClient(this.value)">
<option value="">-- Choose a client --</option>
                        ${clients.map(c => '<option value="' + c.id + '">' + c.name + '</option>').join('')}
</select>
</div>
<div class="form-group" style="flex: 1;">
<label class="form-label">Platform</label>
<div style="display: flex; gap: 8px; margin-top: 8px;">
<button class="platform-btn" id="platformInstagram" onclick="setDmPlatform('instagram')" style="background: rgba(228, 64, 95, 0.2); color: #e4405f; border: 1px solid #e4405f;">📷 Instagram</button>
<button class="platform-btn" id="platformFacebook" onclick="setDmPlatform('facebook')" style="background: rgba(24, 119, 242, 0.2); color: #1877f2; border: 1px solid #1877f2;">f Facebook</button>
<button class="platform-btn" id="platformTwitter" onclick="setDmPlatform('twitter')" style="background: rgba(29, 161, 242, 0.2); color: #1da1f2; border: 1px solid #1da1f2;">𝕏 Twitter</button>
</div>
</div>
</div>

<div class="form-row">
<div class="form-group" style="flex: 1;">
<label class="form-label">Handle (@username)</label>
<input type="text" id="dmHandle" class="form-input" placeholder="e.g., @username or facebook_page_name" oninput="validateDmHandle()">
</div>
</div>

<div class="form-group">
<label class="form-label">Message <span style="opacity: 0.5;" id="dmCharCount">(0 chars)</span></label>
<textarea id="dmMessage" class="form-textarea" rows="4" placeholder="Compose your message..." oninput="updateDmCharCount()"></textarea>
</div>

<div style="display: flex; gap: 8px; margin-bottom: 16px;">
<button class="btn-template" onclick="fillDmTemplate('follow_up')" style="background: rgba(255,255,255,0.1); color: #fff; padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px;">📌 Follow Up</button>
<button class="btn-template" onclick="fillDmTemplate('update')" style="background: rgba(255,255,255,0.1); color: #fff; padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px;">📊 Project Update</button>
<button class="btn-template" onclick="fillDmTemplate('payment')" style="background: rgba(255,255,255,0.1); color: #fff; padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px;">💳 Payment Reminder</button>
<button class="btn-template" onclick="fillDmTemplate('thanks')" style="background: rgba(255,255,255,0.1); color: #fff; padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px;">🙏 Thank You</button>
</div>

<div style="display: flex; gap: 8px;">
<button class="btn-admin primary" onclick="openSocialDm()" style="flex: 1;">🔗 Open DM in Browser</button>
<button class="btn-admin" onclick="copyDmMessage()" style="flex: 1; background: rgba(255,255,255,0.1); color: #fff;">📋 Copy Message</button>
<button class="btn-admin" onclick="logDmConversation()" style="flex: 1; background: rgba(46,204,113,0.2); color: #2ecc71;">💾 Log Conversation</button>
</div>
</div>

        <!-- Client Handles Directory -->
<div class="form-section">
<div class="form-section-title">📋 Client Handles Directory</div>
<div style="overflow-x: auto;">
<table class="data-table" style="width: 100%; min-width: 600px;">
<thead>
<tr>
<th>Client Name</th>
<th style="text-align: center;">📷 Instagram</th>
<th style="text-align: center;">f Facebook</th>
<th style="text-align: center;">𝕏 Twitter</th>
<th>Action</th>
</tr>
</thead>
<tbody>
                        ${clients.length === 0 ? '<tr><td colspan="5" style="text-align: center; opacity: 0.5;">No clients yet</td></tr>' : clients.map(c => `
<tr>
<td><strong>${c.name}</strong></td>
<td style="text-align: center;">${c.socialHandles?.instagram ? '@' + c.socialHandles.instagram : '-'}</td>
<td style="text-align: center;">${c.socialHandles?.facebook ? c.socialHandles.facebook : '-'}</td>
<td style="text-align: center;">${c.socialHandles?.twitter ? '@' + c.socialHandles.twitter : '-'}</td>
<td><button class="btn-admin small primary" onclick="editClientHandles('${c.id}')">Edit Handles</button></td>
</tr>
                        `).join('')}
</tbody>
</table>
</div>
</div>

        <!-- Conversation Log -->
<div class="form-section">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
<div class="form-section-title" style="margin: 0;">📥 Conversation Log (${sm.conversations.length})</div>
<button class="btn-admin small" onclick="exportDmLog()" style="background: rgba(255,255,255,0.1); color: #fff;">📊 Export CSV</button>
</div>
<div style="margin-bottom: 12px;">
<input type="text" id="dmLogSearch" class="form-input" placeholder="🔍 Search conversations..." oninput="searchDmLog(this.value)">
</div>
<div id="dmLogContainer" style="max-height: 500px; overflow-y: auto;">
                ${sm.conversations.length === 0 ? '<p style="text-align: center; opacity: 0.5; padding: 32px;">No conversations logged yet. Send and log messages to build history.</p>' : sm.conversations.map((conv, idx) => `
<div style="display: flex; gap: 12px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 6px; margin-bottom: 8px; border-left: 3px solid ${conv.platform === 'facebook' ? '#1877f2' : conv.platform === 'instagram' ? '#e4405f' : '#1da1f2'};">
<div style="flex: 1;">
<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 4px;">
<div>
<span style="font-weight: bold;">${conv.clientName}</span>
<span style="opacity: 0.5; margin-left: 8px; font-size: 12px;">@${conv.handle}</span>
<span style="opacity: 0.5; margin-left: 8px; font-size: 11px;">${conv.platform === 'facebook' ? 'f' : conv.platform === 'instagram' ? '📷' : '𝕏'}</span>
</div>
<span style="font-size: 11px; opacity: 0.5;">${new Date(conv.timestamp).toLocaleString()}</span>
</div>
<p style="margin: 0; font-size: 13px; opacity: 0.8; line-height: 1.4;">${(conv.message || '').substring(0, 150)}${(conv.message || '').length > 150 ? '...' : ''}</p>
</div>
<button class="btn-admin small danger" onclick="deleteDmConversation(${idx})" style="padding: 4px 8px; height: fit-content;">✕</button>
</div>
                `).join('')}
</div>
</div>

        <!-- Auto-Response Templates -->
<div class="form-section">
<div class="form-section-title">🤖 Auto-Response Settings</div>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
<p style="color: rgba(255,255,255,0.6); margin: 0;">Automatically respond to common inquiries across platforms</p>
<label class="switch">
<input type="checkbox" ${sm.settings.autoReplyEnabled ? 'checked' : ''} onchange="toggleSocialAutoReply(this.checked)">
<span class="slider round"></span>
</label>
</div>
<div style="margin-bottom: 16px;">
<button class="btn-admin primary" onclick="addSocialAutoResponse()">+ Add Auto-Response</button>
</div>
<table class="data-table">
<thead><tr><th>Trigger</th><th>Platform</th><th>Response</th><th>Actions</th></tr></thead>
<tbody>
                    ${sm.autoResponses.map((ar, i) => `
<tr>
<td><span class="tag">${ar.trigger}</span></td>
<td>${ar.platform}</td>
<td style="max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${ar.message}</td>
<td>
<button class="btn-admin small danger" onclick="deleteSocialAutoResponse(${i})">Delete</button>
</td>
</tr>
                    `).join('')}
</tbody>
</table>
</div>
    `;
}

// ==================== SOCIAL DM HELPER FUNCTIONS ====================

let currentDmPlatform = 'instagram';

function selectDmClient(clientId) {
    if (!clientId) {
        document.getElementById('dmHandle').value = '';
        return;
    }
    const client = clients.find(c => c.id === clientId);
    if (!client) return;

    const handles = client.socialHandles || {};
    const handle = handles[currentDmPlatform] || '';
    document.getElementById('dmHandle').value = handle ? '@' + handle.replace('@', '') : '';
}

function setDmPlatform(platform) {
    currentDmPlatform = platform;

    // Update button styles
    document.getElementById('platformInstagram').style.background = platform === 'instagram' ? 'rgba(228, 64, 95, 0.4)' : 'rgba(228, 64, 95, 0.2)';
    document.getElementById('platformInstagram').style.fontWeight = platform === 'instagram' ? '600' : '400';

    document.getElementById('platformFacebook').style.background = platform === 'facebook' ? 'rgba(24, 119, 242, 0.4)' : 'rgba(24, 119, 242, 0.2)';
    document.getElementById('platformFacebook').style.fontWeight = platform === 'facebook' ? '600' : '400';

    document.getElementById('platformTwitter').style.background = platform === 'twitter' ? 'rgba(29, 161, 242, 0.4)' : 'rgba(29, 161, 242, 0.2)';
    document.getElementById('platformTwitter').style.fontWeight = platform === 'twitter' ? '600' : '400';

    // Re-populate handle from client if one is selected
    const clientSelect = document.getElementById('dmClientSelect');
    if (clientSelect && clientSelect.value) {
        selectDmClient(clientSelect.value);
    }
}

function fillDmTemplate(type) {
    let template = '';
    const clientSelect = document.getElementById('dmClientSelect');
    const clientId = clientSelect ? clientSelect.value : '';
    const clientName = clientId ? (clients.find(c => c.id === clientId)?.name || 'Client') : 'Client';

    switch(type) {
        case 'follow_up':
            template = `Hi ${clientName},\n\nJust following up on our previous conversation. Let me know if you have any questions!\n\nBest regards,\nNew Urban Influence`;
            break;
        case 'update':
            template = `Hi ${clientName},\n\nYour project is progressing well! Check your email for the latest proof/update.\n\nLooking forward to your feedback!\n\nBest regards,\nNew Urban Influence`;
            break;
        case 'payment':
            template = `Hi ${clientName},\n\nFriendly reminder that your invoice is due soon. Let me know if you have any questions!\n\nThanks!`;
            break;
        case 'thanks':
            template = `Hi ${clientName},\n\nThank you for working with us! We really appreciate the opportunity.\n\nBest regards,\nNew Urban Influence`;
            break;
    }

    document.getElementById('dmMessage').value = template;
    updateDmCharCount();
}

function updateDmCharCount() {
    const msg = document.getElementById('dmMessage').value;
    document.getElementById('dmCharCount').textContent = '(' + msg.length + ' chars)';
}

function validateDmHandle() {
    let handle = document.getElementById('dmHandle').value;
    if (currentDmPlatform === 'twitter' || currentDmPlatform === 'instagram') {
        handle = handle.replace('@', '').trim();
    }
    document.getElementById('dmHandle').value = handle;
}

function openSocialDm() {
    const platform = currentDmPlatform;
    const handle = document.getElementById('dmHandle').value.replace('@', '').trim();
    const message = document.getElementById('dmMessage').value;

    if (!handle) {
        alert('Please enter a handle');
        return;
    }

    let url = '';
    let encodedMsg = encodeURIComponent(message);

    switch(platform) {
        case 'instagram':
            url = 'https://ig.me/m/' + handle;
            break;
        case 'facebook':
            url = 'https://m.me/' + handle;
            break;
        case 'twitter':
            url = 'https://twitter.com/' + handle;
            break;
        default:
            alert('Invalid platform');
            return;
    }

    window.open(url, '_blank');
}

function copyDmMessage() {
    const message = document.getElementById('dmMessage').value;
    if (!message) {
        alert('Message is empty');
        return;
    }
    navigator.clipboard.writeText(message).then(() => {
        alert('Message copied to clipboard!');
    }).catch(() => {
        alert('Failed to copy message');
    });
}

function logDmConversation() {
    const clientSelect = document.getElementById('dmClientSelect');
    if (!clientSelect.value) {
        alert('Please select a client');
        return;
    }

    const clientId = clientSelect.value;
    const client = clients.find(c => c.id === clientId);
    const handle = document.getElementById('dmHandle').value.replace('@', '').trim();
    const message = document.getElementById('dmMessage').value;

    if (!handle || !message) {
        alert('Please fill in handle and message');
        return;
    }

    const conversation = {
        clientName: client.name,
        clientId: clientId,
        platform: currentDmPlatform,
        handle: handle,
        message: message,
        timestamp: new Date().toISOString()
    };

    socialMediaDM.conversations.unshift(conversation);
    saveSocialDM();

    // Log to CRM if available
    if (typeof logProofActivity === 'function') {
        logProofActivity(clientId, 'social_dm', `Sent DM to @${handle} on ${currentDmPlatform}: ${message.substring(0, 100)}`);
    }

    // Clear form
    document.getElementById('dmMessage').value = '';
    document.getElementById('dmHandle').value = '';
    updateDmCharCount();

    loadAdminSocialDmPanel();
    alert('Conversation logged!');
}

function deleteDmConversation(index) {
    if (!confirm('Delete this conversation from log?')) return;
    socialMediaDM.conversations.splice(index, 1);
    saveSocialDM();
    loadAdminSocialDmPanel();
}

function searchDmLog(query) {
    const logContainer = document.getElementById('dmLogContainer');
    if (!logContainer) return;

    const items = logContainer.querySelectorAll('[style*="border-left"]');
    const lowerQuery = query.toLowerCase();

    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(lowerQuery) ? '' : 'none';
    });
}

function exportDmLog() {
    if (socialMediaDM.conversations.length === 0) {
        alert('No conversations to export');
        return;
    }

    let csv = 'Client,Handle,Platform,Message,Date\n';
    socialMediaDM.conversations.forEach(conv => {
        const date = new Date(conv.timestamp).toLocaleString();
        const msg = '"' + (conv.message || '').replace(/"/g, '""') + '"';
        csv += `"${conv.clientName}","@${conv.handle}","${conv.platform}",${msg},"${date}"\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'social_dm_log_' + new Date().getTime() + '.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

function editClientHandles(clientId) {
    const client = clients.find(c => c.id === clientId);
    if (!client) return;

    const current = client.socialHandles || {};
    const instagram = prompt('Instagram handle (without @):', current.instagram || '');
    if (instagram === null) return;

    const facebook = prompt('Facebook handle/page name:', current.facebook || '');
    if (facebook === null) return;

    const twitter = prompt('Twitter/X handle (without @):', current.twitter || '');
    if (twitter === null) return;

    client.socialHandles = {
        instagram: instagram.replace('@', '').trim(),
        facebook: facebook.trim(),
        twitter: twitter.replace('@', '').trim()
    };

    saveClients();
    loadAdminSocialDmPanel();
    alert('Handles saved for ' + client.name);
}

function toggleSocialAutoReply(enabled) {
    socialMediaDM.settings.autoReplyEnabled = enabled;
    saveSocialDM();
}

function addSocialAutoResponse() {
    const trigger = prompt('Enter trigger word (e.g., "pricing", "hello", "hours"):');
    if (!trigger) return;

    const message = prompt('Enter auto-response message:');
    if (!message) return;

    socialMediaDM.autoResponses.push({
        id: Date.now(),
        trigger: trigger.toLowerCase(),
        platform: 'all',
        message: message
    });
    saveSocialDM();
    loadAdminSocialDmPanel();
}

function deleteSocialAutoResponse(index) {
    if (!confirm('Delete this auto-response?')) return;
    socialMediaDM.autoResponses.splice(index, 1);
    saveSocialDM();
    loadAdminSocialDmPanel();
}

// ==================== SMS / OPENPHONE PANEL ====================
function loadAdminSmsPanel() {
    const sms = smsSystem;
    document.getElementById('adminSmsPanel').innerHTML = `
<div class="panel-header">
<h2 class="panel-title">📲 SMS Communications</h2>
<p class="panel-subtitle">Manage SMS through OpenPhone integration</p>
</div>

        <!-- OpenPhone Connection -->
<div class="form-section" style="background: ${sms.openPhone.connected ? 'rgba(46,204,113,0.1)' : 'rgba(255,59,48,0.1)'}; border: 1px solid ${sms.openPhone.connected ? '#2ecc71' : '#ff3b30'};">
<div style="display: flex; justify-content: space-between; align-items: center;">
<div>
<div class="form-section-title" style="margin: 0;">📱 OpenPhone Connection</div>
<p style="color: rgba(255,255,255,0.5); font-size: 13px; margin: 8px 0 0;">
                        ${sms.openPhone.connected ? 'Connected: ' + sms.openPhone.phoneNumber : 'Connect your OpenPhone account to send/receive SMS'}
</p>
</div>
<button class="btn-admin ${sms.openPhone.connected ? 'danger' : 'primary'}" onclick="${sms.openPhone.connected ? 'disconnectOpenPhone()' : 'connectOpenPhone()'}">
                    ${sms.openPhone.connected ? 'Disconnect' : 'Connect OpenPhone'}
</button>
</div>
</div>

        <!-- API Configuration -->
        ${!sms.openPhone.connected ? `
<div class="form-section">
<div class="form-section-title">🔑 OpenPhone API Configuration</div>
<div class="form-group">
<label class="form-label">API Key</label>
<input type="password" id="openPhoneApiKey" class="form-input" placeholder="Enter your OpenPhone API key">
</div>
<div class="form-group">
<label class="form-label">Phone Number</label>
<input type="tel" id="openPhoneNumber" class="form-input" placeholder="+1 (313) 555-0123">
</div>
<button class="btn-admin primary" onclick="saveOpenPhoneConfig()">Save & Connect</button>
<p style="font-size: 12px; opacity: 0.5; margin-top: 12px;">
                Get your API key from <a href="https://app.openphone.com/settings/api" target="_blank" style="color: var(--red);">OpenPhone Settings → API</a>
</p>
</div>
        ` : ''}

        <!-- Auto-Response Settings -->
<div class="form-section">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
<div class="form-section-title" style="margin: 0;">🤖 Auto-Response Settings</div>
<label class="switch">
<input type="checkbox" ${sms.settings.autoReplyEnabled ? 'checked' : ''} onchange="toggleSmsAutoReply(this.checked)">
<span class="slider round"></span>
</label>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Business Hours Only</label>
<select class="form-select" onchange="updateSmsSetting('businessHoursOnly', this.value === 'true')">
<option value="true" ${sms.settings.businessHoursOnly ? 'selected' : ''}>Yes</option>
<option value="false" ${!sms.settings.businessHoursOnly ? 'selected' : ''}>No (24/7)</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Start Time</label>
<input type="time" class="form-input" value="${sms.settings.businessHours.start}" onchange="updateSmsBusinessHours('start', this.value)">
</div>
<div class="form-group">
<label class="form-label">End Time</label>
<input type="time" class="form-input" value="${sms.settings.businessHours.end}" onchange="updateSmsBusinessHours('end', this.value)">
</div>
</div>
</div>

        <!-- SMS Templates -->
<div class="form-section">
<div class="form-section-title">📝 SMS Templates</div>
<div style="margin-bottom: 16px;">
<button class="btn-admin primary" onclick="addSmsTemplate()">+ Add Template</button>
</div>
<div class="card-grid">
                ${sms.templates.map(t => `
<div class="client-card">
<div class="client-card-header" style="background: linear-gradient(135deg, #25d366, #000);">📲</div>
<div class="client-card-body">
<div class="client-card-name">${t.name}</div>
<div class="client-card-meta" style="font-size: 12px; height: 40px; overflow: hidden;">${t.message}</div>
<div class="client-card-btns">
<button onclick="useSmsTemplate(${t.id})" style="background: var(--red); color: #fff;">Use</button>
<button onclick="editSmsTemplate(${t.id})" style="background: rgba(255,255,255,0.1); color: #fff;">Edit</button>
</div>
</div>
</div>
                `).join('')}
</div>
</div>

        <!-- Send SMS -->
<div class="form-section">
<div class="form-section-title">✉️ Send SMS</div>
<div class="form-row">
<div class="form-group" style="flex: 1;">
<label class="form-label">To (Phone Number)</label>
<input type="tel" id="smsTo" class="form-input" placeholder="+1 (313) 555-0123">
</div>
<div class="form-group" style="flex: 1;">
<label class="form-label">Select Client</label>
<select id="smsClientSelect" class="form-select" onchange="populateSmsPhone(this.value)">
<option value="">-- Or select client --</option>
                        ${clients.filter(c => c.phone).map(c => '<option value="' + c.phone + '">' + c.name + ' - ' + c.phone + '</option>').join('')}
</select>
</div>
</div>
<div class="form-group">
<label class="form-label">Message (<span id="smsCharCount">0</span>/160)</label>
<textarea id="smsMessage" class="form-textarea" rows="3" placeholder="Type your message..." oninput="updateSmsCharCount()"></textarea>
</div>
<button class="btn-admin primary" onclick="sendSms()">📤 Send SMS</button>
</div>

        <!-- Conversations -->
<div class="form-section">
<div class="form-section-title">💬 SMS Conversations (${sms.conversations.length})</div>
<div style="max-height: 400px; overflow-y: auto;">
                ${sms.conversations.length === 0 ? '<p style="text-align: center; opacity: 0.5; padding: 40px;">No SMS conversations yet.</p>' : ''}
                ${sms.conversations.map(conv => `
<div style="display: flex; gap: 12px; padding: 16px; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 8px;">
<div style="width: 48px; height: 48px; border-radius: 50%; background: #25d366; display: flex; align-items: center; justify-content: center; font-size: 20px;">📲</div>
<div style="flex: 1;">
<div style="display: flex; justify-content: space-between;">
<strong>${conv.contactName || conv.phone}</strong>
<span style="font-size: 12px; opacity: 0.5;">${new Date(conv.lastMessageAt).toLocaleString()}</span>
</div>
<p style="margin: 4px 0; font-size: 13px; opacity: 0.7;">${conv.phone}</p>
<p style="margin: 4px 0 8px; font-size: 14px;">${conv.lastMessage}</p>
<button class="btn-admin small primary" onclick="openSmsConversation('${conv.phone}')">Reply</button>
</div>
</div>
                `).join('')}
</div>
</div>

        <!-- Test -->
<div class="form-section">
<div class="form-section-title">🧪 Test</div>
<button class="btn-admin secondary" onclick="simulateIncomingSms()">Simulate Incoming SMS</button>
</div>
    `;
}

function connectOpenPhone() {
    document.getElementById('openPhoneApiKey')?.focus();
}

function saveOpenPhoneConfig() {
    const apiKey = document.getElementById('openPhoneApiKey').value;
    const phoneNumber = document.getElementById('openPhoneNumber').value;

    if (!apiKey || !phoneNumber) {
        alert('Please enter both API key and phone number.');
        return;
    }

    smsSystem.openPhone = {
        connected: true,
        apiKey: apiKey,
        phoneNumber: phoneNumber,
        userId: 'user_' + Date.now()
    };
    saveSms();
    loadAdminSmsPanel();
    alert('OpenPhone connected successfully!');
}

function disconnectOpenPhone() {
    if (!confirm('Disconnect OpenPhone?')) return;
    smsSystem.openPhone = { connected: false, apiKey: '', phoneNumber: '', userId: '' };
    saveSms();
    loadAdminSmsPanel();
}

function toggleSmsAutoReply(enabled) {
    smsSystem.settings.autoReplyEnabled = enabled;
    saveSms();
}

function updateSmsSetting(key, value) {
    smsSystem.settings[key] = value;
    saveSms();
}

function updateSmsBusinessHours(key, value) {
    smsSystem.settings.businessHours[key] = value;
    saveSms();
}

function populateSmsPhone(phone) {
    if (phone) document.getElementById('smsTo').value = phone;
}

function updateSmsCharCount() {
    const msg = document.getElementById('smsMessage').value;
    document.getElementById('smsCharCount').textContent = msg.length;
}

async function sendSms() {
    const to = document.getElementById('smsTo').value;
    const message = document.getElementById('smsMessage').value;

    if (!to || !message) {
        alert('Please enter phone number and message.');
        return;
    }

    if (!smsSystem.openPhone.connected) {
        alert('Please connect OpenPhone first.');
        return;
    }

    // Show sending state
    const sendBtn = document.querySelector('[onclick="sendSms()"]');
    if (sendBtn) { sendBtn.textContent = '⏳ Sending...'; sendBtn.disabled = true; }

    let apiSuccess = false;
    try {
        const res = await fetch('/.netlify/functions/send-sms', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ to, message })
        });
        const result = await res.json();
        apiSuccess = res.ok && result.success;
        if (!apiSuccess) {
            console.warn('SMS API error:', result.error || res.status);
        }
    } catch (err) {
        console.warn('SMS send failed:', err.message);
    }

    // Add to local conversations for immediate display
    let conv = smsSystem.conversations.find(c => c.phone === to);
    if (!conv) {
        conv = {
            id: Date.now(),
            phone: to,
            contactName: clients.find(c => c.phone === to)?.name || '',
            messages: [],
            lastMessage: '',
            lastMessageAt: ''
        };
        smsSystem.conversations.push(conv);
    }

    conv.messages.push({ direction: 'outbound', content: message, timestamp: new Date().toISOString(), sentViaApi: apiSuccess });
    conv.lastMessage = message;
    conv.lastMessageAt = new Date().toISOString();

    saveSms();
    document.getElementById('smsMessage').value = '';
    updateSmsCharCount();
    loadAdminSmsPanel();

    if (sendBtn) { sendBtn.textContent = '📤 Send SMS'; sendBtn.disabled = false; }
    alert(apiSuccess ? '✅ SMS sent to ' + to + '!' : '⚠️ SMS saved locally but delivery failed. Check your OpenPhone API key in Netlify env vars (OPENPHONE_API_KEY, OPENPHONE_PHONE_NUMBER).');
}

// Dev/test helper — simulates an incoming SMS for testing the UI
// In production, real incoming SMS arrives via OpenPhone webhook → Supabase → realtime
function simulateIncomingSms() {
    const phones = ['+1 (313) 555-0101', '+1 (313) 555-0202', '+1 (313) 555-0303'];
    const names = ['John Doe', 'Jane Smith', 'Bob Wilson'];
    const messages = [
        'Hi! I received your email. When can we chat?',
        'Thanks for the quote! I have a few questions.',
        'Is the project still on track for next week?',
        'Got it, thanks!'
    ];

    const phone = phones[Math.floor(Math.random() * phones.length)];
    const name = names[Math.floor(Math.random() * names.length)];
    const message = messages[Math.floor(Math.random() * messages.length)];

    let conv = smsSystem.conversations.find(c => c.phone === phone);
    if (!conv) {
        conv = { id: Date.now(), phone: phone, contactName: name, messages: [], lastMessage: '', lastMessageAt: '' };
        smsSystem.conversations.push(conv);
    }

    conv.messages.push({ direction: 'inbound', content: message, timestamp: new Date().toISOString() });
    conv.lastMessage = message;
    conv.lastMessageAt = new Date().toISOString();

    saveSms();
    loadAdminSmsPanel();
    showNotification('Test SMS received from ' + name, 'info');
}

function addSmsTemplate() {
    const name = prompt('Template name:');
    if (!name) return;

    const message = prompt('Message (use {name}, {invoice}, {time} for placeholders):');
    if (!message) return;

    smsSystem.templates.push({ id: Date.now(), name: name, message: message });
    saveSms();
    loadAdminSmsPanel();
}

function useSmsTemplate(id) {
    const template = smsSystem.templates.find(t => t.id === id);
    if (template) {
        document.getElementById('smsMessage').value = template.message;
        updateSmsCharCount();
    }
}

function openSmsConversation(phone) {
    // Populate the phone number field
    document.getElementById('smsTo').value = phone;
    document.getElementById('smsTo').focus();

    // Find conversation and show messages
    const conv = smsSystem.conversations.find(c => c.phone === phone);
    if (conv && conv.messages && conv.messages.length > 0) {
        const messagesHtml = conv.messages.slice(-10).map(m => `
<div style="display: flex; justify-content: ${m.direction === 'outbound' ? 'flex-end' : 'flex-start'}; margin-bottom: 8px;">
<div style="max-width: 70%; padding: 10px 14px; border-radius: 12px; background: ${m.direction === 'outbound' ? 'var(--red)' : 'rgba(255,255,255,0.1)'}; color: #fff;">
<p style="margin: 0; font-size: 14px;">${m.content}</p>
<span style="font-size: 10px; opacity: 0.6;">${new Date(m.timestamp).toLocaleString()}</span>
</div>
</div>
        `).join('');

        alert(`Conversation with ${conv.contactName || phone}:\n\n${conv.messages.slice(-5).map(m => `${m.direction === 'outbound' ? 'You' : 'Them'}: ${m.content}`).join('\n')}`);
    }

    // Scroll to send section
    document.getElementById('smsMessage').focus();
}

// ==================== SITE IMAGES PANEL ====================
function loadAdminSiteImagesPanel() {
    document.getElementById('adminSiteimagesPanel').innerHTML = `
<div class="panel-header">
<h2 class="panel-title">🖼️ Site Images & Branding</h2>
<p class="panel-subtitle">Manage logos, taglines, and images across the entire website</p>
</div>

        <!-- CMS LOGO MANAGEMENT SECTION -->
<div class="form-section" style="background: linear-gradient(135deg, rgba(255,0,0,0.1), rgba(255,107,107,0.05)); border: 1px solid rgba(255,0,0,0.2); border-radius: 12px; padding: 24px; margin-bottom: 32px;">
<div class="form-section-title" style="color: var(--red);">🎨 Brand Identity (CMS)</div>
<p style="color: var(--admin-text-muted); font-size: 13px; margin-bottom: 20px;">These logos and taglines appear across the entire website header and footer.</p>

<div class="card-grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px;">
                <!-- Header Logo -->
<div class="image-upload-card" style="background: var(--admin-card); border-radius: 12px; overflow: hidden;">
<div class="image-upload-preview" style="height: 120px; background: var(--admin-bg-secondary);">
                        ${siteImages.headerLogo?.url ? `<img loading="lazy" src="${siteImages.headerLogo.url}" alt="Header Logo" style="max-height: 80px; object-fit: contain;">` : '<span class="placeholder" style="font-size: 48px;">🏷️</span>'}
<div class="image-upload-overlay">
<button class="btn-admin primary" onclick="document.getElementById('headerLogoUpload').click()">Upload</button>
                            ${siteImages.headerLogo?.url ? `<button class="btn-admin danger" onclick="clearSiteImage('headerLogo')">Remove</button>` : ''}
</div>
</div>
<input type="file" id="headerLogoUpload" accept="image/*" style="display: none;" onchange="uploadSiteImage('headerLogo', this)">
<div class="image-upload-info" style="padding: 16px;">
<span class="image-upload-label" style="font-weight: 600; color: var(--admin-text);">Header Logo</span>
<span class="image-upload-hint" style="color: var(--admin-text-muted);">300x80px recommended (PNG/SVG)</span>
</div>
</div>

                <!-- Footer Logo -->
<div class="image-upload-card" style="background: var(--admin-card); border-radius: 12px; overflow: hidden;">
<div class="image-upload-preview" style="height: 120px; background: var(--admin-bg-secondary);">
                        ${siteImages.footerLogo?.url ? `<img loading="lazy" src="${siteImages.footerLogo.url}" alt="Footer Logo" style="max-height: 80px; object-fit: contain;">` : '<span class="placeholder" style="font-size: 48px;">🏷️</span>'}
<div class="image-upload-overlay">
<button class="btn-admin primary" onclick="document.getElementById('footerLogoUpload').click()">Upload</button>
                            ${siteImages.footerLogo?.url ? `<button class="btn-admin danger" onclick="clearSiteImage('footerLogo')">Remove</button>` : ''}
</div>
</div>
<input type="file" id="footerLogoUpload" accept="image/*" style="display: none;" onchange="uploadSiteImage('footerLogo', this)">
<div class="image-upload-info" style="padding: 16px;">
<span class="image-upload-label" style="font-weight: 600; color: var(--admin-text);">Footer Logo</span>
<span class="image-upload-hint" style="color: var(--admin-text-muted);">300x80px recommended (PNG/SVG)</span>
</div>
</div>
</div>

            <!-- Taglines -->
<div style="margin-top: 24px; display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
<div>
<label style="display: block; font-weight: 600; color: var(--admin-text); margin-bottom: 8px;">Site Tagline</label>
<input type="text" id="siteTagline" value="${siteImages.tagline || ''}"
                        placeholder="e.g., BUILD YOUR INFLUENCE"
                        style="width: 100%; padding: 12px 16px; border: 1px solid var(--admin-border); border-radius: 8px; font-size: 14px; background: var(--admin-input-bg); color: var(--admin-text);"
                        onchange="siteImages.tagline = this.value; saveSiteImages();">
<span style="font-size: 12px; color: var(--admin-text-muted);">Appears in navigation and footer</span>
</div>
<div>
<label style="display: block; font-weight: 600; color: var(--admin-text); margin-bottom: 8px;">Hero Tagline</label>
<input type="text" id="heroTagline" value="${siteImages.heroTagline || ''}"
                        placeholder="e.g., UNAPOLOGETICALLY DETROIT"
                        style="width: 100%; padding: 12px 16px; border: 1px solid var(--admin-border); border-radius: 8px; font-size: 14px; background: var(--admin-input-bg); color: var(--admin-text);"
                        onchange="siteImages.heroTagline = this.value; saveSiteImages();">
<span style="font-size: 12px; color: var(--admin-text-muted);">Appears on homepage hero section</span>
</div>
</div>
</div>

<div class="form-section">
<div class="form-section-title">🏠 Homepage Images</div>
<div class="card-grid">
<div class="image-upload-card">
<div class="image-upload-preview">
                        ${siteImages.hero?.url ? `<img loading="lazy" src="${siteImages.hero.url}" alt="Hero">` : '<span class="placeholder">🖼️</span>'}
<div class="image-upload-overlay">
<button class="btn-admin primary" onclick="document.getElementById('heroImageUpload').click()">Upload</button>
                            ${siteImages.hero?.url ? `<button class="btn-admin danger" onclick="clearSiteImage('hero')">Remove</button>` : ''}
</div>
</div>
<input type="file" id="heroImageUpload" accept="image/*" style="display: none;" onchange="uploadSiteImage('hero', this)">
<div class="image-upload-info"><span class="image-upload-label">Hero Background</span><span class="image-upload-hint">1920x1080 recommended</span></div>
</div>
<div class="image-upload-card">
<div class="image-upload-preview">
                        ${siteImages.about?.url ? `<img loading="lazy" src="${siteImages.about.url}" alt="About">` : '<span class="placeholder">🖼️</span>'}
<div class="image-upload-overlay">
<button class="btn-admin primary" onclick="document.getElementById('aboutImageUpload').click()">Upload</button>
                            ${siteImages.about?.url ? `<button class="btn-admin danger" onclick="clearSiteImage('about')">Remove</button>` : ''}
</div>
</div>
<input type="file" id="aboutImageUpload" accept="image/*" style="display: none;" onchange="uploadSiteImage('about', this)">
<div class="image-upload-info"><span class="image-upload-label">About Section</span><span class="image-upload-hint">1200x800 recommended</span></div>
</div>
</div>
</div>
<div class="form-section">
<div class="form-section-title">📦 Service Package Images</div>
<div class="card-grid">
                ${siteImages.services.map(service => `
<div class="image-upload-card">
<div class="image-upload-preview">
                            ${service.url ? `<img loading="lazy" src="${service.url}" alt="${service.alt}">` : '<span class="placeholder">🖼️</span>'}
<div class="image-upload-overlay">
<button class="btn-admin primary" onclick="document.getElementById('service_${service.id}').click()">Upload</button>
</div>
</div>
<input type="file" id="service_${service.id}" accept="image/*" style="display: none;" onchange="uploadServiceImage('${service.id}', this)">
<div class="image-upload-info">
<span class="image-upload-label">${service.alt}</span>
<span class="image-upload-hint">1920x600 recommended</span>
</div>
</div>
                `).join('')}
</div>
</div>
<button class="btn-admin primary" onclick="saveSiteImages(); loadServicesView(); showNotification('Site images saved and pushed to frontend!', 'success');">Save All Changes</button>
    `;
}

function uploadSiteImage(key, input) {
    if (input.files && input.files[0]) {
        showNotification('Uploading ' + key + ' image...', 'info');
        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const compressed = await compressImage(e.target.result, 1200, 0.7);
                const ref = await NuiImageStore.saveImage('site_' + key, compressed);
                siteImages[key].url = ref;
            } catch(err) {
                console.warn('Cloud storage failed for site image, using compressed data URL:', err.message);
                try { siteImages[key].url = await compressImage(e.target.result, 800, 0.5); }
                catch(e2) { siteImages[key].url = e.target.result; }
            }
            saveSiteImages();
            loadAdminSiteImagesPanel();
            showNotification((siteImages[key].alt || key) + ' saved!', 'success');
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function uploadServiceImage(serviceId, input) {
    if (input.files && input.files[0]) {
        showNotification('Uploading service image...', 'info');
        const reader = new FileReader();
        reader.onload = async function(e) {
            const service = siteImages.services.find(s => s.id === serviceId);
            if (service) {
                try {
                    const compressed = await compressImage(e.target.result, 1200, 0.7);
                    const ref = await NuiImageStore.saveImage('service_' + serviceId, compressed);
                    service.url = ref;
                } catch(err) {
                    console.warn('Cloud storage failed for service image, using compressed data URL:', err.message);
                    try { service.url = await compressImage(e.target.result, 800, 0.5); }
                    catch(e2) { service.url = e.target.result; }
                }
                saveSiteImages();
                loadAdminSiteImagesPanel();
                showNotification(service.alt + ' image saved!', 'success');
            }
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function clearSiteImage(key) {
    siteImages[key].url = '';
    saveSiteImages();
    loadAdminSiteImagesPanel();
}

// ==================== DESIGNERS PANEL ====================
function loadAdminDesignersPanel(searchTerm = '') {
    const filtered = searchTerm
        ? designers.filter(d =>
            (d.name || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
            (d.email || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
            (d.role || '').toLowerCase().includes(searchTerm.toLowerCase())
          )
        : designers;

    document.getElementById('adminDesignersPanel').innerHTML = `
<div class="panel-header">
<h2 class="panel-title">🎨 Designer Management</h2>
<p class="panel-subtitle">Manage designer accounts and permissions (${filtered.length} of ${designers.length})</p>
</div>
<div style="display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; align-items: center;">
<input type="text" id="designerSearch" placeholder="Search designers..." value="${searchTerm}"
                oninput="loadAdminDesignersPanel(this.value)"
                style="flex: 1; min-width: 200px; padding: 12px 16px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; font-size: 14px; background: rgba(255,255,255,0.1); color: #fff;">
<button onclick="exportDesignersCSV()" style="padding: 10px 16px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; cursor: pointer; color: #fff;">Export CSV</button>
<button class="btn-admin primary" onclick="showAddDesignerModal()">+ Add Designer</button>
</div>
        ${filtered.length > 0 ? `
<div class="card-grid">
            ${filtered.map(designer => `
<div class="client-card">
<div class="client-card-header" style="background: linear-gradient(135deg, var(--red), #ff6b6b);">
                        ${designer.avatar ? '<img alt="Designer avatar" loading="lazy" src="' + designer.avatar + '" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;">' : designer.name.charAt(0)}
</div>
<div class="client-card-body">
<div class="client-card-name">${designer.name}</div>
<div class="client-card-meta">${designer.email}<br>${designer.role}</div>
<div style="margin-bottom: 12px;">
                            ${(designer.permissions || []).map(p => '<span class="tag" style="margin: 2px;">' + p + '</span>').join('')}
</div>
<div class="client-card-btns">
<button style="background: var(--red); color: #fff;" onclick="editDesigner(${designer.id})">Edit</button>
<button style="background: rgba(255,255,255,0.1); color: #fff;" onclick="deleteDesigner(${designer.id})">Delete</button>
</div>
</div>
</div>
            `).join('')}
</div>
        ` : '<p style="color: rgba(255,255,255,0.5); text-align: center; padding: 40px;">No designers found.</p>'}
<div class="form-section" style="margin-top: 32px;">
<div class="form-section-title">🔐 Designer Login Credentials</div>
<p style="color: rgba(255,255,255,0.5); font-size: 13px; margin-bottom: 16px;">Designers can log in at the portal with these credentials:</p>
<table class="data-table">
<thead><tr><th>Name</th><th>Email</th><th>Password</th><th>Role</th></tr></thead>
<tbody>
                    ${filtered.length === 0 ? '<tr><td colspan="4" style="text-align: center;">No designers</td></tr>' : ''}
                    ${filtered.map(d => '<tr><td>' + d.name + '</td><td>' + d.email + '</td><td>' + d.password + '</td><td>' + d.role + '</td></tr>').join('')}
</tbody>
</table>
</div>
    `;
}

// Export designers to CSV
function exportDesignersCSV() {
    if (designers.length === 0) {
        alert('No designers to export.');
        return;
    }

    const headers = ['ID', 'Name', 'Email', 'Role', 'Permissions', 'Payout Tier'];
    const rows = designers.map(d => [
        d.id,
        d.name || '',
        d.email || '',
        d.role || '',
        (d.permissions || []).join('; '),
        d.payoutTier || '35%'
    ]);

    const csv = [headers.join(','), ...rows.map(r => r.map(v => '"' + String(v).replace(/"/g, '""') + '"').join(','))].join('\n');
    downloadCSV(csv, 'nui-designers-' + new Date().toISOString().split('T')[0] + '.csv');
}

function showAddDesignerModal() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.id = 'designerModal';
    modal.innerHTML = `
<div class="modal">
<div class="modal-header"><h3 class="modal-title">Add Designer</h3><button class="modal-close" onclick="document.getElementById('designerModal').remove()">×</button></div>
<div class="modal-body">
<div class="form-group"><label class="form-label">Name *</label><input type="text" id="designerName" class="form-input" placeholder="Jane Designer"></div>
<div class="form-group"><label class="form-label">Email *</label><input type="email" id="designerEmail" class="form-input" placeholder="jane@nui.com"></div>
<div class="form-group"><label class="form-label">Password *</label><input type="text" id="designerPassword" class="form-input" placeholder="designer123"></div>
<div class="form-group"><label class="form-label">Role</label><input type="text" id="designerRole" class="form-input" placeholder="Designer" value="Designer"></div>
<div class="form-group">
<label class="form-label">Permissions</label>
<div style="display: flex; flex-wrap: wrap; gap: 12px;">
<label style="display: flex; align-items: center; gap: 8px; cursor: pointer;"><input type="checkbox" id="permProjects" checked> Projects</label>
<label style="display: flex; align-items: center; gap: 8px; cursor: pointer;"><input type="checkbox" id="permProofs" checked> Proofs</label>
<label style="display: flex; align-items: center; gap: 8px; cursor: pointer;"><input type="checkbox" id="permAssets" checked> Assets</label>
<label style="display: flex; align-items: center; gap: 8px; cursor: pointer;"><input type="checkbox" id="permClients"> Clients</label>
</div>
</div>
</div>
<div class="modal-footer"><button class="btn-admin secondary" onclick="document.getElementById('designerModal').remove()">Cancel</button><button class="btn-admin primary" onclick="saveDesigner()">Add Designer</button></div>
</div>
    `;
    document.body.appendChild(modal);
}

function saveDesigner() {
    const permissions = [];
    if (document.getElementById('permProjects').checked) permissions.push('projects');
    if (document.getElementById('permProofs').checked) permissions.push('proofs');
    if (document.getElementById('permAssets').checked) permissions.push('assets');
    if (document.getElementById('permClients').checked) permissions.push('clients');

    const designer = {
        id: Date.now(),
        name: document.getElementById('designerName').value,
        email: document.getElementById('designerEmail').value,
        password: document.getElementById('designerPassword').value,
        role: document.getElementById('designerRole').value,
        avatar: '',
        permissions: permissions
    };
    designers.push(designer);
    saveDesigners();
    document.getElementById('designerModal').remove();
    loadAdminDesignersPanel();
}

function editDesigner(id) {
    const designer = designers.find(d => d.id === id);
    if (!designer) return;
    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.id = 'designerModal';
    modal.innerHTML = `
<div class="modal">
<div class="modal-header"><h3 class="modal-title">Edit Designer</h3><button class="modal-close" onclick="document.getElementById('designerModal').remove()">×</button></div>
<div class="modal-body">
<div class="form-group"><label class="form-label">Name</label><input type="text" id="designerName" class="form-input" value="${designer.name}"></div>
<div class="form-group"><label class="form-label">Email</label><input type="email" id="designerEmail" class="form-input" value="${designer.email}"></div>
<div class="form-group"><label class="form-label">Password</label><input type="text" id="designerPassword" class="form-input" value="${designer.password}"></div>
<div class="form-group"><label class="form-label">Role</label><input type="text" id="designerRole" class="form-input" value="${designer.role}"></div>
<div class="form-group">
<label class="form-label">Permissions</label>
<div style="display: flex; flex-wrap: wrap; gap: 12px;">
<label style="display: flex; align-items: center; gap: 8px; cursor: pointer;"><input type="checkbox" id="permProjects" ${designer.permissions.includes('projects') ? 'checked' : ''}> Projects</label>
<label style="display: flex; align-items: center; gap: 8px; cursor: pointer;"><input type="checkbox" id="permProofs" ${designer.permissions.includes('proofs') ? 'checked' : ''}> Proofs</label>
<label style="display: flex; align-items: center; gap: 8px; cursor: pointer;"><input type="checkbox" id="permAssets" ${designer.permissions.includes('assets') ? 'checked' : ''}> Assets</label>
<label style="display: flex; align-items: center; gap: 8px; cursor: pointer;"><input type="checkbox" id="permClients" ${designer.permissions.includes('clients') ? 'checked' : ''}> Clients</label>
</div>
</div>
</div>
<div class="modal-footer"><button class="btn-admin secondary" onclick="document.getElementById('designerModal').remove()">Cancel</button><button class="btn-admin primary" onclick="updateDesigner(${id})">Update</button></div>
</div>
    `;
    document.body.appendChild(modal);
}

function updateDesigner(id) {
    const designer = designers.find(d => d.id === id);
    if (!designer) return;
    const permissions = [];
    if (document.getElementById('permProjects').checked) permissions.push('projects');
    if (document.getElementById('permProofs').checked) permissions.push('proofs');
    if (document.getElementById('permAssets').checked) permissions.push('assets');
    if (document.getElementById('permClients').checked) permissions.push('clients');

    designer.name = document.getElementById('designerName').value;
    designer.email = document.getElementById('designerEmail').value;
    designer.password = document.getElementById('designerPassword').value;
    designer.role = document.getElementById('designerRole').value;
    designer.permissions = permissions;
    saveDesigners();
    document.getElementById('designerModal').remove();
    loadAdminDesignersPanel();
}

function deleteDesigner(id) {
    const designer = designers.find(d => d.id == id);
    if (!designer) { alert('Designer not found.'); return; }
    if (!confirm('Delete ' + designer.name + '? This cannot be undone.')) return;
    designers = designers.filter(d => d.id != id);
    saveDesigners();
    loadAdminDesignersPanel();
}

// ==================== BRAND GUIDE PANEL ====================
// Current brand guide being edited
let currentBrandGuide = null;

function loadAdminBrandGuidePanel() {
    const clientProofs = proofs.filter(p => p.type === 'brandguide');

    document.getElementById('adminBrandguidePanel').innerHTML = `
<div class="panel-header">
<h2 class="panel-title">📘 Brand Guide & Proof System</h2>
<p class="panel-subtitle">Create brand guides, manage proofs, and client asset storage</p>
</div>

        <!-- Stats -->
<div class="stats-grid">
<div class="stat-card"><div class="stat-label">Active Guides</div><div class="stat-value">${clientProofs.length}</div></div>
<div class="stat-card"><div class="stat-label">Pending Approval</div><div class="stat-value" style="color: #f59e0b;">${clientProofs.filter(p => p.status === 'pending' || p.status === 'revision_requested').length}</div></div>
<div class="stat-card"><div class="stat-label">Approved</div><div class="stat-value" style="color: #2ecc71;">${clientProofs.filter(p => p.status === 'approved').length}</div></div>
<div class="stat-card"><div class="stat-label">Delivered</div><div class="stat-value" style="color: #3b82f6;">${clientProofs.filter(p => p.status === 'delivered').length}</div></div>
</div>

<div style="display: flex; gap: 12px; margin-bottom: 24px;">
<button class="btn-admin primary" onclick="showCreateBrandGuideModal()">+ Create Brand Guide</button>
<button class="btn-admin secondary" onclick="showAdminPanel('assets')">📁 Client Asset Storage</button>
</div>

        <!-- Brand Guides Grid (Portfolio Style) -->
<div class="form-section">
<div class="form-section-title">📁 Brand Guides</div>
            ${clientProofs.length === 0 ? '<p style="color: rgba(255,255,255,0.5);">No brand guides created yet. Click "Create Brand Guide" to get started.</p>' : ''}
<div class="card-grid">
                ${clientProofs.map(proof => {
                    const client = clients.find(c => c.id == proof.clientId);
                    const isPaid = checkClientPaymentStatus(proof.clientId);
                    return `
<div class="client-card" style="cursor: pointer; position: relative;" onclick="editBrandGuidePortfolio(${proof.id})">
<div class="client-card-header" style="background: linear-gradient(135deg, ${proof.brandColors?.[0] || '#e63946'}, ${proof.brandColors?.[1] || '#1d3557'});">
                            ${proof.logo ? '<img alt="Client logo proof" loading="lazy" src="' + proof.logo + '" style="max-width: 80px; max-height: 50px; object-fit: contain;">' : (proof.clientName?.charAt(0) || 'B')}
</div>
                        ${proof.status === 'revision_requested' ? '<div style="position: absolute; top: 8px; right: 8px; background: #f59e0b; color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">REVISION</div>' : ''}
                        ${isPaid ? '<div style="position: absolute; top: 8px; left: 8px; background: #2ecc71; color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">PAID</div>' : ''}
<div class="client-card-body">
<div class="client-card-name">${proof.title || proof.clientName}</div>
<div class="client-card-meta">
                                ${client?.name || 'No Client'}<br>
<span class="status-badge ${proof.status}" style="margin-top: 4px; display: inline-block;">${proof.status?.replace('_', ' ') || 'draft'}</span>
</div>
<div style="margin-top: 8px; font-size: 11px; color: rgba(255,255,255,0.5);">
                                ${proof.revisionCount || 0} revisions • ${proof.comments?.length || 0} comments
</div>
<div class="client-card-btns" style="margin-top: 12px;">
<button style="background: var(--red); color: #fff;" onclick="event.stopPropagation(); editBrandGuidePortfolio(${proof.id})">Edit</button>
<button style="background: rgba(255,255,255,0.1); color: #fff;" onclick="event.stopPropagation(); sendProofToClient(${proof.id})">Send</button>
</div>
</div>
</div>
                `;}).join('')}
</div>
</div>

        <!-- Recent Activity -->
<div class="form-section">
<div class="form-section-title">📋 Recent Proof Activity</div>
<table class="data-table">
<thead><tr><th>Brand Guide</th><th>Client</th><th>Status</th><th>Payment</th><th>Last Update</th><th>Actions</th></tr></thead>
<tbody>
                    ${clientProofs.length === 0 ? '<tr><td colspan="6" style="text-align: center; opacity: 0.5;">No activity yet</td></tr>' : ''}
                    ${clientProofs.slice(-10).reverse().map(p => {
                        const client = clients.find(c => c.id == p.clientId);
                        const isPaid = checkClientPaymentStatus(p.clientId);
                        return `
<tr>
<td style="font-weight: 600;">${p.title}</td>
<td>${client?.name || 'N/A'}</td>
<td><span class="status-badge ${p.status}">${p.status?.replace('_', ' ') || 'draft'}</span></td>
<td>${isPaid ? '<span style="color: #2ecc71;">✓ Paid</span>' : '<span style="color: #f59e0b;">Pending</span>'}</td>
<td>${p.updatedAt ? new Date(p.updatedAt).toLocaleDateString() : '-'}</td>
<td>
<button class="btn-admin small" onclick="editBrandGuidePortfolio(${p.id})">Edit</button>
                                ${p.status === 'approved' && isPaid ? '<button class="btn-admin small primary" onclick="deliverBrandGuide(' + p.id + ')">Deliver</button>' : ''}
</td>
</tr>
                    `;}).join('')}
</tbody>
</table>
</div>
        ${currentBrandGuide ? renderBrandGuideEditor() : ''}
    `;
}

// Check if client has paid for their project
function checkClientPaymentStatus(clientId) {
    const clientPayments = payments.filter(p => p.clientId == clientId && p.status === 'completed');
    const clientInvoices = invoices.filter(i => i.clientId == clientId && i.status === 'paid');
    return clientPayments.length > 0 || clientInvoices.length > 0;
}

// Portfolio-style Brand Guide Editor
function renderBrandGuideEditor() {
    const p = proofs.find(x => x.id === currentBrandGuide);
    if (!p) return '';
    const client = clients.find(c => c.id == p.clientId);
    const isPaid = checkClientPaymentStatus(p.clientId);

    return `
<div style="position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px;">
<div style="background: #1a1a1a; width: 100%; max-width: 1100px; max-height: 95vh; overflow-y: auto; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
                <!-- Header -->
<div style="padding: 24px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: #1a1a1a; z-index: 10;">
<div>
<h2 style="font-size: 24px; font-weight: 700; color: #fff;">${p.title}</h2>
<p style="color: rgba(255,255,255,0.5); font-size: 13px; margin-top: 4px;">Client: ${client?.name || 'Unknown'} • Status: <span class="status-badge ${p.status}">${p.status?.replace('_', ' ')}</span></p>
</div>
<div style="display: flex; gap: 12px; align-items: center;">
                        ${isPaid ? '<span style="background: #2ecc71; color: #fff; padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: 600;">✓ PAID</span>' : '<span style="background: #f59e0b; color: #fff; padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: 600;">PAYMENT PENDING</span>'}
<button onclick="currentBrandGuide = null; loadAdminBrandGuidePanel();" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #fff;">×</button>
</div>
</div>

<div style="padding: 24px;">
                    <!-- Hero Banner (21:9) -->
<div class="form-section">
<div class="form-section-title">🖼️ Hero Banner Image (21:9 Full Width)</div>
<div style="aspect-ratio: 21/9; border: 2px dashed rgba(255,255,255,0.2); border-radius: 16px; overflow: hidden; background: linear-gradient(135deg, ${p.brandColors?.[0] || '#e63946'} 0%, ${p.brandColors?.[1] || '#1d3557'} 100%); position: relative;">
                            ${p.heroImage ? '<img alt="Brand guide hero image" loading="lazy" src="' + p.heroImage + '" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.5;">' : ''}
<div style="position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px;">
<div style="font-size: 32px; font-weight: 900; color: #fff; text-shadow: 0 2px 8px rgba(0,0,0,0.5);">${p.title}</div>
                                ${p.tagline ? '<div style="font-size: 16px; color: rgba(255,255,255,0.8);">' + p.tagline + '</div>' : ''}
<input type="file" id="bgHeroUpload" style="display: none;" accept="image/*" onchange="uploadBrandGuideHero(${p.id}, this)">
<button onclick="document.getElementById('bgHeroUpload').click()" style="padding: 12px 24px; background: rgba(0,0,0,0.7); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Upload Hero Image</button>
</div>
</div>
</div>

                    <!-- Basic Info -->
<div class="form-section" style="margin-top: 24px;">
<div class="form-section-title">📝 Basic Info</div>
<div class="form-row">
<div class="form-group"><label class="form-label">Brand Name</label><input type="text" class="form-input" value="${p.title || ''}" onchange="updateBrandGuideField(${p.id}, 'title', this.value)"></div>
<div class="form-group"><label class="form-label">Tagline</label><input type="text" class="form-input" value="${p.tagline || ''}" onchange="updateBrandGuideField(${p.id}, 'tagline', this.value)"></div>
</div>
<div class="form-group"><label class="form-label">Brand Story / Mission</label><textarea class="form-textarea" rows="3" onchange="updateBrandGuideField(${p.id}, 'description', this.value)">${p.description || ''}</textarea></div>
</div>

                    <!-- Logo System (1:1 Square) -->
<div class="form-section" style="margin-top: 24px;">
<div class="form-section-title">🎨 Logo System (1:1 Square)</div>
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px;">
                            ${['Primary Logo', 'Secondary Logo', 'Icon / Logo Mark'].map((label, i) => {
                                const keys = ['logo', 'secondaryLogo', 'iconMark'];
                                const key = keys[i];
                                return `
<div style="aspect-ratio: 1/1; border: 2px dashed rgba(255,255,255,0.2); border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; background: rgba(255,255,255,0.05);">
<div style="font-size: 11px; color: rgba(255,255,255,0.6); padding: 16px; background: rgba(255,255,255,0.05); text-transform: uppercase; letter-spacing: 1px; font-weight: 600; text-align: center;">${label}</div>
<div style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 24px; background: #fff;">
                                        ${p[key] ? '<img alt="Brand asset image" loading="lazy" src="' + p[key] + '" style="max-height: 100%; max-width: 100%; object-fit: contain;">' : '<div style="color: #ccc; font-size: 13px;">No logo</div>'}
</div>
<div style="padding: 16px; background: rgba(255,255,255,0.05); text-align: center;">
<input type="file" id="bgLogo${i}Upload" style="display: none;" accept="image/*" onchange="uploadBrandGuideAsset(${p.id}, '${key}', this)">
<button onclick="document.getElementById('bgLogo${i}Upload').click()" style="padding: 10px 20px; background: var(--red); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600;">Upload</button>
</div>
</div>
                            `;}).join('')}
</div>
</div>

                    <!-- Color Palette -->
<div class="form-section" style="margin-top: 24px;">
<div class="form-section-title">🎨 Color Palette</div>
<div style="display: flex; gap: 16px; flex-wrap: wrap;">
                            ${(p.brandColors || ['#e63946', '#1d3557', '#f4a261']).map((c, i) => `
<div style="text-align: center;">
<input type="color" value="${c}" onchange="updateBrandGuideColor(${p.id}, ${i}, this.value)" style="width: 70px; height: 70px; border: none; border-radius: 12px; cursor: pointer;">
<div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 4px; font-family: monospace;">${c}</div>
</div>
                            `).join('')}
<button onclick="addBrandGuideColor(${p.id})" style="width: 70px; height: 70px; border: 2px dashed rgba(255,255,255,0.3); border-radius: 12px; background: none; cursor: pointer; font-size: 24px; color: rgba(255,255,255,0.5);">+</button>
</div>
</div>

                    <!-- Font System -->
<div class="form-section" style="margin-top: 24px;">
<div class="form-section-title">🔤 Font System</div>
<div class="form-row">
<div class="form-group"><label class="form-label">Heading Font</label><input type="text" class="form-input" value="${p.fonts?.primary || ''}" onchange="updateBrandGuideFont(${p.id}, 'primary', this.value)"></div>
<div class="form-group"><label class="form-label">Body Font</label><input type="text" class="form-input" value="${p.fonts?.secondary || ''}" onchange="updateBrandGuideFont(${p.id}, 'secondary', this.value)"></div>
</div>
</div>

                    <!-- Brand Mockups -->
<div class="form-section" style="margin-top: 24px;">
<div class="form-section-title">📸 Brand Mockups</div>
<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                            ${(p.mockups || []).map((m, i) => `
<div style="position: relative; border-radius: 16px; overflow: hidden; box-shadow: 0 8px 24px rgba(0,0,0,0.3);">
<img alt="Moodboard reference image" loading="lazy" src="${m}" style="width: 100%; aspect-ratio: 16/9; object-fit: cover;">
<button onclick="removeBrandGuideMockup(${p.id}, ${i})" style="position: absolute; top: 12px; right: 12px; background: #dc2626; color: #fff; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer;">×</button>
</div>
                            `).join('')}
<div style="border: 2px dashed rgba(255,255,255,0.2); border-radius: 16px; aspect-ratio: 16/9; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px;">
<input type="file" id="bgMockupUpload" accept="image/*" style="display: none;" onchange="uploadBrandGuideMockup(${p.id}, this)">
<button onclick="document.getElementById('bgMockupUpload').click()" style="padding: 12px 24px; background: var(--red); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">+ Add Mockup</button>
</div>
</div>
</div>

                    <!-- Proof Approval Section -->
<div class="form-section" style="margin-top: 32px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);">
<div class="form-section-title">✅ Proof Approval System</div>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                            <!-- Status & Actions -->
<div>
<p style="color: rgba(255,255,255,0.6); font-size: 14px; margin-bottom: 16px;">Current Status: <span class="status-badge ${p.status}" style="margin-left: 8px;">${p.status?.replace('_', ' ') || 'draft'}</span></p>
<p style="color: rgba(255,255,255,0.6); font-size: 14px; margin-bottom: 16px;">Revision Count: <strong>${p.revisionCount || 0}</strong></p>
<p style="color: rgba(255,255,255,0.6); font-size: 14px; margin-bottom: 16px;">Payment: ${isPaid ? '<span style="color: #2ecc71; font-weight: 600;">✓ Paid</span>' : '<span style="color: #f59e0b; font-weight: 600;">Pending</span>'}</p>

<div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 24px;">
<button class="btn-admin primary" onclick="sendProofToClient(${p.id})">📤 Send to Client</button>
                                    ${p.status === 'approved' && isPaid ? '<button class="btn-admin" style="background: #2ecc71; color: #fff;" onclick="deliverBrandGuide(' + p.id + ')">📦 Deliver Files</button>' : ''}
                                    ${p.status === 'approved' && !isPaid ? '<button class="btn-admin secondary" disabled title="Client must pay before delivery">⏳ Awaiting Payment</button>' : ''}
</div>
</div>

                            <!-- Comments -->
<div>
<p style="color: rgba(255,255,255,0.8); font-weight: 600; margin-bottom: 12px;">💬 Comments & Feedback (${(p.comments || []).length})</p>
<div style="max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                                    ${(p.comments || []).length === 0 ? '<p style="color: rgba(255,255,255,0.4); font-size: 13px;">No comments yet</p>' : ''}
                                    ${(p.comments || []).map(c => `
<div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
<div style="display: flex; justify-content: space-between;">
<strong style="font-size: 12px; color: ${c.from === 'client' ? '#3b82f6' : '#2ecc71'};">${c.from === 'client' ? '👤 Client' : '🏢 NUI'}</strong>
<span style="font-size: 11px; color: rgba(255,255,255,0.4);">${new Date(c.timestamp).toLocaleString()}</span>
</div>
<p style="font-size: 13px; margin-top: 4px; color: rgba(255,255,255,0.8);">${c.text}</p>
</div>
                                    `).join('')}
</div>
<div style="display: flex; gap: 8px;">
<input type="text" id="bgNewComment" class="form-input" placeholder="Add a comment..." style="flex: 1;">
<button class="btn-admin primary" onclick="addBrandGuideComment(${p.id})">Send</button>
</div>
</div>
</div>
</div>

                    <!-- Client Download Section -->
                    ${p.status === 'approved' || p.status === 'delivered' ? `
<div class="form-section" style="margin-top: 24px; background: ${isPaid ? 'rgba(46,204,113,0.1)' : 'rgba(255,59,48,0.1)'}; border: 1px solid ${isPaid ? '#2ecc71' : '#ff3b30'};">
<div class="form-section-title">${isPaid ? '✅ Ready for Download' : '🔒 Payment Required for Download'}</div>
                        ${isPaid ? `
<p style="color: rgba(255,255,255,0.6); margin-bottom: 16px;">Client can now download their brand assets.</p>
<div style="display: flex; gap: 12px; flex-wrap: wrap;">
<button class="btn-admin" style="background: #2ecc71; color: #fff;" onclick="downloadBrandGuidePackage(${p.id})">📥 Download Full Package</button>
<button class="btn-admin secondary" onclick="emailBrandGuideToClient(${p.id})">📧 Email to Client</button>
</div>
                        ` : `
<p style="color: rgba(255,255,255,0.6); margin-bottom: 16px;">Client must complete payment before downloading files.</p>
<button class="btn-admin primary" onclick="sendPaymentReminder(${p.clientId})">💳 Send Payment Reminder</button>
                        `}
</div>
                    ` : ''}

                    <!-- Footer Actions -->
<div style="margin-top: 32px; display: flex; gap: 16px; justify-content: space-between;">
<button onclick="deleteBrandGuide(${p.id})" style="padding: 12px 24px; background: #fee2e2; color: #dc2626; border: none; border-radius: 8px; cursor: pointer;">Delete Brand Guide</button>
<button onclick="currentBrandGuide = null; loadAdminBrandGuidePanel();" class="btn-admin primary">Save & Close</button>
</div>
</div>
</div>
</div>
    `;
}

function editBrandGuidePortfolio(id) {
    currentBrandGuide = id;
    loadAdminBrandGuidePanel();
}

function updateBrandGuideField(id, field, value) {
    const p = proofs.find(x => x.id === id);
    if (p) {
        p[field] = value;
        p.updatedAt = new Date().toISOString();
        saveProofs();
    }
}

function updateBrandGuideColor(id, index, value) {
    const p = proofs.find(x => x.id === id);
    if (p) {
        if (!p.brandColors) p.brandColors = ['#e63946', '#1d3557', '#f4a261'];
        p.brandColors[index] = value;
        p.updatedAt = new Date().toISOString();
        saveProofs();
        loadAdminBrandGuidePanel();
    }
}

function addBrandGuideColor(id) {
    const p = proofs.find(x => x.id === id);
    if (p && (!p.brandColors || p.brandColors.length < 6)) {
        if (!p.brandColors) p.brandColors = [];
        p.brandColors.push('#000000');
        saveProofs();
        loadAdminBrandGuidePanel();
    }
}

function updateBrandGuideFont(id, type, value) {
    const p = proofs.find(x => x.id === id);
    if (p) {
        if (!p.fonts) p.fonts = {};
        p.fonts[type] = value;
        saveProofs();
    }
}

function uploadBrandGuideHero(id, input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const p = proofs.find(x => x.id === id);
        if (p) {
            p.heroImage = e.target.result;
            p.updatedAt = new Date().toISOString();
            saveProofs();
            loadAdminBrandGuidePanel();
        }
    };
    reader.readAsDataURL(file);
}

function uploadBrandGuideAsset(id, key, input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const p = proofs.find(x => x.id === id);
        if (p) {
            p[key] = e.target.result;
            p.updatedAt = new Date().toISOString();
            saveProofs();
            loadAdminBrandGuidePanel();
        }
    };
    reader.readAsDataURL(file);
}

function uploadBrandGuideMockup(id, input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const p = proofs.find(x => x.id === id);
        if (p) {
            if (!p.mockups) p.mockups = [];
            p.mockups.push(e.target.result);
            p.updatedAt = new Date().toISOString();
            saveProofs();
            loadAdminBrandGuidePanel();
        }
    };
    reader.readAsDataURL(file);
}

function removeBrandGuideMockup(id, index) {
    const p = proofs.find(x => x.id === id);
    if (p && p.mockups) {
        p.mockups.splice(index, 1);
        saveProofs();
        loadAdminBrandGuidePanel();
    }
}

function addBrandGuideComment(id) {
    const input = document.getElementById('bgNewComment');
    const text = input.value.trim();
    if (!text) return;

    const p = proofs.find(x => x.id === id);
    if (p) {
        if (!p.comments) p.comments = [];
        p.comments.push({
            from: 'admin',
            text: text,
            timestamp: new Date().toISOString()
        });
        p.updatedAt = new Date().toISOString();
        saveProofs();
        input.value = '';
        loadAdminBrandGuidePanel();
    }
}

async function sendProofToClient(id) {
    const p = proofs.find(x => x.id === id);
    if (!p) return;

    p.status = 'pending';
    p.sentToClient = true;
    p.sentAt = new Date().toISOString();
    p.updatedAt = new Date().toISOString();
    saveProofs();

    const client = clients.find(c => c.id == p.clientId);
    const clientEmail = client?.email;

    // Send real email to client
    let emailSent = false;
    if (clientEmail) {
        try {
            const resp = await fetch('/.netlify/functions/send-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    to: clientEmail,
                    clientId: client?.id,
                    subject: `🎨 Your ${p.title || 'Brand Guide'} Proof is Ready for Review`,
                    html: `<div style="font-family: -apple-system, sans-serif; max-width: 600px; margin: 0 auto; background: #0a0a0a; color: #fff; border-radius: 12px; overflow: hidden;">
<div style="background: linear-gradient(135deg, #e63946, #ff6b6b); padding: 32px; text-align: center;">
<h2 style="margin: 0; font-size: 24px; color: #fff;">Your Proof is Ready! 🎉</h2>
</div>
<div style="padding: 32px;">
<p style="color: #ccc; font-size: 16px;">Hey ${client?.name || 'there'},</p>
<p style="color: #ccc; font-size: 16px;">Your <strong>${p.title || 'Brand Guide'}</strong> proof is ready for your review!</p>
<div style="background: #111; border: 1px solid #333; border-radius: 12px; padding: 24px; margin: 24px 0; text-align: center;">
<p style="color: #fff; font-weight: 600; margin-bottom: 16px;">What to do next:</p>
<p style="color: #ccc; font-size: 14px; margin-bottom: 8px;">✅ <strong>Approve</strong> — if everything looks perfect</p>
<p style="color: #ccc; font-size: 14px;">🔄 <strong>Request Revisions</strong> — if you need changes</p>
</div>
<p style="color: #ccc; font-size: 14px;">Log into your <a href="https://newurbaninfluence.com/#portal" style="color: #e63946; text-decoration: none; font-weight: 600;">Client Portal</a> to review and respond.</p>
<p style="color: #888; font-size: 13px; margin-top: 24px;">Questions? Reply to this email or call (248) 487-8747.</p>
</div>
<div style="background: #050505; padding: 20px; text-align: center; border-top: 1px solid #222;">
<p style="color: #666; font-size: 12px; margin: 0;">New Urban Influence • Detroit, MI</p>
</div>
</div>`,
                    text: `Hey ${client?.name || 'there'}, your ${p.title || 'Brand Guide'} proof is ready for review! Log into your client portal to approve or request revisions. — New Urban Influence`
                })
            });
            emailSent = resp.ok;
        } catch (err) {
            console.log('Client email failed:', err.message);
        }
    }

    // Log to CRM
    logProofActivity('sent_to_client', p, `Proof "${p.title || 'Brand Guide'}" sent to ${client?.name || 'client'} for review`);

    alert('Proof sent to ' + (client?.name || 'client') + '!' + (emailSent ? '\n\n📧 Email delivered to ' + clientEmail : '\n\n⚠️ No email on file — notify client manually.'));
    loadAdminBrandGuidePanel();
}

async function deliverBrandGuide(id) {
    const p = proofs.find(x => x.id === id);
    if (!p) return;

    const isPaid = checkClientPaymentStatus(p.clientId);
    if (!isPaid) {
        alert('Cannot deliver - client has not paid yet.');
        return;
    }

    p.status = 'delivered';
    p.deliveredAt = new Date().toISOString();
    p.updatedAt = new Date().toISOString();
    saveProofs();

    const client = clients.find(c => c.id == p.clientId);

    // Send real delivery email
    if (client?.email) {
        await simulateEmailNotification(
            client.email,
            `🎉 Your ${p.title || 'Brand Guide'} is Ready for Download!`,
            `Your brand assets have been finalized and are ready to download. Log into your Client Portal at newurbaninfluence.com to access your files. Package includes all logo files, color palettes, typography guides, and brand guidelines.`
        );
    }

    // Log to CRM
    logProofActivity('delivered', p, `Brand Guide "${p.title}" delivered to ${client?.name || 'client'}`);

    alert('Brand Guide delivered to ' + (client?.name || 'client') + '!' + (client?.email ? '\n📧 Download notification sent via email.' : ''));
    loadAdminBrandGuidePanel();
}

function downloadBrandGuidePackage(id) {
    const p = proofs.find(x => x.id === id);
    if (!p) return;

    const isPaid = checkClientPaymentStatus(p.clientId);
    if (!isPaid) {
        alert('Download not available - payment required.');
        return;
    }

    // Generate HTML brand guide document
    const client = clients.find(c => c.id === p.clientId);
    const brandName = p.title || 'Brand Guide';
    const logoImages = [
        { name: 'Primary Logo', url: p.logo },
        { name: 'Secondary Logo', url: p.secondaryLogo },
        { name: 'Icon / Mark', url: p.iconMark }
    ].filter(l => l.url);

    const colorSwatches = (p.brandColors || []).map((color, i) => {
        const colorNames = ['Primary', 'Secondary', 'Accent'];
        return `
<div style="display: inline-block; text-align: center; margin: 16px; vertical-align: top;">
<div style="width: 120px; height: 120px; background: ${color}; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);"></div>
<p style="font-weight: 600; margin-top: 12px; font-size: 14px;">${colorNames[i] || 'Color ' + (i+1)}</p>
<p style="font-family: monospace; color: #666; margin: 4px 0; font-size: 12px;">${color.toUpperCase()}</p>
</div>
        `;
    }).join('');

    const mockupHTML = (p.mockups || []).map(mockup => `
<div style="margin: 20px 0;">
<img alt="Brand mockup preview" loading="lazy" src="${mockup}" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
</div>
    `).join('');

    const html = `
<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>${brandName} - Brand Guide</title>
 <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            color: #333;
            line-height: 1.6;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }

        /* Hero Section */
        .hero {
            background: linear-gradient(135deg, ${p.brandColors?.[0] || '#e63946'} 0%, ${p.brandColors?.[1] || '#1d3557'} 100%);
            color: white;
            padding: 80px 40px;
            text-align: center;
            border-radius: 16px;
            margin-bottom: 60px;
            ${p.heroImage ? `background-image: url('${p.heroImage}'); background-size: cover; background-position: center;` : ''}
        }
        .hero::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.4);
            border-radius: 16px;
        }
        .hero h1 {
            font-size: 48px;
            font-weight: 900;
            margin-bottom: 12px;
            position: relative;
            z-index: 1;
        }
        .hero p {
            font-size: 18px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        /* Section */
        .section {
            margin-bottom: 80px;
        }
        .section-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 32px;
            border-bottom: 3px solid ${p.brandColors?.[0] || '#e63946'};
            padding-bottom: 16px;
        }

        /* Logo Suite */
        .logo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 32px;
            margin-bottom: 40px;
        }
        .logo-item {
            text-align: center;
        }
        .logo-item img {
            width: 100%;
            height: 120px;
            object-fit: contain;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #eee;
            padding: 16px;
            margin-bottom: 12px;
        }
        .logo-item h3 {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        /* Color Palette */
        .color-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }
        .color-item {
            text-align: center;
        }
        .color-box {
            width: 120px;
            height: 120px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            margin-bottom: 12px;
        }
        .color-info {
            font-size: 12px;
            font-weight: 600;
        }
        .color-hex {
            font-family: monospace;
            color: #666;
            font-size: 11px;
        }

        /* Typography */
        .typography-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 40px;
        }
        .typography-item h3 {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .typography-preview {
            padding: 24px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        .typography-preview h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 12px;
        }
        .typography-preview p {
            font-size: 14px;
            line-height: 1.6;
        }

        /* Description */
        .description {
            background: #f0f0f0;
            padding: 32px;
            border-radius: 12px;
            margin-bottom: 60px;
        }
        .description h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }
        .description p {
            font-size: 15px;
            line-height: 1.8;
        }

        /* Mockups */
        .mockup-gallery {
            margin-bottom: 40px;
        }
        .mockup-gallery img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-bottom: 24px;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 40px;
            border-top: 1px solid #eee;
            color: #999;
            font-size: 12px;
        }
 </style>
    <!-- Geo Meta Tags -->
    <meta name="geo.region" content="US-MI">
    <meta name="geo.placename" content="Detroit, Michigan">
    <meta name="geo.position" content="42.3314;-83.0458">
    <meta name="ICBM" content="42.3314, -83.0458">
</head>
<body>
 <div class="container">
        <!-- Hero Section -->
<div class="hero" style="position: relative;">
<h2>${brandName}</h2>
            ${p.tagline ? `<p>${p.tagline}</p>` : ''}
</div>

        <!-- Description -->
        ${p.description ? `
<div class="description">
<h3>Brand Story</h3>
<p>${p.description.replace(/\n/g, '<br>')}</p>
</div>
        ` : ''}

        <!-- Logo Suite -->
<div class="section">
<h2 class="section-title">Logo Suite</h2>
<div class="logo-grid">
                ${logoImages.map(logo => `
<div class="logo-item">
<img loading="lazy" src="${logo.url}" alt="${logo.name}">
<h3>${logo.name}</h3>
</div>
                `).join('')}
</div>
</div>

        <!-- Color Palette -->
<div class="section">
<h2 class="section-title">Color Palette</h2>
<div class="color-grid">
                ${colorSwatches}
</div>
</div>

        <!-- Typography -->
        ${p.fonts ? `
<div class="section">
<h2 class="section-title">Typography</h2>
<div class="typography-section">
<div class="typography-item">
<h3>Headings</h3>
<div class="typography-preview">
<h2 style="font-family: '${p.fonts.primary || 'inherit'}', sans-serif;">Aa Bb Cc</h2>
<p style="font-size: 12px; color: #999;">${p.fonts.primary || 'Primary Font'}</p>
</div>
</div>
<div class="typography-item">
<h3>Body Text</h3>
<div class="typography-preview">
<p style="font-family: '${p.fonts.secondary || 'inherit'}', sans-serif;">The quick brown fox jumps over the lazy dog. Pack my box with five dozen liquor jugs.</p>
<p style="font-size: 12px; color: #999; margin-top: 12px;">${p.fonts.secondary || 'Secondary Font'}</p>
</div>
</div>
</div>
</div>
        ` : ''}

        <!-- Mockups -->
        ${mockupHTML ? `
<div class="section">
<h2 class="section-title">Brand Applications</h2>
<div class="mockup-gallery">
                ${mockupHTML}
</div>
</div>
        ` : ''}

        <!-- Footer -->
<div class="footer">
<p>Brand Guide for ${client?.name || 'Client'} • Generated on ${new Date().toLocaleDateString()}</p>
<p style="margin-top: 12px;">© New Urban Influence • All Rights Reserved</p>
</div>
 </div>
</body>
</html>
    `;

    // Create blob and trigger download
    const blob = new Blob([html], { type: 'text/html' });
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `${brandName.toLowerCase().replace(/\s+/g, '-')}-brand-guide.html`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);
}

async function emailBrandGuideToClient(id) {
    const p = proofs.find(x => x.id === id);
    if (!p) return;

    const isPaid = checkClientPaymentStatus(p.clientId);
    if (!isPaid) {
        alert('Cannot email - client has not paid yet.');
        return;
    }

    const client = clients.find(c => c.id == p.clientId);
    if (client?.email) {
        await simulateEmailNotification(
            client.email,
            `📦 Your Brand Assets - ${p.title || 'Brand Guide'}`,
            `Here are your brand assets! Log into your Client Portal at newurbaninfluence.com to download your complete brand package including logo files (SVG, PNG, EPS), color palette, typography guide, and all approved mockups.`
        );
        alert('📧 Email sent to ' + client.email + ' with download links!');
    } else {
        alert('No email address on file for this client.');
    }
}

async function sendPaymentReminder(clientId) {
    const client = clients.find(c => c.id == clientId);
    if (client?.email) {
        await simulateEmailNotification(
            client.email,
            `💳 Payment Reminder - New Urban Influence`,
            `Hi ${client.name || 'there'}, this is a friendly reminder that you have an outstanding balance for your project. Please log into your Client Portal to complete payment and unlock your final deliverables. Questions? Reply to this email or call (248) 487-8747.`
        );
        alert('📧 Payment reminder sent to ' + client.email + '!');
    } else {
        alert('No email on file for this client.');
    }
}

function deleteBrandGuide(id) {
    if (!confirm('Are you sure you want to delete this brand guide?')) return;
    proofs = proofs.filter(p => p.id !== id);
    saveProofs();
    currentBrandGuide = null;
    loadAdminBrandGuidePanel();
}

function showCreateBrandGuideModal() {
    const clientList = clients || [];
    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.id = 'brandGuideModal';
    modal.innerHTML = `
<div class="modal" style="max-width: 800px;">
<div class="modal-header">
<h3 class="modal-title">Create Brand Guide</h3>
<button class="modal-close" onclick="document.getElementById('brandGuideModal').remove()">×</button>
</div>
<div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
<div class="form-group">
<label class="form-label">Select Client *</label>
<select id="bgClient" class="form-select">
<option value="">-- Select Client --</option>
                        ${clientList.map(c => '<option value="' + c.id + '">' + c.name + ' - ' + (c.company || c.industry || 'N/A') + '</option>').join('')}
</select>
</div>
<div class="form-group">
<label class="form-label">Brand Name *</label>
<input type="text" id="bgBrandName" class="form-input" placeholder="Brand / Company Name">
</div>
<div class="form-group">
<label class="form-label">Tagline</label>
<input type="text" id="bgTagline" class="form-input" placeholder="Your brand tagline">
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Primary Color</label>
<input type="color" id="bgColor1" value="#e63946" style="width: 100%; height: 50px; border: none; border-radius: 8px; cursor: pointer;">
</div>
<div class="form-group">
<label class="form-label">Secondary Color</label>
<input type="color" id="bgColor2" value="#1d3557" style="width: 100%; height: 50px; border: none; border-radius: 8px; cursor: pointer;">
</div>
<div class="form-group">
<label class="form-label">Accent Color</label>
<input type="color" id="bgColor3" value="#f4a261" style="width: 100%; height: 50px; border: none; border-radius: 8px; cursor: pointer;">
</div>
</div>
<div class="form-group">
<label class="form-label">Hero Image (Optional)</label>
<input type="file" id="bgHeroImageUpload" accept="image/*" class="form-input" onchange="previewBrandGuideHeroImage(this)">
<div id="bgHeroImagePreview" style="margin-top: 12px;"></div>
<p style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 8px;">Recommended: 21:9 aspect ratio for full width banner</p>
</div>
<div class="form-group">
<label class="form-label">Primary Logo *</label>
<input type="file" id="bgLogoUpload" accept="image/*" class="form-input" onchange="previewBrandGuideLogo(this)">
<div id="bgLogoPreview" style="margin-top: 12px;"></div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Secondary Logo (Optional)</label>
<input type="file" id="bgSecondaryLogoUpload" accept="image/*" class="form-input" onchange="previewBrandGuideSecondaryLogo(this)">
<div id="bgSecondaryLogoPreview" style="margin-top: 12px;"></div>
</div>
<div class="form-group">
<label class="form-label">Icon/Logo Mark (Optional)</label>
<input type="file" id="bgIconMarkUpload" accept="image/*" class="form-input" onchange="previewBrandGuideIconMark(this)">
<div id="bgIconMarkPreview" style="margin-top: 12px;"></div>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Primary Font</label>
<select id="bgFontPrimary" class="form-select">
<option value="Playfair Display">Playfair Display</option>
<option value="Poppins">Poppins</option>
<option value="Montserrat">Montserrat</option>
<option value="Roboto">Roboto</option>
<option value="Open Sans">Open Sans</option>
<option value="Lato">Lato</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Secondary Font</label>
<select id="bgFontSecondary" class="form-select">
<option value="Inter">Inter</option>
<option value="Roboto">Roboto</option>
<option value="Open Sans">Open Sans</option>
<option value="Lato">Lato</option>
<option value="Poppins">Poppins</option>
</select>
</div>
</div>
<div class="form-group">
<label class="form-label">Brand Story / Description</label>
<textarea id="bgDescription" class="form-textarea" rows="4" placeholder="Brief brand story or description..."></textarea>
</div>
<div class="form-group">
<label class="form-label">Brand Mockups (Optional)</label>
<input type="file" id="bgMockupsUpload" accept="image/*" multiple class="form-input">
<p style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 8px;">Upload mockups showing the brand in use (business cards, letterhead, packaging, etc.)</p>
</div>
<div class="form-group">
<label class="form-label">Additional Assets (Optional)</label>
<input type="file" id="bgAssetsUpload" accept="image/*" multiple class="form-input">
<p style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 8px;">Upload additional brand assets (icons, patterns, photos)</p>
</div>
</div>
<div class="modal-footer">
<button class="btn-admin secondary" onclick="document.getElementById('brandGuideModal').remove()">Cancel</button>
<button class="btn-admin primary" onclick="saveBrandGuide()">Create Brand Guide</button>
</div>
</div>
    `;
    document.body.appendChild(modal);
}

function previewBrandGuideLogo(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = e => {
            document.getElementById('bgLogoPreview').innerHTML = `<img alt="Uploaded primary logo" loading="lazy" src="${e.target.result}" style="max-width: 200px; max-height: 100px; object-fit: contain; background: #fff; padding: 12px; border-radius: 8px;">`;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function previewBrandGuideHeroImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = e => {
            document.getElementById('bgHeroImagePreview').innerHTML = `<img alt="Uploaded hero image" loading="lazy" src="${e.target.result}" style="max-width: 300px; max-height: 150px; object-fit: cover; border-radius: 8px;">`;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function previewBrandGuideSecondaryLogo(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = e => {
            document.getElementById('bgSecondaryLogoPreview').innerHTML = `<img alt="Uploaded secondary logo" loading="lazy" src="${e.target.result}" style="max-width: 150px; max-height: 100px; object-fit: contain; background: #fff; padding: 12px; border-radius: 8px;">`;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function previewBrandGuideIconMark(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = e => {
            document.getElementById('bgIconMarkPreview').innerHTML = `<img alt="Uploaded icon mark" loading="lazy" src="${e.target.result}" style="max-width: 150px; max-height: 100px; object-fit: contain; background: #fff; padding: 12px; border-radius: 8px;">`;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function saveBrandGuide() {
    const clientId = document.getElementById('bgClient').value;
    const client = clients.find(c => c.id == clientId);

    const logoInput = document.getElementById('bgLogoUpload');
    const secondaryLogoInput = document.getElementById('bgSecondaryLogoUpload');
    const iconMarkInput = document.getElementById('bgIconMarkUpload');
    const heroImageInput = document.getElementById('bgHeroImageUpload');
    const mockupsInput = document.getElementById('bgMockupsUpload');
    const assetsInput = document.getElementById('bgAssetsUpload');

    const saveGuide = (data) => {
        const brandGuide = {
            id: Date.now(),
            type: 'brandguide',
            clientId: clientId,
            clientName: client ? client.name : document.getElementById('bgBrandName').value,
            title: document.getElementById('bgBrandName').value,
            tagline: document.getElementById('bgTagline').value,
            brandColors: [
                document.getElementById('bgColor1').value,
                document.getElementById('bgColor2').value,
                document.getElementById('bgColor3').value
            ],
            fonts: {
                primary: document.getElementById('bgFontPrimary').value,
                secondary: document.getElementById('bgFontSecondary').value
            },
            logo: data.logo || '',
            heroImage: data.heroImage || '',
            secondaryLogo: data.secondaryLogo || '',
            iconMark: data.iconMark || '',
            description: document.getElementById('bgDescription').value,
            mockups: data.mockups || [],
            comments: [],
            revisionCount: 0,
            assets: data.assets || [],
            status: 'draft',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            sentToClient: false
        };

        proofs.push(brandGuide);
        saveProofs();
        document.getElementById('brandGuideModal').remove();
        loadAdminBrandGuidePanel();
        alert('Brand Guide created successfully!');
    };

    // Collect all file data
    const fileData = {};
    let filesToProcess = 0;
    let filesProcessed = 0;

    // Helper to process all files and call saveGuide when done
    const tryCallSaveGuide = () => {
        filesProcessed++;
        if (filesProcessed === filesToProcess) {
            saveGuide(fileData);
        }
    };

    // Count files to process
    if (heroImageInput.files && heroImageInput.files[0]) filesToProcess++;
    if (logoInput.files && logoInput.files[0]) filesToProcess++;
    if (secondaryLogoInput.files && secondaryLogoInput.files[0]) filesToProcess++;
    if (iconMarkInput.files && iconMarkInput.files[0]) filesToProcess++;
    if (mockupsInput.files && mockupsInput.files.length > 0) filesToProcess++;
    if (assetsInput.files && assetsInput.files.length > 0) filesToProcess++;

    // If no files, just save
    if (filesToProcess === 0) {
        saveGuide(fileData);
        return;
    }

    // Process hero image
    if (heroImageInput.files && heroImageInput.files[0]) {
        const reader = new FileReader();
        reader.onload = e => {
            fileData.heroImage = e.target.result;
            tryCallSaveGuide();
        };
        reader.readAsDataURL(heroImageInput.files[0]);
    }

    // Process primary logo
    if (logoInput.files && logoInput.files[0]) {
        const reader = new FileReader();
        reader.onload = e => {
            fileData.logo = e.target.result;
            tryCallSaveGuide();
        };
        reader.readAsDataURL(logoInput.files[0]);
    }

    // Process secondary logo
    if (secondaryLogoInput.files && secondaryLogoInput.files[0]) {
        const reader = new FileReader();
        reader.onload = e => {
            fileData.secondaryLogo = e.target.result;
            tryCallSaveGuide();
        };
        reader.readAsDataURL(secondaryLogoInput.files[0]);
    }

    // Process icon mark
    if (iconMarkInput.files && iconMarkInput.files[0]) {
        const reader = new FileReader();
        reader.onload = e => {
            fileData.iconMark = e.target.result;
            tryCallSaveGuide();
        };
        reader.readAsDataURL(iconMarkInput.files[0]);
    }

    // Process mockups
    if (mockupsInput.files && mockupsInput.files.length > 0) {
        fileData.mockups = [];
        let mockupCount = 0;
        Array.from(mockupsInput.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = e => {
                fileData.mockups.push(e.target.result);
                mockupCount++;
                if (mockupCount === mockupsInput.files.length) {
                    tryCallSaveGuide();
                }
            };
            reader.readAsDataURL(file);
        });
    }

    // Process additional assets
    if (assetsInput.files && assetsInput.files.length > 0) {
        fileData.assets = [];
        let assetCount = 0;
        Array.from(assetsInput.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = e => {
                fileData.assets.push({ name: file.name, data: e.target.result });
                assetCount++;
                if (assetCount === assetsInput.files.length) {
                    tryCallSaveGuide();
                }
            };
            reader.readAsDataURL(file);
        });
    }
}

function viewBrandGuide(id) {
    const guide = proofs.find(p => p.id === id);
    if (!guide) return;

    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.id = 'viewBrandGuideModal';
    modal.innerHTML = `
<div class="modal" style="max-width: 900px; max-height: 90vh; overflow: hidden;">
<div class="modal-header" style="background: linear-gradient(135deg, ${guide.brandColors?.[0] || '#e63946'}, ${guide.brandColors?.[1] || '#1d3557'});">
<h3 class="modal-title" style="color: #fff;">${guide.title} - Brand Guide</h3>
<button class="modal-close" onclick="document.getElementById('viewBrandGuideModal').remove()" style="color: #fff;">×</button>
</div>
<div class="modal-body" style="max-height: 70vh; overflow-y: auto; background: #0a0a0a;">
                <!-- Brand Header -->
<div style="text-align: center; padding: 40px 20px; background: linear-gradient(135deg, ${guide.brandColors?.[0]}22, ${guide.brandColors?.[1]}22); border-radius: 12px; margin-bottom: 24px;">
                    ${guide.logo ? `<img alt="Brand guide logo" loading="lazy" src="${guide.logo}" style="max-width: 200px; max-height: 100px; object-fit: contain; margin-bottom: 16px;">` : ''}
<h2 style="font-family: '${guide.fonts?.primary || 'Playfair Display'}', serif; font-size: 32px; margin-bottom: 8px;">${guide.title}</h2>
                    ${guide.tagline ? `<p style="font-family: '${guide.fonts?.secondary || 'Inter'}', sans-serif; font-size: 16px; opacity: 0.8;">${guide.tagline}</p>` : ''}
</div>

                <!-- Color Palette -->
<div style="margin-bottom: 32px;">
<h3 style="margin-bottom: 16px; font-size: 18px;">Color Palette</h3>
<div style="display: flex; gap: 16px; flex-wrap: wrap;">
                        ${guide.brandColors?.map((color, i) => `
<div style="flex: 1; min-width: 120px;">
<div style="width: 100%; height: 80px; background: ${color}; border-radius: 12px; margin-bottom: 8px;"></div>
<p style="font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">${['Primary', 'Secondary', 'Accent'][i]}</p>
<p style="font-family: monospace; font-size: 14px;">${color}</p>
</div>
                        `).join('') || ''}
</div>
</div>

                <!-- Typography -->
<div style="margin-bottom: 32px;">
<h3 style="margin-bottom: 16px; font-size: 18px;">Typography</h3>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 24px;">
<div style="padding: 24px; background: rgba(255,255,255,0.05); border-radius: 12px;">
<p style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">PRIMARY FONT</p>
<p style="font-family: '${guide.fonts?.primary}', serif; font-size: 28px;">${guide.fonts?.primary}</p>
<p style="font-family: '${guide.fonts?.primary}', serif; font-size: 16px; margin-top: 12px;">Aa Bb Cc Dd Ee Ff Gg</p>
</div>
<div style="padding: 24px; background: rgba(255,255,255,0.05); border-radius: 12px;">
<p style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">SECONDARY FONT</p>
<p style="font-family: '${guide.fonts?.secondary}', sans-serif; font-size: 28px;">${guide.fonts?.secondary}</p>
<p style="font-family: '${guide.fonts?.secondary}', sans-serif; font-size: 16px; margin-top: 12px;">Aa Bb Cc Dd Ee Ff Gg</p>
</div>
</div>
</div>

                <!-- Brand Story -->
                ${guide.description ? `
<div style="margin-bottom: 32px;">
<h3 style="margin-bottom: 16px; font-size: 18px;">Brand Story</h3>
<p style="line-height: 1.8; opacity: 0.9;">${guide.description}</p>
</div>
                ` : ''}

                <!-- Assets -->
                ${guide.assets && guide.assets.length > 0 ? `
<div style="margin-bottom: 32px;">
<h3 style="margin-bottom: 16px; font-size: 18px;">Brand Assets</h3>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
                        ${guide.assets.map(asset => `
<div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 12px; text-align: center;">
<img alt="Brand asset thumbnail" loading="lazy" src="${asset.data}" style="max-width: 100%; max-height: 120px; object-fit: contain; margin-bottom: 8px;">
<p style="font-size: 12px; opacity: 0.7;">${asset.name}</p>
</div>
                        `).join('')}
</div>
</div>
                ` : ''}
</div>
<div class="modal-footer">
<button class="btn-admin secondary" onclick="document.getElementById('viewBrandGuideModal').remove()">Close</button>
<button class="btn-admin primary" onclick="downloadBrandGuideAssets(${id})">📥 Download All Assets</button>
<button class="btn-admin primary" onclick="sendBrandGuideToClient(${id})">📧 Send to Client</button>
</div>
</div>
    `;
    document.body.appendChild(modal);
}

function editBrandGuide(id) {
    const guide = proofs.find(p => p.id === id);
    if (!guide) return;
    // Reuse create modal with pre-filled data
    showCreateBrandGuideModal();
    setTimeout(() => {
        document.getElementById('bgBrandName').value = guide.title || '';
        document.getElementById('bgTagline').value = guide.tagline || '';
        document.getElementById('bgColor1').value = guide.brandColors?.[0] || '#e63946';
        document.getElementById('bgColor2').value = guide.brandColors?.[1] || '#1d3557';
        document.getElementById('bgColor3').value = guide.brandColors?.[2] || '#f4a261';
        document.getElementById('bgFontPrimary').value = guide.fonts?.primary || 'Playfair Display';
        document.getElementById('bgFontSecondary').value = guide.fonts?.secondary || 'Inter';
        document.getElementById('bgDescription').value = guide.description || '';
        if (guide.logo) {
            document.getElementById('bgLogoPreview').innerHTML = `<img alt="Brand guide cover logo" loading="lazy" src="${guide.logo}" style="max-width: 200px; max-height: 100px; object-fit: contain; background: #fff; padding: 12px; border-radius: 8px;">`;
        }
        // Update save button to update instead of create
        const saveBtn = document.querySelector('#brandGuideModal .modal-footer .btn-admin.primary');
        saveBtn.textContent = 'Update Brand Guide';
        saveBtn.onclick = () => updateBrandGuide(id);
    }, 100);
}

function updateBrandGuide(id) {
    const guide = proofs.find(p => p.id === id);
    if (!guide) return;

    guide.title = document.getElementById('bgBrandName').value;
    guide.tagline = document.getElementById('bgTagline').value;
    guide.brandColors = [
        document.getElementById('bgColor1').value,
        document.getElementById('bgColor2').value,
        document.getElementById('bgColor3').value
    ];
    guide.fonts = {
        primary: document.getElementById('bgFontPrimary').value,
        secondary: document.getElementById('bgFontSecondary').value
    };
    guide.description = document.getElementById('bgDescription').value;

    saveProofs();
    document.getElementById('brandGuideModal').remove();
    loadAdminBrandGuidePanel();
    alert('Brand Guide updated!');
}

function downloadBrandGuideAssets(id) {
    const guide = proofs.find(p => p.id === id);
    if (!guide) return;

    // Create downloadable content
    const assets = [];
    if (guide.logo) assets.push({ name: 'logo.png', data: guide.logo });
    if (guide.assets) guide.assets.forEach(a => assets.push(a));

    if (assets.length === 0) {
        alert('No assets to download');
        return;
    }

    // Download each asset
    assets.forEach((asset, i) => {
        setTimeout(() => {
            const link = document.createElement('a');
            link.href = asset.data;
            link.download = asset.name || `asset-${i + 1}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }, i * 500);
    });

    alert(`Downloading ${assets.length} asset(s)...`);
}

function sendBrandGuideToClient(id) {
    const guide = proofs.find(p => p.id === id);
    if (!guide) return;

    guide.sentToClient = true;
    guide.sentAt = new Date().toISOString();
    saveProofs();

    alert(`Brand Guide for "${guide.title}" has been marked as sent to client. In production, this would send an email with the brand guide link.`);
    loadAdminBrandGuidePanel();
}

// ==================== MOODBOARD SYSTEM ====================
function loadAdminMoodboardPanel() {
    // Run storage cleanup on panel load to prevent quota issues
    cleanupProofStorage();
    const moodboards = proofs.filter(p => p.type === 'moodboard');
    const pending = moodboards.filter(m => m.status === 'pending').length;
    const approved = moodboards.filter(m => m.status === 'approved').length;
    const drafts = moodboards.filter(m => m.status === 'draft').length;

    const boardCards = moodboards.length === 0 ?
        '<div style="text-align: center; padding: 60px 20px; color: #666;"><div style="font-size: 48px; margin-bottom: 16px;">🎨</div><h3>No Moodboards Yet</h3><p style="margin-top: 8px;">Create your first moodboard to share creative direction with clients.</p></div>' :
        moodboards.map(m => {
            const client = clients.find(c => c.id == m.clientId);
            const previewImages = (m.collageItems || []).filter(i => i.type === 'image').slice(0, 4);
            const colorItems = (m.collageItems || []).filter(i => i.type === 'color').slice(0, 5);
            const statusColors = { draft: '#888', pending: '#ffaa00', approved: '#44ff44', revision: '#ff4444', delivered: '#4488ff' };
            return `
<div style="background: #111; border: 1px solid rgba(255,255,255,0.06); border-radius: 16px; overflow: hidden; cursor: pointer;" onclick="openMoodboardEditor('${m.id}')">
<div style="height: 200px; background: #0a0a0a; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 2px; overflow: hidden;">
                        ${previewImages.map(img => {
                            const isIdb = img.src && img.src.startsWith('idb://');
                            return `<div style="${isIdb ? '' : "background: url('" + img.src + "') center/cover;"} min-height: 98px; background-color: #1a1a1a;" ${isIdb ? 'data-idb-bg="' + img.src + '"' : ''}></div>`;
                        }).join('')}
                        ${previewImages.length === 0 ? '<div style="grid-column: 1/-1; grid-row: 1/-1; display: flex; align-items: center; justify-content: center; color: #444; font-size: 48px;">🎨</div>' : ''}
</div>
<div style="padding: 16px;">
<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
<h4 style="font-size: 15px; font-weight: 600;">${m.title || 'Untitled Moodboard'}</h4>
<span style="padding: 3px 10px; border-radius: 20px; font-size: 11px; background: ${statusColors[m.status] || '#888'}20; color: ${statusColors[m.status] || '#888'};">${m.status}</span>
</div>
<div style="font-size: 13px; color: #888;">${client?.name || 'No Client'}</div>
<div style="display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap;">
                            ${colorItems.map(c => `<div style="width: 20px; height: 20px; border-radius: 50%; background: ${c.color}; border: 2px solid rgba(255,255,255,0.1);"></div>`).join('')}
</div>
<div style="display: flex; gap: 8px; margin-top: 12px;">
                            ${m.status === 'draft' ? `<button onclick="event.stopPropagation(); sendProofToClient('${m.id}')" style="padding: 6px 14px; background: #ff0000; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Send to Client</button>` : ''}
<button onclick="event.stopPropagation(); deleteMoodboard('${m.id}')" style="padding: 6px 14px; background: transparent; border: 1px solid #ff444440; color: #ff4444; border-radius: 6px; cursor: pointer; font-size: 12px;">Delete</button>
</div>
</div>
</div>
            `;
        }).join('');

    document.getElementById('adminMoodboardPanel').innerHTML = `
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
<h2 style="font-size: 28px; font-weight: 700;">🎨 Moodboards</h2>
<button onclick="showCreateMoodboardModal()" style="padding: 12px 24px; background: linear-gradient(135deg, #ff0000, #cc0000); color: #fff; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px;">+ New Moodboard</button>
</div>
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 32px;">
<div style="background: #111; border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 20px; text-align: center;">
<div style="font-size: 28px; font-weight: 700; color: #888;">${drafts}</div>
<div style="font-size: 13px; color: #666;">Drafts</div>
</div>
<div style="background: #111; border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 20px; text-align: center;">
<div style="font-size: 28px; font-weight: 700; color: #ffaa00;">${pending}</div>
<div style="font-size: 13px; color: #666;">Sent / Pending</div>
</div>
<div style="background: #111; border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 20px; text-align: center;">
<div style="font-size: 28px; font-weight: 700; color: #44ff44;">${approved}</div>
<div style="font-size: 13px; color: #666;">Approved</div>
</div>
</div>
<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
            ${boardCards}
</div>
    `;
    // Resolve any idb:// thumbnail backgrounds
    setTimeout(resolveAllImages, 50);
}

function deleteMoodboard(id) {
    if (!confirm('Delete this moodboard?')) return;
    const idx = proofs.findIndex(p => p.id == id);
    if (idx !== -1) { proofs.splice(idx, 1); saveProofs(); }
    loadAdminMoodboardPanel();
}

function showCreateMoodboardModal() {
    const clientOpts = clients.map(c => `<option value="${c.id}">${c.name} — ${c.email}</option>`).join('');
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.id = 'createMoodboardModal';
    modal.style.display = 'flex';
    modal.innerHTML = `
<div class="modal" style="max-width: 500px;">
<div class="modal-header">
<h3 class="modal-title">Create Moodboard</h3>
<button class="modal-close" onclick="document.getElementById('createMoodboardModal').remove()">×</button>
</div>
<div class="modal-body" style="padding: 24px;">
<div class="form-group" style="margin-bottom: 16px;">
<label class="form-label">Client *</label>
<select id="moodboardClient" class="form-input"><option value="">Select client...</option>${clientOpts}</select>
</div>
<div class="form-group" style="margin-bottom: 16px;">
<label class="form-label">Moodboard Title *</label>
<input type="text" id="moodboardTitle" class="form-input" placeholder="e.g. Brand Direction — Modern & Bold">
</div>
<div class="form-group" style="margin-bottom: 16px;">
<label class="form-label">Creative Brief / Notes</label>
<textarea id="moodboardNotes" class="form-input" rows="3" placeholder="Describe the creative direction..."></textarea>
</div>
</div>
<div class="modal-footer">
<button onclick="document.getElementById('createMoodboardModal').remove()" class="btn-outline">Cancel</button>
<button onclick="createMoodboardAndOpenEditor()" class="btn-cta">Create & Open Builder</button>
</div>
</div>
    `;
    document.body.appendChild(modal);
}

function createMoodboardAndOpenEditor() {
    const clientId = document.getElementById('moodboardClient').value;
    const title = document.getElementById('moodboardTitle').value.trim();
    const notes = document.getElementById('moodboardNotes').value.trim();
    if (!clientId || !title) { alert('Client and title are required.'); return; }

    const client = clients.find(c => c.id == clientId);
    const moodboard = {
        id: Date.now(),
        type: 'moodboard',
        clientId: clientId,
        clientName: client?.name || '',
        title: title,
        notes: notes,
        collageItems: [],
        canvasBackground: '#111111',
        canvasWidth: 1200,
        canvasHeight: 800,
        comments: [],
        revisionCount: 0,
        status: 'draft',
        sentToClient: false,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
    };
    proofs.push(moodboard);
    saveProofs();
    document.getElementById('createMoodboardModal').remove();
    openMoodboardEditor(moodboard.id);
}

// ==================== MILANOTE-STYLE MOODBOARD EDITOR ====================

// Canvas state
var _mbZoom = 1;
var _mbPanX = 0;
var _mbPanY = 0;
var _mbIsPanning = false;
var _mbPanStart = { x: 0, y: 0 };
var _mbPanStartOff = { x: 0, y: 0 };
var _mbSpaceHeld = false;
var _mbGridSize = 20;
var _mbSnapOn = true;
var _mbDragging = false;
var _mbDragIdx = -1;
var _mbDragStart = { x: 0, y: 0 };
var _mbItemStart = { x: 0, y: 0 };
var _mbResizing = false;
var _mbResizeIdx = -1;
var _mbResizeStart = { x: 0, y: 0 };
var _mbResizeItemStart = { w: 0, h: 0 };

function snapVal(v) { return _mbSnapOn ? Math.round(v / _mbGridSize) * _mbGridSize : v; }
function escHtml(s) { if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
function escCss(s) { if(!s) return ''; return String(s).replace(/[;"'<>&\\(){}]/g, ''); }

function openMoodboardEditor(id) {
    var mb = proofs.find(function(p) { return p.id == id; });
    if (!mb) { alert('Moodboard not found.'); return; }
    var client = clients.find(function(c) { return c.id == mb.clientId; });
    _mbZoom = 1; _mbPanX = 0; _mbPanY = 0;
    window._mbEditorState = { id: mb.id, selectedItem: null };
    var bgColor = mb.canvasBackground || '#f5f5f5';

    document.getElementById('adminMoodboardPanel').innerHTML = `
<style>
            .ml-wrap{display:flex;flex-direction:column;height:calc(100vh - 180px);background:#fff;border-radius:12px;overflow:hidden;border:1px solid #d4d4d8;font-family:Inter,-apple-system,BlinkMacSystemFont,sans-serif;box-shadow:0 4px 24px rgba(0,0,0,0.08)}
            .ml-head{display:flex;justify-content:space-between;align-items:center;padding:12px 20px;background:linear-gradient(180deg,#fff 0%,#fafafa 100%);border-bottom:1px solid #e4e4e7}
            .ml-head-title{font-size:17px;font-weight:700;color:#18181b;letter-spacing:-0.3px}
            .ml-head-sub{font-size:12px;color:#a1a1aa;margin-top:2px}
            .ml-hbtn{padding:8px 18px;background:#fff;border:1px solid #d4d4d8;color:#3f3f46;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600;transition:all .15s;box-shadow:0 1px 2px rgba(0,0,0,0.04)}
            .ml-hbtn:hover{background:#f4f4f5;border-color:#a1a1aa;box-shadow:0 2px 4px rgba(0,0,0,0.08);transform:translateY(-1px)}
            .ml-hbtn:active{transform:translateY(0);box-shadow:0 1px 2px rgba(0,0,0,0.04)}
            .ml-hbtn-red{background:linear-gradient(180deg,#ef4444,#dc2626);border-color:#dc2626;color:#fff;box-shadow:0 1px 3px rgba(220,38,38,0.3)}
            .ml-hbtn-red:hover{background:linear-gradient(180deg,#dc2626,#b91c1c);box-shadow:0 3px 8px rgba(220,38,38,0.35)}
            .ml-body{display:flex;flex:1;overflow:hidden}

            /* Sidebar */
            .ml-sidebar{width:220px;background:linear-gradient(180deg,#fafafa 0%,#f4f4f5 100%);border-right:1px solid #e4e4e7;display:flex;flex-direction:column;flex-shrink:0;overflow-y:auto}
            .ml-sb-section{padding:18px 16px 8px;font-size:10px;font-weight:700;color:#a1a1aa;text-transform:uppercase;letter-spacing:1.2px}
            .ml-sb-item{display:flex;align-items:center;gap:11px;padding:10px 14px;margin:2px 10px;border-radius:10px;cursor:pointer;color:#52525b;font-size:13px;font-weight:500;transition:all .18s;border:1px solid transparent;user-select:none}
            .ml-sb-item:hover{background:#fff;border-color:#d4d4d8;color:#18181b;box-shadow:0 2px 8px rgba(0,0,0,0.06);transform:translateX(2px)}
            .ml-sb-item:active{transform:scale(0.97) translateX(0);box-shadow:0 0 0 2px rgba(59,130,246,0.3);background:#eff6ff}
            .ml-sb-item[draggable]{cursor:grab}
            .ml-sb-item[draggable]:active{cursor:grabbing}
            .ml-ghost{position:fixed;pointer-events:none;z-index:9999;opacity:0.9;padding:10px 16px;background:#fff;border-radius:10px;box-shadow:0 12px 40px rgba(0,0,0,0.2);font-size:13px;font-weight:600;color:#18181b;display:none}
            .ml-sb-icon{width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
            .ml-sb-sep{height:1px;background:linear-gradient(90deg,transparent,#d4d4d8,transparent);margin:10px 16px}

            /* Canvas */
            .ml-canvas-area{flex:1;overflow:hidden;position:relative;background:#e4e4e7;cursor:default}
            .ml-canvas-area.panning{cursor:grab}
            .ml-canvas{transform-origin:0 0;position:absolute;width:5000px;height:4000px}
            .ml-grid{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;opacity:0.25;background-image:radial-gradient(circle,#a1a1aa 0.5px,transparent 0.5px);background-size:20px 20px}

            /* Cards */
            .ml-card{position:absolute;background:#fff;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.08),0 0 0 1px rgba(0,0,0,0.03);cursor:move;user-select:none;transition:box-shadow .2s,transform .1s}
            .ml-card:hover{box-shadow:0 4px 16px rgba(0,0,0,0.12),0 0 0 1px rgba(0,0,0,0.05)}
            .ml-card.sel{box-shadow:0 0 0 2.5px #3b82f6,0 4px 16px rgba(59,130,246,0.2)}
            .ml-card .ml-rz{position:absolute;width:10px;height:10px;background:#3b82f6;border:2px solid #fff;border-radius:2px;display:none;z-index:5;box-shadow:0 1px 3px rgba(0,0,0,0.2)}
            .ml-card.sel .ml-rz{display:block}
            .ml-rz-se{bottom:-5px;right:-5px;cursor:se-resize}

            /* Image card */
            .ml-img-wrap{width:100%;overflow:hidden;border-radius:8px 8px 0 0;cursor:move}
            .ml-img-wrap img{width:100%;display:block;pointer-events:none}
            .ml-img-caption{padding:10px 14px;font-size:12px;color:#52525b;border:none;background:none;width:100%;outline:none;box-sizing:border-box;min-height:20px;resize:none;font-family:inherit;border-top:1px solid #f4f4f5}
            .ml-img-caption:focus{background:#fafafa}
            .ml-img-caption:empty::before{content:'Add a caption...';color:#d4d4d8}
            .ml-img-caption::placeholder{color:#d4d4d8}

            /* Note card */
            .ml-note{overflow:hidden}
            .ml-note-strip{height:5px;border-radius:8px 8px 0 0}
            .ml-note-handle{height:24px;cursor:move;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(0,0,0,0.02),rgba(0,0,0,0.01));border-bottom:1px solid rgba(0,0,0,0.05);position:relative}
            .ml-note-handle:hover{background:linear-gradient(180deg,rgba(0,0,0,0.04),rgba(0,0,0,0.02))}
            .ml-note-handle::after{content:'';width:28px;height:3px;border-radius:3px;background:rgba(0,0,0,0.12)}
            .ml-note-title{font-size:15px;font-weight:600;color:#18181b;padding:10px 14px 2px;border:none;background:none;width:100%;outline:none;box-sizing:border-box;font-family:inherit}
            .ml-note-title:focus{background:#fafafa}
            .ml-note-body{font-size:13px;color:#52525b;padding:4px 14px 14px;border:none;background:none;width:100%;outline:none;resize:none;min-height:40px;line-height:1.6;box-sizing:border-box;font-family:inherit}
            .ml-note-body:focus{background:#fafafa}
            .ml-note-title::placeholder{color:#d4d4d8}
            .ml-note-body::placeholder{color:#d4d4d8}

            /* Link card */
            .ml-link-domain{font-size:10px;color:#a1a1aa;text-transform:uppercase;letter-spacing:0.5px;display:flex;align-items:center;gap:6px;padding:14px 14px 6px}
            .ml-link-title{font-size:14px;font-weight:600;color:#18181b;padding:0 14px 8px;line-height:1.3}
            .ml-link-url{border-top:1px solid #f4f4f5;padding:10px 14px;font-size:11px}
            .ml-link-url a{color:#3b82f6;text-decoration:none;font-weight:500}
            .ml-link-url a:hover{text-decoration:underline}

            /* Color swatch */
            .ml-swatch-color{width:100%;aspect-ratio:1;border-radius:8px 8px 0 0}
            .ml-swatch-label{padding:8px 10px;font-size:11px;color:#71717a;font-family:'SF Mono',SFMono-Regular,monospace;text-align:center;background:#fff;border-radius:0 0 8px 8px;font-weight:500}

            /* Text card */
            .ml-text-card{background:transparent!important;box-shadow:none!important}
            .ml-text-card:hover{box-shadow:0 0 0 1.5px #3b82f6!important}
            .ml-text-card.sel{box-shadow:0 0 0 2.5px #3b82f6!important}

            /* Footer */
            .ml-foot{display:flex;align-items:center;justify-content:space-between;padding:8px 18px;background:linear-gradient(180deg,#fafafa,#fff);border-top:1px solid #e4e4e7;font-size:11px;color:#a1a1aa}
            .ml-zbtn{width:28px;height:28px;display:flex;align-items:center;justify-content:center;background:#fff;border:1px solid #d4d4d8;color:#52525b;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;transition:all .12s;box-shadow:0 1px 2px rgba(0,0,0,0.04)}
            .ml-zbtn:hover{background:#f4f4f5;color:#18181b;border-color:#a1a1aa;box-shadow:0 2px 4px rgba(0,0,0,0.08)}

            /* Floating panels */
            .ml-float{position:absolute;top:14px;right:14px;width:250px;background:#fff;border:1px solid #e4e4e7;border-radius:12px;padding:16px;z-index:50;display:none;box-shadow:0 8px 32px rgba(0,0,0,0.12),0 0 0 1px rgba(0,0,0,0.03)}
            .ml-float.show{display:block;animation:mlPanelIn .15s ease-out}
            @keyframes mlPanelIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}
            .ml-float h4{font-size:10px;font-weight:700;color:#a1a1aa;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:12px}
            .ml-finput{width:100%;padding:9px 12px;background:#fafafa;border:1px solid #d4d4d8;color:#18181b;border-radius:8px;font-size:12px;margin-bottom:8px;box-sizing:border-box;transition:border-color .15s}
            .ml-finput:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,0.1)}
            .ml-fbtn{width:100%;padding:9px;background:#f4f4f5;border:1px solid #d4d4d8;color:#3f3f46;border-radius:8px;cursor:pointer;font-size:12px;font-weight:500;margin-bottom:6px;transition:all .12s}
            .ml-fbtn:hover{background:#e4e4e7;color:#18181b;border-color:#a1a1aa}
</style>

<div class="ml-wrap">
            <!-- HEADER -->
<div class="ml-head">
<div style="display:flex;align-items:center;gap:14px;">
<button onclick="loadAdminMoodboardPanel()" class="ml-hbtn">\u2190 Back</button>
<div>
<div class="ml-head-title">${mb.title}</div>
<div class="ml-head-sub">${client?.name || 'Client'} \u00b7 ${mb.collageItems.length} items</div>
</div>
</div>
<div style="display:flex;gap:8px;">
<button onclick="saveMoodboardState('${mb.id}')" class="ml-hbtn">\ud83d\udcbe Save</button>
<button onclick="previewMoodboard('${mb.id}')" class="ml-hbtn">\ud83d\udc41 Preview</button>
                    ${mb.status === 'draft' ? `<button onclick="sendProofToClient('${mb.id}'); setTimeout(function(){ openMoodboardEditor('${mb.id}'); }, 500);" class="ml-hbtn ml-hbtn-red">\ud83d\udce4 Send to Client</button>` : `<span style="padding:6px 12px;background:#fff8e1;color:#f59e0b;border-radius:6px;font-size:11px;border:1px solid #fde68a;">Sent \u00b7 ${mb.status}</span>`}
</div>
</div>

            <!-- BODY -->
<div class="ml-body">
                <!-- LEFT SIDEBAR - Milanote-style wide toolbar with labels -->
<div class="ml-sidebar" id="mlSidebar">
<div class="ml-sb-section">Add to Board</div>

<div class="ml-sb-item" draggable="true" onclick="addMoodboardNote('${mb.id}')" ondragstart="mlDragStart(event,'note','${mb.id}')" ondragend="mlDragEnd(event)">
<div class="ml-sb-icon" style="background:#fff3cd;color:#d97706;">\ud83d\udcdd</div>
<div><div style="font-weight:600;">Note</div><div style="font-size:10px;color:#999;">Drag onto board or click</div></div>
</div>

<div class="ml-sb-item" onclick="document.getElementById('mbImageUpload').click()">
<div class="ml-sb-icon" style="background:#dbeafe;color:#2563eb;">\ud83d\uddbc</div>
<div><div style="font-weight:600;">Image</div><div style="font-size:10px;color:#999;">Upload from computer</div></div>
</div>

<div class="ml-sb-item" onclick="mlShowPanel('imageUrl')">
<div class="ml-sb-icon" style="background:#dbeafe;color:#2563eb;">\ud83c\udf10</div>
<div><div style="font-weight:600;">Image URL</div><div style="font-size:10px;color:#999;">Paste a link</div></div>
</div>

<div class="ml-sb-item" onclick="mlShowPanel('imageSearch')">
<div class="ml-sb-icon" style="background:#dbeafe;color:#2563eb;">\ud83d\udd0d</div>
<div><div style="font-weight:600;">Search Photos</div><div style="font-size:10px;color:#999;">Free stock images</div></div>
</div>

<div class="ml-sb-item" onclick="mlShowPanel('link')">
<div class="ml-sb-icon" style="background:#e0e7ff;color:#4f46e5;">\ud83d\udd17</div>
<div><div style="font-weight:600;">Link</div><div style="font-size:10px;color:#999;">Web page preview</div></div>
</div>

<div class="ml-sb-item" onclick="mlShowPanel('text')">
<div class="ml-sb-icon" style="background:#f3e8ff;color:#7c3aed;">T</div>
<div><div style="font-weight:600;">Text</div><div style="font-size:10px;color:#999;">Heading or label</div></div>
</div>

<div class="ml-sb-item" onclick="mlShowPanel('color')">
<div class="ml-sb-icon" style="background:linear-gradient(135deg,#e63946,#f4a261,#2a9d8f);border-radius:50%;">&nbsp;</div>
<div><div style="font-weight:600;">Color Swatch</div><div style="font-size:10px;color:#999;">Palette builder</div></div>
</div>

<div class="ml-sb-item" onclick="mlShowPanel('video')">
<div class="ml-sb-icon" style="background:#fce7f3;color:#db2777;">\u25b6</div>
<div><div style="font-weight:600;">Video</div><div style="font-size:10px;color:#999;">YouTube / Vimeo</div></div>
</div>

<div class="ml-sb-sep"></div>
<div class="ml-sb-section">Templates</div>

<div class="ml-sb-item" onclick="loadMbTemplate('${mb.id}','brand')">
<div class="ml-sb-icon" style="background:#fef2f2;color:#e63946;">\ud83c\udfa8</div>
<div><div style="font-weight:600;">Brand Board</div><div style="font-size:10px;color:#999;">Logo, colors, fonts</div></div>
</div>

<div class="ml-sb-item" onclick="loadMbTemplate('${mb.id}','mood')">
<div class="ml-sb-icon" style="background:#ecfdf5;color:#059669;">\u2728</div>
<div><div style="font-weight:600;">Mood Board</div><div style="font-size:10px;color:#999;">Inspiration layout</div></div>
</div>

<div class="ml-sb-item" onclick="loadMbTemplate('${mb.id}','ui')">
<div class="ml-sb-icon" style="background:#eff6ff;color:#2563eb;">\ud83d\udcf1</div>
<div><div style="font-weight:600;">UI Design</div><div style="font-size:10px;color:#999;">Screens + references</div></div>
</div>

<div class="ml-sb-item" onclick="loadMbTemplate('${mb.id}','photo')">
<div class="ml-sb-icon" style="background:#fefce8;color:#ca8a04;">\ud83d\udcf7</div>
<div><div style="font-weight:600;">Photography</div><div style="font-size:10px;color:#999;">Visual direction</div></div>
</div>

<div class="ml-sb-item" onclick="loadMbTemplate('${mb.id}','interior')">
<div class="ml-sb-icon" style="background:#f0fdf4;color:#16a34a;">\ud83c\udfe0</div>
<div><div style="font-weight:600;">Interior Design</div><div style="font-size:10px;color:#999;">Space + materials</div></div>
</div>

<div class="ml-sb-item" onclick="loadMbTemplate('${mb.id}','fashion')">
<div class="ml-sb-icon" style="background:#fdf2f8;color:#db2777;">\ud83d\udc57</div>
<div><div style="font-weight:600;">Fashion</div><div style="font-size:10px;color:#999;">Style + texture</div></div>
</div>

<div class="ml-sb-sep"></div>
<div class="ml-sb-section">Board</div>

<div class="ml-sb-item" onclick="mlShowPanel('settings')">
<div class="ml-sb-icon" style="background:#f5f5f5;color:#666;">\u2699</div>
<div><div style="font-weight:600;">Settings</div><div style="font-size:10px;color:#999;">Background, grid, notes</div></div>
</div>

                    <!-- Hidden file input -->
<input type="file" id="mbImageUpload" accept="image/*" multiple onchange="addMoodboardImages('${mb.id}')" style="display:none;">
</div>

                <!-- CANVAS -->
<div class="ml-canvas-area" id="mbCanvasWrap"
                     onmousedown="mbEditorMouseDown(event)"
                     onmousemove="mbEditorMouseMove(event)"
                     onmouseup="mbEditorMouseUp(event)"
                     onmouseleave="mbEditorMouseUp(event)"
                     onwheel="mbEditorWheel(event)">

<div id="moodboardCanvas" class="ml-canvas" style="transform:scale(${_mbZoom}) translate(${_mbPanX}px,${_mbPanY}px);background:${bgColor};">
<div class="ml-grid" id="mbGrid" style="${_mbSnapOn ? '' : 'display:none'}"></div>
                        ${renderMoodboardItems(mb)}
</div>

                    <!-- Image URL quick-add (shows when clicking Image if no file selected) -->
<div class="ml-float" id="mlPanel-imageUrl">
<h4>Add Image</h4>
<input type="text" id="mbImageUrl" class="ml-finput" placeholder="Paste image URL and press Enter..." onkeydown="if(event.key==='Enter'){addMoodboardImageUrl('${mb.id}');mlHideAllPanels();}">
<button onclick="addMoodboardImageUrl('${mb.id}');mlHideAllPanels();" class="ml-fbtn">Add from URL</button>
<button onclick="document.getElementById('mbImageUpload').click();mlHideAllPanels();" class="ml-fbtn">Upload from Computer</button>
</div>

<div class="ml-float" id="mlPanel-imageSearch" style="width:320px;">
<h4>Search Free Photos</h4>
<div style="display:flex;gap:6px;margin-bottom:10px;">
<input type="text" id="mbPexelsQuery" class="ml-finput" style="margin:0;flex:1;" placeholder="Search photos..." onkeydown="if(event.key==='Enter') searchPexelsImages('${mb.id}')">
<button onclick="searchPexelsImages('${mb.id}')" class="ml-fbtn" style="width:auto;padding:8px 14px;margin:0;">Search</button>
</div>
<div id="mbPexelsResults" style="display:grid;grid-template-columns:1fr 1fr;gap:6px;max-height:340px;overflow-y:auto;"></div>
<div style="font-size:9px;color:#bbb;margin-top:6px;text-align:center;">Photos by Pexels</div>
</div>

<div class="ml-float" id="mlPanel-link">
<h4>Add Link</h4>
<input type="text" id="mbLinkUrl" class="ml-finput" placeholder="Paste any URL..." onkeydown="if(event.key==='Enter'){addMoodboardLink('${mb.id}');mlHideAllPanels();}">
<button onclick="addMoodboardLink('${mb.id}');mlHideAllPanels();" class="ml-fbtn">Add Link Card</button>
</div>

<div class="ml-float" id="mlPanel-text">
<h4>Add Text</h4>
<input type="text" id="mbTextInput" class="ml-finput" placeholder="Type heading or label..." onkeydown="if(event.key==='Enter'){addMoodboardText('${mb.id}');mlHideAllPanels();}">
<select id="mbFontSelect" class="ml-finput">
<option value="Inter, sans-serif">Inter</option>
<option value="Georgia, serif">Georgia</option>
<option value="Playfair Display, serif">Playfair Display</option>
<option value="Montserrat, sans-serif">Montserrat</option>
</select>
<button onclick="addMoodboardText('${mb.id}');mlHideAllPanels();" class="ml-fbtn">Add Text</button>
</div>

<div class="ml-float" id="mlPanel-color">
<h4>Add Color Swatch</h4>
<div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;">
<input type="color" id="mbColorPicker" value="#e63946" style="width:40px;height:36px;border:none;cursor:pointer;">
<button onclick="addMoodboardColor('${mb.id}');mlHideAllPanels();" class="ml-fbtn" style="margin:0;flex:1;">Add</button>
</div>
<div style="display:grid;grid-template-columns:repeat(6,1fr);gap:6px;">
                            ${['#e63946','#264653','#2a9d8f','#e9c46a','#f4a261','#e76f51','#1d3557','#457b9d','#a8dadc','#606c38','#dda15e','#bc6c25'].map(c => `<div onclick="document.getElementById('mbColorPicker').value='${c}';addMoodboardColor('${mb.id}');mlHideAllPanels();" style="width:100%;aspect-ratio:1;background:${c};border-radius:50%;cursor:pointer;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,0.15);"></div>`).join('')}
</div>
</div>

<div class="ml-float" id="mlPanel-video">
<h4>Add Video</h4>
<input type="text" id="mbVideoUrl" class="ml-finput" placeholder="YouTube or Vimeo URL..." onkeydown="if(event.key==='Enter'){addMoodboardVideo('${mb.id}');mlHideAllPanels();}">
<button onclick="addMoodboardVideo('${mb.id}');mlHideAllPanels();" class="ml-fbtn">Add Video</button>
</div>

<div class="ml-float" id="mlPanel-settings">
<h4>Board Settings</h4>
<label style="font-size:11px;color:#888;display:block;margin-bottom:4px;">Background</label>
<div style="display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap;">
<input type="color" id="mbCanvasBg" value="${bgColor}" onchange="updateCanvasBackground('${mb.id}',this.value)" style="width:32px;height:32px;border:none;cursor:pointer;">
                            ${['#f5f5f5','#ffffff','#f5f0e8','#fafafa','#1a1a1a','#111111'].map(c => `<div onclick="updateCanvasBackground('${mb.id}','${c}')" style="width:32px;height:32px;background:${c};border-radius:4px;cursor:pointer;border:1px solid #ddd;"></div>`).join('')}
</div>
<label style="font-size:11px;color:#888;display:block;margin-bottom:4px;">Grid</label>
<button onclick="_mbSnapOn=!_mbSnapOn;document.getElementById('mbGrid').style.display=_mbSnapOn?'':'none';this.textContent=_mbSnapOn?'Grid: ON':'Grid: OFF'" class="ml-fbtn">${_mbSnapOn ? 'Grid: ON' : 'Grid: OFF'}</button>
<label style="font-size:11px;color:#888;display:block;margin-bottom:4px;margin-top:8px;">Board Notes</label>
<textarea id="mbNotes" class="ml-finput" style="min-height:80px;resize:vertical;">${mb.notes || ''}</textarea>
<button onclick="clearMoodboardStorage('${mb.id}')" class="ml-fbtn" style="color:#e63946;margin-top:4px;">Clear Old Image Data</button>
</div>

                    <!-- Selected item controls -->
<div class="ml-float" id="mlPanel-selected" style="top:auto;bottom:44px;">
<h4>Selected Item</h4>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;">
<button onclick="resizeMbItem(1.15)" class="ml-fbtn">+ Bigger</button>
<button onclick="resizeMbItem(0.85)" class="ml-fbtn">\u2212 Smaller</button>
<button onclick="bringMbItemForward()" class="ml-fbtn">\u2191 Forward</button>
<button onclick="sendMbItemBackward()" class="ml-fbtn">\u2193 Backward</button>
<button onclick="rotateMbItem(15)" class="ml-fbtn">\u21bb Rotate</button>
<button onclick="rotateMbItem(-15)" class="ml-fbtn">\u21ba Rotate</button>
</div>
<button onclick="deleteMbItem()" class="ml-fbtn" style="color:#e63946;border-color:#fecaca;margin-top:6px;">Delete Item</button>
</div>
</div>
</div>

            <!-- FOOTER -->
<div class="ml-foot">
<div>${mb.collageItems.length} items \u00b7 ${client?.name || ''}</div>
<div style="display:flex;align-items:center;gap:6px;">
<button class="ml-zbtn" onclick="mbSetZoom(_mbZoom-0.1)">\u2212</button>
<span id="mbZoomLevel" style="min-width:36px;text-align:center;">${Math.round(_mbZoom*100)}%</span>
<button class="ml-zbtn" onclick="mbSetZoom(_mbZoom+0.1)">+</button>
<button class="ml-zbtn" onclick="mbSetZoom(1);_mbPanX=0;_mbPanY=0;mbUpdateTransform();" style="width:auto;padding:0 8px;font-size:10px;">Reset</button>
<span style="color:#ccc;margin:0 6px;">|</span>
<span style="color:#bbb;font-size:10px;">Space+Drag to pan \u00b7 Scroll to zoom</span>
</div>
</div>
</div>
    `;

    document.removeEventListener('keydown', mbKeyDown);
    document.removeEventListener('keyup', mbKeyUp);
    document.addEventListener('keydown', mbKeyDown);
    document.addEventListener('keyup', mbKeyUp);
    setTimeout(resolveAllImages, 50);
}

// Panel management
// Drag from sidebar onto canvas
var _mlDragType = null;
var _mlDragMbId = null;

function mlDragStart(e, type, mbId) {
    _mlDragType = type;
    _mlDragMbId = mbId;
    e.dataTransfer.setData('text/plain', type);
    e.dataTransfer.effectAllowed = 'copy';
    // Set a small drag image
    var ghost = document.createElement('div');
    ghost.textContent = type === 'note' ? 'Note' : type === 'color' ? 'Color' : type;
    ghost.style.cssText = 'padding:6px 12px;background:#fff;border-radius:6px;font-size:12px;font-weight:600;color:#333;box-shadow:0 2px 8px rgba(0,0,0,0.15);position:absolute;top:-100px;';
    document.body.appendChild(ghost);
    e.dataTransfer.setDragImage(ghost, 30, 15);
    setTimeout(function(){ ghost.remove(); }, 0);
}

function mlDragEnd(e) {
    _mlDragType = null;
    _mlDragMbId = null;
}

// Enable drop on canvas
document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('dragover', function(e) {
        var wrap = document.getElementById('mbCanvasWrap');
        if (wrap && wrap.contains(e.target)) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        }
    });
    document.addEventListener('drop', function(e) {
        var wrap = document.getElementById('mbCanvasWrap');
        if (!wrap || !wrap.contains(e.target)) return;
        e.preventDefault();
        if (!_mlDragType || !_mlDragMbId) return;

        var mb = proofs.find(function(p){return p.id == _mlDragMbId;});
        if (!mb) return;

        // Calculate drop position on canvas
        var rect = document.getElementById('moodboardCanvas').getBoundingClientRect();
        var dropX = (e.clientX - rect.left) / _mbZoom;
        var dropY = (e.clientY - rect.top) / _mbZoom;
        dropX = snapVal(dropX);
        dropY = snapVal(dropY);

        if (_mlDragType === 'note') {
            mb.collageItems.push({
                type:'note', title:'', body:'', stripColor:'#e9c46a',
                x:dropX, y:dropY, width:260, height:160, rotation:0,
                zIndex:mb.collageItems.length+1
            });
        }

        _mlDragType = null;
        _mlDragMbId = null;
        mb.updatedAt = new Date().toISOString();
        saveProofs();
        openMoodboardEditor(mb.id);
    });
});

function mlShowPanel(name) {
    mlHideAllPanels();
    var p = document.getElementById('mlPanel-' + name);
    if (p) p.classList.add('show');
}
function mlHideAllPanels() {
    document.querySelectorAll('.ml-float').forEach(function(p) {
        if (p.id !== 'mlPanel-selected') p.classList.remove('show');
    });
}

// Keyboard
function mbKeyDown(e) {
    if (e.code === 'Space' && !e.target.matches('input,textarea,[contenteditable]')) {
        e.preventDefault(); _mbSpaceHeld = true;
        var w = document.getElementById('mbCanvasWrap');
        if (w) w.classList.add('panning');
    }
    if ((e.code === 'Delete' || e.code === 'Backspace') && !e.target.matches('input,textarea,[contenteditable]')) {
        if (window._mbEditorState && window._mbEditorState.selectedItem != null) {
            e.preventDefault(); deleteMbItem();
        }
    }
}
function mbKeyUp(e) {
    if (e.code === 'Space') {
        _mbSpaceHeld = false;
        var w = document.getElementById('mbCanvasWrap');
        if (w) w.classList.remove('panning');
    }
}

// Zoom
function mbSetZoom(z) {
    _mbZoom = Math.max(0.15, Math.min(3, z));
    mbUpdateTransform();
    var l = document.getElementById('mbZoomLevel');
    if (l) l.textContent = Math.round(_mbZoom*100)+'%';
}
function mbUpdateTransform() {
    var c = document.getElementById('moodboardCanvas');
    if (c) c.style.transform = 'scale('+_mbZoom+') translate('+_mbPanX+'px,'+_mbPanY+'px)';
}
function mbEditorWheel(e) {
    e.preventDefault();
    mbSetZoom(_mbZoom + (e.deltaY > 0 ? -0.08 : 0.08));
}

// Mouse handlers
function mbEditorMouseDown(e) {
    // Pan
    if (_mbSpaceHeld || e.button === 1) {
        _mbIsPanning = true;
        _mbPanStart = { x: e.clientX, y: e.clientY };
        _mbPanStartOff = { x: _mbPanX, y: _mbPanY };
        e.preventDefault(); return;
    }

    // Resize handle (SE corner)
    var rz = e.target.closest('.ml-rz');
    if (rz) {
        var card = rz.closest('.ml-card');
        if (card) {
            var idx = parseInt(card.dataset.idx);
            _mbResizing = true; _mbResizeIdx = idx;
            _mbResizeStart = { x: e.clientX, y: e.clientY };
            var mb = proofs.find(function(p){return p.id==window._mbEditorState.id;});
            if (mb && mb.collageItems[idx]) {
                var ci = mb.collageItems[idx];
                _mbResizeItemStart = { w: ci.width||240, h: ci.height||180 };
            }
            e.preventDefault(); return;
        }
    }

    // Click card to select + start drag
    var card = e.target.closest('.ml-card');
    if (card) {
        if (e.target.matches('input,textarea,[contenteditable]')) return;
        var idx = parseInt(card.dataset.idx);
        window._mbEditorState.selectedItem = idx;
        _mbDragging = true; _mbDragIdx = idx;
        _mbDragStart = { x: e.clientX, y: e.clientY };
        var mb = proofs.find(function(p){return p.id==window._mbEditorState.id;});
        if (mb && mb.collageItems[idx]) {
            _mbItemStart = { x: mb.collageItems[idx].x||0, y: mb.collageItems[idx].y||0 };
        }
        document.querySelectorAll('.ml-card').forEach(function(c){c.classList.remove('sel');c.style.opacity='';});
        card.classList.add('sel');
        card.style.opacity='0.85';
        var sp = document.getElementById('mlPanel-selected');
        if (sp) sp.classList.add('show');
        e.preventDefault(); return;
    }

    // Deselect
    document.querySelectorAll('.ml-card').forEach(function(c){c.classList.remove('sel');});
    window._mbEditorState.selectedItem = null;
    var sp = document.getElementById('mlPanel-selected');
    if (sp) sp.classList.remove('show');
    mlHideAllPanels();
}

function mbEditorMouseMove(e) {
    if (_mbIsPanning) {
        _mbPanX = _mbPanStartOff.x + (e.clientX-_mbPanStart.x)/_mbZoom;
        _mbPanY = _mbPanStartOff.y + (e.clientY-_mbPanStart.y)/_mbZoom;
        mbUpdateTransform(); return;
    }
    if (_mbResizing && _mbResizeIdx >= 0) {
        var mb = proofs.find(function(p){return p.id==window._mbEditorState.id;});
        if (!mb||!mb.collageItems[_mbResizeIdx]) return;
        var ci = mb.collageItems[_mbResizeIdx];
        var dx = (e.clientX-_mbResizeStart.x)/_mbZoom;
        var dy = (e.clientY-_mbResizeStart.y)/_mbZoom;
        ci.width = Math.max(60, snapVal(_mbResizeItemStart.w+dx));
        ci.height = Math.max(40, snapVal(_mbResizeItemStart.h+dy));
        var el = document.querySelector('.ml-card[data-idx="'+_mbResizeIdx+'"]');
        if (el) { el.style.width=ci.width+'px'; if(ci.type!=='note') el.style.height=ci.height+'px'; }
        return;
    }
    if (_mbDragging && _mbDragIdx >= 0) {
        var mb = proofs.find(function(p){return p.id==window._mbEditorState.id;});
        if (!mb||!mb.collageItems[_mbDragIdx]) return;
        var dx = (e.clientX-_mbDragStart.x)/_mbZoom;
        var dy = (e.clientY-_mbDragStart.y)/_mbZoom;
        mb.collageItems[_mbDragIdx].x = snapVal(_mbItemStart.x+dx);
        mb.collageItems[_mbDragIdx].y = snapVal(_mbItemStart.y+dy);
        var el = document.querySelector('.ml-card[data-idx="'+_mbDragIdx+'"]');
        if (el) {
            var ci = mb.collageItems[_mbDragIdx];
            el.style.transform='translate('+ci.x+'px,'+ci.y+'px) rotate('+(ci.rotation||0)+'deg)';
        }
    }
}

function mbEditorMouseUp(e) {
    if (_mbIsPanning) { _mbIsPanning=false; return; }
    if (_mbResizing) {
        _mbResizing=false; _mbResizeIdx=-1;
        var mb=proofs.find(function(p){return p.id==window._mbEditorState.id;});
        if(mb){mb.updatedAt=new Date().toISOString();saveProofs();}
        return;
    }
    if (_mbDragging) {
        var dragEl=document.querySelector('.ml-card[data-idx="'+_mbDragIdx+'"]');
        if(dragEl) dragEl.style.opacity='';
        _mbDragging=false; _mbDragIdx=-1;
        var mb=proofs.find(function(p){return p.id==window._mbEditorState.id;});
        if(mb){mb.updatedAt=new Date().toISOString();saveProofs();}
    }
}

// RENDER ITEMS - Milanote-style cards
function renderMoodboardItems(mb, isPreview) {
    return (mb.collageItems||[]).map(function(item, idx) {
        var tx = 'translate('+(item.x||0)+'px,'+(item.y||0)+'px) rotate('+(item.rotation||0)+'deg)';
        var w = item.width || 240;
        var z = item.zIndex || idx+1;
        var sel = (!isPreview && window._mbEditorState && window._mbEditorState.selectedItem===idx) ? ' sel':'';
        var rz = isPreview ? '' : '<div class="ml-rz ml-rz-se"></div>';

        if (item.type === 'image') {
            var isIdb = item.src && item.src.startsWith('idb://');
            // Show full image at natural aspect ratio
            return '<div class="ml-card'+sel+'" data-idx="'+idx+'" style="transform:'+tx+';width:'+w+'px;z-index:'+z+';padding:0;overflow:hidden;">'+
                rz+
                '<div class="ml-img-wrap">'+
                    '<img alt="Moodboard item" loading="lazy" src="'+(isIdb?'':escHtml(item.src))+'" data-idb-src="'+escHtml(item.src||'')+'" style="width:100%;display:block;'+(isIdb?'min-height:120px;background:#f0f0f0;':'')+'">'+
                '</div>'+
                (isPreview ? (item.caption ? '<div style="padding:8px 12px;font-size:12px;color:#555;">'+escHtml(item.caption)+'</div>' : '') :
                '<textarea class="ml-img-caption" placeholder="Add a caption..." onclick="event.stopPropagation()" onchange="mbUpdateCaption('+idx+',this.value)">'+escHtml(item.caption||'')+'</textarea>')+
            '</div>';

        } else if (item.type === 'note') {
            var stripColor = escCss(item.stripColor || '#e9c46a');
            if (isPreview) {
                return '<div class="ml-card ml-note" style="transform:'+tx+';width:'+w+'px;z-index:'+z+';padding:0;">'+
                    '<div class="ml-note-strip" style="background:'+stripColor+';"></div>'+
                    '<div style="padding:12px 14px 4px;font-size:15px;font-weight:600;color:#1a1a1a;">'+escHtml(item.title||'Untitled')+'</div>'+
                    '<div style="padding:4px 14px 12px;font-size:13px;color:#555;line-height:1.6;">'+escHtml(item.body||'')+'</div>'+
                '</div>';
            }
            return '<div class="ml-card ml-note'+sel+'" data-idx="'+idx+'" style="transform:'+tx+';width:'+w+'px;z-index:'+z+';padding:0;">'+
                rz+
                '<div class="ml-note-strip" style="background:'+stripColor+';" onclick="event.stopPropagation();mbCycleNoteColor('+idx+')"></div>'+
                '<div class="ml-note-handle" title="Drag to move"></div>'+
                '<input class="ml-note-title" value="'+escHtml(item.title||'')+'" placeholder="Title" onchange="mbUpdateNote('+idx+',\'title\',this.value)" onclick="event.stopPropagation()">'+
                '<textarea class="ml-note-body" placeholder="Write something..." onchange="mbUpdateNote('+idx+',\'body\',this.value)" onclick="event.stopPropagation()" oninput="this.style.height=\'auto\';this.style.height=this.scrollHeight+\'px\'">'+escHtml(item.body||'')+'</textarea>'+
            '</div>';

        } else if (item.type === 'link') {
            var domain='';
            try{domain=new URL(item.url).hostname.replace('www.','');}catch(e){domain=item.url||'';}
            return '<div class="ml-card'+sel+'" data-idx="'+idx+'" style="transform:'+tx+';width:'+w+'px;z-index:'+z+';padding:0;overflow:hidden;">'+
                rz+
                '<div class="ml-link-domain">'+
                    '<img alt="Website favicon" loading="lazy" src="https://www.google.com/s2/favicons?domain='+escHtml(domain)+'&sz=32" style="width:14px;height:14px;border-radius:2px;" onerror="this.style.display=\'none\'">'+
                    '<span>'+escHtml(domain)+'</span>'+
                '</div>'+
                '<div class="ml-link-title">'+escHtml(item.title||item.url)+'</div>'+
                '<div class="ml-link-url"><a href="'+escHtml(item.url||'')+'" target="_blank" onclick="event.stopPropagation()">'+escHtml(item.url||'')+'</a></div>'+
            '</div>';

        } else if (item.type === 'color') {
            return '<div class="ml-card'+sel+'" data-idx="'+idx+'" style="transform:'+tx+';width:'+(item.width||80)+'px;z-index:'+z+';padding:0;overflow:hidden;">'+
                rz+
                '<div class="ml-swatch-color" style="background:'+escCss(item.color)+';"></div>'+
                '<div class="ml-swatch-label">'+escHtml(item.color)+'</div>'+
            '</div>';

        } else if (item.type === 'text') {
            return '<div class="ml-card ml-text-card'+sel+'" data-idx="'+idx+'" style="transform:'+tx+';z-index:'+z+';padding:12px 16px;">'+
                rz+
                '<div style="font-family:'+escCss(item.font||'Inter,sans-serif')+';font-size:'+(parseInt(item.fontSize)||28)+'px;color:'+escCss(item.color||'#1a1a1a')+';white-space:nowrap;font-weight:700;">'+escHtml(item.text)+'</div>'+
            '</div>';

        } else if (item.type === 'texture') {
            return '<div class="ml-card'+sel+'" data-idx="'+idx+'" style="transform:'+tx+';width:'+w+'px;height:'+(item.height||150)+'px;z-index:'+z+';padding:0;overflow:hidden;">'+
                rz+
                '<div style="width:100%;height:100%;background:'+escCss(item.pattern)+';border-radius:6px;"></div>'+
            '</div>';

        } else if (item.type === 'video') {
            return '<div class="ml-card'+sel+'" data-idx="'+idx+'" style="transform:'+tx+';width:'+(item.width||320)+'px;height:'+(item.height||220)+'px;z-index:'+z+';padding:0;overflow:hidden;">'+
                rz+
                '<div style="width:100%;height:calc(100% - 32px);position:relative;">'+
                    '<iframe src="'+escHtml(item.embedUrl)+'" style="width:100%;height:100%;border:none;pointer-events:none;" allowfullscreen></iframe>'+
                    '<div style="position:absolute;top:0;left:0;right:0;bottom:0;cursor:move;"></div>'+
                '</div>'+
                '<div style="height:32px;display:flex;align-items:center;padding:0 12px;font-size:11px;color:#888;border-top:1px solid #eee;">\u25b6 '+escHtml(item.title||'Video')+'</div>'+
            '</div>';
        }
        return '';
    }).join('');
}

// Update helpers
function mbUpdateNote(idx, field, value) {
    var mb=proofs.find(function(p){return p.id==window._mbEditorState.id;});
    if(!mb||!mb.collageItems[idx]) return;
    mb.collageItems[idx][field] = value;
    mb.updatedAt=new Date().toISOString(); saveProofs();
}

function mbUpdateCaption(idx, value) {
    var mb=proofs.find(function(p){return p.id==window._mbEditorState.id;});
    if(!mb||!mb.collageItems[idx]) return;
    mb.collageItems[idx].caption = value;
    mb.updatedAt=new Date().toISOString(); saveProofs();
}

var _noteColors = ['#e9c46a','#e63946','#4a90d9','#2a9d8f','#7c3aed','#f4a261','#606c38','#264653'];
function mbCycleNoteColor(idx) {
    var mb=proofs.find(function(p){return p.id==window._mbEditorState.id;});
    if(!mb||!mb.collageItems[idx]) return;
    var current = mb.collageItems[idx].stripColor||'#e9c46a';
    var ci = _noteColors.indexOf(current);
    mb.collageItems[idx].stripColor = _noteColors[(ci+1)%_noteColors.length];
    mb.updatedAt=new Date().toISOString(); saveProofs();
    openMoodboardEditor(mb.id);
}

// Add items
function addMoodboardNote(mbId) {
    var mb=proofs.find(function(p){return p.id==mbId;});
    if(!mb) return;
    mb.collageItems.push({
        type:'note', title:'', body:'', stripColor:'#e9c46a',
        x:100+Math.random()*200, y:100+Math.random()*200,
        width:260, height:160, rotation:0, zIndex:mb.collageItems.length+1
    });
    mb.updatedAt=new Date().toISOString(); saveProofs();
    openMoodboardEditor(mb.id);
}

function addMoodboardLink(mbId) {
    var mb=proofs.find(function(p){return p.id==mbId;});
    if(!mb) return;
    var url=(document.getElementById('mbLinkUrl')?.value||'').trim();
    if(!url){alert('Paste a URL first.');return;}
    if(!url.startsWith('http')) url='https://'+url;
    var domain='',title='';
    try{domain=new URL(url).hostname.replace('www.','');title=domain;}catch(e){title=url;}
    mb.collageItems.push({
        type:'link', url:url, title:title, description:'',
        x:100+Math.random()*200, y:100+Math.random()*200,
        width:280, rotation:0, zIndex:mb.collageItems.length+1
    });
    mb.updatedAt=new Date().toISOString(); saveProofs();
    openMoodboardEditor(mb.id);
}

function addMoodboardImages(mbId) {
    var mb=proofs.find(function(p){return p.id==mbId;});
    if(!mb) return;
    var files=document.getElementById('mbImageUpload').files;
    if(!files.length){
        // No file selected — show URL panel instead
        mlShowPanel('imageUrl');
        return;
    }
    var loaded=0, total=files.length;
    if(typeof showNotification==='function') showNotification('Uploading '+total+' image(s)...','info');

    Array.from(files).forEach(function(file, i) {
        var reader=new FileReader();
        reader.onload=async function(e) {
            // Get natural image dimensions for proper aspect ratio
            var img=new Image();
            img.onload=async function() {
                var natW=img.naturalWidth, natH=img.naturalHeight;
                var cardW=280; // default card width
                var cardH=Math.round(cardW*(natH/natW)); // maintain aspect ratio

                var imgRef;
                try {
                    var compressed=await compressImage(e.target.result, 1200, 0.75);
                    imgRef=await NuiImageStore.saveImage('moodboard', compressed);
                } catch(err) {
                    try{imgRef=await compressImage(e.target.result, 600, 0.6);}catch(e2){imgRef=e.target.result;}
                }
                mb.collageItems.push({
                    type:'image', src:imgRef, caption:'',
                    x:60+(i*40), y:60+(i*40),
                    width:cardW, height:cardH, rotation:0,
                    zIndex:mb.collageItems.length+1
                });
                loaded++;
                if(loaded===total) {
                    mb.updatedAt=new Date().toISOString(); saveProofs();
                    openMoodboardEditor(mb.id);
                    if(typeof showNotification==='function') showNotification(total+' image(s) added!','success');
                }
            };
            img.src=e.target.result;
        };
        reader.readAsDataURL(file);
    });
}

function addMoodboardImageUrl(mbId) {
    var mb=proofs.find(function(p){return p.id==mbId;});
    var url=(document.getElementById('mbImageUrl')?.value||'').trim();
    if(!mb||!url) return;
    // Try to load image to get natural dimensions
    var img=new Image();
    img.crossOrigin='anonymous';
    img.onload=function(){
        var cardW=280, cardH=Math.round(cardW*(img.naturalHeight/img.naturalWidth));
        mb.collageItems.push({
            type:'image', src:url, caption:'',
            x:60+Math.random()*100, y:60+Math.random()*100,
            width:cardW, height:cardH, rotation:0,
            zIndex:mb.collageItems.length+1
        });
        mb.updatedAt=new Date().toISOString(); saveProofs();
        openMoodboardEditor(mb.id);
    };
    img.onerror=function(){
        // If can't load (CORS), use default dimensions
        mb.collageItems.push({
            type:'image', src:url, caption:'',
            x:60+Math.random()*100, y:60+Math.random()*100,
            width:280, height:200, rotation:0,
            zIndex:mb.collageItems.length+1
        });
        mb.updatedAt=new Date().toISOString(); saveProofs();
        openMoodboardEditor(mb.id);
    };
    img.src=url;
}

function addMoodboardColor(mbId) {
    var mb=proofs.find(function(p){return p.id==mbId;});
    if(!mb) return;
    var color=document.getElementById('mbColorPicker')?.value||'#e63946';
    mb.collageItems.push({
        type:'color', color:color,
        x:60+Math.random()*200, y:60+Math.random()*200,
        width:80, height:100, rotation:0,
        zIndex:mb.collageItems.length+1
    });
    mb.updatedAt=new Date().toISOString(); saveProofs();
    openMoodboardEditor(mb.id);
}

function addMoodboardText(mbId) {
    var mb=proofs.find(function(p){return p.id==mbId;});
    if(!mb) return;
    var text=(document.getElementById('mbTextInput')?.value||'').trim();
    var font=document.getElementById('mbFontSelect')?.value||'Inter, sans-serif';
    if(!text){alert('Enter text first.');return;}
    mb.collageItems.push({
        type:'text', text:text, font:font, fontSize:28, color:'#1a1a1a',
        x:100+Math.random()*100, y:100+Math.random()*100,
        rotation:0, zIndex:mb.collageItems.length+1
    });
    mb.updatedAt=new Date().toISOString(); saveProofs();
    openMoodboardEditor(mb.id);
}

function addMoodboardVideo(mbId) {
    var mb=proofs.find(function(p){return p.id==mbId;});
    if(!mb) return;
    var rawUrl=(document.getElementById('mbVideoUrl')?.value||'').trim();
    if(!rawUrl){alert('Paste a video URL first.');return;}
    var embedUrl='', title='Video';
    var ytMatch=rawUrl.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/shorts\/)([a-zA-Z0-9_-]{11})/);
    if(ytMatch){embedUrl='https://www.youtube.com/embed/'+ytMatch[1]+'?rel=0';title='YouTube Video';}
    if(!embedUrl){var vmMatch=rawUrl.match(/(?:vimeo\.com\/)(\d+)/);if(vmMatch){embedUrl='https://player.vimeo.com/video/'+vmMatch[1];title='Vimeo Video';}}
    if(!embedUrl&&(rawUrl.includes('youtube.com/embed/')||rawUrl.includes('player.vimeo.com/'))){embedUrl=rawUrl;}
    if(!embedUrl){alert('Please paste a valid YouTube or Vimeo URL.');return;}
    mb.collageItems.push({
        type:'video', embedUrl:embedUrl, originalUrl:rawUrl, title:title,
        x:60+Math.random()*100, y:60+Math.random()*100,
        width:360, height:240, rotation:0,
        zIndex:mb.collageItems.length+1
    });
    mb.updatedAt=new Date().toISOString(); saveProofs();
    openMoodboardEditor(mb.id);
}

function addMoodboardTexture(mbId, pattern) {
    var mb=proofs.find(function(p){return p.id==mbId;});
    if(!mb) return;
    var patterns={
        'dots':'radial-gradient(circle, #ffffff30 1px, transparent 1px); background-size: 8px 8px',
        'lines':'repeating-linear-gradient(45deg, transparent, transparent 5px, #ffffff15 5px, #ffffff15 6px)',
        'grid':'linear-gradient(#ffffff15 1px, transparent 1px), linear-gradient(90deg, #ffffff15 1px, transparent 1px); background-size: 10px 10px',
        'gradient1':'linear-gradient(135deg, #e63946, #ff6b6b)',
        'gradient2':'linear-gradient(135deg, #457b9d, #1d3557)',
        'gradient3':'linear-gradient(135deg, #2a9d8f, #264653)'
    };
    mb.collageItems.push({
        type:'texture', pattern:patterns[pattern]||patterns.dots,
        x:80+Math.random()*150, y:80+Math.random()*150,
        width:200, height:150, rotation:0,
        zIndex:mb.collageItems.length+1
    });
    mb.updatedAt=new Date().toISOString(); saveProofs();
    openMoodboardEditor(mb.id);
}

// Templates
function loadMbTemplate(mbId, tplName) {
    var mb=proofs.find(function(p){return p.id==mbId;});
    if(!mb) return;
    if(mb.collageItems.length>0 && !confirm('This will replace your current board. Continue?')) return;

    if(tplName==='brand') {
        mb.canvasBackground='#f5f5f5';
        mb.collageItems=[
            {type:'text',text:'Brand Guidelines',font:'Playfair Display, serif',fontSize:36,color:'#1a1a1a',x:60,y:40,rotation:0,zIndex:1},
            {type:'note',title:'Brand Story',body:'Write your brand narrative here...',stripColor:'#e63946',x:60,y:120,width:300,height:160,rotation:0,zIndex:2},
            {type:'note',title:'Typography',body:'Primary: [Font Name]\nSecondary: [Font Name]\nBody: [Font Name]',stripColor:'#264653',x:380,y:120,width:260,height:160,rotation:0,zIndex:3},
            {type:'text',text:'Color Palette',font:'Inter, sans-serif',fontSize:20,color:'#666',x:60,y:320,rotation:0,zIndex:4},
            {type:'color',color:'#e63946',x:60,y:370,width:80,height:100,rotation:0,zIndex:5},
            {type:'color',color:'#264653',x:160,y:370,width:80,height:100,rotation:0,zIndex:6},
            {type:'color',color:'#2a9d8f',x:260,y:370,width:80,height:100,rotation:0,zIndex:7},
            {type:'color',color:'#e9c46a',x:360,y:370,width:80,height:100,rotation:0,zIndex:8},
            {type:'color',color:'#f4a261',x:460,y:370,width:80,height:100,rotation:0,zIndex:9},
            {type:'note',title:'Logo Usage',body:'Place your logo variations here.\nPrimary, secondary, icon-only.',stripColor:'#4a90d9',x:60,y:500,width:300,height:140,rotation:0,zIndex:10},
            {type:'note',title:'Brand Voice',body:'Tone: Professional yet approachable\nStyle: Modern, clean, confident',stripColor:'#2a9d8f',x:380,y:500,width:260,height:140,rotation:0,zIndex:11},
            {type:'text',text:'Imagery & Photography',font:'Inter, sans-serif',fontSize:20,color:'#666',x:60,y:680,rotation:0,zIndex:12},
            {type:'note',title:'Photo Style',body:'Add reference images that capture the brand aesthetic.',stripColor:'#f4a261',x:60,y:730,width:580,height:100,rotation:0,zIndex:13}
        ];
    } else if(tplName==='mood') {
        mb.canvasBackground='#f0ede8';
        mb.collageItems=[
            {type:'text',text:'Moodboard',font:'Playfair Display, serif',fontSize:42,color:'#1a1a1a',x:60,y:40,rotation:0,zIndex:1},
            {type:'note',title:'Concept',body:'Describe the feeling, atmosphere, and direction...',stripColor:'#e9c46a',x:60,y:120,width:300,height:140,rotation:0,zIndex:2},
            {type:'text',text:'Inspiration Images',font:'Inter, sans-serif',fontSize:18,color:'#888',x:60,y:300,rotation:0,zIndex:3},
            {type:'note',title:'Add images here',body:'Upload photos or paste URLs from the sidebar to build your visual mood.',stripColor:'#4a90d9',x:60,y:350,width:280,height:120,rotation:0,zIndex:4},
            {type:'text',text:'Color Direction',font:'Inter, sans-serif',fontSize:18,color:'#888',x:380,y:300,rotation:0,zIndex:5},
            {type:'color',color:'#264653',x:380,y:350,width:70,height:90,rotation:0,zIndex:6},
            {type:'color',color:'#2a9d8f',x:470,y:350,width:70,height:90,rotation:0,zIndex:7},
            {type:'color',color:'#e9c46a',x:560,y:350,width:70,height:90,rotation:0,zIndex:8},
            {type:'note',title:'References & Links',body:'Add web links to reference sites...',stripColor:'#7c3aed',x:380,y:480,width:250,height:120,rotation:0,zIndex:9}
        ];
    } else if(tplName==='ui') {
        mb.canvasBackground='#f8f9fa';
        mb.collageItems=[
            {type:'text',text:'UI Design References',font:'Inter, sans-serif',fontSize:32,color:'#1a1a1a',x:60,y:40,rotation:0,zIndex:1},
            {type:'note',title:'Design System',body:'Components, patterns, and reusable elements.',stripColor:'#4a90d9',x:60,y:110,width:280,height:140,rotation:0,zIndex:2},
            {type:'note',title:'Screen Flows',body:'Add screenshots and wireframes here.',stripColor:'#2a9d8f',x:360,y:110,width:280,height:140,rotation:0,zIndex:3},
            {type:'text',text:'Typography Scale',font:'Inter, sans-serif',fontSize:18,color:'#888',x:60,y:290,rotation:0,zIndex:4},
            {type:'note',title:'Type Hierarchy',body:'H1: 32px Bold\nH2: 24px Semi\nBody: 16px Regular\nCaption: 12px',stripColor:'#264653',x:60,y:340,width:240,height:160,rotation:0,zIndex:5},
            {type:'text',text:'Color Tokens',font:'Inter, sans-serif',fontSize:18,color:'#888',x:360,y:290,rotation:0,zIndex:6},
            {type:'color',color:'#2563eb',x:360,y:340,width:70,height:90,rotation:0,zIndex:7},
            {type:'color',color:'#1a1a1a',x:450,y:340,width:70,height:90,rotation:0,zIndex:8},
            {type:'color',color:'#f5f5f5',x:540,y:340,width:70,height:90,rotation:0,zIndex:9},
            {type:'note',title:'Interaction Patterns',body:'Add links to reference apps and sites.',stripColor:'#7c3aed',x:60,y:540,width:580,height:100,rotation:0,zIndex:10}
        ];
    } else if(tplName==='photo') {
        mb.canvasBackground='#1a1a1a';
        mb.collageItems=[
            {type:'text',text:'Photography Direction',font:'Playfair Display, serif',fontSize:36,color:'#ffffff',x:60,y:40,rotation:0,zIndex:1},
            {type:'note',title:'Shot List',body:'1. Hero shot\n2. Detail close-ups\n3. Environment/context\n4. Lifestyle/in-use\n5. Behind-the-scenes',stripColor:'#e9c46a',x:60,y:120,width:280,height:200,rotation:0,zIndex:2},
            {type:'note',title:'Mood & Lighting',body:'Direction: Natural / Studio / Dramatic\nLighting: Soft / Hard / Golden hour\nPost-processing: Clean / Moody / Film',stripColor:'#4a90d9',x:360,y:120,width:280,height:200,rotation:0,zIndex:3},
            {type:'text',text:'Reference Images',font:'Inter, sans-serif',fontSize:20,color:'#888',x:60,y:360,rotation:0,zIndex:4},
            {type:'note',title:'Add reference photos here',body:'Upload images or search free photos from the sidebar.',stripColor:'#2a9d8f',x:60,y:410,width:580,height:100,rotation:0,zIndex:5},
            {type:'text',text:'Color Grading',font:'Inter, sans-serif',fontSize:20,color:'#888',x:60,y:550,rotation:0,zIndex:6},
            {type:'color',color:'#2c1810',x:60,y:600,width:70,height:90,rotation:0,zIndex:7},
            {type:'color',color:'#d4a574',x:150,y:600,width:70,height:90,rotation:0,zIndex:8},
            {type:'color',color:'#f5e6d3',x:240,y:600,width:70,height:90,rotation:0,zIndex:9}
        ];
    } else if(tplName==='interior') {
        mb.canvasBackground='#f5f0e8';
        mb.collageItems=[
            {type:'text',text:'Interior Concept',font:'Playfair Display, serif',fontSize:36,color:'#1a1a1a',x:60,y:40,rotation:0,zIndex:1},
            {type:'note',title:'Space Overview',body:'Room: \nDimensions: \nStyle: Modern / Traditional / Eclectic\nBudget: ',stripColor:'#264653',x:60,y:120,width:280,height:180,rotation:0,zIndex:2},
            {type:'note',title:'Materials & Finishes',body:'Flooring: \nWalls: \nCountertops: \nHardware: ',stripColor:'#2a9d8f',x:360,y:120,width:280,height:180,rotation:0,zIndex:3},
            {type:'text',text:'Color Palette',font:'Inter, sans-serif',fontSize:20,color:'#666',x:60,y:340,rotation:0,zIndex:4},
            {type:'color',color:'#d4c5a9',x:60,y:390,width:70,height:90,rotation:0,zIndex:5},
            {type:'color',color:'#8b7355',x:150,y:390,width:70,height:90,rotation:0,zIndex:6},
            {type:'color',color:'#2f4f4f',x:240,y:390,width:70,height:90,rotation:0,zIndex:7},
            {type:'color',color:'#f5f0e8',x:330,y:390,width:70,height:90,rotation:0,zIndex:8},
            {type:'note',title:'Furniture & Fixtures',body:'Add product images and links here.',stripColor:'#e9c46a',x:60,y:520,width:280,height:120,rotation:0,zIndex:9},
            {type:'note',title:'Inspiration',body:'Add reference images of spaces you love.',stripColor:'#f4a261',x:360,y:520,width:280,height:120,rotation:0,zIndex:10}
        ];
    } else if(tplName==='fashion') {
        mb.canvasBackground='#fafafa';
        mb.collageItems=[
            {type:'text',text:'Fashion Moodboard',font:'Playfair Display, serif',fontSize:36,color:'#1a1a1a',x:60,y:40,rotation:0,zIndex:1},
            {type:'note',title:'Collection Theme',body:'Season: \nTheme: \nTarget audience: \nKey pieces: ',stripColor:'#db2777',x:60,y:120,width:280,height:180,rotation:0,zIndex:2},
            {type:'note',title:'Fabric & Texture',body:'Add fabric swatches and texture references.',stripColor:'#7c3aed',x:360,y:120,width:280,height:180,rotation:0,zIndex:3},
            {type:'text',text:'Color Story',font:'Inter, sans-serif',fontSize:20,color:'#666',x:60,y:340,rotation:0,zIndex:4},
            {type:'color',color:'#1a1a1a',x:60,y:390,width:70,height:90,rotation:0,zIndex:5},
            {type:'color',color:'#8b0000',x:150,y:390,width:70,height:90,rotation:0,zIndex:6},
            {type:'color',color:'#f5f5dc',x:240,y:390,width:70,height:90,rotation:0,zIndex:7},
            {type:'color',color:'#c0a080',x:330,y:390,width:70,height:90,rotation:0,zIndex:8},
            {type:'note',title:'Styling References',body:'Add lookbook images and styling ideas.',stripColor:'#e63946',x:60,y:520,width:580,height:100,rotation:0,zIndex:9},
            {type:'text',text:'Silhouettes & Shapes',font:'Inter, sans-serif',fontSize:20,color:'#666',x:60,y:660,rotation:0,zIndex:10},
            {type:'note',title:'Key Silhouettes',body:'Sketch or describe the key shapes for this collection.',stripColor:'#264653',x:60,y:710,width:580,height:100,rotation:0,zIndex:11}
        ];
    }

    mb.updatedAt=new Date().toISOString(); saveProofs();
    openMoodboardEditor(mb.id);
    if(typeof showNotification==='function') showNotification('Template loaded!','success');
}

// Pexels image search
function searchPexelsImages(mbId) {
    var query=(document.getElementById('mbPexelsQuery')?.value||'').trim();
    if(!query){alert('Enter a search term.');return;}
    var resultsDiv=document.getElementById('mbPexelsResults');
    if(!resultsDiv) return;
    resultsDiv.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:20px;color:#999;">Searching...</div>';

    // Use Pexels API via backend proxy (key stored server-side)
    fetch('/.netlify/functions/pexels-search?query='+encodeURIComponent(query))
    .then(function(r){return r.json();})
    .then(function(data) {
        if(!data.photos||!data.photos.length) {
            resultsDiv.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:20px;color:#999;">No results found. Try different keywords.</div>';
            return;
        }
        resultsDiv.innerHTML=data.photos.map(function(photo) {
            var safeUrl=escHtml(photo.src.medium);
            var safeThumb=escHtml(photo.src.tiny);
            return '<div onclick="addPexelsImage(\''+mbId+'\',\''+safeUrl+'\','+parseInt(photo.width)||0+','+parseInt(photo.height)||0+')" style="cursor:pointer;border-radius:6px;overflow:hidden;border:1px solid #eee;transition:all .15s;aspect-ratio:1;background:#f5f5f5;" onmouseover="this.style.transform=\'scale(1.03)\';this.style.boxShadow=\'0 2px 8px rgba(0,0,0,0.15)\'" onmouseout="this.style.transform=\'none\';this.style.boxShadow=\'none\'">'+
                '<img alt="Moodboard thumbnail" loading="lazy" src="'+safeThumb+'" style="width:100%;height:100%;object-fit:cover;display:block;">'+
            '</div>';
        }).join('');
    })
    .catch(function(err) {
        resultsDiv.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:20px;color:#e63946;">Search failed. Try again.</div>';
    });
}

function addPexelsImage(mbId, url, natW, natH) {
    var mb=proofs.find(function(p){return p.id==mbId;});
    if(!mb) return;
    var cardW=280, cardH=Math.round(cardW*(natH/natW));
    mb.collageItems.push({
        type:'image', src:url, caption:'Photo by Pexels',
        x:60+Math.random()*100, y:60+Math.random()*100,
        width:cardW, height:cardH, rotation:0,
        zIndex:mb.collageItems.length+1
    });
    mb.updatedAt=new Date().toISOString(); saveProofs();
    openMoodboardEditor(mb.id);
    if(typeof showNotification==='function') showNotification('Image added!','success');
}

// Utility functions
function isLightColor(hex) {
    var c=hex.replace('#','');
    var r=parseInt(c.substr(0,2),16), g=parseInt(c.substr(2,2),16), b=parseInt(c.substr(4,2),16);
    return (r*299+g*587+b*114)/1000>128;
}

function resizeMbItem(factor) {
    var mb=proofs.find(function(p){return p.id==window._mbEditorState.id;});
    var idx=window._mbEditorState.selectedItem;
    if(!mb||idx==null||!mb.collageItems[idx]) return;
    var ci=mb.collageItems[idx];
    if(ci.width) ci.width=Math.round(ci.width*factor);
    if(ci.height) ci.height=Math.round(ci.height*factor);
    if(ci.fontSize) ci.fontSize=Math.round(ci.fontSize*factor);
    saveProofs(); openMoodboardEditor(mb.id);
}

function stretchMbItem(dim, amt) {
    var mb=proofs.find(function(p){return p.id==window._mbEditorState.id;});
    var idx=window._mbEditorState.selectedItem;
    if(!mb||idx==null||!mb.collageItems[idx]) return;
    if(dim==='width') mb.collageItems[idx].width=Math.max(40,(mb.collageItems[idx].width||200)+amt);
    else mb.collageItems[idx].height=Math.max(40,(mb.collageItems[idx].height||150)+amt);
    saveProofs(); openMoodboardEditor(mb.id);
}

function rotateMbItem(deg) {
    var mb=proofs.find(function(p){return p.id==window._mbEditorState.id;});
    var idx=window._mbEditorState.selectedItem;
    if(!mb||idx==null||!mb.collageItems[idx]) return;
    mb.collageItems[idx].rotation=((mb.collageItems[idx].rotation||0)+deg)%360;
    saveProofs(); openMoodboardEditor(mb.id);
}

function bringMbItemForward() {
    var mb=proofs.find(function(p){return p.id==window._mbEditorState.id;});
    var idx=window._mbEditorState.selectedItem;
    if(!mb||idx==null||!mb.collageItems[idx]) return;
    mb.collageItems[idx].zIndex=(mb.collageItems[idx].zIndex||idx+1)+1;
    saveProofs(); openMoodboardEditor(mb.id);
}

function sendMbItemBackward() {
    var mb=proofs.find(function(p){return p.id==window._mbEditorState.id;});
    var idx=window._mbEditorState.selectedItem;
    if(!mb||idx==null||!mb.collageItems[idx]) return;
    mb.collageItems[idx].zIndex=Math.max(1,(mb.collageItems[idx].zIndex||idx+1)-1);
    saveProofs(); openMoodboardEditor(mb.id);
}

function deleteMbItem() {
    var mb=proofs.find(function(p){return p.id==window._mbEditorState.id;});
    var idx=window._mbEditorState.selectedItem;
    if(!mb||idx==null) return;
    mb.collageItems.splice(idx,1);
    window._mbEditorState.selectedItem=null;
    var sp=document.getElementById('mlPanel-selected');
    if(sp) sp.classList.remove('show');
    saveProofs(); openMoodboardEditor(mb.id);
}

function updateCanvasBackground(mbId, color) {
    var mb=proofs.find(function(p){return p.id==mbId;});
    if(!mb) return;
    mb.canvasBackground=color;
    var c=document.getElementById('moodboardCanvas');
    if(c) c.style.background=color;
    var g=document.getElementById('mbGrid');
    if(g){
        var dot=isLightColor(color)?'rgba(0,0,0,0.1)':'rgba(255,255,255,0.1)';
        g.style.backgroundImage='radial-gradient(circle,'+dot+' 0.5px,transparent 0.5px)';
    }
    saveProofs();
}

function saveMoodboardState(mbId) {
    var mb=proofs.find(function(p){return p.id==mbId;});
    if(!mb) return;
    var n=document.getElementById('mbNotes');
    if(n) mb.notes=n.value;
    mb.updatedAt=new Date().toISOString(); saveProofs();

    // AUTO-SEND: If moodboard has content, hasn't been sent yet, and client has a qualifying service package
    if (mb.collageItems && mb.collageItems.length > 0 && !mb.sentToClient && mb.status === 'draft') {
        var client = clients.find(function(c) { return c.id == mb.clientId; });
        var autoSendServices = ['brand_kit', 'product_brand', 'service_brand', 'brand-kit', 'product-brand', 'service-brand', 'brandkit', 'productbrand', 'servicebrand'];
        var clientService = (client && client.servicePackageId) ? client.servicePackageId.toLowerCase() : '';
        var clientServiceName = (client && client.servicePackageName) ? client.servicePackageName.toLowerCase() : '';
        var qualifies = autoSendServices.some(function(s) { return clientService.indexOf(s) !== -1; }) ||
            clientServiceName.indexOf('brand') !== -1 || clientServiceName.indexOf('product') !== -1 || clientServiceName.indexOf('service') !== -1;
        if (qualifies) {
            // Auto-send moodboard to client
            sendProofToClient(mb.id);
            if(typeof showNotification==='function') showNotification('Moodboard saved & auto-sent to client!','success');
            else alert('Moodboard saved & auto-sent to ' + (client?.name || 'client') + '!');
            return;
        }
    }

    if(typeof showNotification==='function') showNotification('Moodboard saved!','success');
    else alert('Moodboard saved!');
}

function clearMoodboardStorage(mbId) {
    if(!confirm('Clear cached image data from old moodboards to free storage?')) return;
    var freed=0;
    proofs.forEach(function(p){
        if(p.type==='moodboard'&&p.collageItems&&p.id!=mbId){
            p.collageItems.forEach(function(item){
                if(item.type==='image'&&item.src&&item.src.startsWith('data:')&&item.src.length>1000){
                    freed+=item.src.length; item.src='[cleared-for-space]';
                }
            });
        }
        if(p.image&&p.image.startsWith('data:')&&p.image.length>5000){
            freed+=p.image.length; p.image='[cleared-for-space]';
        }
    });
    saveProofs();
    var kb=Math.round(freed/1024);
    if(typeof showNotification==='function') showNotification('Freed ~'+kb+'KB!','success');
    else alert('Freed ~'+kb+'KB of storage!');
}

function previewMoodboard(mbId) {
    var mb=proofs.find(function(p){return p.id==mbId;});
    if(!mb) return;
    var client=clients.find(function(c){return c.id==mb.clientId;});
    var bgColor=mb.canvasBackground||'#f5f5f5';

    var html='<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:#000;z-index:10000;overflow-y:auto;">'+
        '<style>.ml-card{position:absolute;background:#fff;border-radius:6px;box-shadow:0 1px 3px rgba(0,0,0,0.08);user-select:none} .ml-img-wrap{overflow:hidden;border-radius:6px 6px 0 0} .ml-img-wrap img{width:100%;display:block} .ml-note-strip{height:4px;border-radius:6px 6px 0 0} .ml-swatch-color{width:100%;aspect-ratio:1;border-radius:6px 6px 0 0} .ml-swatch-label{padding:6px 10px;font-size:11px;color:#666;font-family:monospace;text-align:center} .ml-link-domain{font-size:10px;color:#999;text-transform:uppercase;letter-spacing:0.5px;display:flex;align-items:center;gap:6px;padding:12px 14px 6px} .ml-link-title{font-size:14px;font-weight:600;color:#1a1a1a;padding:0 14px 6px} .ml-link-url{border-top:1px solid #f0f0f0;padding:8px 14px;font-size:11px} .ml-link-url a{color:#4a90d9;text-decoration:none} .ml-text-card{background:transparent!important;box-shadow:none!important}</style>'+
        '<div style="max-width:1200px;margin:0 auto;padding:40px;">'+
            '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:32px;">'+
                '<div><h2 style="font-size:28px;font-weight:700;color:#fff;">'+mb.title+'</h2>'+
                '<p style="color:#888;margin-top:4px;">Prepared for '+(client?.name||'Client')+' by New Urban Influence</p></div>'+
                '<button onclick="this.closest(\'div[style*=fixed]\').remove()" style="padding:10px 20px;background:#333;border:1px solid #555;color:#fff;border-radius:8px;cursor:pointer;">Close</button>'+
            '</div>'+
            (mb.notes?'<div style="background:#111;border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:20px;margin-bottom:24px;"><p style="color:#ccc;line-height:1.6;">'+mb.notes+'</p></div>':'')+
            '<div style="background:'+bgColor+';border-radius:12px;position:relative;width:100%;height:700px;overflow:hidden;border:1px solid rgba(255,255,255,0.06);">'+
                renderMoodboardItems(mb, true)+
            '</div>'+
        '</div>'+
    '</div>';
    document.body.insertAdjacentHTML('beforeend', html);
    setTimeout(resolveAllImages, 50);
}

// ==================== PAYMENTS PANEL ====================
function loadAdminPaymentsPanel() {
    const totalRevenue = payments.reduce((sum, p) => sum + (p.amount || 0), 0);
    const pendingPayments = payments.filter(p => p.status === 'pending');
    const completedPayments = payments.filter(p => p.status === 'completed');

    document.getElementById('adminPaymentsPanel').innerHTML = `
<div class="panel-header">
<h2 class="panel-title">💳 Payments</h2>
<p class="panel-subtitle">Track payments, auto-pay schedules, and revenue</p>
</div>

        <!-- Stats Cards -->
<div class="stats-grid">
<div class="stat-card">
<div class="stat-label">Total Revenue</div>
<div class="stat-value">$${totalRevenue.toLocaleString()}</div>
</div>
<div class="stat-card">
<div class="stat-label">Pending</div>
<div class="stat-value" style="color: #f4a261;">${pendingPayments.length}</div>
</div>
<div class="stat-card">
<div class="stat-label">Completed</div>
<div class="stat-value" style="color: #2a9d8f;">${completedPayments.length}</div>
</div>
<div class="stat-card">
<div class="stat-label">This Month</div>
<div class="stat-value">$${payments.filter(p => new Date(p.date).getMonth() === new Date().getMonth()).reduce((s, p) => s + (p.amount || 0), 0).toLocaleString()}</div>
</div>
</div>

<div style="display: flex; justify-content: flex-end; margin-bottom: 24px; gap: 12px;">
<button class="btn-admin secondary" onclick="showPaymentPlansInfo()">📋 Payment Plan Info</button>
<button class="btn-admin primary" onclick="showRecordPaymentModal()">+ Record Payment</button>
</div>

        <!-- Auto-Pay Schedules -->
<div class="form-section">
<div class="form-section-title">⚡ Active Auto-Pay Schedules</div>
<div id="autoPaySchedules">
                ${renderAutoPaySchedules()}
</div>
</div>

        <!-- Recent Payments -->
<div class="form-section">
<div class="form-section-title">💰 Payment History</div>
<table class="data-table">
<thead>
<tr>
<th>Date</th>
<th>Client</th>
<th>Project</th>
<th>Amount</th>
<th>Type</th>
<th>Status</th>
<th>Actions</th>
</tr>
</thead>
<tbody>
                    ${payments.length === 0 ? '<tr><td colspan="7" style="text-align: center; opacity: 0.5;">No payments recorded yet</td></tr>' : ''}
                    ${payments.sort((a, b) => new Date(b.date) - new Date(a.date)).map(payment => `
<tr>
<td>${new Date(payment.date).toLocaleDateString()}</td>
<td>${payment.clientName || 'N/A'}</td>
<td>${payment.projectName || 'N/A'}</td>
<td style="font-weight: 600; color: #2a9d8f;">$${payment.amount?.toLocaleString() || 0}</td>
<td><span class="tag">${payment.type || 'One-time'}</span></td>
<td><span class="status-badge ${payment.status}">${payment.status}</span></td>
<td>
<button class="btn-admin small" onclick="viewPaymentDetails(${payment.id})">View</button>
                                ${payment.status === 'pending' ? `<button class="btn-admin small primary" onclick="markPaymentComplete(${payment.id})">Mark Paid</button>` : ''}
</td>
</tr>
                    `).join('')}
</tbody>
</table>
</div>
    `;
}

function renderAutoPaySchedules() {
    const projectsWithAutoPay = projects.filter(p => p.paymentPlan && p.paymentPlan !== 'full');

    if (projectsWithAutoPay.length === 0) {
        return '<p style="color: rgba(255,255,255,0.5);">No active auto-pay schedules. Create a project with a payment plan to see schedules here.</p>';
    }

    return `
<div class="card-grid">
            ${projectsWithAutoPay.map(project => {
                const plan = paymentPlans[project.paymentPlan];
                const paidInstallments = project.paidInstallments || 0;
                const totalAmount = project.totalAmount || 0;

                return `
<div class="client-card">
<div class="client-card-header" style="background: linear-gradient(135deg, #2a9d8f, #264653);">
                            ${project.name?.charAt(0) || 'P'}
</div>
<div class="client-card-body">
<div class="client-card-name">${project.name}</div>
<div class="client-card-meta">${project.clientName || 'Client'}<br>Plan: ${plan?.name || 'Standard'}</div>
<div style="margin: 12px 0;">
<div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
<span style="font-size: 12px;">Progress</span>
<span style="font-size: 12px;">${paidInstallments}/${plan?.installments || 3} payments</span>
</div>
<div style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
<div style="background: var(--red); height: 100%; width: ${(paidInstallments / (plan?.installments || 3)) * 100}%; transition: width 0.3s;"></div>
</div>
</div>
<div style="font-size: 13px; color: rgba(255,255,255,0.7);">
                                ${plan?.schedule?.map((pct, i) => `
<div style="display: flex; justify-content: space-between; padding: 4px 0; ${i < paidInstallments ? 'text-decoration: line-through; opacity: 0.5;' : ''}">
<span>${plan.triggers?.[i] || `Payment ${i + 1}`}</span>
<span>$${Math.round(totalAmount * pct / 100).toLocaleString()} (${pct}%)</span>
</div>
                                `).join('') || ''}
</div>
</div>
</div>
                `;
            }).join('')}
</div>
    `;
}

function showPaymentPlansInfo() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.id = 'paymentPlansModal';
    modal.innerHTML = `
<div class="modal" style="max-width: 700px;">
<div class="modal-header">
<h3 class="modal-title">Payment Plan Options</h3>
<button class="modal-close" onclick="document.getElementById('paymentPlansModal').remove()">×</button>
</div>
<div class="modal-body">
<div style="display: grid; gap: 16px;">
                    ${Object.entries(paymentPlans).map(([key, plan]) => `
<div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; border-left: 4px solid var(--red);">
<h4 style="margin-bottom: 8px;">${plan.name} ${plan.discount > 0 ? `<span style="color: #2a9d8f;">(${plan.discount}% discount)</span>` : ''}</h4>
<p style="font-size: 14px; opacity: 0.7; margin-bottom: 12px;">${plan.installments} installment(s)</p>
<div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                ${plan.schedule.map((pct, i) => `
<div style="background: rgba(255,255,255,0.1); padding: 8px 16px; border-radius: 8px; text-align: center;">
<div style="font-size: 18px; font-weight: 600;">${pct}%</div>
<div style="font-size: 11px; opacity: 0.6;">${plan.triggers?.[i] || `Payment ${i + 1}`}</div>
</div>
                                `).join('')}
</div>
</div>
                    `).join('')}
</div>
</div>
<div class="modal-footer">
<button class="btn-admin primary" onclick="document.getElementById('paymentPlansModal').remove()">Got It</button>
</div>
</div>
    `;
    document.body.appendChild(modal);
}

function showRecordPaymentModal() {
    const allClients = window.clients || [];
    const allProjects = window.projects || [];
    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.id = 'recordPaymentModal';
    modal.innerHTML = `
<div class="modal" style="background: #1a1a1a; color: #fff;">
<div class="modal-header" style="border-bottom: 1px solid rgba(255,255,255,0.1);">
<h3 class="modal-title" style="color: #fff;">💳 Record Payment</h3>
<button class="modal-close" onclick="document.getElementById('recordPaymentModal').remove()" style="color: #fff;">×</button>
</div>
<div class="modal-body">
<div class="form-group">
<label class="form-label" style="color: #fff;">Client *</label>
<select id="paymentClient" class="form-select" onchange="loadClientProjects(this.value)" style="background: #252525; color: #fff; border: 1px solid rgba(255,255,255,0.2);">
<option value="">-- Select Client --</option>
                        ${allClients.map(c => `<option value="${c.id}">${c.name}${c.company ? ' - ' + c.company : ''}</option>`).join('')}
</select>
</div>
<div class="form-group">
<label class="form-label" style="color: #fff;">Project</label>
<select id="paymentProject" class="form-select" style="background: #252525; color: #fff; border: 1px solid rgba(255,255,255,0.2);">
<option value="">-- Select Project (select client first) --</option>
                        ${allProjects.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
</select>
</div>
<div class="form-group">
<label class="form-label" style="color: #fff;">Amount *</label>
<input type="number" id="paymentAmount" class="form-input" placeholder="0.00" step="0.01" style="background: #252525; color: #fff; border: 1px solid rgba(255,255,255,0.2);">
</div>
<div class="form-group">
<label class="form-label" style="color: #fff;">Payment Type</label>
<select id="paymentType" class="form-select" style="background: #252525; color: #fff; border: 1px solid rgba(255,255,255,0.2);">
<option value="deposit">Deposit (50%)</option>
<option value="approval">Approval Payment (25%)</option>
<option value="final">Final Payment (25%)</option>
<option value="full">Full Payment</option>
<option value="monthly">Monthly Payment</option>
<option value="other">Other</option>
</select>
</div>
<div class="form-group">
<label class="form-label" style="color: #fff;">Date</label>
<input type="date" id="paymentDate" class="form-input" value="${new Date().toISOString().split('T')[0]}" style="background: #252525; color: #fff; border: 1px solid rgba(255,255,255,0.2);">
</div>
<div class="form-group">
<label class="form-label" style="color: #fff;">Notes</label>
<textarea id="paymentNotes" class="form-textarea" rows="2" placeholder="Payment notes..." style="background: #252525; color: #fff; border: 1px solid rgba(255,255,255,0.2);"></textarea>
</div>
</div>
<div class="modal-footer" style="border-top: 1px solid rgba(255,255,255,0.1);">
<button class="btn-admin secondary" onclick="document.getElementById('recordPaymentModal').remove()" style="background: #333; color: #fff;">Cancel</button>
<button class="btn-admin primary" onclick="savePayment()" style="background: var(--red); color: #fff;">Record Payment</button>
</div>
</div>
    `;
    document.body.appendChild(modal);
}

function loadClientProjects(clientId) {
    const allProjects = window.projects || [];
    const clientProjects = clientId ? allProjects.filter(p => p.clientId == clientId) : allProjects;
    const select = document.getElementById('paymentProject');
    if (select) {
        select.innerHTML = `
<option value="">-- Select Project --</option>
            ${clientProjects.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
        `;
    }
}

function savePayment() {
    const clientSelect = document.getElementById('paymentClient');
    const projectSelect = document.getElementById('paymentProject');
    const allClients = window.clients || [];
    const client = allClients.find(c => c.id == clientSelect.value);
    const project = (window.projects || []).find(p => p.id == projectSelect.value);

    const payment = {
        id: Date.now(),
        clientId: clientSelect.value,
        clientName: client?.name || 'Unknown',
        projectId: projectSelect.value,
        projectName: project?.name || 'N/A',
        amount: parseFloat(document.getElementById('paymentAmount').value) || 0,
        type: document.getElementById('paymentType').value,
        date: document.getElementById('paymentDate').value,
        notes: document.getElementById('paymentNotes').value,
        status: 'completed',
        createdAt: new Date().toISOString()
    };

    payments.push(payment);
    savePayments();

    // Update project paid installments if applicable
    if (project && project.paymentPlan) {
        project.paidInstallments = (project.paidInstallments || 0) + 1;
        saveProjects();
    }

    document.getElementById('recordPaymentModal').remove();
    loadAdminPaymentsPanel();
    alert('Payment recorded successfully!');
}

function markPaymentComplete(id) {
    const payment = payments.find(p => p.id === id);
    if (payment) {
        payment.status = 'completed';
        payment.completedAt = new Date().toISOString();
        savePayments();
        loadAdminPaymentsPanel();
    }
}

function viewPaymentDetails(id) {
    const payment = payments.find(p => p.id === id);
    if (!payment) return;

    alert(`Payment Details:\n\nClient: ${payment.clientName}\nProject: ${payment.projectName}\nAmount: $${payment.amount}\nType: ${payment.type}\nDate: ${payment.date}\nStatus: ${payment.status}\nNotes: ${payment.notes || 'None'}`);
}

// ==================== INVOICES PANEL ====================
function loadAdminInvoicesPanel(searchTerm = '', statusFilter = '') {
    let filtered = invoices;

    if (searchTerm) {
        filtered = filtered.filter(i =>
            (i.invoiceNumber || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
            (i.clientName || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
            (i.projectName || '').toLowerCase().includes(searchTerm.toLowerCase())
        );
    }

    if (statusFilter) {
        filtered = filtered.filter(i => i.status === statusFilter);
    }

    const totalInvoiced = invoices.reduce((sum, i) => sum + (i.total || 0), 0);
    const pendingInvoices = invoices.filter(i => i.status === 'pending' || i.status === 'sent');
    const paidInvoices = invoices.filter(i => i.status === 'paid');

    document.getElementById('adminInvoicesPanel').innerHTML = `
<div class="panel-header">
<h2 class="panel-title">📄 Invoices</h2>
<p class="panel-subtitle">Create, send, and track invoices</p>
</div>

        <!-- Stats Cards -->
<div class="stats-grid">
<div class="stat-card">
<div class="stat-label">Total Invoiced</div>
<div class="stat-value">$${totalInvoiced.toLocaleString()}</div>
</div>
<div class="stat-card">
<div class="stat-label">Pending</div>
<div class="stat-value" style="color: #f4a261;">${pendingInvoices.length}</div>
</div>
<div class="stat-card">
<div class="stat-label">Paid</div>
<div class="stat-value" style="color: #2a9d8f;">${paidInvoices.length}</div>
</div>
<div class="stat-card">
<div class="stat-label">Outstanding</div>
<div class="stat-value" style="color: #e63946;">$${pendingInvoices.reduce((s, i) => s + (i.total || 0), 0).toLocaleString()}</div>
</div>
</div>

        <!-- Search, Filter, and Actions Bar -->
<div style="display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; align-items: center;">
<input type="text" id="invoiceSearch" placeholder="Search invoices..." value="${searchTerm}"
                oninput="loadAdminInvoicesPanel(this.value, document.getElementById('invoiceStatusFilter').value)"
                style="flex: 1; min-width: 200px; padding: 12px 16px; border: 1px solid #e5e5e5; border-radius: 8px; font-size: 14px;">
<select id="invoiceStatusFilter" onchange="loadAdminInvoicesPanel(document.getElementById('invoiceSearch').value, this.value)"
                style="padding: 12px 16px; border: 1px solid #e5e5e5; border-radius: 8px; font-size: 14px; background: #fff;">
<option value="" ${!statusFilter ? 'selected' : ''}>All Status</option>
<option value="draft" ${statusFilter === 'draft' ? 'selected' : ''}>Draft</option>
<option value="sent" ${statusFilter === 'sent' ? 'selected' : ''}>Sent</option>
<option value="pending" ${statusFilter === 'pending' ? 'selected' : ''}>Pending</option>
<option value="paid" ${statusFilter === 'paid' ? 'selected' : ''}>Paid</option>
<option value="overdue" ${statusFilter === 'overdue' ? 'selected' : ''}>Overdue</option>
</select>
<button onclick="selectAllInvoices()" style="padding: 10px 16px; background: #f3f4f6; border: 1px solid #e5e5e5; border-radius: 8px; cursor: pointer;">Select All</button>
<button onclick="deleteSelectedInvoices()" style="padding: 10px 16px; background: #fee2e2; color: #dc2626; border: none; border-radius: 8px; cursor: pointer;">Delete Selected</button>
<button onclick="exportInvoicesCSV()" style="padding: 10px 16px; background: #f3f4f6; border: 1px solid #e5e5e5; border-radius: 8px; cursor: pointer;">Export CSV</button>
<button class="btn-admin primary" onclick="showCreateInvoiceModal()">+ Create Invoice</button>
</div>

        <!-- Invoices Table -->
<div class="form-section">
<div class="form-section-title">📋 ${filtered.length} of ${invoices.length} Invoices</div>
<table class="data-table">
<thead>
<tr>
<th style="width: 40px;"><input type="checkbox" id="selectAllInvoicesHeader" onchange="toggleAllInvoiceCheckboxes(this.checked)"></th>
<th>Invoice #</th>
<th>Client</th>
<th>Project</th>
<th>Amount</th>
<th>Date</th>
<th>Due Date</th>
<th>Status</th>
<th>Actions</th>
</tr>
</thead>
<tbody>
                    ${filtered.length === 0 ? '<tr><td colspan="9" style="text-align: center; opacity: 0.5;">No invoices found</td></tr>' : ''}
                    ${filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).map(invoice => `
<tr>
<td><input type="checkbox" class="invoice-checkbox" data-id="${invoice.id}"></td>
<td style="font-weight: 600;">#${invoice.invoiceNumber || invoice.id}</td>
<td>${invoice.clientName || 'N/A'}</td>
<td>${invoice.projectName || 'N/A'}</td>
<td style="font-weight: 600;">$${(invoice.total || 0).toLocaleString()}</td>
<td>${new Date(invoice.createdAt).toLocaleDateString()}</td>
<td>${invoice.dueDate ? new Date(invoice.dueDate).toLocaleDateString() : 'N/A'}</td>
<td><span class="status-badge ${invoice.status}">${invoice.status}</span></td>
<td>
<button class="btn-admin small" onclick="viewInvoice(${invoice.id})">View</button>
<button class="btn-admin small" onclick="downloadInvoice(${invoice.id})">PDF</button>
                                ${invoice.status !== 'paid' ? '<button class="btn-admin small primary" onclick="markInvoicePaid(' + invoice.id + ')">Mark Paid</button>' : ''}
<button class="btn-admin small danger" onclick="deleteInvoice(${invoice.id})" style="background: #fee2e2; color: #dc2626;">×</button>
</td>
</tr>
                    `).join('')}
</tbody>
</table>
</div>
    `;
}

// Toggle all invoice checkboxes
function toggleAllInvoiceCheckboxes(checked) {
    document.querySelectorAll('.invoice-checkbox').forEach(cb => cb.checked = checked);
}

// Select all invoices button
function selectAllInvoices() {
    const checkboxes = document.querySelectorAll('.invoice-checkbox');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    checkboxes.forEach(cb => cb.checked = !allChecked);
    const headerCb = document.getElementById('selectAllInvoicesHeader');
    if (headerCb) headerCb.checked = !allChecked;
}

// Bulk delete invoices
function deleteSelectedInvoices() {
    const checkboxes = document.querySelectorAll('.invoice-checkbox:checked');
    if (checkboxes.length === 0) {
        alert('Please select at least one invoice to delete.');
        return;
    }

    if (!confirm('Are you sure you want to delete ' + checkboxes.length + ' invoice(s)? This cannot be undone.')) return;

    const idsToDelete = Array.from(checkboxes).map(cb => parseInt(cb.dataset.id));
    invoices = invoices.filter(i => !idsToDelete.includes(i.id));
    saveInvoices();

    const search = document.getElementById('invoiceSearch')?.value || '';
    const status = document.getElementById('invoiceStatusFilter')?.value || '';
    loadAdminInvoicesPanel(search, status);
    alert(idsToDelete.length + ' invoice(s) deleted successfully.');
}

// Export invoices to CSV
function exportInvoicesCSV() {
    if (invoices.length === 0) {
        alert('No invoices to export.');
        return;
    }

    const headers = ['Invoice #', 'Client', 'Project', 'Amount', 'Status', 'Created Date', 'Due Date', 'Paid Date'];
    const rows = invoices.map(i => [
        i.invoiceNumber || i.id,
        i.clientName || '',
        i.projectName || '',
        i.total || 0,
        i.status || '',
        i.createdAt || '',
        i.dueDate || '',
        i.paidAt || ''
    ]);

    const csv = [headers.join(','), ...rows.map(r => r.map(v => '"' + String(v).replace(/"/g, '""') + '"').join(','))].join('\n');
    downloadCSV(csv, 'nui-invoices-' + new Date().toISOString().split('T')[0] + '.csv');
}

function showCreateInvoiceModal() {
    const allClients = window.clients || [];
    const allProjects = window.projects || [];
    const invoiceNumber = `INV-${new Date().getFullYear()}-${String(invoices.length + 1).padStart(4, '0')}`;

    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.id = 'createInvoiceModal';
    modal.innerHTML = `
<div class="modal" style="max-width: 800px; background: #1a1a1a; color: #fff;">
<div class="modal-header" style="border-bottom: 1px solid rgba(255,255,255,0.1);">
<h3 class="modal-title" style="color: #fff;">📄 Create Invoice</h3>
<button class="modal-close" onclick="document.getElementById('createInvoiceModal').remove()" style="color: #fff;">×</button>
</div>
<div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
<div class="form-row">
<div class="form-group">
<label class="form-label" style="color: #fff;">Invoice Number</label>
<input type="text" id="invoiceNumber" class="form-input" value="${invoiceNumber}" readonly style="background: #252525; color: #fff; border: 1px solid rgba(255,255,255,0.2);">
</div>
<div class="form-group">
<label class="form-label" style="color: #fff;">Due Date</label>
<input type="date" id="invoiceDueDate" class="form-input" value="${new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]}" style="background: #252525; color: #fff; border: 1px solid rgba(255,255,255,0.2);">
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label" style="color: #fff;">Client *</label>
<select id="invoiceClient" class="form-select" onchange="loadInvoiceClientProjects(this.value)" style="background: #252525; color: #fff; border: 1px solid rgba(255,255,255,0.2);">
<option value="">-- Select Client --</option>
                            ${allClients.map(c => `<option value="${c.id}">${c.name}${c.company ? ' - ' + c.company : ''}</option>`).join('')}
</select>
</div>
<div class="form-group">
<label class="form-label" style="color: #fff;">Project</label>
<select id="invoiceProject" class="form-select" onchange="populateInvoiceFromProject(this.value)" style="background: #252525; color: #fff; border: 1px solid rgba(255,255,255,0.2);">
<option value="">-- Select Project --</option>
                            ${allProjects.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
</select>
</div>
</div>

                <!-- Quick Add Service/Package -->
<div class="form-section" style="margin-top: 24px; background: rgba(255,59,48,0.15); padding: 16px; border-radius: 8px; border: 1px solid rgba(255,59,48,0.3);">
<div class="form-section-title" style="color: var(--red); font-weight: 600;">⚡ Quick Add Service/Package</div>
<div class="form-row">
<div class="form-group">
<label class="form-label" style="color: #fff;">Packages</label>
<select id="quickAddPackage" class="form-select" onchange="quickAddServiceToInvoice('package', this.value)" style="background: #252525; color: #fff; border: 1px solid rgba(255,255,255,0.2);">
<option value="">-- Select Package --</option>
                                ${servicePackages.map(p => '<option value="' + p.id + '">' + p.name + ' - $' + p.price + ' (' + p.turnaround + ')</option>').join('')}
</select>
</div>
<div class="form-group">
<label class="form-label" style="color: #fff;">Individual Services</label>
<select id="quickAddService" class="form-select" onchange="quickAddServiceToInvoice('service', this.value)" style="background: #252525; color: #fff; border: 1px solid rgba(255,255,255,0.2);">
<option value="">-- Select Service --</option>
                                ${individualServices.map(s => '<option value="' + s.id + '">' + s.name + ' - $' + s.price + '</option>').join('')}
</select>
</div>
</div>
<button onclick="showCreateProductModal()" class="btn-admin" style="margin-top: 12px; background: #10b981; color: #fff; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer;">➕ Create New Product/Service</button>
</div>

<div class="form-section" style="margin-top: 24px;">
<div class="form-section-title">Line Items</div>
<div id="invoiceLineItems">
<div class="invoice-line-item" style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 12px; margin-bottom: 12px; align-items: end;">
<div class="form-group" style="margin: 0;">
<label class="form-label">Description</label>
<input type="text" class="form-input line-desc" placeholder="Service description">
</div>
<div class="form-group" style="margin: 0;">
<label class="form-label">Qty</label>
<input type="number" class="form-input line-qty" value="1" min="1" onchange="calculateInvoiceTotal()">
</div>
<div class="form-group" style="margin: 0;">
<label class="form-label">Rate</label>
<input type="number" class="form-input line-rate" placeholder="0.00" step="0.01" onchange="calculateInvoiceTotal()">
</div>
<div class="form-group" style="margin: 0;">
<label class="form-label">Amount</label>
<input type="text" class="form-input line-amount" readonly value="$0.00">
</div>
<button class="btn-admin small" onclick="removeInvoiceLine(this)" style="margin-bottom: 4px;">×</button>
</div>
</div>
<button class="btn-admin secondary" onclick="addInvoiceLine()" style="margin-top: 12px;">+ Add Line Item</button>
</div>

                <!-- Discount Section -->
<div class="form-section" style="margin-top: 24px; background: rgba(46,204,113,0.1); padding: 16px; border-radius: 8px;">
<div class="form-section-title" style="color: #2ecc71;">💰 Discount</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Discount Type</label>
<select id="discountType" class="form-select" onchange="calculateInvoiceTotal()">
<option value="none">No Discount</option>
<option value="percent">Percentage (%)</option>
<option value="fixed">Fixed Amount ($)</option>
<option value="loyalty">Loyalty Reward</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Discount Value</label>
<input type="number" id="discountValue" class="form-input" value="0" min="0" step="0.01" onchange="calculateInvoiceTotal()">
</div>
<div class="form-group">
<label class="form-label">Discount Code (Optional)</label>
<input type="text" id="discountCode" class="form-input" placeholder="SAVE10">
</div>
</div>
</div>

<div style="display: flex; justify-content: flex-end; margin-top: 24px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
<div style="text-align: right; min-width: 200px;">
<div style="font-size: 14px; opacity: 0.7; margin-bottom: 8px;">Subtotal: <span id="invoiceSubtotal">$0.00</span></div>
<div style="font-size: 14px; color: #2ecc71; margin-bottom: 8px;" id="discountLine" style="display: none;">Discount: -<span id="invoiceDiscount">$0.00</span></div>
<div style="font-size: 24px; font-weight: 600;">Total: <span id="invoiceTotal" style="color: var(--red);">$0.00</span></div>
</div>
</div>

<div class="form-group" style="margin-top: 24px;">
<label class="form-label">Notes</label>
<textarea id="invoiceNotes" class="form-textarea" rows="3" placeholder="Payment terms, additional notes...">Payment due within 30 days. Thank you for your business!</textarea>
</div>
</div>
<div class="modal-footer">
<button class="btn-admin secondary" onclick="document.getElementById('createInvoiceModal').remove()">Cancel</button>
<button class="btn-admin primary" onclick="saveInvoice()">Create Invoice</button>
</div>
</div>
    `;
    document.body.appendChild(modal);
}

function addInvoiceLine() {
    const container = document.getElementById('invoiceLineItems');
    const lineItem = document.createElement('div');
    lineItem.className = 'invoice-line-item';
    lineItem.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 12px; margin-bottom: 12px; align-items: end;';
    lineItem.innerHTML = `
<div class="form-group" style="margin: 0;">
<input type="text" class="form-input line-desc" placeholder="Service description">
</div>
<div class="form-group" style="margin: 0;">
<input type="number" class="form-input line-qty" value="1" min="1" onchange="calculateInvoiceTotal()">
</div>
<div class="form-group" style="margin: 0;">
<input type="number" class="form-input line-rate" placeholder="0.00" step="0.01" onchange="calculateInvoiceTotal()">
</div>
<div class="form-group" style="margin: 0;">
<input type="text" class="form-input line-amount" readonly value="$0.00">
</div>
<button class="btn-admin small" onclick="removeInvoiceLine(this)" style="margin-bottom: 4px;">×</button>
    `;
    container.appendChild(lineItem);
}

function removeInvoiceLine(btn) {
    const lines = document.querySelectorAll('.invoice-line-item');
    if (lines.length > 1) {
        btn.closest('.invoice-line-item').remove();
        calculateInvoiceTotal();
    }
}

function calculateInvoiceTotal() {
    let subtotal = 0;
    document.querySelectorAll('.invoice-line-item').forEach(line => {
        const qty = parseFloat(line.querySelector('.line-qty').value) || 0;
        const rate = parseFloat(line.querySelector('.line-rate').value) || 0;
        const amount = qty * rate;
        line.querySelector('.line-amount').value = '$' + amount.toFixed(2);
        subtotal += amount;
    });

    // Calculate discount
    const discountType = document.getElementById('discountType')?.value || 'none';
    const discountValue = parseFloat(document.getElementById('discountValue')?.value) || 0;
    let discount = 0;

    if (discountType === 'percent') {
        discount = subtotal * (discountValue / 100);
    } else if (discountType === 'fixed') {
        discount = discountValue;
    } else if (discountType === 'loyalty') {
        // Apply loyalty points (each point = $1)
        discount = discountValue;
    }

    discount = Math.min(discount, subtotal); // Can't discount more than subtotal
    const total = subtotal - discount;

    document.getElementById('invoiceSubtotal').textContent = '$' + subtotal.toFixed(2);
    document.getElementById('invoiceTotal').textContent = '$' + total.toFixed(2);

    // Show/hide discount line
    const discountLine = document.getElementById('discountLine');
    const discountDisplay = document.getElementById('invoiceDiscount');
    if (discountLine && discountDisplay) {
        if (discount > 0) {
            discountLine.style.display = 'block';
            discountDisplay.textContent = '$' + discount.toFixed(2);
        } else {
            discountLine.style.display = 'none';
        }
    }

    return { subtotal, discount, total };
}

// Quick add service/package to invoice
function quickAddServiceToInvoice(type, id) {
    if (!id) return;

    let item;
    if (type === 'package') {
        item = servicePackages.find(p => p.id === id);
    } else {
        item = individualServices.find(s => s.id === id);
    }

    if (!item) return;

    // Add as new line item
    const container = document.getElementById('invoiceLineItems');
    const lineItem = document.createElement('div');
    lineItem.className = 'invoice-line-item';
    lineItem.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 12px; margin-bottom: 12px; align-items: end;';
    lineItem.innerHTML = `
<div class="form-group" style="margin: 0;">
<input type="text" class="form-input line-desc" value="${item.name}${item.turnaround ? ' (' + item.turnaround + ')' : ''}">
</div>
<div class="form-group" style="margin: 0;">
<input type="number" class="form-input line-qty" value="1" min="1" onchange="calculateInvoiceTotal()">
</div>
<div class="form-group" style="margin: 0;">
<input type="number" class="form-input line-rate" value="${item.price}" step="0.01" onchange="calculateInvoiceTotal()">
</div>
<div class="form-group" style="margin: 0;">
<input type="text" class="form-input line-amount" readonly value="$${item.price.toFixed(2)}">
</div>
<button class="btn-admin small" onclick="removeInvoiceLine(this)" style="margin-bottom: 4px;">×</button>
    `;
    container.appendChild(lineItem);
    calculateInvoiceTotal();

    // Reset dropdown
    document.getElementById(type === 'package' ? 'quickAddPackage' : 'quickAddService').value = '';
}

function loadInvoiceClientProjects(clientId) {
    const clientProjects = projects.filter(p => p.clientId == clientId);
    const select = document.getElementById('invoiceProject');
    select.innerHTML = `
<option value="">-- Select Project --</option>
        ${clientProjects.map(p => `<option value="${p.id}">${p.name} - $${p.totalAmount || 0}</option>`).join('')}
    `;
}

function populateInvoiceFromProject(projectId) {
    const project = projects.find(p => p.id == projectId);
    if (!project) return;

    // Find the package or service
    const pkg = servicePackages.find(p => p.id === project.packageId || p.name === project.package);

    // Clear existing lines and add project line
    document.getElementById('invoiceLineItems').innerHTML = `
<div class="invoice-line-item" style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 12px; margin-bottom: 12px; align-items: end;">
<div class="form-group" style="margin: 0;">
<label class="form-label">Description</label>
<input type="text" class="form-input line-desc" value="${project.name} - ${pkg?.name || project.package || 'Custom Project'}">
</div>
<div class="form-group" style="margin: 0;">
<label class="form-label">Qty</label>
<input type="number" class="form-input line-qty" value="1" min="1" onchange="calculateInvoiceTotal()">
</div>
<div class="form-group" style="margin: 0;">
<label class="form-label">Rate</label>
<input type="number" class="form-input line-rate" value="${project.totalAmount || pkg?.price || 0}" step="0.01" onchange="calculateInvoiceTotal()">
</div>
<div class="form-group" style="margin: 0;">
<label class="form-label">Amount</label>
<input type="text" class="form-input line-amount" readonly value="$${project.totalAmount || pkg?.price || 0}">
</div>
<button class="btn-admin small" onclick="removeInvoiceLine(this)" style="margin-bottom: 4px;">×</button>
</div>
    `;
    calculateInvoiceTotal();
}

function saveInvoice() {
    const clientSelect = document.getElementById('invoiceClient');
    const projectSelect = document.getElementById('invoiceProject');
    const client = (crmData.clients || []).find(c => c.id == clientSelect.value);
    const project = projects.find(p => p.id == projectSelect.value);

    const lineItems = [];
    document.querySelectorAll('.invoice-line-item').forEach(line => {
        lineItems.push({
            description: line.querySelector('.line-desc').value,
            qty: parseFloat(line.querySelector('.line-qty').value) || 0,
            rate: parseFloat(line.querySelector('.line-rate').value) || 0,
            amount: parseFloat(line.querySelector('.line-amount').value.replace('$', '')) || 0
        });
    });

    const total = lineItems.reduce((sum, item) => sum + item.amount, 0);

    const invoice = {
        id: Date.now(),
        invoiceNumber: document.getElementById('invoiceNumber').value,
        clientId: clientSelect.value,
        clientName: client?.name || 'Unknown',
        clientEmail: client?.email || '',
        projectId: projectSelect.value,
        projectName: project?.name || 'N/A',
        lineItems: lineItems,
        subtotal: total,
        total: total,
        dueDate: document.getElementById('invoiceDueDate').value,
        notes: document.getElementById('invoiceNotes').value,
        status: 'pending',
        createdAt: new Date().toISOString()
    };

    invoices.push(invoice);
    saveInvoices();

    document.getElementById('createInvoiceModal').remove();
    loadAdminInvoicesPanel();
    alert('Invoice created successfully!');
}

function viewInvoice(id) {
    const invoice = invoices.find(i => i.id === id);
    if (!invoice) return;

    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.id = 'viewInvoiceModal';
    modal.innerHTML = `
<div class="modal" style="max-width: 700px;">
<div class="modal-header" style="background: var(--red);">
<h3 class="modal-title" style="color: #fff;">Invoice ${invoice.invoiceNumber}</h3>
<button class="modal-close" onclick="document.getElementById('viewInvoiceModal').remove()" style="color: #fff;">×</button>
</div>
<div class="modal-body" style="background: #fff; color: #1a1a1a;">
<div style="display: flex; justify-content: space-between; margin-bottom: 32px;">
<div>
<h2 style="color: var(--red); margin-bottom: 8px;">NEW URBAN INFLUENCE</h2>
<p style="font-size: 14px; opacity: 0.7;">Detroit, MI<br>newurbaninfluence@gmail.com</p>
</div>
<div style="text-align: right;">
<p style="font-size: 14px;"><strong>Invoice #:</strong> ${invoice.invoiceNumber}</p>
<p style="font-size: 14px;"><strong>Date:</strong> ${new Date(invoice.createdAt).toLocaleDateString()}</p>
<p style="font-size: 14px;"><strong>Due:</strong> ${invoice.dueDate ? new Date(invoice.dueDate).toLocaleDateString() : 'N/A'}</p>
</div>
</div>

<div style="margin-bottom: 24px; padding: 16px; background: #f5f5f5; border-radius: 8px;">
<p style="font-weight: 600; margin-bottom: 4px;">Bill To:</p>
<p>${invoice.clientName}</p>
<p style="font-size: 14px; opacity: 0.7;">${invoice.clientEmail || ''}</p>
</div>

<table style="width: 100%; border-collapse: collapse; margin-bottom: 24px;">
<thead>
<tr style="border-bottom: 2px solid #1a1a1a;">
<th style="text-align: left; padding: 12px 8px;">Description</th>
<th style="text-align: center; padding: 12px 8px;">Qty</th>
<th style="text-align: right; padding: 12px 8px;">Rate</th>
<th style="text-align: right; padding: 12px 8px;">Amount</th>
</tr>
</thead>
<tbody>
                        ${invoice.lineItems?.map(item => `
<tr style="border-bottom: 1px solid #eee;">
<td style="padding: 12px 8px;">${item.description}</td>
<td style="text-align: center; padding: 12px 8px;">${item.qty}</td>
<td style="text-align: right; padding: 12px 8px;">$${item.rate?.toFixed(2)}</td>
<td style="text-align: right; padding: 12px 8px;">$${item.amount?.toFixed(2)}</td>
</tr>
                        `).join('') || ''}
</tbody>
</table>

<div style="display: flex; justify-content: flex-end;">
<div style="width: 250px;">
<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
<span>Subtotal:</span>
<span>$${invoice.subtotal?.toFixed(2)}</span>
</div>
<div style="display: flex; justify-content: space-between; padding: 12px 0; font-size: 20px; font-weight: 600;">
<span>Total:</span>
<span style="color: var(--red);">$${invoice.total?.toFixed(2)}</span>
</div>
</div>
</div>

                ${invoice.notes ? `
<div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid #eee;">
<p style="font-weight: 600; margin-bottom: 8px;">Notes:</p>
<p style="font-size: 14px; opacity: 0.7;">${invoice.notes}</p>
</div>
                ` : ''}

<div style="text-align: center; margin-top: 32px; padding: 16px; background: ${invoice.status === 'paid' ? '#d4edda' : '#fff3cd'}; border-radius: 8px;">
<span style="font-weight: 600; text-transform: uppercase; color: ${invoice.status === 'paid' ? '#155724' : '#856404'};">
                        ${invoice.status === 'paid' ? '✓ PAID' : '⏳ ' + invoice.status.toUpperCase()}
</span>
</div>
</div>
<div class="modal-footer">
<button class="btn-admin secondary" onclick="document.getElementById('viewInvoiceModal').remove()">Close</button>
<button class="btn-admin primary" onclick="downloadInvoice(${id})">📥 Download PDF</button>
                ${invoice.status !== 'paid' ? `<button class="btn-admin primary" onclick="sendInvoiceToClient(${id})">📧 Send to Client</button>` : ''}
</div>
</div>
    `;
    document.body.appendChild(modal);
}

function markInvoicePaid(id) {
    const invoice = invoices.find(i => i.id === id);
    if (invoice) {
        invoice.status = 'paid';
        invoice.paidAt = new Date().toISOString();
        saveInvoices();

        // Record the payment
        const payment = {
            id: Date.now(),
            clientId: invoice.clientId,
            clientName: invoice.clientName,
            projectId: invoice.projectId,
            projectName: invoice.projectName,
            amount: invoice.total,
            type: 'invoice',
            date: new Date().toISOString().split('T')[0],
            notes: `Payment for Invoice ${invoice.invoiceNumber}`,
            status: 'completed',
            invoiceId: invoice.id,
            createdAt: new Date().toISOString()
        };
        payments.push(payment);
        savePayments();

        // Trigger workflow: Update loyalty points and order status
        triggerInvoicePaid(id);

        loadAdminInvoicesPanel();
        alert('Invoice marked as paid and payment recorded!');
    }
}

function deleteInvoice(id) {
    if (!confirm('Are you sure you want to delete this invoice? This cannot be undone.')) return;
    invoices = invoices.filter(i => i.id !== id);
    saveInvoices();
    loadAdminInvoicesPanel();
}

function downloadInvoice(id) {
    const invoice = invoices.find(i => i.id === id);
    if (!invoice) return;

    // Create a printable version
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
<html>
<head>
<title>Invoice ${invoice.invoiceNumber}</title>
<style>
                body { font-family: Arial, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }
                .header { display: flex; justify-content: space-between; margin-bottom: 40px; }
                .company { color: #e63946; font-size: 24px; font-weight: bold; }
                table { width: 100%; border-collapse: collapse; margin: 24px 0; }
                th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
                th { border-bottom: 2px solid #333; }
                .total-row { font-size: 20px; font-weight: bold; }
                .notes { margin-top: 32px; padding-top: 16px; border-top: 1px solid #eee; }
                @media print { body { padding: 20px; } }
</style>
    <!-- Geo Meta Tags -->
    <meta name="geo.region" content="US-MI">
    <meta name="geo.placename" content="Detroit, Michigan">
    <meta name="geo.position" content="42.3314;-83.0458">
    <meta name="ICBM" content="42.3314, -83.0458">
</head>
<body>
<div class="header">
<div>
<div class="company">NEW URBAN INFLUENCE</div>
<p>Detroit, MI<br>newurbaninfluence@gmail.com</p>
</div>
<div style="text-align: right;">
<p><strong>Invoice #:</strong> ${invoice.invoiceNumber}</p>
<p><strong>Date:</strong> ${new Date(invoice.createdAt).toLocaleDateString()}</p>
<p><strong>Due:</strong> ${invoice.dueDate ? new Date(invoice.dueDate).toLocaleDateString() : 'N/A'}</p>
</div>
</div>
<div style="background: #f5f5f5; padding: 16px; margin-bottom: 24px;">
<strong>Bill To:</strong><br>${invoice.clientName}<br>${invoice.clientEmail || ''}
</div>
<table>
<thead><tr><th>Description</th><th>Qty</th><th style="text-align: right;">Rate</th><th style="text-align: right;">Amount</th></tr></thead>
<tbody>
                    ${invoice.lineItems?.map(item => `<tr><td>${item.description}</td><td>${item.qty}</td><td style="text-align: right;">$${item.rate?.toFixed(2)}</td><td style="text-align: right;">$${item.amount?.toFixed(2)}</td></tr>`).join('') || ''}
</tbody>
</table>
<div style="text-align: right;">
<p>Subtotal: $${invoice.subtotal?.toFixed(2)}</p>
<p class="total-row">Total: $${invoice.total?.toFixed(2)}</p>
</div>
            ${invoice.notes ? `<div class="notes"><strong>Notes:</strong><br>${invoice.notes}</div>` : ''}
<scr` + `ipt>window.print();</scr` + `ipt>
</body>
</html>
    `);
    printWindow.document.close();
}

async function sendInvoiceToClient(id) {
    const invoice = invoices.find(i => i.id === id);
    if (!invoice) return;

    const client = clients.find(c => c.id == invoice.clientId);
    const clientEmail = client?.email || invoice.clientEmail;
    if (!clientEmail) { alert('No email found for this client.'); return; }

    invoice.status = 'sent';
    invoice.sentAt = new Date().toISOString();
    saveInvoices();

    // Build line items HTML
    const lineItemsHtml = (invoice.lineItems || []).map(item =>
        `<tr><td style="padding: 10px 16px; border-bottom: 1px solid #eee; font-size: 14px;">${item.description || item.name}</td><td style="padding: 10px 16px; border-bottom: 1px solid #eee; text-align: center; font-size: 14px;">${item.quantity || 1}</td><td style="padding: 10px 16px; border-bottom: 1px solid #eee; text-align: right; font-size: 14px;">$${(item.amount || item.price || 0).toLocaleString()}</td></tr>`
    ).join('');

    // Send real email
    try {
        await fetch('/.netlify/functions/send-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                to: clientEmail,
                subject: `Invoice ${invoice.invoiceNumber || '#' + invoice.id} from New Urban Influence`,
                html: `
<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #ffffff;">
<div style="background: linear-gradient(135deg, #ff0000, #cc0000); padding: 32px; text-align: center;">
<h2 style="color: #fff; margin: 0; font-size: 24px;">INVOICE</h2>
<p style="color: rgba(255,255,255,0.8); margin: 8px 0 0; font-size: 14px;">${invoice.invoiceNumber || '#' + invoice.id}</p>
</div>
<div style="padding: 32px;">
<p style="font-size: 16px; color: #333;">Hi ${invoice.clientName || client?.name || 'there'},</p>
<p style="font-size: 14px; color: #666; line-height: 1.6;">Please find your invoice from New Urban Influence below. ${invoice.dueDate ? 'Payment is due by <strong>' + new Date(invoice.dueDate).toLocaleDateString() + '</strong>.' : ''}</p>

                            ${invoice.projectName ? '<p style="font-size: 14px; color: #666;"><strong>Project:</strong> ' + invoice.projectName + '</p>' : ''}

<table style="width: 100%; border-collapse: collapse; margin: 24px 0;">
<thead>
<tr style="background: #f8f8f8;">
<th style="padding: 10px 16px; text-align: left; font-size: 12px; text-transform: uppercase; color: #888;">Description</th>
<th style="padding: 10px 16px; text-align: center; font-size: 12px; text-transform: uppercase; color: #888;">Qty</th>
<th style="padding: 10px 16px; text-align: right; font-size: 12px; text-transform: uppercase; color: #888;">Amount</th>
</tr>
</thead>
<tbody>
                                    ${lineItemsHtml || '<tr><td colspan="3" style="padding: 16px; text-align: center; color: #888;">Service package</td></tr>'}
</tbody>
</table>

<div style="text-align: right; padding: 16px; background: #f8f8f8; border-radius: 8px;">
<span style="font-size: 14px; color: #666;">Total Due: </span>
<span style="font-size: 28px; font-weight: 700; color: #ff0000;">$${(invoice.total || invoice.amount || 0).toLocaleString()}</span>
</div>

<div style="text-align: center; margin-top: 32px;">
<a href="${typeof window !== 'undefined' ? window.location.origin : 'https://newurbaninfluence.com'}" style="display: inline-block; padding: 14px 32px; background: #ff0000; color: #fff; text-decoration: none; border-radius: 8px; font-weight: 600;">View Invoice & Pay</a>
</div>

<p style="font-size: 12px; color: #999; margin-top: 32px; text-align: center;">New Urban Influence · Detroit, MI · (248) 487-8747</p>
</div>
</div>
                `,
                text: `Invoice ${invoice.invoiceNumber || '#' + invoice.id} from New Urban Influence. Total: $${(invoice.total || invoice.amount || 0).toLocaleString()}. Log in to your client portal to view and pay.`
            })
        });
        alert(`Invoice ${invoice.invoiceNumber || '#' + invoice.id} sent to ${clientEmail}!`);
    } catch (err) {
        console.error('Email send failed:', err);
        alert(`Invoice marked as sent, but email delivery failed. You may need to resend.`);
    }

    // Log to CRM
    if (typeof logProofActivity === 'function') {
        logProofActivity('invoice_sent', invoice.clientName || 'Client', `Invoice ${invoice.invoiceNumber || '#' + invoice.id} sent — $${(invoice.total || 0).toLocaleString()}`);
    }

    if (document.getElementById('viewInvoiceModal')) {
        document.getElementById('viewInvoiceModal').remove();
    }
    loadAdminInvoicesPanel();
}

// ==================== PAYOUTS PANEL ====================
let payoutSettings = JSON.parse(localStorage.getItem('nui_payouts')) || {
    designerRate: 40, // percentage
    profitMargin: 60,
    payoutSchedule: 'biweekly', // weekly, biweekly, monthly
    minimumPayout: 100,
    stripeEnabled: false
};
function savePayoutSettings() { localStorage.setItem('nui_payouts', JSON.stringify(payoutSettings)); }

let designerPayouts = JSON.parse(localStorage.getItem('nui_designer_payouts')) || [];
function saveDesignerPayouts() { localStorage.setItem('nui_designer_payouts', JSON.stringify(designerPayouts)); }

function loadAdminPayoutsPanel() {
    const designers = JSON.parse(localStorage.getItem('nui_designers')) || [];
    const completedOrders = orders.filter(o => o.status === 'delivered' && o.assignedDesigner);

    // Calculate earnings
    const totalRevenue = orders.filter(o => o.paymentStatus === 'paid').reduce((sum, o) => sum + (o.estimate || 0), 0);
    const designerPayout = Math.round(totalRevenue * (payoutSettings.designerRate / 100));
    const profit = totalRevenue - designerPayout;

    // Calculate per-designer earnings
    const designerEarnings = {};
    completedOrders.forEach(o => {
        if (o.assignedDesigner) {
            if (!designerEarnings[o.assignedDesigner]) {
                designerEarnings[o.assignedDesigner] = { orders: 0, total: 0, paid: 0, pending: 0 };
            }
            const designerCut = Math.round((o.estimate || 0) * (payoutSettings.designerRate / 100));
            designerEarnings[o.assignedDesigner].orders++;
            designerEarnings[o.assignedDesigner].total += designerCut;
            if (o.designerPaid) {
                designerEarnings[o.assignedDesigner].paid += designerCut;
            } else {
                designerEarnings[o.assignedDesigner].pending += designerCut;
            }
        }
    });

    // Monthly recurring revenue from subscriptions
    const monthlyRecurring = subscriptions.filter(s => s.status === 'active').reduce((sum, s) => sum + (s.price || 0), 0);
    const totalIncome = totalRevenue + monthlyRecurring;

    document.getElementById('adminPayoutsPanel').innerHTML = `
<div class="panel-header" style="display:flex;justify-content:space-between;align-items:center;">
<div>
<h2 class="panel-title">💰 Payouts & Profit</h2>
<p class="panel-subtitle">Revenue breakdown, designer payouts, and profit tracking</p>
</div>
<button onclick="openPayoutSettingsModal()" style="padding:10px 20px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);color:#fff;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;">⚙️ Settings</button>
</div>

        <!-- Profit Overview -->
<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:28px;">
<div style="background:linear-gradient(135deg,#10b981,#059669);padding:24px;border-radius:14px;">
<div style="font-size:12px;color:rgba(255,255,255,0.75);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Total Revenue</div>
<div style="font-size:32px;font-weight:700;color:#fff;">$${totalRevenue.toLocaleString()}</div>
<div style="font-size:12px;color:rgba(255,255,255,0.6);margin-top:6px;">From paid orders</div>
</div>
<div style="background:linear-gradient(135deg,#3b82f6,#1d4ed8);padding:24px;border-radius:14px;">
<div style="font-size:12px;color:rgba(255,255,255,0.75);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Designer Payouts (${payoutSettings.designerRate}%)</div>
<div style="font-size:32px;font-weight:700;color:#fff;">$${designerPayout.toLocaleString()}</div>
<div style="font-size:12px;color:rgba(255,255,255,0.6);margin-top:6px;">Owed to designers</div>
</div>
<div style="background:linear-gradient(135deg,#8b5cf6,#6d28d9);padding:24px;border-radius:14px;">
<div style="font-size:12px;color:rgba(255,255,255,0.75);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Net Profit</div>
<div style="font-size:32px;font-weight:700;color:#fff;">$${profit.toLocaleString()}</div>
<div style="font-size:12px;color:rgba(255,255,255,0.6);margin-top:6px;">${Math.round((profit / (totalRevenue || 1)) * 100)}% margin</div>
</div>
<div style="background:linear-gradient(135deg,#e63946,#d62839);padding:24px;border-radius:14px;">
<div style="font-size:12px;color:rgba(255,255,255,0.75);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Monthly Recurring</div>
<div style="font-size:32px;font-weight:700;color:#fff;">$${monthlyRecurring.toLocaleString()}</div>
<div style="font-size:12px;color:rgba(255,255,255,0.6);margin-top:6px;">${subscriptions.filter(s => s.status === 'active').length} active subs</div>
</div>
</div>

        <!-- Payout Tiers -->
<div style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);padding:24px;border-radius:14px;margin-bottom:28px;">
<h3 style="font-size:15px;font-weight:600;color:#fff;margin-bottom:16px;">📊 Payout Tiers</h3>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;">
<div style="padding:20px;background:${payoutSettings.designerRate === 35 ? 'rgba(230,57,70,0.15)' : 'rgba(255,255,255,0.04)'};border-radius:12px;border:2px solid ${payoutSettings.designerRate === 35 ? '#e63946' : 'rgba(255,255,255,0.08)'};text-align:center;">
<div style="font-size:13px;font-weight:600;color:${payoutSettings.designerRate === 35 ? '#e63946' : 'rgba(255,255,255,0.7)'};margin-bottom:6px;">🥉 Starter</div>
<div style="font-size:22px;font-weight:700;color:#fff;margin-bottom:4px;">35% / 65%</div>
<div style="font-size:12px;color:rgba(255,255,255,0.45);margin-bottom:12px;">New designers (0-5 projects)</div>
<button onclick="setPayoutTier(35, 65)" style="padding:8px 16px;background:${payoutSettings.designerRate === 35 ? '#e63946' : 'rgba(255,255,255,0.1)'};color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;width:100%;">${payoutSettings.designerRate === 35 ? '✓ Active' : 'Apply'}</button>
</div>
<div style="padding:20px;background:${payoutSettings.designerRate === 40 ? 'rgba(230,57,70,0.15)' : 'rgba(255,255,255,0.04)'};border-radius:12px;border:2px solid ${payoutSettings.designerRate === 40 ? '#e63946' : 'rgba(255,255,255,0.08)'};text-align:center;">
<div style="font-size:13px;font-weight:600;color:${payoutSettings.designerRate === 40 ? '#e63946' : 'rgba(255,255,255,0.7)'};margin-bottom:6px;">🥈 Standard</div>
<div style="font-size:22px;font-weight:700;color:#fff;margin-bottom:4px;">40% / 60%</div>
<div style="font-size:12px;color:rgba(255,255,255,0.45);margin-bottom:12px;">Established (6-20 projects)</div>
<button onclick="setPayoutTier(40, 60)" style="padding:8px 16px;background:${payoutSettings.designerRate === 40 ? '#e63946' : 'rgba(255,255,255,0.1)'};color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;width:100%;">${payoutSettings.designerRate === 40 ? '✓ Active' : 'Apply'}</button>
</div>
<div style="padding:20px;background:${payoutSettings.designerRate === 50 ? 'rgba(230,57,70,0.15)' : 'rgba(255,255,255,0.04)'};border-radius:12px;border:2px solid ${payoutSettings.designerRate === 50 ? '#e63946' : 'rgba(255,255,255,0.08)'};text-align:center;">
<div style="font-size:13px;font-weight:600;color:${payoutSettings.designerRate === 50 ? '#e63946' : 'rgba(255,255,255,0.7)'};margin-bottom:6px;">🥇 Senior</div>
<div style="font-size:22px;font-weight:700;color:#fff;margin-bottom:4px;">50% / 50%</div>
<div style="font-size:12px;color:rgba(255,255,255,0.45);margin-bottom:12px;">Top performers (20+ projects)</div>
<button onclick="setPayoutTier(50, 50)" style="padding:8px 16px;background:${payoutSettings.designerRate === 50 ? '#e63946' : 'rgba(255,255,255,0.1)'};color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;width:100%;">${payoutSettings.designerRate === 50 ? '✓ Active' : 'Apply'}</button>
</div>
</div>
</div>

        <!-- Designer Earnings Table -->
<div style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);padding:24px;border-radius:14px;margin-bottom:28px;">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
<h3 style="font-size:15px;font-weight:600;color:#fff;">👥 Designer Earnings</h3>
<button onclick="processAllPayouts()" style="padding:10px 20px;background:#10b981;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;">💸 Process All Payouts</button>
</div>
<table style="width:100%;border-collapse:collapse;">
<thead>
<tr style="border-bottom:1px solid rgba(255,255,255,0.1);">
<th style="text-align:left;padding:12px 8px;font-size:11px;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:1px;">Designer</th>
<th style="text-align:center;padding:12px 8px;font-size:11px;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:1px;">Projects</th>
<th style="text-align:right;padding:12px 8px;font-size:11px;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:1px;">Total Earned</th>
<th style="text-align:right;padding:12px 8px;font-size:11px;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:1px;">Paid Out</th>
<th style="text-align:right;padding:12px 8px;font-size:11px;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:1px;">Pending</th>
<th style="text-align:center;padding:12px 8px;font-size:11px;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:1px;">Action</th>
</tr>
</thead>
<tbody>
                    ${Object.entries(designerEarnings).map(([name, data]) => `
<tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
<td style="padding:14px 8px;">
<div style="display:flex;align-items:center;gap:12px;">
<div style="width:36px;height:36px;background:linear-gradient(135deg,#e63946,#d62839);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;font-size:14px;">${name.charAt(0)}</div>
<span style="font-weight:600;color:#fff;">${name}</span>
</div>
</td>
<td style="text-align:center;padding:14px 8px;color:rgba(255,255,255,0.7);">${data.orders}</td>
<td style="text-align:right;padding:14px 8px;font-weight:600;color:#fff;">$${data.total.toLocaleString()}</td>
<td style="text-align:right;padding:14px 8px;color:#10b981;font-weight:500;">$${data.paid.toLocaleString()}</td>
<td style="text-align:right;padding:14px 8px;color:${data.pending > 0 ? '#f59e0b' : 'rgba(255,255,255,0.4)'};font-weight:${data.pending > 0 ? '600' : '400'};">$${data.pending.toLocaleString()}</td>
<td style="text-align:center;padding:14px 8px;">
                                ${data.pending > 0 ? `<button onclick="processDesignerPayout('${name}', ${data.pending})" style="padding:8px 16px;background:#10b981;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;">Pay $${data.pending}</button>` : '<span style="color:rgba(255,255,255,0.3);font-size:12px;">All paid</span>'}
</td>
</tr>
                    `).join('') || '<tr><td colspan="6" style="text-align:center;padding:40px;color:rgba(255,255,255,0.35);">No designer assignments yet. Assign designers to orders to track earnings.</td></tr>'}
</tbody>
</table>
</div>

        <!-- Payout History -->
<div style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);padding:24px;border-radius:14px;">
<h3 style="font-size:15px;font-weight:600;color:#fff;margin-bottom:16px;">📋 Payout History</h3>
<div style="display:flex;flex-direction:column;gap:10px;">
                ${designerPayouts.slice(-10).reverse().map(p => `
<div style="display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);border-radius:10px;">
<div style="display:flex;align-items:center;gap:12px;">
<div style="width:32px;height:32px;background:rgba(16,185,129,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;">💸</div>
<div>
<div style="font-weight:600;color:#fff;font-size:14px;">${p.designer}</div>
<div style="font-size:12px;color:rgba(255,255,255,0.4);">${new Date(p.date).toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'})}</div>
</div>
</div>
<div style="text-align:right;">
<div style="font-weight:700;color:#10b981;font-size:16px;">$${p.amount.toLocaleString()}</div>
<div style="font-size:11px;color:rgba(255,255,255,0.35);">${p.method || 'Stripe'}</div>
</div>
</div>
                `).join('') || '<div style="text-align:center;color:rgba(255,255,255,0.35);padding:32px;">No payouts processed yet</div>'}
</div>
</div>
    `;
}

function setPayoutTier(designerRate, profitMargin) {
    payoutSettings.designerRate = designerRate;
    payoutSettings.profitMargin = profitMargin;
    savePayoutSettings();
    loadAdminPayoutsPanel();
}

function processDesignerPayout(designerName, amount) {
    if (!confirm('Process payout of $' + amount + ' to ' + designerName + '?')) return;

    // Mark orders as paid
    orders.forEach(o => {
        if (o.assignedDesigner === designerName && !o.designerPaid) {
            o.designerPaid = true;
            o.designerPaidAt = new Date().toISOString();
        }
    });
    saveOrders();

    // Record payout
    designerPayouts.push({
        id: Date.now(),
        designer: designerName,
        amount: amount,
        date: new Date().toISOString(),
        method: payoutSettings.stripeEnabled ? 'Stripe' : 'Manual'
    });
    saveDesignerPayouts();

    loadAdminPayoutsPanel();
    alert('Successfully processed $' + amount + ' payout to ' + designerName + '!');
}

function processAllPayouts() {
    const pendingPayouts = [];
    const designerEarnings = {};

    orders.filter(o => o.status === 'delivered' && o.assignedDesigner && !o.designerPaid).forEach(o => {
        if (!designerEarnings[o.assignedDesigner]) designerEarnings[o.assignedDesigner] = 0;
        designerEarnings[o.assignedDesigner] += Math.round((o.estimate || 0) * (payoutSettings.designerRate / 100));
    });

    const total = Object.values(designerEarnings).reduce((sum, v) => sum + v, 0);
    if (total === 0) {
        alert('No pending payouts to process!');
        return;
    }

    if (!confirm('Process all pending payouts totaling $' + total.toLocaleString() + '?')) return;

    Object.entries(designerEarnings).forEach(([name, amount]) => {
        if (amount > 0) {
            processDesignerPayout(name, amount);
        }
    });
}

function openPayoutSettingsModal() {
    const modal = document.createElement('div');
    modal.id = 'payoutSettingsModal';
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;';
    modal.innerHTML = `
<div style="background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);border-radius:16px;max-width:480px;width:90%;padding:32px;position:relative;">
<button onclick="document.getElementById('payoutSettingsModal').remove()" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:24px;cursor:pointer;color:rgba(255,255,255,0.5);">&times;</button>
<h2 style="font-size:18px;font-weight:700;color:#fff;margin-bottom:24px;">⚙️ Payout Settings</h2>
<div style="display:flex;flex-direction:column;gap:16px;">
<div>
<label style="display:block;font-size:12px;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Designer Rate (%)</label>
<input type="number" id="psDesignerRate" value="${payoutSettings.designerRate}" min="10" max="80" style="width:100%;padding:10px 14px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#fff;font-size:14px;">
</div>
<div>
<label style="display:block;font-size:12px;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Payout Schedule</label>
<select id="psSchedule" style="width:100%;padding:10px 14px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#fff;font-size:14px;">
<option value="weekly" ${payoutSettings.payoutSchedule === 'weekly' ? 'selected' : ''} style="background:#1a1a1a;">Weekly</option>
<option value="biweekly" ${payoutSettings.payoutSchedule === 'biweekly' ? 'selected' : ''} style="background:#1a1a1a;">Bi-Weekly</option>
<option value="monthly" ${payoutSettings.payoutSchedule === 'monthly' ? 'selected' : ''} style="background:#1a1a1a;">Monthly</option>
</select>
</div>
<div>
<label style="display:block;font-size:12px;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Minimum Payout ($)</label>
<input type="number" id="psMinPayout" value="${payoutSettings.minimumPayout}" min="0" style="width:100%;padding:10px 14px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#fff;font-size:14px;">
</div>
</div>
<div style="display:flex;gap:12px;margin-top:24px;">
<button onclick="document.getElementById('payoutSettingsModal').remove()" style="flex:1;padding:12px;background:rgba(255,255,255,0.08);color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:14px;">Cancel</button>
<button onclick="savePayoutSettingsFromModal()" style="flex:1;padding:12px;background:#e63946;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;">Save Settings</button>
</div>
</div>
    `;
    document.body.appendChild(modal);
}

function savePayoutSettingsFromModal() {
    const rate = parseInt(document.getElementById('psDesignerRate').value) || 40;
    payoutSettings.designerRate = Math.min(80, Math.max(10, rate));
    payoutSettings.profitMargin = 100 - payoutSettings.designerRate;
    payoutSettings.payoutSchedule = document.getElementById('psSchedule').value;
    payoutSettings.minimumPayout = parseInt(document.getElementById('psMinPayout').value) || 100;
    savePayoutSettings();
    document.getElementById('payoutSettingsModal').remove();
    loadAdminPayoutsPanel();
}

// ==================== STRIPE INTEGRATION PANEL ====================
let stripeSettings = JSON.parse(localStorage.getItem('nui_stripe')) || {
    connected: false,
    accountId: '',
    publishableKey: '',
    secretKey: '',
    webhookSecret: '',
    testMode: true
};
function saveStripeSettings() {
    localStorage.setItem('nui_stripe', JSON.stringify(stripeSettings));
    // Also sync to Supabase so settings persist across browsers/sessions
    if (typeof _pushToBackend === 'function') {
        _pushToBackend('stripe_settings', stripeSettings).catch(function(e) { console.warn('Stripe settings sync error:', e.message); });
    }
}

function loadAdminStripePanel() {
    const recentTransactions = [
        { id: 'pi_abc123', amount: 1500, status: 'succeeded', customer: 'Marcus Johnson', date: '2025-01-28' },
        { id: 'pi_def456', amount: 2500, status: 'succeeded', customer: 'Sarah Williams', date: '2025-01-25' },
        { id: 'pi_ghi789', amount: 800, status: 'pending', customer: 'David Chen', date: '2025-01-24' }
    ];

    document.getElementById('adminStripePanel').innerHTML = `
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
<h2 style="font-size: 28px; font-weight: 700;">💎 Stripe Integration</h2>
<span style="padding: 8px 16px; background: ${stripeSettings.connected ? '#d1fae5' : '#fee2e2'}; color: ${stripeSettings.connected ? '#059669' : '#dc2626'}; border-radius: 8px; font-size: 14px;">
                ${stripeSettings.connected ? '✓ Connected' : '✗ Not Connected'}
</span>
</div>

        ${!stripeSettings.connected ? `
        <!-- Connect Stripe -->
<div style="background: linear-gradient(135deg, #635bff 0%, #4f46e5 100%); padding: 48px; border-radius: 20px; color: #fff; text-align: center; margin-bottom: 32px;">
<div style="font-size: 64px; margin-bottom: 16px;">💳</div>
<h2 style="font-size: 28px; font-weight: 700; margin-bottom: 12px;">Connect Your Stripe Account</h2>
<p style="font-size: 16px; opacity: 0.9; margin-bottom: 24px;">Accept payments, send invoices, and manage payouts with Stripe.</p>
<button onclick="connectStripe()" style="padding: 16px 48px; background: #fff; color: #635bff; border: none; border-radius: 12px; font-size: 18px; font-weight: 700; cursor: pointer;">Connect with Stripe →</button>
</div>
        ` : `
        <!-- Stripe Dashboard -->
<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 32px;">
<div style="background: #1a1a1a; padding: 24px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
<div style="font-size: 13px; color: rgba(255,255,255,0.6); margin-bottom: 8px;">Balance</div>
<div style="font-size: 32px; font-weight: 700; color: #fff;">$4,850</div>
<div style="font-size: 13px; color: #10b981; margin-top: 8px;">Available for payout</div>
</div>
<div style="background: #1a1a1a; padding: 24px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
<div style="font-size: 13px; color: rgba(255,255,255,0.6); margin-bottom: 8px;">This Month</div>
<div style="font-size: 32px; font-weight: 700; color: #fff;">$12,450</div>
<div style="font-size: 13px; color: #10b981; margin-top: 8px;">↑ 18% vs last month</div>
</div>
<div style="background: #1a1a1a; padding: 24px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
<div style="font-size: 13px; color: rgba(255,255,255,0.6); margin-bottom: 8px;">Pending</div>
<div style="font-size: 32px; font-weight: 700; color: #fff;">$2,300</div>
<div style="font-size: 13px; color: #f59e0b; margin-top: 8px;">3 payments processing</div>
</div>
<div style="background: #1a1a1a; padding: 24px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
<div style="font-size: 13px; color: rgba(255,255,255,0.6); margin-bottom: 8px;">Success Rate</div>
<div style="font-size: 32px; font-weight: 700; color: #fff;">98.5%</div>
<div style="font-size: 13px; color: #10b981; margin-top: 8px;">Excellent</div>
</div>
</div>
        `}

        <!-- API Keys -->
<div style="background: #1a1a1a; padding: 24px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 32px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h3 style="font-size: 16px; font-weight: 600; color: #fff;">🔑 API Configuration</h3>
<label style="display: flex; align-items: center; gap: 8px; cursor: pointer; color: #fff;">
<input type="checkbox" ${stripeSettings.testMode ? 'checked' : ''} onchange="toggleStripeMode(this.checked)">
<span style="font-size: 14px;">Test Mode</span>
</label>
</div>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
<div>
<label style="font-size: 13px; color: rgba(255,255,255,0.6); display: block; margin-bottom: 8px;">Publishable Key</label>
<input type="text" id="stripePublishableKey" value="${stripeSettings.publishableKey}" placeholder="pk_test_..." style="width: 100%; padding: 12px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; font-family: monospace; font-size: 13px; background: #252525; color: #fff;">
</div>
<div>
<label style="font-size: 13px; color: rgba(255,255,255,0.6); display: block; margin-bottom: 8px;">Secret Key</label>
<input type="password" id="stripeSecretKey" value="${stripeSettings.secretKey}" placeholder="sk_test_..." style="width: 100%; padding: 12px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; font-family: monospace; font-size: 13px; background: #252525; color: #fff;">
</div>
</div>
<button onclick="saveStripeKeys()" class="btn-cta" style="margin-top: 20px;">Save API Keys</button>
</div>

        <!-- Payment Methods -->
<div style="background: #1a1a1a; padding: 24px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 32px;">
<h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: #fff;">💳 Accepted Payment Methods</h3>
<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
<div style="padding: 20px; background: #252525; border-radius: 12px; text-align: center; border: 2px solid #10b981;">
<div style="font-size: 32px; margin-bottom: 8px;">💳</div>
<div style="font-weight: 600; color: #fff;">Credit Cards</div>
<div style="font-size: 12px; color: #10b981; margin-top: 4px;">Active</div>
</div>
<div style="padding: 20px; background: #252525; border-radius: 12px; text-align: center; border: 2px solid #10b981;">
<div style="font-size: 32px; margin-bottom: 8px;">🏦</div>
<div style="font-weight: 600; color: #fff;">ACH Bank</div>
<div style="font-size: 12px; color: #10b981; margin-top: 4px;">Active</div>
</div>
<div style="padding: 20px; background: #252525; border-radius: 12px; text-align: center; border: 2px solid rgba(255,255,255,0.2);">
<div style="font-size: 32px; margin-bottom: 8px;">🍎</div>
<div style="font-weight: 600; color: #fff;">Apple Pay</div>
<div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 4px;">Configure</div>
</div>
<div style="padding: 20px; background: #252525; border-radius: 12px; text-align: center; border: 2px solid rgba(255,255,255,0.2);">
<div style="font-size: 32px; margin-bottom: 8px;">🔗</div>
<div style="font-weight: 600; color: #fff;">Link</div>
<div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 4px;">Configure</div>
</div>
</div>
</div>

        <!-- Recent Transactions -->
<div style="background: #1a1a1a; padding: 24px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h3 style="font-size: 16px; font-weight: 600; color: #fff;">📋 Recent Transactions</h3>
<a href="https://dashboard.stripe.com" target="_blank" class="btn-outline" style="color: #fff; border-color: rgba(255,255,255,0.3);">Open Stripe Dashboard →</a>
</div>
<table style="width: 100%; border-collapse: collapse;">
<thead>
<tr style="border-bottom: 2px solid rgba(255,255,255,0.1);">
<th style="text-align: left; padding: 12px 0; font-size: 12px; color: rgba(255,255,255,0.6);">Transaction ID</th>
<th style="text-align: left; padding: 12px 0; font-size: 12px; color: rgba(255,255,255,0.6);">Customer</th>
<th style="text-align: right; padding: 12px 0; font-size: 12px; color: rgba(255,255,255,0.6);">Amount</th>
<th style="text-align: center; padding: 12px 0; font-size: 12px; color: rgba(255,255,255,0.6);">Status</th>
<th style="text-align: right; padding: 12px 0; font-size: 12px; color: rgba(255,255,255,0.6);">Date</th>
</tr>
</thead>
<tbody>
                    ${recentTransactions.map(t => `
<tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
<td style="padding: 16px 0; font-family: monospace; font-size: 13px; color: #fff;">${t.id}</td>
<td style="padding: 16px 0; color: #fff;">${t.customer}</td>
<td style="text-align: right; padding: 16px 0; font-weight: 600; color: #fff;">$${t.amount.toLocaleString()}</td>
<td style="text-align: center; padding: 16px 0;">
<span style="padding: 4px 12px; background: ${t.status === 'succeeded' ? 'rgba(16,185,129,0.2)' : 'rgba(245,158,11,0.2)'}; color: ${t.status === 'succeeded' ? '#10b981' : '#f59e0b'}; border-radius: 12px; font-size: 12px;">${t.status}</span>
</td>
<td style="text-align: right; padding: 16px 0; color: rgba(255,255,255,0.5);">${t.date}</td>
</tr>
                    `).join('')}
</tbody>
</table>
</div>
    `;
}

function connectStripe() {
    // Simulate Stripe Connect OAuth flow
    if (confirm('This will redirect you to Stripe to connect your account. Continue?')) {
        stripeSettings.connected = true;
        stripeSettings.accountId = 'acct_' + Math.random().toString(36).substr(2, 16);
        siteAnalytics.stripeConnected = true;
        saveStripeSettings();
        saveAnalytics();
        loadAdminStripePanel();
        alert('Stripe account connected successfully!');
    }
}

function saveStripeKeys() {
    stripeSettings.publishableKey = document.getElementById('stripePublishableKey').value;
    stripeSettings.secretKey = document.getElementById('stripeSecretKey').value;
    saveStripeSettings();
    alert('Stripe API keys saved!');
}

function toggleStripeMode(testMode) {
    stripeSettings.testMode = testMode;
    saveStripeSettings();
    alert(testMode ? 'Switched to Test Mode' : 'Switched to Live Mode - be careful!');
}

// ==================== INTEGRATIONS PANEL ====================
let integrations = JSON.parse(localStorage.getItem('nui_integrations')) || {
    openphone: { connected: false, apiKey: '', phoneNumber: '' },
    mailchimp: { connected: false, apiKey: '', listId: '' },
    sendgrid: { connected: false, apiKey: '' },
    instagram: { connected: false, accessToken: '', username: '' },
    facebook: { connected: false, accessToken: '', pageId: '' },
    twitter: { connected: false, apiKey: '', apiSecret: '' },
    linkedin: { connected: false, accessToken: '' },
    google: { connected: false, clientId: '', clientSecret: '' },
    zapier: { connected: false, webhookUrl: '' },
    slack: { connected: false, webhookUrl: '' }
};

function saveIntegrations() {
    localStorage.setItem('nui_integrations', JSON.stringify(integrations));
}

function loadAdminIntegrationsPanel() {
    document.getElementById('adminIntegrationsPanel').innerHTML = `
<div class="panel-header">
<h2 class="panel-title">🔗 Integrations Hub</h2>
<p class="panel-subtitle">Connect your favorite tools and services to automate workflows</p>
</div>

        <!-- Integration Stats -->
<div class="stat-cards" style="margin-bottom: 32px;">
<div class="stat-card" style="background: #fff;"><div class="num" style="color: #000;">${Object.values(integrations).filter(i => i.connected).length}</div><div class="lbl" style="color: #333;">Connected</div></div>
<div class="stat-card" style="background: #fff;"><div class="num" style="color: #000;">${Object.keys(integrations).length}</div><div class="lbl" style="color: #333;">Available</div></div>
<div class="stat-card" style="background: #fff; border-color: #10b981;"><div class="num" style="color: #10b981;">Active</div><div class="lbl" style="color: #333;">API Status</div></div>
</div>

        <!-- Communications Integrations -->
<div class="form-section" style="background: #111; border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 24px; margin-bottom: 24px;">
<div class="form-section-title" style="color: #fff; margin-bottom: 20px;">📱 Communications</div>
<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">

                <!-- OpenPhone -->
<div style="background: #1a1a1a; border: 1px solid ${integrations.openphone.connected ? '#10b981' : 'rgba(255,255,255,0.1)'}; border-radius: 12px; padding: 20px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
<div style="display: flex; align-items: center; gap: 12px;">
<div style="width: 48px; height: 48px; background: linear-gradient(135deg, #7c3aed, #4f46e5); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">📞</div>
<div>
<div style="font-weight: 600; color: #fff;">OpenPhone</div>
<div style="font-size: 12px; color: rgba(255,255,255,0.5);">SMS & Voice Calls</div>
</div>
</div>
<span style="padding: 4px 12px; background: ${integrations.openphone.connected ? 'rgba(16,185,129,0.2)' : 'rgba(255,255,255,0.1)'}; color: ${integrations.openphone.connected ? '#10b981' : 'rgba(255,255,255,0.5)'}; border-radius: 100px; font-size: 12px;">${integrations.openphone.connected ? 'Connected' : 'Not Connected'}</span>
</div>
<div class="form-group">
<label class="form-label" style="color: rgba(255,255,255,0.7);">API Key</label>
<input type="password" id="openphoneApiKey" value="${integrations.openphone.apiKey}" placeholder="Enter OpenPhone API Key" style="width: 100%; padding: 10px; background: #252525; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff;">
</div>
<div class="form-group">
<label class="form-label" style="color: rgba(255,255,255,0.7);">Phone Number</label>
<input type="text" id="openphoneNumber" value="${integrations.openphone.phoneNumber}" placeholder="+1 (555) 123-4567" style="width: 100%; padding: 10px; background: #252525; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff;">
</div>
<button onclick="toggleOpenPhoneIntegration()" style="width: 100%; padding: 12px; background: ${integrations.openphone.connected ? '#dc2626' : '#7c3aed'}; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">${integrations.openphone.connected ? 'Disconnect' : 'Connect OpenPhone'}</button>
</div>

                <!-- SendGrid -->
<div style="background: #1a1a1a; border: 1px solid ${integrations.sendgrid.connected ? '#10b981' : 'rgba(255,255,255,0.1)'}; border-radius: 12px; padding: 20px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
<div style="display: flex; align-items: center; gap: 12px;">
<div style="width: 48px; height: 48px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">✉️</div>
<div>
<div style="font-weight: 600; color: #fff;">SendGrid</div>
<div style="font-size: 12px; color: rgba(255,255,255,0.5);">Email Delivery</div>
</div>
</div>
<span style="padding: 4px 12px; background: ${integrations.sendgrid.connected ? 'rgba(16,185,129,0.2)' : 'rgba(255,255,255,0.1)'}; color: ${integrations.sendgrid.connected ? '#10b981' : 'rgba(255,255,255,0.5)'}; border-radius: 100px; font-size: 12px;">${integrations.sendgrid.connected ? 'Connected' : 'Not Connected'}</span>
</div>
<div class="form-group">
<label class="form-label" style="color: rgba(255,255,255,0.7);">API Key</label>
<input type="password" id="sendgridApiKey" value="${integrations.sendgrid.apiKey}" placeholder="SG.xxxxxx..." style="width: 100%; padding: 10px; background: #252525; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff;">
</div>
<button onclick="connectSendGrid()" style="width: 100%; padding: 12px; background: ${integrations.sendgrid.connected ? '#dc2626' : '#3b82f6'}; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">${integrations.sendgrid.connected ? 'Disconnect' : 'Connect SendGrid'}</button>
</div>

                <!-- Mailchimp -->
<div style="background: #1a1a1a; border: 1px solid ${integrations.mailchimp.connected ? '#10b981' : 'rgba(255,255,255,0.1)'}; border-radius: 12px; padding: 20px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
<div style="display: flex; align-items: center; gap: 12px;">
<div style="width: 48px; height: 48px; background: linear-gradient(135deg, #ffe01b, #f59e0b); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">🐵</div>
<div>
<div style="font-weight: 600; color: #fff;">Mailchimp</div>
<div style="font-size: 12px; color: rgba(255,255,255,0.5);">Email Marketing</div>
</div>
</div>
<span style="padding: 4px 12px; background: ${integrations.mailchimp.connected ? 'rgba(16,185,129,0.2)' : 'rgba(255,255,255,0.1)'}; color: ${integrations.mailchimp.connected ? '#10b981' : 'rgba(255,255,255,0.5)'}; border-radius: 100px; font-size: 12px;">${integrations.mailchimp.connected ? 'Connected' : 'Not Connected'}</span>
</div>
<div class="form-group">
<label class="form-label" style="color: rgba(255,255,255,0.7);">API Key</label>
<input type="password" id="mailchimpApiKey" value="${integrations.mailchimp.apiKey}" placeholder="Enter Mailchimp API Key" style="width: 100%; padding: 10px; background: #252525; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff;">
</div>
<button onclick="connectMailchimp()" style="width: 100%; padding: 12px; background: ${integrations.mailchimp.connected ? '#dc2626' : '#f59e0b'}; color: #000; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">${integrations.mailchimp.connected ? 'Disconnect' : 'Connect Mailchimp'}</button>
</div>
</div>
</div>

        <!-- Social Media Integrations -->
<div class="form-section" style="background: #111; border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 24px; margin-bottom: 24px;">
<div class="form-section-title" style="color: #fff; margin-bottom: 20px;">📱 Social Media</div>
<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">

                <!-- Instagram -->
<div style="background: #1a1a1a; border: 1px solid ${integrations.instagram.connected ? '#10b981' : 'rgba(255,255,255,0.1)'}; border-radius: 12px; padding: 20px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
<div style="display: flex; align-items: center; gap: 12px;">
<div style="width: 48px; height: 48px; background: linear-gradient(135deg, #833ab4, #fd1d1d, #fcb045); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">📸</div>
<div>
<div style="font-weight: 600; color: #fff;">Instagram</div>
<div style="font-size: 12px; color: rgba(255,255,255,0.5);">DMs & Posts</div>
</div>
</div>
<span style="padding: 4px 12px; background: ${integrations.instagram.connected ? 'rgba(16,185,129,0.2)' : 'rgba(255,255,255,0.1)'}; color: ${integrations.instagram.connected ? '#10b981' : 'rgba(255,255,255,0.5)'}; border-radius: 100px; font-size: 12px;">${integrations.instagram.connected ? 'Connected' : 'Not Connected'}</span>
</div>
<div class="form-group">
<label class="form-label" style="color: rgba(255,255,255,0.7);">Username</label>
<input type="text" id="instagramUsername" value="${integrations.instagram.username}" placeholder="@yourusername" style="width: 100%; padding: 10px; background: #252525; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff;">
</div>
<button onclick="connectInstagram()" style="width: 100%; padding: 12px; background: ${integrations.instagram.connected ? '#dc2626' : 'linear-gradient(135deg, #833ab4, #fd1d1d)'}; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">${integrations.instagram.connected ? 'Disconnect' : 'Connect Instagram'}</button>
</div>

                <!-- Facebook -->
<div style="background: #1a1a1a; border: 1px solid ${integrations.facebook.connected ? '#10b981' : 'rgba(255,255,255,0.1)'}; border-radius: 12px; padding: 20px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
<div style="display: flex; align-items: center; gap: 12px;">
<div style="width: 48px; height: 48px; background: #1877f2; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">📘</div>
<div>
<div style="font-weight: 600; color: #fff;">Facebook</div>
<div style="font-size: 12px; color: rgba(255,255,255,0.5);">Messenger & Pages</div>
</div>
</div>
<span style="padding: 4px 12px; background: ${integrations.facebook.connected ? 'rgba(16,185,129,0.2)' : 'rgba(255,255,255,0.1)'}; color: ${integrations.facebook.connected ? '#10b981' : 'rgba(255,255,255,0.5)'}; border-radius: 100px; font-size: 12px;">${integrations.facebook.connected ? 'Connected' : 'Not Connected'}</span>
</div>
<button onclick="connectFacebook()" style="width: 100%; padding: 12px; background: ${integrations.facebook.connected ? '#dc2626' : '#1877f2'}; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">${integrations.facebook.connected ? 'Disconnect' : 'Connect Facebook'}</button>
</div>

                <!-- LinkedIn -->
<div style="background: #1a1a1a; border: 1px solid ${integrations.linkedin.connected ? '#10b981' : 'rgba(255,255,255,0.1)'}; border-radius: 12px; padding: 20px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
<div style="display: flex; align-items: center; gap: 12px;">
<div style="width: 48px; height: 48px; background: #0077b5; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">💼</div>
<div>
<div style="font-weight: 600; color: #fff;">LinkedIn</div>
<div style="font-size: 12px; color: rgba(255,255,255,0.5);">Professional Network</div>
</div>
</div>
<span style="padding: 4px 12px; background: ${integrations.linkedin.connected ? 'rgba(16,185,129,0.2)' : 'rgba(255,255,255,0.1)'}; color: ${integrations.linkedin.connected ? '#10b981' : 'rgba(255,255,255,0.5)'}; border-radius: 100px; font-size: 12px;">${integrations.linkedin.connected ? 'Connected' : 'Not Connected'}</span>
</div>
<button onclick="connectLinkedIn()" style="width: 100%; padding: 12px; background: ${integrations.linkedin.connected ? '#dc2626' : '#0077b5'}; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">${integrations.linkedin.connected ? 'Disconnect' : 'Connect LinkedIn'}</button>
</div>
</div>
</div>

        <!-- Automation Integrations -->
<div class="form-section" style="background: #111; border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 24px;">
<div class="form-section-title" style="color: #fff; margin-bottom: 20px;">⚡ Automation & Tools</div>
<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">

                <!-- Zapier -->
<div style="background: #1a1a1a; border: 1px solid ${integrations.zapier.connected ? '#10b981' : 'rgba(255,255,255,0.1)'}; border-radius: 12px; padding: 20px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
<div style="display: flex; align-items: center; gap: 12px;">
<div style="width: 48px; height: 48px; background: #ff4a00; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">⚡</div>
<div>
<div style="font-weight: 600; color: #fff;">Zapier</div>
<div style="font-size: 12px; color: rgba(255,255,255,0.5);">Workflow Automation</div>
</div>
</div>
<span style="padding: 4px 12px; background: ${integrations.zapier.connected ? 'rgba(16,185,129,0.2)' : 'rgba(255,255,255,0.1)'}; color: ${integrations.zapier.connected ? '#10b981' : 'rgba(255,255,255,0.5)'}; border-radius: 100px; font-size: 12px;">${integrations.zapier.connected ? 'Connected' : 'Not Connected'}</span>
</div>
<div class="form-group">
<label class="form-label" style="color: rgba(255,255,255,0.7);">Webhook URL</label>
<input type="text" id="zapierWebhook" value="${integrations.zapier.webhookUrl}" placeholder="https://hooks.zapier.com/..." style="width: 100%; padding: 10px; background: #252525; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff;">
</div>
<button onclick="connectZapier()" style="width: 100%; padding: 12px; background: ${integrations.zapier.connected ? '#dc2626' : '#ff4a00'}; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">${integrations.zapier.connected ? 'Disconnect' : 'Connect Zapier'}</button>
</div>

                <!-- Slack -->
<div style="background: #1a1a1a; border: 1px solid ${integrations.slack.connected ? '#10b981' : 'rgba(255,255,255,0.1)'}; border-radius: 12px; padding: 20px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
<div style="display: flex; align-items: center; gap: 12px;">
<div style="width: 48px; height: 48px; background: #4a154b; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">💬</div>
<div>
<div style="font-weight: 600; color: #fff;">Slack</div>
<div style="font-size: 12px; color: rgba(255,255,255,0.5);">Team Notifications</div>
</div>
</div>
<span style="padding: 4px 12px; background: ${integrations.slack.connected ? 'rgba(16,185,129,0.2)' : 'rgba(255,255,255,0.1)'}; color: ${integrations.slack.connected ? '#10b981' : 'rgba(255,255,255,0.5)'}; border-radius: 100px; font-size: 12px;">${integrations.slack.connected ? 'Connected' : 'Not Connected'}</span>
</div>
<div class="form-group">
<label class="form-label" style="color: rgba(255,255,255,0.7);">Webhook URL</label>
<input type="text" id="slackWebhook" value="${integrations.slack.webhookUrl}" placeholder="https://hooks.slack.com/..." style="width: 100%; padding: 10px; background: #252525; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff;">
</div>
<button onclick="connectSlack()" style="width: 100%; padding: 12px; background: ${integrations.slack.connected ? '#dc2626' : '#4a154b'}; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">${integrations.slack.connected ? 'Disconnect' : 'Connect Slack'}</button>
</div>

                <!-- Google -->
<div style="background: #1a1a1a; border: 1px solid ${integrations.google.connected ? '#10b981' : 'rgba(255,255,255,0.1)'}; border-radius: 12px; padding: 20px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
<div style="display: flex; align-items: center; gap: 12px;">
<div style="width: 48px; height: 48px; background: #fff; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">🔵</div>
<div>
<div style="font-weight: 600; color: #fff;">Google</div>
<div style="font-size: 12px; color: rgba(255,255,255,0.5);">Calendar & Drive</div>
</div>
</div>
<span style="padding: 4px 12px; background: ${integrations.google.connected ? 'rgba(16,185,129,0.2)' : 'rgba(255,255,255,0.1)'}; color: ${integrations.google.connected ? '#10b981' : 'rgba(255,255,255,0.5)'}; border-radius: 100px; font-size: 12px;">${integrations.google.connected ? 'Connected' : 'Not Connected'}</span>
</div>
<button onclick="connectGoogle()" style="width: 100%; padding: 12px; background: ${integrations.google.connected ? '#dc2626' : '#4285f4'}; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">${integrations.google.connected ? 'Disconnect' : 'Connect Google'}</button>
</div>
</div>
</div>
    `;
}

// Integration Connection Functions (consolidated)
function toggleOpenPhoneIntegration() {
    const apiKey = document.getElementById('openphoneApiKey')?.value;
    const phoneNumber = document.getElementById('openphoneNumber')?.value;
    if (integrations.openphone.connected) {
        integrations.openphone = { connected: false, apiKey: '', phoneNumber: '' };
        // Also disconnect from SMS system
        smsSystem.openPhone = { connected: false, apiKey: '', phoneNumber: '', userId: '' };
        saveSms();
    } else {
        if (!apiKey) { alert('Please enter your OpenPhone API key'); return; }
        integrations.openphone = { connected: true, apiKey, phoneNumber };
        // Also update SMS system
        smsSystem.openPhone = { connected: true, apiKey, phoneNumber, userId: 'user_' + Date.now() };
        saveSms();
    }
    saveIntegrations();
    loadAdminIntegrationsPanel();
    alert(integrations.openphone.connected ? 'OpenPhone connected! SMS & calls will sync automatically.' : 'OpenPhone disconnected.');
}

function connectSendGrid() {
    const apiKey = document.getElementById('sendgridApiKey').value;
    if (integrations.sendgrid.connected) {
        integrations.sendgrid = { connected: false, apiKey: '' };
    } else {
        if (!apiKey) { alert('Please enter your SendGrid API key'); return; }
        integrations.sendgrid = { connected: true, apiKey };
    }
    saveIntegrations();
    loadAdminIntegrationsPanel();
    alert(integrations.sendgrid.connected ? 'SendGrid connected! Emails will be sent via SendGrid.' : 'SendGrid disconnected.');
}

function connectMailchimp() {
    const apiKey = document.getElementById('mailchimpApiKey').value;
    if (integrations.mailchimp.connected) {
        integrations.mailchimp = { connected: false, apiKey: '', listId: '' };
    } else {
        if (!apiKey) { alert('Please enter your Mailchimp API key'); return; }
        integrations.mailchimp = { connected: true, apiKey, listId: '' };
    }
    saveIntegrations();
    loadAdminIntegrationsPanel();
    alert(integrations.mailchimp.connected ? 'Mailchimp connected! Subscribers will sync automatically.' : 'Mailchimp disconnected.');
}

function connectInstagram() {
    const username = document.getElementById('instagramUsername')?.value || '';
    if (integrations.instagram.connected) {
        integrations.instagram = { connected: false, accessToken: '', username: '' };
    } else {
        // Simulate OAuth flow
        integrations.instagram = { connected: true, accessToken: 'ig_demo_token', username };
    }
    saveIntegrations();
    loadAdminIntegrationsPanel();
    alert(integrations.instagram.connected ? 'Instagram connected! DMs will appear in your inbox.' : 'Instagram disconnected.');
}

function connectFacebook() {
    if (integrations.facebook.connected) {
        integrations.facebook = { connected: false, accessToken: '', pageId: '' };
        saveIntegrations();
        loadAdminIntegrationsPanel();
        alert('Facebook disconnected.');
    } else {
        // Real Facebook OAuth - requires Facebook App ID in env.js
        const fbAppId = window.FACEBOOK_APP_ID || '';
        if (!fbAppId) {
            alert('⚠️ Facebook App ID not configured.\n\nTo connect Facebook:\n1. Create an app at developers.facebook.com\n2. Add your App ID to env.js\n3. Configure OAuth redirect URL');
            return;
        }
        const redirectUri = encodeURIComponent(window.location.origin + '/.netlify/functions/oauth-callback?platform=facebook');
        const authUrl = `https://www.facebook.com/v18.0/dialog/oauth?client_id=${fbAppId}&redirect_uri=${redirectUri}&scope=pages_manage_posts,pages_read_engagement,pages_messaging&response_type=code`;
        window.open(authUrl, 'Facebook Login', 'width=600,height=700');
    }
}

function connectLinkedIn() {
    if (integrations.linkedin.connected) {
        integrations.linkedin = { connected: false, accessToken: '' };
        saveIntegrations();
        loadAdminIntegrationsPanel();
        alert('LinkedIn disconnected.');
    } else {
        const liClientId = window.LINKEDIN_CLIENT_ID || '';
        if (!liClientId) {
            alert('⚠️ LinkedIn Client ID not configured.\n\nTo connect LinkedIn:\n1. Create an app at linkedin.com/developers\n2. Add your Client ID to env.js');
            return;
        }
        const redirectUri = encodeURIComponent(window.location.origin + '/.netlify/functions/oauth-callback?platform=linkedin');
        const authUrl = `https://www.linkedin.com/oauth/v2/authorization?client_id=${liClientId}&redirect_uri=${redirectUri}&scope=r_liteprofile%20w_member_social&response_type=code`;
        window.open(authUrl, 'LinkedIn Login', 'width=600,height=700');
    }
}

function connectZapier() {
    const webhookUrl = document.getElementById('zapierWebhook')?.value;
    if (integrations.zapier.connected) {
        integrations.zapier = { connected: false, webhookUrl: '' };
    } else {
        if (!webhookUrl) { alert('Please enter your Zapier webhook URL'); return; }
        integrations.zapier = { connected: true, webhookUrl };
    }
    saveIntegrations();
    loadAdminIntegrationsPanel();
    alert(integrations.zapier.connected ? 'Zapier connected! Triggers will be sent automatically.' : 'Zapier disconnected.');
}

function connectSlack() {
    const webhookUrl = document.getElementById('slackWebhook')?.value;
    if (integrations.slack.connected) {
        integrations.slack = { connected: false, webhookUrl: '' };
    } else {
        if (!webhookUrl) { alert('Please enter your Slack webhook URL'); return; }
        integrations.slack = { connected: true, webhookUrl };
    }
    saveIntegrations();
    loadAdminIntegrationsPanel();
    alert(integrations.slack.connected ? 'Slack connected! Notifications will be sent to your channel.' : 'Slack disconnected.');
}

function connectGoogle() {
    if (integrations.google.connected) {
        integrations.google = { connected: false, clientId: '', clientSecret: '' };
        saveIntegrations();
        loadAdminIntegrationsPanel();
        alert('Google disconnected.');
    } else {
        alert('⚠️ Google OAuth requires setup.\n\nTo connect Google:\n1. Create a project at console.cloud.google.com\n2. Enable Calendar & Drive APIs\n3. Create OAuth credentials\n4. Add Client ID to env.js');
    }
}

// ==================== DESIGNER DASHBOARD ====================
function loadDesignerDashboard() {
    if (!currentUser || currentUser.type !== 'designer') return;

    const myProjects = orders.filter(o => o.assignedDesigner === currentUser.id || o.assignedDesignerId === currentUser.id || o.assignedDesigner === currentUser.name);
    const activeProjects = myProjects.filter(o => o.status === 'in_progress');
    const pendingProjects = myProjects.filter(o => o.status === 'pending');
    const completedProjects = myProjects.filter(o => o.status === 'delivered');
    const unreadMessages = designerMessages.filter(m => (m.designerId === currentUser.id || m.designerId === currentUser.name) && !m.read).length;

    document.getElementById('adminDashboard').innerHTML = `
<div class="admin-container">
<aside class="admin-sidebar" style="background: #0a0a0a;">
<div class="admin-header">
<div class="admin-logo" style="color: var(--red);">NUI Designer</div>
<div style="font-size: 12px; color: #888;">Welcome, ${currentUser.name}</div>
</div>
<nav class="admin-nav">
<div class="admin-nav-group">
<a onclick="showDesignerPanel('dashboard')" class="admin-nav-link active" data-panel="dashboard">📊 Dashboard</a>
<a onclick="showDesignerPanel('myprojects')" class="admin-nav-link" data-panel="myprojects">📁 My Projects</a>
<a onclick="showDesignerPanel('available')" class="admin-nav-link" data-panel="available">🆕 Available Jobs</a>
<a onclick="showDesignerPanel('proofs')" class="admin-nav-link" data-panel="proofs">📤 Upload Proofs</a>
<a onclick="showDesignerPanel('messages')" class="admin-nav-link" data-panel="messages">💬 Messages ${unreadMessages > 0 ? '<span style="background: var(--red); color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 8px;">' + unreadMessages + '</span>' : ''}</a>
</div>
<div class="admin-nav-group" style="margin-top: auto;">
<a onclick="portalLogout()" class="admin-nav-link" style="color: #888;">🚪 Sign Out</a>
</div>
</nav>
</aside>
<main class="admin-main">
<div id="designerDashboardPanel" class="admin-panel active"></div>
<div id="designerMyprojectsPanel" class="admin-panel"></div>
<div id="designerAvailablePanel" class="admin-panel"></div>
<div id="designerProofsPanel" class="admin-panel"></div>
<div id="designerMessagesPanel" class="admin-panel"></div>
</main>
</div>
    `;
    showDesignerPanel('dashboard');
}

function showDesignerPanel(panel) {
    document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.admin-nav-link').forEach(l => l.classList.remove('active'));
    const panelEl = document.getElementById('designer' + panel.charAt(0).toUpperCase() + panel.slice(1) + 'Panel');
    if (panelEl) panelEl.classList.add('active');
    document.querySelector(`[data-panel="${panel}"]`)?.classList.add('active');

    const loaders = {
        'dashboard': loadDesignerDashboardPanel,
        'myprojects': loadDesignerProjectsPanel,
        'available': loadDesignerAvailablePanel,
        'proofs': loadDesignerProofsPanel,
        'messages': loadDesignerMessagesPanel
    };
    if (loaders[panel]) loaders[panel]();
}

function loadDesignerDashboardPanel() {
    const myProjects = orders.filter(o => o.assignedDesigner === currentUser.id || o.assignedDesignerId === currentUser.id || o.assignedDesigner === currentUser.name);
    const active = myProjects.filter(o => o.status === 'in_progress');
    const urgent = active.filter(o => {
        const due = new Date(o.dueDate);
        const now = new Date();
        const hoursLeft = (due - now) / (1000 * 60 * 60);
        return hoursLeft < 24 && hoursLeft > 0;
    });

    document.getElementById('designerDashboardPanel').innerHTML = `
<h2 style="font-size: 28px; margin-bottom: 24px;">Designer Dashboard</h2>
<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 32px;">
<div style="background: #111; padding: 24px; border-radius: 12px; border: 1px solid #222;">
<div style="font-size: 32px; font-weight: 700; color: var(--red);">${active.length}</div>
<div style="color: #888; font-size: 14px;">Active Projects</div>
</div>
<div style="background: #111; padding: 24px; border-radius: 12px; border: 1px solid #222;">
<div style="font-size: 32px; font-weight: 700; color: #f59e0b;">${urgent.length}</div>
<div style="color: #888; font-size: 14px;">Due in 24hrs</div>
</div>
<div style="background: #111; padding: 24px; border-radius: 12px; border: 1px solid #222;">
<div style="font-size: 32px; font-weight: 700; color: #10b981;">${myProjects.filter(o => o.status === 'delivered').length}</div>
<div style="color: #888; font-size: 14px;">Completed</div>
</div>
<div style="background: #111; padding: 24px; border-radius: 12px; border: 1px solid #222;">
<div style="font-size: 32px; font-weight: 700;">$${myProjects.reduce((sum, o) => sum + (o.estimate || 0), 0).toLocaleString()}</div>
<div style="color: #888; font-size: 14px;">Total Earned</div>
</div>
</div>
<h2 style="font-size: 20px; margin-bottom: 16px;">⏰ Active Projects</h2>
        ${active.length > 0 ? active.map(p => {
            const client = clients.find(c => c.id === p.clientId);
            const due = new Date(p.dueDate);
            const now = new Date();
            const hoursLeft = Math.max(0, Math.floor((due - now) / (1000 * 60 * 60)));
            const isUrgent = hoursLeft < 24;
            return `<div style="background: #111; padding: 20px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid ${isUrgent ? '#ef4444' : '#10b981'};">
<div style="display: flex; justify-content: space-between; align-items: center;">
<div>
<div style="font-weight: 600; font-size: 16px;">${p.projectName}</div>
<div style="color: #888; font-size: 13px;">Client: ${client?.name || 'Unknown'} · $${(p.estimate || 0).toLocaleString()}</div>
</div>
<div style="text-align: right;">
<div style="font-size: 24px; font-weight: 700; color: ${isUrgent ? '#ef4444' : '#10b981'};">${hoursLeft}h</div>
<div style="font-size: 11px; color: #888;">remaining</div>
</div>
</div>
<div style="margin-top: 12px; display: flex; gap: 8px;">
<button onclick="showDesignerPanel('proofs'); selectProjectForProof(${p.id})" style="padding: 8px 16px; background: var(--red); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">Upload Proof</button>
<button onclick="openDesignerChat(${p.id})" style="padding: 8px 16px; background: #333; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">Message Admin</button>
</div>
</div>`;
        }).join('') : '<p style="color: #888;">No active projects. Check available jobs!</p>'}
    `;
}

function loadDesignerProjectsPanel() {
    const myProjects = orders.filter(o => o.assignedDesigner === currentUser.id || o.assignedDesignerId === currentUser.id || o.assignedDesigner === currentUser.name);
    document.getElementById('designerMyprojectsPanel').innerHTML = `
<h2 style="font-size: 28px; margin-bottom: 24px;">My Projects</h2>
        ${myProjects.length > 0 ? myProjects.map(p => {
            const client = clients.find(c => c.id === p.clientId);
            return `<div style="background: #111; padding: 20px; border-radius: 12px; margin-bottom: 12px;">
<div style="display: flex; justify-content: space-between; align-items: center;">
<div>
<div style="font-weight: 600;">${p.projectName}</div>
<div style="color: #888; font-size: 13px;">Client: ${client?.name || 'Unknown'}</div>
</div>
<span style="padding: 6px 12px; border-radius: 20px; font-size: 12px; background: ${p.status === 'delivered' ? '#10b98120' : p.status === 'in_progress' ? '#3b82f620' : '#f59e0b20'}; color: ${p.status === 'delivered' ? '#10b981' : p.status === 'in_progress' ? '#3b82f6' : '#f59e0b'};">${p.status}</span>
</div>
</div>`;
        }).join('') : '<p style="color: #888;">No projects assigned yet.</p>'}
    `;
}

function loadDesignerAvailablePanel() {
    const available = orders.filter(o => !o.assignedDesigner && o.status !== 'delivered');
    document.getElementById('designerAvailablePanel').innerHTML = `
<h2 style="font-size: 28px; margin-bottom: 24px;">Available Jobs</h2>
<p style="color: #888; margin-bottom: 24px;">Accept a job to start the 72-hour timer</p>
        ${available.length > 0 ? available.map(p => {
            const client = clients.find(c => c.id === p.clientId);
            return `<div style="background: #111; padding: 20px; border-radius: 12px; margin-bottom: 12px; border: 1px solid #333;">
<div style="display: flex; justify-content: space-between; align-items: start;">
<div>
<div style="font-weight: 600; font-size: 18px;">${p.projectName}</div>
<div style="color: #888; font-size: 13px; margin-top: 4px;">${p.description || 'No description'}</div>
<div style="margin-top: 12px; display: flex; gap: 16px; font-size: 13px;">
<span style="color: #10b981; font-weight: 600;">💰 $${(p.estimate || 0).toLocaleString()}</span>
<span style="color: #888;">⏱️ ${p.turnaround || '72 hours'}</span>
</div>
</div>
<button onclick="acceptDesignerJob(${p.id})" style="padding: 12px 24px; background: #10b981; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Accept Job</button>
</div>
</div>`;
        }).join('') : '<p style="color: #888;">No available jobs right now. Check back soon!</p>'}
    `;
}

async function acceptDesignerJob(orderId) {
    const order = orders.find(o => o.id === orderId);
    if (!order) return;

    if (!confirm(`Accept "${order.projectName}" for $${(order.estimate || 0).toLocaleString()}?\n\nYou will have 72 hours to deliver the first proof.`)) return;

    order.assignedDesigner = currentUser.id;
    order.assignedDesignerId = currentUser.id;
    order.status = 'in_progress';
    order.acceptedAt = new Date().toISOString();
    // Use turnaround from service package if available, else default 72 hours
    const turnaroundHours = (order.turnaroundDaysMin || 3) * 24;
    order.dueDate = new Date(Date.now() + turnaroundHours * 60 * 60 * 1000).toISOString();
    addStatusHistory(order, 'assigned', `${currentUser.name} accepted the project`);
    addStatusHistory(order, 'in_progress', 'Work started');
    saveOrders();

    // Notify admin
    addDesignerMessage(currentUser.id, orderId, `${currentUser.name} accepted the project "${order.projectName}"`, 'system');

    // Notify client that work has begun
    const client = clients.find(c => c.id === order.clientId);
    if (client?.email) {
        try {
            await fetch('/.netlify/functions/send-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    to: client.email,
                    subject: `🎨 Work Started on ${order.projectName}!`,
                    html: `<div style="font-family: -apple-system, sans-serif; max-width: 600px; margin: 0 auto; background: #0a0a0a; color: #fff; border-radius: 12px; overflow: hidden;">
<div style="background: linear-gradient(135deg, #3b82f6, #60a5fa); padding: 32px; text-align: center;">
<h2 style="margin: 0; font-size: 24px; color: #fff;">Your Project is Underway!</h2>
</div>
<div style="padding: 32px;">
<p style="color: #ccc;">Hey ${client.name}, a designer has started working on <strong>${order.projectName}</strong>. You'll receive proof files for review soon!</p>
<p style="color: #888; font-size: 14px; margin-top: 24px;">Estimated turnaround: <strong>${order.turnaround || 'TBD'}</strong></p>
</div>
<div style="background: #050505; padding: 20px; text-align: center; border-top: 1px solid #222;"><p style="color: #666; font-size: 12px; margin: 0;">New Urban Influence • Detroit, MI</p></div>
</div>`,
                    text: `Work has started on your project "${order.projectName}"! Estimated turnaround: ${order.turnaround || 'TBD'}.`
                })
            });
        } catch (err) { console.log('Client notification failed:', err.message); }
    }

    // Log to CRM
    logProofActivity('assigned', { clientId: order.clientId, projectName: order.projectName }, `Designer ${currentUser.name} accepted "${order.projectName}"`);

    alert('Job accepted! Turnaround: ' + (order.turnaround || '72 hours'));
    loadDesignerAvailablePanel();
}

function loadDesignerProofsPanel() {
    const myProjects = orders.filter(o => (o.assignedDesigner === currentUser.id || o.assignedDesignerId === currentUser.id || o.assignedDesigner === currentUser.name) && o.status === 'in_progress');
    document.getElementById('designerProofsPanel').innerHTML = `
<h2 style="font-size: 28px; margin-bottom: 24px;">Upload Proofs</h2>
<div style="margin-bottom: 24px;">
<label style="display: block; margin-bottom: 8px; color: #888;">Select Project</label>
<select id="proofProjectSelect" onchange="loadProofUploadArea()" style="width: 100%; padding: 12px; background: #111; border: 1px solid #333; color: #fff; border-radius: 8px;">
<option value="">-- Select a project --</option>
                ${myProjects.map(p => `<option value="${p.id}">${p.projectName}</option>`).join('')}
</select>
</div>
<div id="proofUploadArea"></div>
    `;
}

function loadProofUploadArea() {
    const projectId = document.getElementById('proofProjectSelect')?.value;
    if (!projectId) {
        document.getElementById('proofUploadArea').innerHTML = '';
        return;
    }

    const project = orders.find(o => o.id == projectId);
    const projectProofs = proofs.filter(p => p.projectId == projectId);

    document.getElementById('proofUploadArea').innerHTML = `
<div style="background: #111; padding: 24px; border-radius: 12px; border: 2px dashed #333; text-align: center; margin-bottom: 24px;">
<input type="file" id="proofFileInput" multiple accept="image/*,.pdf" style="display: none;" onchange="handleDesignerProofUpload(${projectId})">
<div style="font-size: 48px; margin-bottom: 12px;">📤</div>
<p style="margin-bottom: 16px;">Drag & drop proof files or click to browse</p>
<button onclick="document.getElementById('proofFileInput').click()" style="padding: 12px 24px; background: var(--red); color: #fff; border: none; border-radius: 8px; cursor: pointer;">Select Files</button>
</div>
<div>
<label style="display: block; margin-bottom: 8px; color: #888;">Notes for Admin</label>
<textarea id="proofNotes" placeholder="Add any notes about this proof..." style="width: 100%; padding: 12px; background: #111; border: 1px solid #333; color: #fff; border-radius: 8px; min-height: 100px;"></textarea>
</div>
        ${projectProofs.length > 0 ? `
<h3 style="margin-top: 24px; margin-bottom: 16px;">Previous Proofs</h3>
        ${projectProofs.map(p => `<div style="background: #111; padding: 16px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
<div>
<div style="font-weight: 500;">Version ${p.version}</div>
<div style="color: #888; font-size: 12px;">${new Date(p.uploadedAt).toLocaleDateString()}</div>
</div>
<span style="padding: 4px 12px; border-radius: 12px; font-size: 12px; background: ${p.status === 'approved' ? '#10b98120' : p.status === 'rejected' ? '#ef444420' : '#f59e0b20'}; color: ${p.status === 'approved' ? '#10b981' : p.status === 'rejected' ? '#ef4444' : '#f59e0b'};">${p.status}</span>
</div>`).join('')}
        ` : ''}
    `;
}

function handleDesignerProofUpload(projectId) {
    const files = document.getElementById('proofFileInput').files;
    const notes = document.getElementById('proofNotes')?.value || '';

    if (files.length === 0) return;

    const projectProofs = proofs.filter(p => p.projectId == projectId);
    const version = projectProofs.length + 1;
    const project = orders.find(o => o.id == projectId);
    const client = project ? clients.find(c => c.id === project.clientId) : null;

    Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = async function(e) {
            const newProof = {
                id: Date.now(),
                projectId: parseInt(projectId),
                designerId: currentUser.id,
                designerName: currentUser.name || currentUser.email,
                version: version,
                fileName: file.name,
                fileData: e.target.result,
                notes: notes,
                clientId: client?.id || null,
                clientName: client?.name || null,
                projectName: project?.projectName || project?.project || '',
                status: 'pending_admin', // Goes to admin first
                uploadedAt: new Date().toISOString()
            };
            proofs.push(newProof);
            saveProofs();

            // Notify admin via messaging
            addDesignerMessage(currentUser.id, projectId, `New proof uploaded for review (Version ${version})`, 'proof');

            // Send real email notification to admin
            try {
                await fetch('/.netlify/functions/send-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to: 'newurbaninfluence@gmail.com',
                        subject: `📤 New Proof Uploaded: ${project?.projectName || 'Project'} (v${version}) by ${currentUser.name}`,
                        html: `<div style="font-family: -apple-system, sans-serif; max-width: 600px; margin: 0 auto; background: #0a0a0a; color: #fff; border-radius: 12px; overflow: hidden;">
<div style="background: linear-gradient(135deg, #e63946, #ff6b6b); padding: 24px; text-align: center;">
<h2 style="margin: 0; font-size: 20px; color: #fff;">📤 New Proof Ready for Review</h2>
</div>
<div style="padding: 32px;">
<table style="width: 100%; border-collapse: collapse;">
<tr><td style="padding: 8px 0; color: #888;">Project</td><td style="padding: 8px 0; color: #fff; text-align: right; font-weight: 600;">${project?.projectName || 'N/A'}</td></tr>
<tr><td style="padding: 8px 0; color: #888;">Client</td><td style="padding: 8px 0; color: #fff; text-align: right;">${client?.name || 'N/A'}</td></tr>
<tr><td style="padding: 8px 0; color: #888;">Designer</td><td style="padding: 8px 0; color: #fff; text-align: right;">${currentUser.name}</td></tr>
<tr><td style="padding: 8px 0; color: #888;">Version</td><td style="padding: 8px 0; color: #fff; text-align: right;">v${version}</td></tr>
<tr><td style="padding: 8px 0; color: #888;">File</td><td style="padding: 8px 0; color: #fff; text-align: right;">${file.name}</td></tr>
                                    ${notes ? '<tr><td style="padding: 8px 0; color: #888;">Notes</td><td style="padding: 8px 0; color: #fff; text-align: right;">' + notes + '</td></tr>' : ''}
</table>
<p style="color: #888; font-size: 13px; margin-top: 24px;">Log into the admin panel → ✅ Proof Approval to review.</p>
</div>
</div>`,
                        text: `New proof uploaded for ${project?.projectName || 'project'} (v${version}) by ${currentUser.name}. File: ${file.name}. ${notes ? 'Notes: ' + notes : ''}`
                    })
                });
                console.log('📧 Admin notification sent for proof upload');
            } catch (err) {
                console.log('Admin email failed (non-fatal):', err.message);
            }

            // Log to CRM communications
            logProofActivity('upload', newProof, `${currentUser.name} uploaded proof v${version} for ${project?.projectName || 'project'}`);

            alert('Proof uploaded! Admin has been notified via email.');
            loadProofUploadArea();
        };
        reader.readAsDataURL(file);
    });
}

// ==================== DESIGNER-ADMIN MESSAGING ====================
let designerMessages = JSON.parse(localStorage.getItem('nui_designer_messages')) || [];
function saveDesignerMessages() { localStorage.setItem('nui_designer_messages', JSON.stringify(designerMessages)); syncToBackend('designer_messages', designerMessages); }

function addDesignerMessage(designerId, projectId, message, type = 'message', fromAdmin = false) {
    designerMessages.push({
        id: Date.now(),
        designerId,
        projectId,
        message,
        type,
        fromAdmin,
        read: false,
        createdAt: new Date().toISOString()
    });
    saveDesignerMessages();
}

// ═══════════════════════════════════════════════
// CLIENT MESSAGING SYSTEM
// ═══════════════════════════════════════════════
let clientMessages = JSON.parse(localStorage.getItem('nui_client_messages')) || [];
function saveClientMessages() { localStorage.setItem('nui_client_messages', JSON.stringify(clientMessages)); syncToBackend('client_messages', clientMessages); }

function addClientMessage(clientId, projectId, message, type = 'message', fromAdmin = false) {
    clientMessages.push({
        id: Date.now(),
        clientId,
        projectId,
        message,
        type,
        fromAdmin,
        read: false,
        createdAt: new Date().toISOString()
    });
    saveClientMessages();
}

function sendAdminMessageToClient(clientId, projectId) {
    const msg = prompt('Message to client:');
    if (!msg) return;
    addClientMessage(clientId, projectId, msg, 'message', true);
    alert('✅ Message sent to client');
    if (typeof loadAdminClientsPanel === 'function') loadAdminClientsPanel();
}

function loadClientMessagesPanel() {
    if (!currentUser) return;
    const clientId = currentUser.clientId || currentUser.id;
    const myMessages = clientMessages.filter(m => m.clientId === clientId).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

    // Mark unread as read
    myMessages.filter(m => !m.read && m.fromAdmin).forEach(m => m.read = true);
    saveClientMessages();

    document.getElementById('clientPortalContent').innerHTML = `
<div style="max-width: 800px; margin: 0 auto; padding: 24px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
<h2 style="font-size: 24px; margin: 0;">Messages</h2>
<button onclick="loadClientDashboard()" style="padding: 8px 16px; background: #333; color: #fff; border: none; border-radius: 8px; cursor: pointer;">← Back</button>
</div>

            <!-- Send Message -->
<div style="background: #111; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
<textarea id="clientMsgInput" placeholder="Send a message to your project manager..." style="width: 100%; min-height: 80px; background: #0a0a0a; border: 1px solid #333; border-radius: 8px; padding: 12px; color: #fff; font-size: 14px; resize: vertical; box-sizing: border-box;"></textarea>
<div style="display: flex; justify-content: flex-end; margin-top: 12px;">
<button onclick="submitClientMessage()" style="padding: 10px 24px; background: #dc2626; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Send Message</button>
</div>
</div>

            <!-- Messages List -->
            ${myMessages.length > 0 ? myMessages.map(m => `
<div style="background: ${m.fromAdmin ? '#0a1628' : '#111'}; border: 1px solid ${m.fromAdmin ? '#1e3a5f' : '#333'}; border-radius: 12px; padding: 16px; margin-bottom: 12px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
<span style="font-weight: 600; color: ${m.fromAdmin ? '#3b82f6' : '#10b981'};">${m.fromAdmin ? '👤 NUI Team' : '💬 You'}</span>
<span style="font-size: 12px; color: #666;">${new Date(m.createdAt).toLocaleString()}</span>
</div>
<p style="margin: 0; color: #ddd; line-height: 1.5;">${m.message}</p>
                    ${m.projectId ? '<div style="font-size: 11px; color: #555; margin-top: 8px;">Project #' + m.projectId + '</div>' : ''}
</div>
            `).join('') : '<div style="text-align: center; padding: 40px; color: #888;"><div style="font-size: 48px; margin-bottom: 16px;">💬</div><p>No messages yet. Send a message to your project manager above!</p></div>'}
</div>
    `;
}

function submitClientMessage() {
    const input = document.getElementById('clientMsgInput');
    if (!input || !input.value.trim()) return;
    const clientId = currentUser.clientId || currentUser.id;
    addClientMessage(clientId, null, input.value.trim(), 'message', false);

    // Also log to CRM communications hub
    if (typeof communicationsHub !== 'undefined') {
        const client = clients.find(c => c.id === clientId);
        communicationsHub.inbox.unshift({
            id: Date.now(),
            type: 'client-message',
            subject: 'New message from ' + (client?.name || 'Client'),
            from: client?.email || 'client',
            to: 'admin',
            body: input.value.trim(),
            date: new Date().toISOString(),
            read: false,
            channel: 'client-portal'
        });
        if (typeof saveCommunicationsHub === 'function') saveCommunicationsHub();
    }

    loadClientMessagesPanel();
}

function loadDesignerMessagesPanel() {
    const myMessages = designerMessages.filter(m => m.designerId === currentUser.id).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

    // Mark as read
    myMessages.forEach(m => m.read = true);
    saveDesignerMessages();

    document.getElementById('designerMessagesPanel').innerHTML = `
<h2 style="font-size: 28px; margin-bottom: 24px;">Messages with Admin</h2>
<div style="margin-bottom: 24px; display: flex; gap: 12px;">
<input type="text" id="newMessageInput" placeholder="Type a message to admin..." style="flex: 1; padding: 12px; background: #111; border: 1px solid #333; color: #fff; border-radius: 8px;">
<button onclick="sendMessageToAdmin()" style="padding: 12px 24px; background: var(--red); color: #fff; border: none; border-radius: 8px; cursor: pointer;">Send</button>
</div>
<div style="max-height: 500px; overflow-y: auto;">
            ${myMessages.length > 0 ? myMessages.map(m => `
<div style="background: ${m.fromAdmin ? '#1a1a2e' : '#111'}; padding: 16px; border-radius: 12px; margin-bottom: 8px; border-left: 3px solid ${m.fromAdmin ? '#3b82f6' : 'var(--red)'};">
<div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
<span style="font-weight: 600; color: ${m.fromAdmin ? '#3b82f6' : 'var(--red)'};">${m.fromAdmin ? '👤 Admin' : '🎨 You'}</span>
<span style="color: #666; font-size: 12px;">${new Date(m.createdAt).toLocaleString()}</span>
</div>
<p style="margin: 0;">${m.message}</p>
</div>
            `).join('') : '<p style="color: #888; text-align: center;">No messages yet.</p>'}
</div>
    `;
}

function sendMessageToAdmin() {
    const input = document.getElementById('newMessageInput');
    const message = input?.value?.trim();
    if (!message) return;

    addDesignerMessage(currentUser.id, null, message, 'message', false);
    input.value = '';
    loadDesignerMessagesPanel();
}

function openDesignerChat(projectId) {
    showDesignerPanel('messages');
}

// ==================== CLIENT DASHBOARD ====================
function loadClientDashboard() {
    if (!currentUser || currentUser.type !== 'client') return;

    const client = clients.find(c => c.id === currentUser.clientId);
    if (!client) { portalLogout(); return; }

    const myOrders = orders.filter(o => o.clientId === client.id);
    const myInvoices = invoices.filter(i => i.clientId === client.id);
    const unpaidInvoices = myInvoices.filter(i => i.status !== 'paid');
    const myMsgs = (typeof clientMessages !== 'undefined') ? clientMessages.filter(m => m.clientId === client.id) : [];
    const unreadMsgs = myMsgs.filter(m => !m.read && m.fromAdmin);
    const activeOrders = myOrders.filter(o => o.status !== 'delivered');
    const totalOwed = unpaidInvoices.reduce((sum, i) => sum + (i.total || 0), 0);

    document.getElementById('clientPortal').style.display = 'block';
    document.getElementById('clientPortalContent').innerHTML = `
<div style="max-width: 1200px; margin: 0 auto; padding: 24px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
<div>
<h2 style="font-size: 32px; font-weight: 700;">Welcome back, ${client.name}</h2>
<p style="color: #888;">Manage your projects, invoices, and brand assets</p>
</div>
<button onclick="portalLogout()" style="padding: 10px 20px; background: #333; color: #fff; border: none; border-radius: 8px; cursor: pointer;">Sign Out</button>
</div>

            <!-- Stats Row -->
<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
<div style="background: #111; border-radius: 12px; padding: 20px; border: 1px solid #222;">
<div style="color: #888; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Active Projects</div>
<div style="font-size: 32px; font-weight: 700; color: #3b82f6; margin-top: 4px;">${activeOrders.length}</div>
</div>
<div style="background: #111; border-radius: 12px; padding: 20px; border: 1px solid #222;">
<div style="color: #888; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Total Orders</div>
<div style="font-size: 32px; font-weight: 700; color: #fff; margin-top: 4px;">${myOrders.length}</div>
</div>
<div style="background: #111; border-radius: 12px; padding: 20px; border: 1px solid #222;">
<div style="color: #888; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Outstanding Balance</div>
<div style="font-size: 32px; font-weight: 700; color: ${totalOwed > 0 ? '#ef4444' : '#10b981'}; margin-top: 4px;">$${totalOwed.toLocaleString()}</div>
</div>
<div style="background: #111; border-radius: 12px; padding: 20px; border: 1px solid #222;">
<div style="color: #888; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Messages</div>
<div style="font-size: 32px; font-weight: 700; color: ${unreadMsgs.length > 0 ? '#f59e0b' : '#fff'}; margin-top: 4px;">${unreadMsgs.length > 0 ? unreadMsgs.length + ' new' : myMsgs.length}</div>
</div>
</div>

            <!-- Quick Actions -->
<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 32px;">
<button onclick="showClientNewOrder()" style="padding: 24px; background: linear-gradient(135deg, var(--red), #ff6b6b); color: #fff; border: none; border-radius: 12px; cursor: pointer; text-align: left;">
<div style="font-size: 24px; margin-bottom: 8px;">➕</div>
<div style="font-weight: 600;">New Order</div>
</button>
<button onclick="showClientInvoices()" style="padding: 24px; background: #111; border: 1px solid #333; color: #fff; border-radius: 12px; cursor: pointer; text-align: left;">
<div style="font-size: 24px; margin-bottom: 8px;">📄</div>
<div style="font-weight: 600;">Invoices ${unpaidInvoices.length > 0 ? '<span style="color: #ef4444;">(' + unpaidInvoices.length + ')</span>' : ''}</div>
</button>
<button onclick="loadClientMessagesPanel()" style="padding: 24px; background: #111; border: 1px solid ${unreadMsgs.length > 0 ? '#f59e0b' : '#333'}; color: #fff; border-radius: 12px; cursor: pointer; text-align: left; position: relative;">
<div style="font-size: 24px; margin-bottom: 8px;">💬</div>
<div style="font-weight: 600;">Messages</div>
                    ${unreadMsgs.length > 0 ? '<div style="position: absolute; top: 12px; right: 12px; width: 22px; height: 22px; background: #f59e0b; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: #000;">' + unreadMsgs.length + '</div>' : ''}
</button>
<button onclick="showClientPortal(client)" style="padding: 24px; background: #111; border: 1px solid #333; color: #fff; border-radius: 12px; cursor: pointer; text-align: left;">
<div style="font-size: 24px; margin-bottom: 8px;">🎨</div>
<div style="font-weight: 600;">Brand Portal</div>
</button>
<button onclick="openMeetingModal()" style="padding: 24px; background: #111; border: 1px solid #333; color: #fff; border-radius: 12px; cursor: pointer; text-align: left;">
<div style="font-size: 24px; margin-bottom: 8px;">📅</div>
<div style="font-weight: 600;">Book Meeting</div>
</button>
</div>

            <!-- Subscription Plans Section -->
            ${(() => {
                const clientSubs = subscriptions.filter(s => s.clientId === client.id && s.status === 'active');
                if (clientSubs.length === 0) return '';
                const sub = clientSubs[0];
                const plan = subscriptionPlans.find(p => p.id === sub.planId);
                const nextBillingDate = new Date(sub.nextBillingDate);
                const daysUntilBilling = Math.ceil((nextBillingDate - new Date()) / (1000 * 60 * 60 * 24));
                const activeOrders = myOrders.filter(o => !['delivered', 'completed', 'cancelled'].includes(o.status));
                const progressPercent = plan.orderLimit ? Math.min(100, (activeOrders.length / plan.orderLimit) * 100) : 0;
                return `
<div style="background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%); border: 1px solid #e63946; border-radius: 16px; padding: 24px; margin-bottom: 24px;">
<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
<div>
<h2 style="font-size: 20px; margin: 0; color: #fff;">Your Plan</h2>
<p style="color: #888; font-size: 13px; margin-top: 4px;">Subscription Management</p>
</div>
<div style="text-align: right;">
<div style="font-size: 28px; font-weight: 700; color: #e63946;">$${plan.price}</div>
<div style="color: #888; font-size: 12px;">per month</div>
</div>
</div>
<div style="background: #111; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
<span style="font-weight: 600; color: #fff;">${plan.name}</span>
<span style="padding: 4px 12px; background: #10b981; color: #000; border-radius: 100px; font-size: 11px; font-weight: 600;">✓ Active</span>
</div>
<div style="font-size: 13px; color: rgba(255,255,255,0.6); line-height: 1.6;">
                            ${plan.features.slice(0, 3).map(f => '• ' + f).join('<br>')}
                            ${plan.features.length > 3 ? '<br>+ ' + (plan.features.length - 3) + ' more features' : ''}
</div>
                        ${plan.orderLimit ? `
<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #222;">
<div style="font-size: 12px; color: #888; margin-bottom: 8px;">Active Orders: ${activeOrders.length} / ${plan.orderLimit}</div>
<div style="height: 4px; background: #222; border-radius: 2px; overflow: hidden;">
<div style="width: ${progressPercent}%; height: 100%; background: #e63946; border-radius: 2px;"></div>
</div>
</div>
                        ` : ''}
</div>
<div style="display: flex; gap: 8px; font-size: 13px; color: rgba(255,255,255,0.6);">
<span>📅 Next billing:</span>
<span>${nextBillingDate.toLocaleDateString()} (in ${daysUntilBilling} days)</span>
</div>
</div>
                `;
            })()}

            <!-- My Active Projects (expanded cards) -->
<div style="background: #111; border-radius: 16px; padding: 24px; margin-bottom: 24px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h2 style="font-size: 20px; margin: 0;">My Projects</h2>
<span style="color: #888; font-size: 13px;">${activeOrders.length} active, ${myOrders.filter(o => o.status === 'delivered').length} completed</span>
</div>
                ${myOrders.length > 0 ? myOrders.slice().reverse().slice(0, 8).map(o => {
                    const daysElapsed = o.createdAt ? Math.floor((new Date() - new Date(o.createdAt)) / (1000*60*60*24)) : 0;
                    const turnaroundMin = o.turnaroundDaysMin || 7;
                    const turnaroundMax = o.turnaroundDaysMax || 14;
                    const isOverdue = daysElapsed > turnaroundMax && o.status !== 'delivered';
                    const isNearDue = daysElapsed >= turnaroundMin && daysElapsed <= turnaroundMax && o.status !== 'delivered';
                    const progressPct = o.status === 'delivered' ? 100 : o.status === 'review' ? 80 : o.status === 'in_progress' ? 50 : o.status === 'assigned' ? 25 : 10;
                    const myInvoice = invoices.find(i => i.orderId === o.id);
                    const designerName = o.assignedDesigner || null;
                    const statusColors = { pending: '#f59e0b', assigned: '#6366f1', in_progress: '#3b82f6', review: '#8b5cf6', delivered: '#10b981' };
                    const statusIcons = { pending: '📥', assigned: '👤', in_progress: '🎨', review: '👁️', delivered: '✅' };
                    const statusLabel = (o.status || 'pending').replace('_', ' ');
                    return `
<div style="padding: 20px; background: #0a0a0a; border: 1px solid #222; border-radius: 12px; margin-bottom: 12px;">
<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
<div>
<div style="font-weight: 700; font-size: 16px; margin-bottom: 4px;">${o.projectName}</div>
<div style="color: #888; font-size: 13px;">${o.packageName || 'Custom'} • Created ${new Date(o.createdAt).toLocaleDateString()}</div>
</div>
<span style="padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ${(statusColors[o.status] || '#f59e0b')}20; color: ${statusColors[o.status] || '#f59e0b'};">${statusIcons[o.status] || '📥'} ${statusLabel}</span>
</div>
                        <!-- Turnaround Progress -->
<div style="margin-bottom: 12px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
<span style="font-size: 12px; color: #888;">Turnaround Progress</span>
<span style="font-size: 12px; font-weight: 600; color: ${o.status === 'delivered' ? '#10b981' : isOverdue ? '#ef4444' : isNearDue ? '#f59e0b' : '#3b82f6'};">${o.status === 'delivered' ? 'Delivered!' : isOverdue ? 'Overdue (' + daysElapsed + ' days)' : 'Day ' + daysElapsed + ' of ' + turnaroundMin + '-' + turnaroundMax}</span>
</div>
<div style="height: 6px; background: #222; border-radius: 3px; overflow: hidden;">
<div style="width: ${progressPct}%; height: 100%; background: ${o.status === 'delivered' ? '#10b981' : isOverdue ? '#ef4444' : isNearDue ? '#f59e0b' : '#3b82f6'}; border-radius: 3px; transition: width 0.3s;"></div>
</div>
</div>
                        <!-- Designer + Payment Row -->
<div style="display: flex; justify-content: space-between; align-items: center; gap: 16px; flex-wrap: wrap;">
<div style="display: flex; gap: 16px; align-items: center;">
                                ${designerName ? '<div style="display: flex; align-items: center; gap: 8px;"><div style="width: 28px; height: 28px; background: linear-gradient(135deg, #6366f1, #8b5cf6); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700;">' + (designerName.charAt(0) || 'D').toUpperCase() + '</div><div><div style="font-size: 13px; font-weight: 500;">' + designerName + '</div><div style="font-size: 11px; color: #888;">Your Designer</div></div></div>' : '<div style="font-size: 13px; color: #666;">Awaiting designer assignment</div>'}
                                ${o.turnaround ? '<div style="font-size: 12px; color: #888; padding: 4px 10px; background: #1a1a1a; border-radius: 6px;">⏱️ ' + o.turnaround + '</div>' : ''}
</div>
<div style="display: flex; gap: 8px; align-items: center;">
                                ${myInvoice ? (myInvoice.status === 'paid' ? '<span style="font-size: 12px; color: #10b981; font-weight: 600;">Paid</span>' : '<button onclick="payInvoice(' + myInvoice.id + ')" style="padding: 8px 20px; background: #10b981; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">Pay $' + (myInvoice.total || 0).toLocaleString() + '</button>') : ''}
</div>
</div>
</div>`;
                }).join('') : '<div style="text-align: center; padding: 40px; color: #888;"><div style="font-size: 48px; margin-bottom: 16px;">🎨</div><p>No projects yet. Start your first one!</p><button onclick="showClientNewOrder()" style="margin-top: 12px; padding: 12px 28px; background: var(--red); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Start a Project →</button></div>'}
</div>

            <!-- Two-column: Invoices + Messages Preview -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                <!-- Invoices -->
<div style="background: #111; border-radius: 16px; padding: 24px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
<h2 style="font-size: 18px; margin: 0;">Invoices</h2>
<button onclick="showClientInvoices()" style="font-size: 13px; color: #dc2626; background: none; border: none; cursor: pointer;">View All →</button>
</div>
                    ${myInvoices.length > 0 ? myInvoices.slice(0, 4).map(i => `
<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #1a1a1a;">
<div>
<div style="font-weight: 500; font-size: 14px;">${i.invoiceNumber || 'INV-' + i.id}</div>
<div style="color: #888; font-size: 12px;">$${(i.total || 0).toLocaleString()} ${i.type === 'estimate' ? '(Estimate)' : ''}</div>
</div>
<div style="display: flex; gap: 8px; align-items: center;">
<span style="padding: 4px 10px; border-radius: 12px; font-size: 11px; background: ${i.status === 'paid' ? '#10b98120' : i.status === 'estimate' ? '#6366f120' : '#ef444420'}; color: ${i.status === 'paid' ? '#10b981' : i.status === 'estimate' ? '#6366f1' : '#ef4444'};">${i.status}</span>
                                ${i.status !== 'paid' && i.status !== 'estimate' ? '<button onclick="payInvoice(' + i.id + ')" style="padding: 6px 12px; background: #10b981; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Pay</button>' : ''}
</div>
</div>
                    `).join('') : '<p style="color: #666; font-size: 14px;">No invoices yet.</p>'}
</div>

                <!-- Messages Preview -->
<div style="background: #111; border-radius: 16px; padding: 24px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
<h2 style="font-size: 18px; margin: 0;">Messages ${unreadMsgs.length > 0 ? '<span style="color: #f59e0b; font-size: 14px;">(' + unreadMsgs.length + ' new)</span>' : ''}</h2>
<button onclick="loadClientMessagesPanel()" style="font-size: 13px; color: #dc2626; background: none; border: none; cursor: pointer;">Open Chat →</button>
</div>
                    ${myMsgs.length > 0 ? myMsgs.slice(0, 3).map(m => `
<div style="padding: 12px; background: ${m.fromAdmin ? '#0a1628' : '#0a0a0a'}; border: 1px solid ${m.fromAdmin ? '#1e3a5f' : '#222'}; border-radius: 8px; margin-bottom: 8px;">
<div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
<span style="font-size: 12px; font-weight: 600; color: ${m.fromAdmin ? '#3b82f6' : '#10b981'};">${m.fromAdmin ? 'NUI Team' : 'You'}</span>
<span style="font-size: 11px; color: #555;">${new Date(m.createdAt).toLocaleDateString()}</span>
</div>
<p style="margin: 0; font-size: 13px; color: #bbb; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${m.message}</p>
</div>
                    `).join('') : '<div style="text-align: center; padding: 24px; color: #666;"><div style="font-size: 32px; margin-bottom: 8px;">💬</div><p style="font-size: 13px;">No messages yet</p><button onclick="loadClientMessagesPanel()" style="margin-top: 8px; padding: 8px 20px; background: #dc2626; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 13px;">Send a Message</button></div>'}
</div>
</div>

            <!-- My Info -->
<div style="background: #111; border-radius: 16px; padding: 24px;">
<h2 style="font-size: 18px; margin-bottom: 16px;">My Information</h2>
<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px;">
<div><div style="color: #888; font-size: 12px; margin-bottom: 4px;">Business Name</div><div>${client.name}</div></div>
<div><div style="color: #888; font-size: 12px; margin-bottom: 4px;">Contact</div><div>${client.contact || client.name}</div></div>
<div><div style="color: #888; font-size: 12px; margin-bottom: 4px;">Email</div><div>${client.email}</div></div>
<div><div style="color: #888; font-size: 12px; margin-bottom: 4px;">Phone</div><div>${client.phone || 'Not set'}</div></div>
<div><div style="color: #888; font-size: 12px; margin-bottom: 4px;">Industry</div><div>${client.industry || 'Not set'}</div></div>
<div><div style="color: #888; font-size: 12px; margin-bottom: 4px;">Website</div><div>${client.website ? '<a href="' + client.website + '" target="_blank" style="color: #3b82f6;">' + client.website + '</a>' : 'Not set'}</div></div>
</div>
</div>
</div>
    `;
}

function showClientNewOrder() {
    const client = clients.find(c => c.id === currentUser.clientId);
    if (!client) return;

    document.getElementById('clientPortalContent').innerHTML = `
<div style="max-width: 800px; margin: 0 auto; padding: 24px;">
<button onclick="loadClientDashboard()" style="margin-bottom: 24px; padding: 10px 20px; background: #333; color: #fff; border: none; border-radius: 8px; cursor: pointer;">← Back to Dashboard</button>
<h2 style="font-size: 28px; margin-bottom: 8px;">Start a New Project</h2>
<p style="color: #888; margin-bottom: 32px;">Select a service package or request a custom quote</p>

            <!-- Service Packages -->
<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 16px; margin-bottom: 32px;">
                ${servicePackages.map(pkg => `
<div onclick="selectClientPackage('${pkg.id}')" id="clientPkg-${pkg.id}" style="padding: 24px; background: #111; border: 2px solid #333; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
<div style="font-weight: 600; font-size: 16px; margin-bottom: 8px;">${pkg.name}</div>
<div style="font-size: 24px; font-weight: 700; color: var(--red); margin-bottom: 8px;">${pkg.price > 0 ? '$' + pkg.price.toLocaleString() : 'Custom'}</div>
<div style="font-size: 13px; color: #888; margin-bottom: 4px;">⏱️ ${pkg.turnaround}</div>
<div style="font-size: 13px; color: #666;">${pkg.desc}</div>
</div>
                `).join('')}
</div>

            <!-- Request Form -->
<form onsubmit="submitClientOrder(event)" style="background: #111; padding: 32px; border-radius: 16px; border: 1px solid #333;">
<h2 style="font-size: 20px; margin-bottom: 20px;">Project Details</h2>
<input type="hidden" id="clientSelectedPackage" value="">
<div style="margin-bottom: 16px;">
<label style="display: block; color: #888; font-size: 13px; margin-bottom: 6px;">Project Name *</label>
<input type="text" id="clientProjectName" required style="width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; color: #fff; border-radius: 8px; font-family: inherit;">
</div>
<div style="margin-bottom: 16px;">
<label style="display: block; color: #888; font-size: 13px; margin-bottom: 6px;">Description / Notes</label>
<textarea id="clientProjectDesc" rows="3" style="width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; color: #fff; border-radius: 8px; font-family: inherit; resize: vertical;"></textarea>
</div>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
<div>
<label style="display: block; color: #888; font-size: 13px; margin-bottom: 6px;">Selected Package</label>
<div id="clientPackageDisplay" style="padding: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #888;">None selected — choose above</div>
</div>
<div>
<label style="display: block; color: #888; font-size: 13px; margin-bottom: 6px;">Estimated Total</label>
<div id="clientPriceDisplay" style="padding: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: var(--red); font-weight: 700; font-size: 18px;">—</div>
</div>
</div>
<button type="submit" style="width: 100%; padding: 16px; background: var(--red); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; font-family: inherit;">Submit Order Request</button>
<p style="color: #666; font-size: 12px; text-align: center; margin-top: 12px;">You'll receive an invoice via email after we confirm your project details.</p>
</form>
</div>
    `;
}

function selectClientPackage(pkgId) {
    document.querySelectorAll('[id^="clientPkg-"]').forEach(el => el.style.borderColor = '#333');
    const el = document.getElementById('clientPkg-' + pkgId);
    if (el) el.style.borderColor = 'var(--red)';

    const pkg = servicePackages.find(p => p.id === pkgId);
    document.getElementById('clientSelectedPackage').value = pkgId;
    if (pkg) {
        document.getElementById('clientPackageDisplay').innerHTML = `<span style="color: #fff;">${pkg.name}</span> <span style="color: #888;">• ${pkg.turnaround}</span>`;
        document.getElementById('clientPriceDisplay').textContent = pkg.price > 0 ? '$' + pkg.price.toLocaleString() : 'Custom Quote';
        if (!document.getElementById('clientProjectName').value) {
            document.getElementById('clientProjectName').value = pkg.name;
        }
    }
}

async function submitClientOrder(e) {
    e.preventDefault();
    const client = clients.find(c => c.id === currentUser.clientId);
    if (!client) return;

    const pkgId = document.getElementById('clientSelectedPackage').value;
    const pkg = servicePackages.find(p => p.id === pkgId);

    const order = {
        id: Date.now(),
        clientId: client.id,
        projectName: document.getElementById('clientProjectName').value,
        description: document.getElementById('clientProjectDesc').value,
        estimate: pkg?.price || 0,
        turnaround: pkg?.turnaround || 'TBD',
        turnaroundDaysMin: pkg ? parseInt(pkg.turnaround) || 7 : 7,
        turnaroundDaysMax: pkg ? (parseInt(pkg.turnaround.match(/\d+\s*[-–]\s*(\d+)/)?.[1]) || parseInt(pkg.turnaround) || 14) : 14,
        packageId: pkgId || 'custom',
        packageName: pkg?.name || 'Custom Request',
        dueDate: new Date(Date.now() + (pkg ? (parseInt(pkg.turnaround.match(/(\d+)\s*[-–]\s*(\d+)/)?.[2] || pkg.turnaround) || 14) : 14) * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
        status: 'pending',
        statusHistory: [{ status: 'pending', timestamp: new Date().toISOString(), note: 'Order submitted by client', user: client.name }],
        createdAt: new Date().toISOString(),
        deliveredAt: null,
        deliverables: [],
        paymentStatus: 'unpaid',
        submittedByClient: true
    };
    orders.push(order);
    saveOrders();

    // Create invoice
    const invoice = {
        id: Date.now() + 1,
        invoiceNumber: 'INV-' + order.id,
        clientId: client.id,
        clientName: client.name,
        clientEmail: client.email,
        orderId: order.id,
        projectName: order.projectName,
        lineItems: [{ description: order.projectName, amount: order.estimate }],
        subtotal: order.estimate,
        total: order.estimate,
        dueDate: order.dueDate,
        status: order.estimate > 0 ? 'pending' : 'quote_requested',
        createdAt: new Date().toISOString()
    };
    invoices.push(invoice);
    saveInvoices();

    // Notify admin
    try {
        await fetch('/.netlify/functions/send-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                to: 'newurbaninfluence@gmail.com',
                subject: `🆕 New Order from ${client.name}: ${order.projectName}`,
                html: `<div style="font-family: -apple-system, sans-serif; max-width: 600px; margin: 0 auto; background: #0a0a0a; color: #fff; border-radius: 12px; overflow: hidden;">
<div style="background: var(--red, #e11d48); padding: 32px; text-align: center;"><h2 style="margin: 0; color: #fff;">New Client Order!</h2></div>
<div style="padding: 32px;">
<p style="color: #ccc;">Client <strong>${client.name}</strong> submitted a new order:</p>
<div style="background: #111; border: 1px solid #333; border-radius: 12px; padding: 24px; margin: 16px 0;">
<p style="color: #fff;"><strong>${order.projectName}</strong></p>
<p style="color: #888;">Package: ${order.packageName}</p>
<p style="color: #888;">Amount: <strong style="color: var(--red, #e11d48);">$${order.estimate.toLocaleString()}</strong></p>
                            ${order.description ? '<p style="color: #888;">Notes: ' + order.description + '</p>' : ''}
</div>
<p style="color: #888; font-size: 13px;">Log in to the admin dashboard to assign a designer.</p>
</div>
</div>`,
                text: `New order from ${client.name}: ${order.projectName} — $${order.estimate.toLocaleString()}`
            })
        });
    } catch (err) { console.log('Admin notification failed:', err.message); }

    // Log to CRM
    communicationsHub.inbox.unshift({
        id: Date.now() + 2, platform: 'system', clientId: client.id, clientName: client.name,
        preview: `Client submitted order: ${order.projectName} — $${order.estimate.toLocaleString()}`,
        timestamp: new Date().toISOString(), unread: true,
        metadata: { type: 'client_order', orderId: order.id }
    });
    saveCommHub();

    // Show success
    document.getElementById('clientPortalContent').innerHTML = `
<div style="max-width: 600px; margin: 80px auto; text-align: center; padding: 24px;">
<div style="width: 80px; height: 80px; background: linear-gradient(135deg, #10b981, #34d399); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 36px; color: #fff; margin-bottom: 24px;">✓</div>
<h2 style="font-size: 28px; margin-bottom: 12px;">Order Submitted!</h2>
<p style="color: #888; font-size: 16px; margin-bottom: 32px;">Your <strong>${order.projectName}</strong> order has been received. We'll confirm details and send your invoice shortly.</p>
<div style="background: #111; padding: 24px; border-radius: 12px; text-align: left; margin-bottom: 32px;">
<div style="display: flex; justify-content: space-between; margin-bottom: 8px;"><span style="color: #888;">Order #</span><span>${order.id}</span></div>
<div style="display: flex; justify-content: space-between; margin-bottom: 8px;"><span style="color: #888;">Package</span><span>${order.packageName}</span></div>
<div style="display: flex; justify-content: space-between; margin-bottom: 8px;"><span style="color: #888;">Turnaround</span><span>${order.turnaround}</span></div>
                ${order.estimate > 0 ? `<div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid #333;"><span style="color: #888;">Amount</span><span style="color: var(--red); font-weight: 700; font-size: 18px;">$${order.estimate.toLocaleString()}</span></div>` : `<div style="color: #f59e0b; padding-top: 8px; border-top: 1px solid #333;">Custom quote — we'll follow up within 24 hours</div>`}
</div>
<button onclick="loadClientDashboard()" style="padding: 14px 32px; background: var(--red); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px;">Back to Dashboard</button>
</div>
    `;
}

function showClientInvoices() {
    const client = clients.find(c => c.id === currentUser.clientId);
    const myInvoices = invoices.filter(i => i.clientId === client.id);

    document.getElementById('clientPortalContent').innerHTML = `
<div style="max-width: 800px; margin: 0 auto; padding: 24px;">
<button onclick="loadClientDashboard()" style="margin-bottom: 24px; padding: 10px 20px; background: #333; color: #fff; border: none; border-radius: 8px; cursor: pointer;">← Back to Dashboard</button>
<h2 style="font-size: 28px; margin-bottom: 24px;">My Invoices</h2>
            ${myInvoices.map(i => `
<div style="background: #111; padding: 24px; border-radius: 12px; margin-bottom: 16px;">
<div style="display: flex; justify-content: space-between; align-items: center;">
<div>
<div style="font-weight: 600; font-size: 18px;">${i.invoiceNumber || 'INV-' + i.id}</div>
<div style="color: #888; margin-top: 4px;">Due: ${i.dueDate ? new Date(i.dueDate).toLocaleDateString() : 'N/A'}</div>
</div>
<div style="text-align: right;">
<div style="font-size: 24px; font-weight: 700;">$${(i.total || 0).toLocaleString()}</div>
<span style="padding: 6px 12px; border-radius: 20px; font-size: 12px; background: ${i.status === 'paid' ? '#10b98120' : '#ef444420'}; color: ${i.status === 'paid' ? '#10b981' : '#ef4444'};">${i.status}</span>
</div>
</div>
                    ${i.status !== 'paid' ? `<button onclick="payInvoice(${i.id})" style="width: 100%; margin-top: 16px; padding: 14px; background: #10b981; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Pay $${(i.total || 0).toLocaleString()} Now</button>` : ''}
</div>
            `).join('')}
</div>
    `;
}

async function payInvoice(invoiceId) {
    const inv = invoices.find(i => i.id === invoiceId);
    if (!inv) return;

    // Check if terms already accepted for this invoice
    if (!inv.termsAccepted) {
        showTermsModal({ invoiceId: inv.id, invoice: inv });
        return;
    }

    // Terms already accepted, proceed to payment
    proceedToPayment(inv);
}

async function proceedToPayment(inv) {
    if (!window.STRIPE_PUBLISHABLE_KEY) {
        alert('Payment system not configured. Contact admin to complete payment.');
        return;
    }

    const amount = inv.total || 0;
    if (amount <= 0) {
        alert('Invalid invoice amount.');
        return;
    }

    // Build the Stripe payment modal
    const modalOverlay = document.createElement('div');
    modalOverlay.id = 'stripePaymentModal';
    modalOverlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;';
    modalOverlay.innerHTML = `
<div style="background:#fff;border-radius:16px;max-width:480px;width:90%;padding:32px;position:relative;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
<button onclick="closeStripeModal()" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;">&times;</button>
<div style="text-align:center;margin-bottom:24px;">
<div style="font-size:14px;color:#666;text-transform:uppercase;letter-spacing:1px;">New Urban Influence</div>
<h2 style="margin:8px 0 4px;font-size:22px;">Pay Invoice ${inv.invoiceNumber || ''}</h2>
<div style="font-size:28px;font-weight:700;color:#e63946;">$${amount.toLocaleString('en-US', {minimumFractionDigits:2})}</div>
<div style="font-size:13px;color:#888;margin-top:4px;">${inv.projectName || 'Invoice Payment'}</div>
</div>
<div id="stripeCardElement" style="padding:14px;border:2px solid #e0e0e0;border-radius:8px;margin-bottom:16px;min-height:44px;transition:border-color 0.2s;"></div>
<div id="stripeCardErrors" style="color:#e63946;font-size:13px;margin-bottom:12px;min-height:20px;"></div>
<button id="stripePayBtn" onclick="submitStripePayment()" style="width:100%;padding:14px;background:linear-gradient(135deg,#e63946,#d62839);color:#fff;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:opacity 0.2s;">
                Pay $${amount.toLocaleString('en-US', {minimumFractionDigits:2})}
</button>
<div id="stripePaySpinner" style="display:none;text-align:center;padding:14px;">
<div style="display:inline-block;width:24px;height:24px;border:3px solid #e63946;border-top-color:transparent;border-radius:50%;animation:spin 0.8s linear infinite;"></div>
<div style="margin-top:8px;color:#666;font-size:14px;">Processing payment...</div>
</div>
<div style="text-align:center;margin-top:12px;">
<img loading="lazy" src="https://img.icons8.com/color/32/stripe.png" alt="Stripe" style="height:20px;opacity:0.6;">
<span style="font-size:11px;color:#aaa;vertical-align:middle;margin-left:4px;">Secured by Stripe</span>
</div>
</div>
    `;
    document.body.appendChild(modalOverlay);

    // Store current invoice for submit handler
    window._stripeCurrentInvoice = inv;

    // Initialize Stripe Elements
    try {
        await loadStripe();
        window._stripeInstance = Stripe(window.STRIPE_PUBLISHABLE_KEY);
        const elements = window._stripeInstance.elements();
        window._stripeCardElement = elements.create('card', {
            style: {
                base: {
                    fontSize: '16px',
                    color: '#333',
                    fontFamily: '"Inter", -apple-system, sans-serif',
                    '::placeholder': { color: '#aaa' }
                },
                invalid: { color: '#e63946' }
            }
        });
        window._stripeCardElement.mount('#stripeCardElement');
        window._stripeCardElement.on('change', function(event) {
            const errEl = document.getElementById('stripeCardErrors');
            if (errEl) errEl.textContent = event.error ? event.error.message : '';
        });
    } catch (err) {
        console.error('Stripe init error:', err);
        document.getElementById('stripeCardErrors').textContent = 'Failed to load payment form. Please refresh and try again.';
    }
}

function closeStripeModal() {
    const modal = document.getElementById('stripePaymentModal');
    if (modal) modal.remove();
    if (window._stripeCardElement) {
        window._stripeCardElement.destroy();
        window._stripeCardElement = null;
    }
    window._stripeCurrentInvoice = null;
}

async function submitStripePayment() {
    const inv = window._stripeCurrentInvoice;
    if (!inv) return;

    const payBtn = document.getElementById('stripePayBtn');
    const spinner = document.getElementById('stripePaySpinner');
    const errEl = document.getElementById('stripeCardErrors');

    // Show loading state
    if (payBtn) payBtn.style.display = 'none';
    if (spinner) spinner.style.display = 'block';
    if (errEl) errEl.textContent = '';

    try {
        // Step 1: Create PaymentIntent via Netlify function
        const response = await fetch('/.netlify/functions/create-payment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                invoiceId: inv.id,
                amount: inv.total,
                clientId: inv.clientId,
                clientEmail: currentUser?.email || '',
                description: `Invoice ${inv.invoiceNumber || ''} - ${inv.projectName || 'Payment'}`
            })
        });

        if (!response.ok) {
            const errData = await response.json().catch(() => ({}));
            throw new Error(errData.error || 'Failed to create payment. Please try again.');
        }

        const { clientSecret } = await response.json();

        // Step 2: Confirm payment with Stripe.js
        const { error, paymentIntent } = await window._stripeInstance.confirmCardPayment(clientSecret, {
            payment_method: { card: window._stripeCardElement }
        });

        if (error) {
            throw new Error(error.message);
        }

        if (paymentIntent.status === 'succeeded') {
            // Step 3: Mark invoice as paid locally
            const localInvoices = JSON.parse(localStorage.getItem('nui_invoices') || '[]');
            const idx = localInvoices.findIndex(i => i.id === inv.id);
            if (idx >= 0) {
                localInvoices[idx].status = 'paid';
                localInvoices[idx].paidAt = new Date().toISOString();
                localInvoices[idx].stripe_payment_intent = paymentIntent.id;
                localStorage.setItem('nui_invoices', JSON.stringify(localInvoices));
            }
            // Update in-memory array too
            const memInv = invoices.find(i => i.id === inv.id);
            if (memInv) {
                memInv.status = 'paid';
                memInv.paidAt = new Date().toISOString();
                memInv.stripe_payment_intent = paymentIntent.id;
            }

            // Record payment
            const payment = {
                id: Date.now(),
                clientId: inv.clientId,
                clientName: inv.clientName,
                projectId: inv.projectId,
                projectName: inv.projectName,
                amount: inv.total,
                type: 'invoice',
                date: new Date().toISOString().split('T')[0],
                notes: `Stripe payment for Invoice ${inv.invoiceNumber || ''}`,
                status: 'completed',
                invoiceId: inv.id,
                stripe_payment_id: paymentIntent.id,
                createdAt: new Date().toISOString()
            };
            payments.push(payment);
            savePayments();

            // Trigger loyalty + order updates
            if (typeof triggerInvoicePaid === 'function') triggerInvoicePaid(inv.id);

            // Log to CRM
            if (typeof logProofActivity === 'function') {
                logProofActivity(inv.clientId, 'payment', `Client paid Invoice ${inv.invoiceNumber || ''} ($${inv.total}) via Stripe`);
            }

            // Close modal and show success
            closeStripeModal();
            alert('✅ Payment successful! Thank you for your payment.');

            // Refresh client portal
            if (currentUser?.type === 'client') {
                showClientPortal(currentUser);
            }

            // Trigger backend sync
            if (typeof debouncedSync === 'function') debouncedSync();
        }

    } catch (err) {
        console.error('Payment error:', err);
        if (errEl) errEl.textContent = err.message || 'Payment failed. Please try again.';
        if (payBtn) payBtn.style.display = 'block';
        if (spinner) spinner.style.display = 'none';
    }
}

// Override processPaymentAfterTerms for actual payment flow
processPaymentAfterTerms = async function(invoiceData) {
    const storedInvoices = JSON.parse(localStorage.getItem('nui_invoices') || '[]');
    const idx = storedInvoices.findIndex(i => i.id === invoiceData.invoiceId);
    if (idx >= 0) {
        storedInvoices[idx].termsAccepted = true;
        storedInvoices[idx].termsAcceptedDate = new Date().toISOString();
        localStorage.setItem('nui_invoices', JSON.stringify(storedInvoices));
    }
    // Update in-memory too
    const memInv = invoices.find(i => i.id === invoiceData.invoiceId);
    if (memInv) {
        memInv.termsAccepted = true;
        memInv.termsAcceptedDate = new Date().toISOString();
    }
    // Now proceed to Stripe payment
    await proceedToPayment(invoiceData.invoice);
}

// Update login to route to correct dashboard (async-aware)
const originalHandlePortalLogin = handlePortalLogin;
handlePortalLogin = async function(e) {
    await originalHandlePortalLogin(e);
    // Small delay to let state settle, then route to correct dashboard
    setTimeout(() => {
        if (currentUser?.type === 'designer') {
            document.getElementById('portalLogin').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
            loadDesignerDashboard();
        } else if (currentUser?.type === 'client') {
            document.getElementById('portalLogin').style.display = 'none';
            loadClientDashboard();
        }
    }, 100);
}

// ==================== SESSION AUTO-RESTORE ====================
// Check for existing Supabase session on page load
async function restoreSupabaseSession() {
    if (!window.NuiAuth || !NuiAuth.isAvailable()) {
        console.log('Supabase not available - skipping session restore');
        return;
    }

    try {
        const session = await NuiAuth.getSession();
        if (!session || !session.user) {
            console.log('No active Supabase session');
            return;
        }

        const authUser = session.user;
        console.log('Restoring session for:', authUser.email);

        // Determine role
        const roleInfo = await NuiAuth.getUserRole(authUser);
        const role = roleInfo?.role || 'client';

        if (role === 'admin') {
            currentUser = { type: 'admin', email: authUser.email, name: authUser.user_metadata?.name || 'Admin', id: authUser.id };
            document.getElementById('portalLogin').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
            renderAdminSidebar();
            loadAdminDashboardPanel();
        } else if (role === 'manager') {
            currentUser = { type: 'manager', email: authUser.email, name: authUser.user_metadata?.name || 'Manager', id: authUser.id, ...authUser.user_metadata };
            document.getElementById('portalLogin').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
            renderAdminSidebar();
            loadAdminDashboardPanel();
        } else if (role === 'designer') {
            const meta = authUser.user_metadata || {};
            currentUser = { type: 'designer', email: authUser.email, name: meta.name || 'Designer', id: authUser.id, ...meta };
            document.getElementById('portalLogin').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
            loadDesignerDashboard(currentUser);
        } else {
            currentUser = { type: 'client', email: authUser.email, name: roleInfo?.data?.name || authUser.user_metadata?.name || authUser.email.split('@')[0], id: authUser.id, ...(roleInfo?.data || {}) };
            document.getElementById('portalLogin').style.display = 'none';
            document.getElementById('clientPortal').style.display = 'block';
            showClientPortal(currentUser);
        }

        console.log('Session restored successfully:', currentUser.type, currentUser.email);
    } catch (error) {
        console.warn('Session restore failed:', error.message);
    }
}

// Listen for OAuth redirects (Google sign-in returns here)
if (window.NuiAuth && NuiAuth.isAvailable()) {
    NuiAuth.onAuthStateChange(async (event, session) => {
        if (event === 'SIGNED_IN' && session && !currentUser) {
            console.log('Auth state: SIGNED_IN via', session.user?.app_metadata?.provider || 'email');
            // If signed in via OAuth redirect and not already logged in, restore session
            await restoreSupabaseSession();
        }
    });
}

// Auto-restore session when portal view loads
const _originalLoadPortalView = typeof loadPortalView === 'function' ? loadPortalView : null;
if (_originalLoadPortalView) {
    const _wrappedLoadPortalView = loadPortalView;
    loadPortalView = function() {
        _wrappedLoadPortalView();
        // After portal renders, try to restore session
        setTimeout(() => restoreSupabaseSession(), 200);
    };
}

// ==================== EMAIL TEMPLATE SYSTEM ====================
const NUI_COMPANY = {
    name: 'New Urban Influence',
    phone: '(248) 487-8747',
    email: 'info@newurbaninfluence.com',
    location: 'Detroit, MI',
    website: 'newurbaninfluence.com',
    colors: {
        primary: '#e63946',
        secondary: '#1a1a1a',
        accent: '#f4f4f4'
    },
    logo: 'NUI | New Urban Influence' // Text logo for now
};

// Email Templates Storage
let emailTemplates = JSON.parse(localStorage.getItem('nui_email_templates')) || [];
let scheduledEmails = JSON.parse(localStorage.getItem('nui_scheduled_emails')) || [];
function saveEmailTemplates() { localStorage.setItem('nui_email_templates', JSON.stringify(emailTemplates)); }
function saveScheduledEmails() { localStorage.setItem('nui_scheduled_emails', JSON.stringify(scheduledEmails)); }

// Initialize default templates
if (emailTemplates.length === 0) {
    emailTemplates = [
        {
            id: 1,
            name: 'Welcome New Client',
            subject: 'Welcome to the NUI Family, {{clientName}}!',
            category: 'onboarding',
            body: `Hey {{clientName}},

Let me be real with you — you just made one of the smartest decisions for your business.

While your competitors are out there playing small, you chose to invest in a brand that actually WORKS. That takes vision. That takes guts. And honestly? That's exactly the type of client we love working with.

Here's what happens next:
• Your dedicated designer will reach out within 24 hours
• We'll dive deep into your brand strategy
• You'll start seeing concepts within 72 hours

This isn't just another design project. This is the beginning of your business transformation.

Stay hungry. Stay focused. And get ready to dominate.

Let's build something legendary.`
        },
        {
            id: 2,
            name: 'Project Kickoff',
            subject: '🚀 Your Project Just Started, {{clientName}}!',
            category: 'project',
            body: `Hey {{clientName}},

Game time.

Your project is officially in motion, and I want you to understand something important: we don't do average work. We create brands that make your competition nervous.

Your designer {{designerName}} is already working on bringing your vision to life.

What to expect:
• First proof delivery: 72 hours
• Unlimited revisions until you're 100% satisfied
• Direct communication the entire way

Here's my challenge to you: dream bigger than you think you should. Push us. Tell us what you REALLY want your brand to feel like. The bolder you go, the more we can deliver.

Time to level up.`
        },
        {
            id: 3,
            name: 'Proof Ready',
            subject: '👀 Your Proof is Ready for Review, {{clientName}}',
            category: 'project',
            body: `Hey {{clientName}},

Stop what you're doing.

Your first proof is ready, and I'm genuinely excited for you to see it. This is the moment where your brand starts becoming REAL.

Log into your client portal to review:
{{portalLink}}

Here's what I need from you:
1. Look at it with fresh eyes
2. Imagine it on your website, your business cards, everywhere
3. Trust your gut reaction

Love it? Approve it and we move forward.
Want changes? No problem — tell us exactly what you're thinking.

This is YOUR brand. Make sure it feels right.

Waiting on your feedback.`
        },
        {
            id: 4,
            name: 'Invoice Reminder',
            subject: 'Quick Reminder: Invoice {{invoiceNumber}} Due Soon',
            category: 'payment',
            body: `Hey {{clientName}},

Quick heads up — your invoice {{invoiceNumber}} for \${{amount}} is coming due.

I know you're busy building your influence, so I wanted to make this easy. Click below to handle it in 30 seconds:

{{paymentLink}}

Once this is squared away, we can keep the momentum going on your project. No delays, no interruptions — just results.

Questions? Hit reply. I got you.

Talk soon.`
        },
        {
            id: 5,
            name: 'Project Complete',
            subject: '🎉 Your Brand is LIVE, {{clientName}}!',
            category: 'delivery',
            body: `Hey {{clientName}},

This is it. The moment you've been waiting for.

Your brand is complete, approved, and ready to take over your market. All your files are waiting in your portal:
{{portalLink}}

But here's what I really want you to understand...

This isn't the end. This is the BEGINNING.

You now have a brand that:
• Commands attention
• Builds instant credibility
• Makes people remember you

Now it's time to USE it. Put it everywhere. Be loud. Be consistent. And watch what happens to your business.

It's been an honor working with you. And remember — we're always here when you're ready to level up again.

Go dominate.`
        },
        {
            id: 6,
            name: 'Holiday Greeting',
            subject: 'Happy Holidays from the NUI Family! 🎄',
            category: 'newsletter',
            body: `Hey {{clientName}},

As the year wraps up, I wanted to take a moment to say something that doesn't get said enough:

THANK YOU.

Thank you for trusting us with your brand. Thank you for dreaming big. Thank you for being part of the NUI family.

This year, we helped brands just like yours stand out, get noticed, and grow. And honestly? It never gets old.

Wishing you and your family an incredible holiday season filled with rest, reflection, and maybe a little strategic planning for next year 😉

Here's to an even bigger year ahead.

Happy Holidays!`
        },
        {
            id: 7,
            name: 'New Year Special',
            subject: '2026 is YOUR Year, {{clientName}} — Let\'s Make It Happen',
            category: 'promo',
            body: `Hey {{clientName}},

New year. New opportunity. Same question:

Are you going to play small, or are you going to DOMINATE?

Look, I'm not here to give you some generic "new year, new you" message. I'm here to tell you that the brands who win in 2026 are the ones taking action NOW.

That's why we're offering something special:
🔥 20% off any branding package this month
🔥 Free brand strategy session ($500 value)
🔥 Priority scheduling for Q1 delivery

This isn't about discounts. This is about momentum. The businesses that start strong, finish strong.

Ready to make 2026 your year?

Reply "LET'S GO" and I'll personally set up your strategy call.

No excuses. Just results.`
        }
    ];
    saveEmailTemplates();
}

// Generate email HTML with beautiful template
function generateEmailHTML(template, clientData) {
    const { clientName, designerName, invoiceNumber, amount, paymentLink, portalLink } = clientData;

    let body = template.body
        .replace(/\{\{clientName\}\}/g, clientName || 'there')
        .replace(/\{\{designerName\}\}/g, designerName || 'our team')
        .replace(/\{\{invoiceNumber\}\}/g, invoiceNumber || '')
        .replace(/\{\{amount\}\}/g, amount || '')
        .replace(/\{\{paymentLink\}\}/g, paymentLink || '#')
        .replace(/\{\{portalLink\}\}/g, portalLink || '#');

    // Convert line breaks to HTML
    const bodyHTML = body.split('\n\n').map(p => `<p style="margin: 0 0 16px 0; line-height: 1.7;">${p.replace(/\n/g, '<br>')}</p>`).join('');

    return `
<!DOCTYPE html>
<html>
<head>
 <meta charset="utf-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Geo Meta Tags -->
    <meta name="geo.region" content="US-MI">
    <meta name="geo.placename" content="Detroit, Michigan">
    <meta name="geo.position" content="42.3314;-83.0458">
    <meta name="ICBM" content="42.3314, -83.0458">
</head>
<body style="margin: 0; padding: 0; background-color: #f4f4f4; font-family: 'Helvetica Neue', Arial, sans-serif;">
 <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f4f4f4; padding: 40px 20px;">
<tr>
<td align="center">
<table width="600" cellpadding="0" cellspacing="0" style="background-color: #ffffff; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 24px rgba(0,0,0,0.1);">
                    <!-- Header -->
<tr>
<td style="background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); padding: 32px 40px; text-align: center;">
<h2 style="margin: 0; font-size: 28px; font-weight: 800; color: #e63946; letter-spacing: 2px;">NUI</h2>
<p style="margin: 8px 0 0 0; font-size: 11px; color: #888; letter-spacing: 3px; text-transform: uppercase;">New Urban Influence</p>
</td>
</tr>
                    <!-- Accent Bar -->
<tr>
<td style="background: linear-gradient(90deg, #e63946, #ff6b6b); height: 4px;"></td>
</tr>
                    <!-- Body -->
<tr>
<td style="padding: 48px 40px; color: #1a1a1a; font-size: 16px;">
                            ${bodyHTML}
</td>
</tr>
                    <!-- Signature -->
<tr>
<td style="padding: 0 40px 40px 40px;">
<table width="100%" cellpadding="0" cellspacing="0" style="border-top: 1px solid #eee; padding-top: 24px;">
<tr>
<td>
<p style="margin: 0 0 4px 0; font-weight: 700; color: #1a1a1a;">New Urban Influence</p>
<p style="margin: 0; font-size: 14px; color: #666;">Detroit's Premier Creative Agency</p>
<p style="margin: 12px 0 0 0; font-size: 14px; color: #888;">
                                            📞 ${NUI_COMPANY.phone}<br>
                                            📧 ${NUI_COMPANY.email}<br>
                                            📍 ${NUI_COMPANY.location}
</p>
</td>
</tr>
</table>
</td>
</tr>
                    <!-- Footer -->
<tr>
<td style="background-color: #1a1a1a; padding: 24px 40px; text-align: center;">
<p style="margin: 0; font-size: 12px; color: #888;">
                                © 2026 New Urban Influence. Unapologetically Detroit.
</p>
<p style="margin: 12px 0 0 0; font-size: 11px; color: #666;">
<a href="#" style="color: #e63946; text-decoration: none;">Website</a> ·
<a href="#" style="color: #e63946; text-decoration: none;">Instagram</a> ·
<a href="#" style="color: #e63946; text-decoration: none;">Unsubscribe</a>
</p>
</td>
</tr>
</table>
</td>
</tr>
 </table>
</body>
</html>`;
}

// Send email using template
async function sendTemplateEmail(templateId, clientId, customData = {}) {
    const template = emailTemplates.find(t => t.id === templateId);
    const client = clients.find(c => c.id === clientId);

    if (!template || !client) {
        alert('Template or client not found');
        return;
    }

    const clientData = {
        clientName: client.name,
        portalLink: window.location.origin + '/portal',
        ...customData
    };

    const subject = template.subject.replace(/\{\{clientName\}\}/g, client.name);
    const html = generateEmailHTML(template, clientData);

    try {
        const response = await fetch('/.netlify/functions/send-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                to: client.email,
                subject: subject,
                html: html,
                text: template.body.replace(/\{\{clientName\}\}/g, client.name),
                clientId: client.id
            })
        });

        const result = await response.json();
        if (result.success) {
            alert('Email sent successfully!');
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        console.error('Email error:', error);
        alert('Email sending failed. Check console for details.');
    }
}

// Load Email Templates Panel in Admin
function loadAdminEmailTemplatesPanel() {
    const categories = ['onboarding', 'project', 'payment', 'delivery', 'newsletter', 'promo'];

    document.getElementById('adminEmailmarketingPanel').innerHTML = `
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
<h2 style="font-size: 28px; font-weight: 700;">📧 Email Templates</h2>
<button onclick="showCreateTemplateModal()" class="btn-cta">+ New Template</button>
</div>

        <!-- Quick Send -->
<div style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); padding: 24px; border-radius: 12px; margin-bottom: 24px;">
<h3 style="margin: 0 0 16px 0; color: #fff;">⚡ Quick Send</h3>
<div style="display: flex; gap: 12px; flex-wrap: wrap;">
<select id="quickSendTemplate" style="flex: 1; min-width: 200px; padding: 12px; background: #333; border: 1px solid #444; color: #fff; border-radius: 8px;">
<option value="">Select Template</option>
                    ${emailTemplates.map(t => `<option value="${t.id}">${t.name}</option>`).join('')}
</select>
<select id="quickSendClient" style="flex: 1; min-width: 200px; padding: 12px; background: #333; border: 1px solid #444; color: #fff; border-radius: 8px;">
<option value="">Select Client</option>
                    ${clients.map(c => `<option value="${c.id}">${c.name} (${c.email})</option>`).join('')}
</select>
<button onclick="quickSendEmail()" style="padding: 12px 24px; background: #e63946; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Send Now</button>
<button onclick="previewEmail()" style="padding: 12px 24px; background: #333; color: #fff; border: 1px solid #444; border-radius: 8px; cursor: pointer;">Preview</button>
</div>
</div>

        <!-- Scheduled Campaigns -->
<div style="background: #111; padding: 24px; border-radius: 12px; margin-bottom: 24px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
<h3 style="margin: 0;">🗓️ Scheduled Campaigns</h3>
<button onclick="showScheduleCampaignModal()" style="padding: 8px 16px; background: #10b981; color: #fff; border: none; border-radius: 6px; cursor: pointer;">+ Schedule Campaign</button>
</div>
            ${scheduledEmails.length > 0 ? scheduledEmails.map(s => `
<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #222;">
<div>
<div style="font-weight: 500;">${emailTemplates.find(t => t.id === s.templateId)?.name || 'Unknown'}</div>
<div style="font-size: 13px; color: #888;">${s.audience === 'all' ? 'All Clients' : s.audience} · ${new Date(s.sendAt).toLocaleString()}</div>
</div>
<div style="display: flex; gap: 8px;">
<span style="padding: 4px 12px; border-radius: 12px; font-size: 12px; background: ${s.status === 'sent' ? '#10b98120' : '#f59e0b20'}; color: ${s.status === 'sent' ? '#10b981' : '#f59e0b'};">${s.status}</span>
<button onclick="cancelScheduledEmail(${s.id})" style="padding: 4px 8px; background: #333; border: none; color: #888; border-radius: 4px; cursor: pointer;">×</button>
</div>
</div>
            `).join('') : '<p style="color: #888;">No scheduled campaigns.</p>'}
</div>

        <!-- Templates by Category -->
        ${categories.map(cat => `
<div style="margin-bottom: 24px;">
<h3 style="font-size: 14px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;">${cat}</h3>
<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">
                    ${emailTemplates.filter(t => t.category === cat).map(t => `
<div style="background: #111; padding: 20px; border-radius: 12px; border: 1px solid #222;">
<h4 style="margin: 0 0 8px 0; font-size: 16px;">${t.name}</h4>
<p style="margin: 0 0 12px 0; font-size: 13px; color: #888; line-height: 1.5;">${t.subject}</p>
<div style="display: flex; gap: 8px;">
<button onclick="editTemplate(${t.id})" style="flex: 1; padding: 8px; background: #333; border: none; color: #fff; border-radius: 6px; cursor: pointer; font-size: 12px;">Edit</button>
<button onclick="previewTemplate(${t.id})" style="flex: 1; padding: 8px; background: #e63946; border: none; color: #fff; border-radius: 6px; cursor: pointer; font-size: 12px;">Preview</button>
</div>
</div>
                    `).join('')}
</div>
</div>
        `).join('')}
    `;
}

function quickSendEmail() {
    const templateId = parseInt(document.getElementById('quickSendTemplate').value);
    const clientId = parseInt(document.getElementById('quickSendClient').value);
    if (!templateId || !clientId) {
        alert('Please select both a template and a client');
        return;
    }
    sendTemplateEmail(templateId, clientId);
}

function previewEmail() {
    const templateId = parseInt(document.getElementById('quickSendTemplate').value);
    const clientId = parseInt(document.getElementById('quickSendClient').value);
    const template = emailTemplates.find(t => t.id === templateId);
    const client = clients.find(c => c.id === clientId) || { name: 'John Smith' };

    if (!template) {
        alert('Please select a template');
        return;
    }

    const html = generateEmailHTML(template, { clientName: client.name });
    const win = window.open('', 'Email Preview', 'width=700,height=800');
    win.document.write(html);
    win.document.close();
}

function previewTemplate(templateId) {
    const template = emailTemplates.find(t => t.id === templateId);
    if (!template) return;

    const html = generateEmailHTML(template, { clientName: 'John Smith' });
    const win = window.open('', 'Email Preview', 'width=700,height=800');
    win.document.write(html);
    win.document.close();
}

function showCreateTemplateModal() {
    const modal = document.createElement('div');
    modal.id = 'templateModal';
    modal.innerHTML = `
<div style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999; padding: 20px;">
<div style="background: #1a1a1a; border-radius: 16px; width: 100%; max-width: 700px; max-height: 90vh; overflow-y: auto;">
<div style="padding: 24px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
<h2 style="margin: 0; font-size: 20px;">Create Email Template</h2>
<button onclick="document.getElementById('templateModal').remove()" style="background: none; border: none; color: #888; font-size: 24px; cursor: pointer;">&times;</button>
</div>
<div style="padding: 24px;">
<div style="margin-bottom: 16px;">
<label style="display: block; margin-bottom: 8px; color: #888; font-size: 13px;">Template Name</label>
<input type="text" id="newTemplateName" placeholder="e.g., Follow Up Email" style="width: 100%; padding: 12px; background: #111; border: 1px solid #333; color: #fff; border-radius: 8px;">
</div>
<div style="margin-bottom: 16px;">
<label style="display: block; margin-bottom: 8px; color: #888; font-size: 13px;">Subject Line (use {{clientName}} for personalization)</label>
<input type="text" id="newTemplateSubject" placeholder="e.g., Hey {{clientName}}, quick question..." style="width: 100%; padding: 12px; background: #111; border: 1px solid #333; color: #fff; border-radius: 8px;">
</div>
<div style="margin-bottom: 16px;">
<label style="display: block; margin-bottom: 8px; color: #888; font-size: 13px;">Category</label>
<select id="newTemplateCategory" style="width: 100%; padding: 12px; background: #111; border: 1px solid #333; color: #fff; border-radius: 8px;">
<option value="onboarding">Onboarding</option>
<option value="project">Project Updates</option>
<option value="payment">Payment</option>
<option value="delivery">Delivery</option>
<option value="newsletter">Newsletter</option>
<option value="promo">Promotional</option>
</select>
</div>
<div style="margin-bottom: 16px;">
<label style="display: block; margin-bottom: 8px; color: #888; font-size: 13px;">Email Body</label>
<textarea id="newTemplateBody" rows="12" placeholder="Hey {{clientName}},

Write your email here...

Use {{clientName}}, {{designerName}}, {{invoiceNumber}}, {{amount}}, {{paymentLink}}, {{portalLink}} for dynamic content." style="width: 100%; padding: 12px; background: #111; border: 1px solid #333; color: #fff; border-radius: 8px; font-family: inherit; line-height: 1.6;"></textarea>
</div>
<button onclick="saveNewTemplate()" style="width: 100%; padding: 14px; background: #e63946; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Save Template</button>
</div>
</div>
</div>
    `;
    document.body.appendChild(modal);
}

function saveNewTemplate() {
    const name = document.getElementById('newTemplateName').value.trim();
    const subject = document.getElementById('newTemplateSubject').value.trim();
    const category = document.getElementById('newTemplateCategory').value;
    const body = document.getElementById('newTemplateBody').value.trim();

    if (!name || !subject || !body) {
        alert('Please fill in all fields');
        return;
    }

    emailTemplates.push({
        id: Date.now(),
        name,
        subject,
        category,
        body
    });
    saveEmailTemplates();

    document.getElementById('templateModal').remove();
    loadAdminEmailTemplatesPanel();
    alert('Template saved!');
}

function editTemplate(templateId) {
    const template = emailTemplates.find(t => t.id === templateId);
    if (!template) return;

    const modal = document.createElement('div');
    modal.id = 'templateModal';
    modal.innerHTML = `
<div style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999; padding: 20px;">
<div style="background: #1a1a1a; border-radius: 16px; width: 100%; max-width: 700px; max-height: 90vh; overflow-y: auto;">
<div style="padding: 24px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
<h2 style="margin: 0; font-size: 20px;">Edit Template: ${template.name}</h2>
<button onclick="document.getElementById('templateModal').remove()" style="background: none; border: none; color: #888; font-size: 24px; cursor: pointer;">&times;</button>
</div>
<div style="padding: 24px;">
<div style="margin-bottom: 16px;">
<label style="display: block; margin-bottom: 8px; color: #888; font-size: 13px;">Template Name</label>
<input type="text" id="editTemplateName" value="${template.name}" style="width: 100%; padding: 12px; background: #111; border: 1px solid #333; color: #fff; border-radius: 8px;">
</div>
<div style="margin-bottom: 16px;">
<label style="display: block; margin-bottom: 8px; color: #888; font-size: 13px;">Subject Line</label>
<input type="text" id="editTemplateSubject" value="${template.subject}" style="width: 100%; padding: 12px; background: #111; border: 1px solid #333; color: #fff; border-radius: 8px;">
</div>
<div style="margin-bottom: 16px;">
<label style="display: block; margin-bottom: 8px; color: #888; font-size: 13px;">Category</label>
<select id="editTemplateCategory" style="width: 100%; padding: 12px; background: #111; border: 1px solid #333; color: #fff; border-radius: 8px;">
<option value="onboarding" ${template.category === 'onboarding' ? 'selected' : ''}>Onboarding</option>
<option value="project" ${template.category === 'project' ? 'selected' : ''}>Project Updates</option>
<option value="payment" ${template.category === 'payment' ? 'selected' : ''}>Payment</option>
<option value="delivery" ${template.category === 'delivery' ? 'selected' : ''}>Delivery</option>
<option value="newsletter" ${template.category === 'newsletter' ? 'selected' : ''}>Newsletter</option>
<option value="promo" ${template.category === 'promo' ? 'selected' : ''}>Promotional</option>
</select>
</div>
<div style="margin-bottom: 16px;">
<label style="display: block; margin-bottom: 8px; color: #888; font-size: 13px;">Email Body</label>
<textarea id="editTemplateBody" rows="12" style="width: 100%; padding: 12px; background: #111; border: 1px solid #333; color: #fff; border-radius: 8px; font-family: inherit; line-height: 1.6;">${template.body}</textarea>
</div>
<div style="display: flex; gap: 12px;">
<button onclick="updateTemplate(${template.id})" style="flex: 1; padding: 14px; background: #e63946; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Save Changes</button>
<button onclick="deleteTemplate(${template.id})" style="padding: 14px 24px; background: #333; color: #ef4444; border: 1px solid #ef4444; border-radius: 8px; cursor: pointer;">Delete</button>
</div>
</div>
</div>
</div>
    `;
    document.body.appendChild(modal);
}

function updateTemplate(templateId) {
    const template = emailTemplates.find(t => t.id === templateId);
    if (!template) return;

    template.name = document.getElementById('editTemplateName').value.trim();
    template.subject = document.getElementById('editTemplateSubject').value.trim();
    template.category = document.getElementById('editTemplateCategory').value;
    template.body = document.getElementById('editTemplateBody').value.trim();

    saveEmailTemplates();
    document.getElementById('templateModal').remove();
    loadAdminEmailTemplatesPanel();
    alert('Template updated!');
}

function deleteTemplate(templateId) {
    if (!confirm('Delete this template?')) return;
    emailTemplates = emailTemplates.filter(t => t.id !== templateId);
    saveEmailTemplates();
    document.getElementById('templateModal').remove();
    loadAdminEmailTemplatesPanel();
}

// Schedule Campaign Modal
function showScheduleCampaignModal() {
    const modal = document.createElement('div');
    modal.id = 'scheduleModal';
    modal.innerHTML = `
<div style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999; padding: 20px;">
<div style="background: #1a1a1a; border-radius: 16px; width: 100%; max-width: 500px;">
<div style="padding: 24px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
<h2 style="margin: 0; font-size: 20px;">Schedule Campaign</h2>
<button onclick="document.getElementById('scheduleModal').remove()" style="background: none; border: none; color: #888; font-size: 24px; cursor: pointer;">&times;</button>
</div>
<div style="padding: 24px;">
<div style="margin-bottom: 16px;">
<label style="display: block; margin-bottom: 8px; color: #888; font-size: 13px;">Template</label>
<select id="scheduleTemplate" style="width: 100%; padding: 12px; background: #111; border: 1px solid #333; color: #fff; border-radius: 8px;">
                            ${emailTemplates.map(t => `<option value="${t.id}">${t.name}</option>`).join('')}
</select>
</div>
<div style="margin-bottom: 16px;">
<label style="display: block; margin-bottom: 8px; color: #888; font-size: 13px;">Send To</label>
<select id="scheduleAudience" style="width: 100%; padding: 12px; background: #111; border: 1px solid #333; color: #fff; border-radius: 8px;">
<option value="all">All Clients</option>
<option value="active">Active Clients (with projects)</option>
<option value="leads">Leads Only</option>
</select>
</div>
<div style="margin-bottom: 16px;">
<label style="display: block; margin-bottom: 8px; color: #888; font-size: 13px;">Send Date & Time</label>
<input type="datetime-local" id="scheduleDateTime" style="width: 100%; padding: 12px; background: #111; border: 1px solid #333; color: #fff; border-radius: 8px;">
</div>
<button onclick="scheduleCampaign()" style="width: 100%; padding: 14px; background: #10b981; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Schedule Campaign</button>
</div>
</div>
</div>
    `;
    document.body.appendChild(modal);
}

function scheduleCampaign() {
    const templateId = parseInt(document.getElementById('scheduleTemplate').value);
    const audience = document.getElementById('scheduleAudience').value;
    const sendAt = document.getElementById('scheduleDateTime').value;

    if (!sendAt) {
        alert('Please select a date and time');
        return;
    }

    scheduledEmails.push({
        id: Date.now(),
        templateId,
        audience,
        sendAt: new Date(sendAt).toISOString(),
        status: 'scheduled'
    });
    saveScheduledEmails();

    document.getElementById('scheduleModal').remove();
    loadAdminEmailTemplatesPanel();
    alert('Campaign scheduled!');
}

function cancelScheduledEmail(id) {
    if (!confirm('Cancel this scheduled campaign?')) return;
    scheduledEmails = scheduledEmails.filter(s => s.id !== id);
    saveScheduledEmails();
    loadAdminEmailTemplatesPanel();
}

// Check for scheduled emails to send (run on page load and every minute)
function checkScheduledEmails() {
    const now = new Date();
    scheduledEmails.forEach(async (scheduled) => {
        if (scheduled.status === 'scheduled' && new Date(scheduled.sendAt) <= now) {
            // Get recipients based on audience
            let recipients = [];
            if (scheduled.audience === 'all') {
                recipients = clients;
            } else if (scheduled.audience === 'active') {
                const activeClientIds = orders.filter(o => o.status === 'in_progress').map(o => o.clientId);
                recipients = clients.filter(c => activeClientIds.includes(c.id));
            } else if (scheduled.audience === 'leads') {
                recipients = leads;
            }

            // Send to each recipient
            for (const recipient of recipients) {
                await sendTemplateEmail(scheduled.templateId, recipient.id);
            }

            scheduled.status = 'sent';
            saveScheduledEmails();
        }
    });
}

// Run scheduled email check every minute
setInterval(checkScheduledEmails, 60000);
checkScheduledEmails(); // Run immediately on load

// Update admin panel loaders to include email templates
const originalShowAdminPanel = showAdminPanel;
showAdminPanel = function(panel) {
    originalShowAdminPanel(panel);
    if (panel === 'emailmarketing') {
        loadAdminEmailTemplatesPanel();
    }
    if (panel === 'subscriptions') {
        loadAdminSubscriptionsPanel();
    }
};

// ==================== SUBSCRIPTION MANAGEMENT PANEL ====================
function loadAdminSubscriptionsPanel() {
    const totalSubscribers = subscriptions.filter(s => s.status === 'active').length;
    const monthlyRevenue = subscriptions.filter(s => s.status === 'active').reduce((sum, s) => sum + s.price, 0);

    const planBreakdown = {};
    subscriptionPlans.forEach(plan => {
        const count = subscriptions.filter(s => s.planId === plan.id && s.status === 'active').length;
        if (count > 0) planBreakdown[plan.id] = { name: plan.name, count };
    });

    let html = `
<div style="padding: 32px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
<div>
<h2 style="font-size: 28px; font-weight: 700; color: #fff; margin: 0;">Subscription Management</h2>
<p style="color: #888; margin-top: 8px;">Manage customer subscriptions and billing plans</p>
</div>
<button onclick="showAssignPlanModal(null)" style="background: #e63946; color: #fff; border: none; padding: 12px 24px; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 14px;">+ Assign Plan</button>
</div>

            <!-- Stats Cards -->
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 32px;">
<div style="background: #111; border: 1px solid #222; border-radius: 12px; padding: 24px;">
<div style="color: #888; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Total Subscribers</div>
<div style="font-size: 36px; font-weight: 700; color: #e63946;">${totalSubscribers}</div>
<div style="color: #666; font-size: 12px; margin-top: 8px;">Active subscriptions</div>
</div>
<div style="background: #111; border: 1px solid #222; border-radius: 12px; padding: 24px;">
<div style="color: #888; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Monthly Revenue</div>
<div style="font-size: 36px; font-weight: 700; color: #10b981;">$${monthlyRevenue.toLocaleString()}</div>
<div style="color: #666; font-size: 12px; margin-top: 8px;">Recurring monthly</div>
</div>
<div style="background: #111; border: 1px solid #222; border-radius: 12px; padding: 24px;">
<div style="color: #888; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Active Plans</div>
<div style="font-size: 36px; font-weight: 700; color: #3b82f6;">${Object.keys(planBreakdown).length}</div>
<div style="color: #666; font-size: 12px; margin-top: 8px;">Of ${subscriptionPlans.length} plans</div>
</div>
</div>

            <!-- Plan Cards -->
<div style="margin-bottom: 32px;">
<h2 style="font-size: 18px; font-weight: 600; color: #fff; margin: 0 0 16px 0;">Plans Overview</h2>
<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px;">
    `;

    subscriptionPlans.forEach(plan => {
        const count = subscriptions.filter(s => s.planId === plan.id && s.status === 'active').length;
        html += `
<div style="background: #111; border: 1px solid #222; border-radius: 12px; padding: 20px; text-align: center;">
<div style="font-size: 28px; font-weight: 700; color: #e63946; margin-bottom: 8px;">$${plan.price}</div>
<div style="font-weight: 600; color: #fff; margin-bottom: 12px; font-size: 14px;">${plan.name}</div>
<div style="font-size: 20px; font-weight: 700; color: #fff; margin-bottom: 12px;">${count}</div>
<div style="color: #666; font-size: 11px; margin-bottom: 16px;">Active subscribers</div>
<button onclick="showAssignPlanModal('${plan.id}')" style="width: 100%; background: #e63946; color: #fff; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 12px;">Assign Plan</button>
</div>
        `;
    });

    html += `
</div>
</div>

            <!-- Search/Filter -->
<div style="margin-bottom: 20px; display: flex; gap: 12px;">
<input type="text" id="subscriptionSearchInput" placeholder="Search by client name or email..." style="flex: 1; padding: 12px; background: #111; border: 1px solid #333; color: #fff; border-radius: 8px; font-size: 14px;">
<select id="subscriptionFilterStatus" onchange="filterSubscriptionTable()" style="padding: 12px; background: #111; border: 1px solid #333; color: #fff; border-radius: 8px; cursor: pointer;">
<option value="">All Status</option>
<option value="active">Active</option>
<option value="paused">Paused</option>
<option value="cancelled">Cancelled</option>
</select>
<button onclick="filterSubscriptionTable()" style="background: #e63946; color: #fff; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">Search</button>
</div>

            <!-- Active Subscriptions Table -->
<div style="background: #111; border: 1px solid #222; border-radius: 12px; overflow: hidden;">
<table id="subscriptionTable" style="width: 100%; border-collapse: collapse;">
<thead>
<tr style="background: #0a0a0a; border-bottom: 1px solid #222;">
<th style="padding: 16px; text-align: left; color: #888; font-weight: 600; font-size: 12px; text-transform: uppercase;">Client</th>
<th style="padding: 16px; text-align: left; color: #888; font-weight: 600; font-size: 12px; text-transform: uppercase;">Plan</th>
<th style="padding: 16px; text-align: left; color: #888; font-weight: 600; font-size: 12px; text-transform: uppercase;">Price</th>
<th style="padding: 16px; text-align: left; color: #888; font-weight: 600; font-size: 12px; text-transform: uppercase;">Status</th>
<th style="padding: 16px; text-align: left; color: #888; font-weight: 600; font-size: 12px; text-transform: uppercase;">Start Date</th>
<th style="padding: 16px; text-align: left; color: #888; font-weight: 600; font-size: 12px; text-transform: uppercase;">Next Billing</th>
<th style="padding: 16px; text-align: center; color: #888; font-weight: 600; font-size: 12px; text-transform: uppercase;">Actions</th>
</tr>
</thead>
<tbody id="subscriptionTableBody">
    `;

    subscriptions.forEach(sub => {
        const statusColors = { active: '#10b981', paused: '#f59e0b', cancelled: '#ef4444' };
        const statusIcons = { active: '●', paused: '⏸', cancelled: '✕' };
        const startDate = new Date(sub.startDate).toLocaleDateString();
        const nextBillingDate = new Date(sub.nextBillingDate).toLocaleDateString();

        html += `
<tr style="border-bottom: 1px solid #222; hover: {background: #0a0a0a;}">
<td style="padding: 16px; color: #fff;">${sub.clientName}</td>
<td style="padding: 16px; color: rgba(255,255,255,0.7);">${sub.plan}</td>
<td style="padding: 16px; color: #e63946; font-weight: 600;">$${sub.price}/mo</td>
<td style="padding: 16px;">
<span style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; background: ${statusColors[sub.status]}20; color: ${statusColors[sub.status]}; border-radius: 100px; font-size: 12px; font-weight: 600;">
<span>${statusIcons[sub.status]}</span>
                                    ${sub.status.charAt(0).toUpperCase() + sub.status.slice(1)}
</span>
</td>
<td style="padding: 16px; color: rgba(255,255,255,0.6); font-size: 13px;">${startDate}</td>
<td style="padding: 16px; color: rgba(255,255,255,0.6); font-size: 13px;">${nextBillingDate}</td>
<td style="padding: 16px; text-align: center;">
<div style="display: flex; gap: 8px; justify-content: center;">
                                    ${sub.status === 'active' ? `<button onclick="pauseSubscription(${sub.id})" style="background: #f59e0b; color: #000; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 11px;">Pause</button>` : sub.status === 'paused' ? `<button onclick="resumeSubscription(${sub.id})" style="background: #10b981; color: #000; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 11px;">Resume</button>` : ''}
<button onclick="showChangePlanModal(${sub.id})" style="background: #3b82f6; color: #fff; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 11px;">Change Plan</button>
<button onclick="sendSubscriptionInvoice(${sub.id})" style="background: #10b981; color: #000; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 11px;">Invoice</button>
<button onclick="cancelSubscription(${sub.id})" style="background: #ef4444; color: #fff; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 11px;">Cancel</button>
</div>
</td>
</tr>
        `;
    });

    html += `
</tbody>
</table>
                ${subscriptions.length === 0 ? `<div style="padding: 40px; text-align: center; color: #666;">No subscriptions yet. <a onclick="showAssignPlanModal(null)" style="color: #e63946; cursor: pointer; font-weight: 600;">Create one now</a></div>` : ''}
</div>
</div>
    `;

    document.getElementById('adminSubscriptionsPanel').innerHTML = html;
    document.getElementById('subscriptionSearchInput').addEventListener('input', filterSubscriptionTable);
}

function showAssignPlanModal(planId) {
    const plan = planId ? subscriptionPlans.find(p => p.id === planId) : null;

    let html = `
<div class="modal-overlay" id="assignPlanModal" style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;">
<div style="background: #111; border: 1px solid #333; border-radius: 16px; padding: 32px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
<h2 style="font-size: 24px; font-weight: 700; color: #fff; margin: 0 0 24px 0;">Assign Subscription Plan</h2>

<div style="margin-bottom: 20px;">
<label style="display: block; color: #fff; font-weight: 600; margin-bottom: 8px;">Select Client</label>
<select id="assignPlanClient" style="width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; color: #fff; border-radius: 8px; font-size: 14px;">
<option value="">-- Choose a client --</option>
                        ${clients.map(c => `<option value="${c.id}">${c.name} (${c.email})</option>`).join('')}
</select>
</div>

<div style="margin-bottom: 20px;">
<label style="display: block; color: #fff; font-weight: 600; margin-bottom: 8px;">Select Plan</label>
<select id="assignPlanSelect" style="width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; color: #fff; border-radius: 8px; font-size: 14px;">
<option value="">-- Choose a plan --</option>
                        ${subscriptionPlans.map(p => `<option value="${p.id}" ${p.id === planId ? 'selected' : ''}>${p.name} - $${p.price}/mo</option>`).join('')}
</select>
</div>

<div id="planPreview" style="background: #0a0a0a; border: 1px solid #222; border-radius: 12px; padding: 16px; margin-bottom: 20px; display: none;">
<div style="color: #fff; font-weight: 600; margin-bottom: 12px;" id="planPreviewName"></div>
<div style="color: #888; font-size: 13px; line-height: 1.6;" id="planPreviewFeatures"></div>
</div>

<div style="margin-bottom: 20px;">
<label style="display: block; color: #fff; font-weight: 600; margin-bottom: 8px;">Start Date</label>
<input type="date" id="assignPlanStartDate" style="width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; color: #fff; border-radius: 8px; font-size: 14px;">
</div>

<div style="margin-bottom: 20px;">
<label style="display: block; color: #fff; font-weight: 600; margin-bottom: 8px;">Billing Method</label>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
<label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: #1a1a1a; border: 1px solid #e63946; border-radius: 8px; cursor: pointer;">
<input type="radio" name="billingMethod" value="stripe" checked style="cursor: pointer;">
<span style="color: #fff; font-size: 14px;">Auto (Stripe)</span>
</label>
<label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; cursor: pointer;">
<input type="radio" name="billingMethod" value="manual" style="cursor: pointer;">
<span style="color: #fff; font-size: 14px;">Manual Invoice</span>
</label>
</div>
</div>

<div style="margin-bottom: 20px;">
<label style="display: block; color: #fff; font-weight: 600; margin-bottom: 8px;">Notes (optional)</label>
<textarea id="assignPlanNotes" style="width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; color: #fff; border-radius: 8px; font-size: 14px; resize: vertical; min-height: 80px;" placeholder="Any special notes about this subscription..."></textarea>
</div>

<div style="display: flex; gap: 12px;">
<button onclick="document.getElementById('assignPlanModal').remove()" style="flex: 1; padding: 12px; background: #333; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
<button onclick="assignSubscription()" style="flex: 1; padding: 12px; background: #e63946; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Assign Plan</button>
</div>
</div>
</div>
    `;

    document.body.appendChild(document.createElement('div')).outerHTML = html;

    // Set today's date as default
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('assignPlanStartDate').value = today;

    // Show plan preview when plan is selected
    document.getElementById('assignPlanSelect').addEventListener('change', function() {
        const selectedPlanId = this.value;
        const selectedPlan = subscriptionPlans.find(p => p.id === selectedPlanId);
        if (selectedPlan) {
            document.getElementById('planPreview').style.display = 'block';
            document.getElementById('planPreviewName').textContent = selectedPlan.name + ' - $' + selectedPlan.price + '/mo';
            document.getElementById('planPreviewFeatures').innerHTML = selectedPlan.features.map(f => '✓ ' + f).join('<br>');
        } else {
            document.getElementById('planPreview').style.display = 'none';
        }
    });
}

function assignSubscription() {
    const clientId = parseInt(document.getElementById('assignPlanClient').value);
    const planId = document.getElementById('assignPlanSelect').value;
    const startDateStr = document.getElementById('assignPlanStartDate').value;
    const billingMethod = document.querySelector('input[name="billingMethod"]:checked').value;
    const notes = document.getElementById('assignPlanNotes').value;

    if (!clientId || !planId || !startDateStr) {
        alert('Please fill in all required fields');
        return;
    }

    const client = clients.find(c => c.id === clientId);
    const plan = subscriptionPlans.find(p => p.id === planId);

    if (!client || !plan) {
        alert('Invalid client or plan selected');
        return;
    }

    const startDate = new Date(startDateStr);
    const nextBillingDate = new Date(startDate);
    nextBillingDate.setDate(nextBillingDate.getDate() + 30);

    const subscription = {
        id: Date.now(),
        planId: planId,
        clientId: clientId,
        clientName: client.name,
        clientEmail: client.email,
        plan: plan.name,
        price: plan.price,
        billingMethod: billingMethod,
        status: 'active',
        startDate: startDate.toISOString(),
        nextBillingDate: nextBillingDate.toISOString(),
        orderLimit: plan.orderLimit,
        features: plan.features,
        notes: notes,
        history: [{ action: 'created', date: new Date().toISOString(), note: 'Subscription started', user: currentUser?.name || 'Admin' }]
    };

    subscriptions.push(subscription);
    saveSubscriptions();

    logProofActivity(clientId, 'subscription_assigned', `${plan.name} subscription assigned for $${plan.price}/mo`, subscription);

    // Send email notification
    if (client.email) {
        try {
            simulateEmailNotification(client.email, `Welcome to ${plan.name}!`, `Your ${plan.name} plan is now active. Next billing date: ${nextBillingDate.toLocaleDateString()}`);
        } catch (e) {
            console.log('Email notification not available');
        }
    }

    document.getElementById('assignPlanModal').remove();
    loadAdminSubscriptionsPanel();
    alert(`Subscription assigned! ${client.name} is now on the ${plan.name} plan.`);
}

function pauseSubscription(subId) {
    const sub = subscriptions.find(s => s.id === subId);
    if (!sub) return;

    if (!confirm(`Pause subscription for ${sub.clientName}? They won't be charged until resumed.`)) return;

    sub.status = 'paused';
    sub.history.push({ action: 'paused', date: new Date().toISOString(), note: 'Subscription paused', user: currentUser?.name || 'Admin' });
    saveSubscriptions();
    loadAdminSubscriptionsPanel();
    alert('Subscription paused');
}

function resumeSubscription(subId) {
    const sub = subscriptions.find(s => s.id === subId);
    if (!sub) return;

    sub.status = 'active';
    sub.history.push({ action: 'resumed', date: new Date().toISOString(), note: 'Subscription resumed', user: currentUser?.name || 'Admin' });
    saveSubscriptions();
    loadAdminSubscriptionsPanel();
    alert('Subscription resumed');
}

function cancelSubscription(subId) {
    const sub = subscriptions.find(s => s.id === subId);
    if (!sub) return;

    if (!confirm(`Cancel subscription for ${sub.clientName}? This action cannot be undone.`)) return;

    sub.status = 'cancelled';
    sub.cancelledDate = new Date().toISOString();
    sub.history.push({ action: 'cancelled', date: new Date().toISOString(), note: 'Subscription cancelled', user: currentUser?.name || 'Admin' });
    saveSubscriptions();
    loadAdminSubscriptionsPanel();
    alert('Subscription cancelled');
}

function showChangePlanModal(subId) {
    const sub = subscriptions.find(s => s.id === subId);
    if (!sub) return;

    let html = `
<div class="modal-overlay" id="changePlanModal" style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;">
<div style="background: #111; border: 1px solid #333; border-radius: 16px; padding: 32px; max-width: 600px; width: 90%;">
<h2 style="font-size: 24px; font-weight: 700; color: #fff; margin: 0 0 24px 0;">Change Plan for ${sub.clientName}</h2>

<div style="background: #0a0a0a; border: 1px solid #222; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
<div style="font-size: 13px; color: #888; margin-bottom: 4px;">Current Plan</div>
<div style="font-size: 18px; font-weight: 600; color: #fff;">${sub.plan} - $${sub.price}/mo</div>
</div>

<div style="margin-bottom: 20px;">
<label style="display: block; color: #fff; font-weight: 600; margin-bottom: 12px;">Select New Plan</label>
<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
    `;

    subscriptionPlans.forEach(plan => {
        const isCurrentPlan = plan.id === sub.planId;
        html += `
<button onclick="changePlan(${subId}, '${plan.id}')" style="padding: 16px; background: ${isCurrentPlan ? '#e63946' : '#1a1a1a'}; border: ${isCurrentPlan ? '2px solid #e63946' : '1px solid #333'}; border-radius: 8px; cursor: ${isCurrentPlan ? 'default' : 'pointer'}; color: #fff; text-align: left; transition: all 0.2s;" ${isCurrentPlan ? 'disabled' : ''}>
<div style="font-weight: 600; margin-bottom: 4px;">${plan.name}</div>
<div style="font-size: 14px; font-weight: 700; color: ${isCurrentPlan ? '#fff' : '#e63946'};">$${plan.price}/mo</div>
                            ${isCurrentPlan ? '<div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 8px;">Current Plan</div>' : ''}
</button>
        `;
    });

    html += `
</div>
</div>

<div style="display: flex; gap: 12px;">
<button onclick="document.getElementById('changePlanModal').remove()" style="flex: 1; padding: 12px; background: #333; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
</div>
</div>
</div>
    `;

    document.body.appendChild(document.createElement('div')).outerHTML = html;
}

function changePlan(subId, newPlanId) {
    const sub = subscriptions.find(s => s.id === subId);
    const newPlan = subscriptionPlans.find(p => p.id === newPlanId);

    if (!sub || !newPlan || newPlan.id === sub.planId) {
        return;
    }

    const oldPlan = sub.plan;
    const oldPrice = sub.price;

    sub.planId = newPlanId;
    sub.plan = newPlan.name;
    sub.price = newPlan.price;
    sub.orderLimit = newPlan.orderLimit;
    sub.features = newPlan.features;
    sub.history.push({
        action: 'plan_changed',
        date: new Date().toISOString(),
        note: `Changed from ${oldPlan} ($${oldPrice}/mo) to ${newPlan.name} ($${newPlan.price}/mo)`,
        user: currentUser?.name || 'Admin'
    });

    saveSubscriptions();
    document.getElementById('changePlanModal').remove();
    loadAdminSubscriptionsPanel();
    alert(`Plan changed! ${sub.clientName} is now on the ${newPlan.name} plan ($${newPlan.price}/mo).`);
}

function sendSubscriptionInvoice(subId) {
    const sub = subscriptions.find(s => s.id === subId);
    if (!sub) return;

    const invoice = {
        id: Date.now() + Math.random(),
        invoiceNumber: 'SUB-INV-' + sub.id + '-' + new Date().getTime(),
        clientId: sub.clientId,
        clientName: sub.clientName,
        clientEmail: sub.clientEmail,
        subscriptionId: sub.id,
        projectName: sub.plan + ' Subscription - Monthly',
        lineItems: [{
            description: `${sub.plan} - Monthly subscription (${new Date(sub.nextBillingDate).toLocaleDateString()})`,
            amount: sub.price
        }],
        subtotal: sub.price,
        total: sub.price,
        dueDate: new Date(sub.nextBillingDate).toISOString().split('T')[0],
        notes: `Billing Method: ${sub.billingMethod === 'stripe' ? 'Automatic (Stripe)' : 'Manual Invoice'}`,
        status: 'pending',
        termsAccepted: false,
        createdAt: new Date().toISOString()
    };

    invoices.push(invoice);
    saveInvoices();

    // Send invoice to client
    if (sub.clientEmail) {
        try {
            sendInvoiceToClient(invoice);
        } catch (e) {
            console.log('Email notification not available');
        }
    }

    alert(`Invoice sent to ${sub.clientName}`);
    loadAdminSubscriptionsPanel();
}

function filterSubscriptionTable(query) {
    const searchInput = document.getElementById('subscriptionSearchInput');
    const statusFilter = document.getElementById('subscriptionFilterStatus');
    const searchQuery = (query || searchInput.value).toLowerCase();
    const statusValue = statusFilter.value;

    const rows = document.querySelectorAll('#subscriptionTableBody tr');
    rows.forEach(row => {
        const clientName = row.cells[0].textContent.toLowerCase();
        const statusText = row.cells[3].textContent.toLowerCase();

        const matchesSearch = clientName.includes(searchQuery);
        const matchesStatus = statusValue === '' || statusText.includes(statusValue);

        row.style.display = matchesSearch && matchesStatus ? '' : 'none';
    });
}
</script>

<!-- Supabase & Stripe already loaded in <head> with defer -->

 <script>
        // Scroll Progress Indicator
        window.addEventListener('scroll', function() {
            var scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
            var scrollHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            var progress = (scrollTop / scrollHeight) * 100;
            var bar = document.getElementById('scrollProgress');
            if (bar) bar.style.width = progress + '%';
        });
 </script>

    <!-- Service Worker: DO NOT register — we killed the SW permanently.
         The cache-buster in <head> handles unregistration.
         The self-destruct sw.js on the server handles browsers that auto-check. -->


</body>
</html>
